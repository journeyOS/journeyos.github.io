
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Android-S Vehicle HAL架构。">
      
      
        <meta name="author" content="Solo">
      
      
        <link rel="canonical" href="https://0.0.0.0:8000/android/car/vehicle/android-s-hal-intro/">
      
      
        <link rel="prev" href="../../carservice/car-wifi-service/">
      
      
        <link rel="next" href="../android-u-hal-intro/">
      
      
      <link rel="icon" href="../../../../assets/images/logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.50">
    
    
      
        <title>Android-S Vehicle HAL架构 - Solo's Blog</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.a40c8224.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../fonts/lxgw-wenkai.css">
    
      <link rel="stylesheet" href="../../../../stylesheets/extra.css">
    
      <link rel="stylesheet" href="../../../../stylesheets/extra2.css">
    
      <link rel="stylesheet" href="../../../../stylesheets/link.css">
    
      <link rel="stylesheet" href="../../../../stylesheets/customize.css">
    
      <link rel="stylesheet" href="../../../../stylesheets/bannerSlider.css">
    
      <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.css">
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1.1.0/style.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#vehiclehal" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      



<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
    <nav class="md-header__inner md-grid" aria-label="页眉">
        <a href="../../../.." title="Solo&#39;s Blog"
           class="md-header__button md-logo" aria-label="Solo's Blog" data-md-component="logo">
            
  <img src="../../../../assets/images/logo.png" alt="logo">

        </a>
        <label class="md-header__button md-icon" for="__drawer">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
        </label>
        <div class="md-header__title" data-md-component="header-title">
            <div class="md-header__ellipsis">
                <div class="md-header__topic">
          <span class="md-ellipsis">
            Solo's Blog
          </span>
                </div>
                <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Android-S Vehicle HAL架构
            
          </span>
                </div>
            </div>
        </div>
        
        



<div class="md-copyright">
    
    <font color=#608DBD size=3>
        <span id="jinrishici-sentence">正在加载今日诗词....</span>
        <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
    </font>
    

    
</div>
        
        
        
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="purple"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
        
        
        
        <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
        
        
        
        <label class="md-header__button md-icon" for="__search">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="分享" aria-label="分享" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
        
        <div class="md-header__source">
            <a href="https://github.com/i-rtfsc/note" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    i-rtfsc/note
  </div>
</a>
        </div>
        
    </nav>
    
    
    
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../.." class="md-tabs__link">
        
  
    
  
  首页

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../../brightness/automatic-brightness-intro/" class="md-tabs__link">
          
  
    
  
  Android

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../base/51-android-rules/" class="md-tabs__link">
          
  
    
  
  基础技术

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../development-board/raspberry-pi/intro/" class="md-tabs__link">
          
  
    
  
  开发板

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../source-code/personal-source-code-intro/" class="md-tabs__link">
          
  
    
  
  源码工程

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
    
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Solo&#39;s Blog" class="md-nav__button md-logo" aria-label="Solo's Blog" data-md-component="logo">
      
  <img src="../../../../assets/images/logo.png" alt="logo">

    </a>
    Solo's Blog
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/i-rtfsc/note" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    i-rtfsc/note
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    首页
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Android
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Android
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../brightness/automatic-brightness-intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android自动背光机制
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tombstones/tombstones-intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NativeTombstoneManager
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../bootanimation/bootanimation-intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    bootanimation程序简介
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" >
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    AMS
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            AMS
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ams/launch-modes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Activity四大启动模式
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ams/client_transaction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Activity框架01-客户端事务管理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ams/activity_client_record/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Activity框架02-ActivityClientRecord
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ams/activity_thread/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Activity框架03-ActivityThread
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ams/activity_context/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Activity框架04-Activity和Context的关系
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ams/lifecycle/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Activity生命周期
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ams/android11-activity-start/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android11 Activity启动流程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ams/wm-layout-params/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    WindowManager.LayoutParams
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ams/frida-dump-activity-lifecycle/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    frida dump activity生命周期
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5" >
        
          
          <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Broadcast
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5">
            <span class="md-nav__icon md-icon"></span>
            Broadcast
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../broadcast/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Broadcast概述
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6" >
        
          
          <label class="md-nav__link" for="__nav_2_6" id="__nav_2_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    SELinux
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6">
            <span class="md-nav__icon md-icon"></span>
            SELinux
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../selinux/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android SELinux介绍
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../selinux/genfscon/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    genfscon
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7" >
        
          
          <label class="md-nav__link" for="__nav_2_7" id="__nav_2_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Binder
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_7">
            <span class="md-nav__icon md-icon"></span>
            Binder
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../binder/android12-native-binder-change/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 12 Native Binder 代码变迁
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../binder/ashmem/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ashmem简介（Android IPC传输大数据）
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../binder/driver/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Binder机制01-驱动
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../binder/service-manager/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Binder机制02-ServiceManager
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../binder/framework-native/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Binder机制03-Framework-Native
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../binder/framework-java/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Binder机制04-Framework-Java
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../binder/aidl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Binder机制05-AIDL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../binder/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Binder概述
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../binder/am-trace-ipc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    am trace-ipc 分析
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_8" checked>
        
          
          <label class="md-nav__link" for="__nav_2_8" id="__nav_2_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Car
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_8_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_8">
            <span class="md-nav__icon md-icon"></span>
            Car
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_8_1" >
        
          
          <label class="md-nav__link" for="__nav_2_8_1" id="__nav_2_8_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    CarService
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_8_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_8_1">
            <span class="md-nav__icon md-icon"></span>
            CarService
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../carservice/start-service/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 15 CarService源码01-服务启动
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../carservice/init-service/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 15 CarService源码02-服务初始化
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../carservice/all-service/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 15 CarService源码03-服务及接口
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../carservice/carservice-call-vhal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 15 CarService源码04-CarService与Vehicle HAL交互
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../carservice/system-interface/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 15 CarService源码05-SystemInterface
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../carservice/car-input-service/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 15 CarService源码06-CarInputService
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../carservice/car-wifi-service/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 15 CarService源码07-CarWifiService
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_8_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2_8_2" id="__nav_2_8_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Vehicle
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_8_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_8_2">
            <span class="md-nav__icon md-icon"></span>
            Vehicle
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Android-S Vehicle HAL架构
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Android-S Vehicle HAL架构
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#vehiclehal" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHAL 简介
    </span>
  </a>
  
    <nav class="md-nav" aria-label="VehicleHAL 简介">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      接口文件
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-vehiclehal" class="md-nav__link">
    <span class="md-ellipsis">
      2. VehicleHal初始化流程
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. VehicleHal初始化流程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vehiclepropertystore" class="md-nav__link">
    <span class="md-ellipsis">
      VehiclePropertyStore
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#emulatedvehicleconnector" class="md-nav__link">
    <span class="md-ellipsis">
      EmulatedVehicleConnector
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclehalserverloadconfigdeclarations" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHalServer::LoadConfigDeclarations()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#emulateduserhal" class="md-nav__link">
    <span class="md-ellipsis">
      EmulatedUserHal
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#emulatedvehiclehal" class="md-nav__link">
    <span class="md-ellipsis">
      EmulatedVehicleHal
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehicleemulator" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleEmulator
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclehalmanager" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHalManager
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclehalinit" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHal.init()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclehal_1" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHal启动序列图
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#typeshal" class="md-nav__link">
    <span class="md-ellipsis">
      types.hal
    </span>
  </a>
  
    <nav class="md-nav" aria-label="types.hal">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vehiclepropertytype" class="md-nav__link">
    <span class="md-ellipsis">
      VehiclePropertyType
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclearea" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleArea
    </span>
  </a>
  
    <nav class="md-nav" aria-label="VehicleArea">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vehiclepropertygroup" class="md-nav__link">
    <span class="md-ellipsis">
      VehiclePropertyGroup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehicleareawindow" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleAreaWindow
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclepropertyaccess" class="md-nav__link">
    <span class="md-ellipsis">
      VehiclePropertyAccess
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclepropertychangemode" class="md-nav__link">
    <span class="md-ellipsis">
      VehiclePropertyChangeMode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#subscribeoptions" class="md-nav__link">
    <span class="md-ellipsis">
      SubscribeOptions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehicleareaseat" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleAreaSeat
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#statuscode" class="md-nav__link">
    <span class="md-ellipsis">
      StatusCode
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ivehiclehal" class="md-nav__link">
    <span class="md-ellipsis">
      IVehicle.hal
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ivehiclecallbackhal" class="md-nav__link">
    <span class="md-ellipsis">
      IVehicleCallback.hal
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vehiclehal_2" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHal 获取（设置）属性
    </span>
  </a>
  
    <nav class="md-nav" aria-label="VehicleHal 获取（设置）属性">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#subscribe" class="md-nav__link">
    <span class="md-ellipsis">
      subscribe订阅属性
    </span>
  </a>
  
    <nav class="md-nav" aria-label="subscribe订阅属性">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#carserviceoncreate" class="md-nav__link">
    <span class="md-ellipsis">
      CarService.onCreate()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#icarimpl" class="md-nav__link">
    <span class="md-ellipsis">
      ICarImpl构造函数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclehal_3" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHal
    </span>
  </a>
  
    <nav class="md-nav" aria-label="VehicleHal">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#getallpropconfigs" class="md-nav__link">
    <span class="md-ellipsis">
      getAllPropConfigs()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclehalinit_1" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHal.init()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powerhalservicegetallsupportedproperties" class="md-nav__link">
    <span class="md-ellipsis">
      PowerHalService.getAllSupportedProperties()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powerhalservicetakeproperties" class="md-nav__link">
    <span class="md-ellipsis">
      PowerHalService.takeProperties()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powerhalserviceinit" class="md-nav__link">
    <span class="md-ellipsis">
      PowerHalService.init()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclehalsubscribeproperty" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHal.subscribeProperty()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#halclientsubscribe" class="md-nav__link">
    <span class="md-ellipsis">
      HalClient.subscribe()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclehalmanagersubscribe" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHalManager.subscribe()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#emulatedvehiclehalsubscribe" class="md-nav__link">
    <span class="md-ellipsis">
      EmulatedVehicleHal.subscribe()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set" class="md-nav__link">
    <span class="md-ellipsis">
      set 设置属性
    </span>
  </a>
  
    <nav class="md-nav" aria-label="set 设置属性">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vehiclehalset" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHal.set()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#halclientsetvalue" class="md-nav__link">
    <span class="md-ellipsis">
      HalClient.setValue()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclehalmanagerset" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHalManager.set()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#emulatedvehiclehalset" class="md-nav__link">
    <span class="md-ellipsis">
      EmulatedVehicleHal.set()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclepropertystorewritevalue" class="md-nav__link">
    <span class="md-ellipsis">
      VehiclePropertyStore.writeValue()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclehalmanagerhandlepropertysetevent" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHalManager.handlePropertySetEvent()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclecallback" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleCallback
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get" class="md-nav__link">
    <span class="md-ellipsis">
      get 获取属性
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get 获取属性">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vehiclehalget" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHal.get()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#halclientgetvalue" class="md-nav__link">
    <span class="md-ellipsis">
      HalClient.getValue()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclehalmanagerget" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHalManager.get()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#emulatedvehiclehalget" class="md-nav__link">
    <span class="md-ellipsis">
      EmulatedVehicleHal.get()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclepropertystore_1" class="md-nav__link">
    <span class="md-ellipsis">
      VehiclePropertyStore
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      附录
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../android-u-hal-intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android-U Vehicle HAL架构
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_9" >
        
          
          <label class="md-nav__link" for="__nav_2_9" id="__nav_2_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Input
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_9">
            <span class="md-nav__icon md-icon"></span>
            Input
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../input/focused-window/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 窗口焦点介绍
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../input/inotify-epoll/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    INotify与Epoll机制
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../input/inputDispatcher-inputChannel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    InputDispatcher与InputChannel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../input/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Input概述
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../input/start/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Input系统01-Input启动过程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../input/input-reader/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Input系统02-InputReader线程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../input/scancode-keycode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Scancode到Keycode的映射
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../input/add-new-key/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    新增物理按键处理流程
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_10" >
        
          
          <label class="md-nav__link" for="__nav_2_10" id="__nav_2_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    基础与工具
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_10">
            <span class="md-nav__icon md-icon"></span>
            基础与工具
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base-tools/adb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ADB
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base-tools/api-levels/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android API Levels
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base-tools/as-shortcut-keys/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android Studio 快捷键
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base-tools/as-compdb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Compdb
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base-tools/c-ifdef/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    c代码中 ifdef 多条件判断
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base-tools/repo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    repo常用操作
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base-tools/ccache/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    使用ccache加快编译速度
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base-tools/winscope/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    编译winscope
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_11" >
        
          
          <label class="md-nav__link" for="__nav_2_11" id="__nav_2_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    巧夺天工
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_11">
            <span class="md-nav__icon md-icon"></span>
            巧夺天工
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../divine-skill/android-bp-if-else/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android.bp 添加宏控
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../divine-skill/service-extra-func-without-aidl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    aosp原生Service快捷扩展接口
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../divine-skill/mem-pressure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    内存加压
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../divine-skill/log-to-line-chart/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    通过log中的坐标转成折线图
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_12" >
        
          
          <label class="md-nav__link" for="__nav_2_12" id="__nav_2_12_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    调试技巧
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_12">
            <span class="md-nav__icon md-icon"></span>
            调试技巧
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../debug-skill/tomestone-stack/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android Native crash tomestone trace tools
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../debug-skill/call-stack/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android打印函数调用流程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../debug-skill/am-set-debug-app/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    am set-debug-app 介绍
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../debug-skill/privapp-permissions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    privapp permissions检查
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../debug-skill/event-log/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    借助 event log 有效排查问题
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../debug-skill/merge-sort-log/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    按时间顺序合并log
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../debug-skill/jdwp-enabled/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    无法打断点调试
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_12_8" >
        
          
          <label class="md-nav__link" for="__nav_2_12_8" id="__nav_2_12_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    调频命令
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_12_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_12_8">
            <span class="md-nav__icon md-icon"></span>
            调频命令
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../debug-skill/frequency/cpu/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CPU提频命令
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../debug-skill/frequency/gpu/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GPU提频命令
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_13" >
        
          
          <label class="md-nav__link" for="__nav_2_13" id="__nav_2_13_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    问题及方案
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_13">
            <span class="md-nav__icon md-icon"></span>
            问题及方案
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../issue-solution/set-affinity/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android进程绑核方案
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../issue_solution/car-service-updatable-call-hide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CarServiceUpdatable引用hide接口
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    基础技术
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            基础技术
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../base/51-android-rules/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    51-android.rules
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../base/jar-delete/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Jar包删除部分内容
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../base/jetbrains_directories/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    JetBrains配置目录
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../base/git_branch_commit_single/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    git小技巧-commit single
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../base/hexo-next/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    hexo、next主题美化
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../base/linux-service/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    linux service
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../base/mkdocs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mkdocs博客搭建
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../base/sshfs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    sshfs命令
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../base/tmux/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    tmux
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../base/tar/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    tar命令
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    开发板
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            开发板
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    树莓派
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            树莓派
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../development-board/raspberry-pi/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    树莓派基础配置
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    源码工程
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            源码工程
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../source-code/personal-source-code-intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    个人源码工程简介
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    ExtFrameworks
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            ExtFrameworks
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../source-code/aosp-ext/fwk-ext/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    aosp frameworks扩展方案
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Android feature
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            Android feature
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../source-code/android-feature/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android Device Feature
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4" >
        
          
          <label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    As aosp
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4">
            <span class="md-nav__icon md-icon"></span>
            As aosp
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../source-code/as-aosp/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    as-aosp工程简介
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../source-code/as-aosp/first-configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    教程001-首次配置
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../source-code/as-aosp/design/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    教程002-设计思路
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../source-code/as-aosp/simple-extra/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    教程003-简单扩展
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../source-code/as-aosp/plugin-extra/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    教程004-插件扩展
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../source-code/as-aosp/jump-system-code/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    教程005-跳转系统源码[6.x版本默认跳转]
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../source-code/as-aosp/jump-aidl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    教程006-aidl跳转
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../source-code/as-aosp/jump-cpp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    教程007-c++跳转
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../source-code/as-aosp/jump-system-code-2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    教程008-跳转系统源码[进阶版]
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_5" >
        
          
          <label class="md-nav__link" for="__nav_5_5" id="__nav_5_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Global scripts
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_5">
            <span class="md-nav__icon md-icon"></span>
            Global scripts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../source-code/global-scripts/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    global_scripts工程简介
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#vehiclehal" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHAL 简介
    </span>
  </a>
  
    <nav class="md-nav" aria-label="VehicleHAL 简介">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      接口文件
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-vehiclehal" class="md-nav__link">
    <span class="md-ellipsis">
      2. VehicleHal初始化流程
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. VehicleHal初始化流程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vehiclepropertystore" class="md-nav__link">
    <span class="md-ellipsis">
      VehiclePropertyStore
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#emulatedvehicleconnector" class="md-nav__link">
    <span class="md-ellipsis">
      EmulatedVehicleConnector
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclehalserverloadconfigdeclarations" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHalServer::LoadConfigDeclarations()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#emulateduserhal" class="md-nav__link">
    <span class="md-ellipsis">
      EmulatedUserHal
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#emulatedvehiclehal" class="md-nav__link">
    <span class="md-ellipsis">
      EmulatedVehicleHal
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehicleemulator" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleEmulator
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclehalmanager" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHalManager
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclehalinit" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHal.init()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclehal_1" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHal启动序列图
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#typeshal" class="md-nav__link">
    <span class="md-ellipsis">
      types.hal
    </span>
  </a>
  
    <nav class="md-nav" aria-label="types.hal">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vehiclepropertytype" class="md-nav__link">
    <span class="md-ellipsis">
      VehiclePropertyType
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclearea" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleArea
    </span>
  </a>
  
    <nav class="md-nav" aria-label="VehicleArea">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vehiclepropertygroup" class="md-nav__link">
    <span class="md-ellipsis">
      VehiclePropertyGroup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehicleareawindow" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleAreaWindow
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclepropertyaccess" class="md-nav__link">
    <span class="md-ellipsis">
      VehiclePropertyAccess
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclepropertychangemode" class="md-nav__link">
    <span class="md-ellipsis">
      VehiclePropertyChangeMode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#subscribeoptions" class="md-nav__link">
    <span class="md-ellipsis">
      SubscribeOptions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehicleareaseat" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleAreaSeat
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#statuscode" class="md-nav__link">
    <span class="md-ellipsis">
      StatusCode
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ivehiclehal" class="md-nav__link">
    <span class="md-ellipsis">
      IVehicle.hal
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ivehiclecallbackhal" class="md-nav__link">
    <span class="md-ellipsis">
      IVehicleCallback.hal
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vehiclehal_2" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHal 获取（设置）属性
    </span>
  </a>
  
    <nav class="md-nav" aria-label="VehicleHal 获取（设置）属性">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#subscribe" class="md-nav__link">
    <span class="md-ellipsis">
      subscribe订阅属性
    </span>
  </a>
  
    <nav class="md-nav" aria-label="subscribe订阅属性">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#carserviceoncreate" class="md-nav__link">
    <span class="md-ellipsis">
      CarService.onCreate()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#icarimpl" class="md-nav__link">
    <span class="md-ellipsis">
      ICarImpl构造函数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclehal_3" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHal
    </span>
  </a>
  
    <nav class="md-nav" aria-label="VehicleHal">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#getallpropconfigs" class="md-nav__link">
    <span class="md-ellipsis">
      getAllPropConfigs()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclehalinit_1" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHal.init()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powerhalservicegetallsupportedproperties" class="md-nav__link">
    <span class="md-ellipsis">
      PowerHalService.getAllSupportedProperties()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powerhalservicetakeproperties" class="md-nav__link">
    <span class="md-ellipsis">
      PowerHalService.takeProperties()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powerhalserviceinit" class="md-nav__link">
    <span class="md-ellipsis">
      PowerHalService.init()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclehalsubscribeproperty" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHal.subscribeProperty()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#halclientsubscribe" class="md-nav__link">
    <span class="md-ellipsis">
      HalClient.subscribe()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclehalmanagersubscribe" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHalManager.subscribe()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#emulatedvehiclehalsubscribe" class="md-nav__link">
    <span class="md-ellipsis">
      EmulatedVehicleHal.subscribe()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set" class="md-nav__link">
    <span class="md-ellipsis">
      set 设置属性
    </span>
  </a>
  
    <nav class="md-nav" aria-label="set 设置属性">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vehiclehalset" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHal.set()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#halclientsetvalue" class="md-nav__link">
    <span class="md-ellipsis">
      HalClient.setValue()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclehalmanagerset" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHalManager.set()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#emulatedvehiclehalset" class="md-nav__link">
    <span class="md-ellipsis">
      EmulatedVehicleHal.set()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclepropertystorewritevalue" class="md-nav__link">
    <span class="md-ellipsis">
      VehiclePropertyStore.writeValue()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclehalmanagerhandlepropertysetevent" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHalManager.handlePropertySetEvent()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclecallback" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleCallback
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get" class="md-nav__link">
    <span class="md-ellipsis">
      get 获取属性
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get 获取属性">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vehiclehalget" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHal.get()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#halclientgetvalue" class="md-nav__link">
    <span class="md-ellipsis">
      HalClient.getValue()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclehalmanagerget" class="md-nav__link">
    <span class="md-ellipsis">
      VehicleHalManager.get()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#emulatedvehiclehalget" class="md-nav__link">
    <span class="md-ellipsis">
      EmulatedVehicleHal.get()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vehiclepropertystore_1" class="md-nav__link">
    <span class="md-ellipsis">
      VehiclePropertyStore
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      附录
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

<nav class="md-tags" >
  
    
    
      
      
    
    
      <span class="md-tag md-tag-icon">Android</span>
    
  
    
    
      
      
    
    
      <span class="md-tag md-tag-icon">car</span>
    
  
    
    
      
      
    
    
      <span class="md-tag md-tag-icon">Vehicle</span>
    
  
</nav>


  
    <a href="https://github.com/i-rtfsc/note/edit/main/docs/Android/car/vehicle/Android-S Vehicle HAL架构.md" title="编辑此页" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  


<h1>Android-S Vehicle HAL架构</h1>

<h2 id="vehiclehal">VehicleHAL 简介<a class="headerlink" href="#vehiclehal" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p>源码位置 : hardware/interfaces/automotive/vehicle/2.0/</p>
</li>
<li>
<p>VehicleHAL 类图
<img alt="" src="../../../../Android/car/vehicle/res/vehicle_hal_01.png" /></p>
</li>
</ul>
<h3 id="_1">接口文件<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h3>
<ul>
<li>types.hal 定义的是一些数据结构</li>
<li>IVehicle.hal 定义的是从 CarService 往 HAL 调用的接口</li>
<li>IVehicleCallback.hal 则是 HAL 往 CarService 上报回调的接口</li>
</ul>
<h2 id="2-vehiclehal">2. VehicleHal初始化流程<a class="headerlink" href="#2-vehiclehal" title="Permanent link">&para;</a></h2>
<p>初始化从执行 hardware/interfaces/automotive/vehicle/2.0/default/VehicleService.cpp 的main函数开始：</p>
<ul>
<li>创建 VehiclePropertyStore 对象</li>
<li>创建 EmulatedVehicleConnector 对象</li>
<li>创建 EmulatedUserHal 对象</li>
<li>创建 EmulatedVehicleHal 对象</li>
<li>创建 VehicleEmulator 对象</li>
<li>创建 VehicleHalManager 对象</li>
</ul>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="k">default</span><span class="o">/</span><span class="n">VehicleService</span><span class="p">.</span><span class="n">cpp</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="cm">/* argc */</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="cm">/* argv */</span><span class="w"> </span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">    </span><span class="c1">//1.  创建一个 VehiclePropertyStore 对象，并使用std::make_unique进行智能指针的初始化</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">VehiclePropertyStore</span><span class="o">&gt;</span><span class="p">();</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">    </span><span class="c1">//2. 创建一个 EmulatedVehicleConnector 对象，并使用std::make_unique进行智能指针的初始化</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">connector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">impl</span><span class="o">::</span><span class="n">EmulatedVehicleConnector</span><span class="o">&gt;</span><span class="p">();</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="w">    </span><span class="c1">// 载入配置声明</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="w">    </span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">LoadConfigDeclarations</span><span class="p">(</span><span class="n">impl</span><span class="o">::</span><span class="n">kVehicleProperties</span><span class="p">);</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="w">    </span><span class="c1">//3. 获取 EmulatedUserHal 对象</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">userHal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">getEmulatedUserHal</span><span class="p">();</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="w">    </span><span class="c1">//4. 创建一个 EmulatedVehicleHal 对象，并使用std::make_unique进行智能指针的初始化</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">hal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">impl</span><span class="o">::</span><span class="n">EmulatedVehicleHal</span><span class="o">&gt;</span><span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span><span class="w"> </span><span class="n">connector</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span><span class="w"> </span><span class="n">userHal</span><span class="p">);</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="w">    </span><span class="c1">//5. 创建一个 VehicleEmulator 对象，并使用std::make_unique进行智能指针的初始化</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">emulator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">impl</span><span class="o">::</span><span class="n">VehicleEmulator</span><span class="o">&gt;</span><span class="p">(</span><span class="n">hal</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="w">    </span><span class="c1">// 创建一个 VehicleHalManager 对象，并使用std::make_unique进行智能指针的初始化</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">VehicleHalManager</span><span class="o">&gt;</span><span class="p">(</span><span class="n">hal</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="w">    </span><span class="c1">// 设置connector的value pool</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="w">    </span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">setValuePool</span><span class="p">(</span><span class="n">hal</span><span class="o">-&gt;</span><span class="n">getValuePool</span><span class="p">());</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="w">    </span><span class="c1">// 配置RPC线程池</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="w">    </span><span class="n">configureRpcThreadpool</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="cm">/* callerWillJoin */</span><span class="p">);</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="w">    </span><span class="n">ALOGI</span><span class="p">(</span><span class="s">&quot;Registering as service...&quot;</span><span class="p">);</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="w">    </span><span class="c1">// 注册为服务</span>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="w">    </span><span class="n">status_t</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">service</span><span class="o">-&gt;</span><span class="n">registerAsService</span><span class="p">();</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="w">        </span><span class="n">ALOGE</span><span class="p">(</span><span class="s">&quot;Unable to register vehicle service (%d)&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a><span class="w">    </span><span class="n">ALOGI</span><span class="p">(</span><span class="s">&quot;Ready&quot;</span><span class="p">);</span>
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a><span class="w">    </span><span class="c1">// 加入RPC线程池</span>
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a><span class="w">    </span><span class="n">joinRpcThreadpool</span><span class="p">();</span>
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-0-37"><a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="vehiclepropertystore">VehiclePropertyStore<a class="headerlink" href="#vehiclepropertystore" title="Permanent link">&para;</a></h3>
<p>VehiclePropertyStore的类，用于存储和访问车辆属性的配置和值。</p>
<ul>
<li>registerProperty：注册车辆属性的配置。</li>
<li>writeValue：存储提供的属性值。</li>
<li>removeValue：删除指定的属性值。</li>
<li>removeValuesForProperty：删除指定属性的所有值。</li>
<li>readAllValues：读取所有属性的值。</li>
<li>readValuesForProperty：读取指定属性的所有值。</li>
<li>readValueOrNull：根据请求读取属性值，如果不存在则返回空指针。</li>
<li>getConfigOrNull：根据属性ID获取属性配置，如果不存在则返回空指针。</li>
<li>getConfigOrDie：根据属性ID获取属性配置，如果不存在则抛出异常。</li>
</ul>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="k">default</span><span class="o">/</span><span class="n">common</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">vhal_v2_0</span><span class="o">/</span><span class="n">VehiclePropertyStore</span><span class="p">.</span><span class="n">h</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">VehiclePropertyStore</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="k">public</span><span class="o">:</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">registerProperty</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">VehiclePropConfig</span><span class="o">&amp;</span><span class="w"> </span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">TokenFunction</span><span class="w"> </span><span class="n">tokenFunc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">    </span><span class="cm">/* Stores provided value. Returns true if value was written returns false if config for</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="cm">     * example wasn&#39;t registered. */</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nf">writeValue</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">VehiclePropValue</span><span class="o">&amp;</span><span class="w"> </span><span class="n">propValue</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">updateStatus</span><span class="p">);</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">removeValue</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">VehiclePropValue</span><span class="o">&amp;</span><span class="w"> </span><span class="n">propValue</span><span class="p">);</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">removeValuesForProperty</span><span class="p">(</span><span class="kt">int32_t</span><span class="w"> </span><span class="n">propId</span><span class="p">);</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">VehiclePropValue</span><span class="o">&gt;</span><span class="w"> </span><span class="n">readAllValues</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">VehiclePropValue</span><span class="o">&gt;</span><span class="w"> </span><span class="n">readValuesForProperty</span><span class="p">(</span><span class="kt">int32_t</span><span class="w"> </span><span class="n">propId</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">VehiclePropValue</span><span class="o">&gt;</span><span class="w"> </span><span class="n">readValueOrNull</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">VehiclePropValue</span><span class="o">&amp;</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">VehiclePropValue</span><span class="o">&gt;</span><span class="w"> </span><span class="n">readValueOrNull</span><span class="p">(</span><span class="kt">int32_t</span><span class="w"> </span><span class="n">prop</span><span class="p">,</span><span class="w"> </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a><span class="w">                                                      </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">VehiclePropConfig</span><span class="o">&gt;</span><span class="w"> </span><span class="n">getAllConfigs</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VehiclePropConfig</span><span class="o">*</span><span class="w"> </span><span class="nf">getConfigOrNull</span><span class="p">(</span><span class="kt">int32_t</span><span class="w"> </span><span class="n">propId</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VehiclePropConfig</span><span class="o">*</span><span class="w"> </span><span class="nf">getConfigOrDie</span><span class="p">(</span><span class="kt">int32_t</span><span class="w"> </span><span class="n">propId</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a><span class="p">};</span>
</span></code></pre></div>
<h3 id="emulatedvehicleconnector">EmulatedVehicleConnector<a class="headerlink" href="#emulatedvehicleconnector" title="Permanent link">&para;</a></h3>
<p>EmulatedVehicleConnector 继承自 IPassThroughConnector<VehicleHalClient, VehicleHalServer>，是Android汽车HAL（Hardware Abstraction Layer）的一部分，用于模拟车辆连接器。</p>
<p>该代码的功能是实现了一个模拟车辆连接器，用于处理车辆属性的设置和转储请求，并与 EmulatedUserHal 进行交互。</p>
<ul>
<li>getEmulatedUserHal() 的函数，返回一个 EmulatedUserHal 类型的指针。</li>
<li>实现了 VehicleHalServer 接口中的 triggerSendAllValues() 函数。用于触发将所有值发送给客户端。</li>
<li>实现了 VehicleHalServer 接口中的 onSetProperty() 函数。用于处理设置属性的请求，如果属性由 EmulatedUserHal 支持，则调用 EmulatedUserHal 的 onSetProperty() 函数进行处理，并根据返回值更新属性的值。</li>
<li>实现了 VehicleHalServer 接口中的 onDump() 函数。</li>
</ul>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="k">default</span><span class="o">/</span><span class="n">impl</span><span class="o">/</span><span class="n">vhal_v2_0</span><span class="o">/</span><span class="n">EmulatedVehicleConnector</span><span class="p">.</span><span class="n">h</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">EmulatedVehicleConnector</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">IPassThroughConnector</span><span class="o">&lt;</span><span class="n">VehicleHalClient</span><span class="p">,</span><span class="w"> </span><span class="n">VehicleHalServer</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">  </span><span class="k">public</span><span class="o">:</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">    </span><span class="n">EmulatedVehicleConnector</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">default</span><span class="p">;</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">    </span><span class="n">EmulatedUserHal</span><span class="o">*</span><span class="w"> </span><span class="nf">getEmulatedUserHal</span><span class="p">();</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="w">    </span><span class="c1">// Methods from VehicleHalServer</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">triggerSendAllValues</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="w">    </span><span class="n">StatusCode</span><span class="w"> </span><span class="nf">onSetProperty</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">VehiclePropValue</span><span class="o">&amp;</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">updateStatus</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nf">onDump</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">hidl_handle</span><span class="o">&amp;</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">hidl_vec</span><span class="o">&lt;</span><span class="n">hidl_string</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">options</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="w">  </span><span class="k">private</span><span class="o">:</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="w">    </span><span class="n">EmulatedUserHal</span><span class="w"> </span><span class="n">mEmulatedUserHal</span><span class="p">;</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="p">};</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="k">default</span><span class="o">/</span><span class="n">impl</span><span class="o">/</span><span class="n">vhal_v2_0</span><span class="o">/</span><span class="n">EmulatedVehicleConnector</span><span class="p">.</span><span class="n">cpp</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="p">...</span>
</span></code></pre></div>
<h3 id="vehiclehalserverloadconfigdeclarations">VehicleHalServer::LoadConfigDeclarations()<a class="headerlink" href="#vehiclehalserverloadconfigdeclarations" title="Permanent link">&para;</a></h3>
<p>我们在 EmulatedVehicleConnector 里并没有看到 LoadConfigDeclarations() 函数，那么是在哪里呢？</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="k">default</span><span class="o">/</span><span class="n">VehicleService</span><span class="p">.</span><span class="n">cpp</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="k">auto</span><span class="w"> </span><span class="n">connector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">impl</span><span class="o">::</span><span class="n">EmulatedVehicleConnector</span><span class="o">&gt;</span><span class="p">();</span><span class="w">  </span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="n">connector</span><span class="o">-&gt;</span><span class="n">LoadConfigDeclarations</span><span class="p">(</span><span class="n">impl</span><span class="o">::</span><span class="n">kVehicleProperties</span><span class="p">);</span>
</span></code></pre></div>
<p>前面什么提到过 EmulatedVehicleConnector 继承自 IPassThroughConnector<VehicleHalClient, VehicleHalServer></p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="k">default</span><span class="o">/</span><span class="n">impl</span><span class="o">/</span><span class="n">vhal_v2_0</span><span class="o">/</span><span class="n">EmulatedVehicleConnector</span><span class="p">.</span><span class="n">h</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">EmulatedVehicleConnector</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">IPassThroughConnector</span><span class="o">&lt;</span><span class="n">VehicleHalClient</span><span class="p">,</span><span class="w"> </span><span class="n">VehicleHalServer</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="p">}</span>
</span></code></pre></div>
<p>果然，我们在 VehicleHalServer 里找到函数 LoadConfigDeclarations()</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="k">default</span><span class="o">/</span><span class="n">impl</span><span class="o">/</span><span class="n">vhal_v2_0</span><span class="o">/</span><span class="n">VehicleHalServer</span><span class="p">.</span><span class="n">h</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">VehicleHalServer</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">IVehicleServer</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">LoadConfigDeclarations</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">ConfigDeclaration</span><span class="o">&gt;</span><span class="w"> </span><span class="n">additionalProperties</span><span class="p">);</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="p">}</span>
</span></code></pre></div>
<p>把 hardware/interfaces/automotive/vehicle/2.0/default/impl/vhal_v2_0/DefaultConfig.h 里声明的 kVehicleProperties 配置全部加载。</p>
<h3 id="emulateduserhal">EmulatedUserHal<a class="headerlink" href="#emulateduserhal" title="Permanent link">&para;</a></h3>
<p>EmulatedUserHal 用于模拟用户 HAL 的行为，通过使用 lshal 调试请求来实现。</p>
<ul>
<li>isSupported()：检查模拟器是否支持给定的属性。</li>
<li>onSetProperty()：允许模拟器设置属性，并返回更新后的属性和状态码。</li>
<li>onGetProperty()：从模拟器获取属性值，并返回属性值和状态码。</li>
<li>dump()：lshal 命令 dump</li>
</ul>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="k">default</span><span class="o">/</span><span class="n">impl</span><span class="o">/</span><span class="n">vhal_v2_0</span><span class="o">/</span><span class="n">EmulatedUserHal</span><span class="p">.</span><span class="n">h</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="k">default</span><span class="o">/</span><span class="n">impl</span><span class="o">/</span><span class="n">vhal_v2_0</span><span class="o">/</span><span class="n">EmulatedUserHal</span><span class="p">.</span><span class="n">cpp</span>
</span></code></pre></div>
<h3 id="emulatedvehiclehal">EmulatedVehicleHal<a class="headerlink" href="#emulatedvehiclehal" title="Permanent link">&para;</a></h3>
<p>EmulatedVehicleHal 类是 EmulatedVehicleHalIface、VehicleHal 的实现 用于连接到模拟器而不是真实的车辆网络。</p>
<ul>
<li>initStaticConfig() : 用于初始化静态配置。</li>
<li>实现 VehicleHal 接口的方法 : onCreate()、listProperties()、get()、set()、subscribe()、unsubscribe() 和 dump()。</li>
<li>实现 EmulatedVehicleHalIface 接口的方法 : setPropertyFromVehicle()、getAllProperties() 和 getAllPropertiesOverride()。</li>
</ul>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="k">default</span><span class="o">/</span><span class="n">impl</span><span class="o">/</span><span class="n">vhal_v2_0</span><span class="o">/</span><span class="n">VehicleEmulator</span><span class="p">.</span><span class="n">h</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">EmulatedVehicleHalIface</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">VehicleHal</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="p">}</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="k">default</span><span class="o">/</span><span class="n">impl</span><span class="o">/</span><span class="n">vhal_v2_0</span><span class="o">/</span><span class="n">EmulatedVehicleHal</span><span class="p">.</span><span class="n">h</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="cm">/** Implementation of VehicleHal that connected to emulator instead of real vehicle network. */</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">EmulatedVehicleHal</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">EmulatedVehicleHalIface</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="k">public</span><span class="o">:</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="w">    </span><span class="n">EmulatedVehicleHal</span><span class="p">(</span><span class="n">VehiclePropertyStore</span><span class="o">*</span><span class="w"> </span><span class="n">propStore</span><span class="p">,</span><span class="w"> </span><span class="n">VehicleHalClient</span><span class="o">*</span><span class="w"> </span><span class="n">client</span><span class="p">,</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="w">                       </span><span class="n">EmulatedUserHal</span><span class="o">*</span><span class="w"> </span><span class="n">emulatedUserHal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="w">    </span><span class="c1">//  Methods from VehicleHal</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">onCreate</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">VehiclePropConfig</span><span class="o">&gt;</span><span class="w"> </span><span class="n">listProperties</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="w">    </span><span class="n">VehiclePropValuePtr</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">VehiclePropValue</span><span class="o">&amp;</span><span class="w"> </span><span class="n">requestedPropValue</span><span class="p">,</span>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="w">                            </span><span class="n">StatusCode</span><span class="o">*</span><span class="w"> </span><span class="n">outStatus</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="w">    </span><span class="n">StatusCode</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">VehiclePropValue</span><span class="o">&amp;</span><span class="w"> </span><span class="n">propValue</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="w">    </span><span class="n">StatusCode</span><span class="w"> </span><span class="nf">subscribe</span><span class="p">(</span><span class="kt">int32_t</span><span class="w"> </span><span class="n">property</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">sampleRate</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a><span class="w">    </span><span class="n">StatusCode</span><span class="w"> </span><span class="nf">unsubscribe</span><span class="p">(</span><span class="kt">int32_t</span><span class="w"> </span><span class="n">property</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nf">dump</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">hidl_handle</span><span class="o">&amp;</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">hidl_vec</span><span class="o">&lt;</span><span class="n">hidl_string</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">options</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
</span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>
</span><span id="__span-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a><span class="w">    </span><span class="c1">//  Methods from EmulatedVehicleHalIface</span>
</span><span id="__span-7-25"><a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nf">setPropertyFromVehicle</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">VehiclePropValue</span><span class="o">&amp;</span><span class="w"> </span><span class="n">propValue</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
</span><span id="__span-7-26"><a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">VehiclePropValue</span><span class="o">&gt;</span><span class="w"> </span><span class="n">getAllProperties</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
</span><span id="__span-7-27"><a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">getAllPropertiesOverride</span><span class="p">();</span>
</span><span id="__span-7-28"><a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a>
</span><span id="__span-7-29"><a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a><span class="k">private</span><span class="o">:</span>
</span><span id="__span-7-30"><a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a>
</span><span id="__span-7-31"><a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a><span class="w">    </span><span class="n">VehiclePropertyStore</span><span class="o">*</span><span class="w"> </span><span class="n">mPropStore</span><span class="p">;</span>
</span><span id="__span-7-32"><a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a><span class="w">    </span><span class="n">VehicleHalClient</span><span class="o">*</span><span class="w"> </span><span class="n">mVehicleClient</span><span class="p">;</span>
</span><span id="__span-7-33"><a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a><span class="w">    </span><span class="n">EmulatedUserHal</span><span class="o">*</span><span class="w"> </span><span class="n">mEmulatedUserHal</span><span class="p">;</span>
</span><span id="__span-7-34"><a id="__codelineno-7-34" name="__codelineno-7-34" href="#__codelineno-7-34"></a><span class="p">};</span>
</span></code></pre></div>
<h3 id="vehicleemulator">VehicleEmulator<a class="headerlink" href="#vehicleemulator" title="Permanent link">&para;</a></h3>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="k">default</span><span class="o">/</span><span class="n">impl</span><span class="o">/</span><span class="n">vhal_v2_0</span><span class="o">/</span><span class="n">VehicleEmulator</span><span class="p">.</span><span class="n">h</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">VehicleEmulator</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">MessageProcessor</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">   </span><span class="k">public</span><span class="o">:</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">    </span><span class="n">VehicleEmulator</span><span class="p">(</span><span class="n">EmulatedVehicleHalIface</span><span class="o">*</span><span class="w"> </span><span class="n">hal</span><span class="p">);</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="k">private</span><span class="o">:</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="w">    </span><span class="n">EmulatedVehicleHalIface</span><span class="o">*</span><span class="w"> </span><span class="n">mHal</span><span class="p">;</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">SocketComm</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mSocketComm</span><span class="p">;</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">PipeComm</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mPipeComm</span><span class="p">;</span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="p">};</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="k">default</span><span class="o">/</span><span class="n">impl</span><span class="o">/</span><span class="n">vhal_v2_0</span><span class="o">/</span><span class="n">VehicleEmulator</span><span class="p">.</span><span class="n">cpp</span>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a><span class="n">VehicleEmulator</span><span class="o">::</span><span class="n">VehicleEmulator</span><span class="p">(</span><span class="n">EmulatedVehicleHalIface</span><span class="o">*</span><span class="w"> </span><span class="n">hal</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">mHal</span><span class="p">{</span><span class="n">hal</span><span class="p">}</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a><span class="w">    </span><span class="n">mHal</span><span class="o">-&gt;</span><span class="n">registerEmulator</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>
</span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a><span class="w">    </span><span class="n">ALOGI</span><span class="p">(</span><span class="s">&quot;Starting SocketComm&quot;</span><span class="p">);</span>
</span><span id="__span-8-20"><a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a><span class="w">    </span><span class="n">mSocketComm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">SocketComm</span><span class="o">&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span id="__span-8-21"><a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a><span class="w">    </span><span class="n">mSocketComm</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">();</span>
</span><span id="__span-8-22"><a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a>
</span><span id="__span-8-23"><a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isInEmulator</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-24"><a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a><span class="w">        </span><span class="n">ALOGI</span><span class="p">(</span><span class="s">&quot;Starting PipeComm&quot;</span><span class="p">);</span>
</span><span id="__span-8-25"><a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a><span class="w">        </span><span class="n">mPipeComm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">PipeComm</span><span class="o">&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span id="__span-8-26"><a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a><span class="w">        </span><span class="n">mPipeComm</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">();</span>
</span><span id="__span-8-27"><a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-8-28"><a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="vehiclehalmanager">VehicleHalManager<a class="headerlink" href="#vehiclehalmanager" title="Permanent link">&para;</a></h3>
<ul>
<li>重置 HidlVecOfVehiclePropValuePool HIDL属性对象池大小</li>
<li>开启事件消费着队列</li>
<li>VehicleHal 初始化</li>
</ul>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="k">default</span><span class="o">/</span><span class="n">common</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">vhal_v2_0</span><span class="o">/</span><span class="n">VehicleHalManager</span><span class="p">.</span><span class="n">h</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">VehicleHalManager</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">IVehicle</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="k">public</span><span class="o">:</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">    </span><span class="n">VehicleHalManager</span><span class="p">(</span><span class="n">VehicleHal</span><span class="o">*</span><span class="w"> </span><span class="n">vehicleHal</span><span class="p">)</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">mHal</span><span class="p">(</span><span class="n">vehicleHal</span><span class="p">),</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">         </span><span class="c1">// 1. mSubscriptionManager成员变量被初始化为一个绑定到onAllClientsUnsubscribed方法的函数对象。</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="w">         </span><span class="c1">// 该函数对象使用std::bind绑定了this指针和std::placeholders::_1占位符。</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="w">          </span><span class="n">mSubscriptionManager</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">VehicleHalManager</span><span class="o">::</span><span class="n">onAllClientsUnsubscribed</span><span class="p">,</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="w">                                         </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="w">        </span><span class="n">init</span><span class="p">();</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="p">}</span>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="k">default</span><span class="o">/</span><span class="n">common</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">VehicleHalManager</span><span class="p">.</span><span class="n">cpp</span>
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>
</span><span id="__span-9-20"><a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a><span class="kt">void</span><span class="w"> </span><span class="n">VehicleHalManager</span><span class="o">::</span><span class="n">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-21"><a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a><span class="w">    </span><span class="n">ALOGI</span><span class="p">(</span><span class="s">&quot;VehicleHalManager::init&quot;</span><span class="p">);</span>
</span><span id="__span-9-22"><a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a>
</span><span id="__span-9-23"><a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a><span class="w">    </span><span class="c1">// 调整 mHidlVecOfVehiclePropValuePool 的大小为 20</span>
</span><span id="__span-9-24"><a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a><span class="w">    </span><span class="c1">// constexpr auto kMaxHidlVecOfVehiclePropValuePoolSize = 20;</span>
</span><span id="__span-9-25"><a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a><span class="w">    </span><span class="n">mHidlVecOfVehiclePropValuePool</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">kMaxHidlVecOfVehiclePropValuePoolSize</span><span class="p">);</span>
</span><span id="__span-9-26"><a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a>
</span><span id="__span-9-27"><a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a><span class="w">    </span><span class="c1">// 开启事件消费着队列</span>
</span><span id="__span-9-28"><a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a><span class="w">    </span><span class="n">mBatchingConsumer</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mEventQueue</span><span class="p">,</span><span class="w"> </span><span class="c1">// 启动批处理消费者线程</span>
</span><span id="__span-9-29"><a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a><span class="w">                          </span><span class="n">kHalEventBatchingTimeWindow</span><span class="p">,</span><span class="w"> </span><span class="c1">// 批处理时间窗口</span>
</span><span id="__span-9-30"><a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a><span class="w">                          </span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">VehicleHalManager</span><span class="o">::</span><span class="n">onBatchHalEvent</span><span class="p">,</span><span class="w"> </span><span class="c1">// 绑定 onBatchHalEvent 函数</span>
</span><span id="__span-9-31"><a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a><span class="w">                                    </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">_1</span><span class="p">));</span>
</span><span id="__span-9-32"><a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a>
</span><span id="__span-9-33"><a id="__codelineno-9-33" name="__codelineno-9-33" href="#__codelineno-9-33"></a><span class="w">    </span><span class="c1">// 初始化 VehicleHal</span>
</span><span id="__span-9-34"><a id="__codelineno-9-34" name="__codelineno-9-34" href="#__codelineno-9-34"></a><span class="w">    </span><span class="n">mHal</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mValueObjectPool</span><span class="p">,</span>
</span><span id="__span-9-35"><a id="__codelineno-9-35" name="__codelineno-9-35" href="#__codelineno-9-35"></a><span class="w">               </span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">VehicleHalManager</span><span class="o">::</span><span class="n">onHalEvent</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">_1</span><span class="p">),</span><span class="w"> </span><span class="c1">// 绑定 onHalEvent 函数</span>
</span><span id="__span-9-36"><a id="__codelineno-9-36" name="__codelineno-9-36" href="#__codelineno-9-36"></a><span class="w">               </span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">VehicleHalManager</span><span class="o">::</span><span class="n">onHalPropertySetError</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="c1">// 绑定 onHalPropertySetError 函数</span>
</span><span id="__span-9-37"><a id="__codelineno-9-37" name="__codelineno-9-37" href="#__codelineno-9-37"></a><span class="w">                         </span><span class="n">_1</span><span class="p">,</span><span class="w"> </span><span class="n">_2</span><span class="p">,</span><span class="w"> </span><span class="n">_3</span><span class="p">));</span>
</span><span id="__span-9-38"><a id="__codelineno-9-38" name="__codelineno-9-38" href="#__codelineno-9-38"></a>
</span><span id="__span-9-39"><a id="__codelineno-9-39" name="__codelineno-9-39" href="#__codelineno-9-39"></a><span class="w">    </span><span class="c1">// 初始化从 VehicleHal 收到的 vehicle 属性的索引</span>
</span><span id="__span-9-40"><a id="__codelineno-9-40" name="__codelineno-9-40" href="#__codelineno-9-40"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">supportedPropConfigs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mHal</span><span class="o">-&gt;</span><span class="n">listProperties</span><span class="p">();</span><span class="w"> </span><span class="c1">// 获取支持的属性配置列表</span>
</span><span id="__span-9-41"><a id="__codelineno-9-41" name="__codelineno-9-41" href="#__codelineno-9-41"></a><span class="w">    </span><span class="n">mConfigIndex</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">VehiclePropConfigIndex</span><span class="p">(</span><span class="n">supportedPropConfigs</span><span class="p">));</span><span class="w"> </span><span class="c1">// 使用支持的属性配置列表创建VehiclePropConfigIndex对象</span>
</span><span id="__span-9-42"><a id="__codelineno-9-42" name="__codelineno-9-42" href="#__codelineno-9-42"></a>
</span><span id="__span-9-43"><a id="__codelineno-9-43" name="__codelineno-9-43" href="#__codelineno-9-43"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int32_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">supportedProperties</span><span class="p">(</span><span class="w"> </span><span class="c1">// 创建支持的属性列表</span>
</span><span id="__span-9-44"><a id="__codelineno-9-44" name="__codelineno-9-44" href="#__codelineno-9-44"></a><span class="w">        </span><span class="n">supportedPropConfigs</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
</span><span id="__span-9-45"><a id="__codelineno-9-45" name="__codelineno-9-45" href="#__codelineno-9-45"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">supportedPropConfigs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-46"><a id="__codelineno-9-46" name="__codelineno-9-46" href="#__codelineno-9-46"></a><span class="w">        </span><span class="n">supportedProperties</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">prop</span><span class="p">);</span><span class="w"> </span><span class="c1">// 将支持的属性添加到列表中</span>
</span><span id="__span-9-47"><a id="__codelineno-9-47" name="__codelineno-9-47" href="#__codelineno-9-47"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-9-48"><a id="__codelineno-9-48" name="__codelineno-9-48" href="#__codelineno-9-48"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="vehiclehalinit">VehicleHal.init()<a class="headerlink" href="#vehiclehalinit" title="Permanent link">&para;</a></h3>
<p>VehicleHal.h 初始化做了以下操作： 
 - 初始化 mValuePool
 - 初始化 mOnHalEvent
 - 初始化 mOnHalPropertySetError 变量
 - 调用 onCreate()</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="k">default</span><span class="o">/</span><span class="n">common</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">vhal_v2_0</span><span class="o">/</span><span class="n">VehicleHal</span><span class="p">.</span><span class="n">h</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">VehicleHal</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">    </span><span class="cm">/**  </span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="cm">    * Override this method if you need to do one-time initialization.  </span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="cm">    */</span><span class="w">  </span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">onCreate</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">init</span><span class="p">(</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="w">        </span><span class="n">VehiclePropValuePool</span><span class="o">*</span><span class="w"> </span><span class="n">valueObjectPool</span><span class="p">,</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">HalEventFunction</span><span class="o">&amp;</span><span class="w"> </span><span class="n">onHalEvent</span><span class="p">,</span>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">HalErrorFunction</span><span class="o">&amp;</span><span class="w"> </span><span class="n">onHalError</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a><span class="w">        </span><span class="n">mValuePool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">valueObjectPool</span><span class="p">;</span>
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a><span class="w">        </span><span class="n">mOnHalEvent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">onHalEvent</span><span class="p">;</span>
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a><span class="w">        </span><span class="n">mOnHalPropertySetError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">onHalError</span><span class="p">;</span>
</span><span id="__span-10-19"><a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a>
</span><span id="__span-10-20"><a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a><span class="w">        </span><span class="n">onCreate</span><span class="p">();</span>
</span><span id="__span-10-21"><a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-10-22"><a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a>
</span><span id="__span-10-23"><a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-10-24"><a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a>
</span><span id="__span-10-25"><a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a><span class="p">}</span>
</span></code></pre></div>
<p>调用 onCreate() 函数，遍历属性列表并以 mPropStore，即 VehiclePropertyStore 保存当前值</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="k">default</span><span class="o">/</span><span class="n">impl</span><span class="o">/</span><span class="n">vhal_v2_0</span><span class="o">/</span><span class="n">VehicleEmulator</span><span class="p">.</span><span class="n">h</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">EmulatedVehicleHalIface</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">VehicleHal</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="p">}</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="k">default</span><span class="o">/</span><span class="n">impl</span><span class="o">/</span><span class="n">vhal_v2_0</span><span class="o">/</span><span class="n">EmulatedVehicleHal</span><span class="p">.</span><span class="n">h</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">EmulatedVehicleHal</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">EmulatedVehicleHalIface</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w">    </span><span class="c1">// Methods from VehicleHal  </span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">onCreate</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="p">}</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="k">default</span><span class="o">/</span><span class="n">impl</span><span class="o">/</span><span class="n">vhal_v2_0</span><span class="o">/</span><span class="n">EmulatedVehicleHal</span><span class="p">.</span><span class="n">cpp</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="c1">// 解析支持的属性列表并生成包含当前值的属性值向量。 </span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="kt">void</span><span class="w"> </span><span class="n">EmulatedVehicleHal</span><span class="o">::</span><span class="n">onCreate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="vehiclehal_1">VehicleHal启动序列图<a class="headerlink" href="#vehiclehal_1" title="Permanent link">&para;</a></h3>
<pre class="mermaid"><code>
sequenceDiagram

VehicleService -&gt;&gt; VehicleService:main()
    Note over VehicleService : 进程主入口，初始化 VehicleHal 等，并注册服务

VehicleService -&gt;&gt; VehiclePropertyStore:EmulatedVehicleHal() 
Note over VehiclePropertyStore : 并使用 std::make_unique 进行智能指针的初始化，并返回对象 store

VehicleService -&gt;&gt; EmulatedVehicleConnector:EmulatedVehicleConnector()
Note over EmulatedVehicleConnector : 并使用 std::make_unique 进行智能指针的初始化，并返回对象 connector

VehicleService -&gt;&gt; EmulatedVehicleHal:EmulatedVehicleHal()
Note over EmulatedVehicleHal : 并使用 std::make_unique 进行智能指针的初始化，构造函数传入VehiclePropertyStore、VehicleHalClient、EmulatedUserHal，并返回对象 hal

VehicleService -&gt;&gt; VehicleEmulator::VehicleEmulator(EmulatedVehicleHalIface* hal)
Note over VehicleEmulator : 并使用 std::make_unique 进行智能指针的初始化，构造函数传入EmulatedVehicleHalIface，并返回对象 emulator

VehicleService -&gt;&gt; VehicleHalManager::VehicleHalManager(VehicleHal* vehicleHal)
Note over VehicleHalManager : 并使用 std::make_unique 进行智能指针的初始化，VehicleHal，并返回对象 service
</code></pre>
<h2 id="typeshal">types.hal<a class="headerlink" href="#typeshal" title="Permanent link">&para;</a></h2>
<h3 id="vehiclepropertytype">VehiclePropertyType<a class="headerlink" href="#vehiclepropertytype" title="Permanent link">&para;</a></h3>
<p>车辆属性类型</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>hardware/interfaces/automotive/vehicle/2.0/types.hal
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>/**
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a> * 枚举支持的车辆属性数据类型。
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a> * 
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a> * 用于在VehicleProperty枚举中创建属性ID。
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a> */
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>enum VehiclePropertyType : int32_t {
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>    STRING          = 0x00100000, // 字符串类型，1048576
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>    BOOLEAN         = 0x00200000, // 布尔类型，2097152
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>    INT32           = 0x00400000, // 32位整数类型，4194304
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>    INT32_VEC       = 0x00410000, // 32位整数向量类型，4259840
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>    INT64           = 0x00500000, // 64位整数类型，5242880
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>    INT64_VEC       = 0x00510000, // 64位整数向量类型，5308416
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>    FLOAT           = 0x00600000, // 浮点数类型，6291456
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>    FLOAT_VEC       = 0x00610000, // 浮点数向量类型，6356992
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>    BYTES           = 0x00700000, // 字节类型，7340032
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>    /**     
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a>     * 标量或向量类型的任意组合。具体格式必须在属性的描述中提供。
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a>     *     
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>     * 对于供应商的混合类型属性，configArray需要按照以下结构进行格式化。
</span><span id="__span-12-23"><a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a>     *      
</span><span id="__span-12-24"><a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a>     * configArray[0]，1表示属性具有字符串值
</span><span id="__span-12-25"><a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a>     * configArray[1]，1表示属性具有布尔值。
</span><span id="__span-12-26"><a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a>     * configArray[2]，1表示属性具有整数值。
</span><span id="__span-12-27"><a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a>     * configArray[3]，数字表示属性中整数数组的大小。
</span><span id="__span-12-28"><a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a>     * configArray[4]，1表示属性具有长整数值。
</span><span id="__span-12-29"><a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a>     * configArray[5]，数字表示属性中长整数数组的大小。
</span><span id="__span-12-30"><a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a>     * configArray[6]，1表示属性具有浮点数值。
</span><span id="__span-12-31"><a id="__codelineno-12-31" name="__codelineno-12-31" href="#__codelineno-12-31"></a>     * configArray[7]，数字表示属性中浮点数数组的大小。
</span><span id="__span-12-32"><a id="__codelineno-12-32" name="__codelineno-12-32" href="#__codelineno-12-32"></a>     * configArray[8]，数字表示属性中字节数组的大小。
</span><span id="__span-12-33"><a id="__codelineno-12-33" name="__codelineno-12-33" href="#__codelineno-12-33"></a>     * 例如：
</span><span id="__span-12-34"><a id="__codelineno-12-34" name="__codelineno-12-34" href="#__codelineno-12-34"></a>     * {@code configArray = {1, 1, 1, 3, 0, 0, 0, 0, 0}} 表示属性具有
</span><span id="__span-12-35"><a id="__codelineno-12-35" name="__codelineno-12-35" href="#__codelineno-12-35"></a>     * 字符串值、布尔值、整数值和一个包含3个整数的数组。
</span><span id="__span-12-36"><a id="__codelineno-12-36" name="__codelineno-12-36" href="#__codelineno-12-36"></a>     */
</span><span id="__span-12-37"><a id="__codelineno-12-37" name="__codelineno-12-37" href="#__codelineno-12-37"></a>    MIXED           = 0x00e00000, // 混合类型，14680064
</span><span id="__span-12-38"><a id="__codelineno-12-38" name="__codelineno-12-38" href="#__codelineno-12-38"></a>
</span><span id="__span-12-39"><a id="__codelineno-12-39" name="__codelineno-12-39" href="#__codelineno-12-39"></a>    MASK            = 0x00ff0000 // 属性类型掩码，16711680
</span><span id="__span-12-40"><a id="__codelineno-12-40" name="__codelineno-12-40" href="#__codelineno-12-40"></a>};
</span></code></pre></div>
<h3 id="vehiclearea">VehicleArea<a class="headerlink" href="#vehiclearea" title="Permanent link">&para;</a></h3>
<p>车辆区域类型</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="n">types</span><span class="p">.</span><span class="n">hal</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="cm">/**</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="cm"> * 车辆区域</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="cm"> * 用于构建 VehicleProperty 枚举中的属性ID。</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="cm"> *</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="cm"> * 一些属性可能与特定的车辆区域相关联。例如，VehicleProperty:DOOR_LOCK 属性必须与特定的车门相关联，</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="cm"> * 因此该属性必须标记为 VehicleArea:DOOR 标志。</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="cm"> *</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="cm"> * 其他属性可能与特定的车辆区域无关。这些属性必须具有 VehicleArea:GLOBAL 标志。</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="cm"> *</span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="cm"> * [定义] 区域：区域表示 AreaType 的一个唯一元素。例如，如果 AreaType 是 WINDOW ，则一个区域可以是 FRONT_WINDSHIELD 。</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="cm"> *</span>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="cm"> * [定义] 区域ID：区域ID 是一个或多个区域的组合，使用 Area 枚举的位掩码表示。不同的 AreaType 不能在一个单独的 AreaID 中混合。</span>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a><span class="cm"> * 例如，窗口区域不能与座位区域组合在一个 AreaID 中。</span>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a><span class="cm"> *</span>
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a><span class="cm"> * 映射分区属性到区域ID 的规则：</span>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a><span class="cm"> *  - 属性必须映射到一个在属性值更改时受影响的 AreaID 数组。</span>
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a><span class="cm"> *  - 数组中的每个元素必须表示一个 AreaID ，在该 AreaID 中，属性值只能在 AreaID 中的所有区域中同时更改，而不能独立更改。</span>
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a><span class="cm"> *    也就是说，当属性值在数组中的一个区域中更改时，它必须自动在 AreaID 中的所有其他区域中更改。</span>
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a><span class="cm"> *  - 属性值必须在数组中的任意两个不同的 AreaID 中独立可控。</span>
</span><span id="__span-13-22"><a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a><span class="cm"> *  - 区域在 AreaID 数组中只能出现一次。也就是说，一个区域只能是 AreaID 数组中的一个区域。</span>
</span><span id="__span-13-23"><a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a><span class="cm"> *</span>
</span><span id="__span-13-24"><a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a><span class="cm"> * [定义] 全局属性：适用于整个车辆并且不与特定区域相关联的属性。例如，FUEL_LEVEL，HVAC_STEERING_WHEEL_HEAT。</span>
</span><span id="__span-13-25"><a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a><span class="cm"> *</span>
</span><span id="__span-13-26"><a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a><span class="cm"> * 映射全局属性到区域ID 的规则：</span>
</span><span id="__span-13-27"><a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a><span class="cm"> *  - 全局属性不得映射到区域ID。</span>
</span><span id="__span-13-28"><a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a><span class="cm">*/</span>
</span><span id="__span-13-29"><a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a><span class="k">enum</span><span class="w"> </span><span class="nc">VehicleArea</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">int32_t</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-30"><a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a><span class="w">    </span><span class="n">GLOBAL</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">0x01000000</span><span class="p">,</span><span class="w"> </span><span class="c1">// 16777216</span>
</span><span id="__span-13-31"><a id="__codelineno-13-31" name="__codelineno-13-31" href="#__codelineno-13-31"></a><span class="w">    </span><span class="n">WINDOW</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">0x03000000</span><span class="p">,</span><span class="w"> </span><span class="c1">// WINDOW映射到VehicleAreaWindow枚举，50331648</span>
</span><span id="__span-13-32"><a id="__codelineno-13-32" name="__codelineno-13-32" href="#__codelineno-13-32"></a><span class="w">    </span><span class="n">MIRROR</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">0x04000000</span><span class="p">,</span><span class="w"> </span><span class="c1">// MIRROR映射到VehicleAreaMirror枚举，67108864</span>
</span><span id="__span-13-33"><a id="__codelineno-13-33" name="__codelineno-13-33" href="#__codelineno-13-33"></a><span class="w">    </span><span class="n">SEAT</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="mh">0x05000000</span><span class="p">,</span><span class="w"> </span><span class="c1">// SEAT映射到VehicleAreaSeat枚举，83886080</span>
</span><span id="__span-13-34"><a id="__codelineno-13-34" name="__codelineno-13-34" href="#__codelineno-13-34"></a><span class="w">    </span><span class="n">DOOR</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="mh">0x06000000</span><span class="p">,</span><span class="w"> </span><span class="c1">// DOOR映射到VehicleAreaDoor枚举，100663296</span>
</span><span id="__span-13-35"><a id="__codelineno-13-35" name="__codelineno-13-35" href="#__codelineno-13-35"></a><span class="w">    </span><span class="n">WHEEL</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">0x07000000</span><span class="p">,</span><span class="w"> </span><span class="c1">// WHEEL映射到VehicleAreaWheel枚举，117440512</span>
</span><span id="__span-13-36"><a id="__codelineno-13-36" name="__codelineno-13-36" href="#__codelineno-13-36"></a>
</span><span id="__span-13-37"><a id="__codelineno-13-37" name="__codelineno-13-37" href="#__codelineno-13-37"></a><span class="w">    </span><span class="n">MASK</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0f000000</span><span class="p">,</span><span class="w"> </span><span class="c1">//251658240</span>
</span><span id="__span-13-38"><a id="__codelineno-13-38" name="__codelineno-13-38" href="#__codelineno-13-38"></a><span class="p">};</span>
</span></code></pre></div>
<h4 id="vehiclepropertygroup">VehiclePropertyGroup<a class="headerlink" href="#vehiclepropertygroup" title="Permanent link">&para;</a></h4>
<p>车辆属性分组类型</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="n">types</span><span class="p">.</span><span class="n">hal</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="cm">/**</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="cm"> * 定义了属性组的枚举类型。</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="cm"> *</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="cm"> * 用于在VehicleProperty枚举中创建属性ID。</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="cm"> */</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="k">enum</span><span class="w"> </span><span class="nc">VehiclePropertyGroup</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">int32_t</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="cm">     * </span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="cm">     */</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="w">    </span><span class="n">SYSTEM</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">0x10000000</span><span class="p">,</span><span class="w"> </span><span class="c1">// 在AOSP中声明的属性必须使用此标志， 268435456</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="cm">     * </span>
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a><span class="cm">     */</span>
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a><span class="w">    </span><span class="n">VENDOR</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">0x20000000</span><span class="p">,</span><span class="w"> </span><span class="c1">// 由供应商声明的属性必须使用此标志， 536870912</span>
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a>
</span><span id="__span-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a><span class="w">    </span><span class="n">MASK</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="mh">0xf0000000</span><span class="p">,</span><span class="w"> </span><span class="c1">// -268435456 ?</span>
</span><span id="__span-14-20"><a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a><span class="p">};</span>
</span></code></pre></div>
<h4 id="vehicleareawindow">VehicleAreaWindow<a class="headerlink" href="#vehicleareawindow" title="Permanent link">&para;</a></h4>
<p>车辆窗户区域属性</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="n">types</span><span class="p">.</span><span class="n">hal</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="cm">/**</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="cm"> * 定义了车辆中的各种挡风玻璃/窗户。</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="cm"> */</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="k">enum</span><span class="w"> </span><span class="nc">VehicleAreaWindow</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">int32_t</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="w">    </span><span class="n">FRONT_WINDSHIELD</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00000001</span><span class="p">,</span><span class="w">  </span><span class="c1">// 前挡风玻璃，1</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="w">    </span><span class="n">REAR_WINDSHIELD</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00000002</span><span class="p">,</span><span class="w">  </span><span class="c1">// 后挡风玻璃，2</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="w">    </span><span class="n">ROW_1_LEFT</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00000010</span><span class="p">,</span><span class="w">  </span><span class="c1">// 第一排左侧窗户，16</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="w">    </span><span class="n">ROW_1_RIGHT</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00000040</span><span class="p">,</span><span class="w">  </span><span class="c1">// 第一排右侧窗户，64</span>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="w">    </span><span class="n">ROW_2_LEFT</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00000100</span><span class="p">,</span><span class="w">  </span><span class="c1">// 第二排左侧窗户，256</span>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="w">    </span><span class="n">ROW_2_RIGHT</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00000400</span><span class="p">,</span><span class="w">  </span><span class="c1">// 第二排右侧窗户，1024</span>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a><span class="w">    </span><span class="n">ROW_3_LEFT</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00001000</span><span class="p">,</span><span class="w">  </span><span class="c1">// 第三排左侧窗户，4096</span>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="w">    </span><span class="n">ROW_3_RIGHT</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00004000</span><span class="p">,</span><span class="w">  </span><span class="c1">// 第三排右侧窗户，16384</span>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a><span class="w">    </span><span class="n">ROOF_TOP_1</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00010000</span><span class="p">,</span><span class="w">  </span><span class="c1">// 顶部1号窗户，65536</span>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a><span class="w">    </span><span class="n">ROOF_TOP_2</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00020000</span><span class="p">,</span><span class="w">  </span><span class="c1">// 顶部2号窗户，131072</span>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a><span class="p">};</span>
</span></code></pre></div>
<h3 id="vehiclepropertyaccess">VehiclePropertyAccess<a class="headerlink" href="#vehiclepropertyaccess" title="Permanent link">&para;</a></h3>
<p>车辆属性访问权限</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="n">types</span><span class="p">.</span><span class="n">hal</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="cm">/**</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="cm"> * Property config 定义了它的功能。API的用户必须首先获取 property config，</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="cm"> * 以了解 get() 命令的输出，并确保 set() 或 events 命令与预期输出同步。</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="cm"> */</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="k">enum</span><span class="w"> </span><span class="nc">VehiclePropertyAccess</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">int32_t</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="w">    </span><span class="n">NONE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="c1">// 没有访问权限，0</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="w">    </span><span class="n">READ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x01</span><span class="p">,</span><span class="w"> </span><span class="c1">// 只读权限，1</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="w">    </span><span class="n">WRITE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x02</span><span class="p">,</span><span class="w"> </span><span class="c1">// 只写权限，2</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="w">    </span><span class="n">READ_WRITE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x03</span><span class="p">,</span><span class="w"> </span><span class="c1">// 读写权限，3</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="p">};</span>
</span></code></pre></div>
<h3 id="vehiclepropertychangemode">VehiclePropertyChangeMode<a class="headerlink" href="#vehiclepropertychangemode" title="Permanent link">&para;</a></h3>
<p>车辆属性变化模式</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="n">types</span><span class="p">.</span><span class="n">hal</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="cm">/**</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="cm"> * 描述属性值如何变化的枚举类型</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="cm"> */</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="k">enum</span><span class="w"> </span><span class="nc">VehiclePropertyChangeMode</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">int32_t</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="w">    </span><span class="cm">/**     </span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="cm">     * 此类型的属性不能被更改。不支持对这些属性进行 subscribe 订阅。只能 IVehicle.get() 获取</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="cm">     */</span>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="w">    </span><span class="n">STATIC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a><span class="cm">     * ON_CHANGE 这个类型的属性当变化时必须上报</span>
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a><span class="cm">     * 此类型的属性在发生变化时必须报告。 IVehicle.get() 调用必须返回当前值。</span>
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a><span class="cm">     * 对于此属性的设置操作被假定为异步的。当在 IVehicle.set() 之后读取属性（使用 IVehicle.get() ）时，</span>
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a><span class="cm">     * 它可能仍然返回旧值，直到支持此属性的底层硬件实际上改变了状态。一旦状态改变，属性必须作为事件分发已更改的值。</span>
</span><span id="__span-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a><span class="cm">     */</span>
</span><span id="__span-17-18"><a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a><span class="w">    </span><span class="n">ON_CHANGE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x01</span><span class="p">,</span>
</span><span id="__span-17-19"><a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a>
</span><span id="__span-17-20"><a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-17-21"><a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a><span class="cm">     * 此类型的属性连续变化，并且需要固定的采样率来检索数据。实现者可以选择在重要的值变化时发送额外的通知。</span>
</span><span id="__span-17-22"><a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a><span class="cm">     */</span>
</span><span id="__span-17-23"><a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a><span class="w">    </span><span class="n">CONTINUOUS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x02</span><span class="p">,</span>
</span><span id="__span-17-24"><a id="__codelineno-17-24" name="__codelineno-17-24" href="#__codelineno-17-24"></a><span class="p">};</span>
</span></code></pre></div>
<h3 id="subscribeoptions">SubscribeOptions<a class="headerlink" href="#subscribeoptions" title="Permanent link">&para;</a></h3>
<p>车辆属性事件订阅信息</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="n">types</span><span class="p">.</span><span class="n">hal</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="cm">/**</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="cm"> * 封装了有关订阅车辆属性事件的信息。</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="cm"> */</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="k">struct</span><span class="w"> </span><span class="nc">SubscribeOptions</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="w">    </span><span class="cm">/** 要订阅的属性 */</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="w">    </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">propId</span><span class="p">;</span>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="cm">     * 采样率，以赫兹(Hz)为单位。</span>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="cm">     *</span>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="cm">     * 对于具有 VehiclePropertyChangeMode::CONTINUOUS 的属性，必须提供。</span>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="cm">     * 该值必须在给定属性的 VehiclePropConfig#minSamplingRate .. VehiclePropConfig#maxSamplingRate 范围内。</span>
</span><span id="__span-18-15"><a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="cm">     * 此值表示客户端希望每秒接收多少次更新。</span>
</span><span id="__span-18-16"><a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="cm">     */</span>
</span><span id="__span-18-17"><a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">sampleRate</span><span class="p">;</span>
</span><span id="__span-18-18"><a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a>
</span><span id="__span-18-19"><a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a><span class="w">    </span><span class="cm">/** 指示要监听哪些事件源的标志。 */</span>
</span><span id="__span-18-20"><a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a><span class="w">    </span><span class="n">SubscribeFlags</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span>
</span><span id="__span-18-21"><a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a><span class="p">};</span>
</span><span id="__span-18-22"><a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a>
</span><span id="__span-18-23"><a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a><span class="k">enum</span><span class="w"> </span><span class="nc">SubscribeFlags</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">int32_t</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-24"><a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a><span class="w">    </span><span class="n">UNDEFINED</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0</span><span class="p">,</span>
</span><span id="__span-18-25"><a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a>
</span><span id="__span-18-26"><a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-18-27"><a id="__codelineno-18-27" name="__codelineno-18-27" href="#__codelineno-18-27"></a><span class="cm">     * 订阅来自车辆HAL的事件</span>
</span><span id="__span-18-28"><a id="__codelineno-18-28" name="__codelineno-18-28" href="#__codelineno-18-28"></a><span class="cm">     * （很可能是车辆本身产生的事件）。</span>
</span><span id="__span-18-29"><a id="__codelineno-18-29" name="__codelineno-18-29" href="#__codelineno-18-29"></a><span class="cm">     */</span>
</span><span id="__span-18-30"><a id="__codelineno-18-30" name="__codelineno-18-30" href="#__codelineno-18-30"></a><span class="w">    </span><span class="n">EVENTS_FROM_CAR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x1</span><span class="p">,</span>
</span><span id="__span-18-31"><a id="__codelineno-18-31" name="__codelineno-18-31" href="#__codelineno-18-31"></a>
</span><span id="__span-18-32"><a id="__codelineno-18-32" name="__codelineno-18-32" href="#__codelineno-18-32"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-18-33"><a id="__codelineno-18-33" name="__codelineno-18-33" href="#__codelineno-18-33"></a><span class="cm">     * 使用此标志订阅当车辆HAL的客户端（例如Car Service）调用 IVehicle.set（...） 时的事件。</span>
</span><span id="__span-18-34"><a id="__codelineno-18-34" name="__codelineno-18-34" href="#__codelineno-18-34"></a><span class="cm">     */</span>
</span><span id="__span-18-35"><a id="__codelineno-18-35" name="__codelineno-18-35" href="#__codelineno-18-35"></a><span class="w">    </span><span class="n">EVENTS_FROM_ANDROID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x2</span><span class="p">,</span>
</span><span id="__span-18-36"><a id="__codelineno-18-36" name="__codelineno-18-36" href="#__codelineno-18-36"></a><span class="p">};</span>
</span></code></pre></div>
<h3 id="vehicleareaseat">VehicleAreaSeat<a class="headerlink" href="#vehicleareaseat" title="Permanent link">&para;</a></h3>
<p>车辆座椅属性</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="n">types</span><span class="p">.</span><span class="n">hal</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="cm">/**</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="cm"> * 不同的车辆座位。</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="cm"> */</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="k">enum</span><span class="w"> </span><span class="nc">VehicleAreaSeat</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">int32_t</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="w">    </span><span class="n">ROW_1_LEFT</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0001</span><span class="p">,</span><span class="w">   </span><span class="c1">// 第一排左侧座位， 1</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="w">    </span><span class="n">ROW_1_CENTER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0002</span><span class="p">,</span><span class="w">   </span><span class="c1">// 第一排中间座位， 2</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="w">    </span><span class="n">ROW_1_RIGHT</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0004</span><span class="p">,</span><span class="w">   </span><span class="c1">// 第一排右侧座位， 4</span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="w">    </span><span class="n">ROW_2_LEFT</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0010</span><span class="p">,</span><span class="w">   </span><span class="c1">// 第二排左侧座位， 16</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="w">    </span><span class="n">ROW_2_CENTER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0020</span><span class="p">,</span><span class="w">   </span><span class="c1">// 第二排中间座位， 32</span>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="w">    </span><span class="n">ROW_2_RIGHT</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0040</span><span class="p">,</span><span class="w">   </span><span class="c1">// 第二排右侧座位， 64</span>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="w">    </span><span class="n">ROW_3_LEFT</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0100</span><span class="p">,</span><span class="w">   </span><span class="c1">// 第三排左侧座位， 256</span>
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="w">    </span><span class="n">ROW_3_CENTER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0200</span><span class="p">,</span><span class="w">   </span><span class="c1">// 第三排中间座位， 512</span>
</span><span id="__span-19-15"><a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="w">    </span><span class="n">ROW_3_RIGHT</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0400</span><span class="w">    </span><span class="c1">// 第三排右侧座位， 1024</span>
</span><span id="__span-19-16"><a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a><span class="p">};</span>
</span></code></pre></div>
<h3 id="statuscode">StatusCode<a class="headerlink" href="#statuscode" title="Permanent link">&para;</a></h3>
<p>接口调用状态值</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="n">types</span><span class="p">.</span><span class="n">hal</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="cm">/** </span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="cm"> * 车辆HAL接口中使用的错误代码。</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="cm"> */</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="k">enum</span><span class="w"> </span><span class="nc">StatusCode</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">int32_t</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="w">    </span><span class="n">OK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="w">    </span><span class="c1">// 再试一次</span>
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="w">    </span><span class="n">TRY_AGAIN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a>
</span><span id="__span-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="w">    </span><span class="c1">// 提供的参数无效</span>
</span><span id="__span-20-13"><a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a><span class="w">    </span><span class="n">INVALID_ARG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
</span><span id="__span-20-14"><a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a>
</span><span id="__span-20-15"><a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a><span class="w">    </span><span class="c1">// 当与车辆属性关联的设备不可用时，必须返回此代码。例如，当客户端尝试在整个HVAC单元关闭时设置HVAC温度。     </span>
</span><span id="__span-20-16"><a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a><span class="w">    </span><span class="n">NOT_AVAILABLE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
</span><span id="__span-20-17"><a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a>
</span><span id="__span-20-18"><a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a><span class="w">    </span><span class="c1">// 访问被拒绝</span>
</span><span id="__span-20-19"><a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a><span class="w">    </span><span class="n">ACCESS_DENIED</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span>
</span><span id="__span-20-20"><a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a>
</span><span id="__span-20-21"><a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a><span class="w">    </span><span class="c1">// 在车辆HAL中发生了意外情况</span>
</span><span id="__span-20-22"><a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a><span class="w">    </span><span class="n">INTERNAL_ERROR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span>
</span><span id="__span-20-23"><a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a><span class="p">};</span>
</span></code></pre></div>
<h2 id="ivehiclehal">IVehicle.hal<a class="headerlink" href="#ivehiclehal" title="Permanent link">&para;</a></h2>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="n">IVehicle</span><span class="p">.</span><span class="n">hal</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="n">interface</span><span class="w"> </span><span class="n">IVehicle</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="w">  </span><span class="cm">/**</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="cm">   * 返回此车辆HAL支持的所有属性配置的列表。</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="cm">   */</span>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="w">  </span><span class="n">getAllPropConfigs</span><span class="p">()</span><span class="w"> </span><span class="n">generates</span><span class="w"> </span><span class="p">(</span><span class="n">vec</span><span class="o">&lt;</span><span class="n">VehiclePropConfig</span><span class="o">&gt;</span><span class="w"> </span><span class="n">propConfigs</span><span class="p">);</span>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a><span class="w">  </span><span class="cm">/**</span>
</span><span id="__span-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a><span class="cm">   * 返回给定属性的属性配置列表。</span>
</span><span id="__span-21-11"><a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a><span class="cm">   *</span>
</span><span id="__span-21-12"><a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="cm">   * 如果未找到请求的 VehicleProperty ，则必须返回 StatusCode::INVALID_ARG，</span>
</span><span id="__span-21-13"><a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a><span class="cm">   * 否则返回带有 StatusCode::OK 的车辆属性配置列表。</span>
</span><span id="__span-21-14"><a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a><span class="cm">   */</span>
</span><span id="__span-21-15"><a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a><span class="w">  </span><span class="n">getPropConfigs</span><span class="p">(</span><span class="n">vec</span><span class="o">&lt;</span><span class="kt">int32_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">props</span><span class="p">)</span>
</span><span id="__span-21-16"><a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a><span class="w">          </span><span class="n">generates</span><span class="w"> </span><span class="p">(</span><span class="n">StatusCode</span><span class="w"> </span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">vec</span><span class="o">&lt;</span><span class="n">VehiclePropConfig</span><span class="o">&gt;</span><span class="w"> </span><span class="n">propConfigs</span><span class="p">);</span>
</span><span id="__span-21-17"><a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a>
</span><span id="__span-21-18"><a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a><span class="w">  </span><span class="cm">/**</span>
</span><span id="__span-21-19"><a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a><span class="cm">   * 获取车辆属性值。</span>
</span><span id="__span-21-20"><a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a><span class="cm">   *</span>
</span><span id="__span-21-21"><a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a><span class="cm">   * 对于 VehiclePropertyChangeMode::STATIC 属性，此方法必须始终返回相同的值。</span>
</span><span id="__span-21-22"><a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a><span class="cm">   * 对于 VehiclePropertyChangeMode::ON_CHANGE 属性，它必须返回最新可用的值。</span>
</span><span id="__span-21-23"><a id="__codelineno-21-23" name="__codelineno-21-23" href="#__codelineno-21-23"></a><span class="cm">   *</span>
</span><span id="__span-21-24"><a id="__codelineno-21-24" name="__codelineno-21-24" href="#__codelineno-21-24"></a><span class="cm">   * 一些属性（如 RADIO_PRESET ）需要在GET请求中传递 VehiclePropValue 对象中的附加数据。</span>
</span><span id="__span-21-25"><a id="__codelineno-21-25" name="__codelineno-21-25" href="#__codelineno-21-25"></a><span class="cm">   *</span>
</span><span id="__span-21-26"><a id="__codelineno-21-26" name="__codelineno-21-26" href="#__codelineno-21-26"></a><span class="cm">   * 如果尚无可用数据，即在初始阶段可能发生的情况下，此调用必须立即返回 StatusCode::TRY_AGAIN 的错误代码。</span>
</span><span id="__span-21-27"><a id="__codelineno-21-27" name="__codelineno-21-27" href="#__codelineno-21-27"></a><span class="cm">   */</span>
</span><span id="__span-21-28"><a id="__codelineno-21-28" name="__codelineno-21-28" href="#__codelineno-21-28"></a><span class="w">  </span><span class="n">get</span><span class="p">(</span><span class="n">VehiclePropValue</span><span class="w"> </span><span class="n">requestedPropValue</span><span class="p">)</span>
</span><span id="__span-21-29"><a id="__codelineno-21-29" name="__codelineno-21-29" href="#__codelineno-21-29"></a><span class="w">          </span><span class="n">generates</span><span class="w"> </span><span class="p">(</span><span class="n">StatusCode</span><span class="w"> </span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">VehiclePropValue</span><span class="w"> </span><span class="n">propValue</span><span class="p">);</span>
</span><span id="__span-21-30"><a id="__codelineno-21-30" name="__codelineno-21-30" href="#__codelineno-21-30"></a>
</span><span id="__span-21-31"><a id="__codelineno-21-31" name="__codelineno-21-31" href="#__codelineno-21-31"></a><span class="w">  </span><span class="cm">/**</span>
</span><span id="__span-21-32"><a id="__codelineno-21-32" name="__codelineno-21-32" href="#__codelineno-21-32"></a><span class="cm">   * 设置车辆属性值。</span>
</span><span id="__span-21-33"><a id="__codelineno-21-33" name="__codelineno-21-33" href="#__codelineno-21-33"></a><span class="cm">   *</span>
</span><span id="__span-21-34"><a id="__codelineno-21-34" name="__codelineno-21-34" href="#__codelineno-21-34"></a><span class="cm">   * 忽略数据的时间戳。</span>
</span><span id="__span-21-35"><a id="__codelineno-21-35" name="__codelineno-21-35" href="#__codelineno-21-35"></a><span class="cm">   *</span>
</span><span id="__span-21-36"><a id="__codelineno-21-36" name="__codelineno-21-36" href="#__codelineno-21-36"></a><span class="cm">   * 设置某些属性需要有初始状态可用。如果初始数据尚不可用，则此调用必须返回 StatusCode::TRY_AGAIN。</span>
</span><span id="__span-21-37"><a id="__codelineno-21-37" name="__codelineno-21-37" href="#__codelineno-21-37"></a><span class="cm">   * 对于具有单独电源控制的属性，如果未启动属性，则此调用必须返回 StatusCode::NOT_AVAILABLE错误。</span>
</span><span id="__span-21-38"><a id="__codelineno-21-38" name="__codelineno-21-38" href="#__codelineno-21-38"></a><span class="cm">   */</span>
</span><span id="__span-21-39"><a id="__codelineno-21-39" name="__codelineno-21-39" href="#__codelineno-21-39"></a><span class="w">  </span><span class="n">set</span><span class="p">(</span><span class="n">VehiclePropValue</span><span class="w"> </span><span class="n">propValue</span><span class="p">)</span><span class="w"> </span><span class="n">generates</span><span class="w"> </span><span class="p">(</span><span class="n">StatusCode</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
</span><span id="__span-21-40"><a id="__codelineno-21-40" name="__codelineno-21-40" href="#__codelineno-21-40"></a>
</span><span id="__span-21-41"><a id="__codelineno-21-41" name="__codelineno-21-41" href="#__codelineno-21-41"></a><span class="w">  </span><span class="cm">/**</span>
</span><span id="__span-21-42"><a id="__codelineno-21-42" name="__codelineno-21-42" href="#__codelineno-21-42"></a><span class="cm">   * 订阅属性事件。</span>
</span><span id="__span-21-43"><a id="__codelineno-21-43" name="__codelineno-21-43" href="#__codelineno-21-43"></a><span class="cm">   *</span>
</span><span id="__span-21-44"><a id="__codelineno-21-44" name="__codelineno-21-44" href="#__codelineno-21-44"></a><span class="cm">   * 客户端必须能够根据选项参数中提供的数据订阅多个属性。</span>
</span><span id="__span-21-45"><a id="__codelineno-21-45" name="__codelineno-21-45" href="#__codelineno-21-45"></a><span class="cm">   *</span>
</span><span id="__span-21-46"><a id="__codelineno-21-46" name="__codelineno-21-46" href="#__codelineno-21-46"></a><span class="cm">   * @param listener 此客户端必须在适当的事件上被调用。</span>
</span><span id="__span-21-47"><a id="__codelineno-21-47" name="__codelineno-21-47" href="#__codelineno-21-47"></a><span class="cm">   * @param options 订阅的选项列表。SubscribeOption包含诸如属性Id、区域Id、采样率等信息。</span>
</span><span id="__span-21-48"><a id="__codelineno-21-48" name="__codelineno-21-48" href="#__codelineno-21-48"></a><span class="cm">   */</span>
</span><span id="__span-21-49"><a id="__codelineno-21-49" name="__codelineno-21-49" href="#__codelineno-21-49"></a><span class="w">  </span><span class="n">subscribe</span><span class="p">(</span><span class="n">IVehicleCallback</span><span class="w"> </span><span class="n">callback</span><span class="p">,</span><span class="w"> </span><span class="n">vec</span><span class="o">&lt;</span><span class="n">SubscribeOptions</span><span class="o">&gt;</span><span class="w"> </span><span class="n">options</span><span class="p">)</span>
</span><span id="__span-21-50"><a id="__codelineno-21-50" name="__codelineno-21-50" href="#__codelineno-21-50"></a><span class="w">          </span><span class="n">generates</span><span class="w"> </span><span class="p">(</span><span class="n">StatusCode</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
</span><span id="__span-21-51"><a id="__codelineno-21-51" name="__codelineno-21-51" href="#__codelineno-21-51"></a>
</span><span id="__span-21-52"><a id="__codelineno-21-52" name="__codelineno-21-52" href="#__codelineno-21-52"></a><span class="w">  </span><span class="cm">/**</span>
</span><span id="__span-21-53"><a id="__codelineno-21-53" name="__codelineno-21-53" href="#__codelineno-21-53"></a><span class="cm">   * 取消订阅属性事件。</span>
</span><span id="__span-21-54"><a id="__codelineno-21-54" name="__codelineno-21-54" href="#__codelineno-21-54"></a><span class="cm">   *</span>
</span><span id="__span-21-55"><a id="__codelineno-21-55" name="__codelineno-21-55" href="#__codelineno-21-55"></a><span class="cm">   * 如果此客户端未订阅给定属性，则此方法必须返回StatusCode::INVALID_ARG。</span>
</span><span id="__span-21-56"><a id="__codelineno-21-56" name="__codelineno-21-56" href="#__codelineno-21-56"></a><span class="cm">   */</span>
</span><span id="__span-21-57"><a id="__codelineno-21-57" name="__codelineno-21-57" href="#__codelineno-21-57"></a><span class="w">  </span><span class="n">unsubscribe</span><span class="p">(</span><span class="n">IVehicleCallback</span><span class="w"> </span><span class="n">callback</span><span class="p">,</span><span class="w"> </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">propId</span><span class="p">)</span>
</span><span id="__span-21-58"><a id="__codelineno-21-58" name="__codelineno-21-58" href="#__codelineno-21-58"></a><span class="w">          </span><span class="n">generates</span><span class="w"> </span><span class="p">(</span><span class="n">StatusCode</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
</span><span id="__span-21-59"><a id="__codelineno-21-59" name="__codelineno-21-59" href="#__codelineno-21-59"></a>
</span><span id="__span-21-60"><a id="__codelineno-21-60" name="__codelineno-21-60" href="#__codelineno-21-60"></a><span class="w">  </span><span class="cm">/**</span>
</span><span id="__span-21-61"><a id="__codelineno-21-61" name="__codelineno-21-61" href="#__codelineno-21-61"></a><span class="cm">   * 打印车辆HAL的调试状态。</span>
</span><span id="__span-21-62"><a id="__codelineno-21-62" name="__codelineno-21-62" href="#__codelineno-21-62"></a><span class="cm">   */</span>
</span><span id="__span-21-63"><a id="__codelineno-21-63" name="__codelineno-21-63" href="#__codelineno-21-63"></a><span class="w">  </span><span class="n">debugDump</span><span class="p">()</span><span class="w"> </span><span class="n">generates</span><span class="w"> </span><span class="p">(</span><span class="n">string</span><span class="w"> </span><span class="n">s</span><span class="p">);</span>
</span><span id="__span-21-64"><a id="__codelineno-21-64" name="__codelineno-21-64" href="#__codelineno-21-64"></a><span class="p">};</span>
</span></code></pre></div>
<h2 id="ivehiclecallbackhal">IVehicleCallback.hal<a class="headerlink" href="#ivehiclecallbackhal" title="Permanent link">&para;</a></h2>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="n">IVehicleCallback</span><span class="p">.</span><span class="n">hal</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="n">interface</span><span class="w"> </span><span class="n">IVehicleCallback</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="cm">     * 当API用户订阅的变量需要报告时，会触发此事件回调。这可能是基于阈值和频率（常规订阅，参见subscribe调用的参数），</span>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="cm">     * 或者当调用 IVehicle.set() 方法并且需要报告实际更改时。</span>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="cm">     *</span>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a><span class="cm">     * 这些回调是分块的。</span>
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a><span class="cm">     *</span>
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a><span class="cm">     * @param values 更新的值。</span>
</span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a><span class="cm">     */</span>
</span><span id="__span-22-13"><a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a><span class="w">    </span><span class="n">oneway</span><span class="w"> </span><span class="nf">onPropertyEvent</span><span class="p">(</span><span class="n">vec</span><span class="o">&lt;</span><span class="n">VehiclePropValue</span><span class="o">&gt;</span><span class="w"> </span><span class="n">propValues</span><span class="p">);</span>
</span><span id="__span-22-14"><a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>
</span><span id="__span-22-15"><a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-22-16"><a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a><span class="cm">     * 如果客户端使用 SubscribeFlags::EVENTS_FROM_ANDROID 标志订阅了属性，并且调用了 IVehicle.set(...) 方法，</span>
</span><span id="__span-22-17"><a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a><span class="cm">     * 则会调用此方法。</span>
</span><span id="__span-22-18"><a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a><span class="cm">     *</span>
</span><span id="__span-22-19"><a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a><span class="cm">     * 这些事件必须立即传递给订阅者，不进行任何批处理。</span>
</span><span id="__span-22-20"><a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a><span class="cm">     *</span>
</span><span id="__span-22-21"><a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a><span class="cm">     * @param value 客户端设置的值。</span>
</span><span id="__span-22-22"><a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a><span class="cm">     */</span>
</span><span id="__span-22-23"><a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a><span class="w">    </span><span class="n">oneway</span><span class="w"> </span><span class="nf">onPropertySet</span><span class="p">(</span><span class="n">VehiclePropValue</span><span class="w"> </span><span class="n">propValue</span><span class="p">);</span>
</span><span id="__span-22-24"><a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a>
</span><span id="__span-22-25"><a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a><span class="w">    </span><span class="cm">/**</span>
</span><span id="__span-22-26"><a id="__codelineno-22-26" name="__codelineno-22-26" href="#__codelineno-22-26"></a><span class="cm">     * 设置属性值通常是异步操作。因此，即使客户端从IVehicle::set(...)收到StatusCode::OK，</span>
</span><span id="__span-22-27"><a id="__codelineno-22-27" name="__codelineno-22-27" href="#__codelineno-22-27"></a><span class="cm">     * 这也不能保证该值已成功传播到车辆网络。如果发生这种罕见的事件，必须调用此方法。</span>
</span><span id="__span-22-28"><a id="__codelineno-22-28" name="__codelineno-22-28" href="#__codelineno-22-28"></a><span class="cm">     *</span>
</span><span id="__span-22-29"><a id="__codelineno-22-29" name="__codelineno-22-29" href="#__codelineno-22-29"></a><span class="cm">     * @param errorCode - StatusCode枚举中的任何值。</span>
</span><span id="__span-22-30"><a id="__codelineno-22-30" name="__codelineno-22-30" href="#__codelineno-22-30"></a><span class="cm">     * @param property - 发生错误的属性。</span>
</span><span id="__span-22-31"><a id="__codelineno-22-31" name="__codelineno-22-31" href="#__codelineno-22-31"></a><span class="cm">     * @param areaId - 指定发生问题的区域的位掩码，对于全局属性必须为0。</span>
</span><span id="__span-22-32"><a id="__codelineno-22-32" name="__codelineno-22-32" href="#__codelineno-22-32"></a><span class="cm">     */</span>
</span><span id="__span-22-33"><a id="__codelineno-22-33" name="__codelineno-22-33" href="#__codelineno-22-33"></a><span class="w">    </span><span class="n">oneway</span><span class="w"> </span><span class="nf">onPropertySetError</span><span class="p">(</span><span class="n">StatusCode</span><span class="w"> </span><span class="n">errorCode</span><span class="p">,</span>
</span><span id="__span-22-34"><a id="__codelineno-22-34" name="__codelineno-22-34" href="#__codelineno-22-34"></a><span class="w">                              </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">propId</span><span class="p">,</span>
</span><span id="__span-22-35"><a id="__codelineno-22-35" name="__codelineno-22-35" href="#__codelineno-22-35"></a><span class="w">                              </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">areaId</span><span class="p">);</span>
</span><span id="__span-22-36"><a id="__codelineno-22-36" name="__codelineno-22-36" href="#__codelineno-22-36"></a><span class="p">};</span>
</span></code></pre></div>
<h2 id="vehiclehal_2">VehicleHal 获取（设置）属性<a class="headerlink" href="#vehiclehal_2" title="Permanent link">&para;</a></h2>
<h3 id="subscribe">subscribe订阅属性<a class="headerlink" href="#subscribe" title="Permanent link">&para;</a></h3>
<h4 id="carserviceoncreate">CarService.onCreate()<a class="headerlink" href="#carserviceoncreate" title="Permanent link">&para;</a></h4>
<p>CarService 在 onCreate() 中创建 ICarImpl</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="n">packages</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">Car</span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">car</span><span class="o">/</span><span class="n">CarService</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="nd">@Override</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onCreate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="w">    </span><span class="n">mVehicle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getVehicle</span><span class="p">();</span>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a><span class="w">    </span><span class="n">mICarImpl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ICarImpl</span><span class="p">(</span><span class="k">this</span><span class="p">,</span>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="w">            </span><span class="n">mVehicle</span><span class="p">,</span>
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a><span class="w">            </span><span class="n">SystemInterface</span><span class="p">.</span><span class="na">Builder</span><span class="p">.</span><span class="na">defaultSystemInterface</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="na">build</span><span class="p">(),</span>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a><span class="w">            </span><span class="n">mVehicleInterfaceName</span><span class="p">);</span>
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a><span class="w">    </span><span class="n">mICarImpl</span><span class="p">.</span><span class="na">init</span><span class="p">();</span>
</span><span id="__span-23-14"><a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a>
</span><span id="__span-23-15"><a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-23-16"><a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a><span class="p">}</span>
</span></code></pre></div>
<p>创建 ICarImpl 的时候传了 mVehicle 进去，也就是 IVehicle 。</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>packages/services/Car/service/src/com/android/car/CarService.java
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>@Nullable
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>private static IVehicle getVehicle() {
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a>    final String instanceName = SystemProperties.get(&quot;ro.vehicle.hal&quot;, &quot;default&quot;);
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a>    try {
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a>        return android.hardware.automotive.vehicle.V2_0.IVehicle.getService(instanceName);
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a>    } catch (RemoteException e) {
</span><span id="__span-24-10"><a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a>        Slog.e(CarLog.TAG_SERVICE, &quot;Failed to get IVehicle/&quot; + instanceName + &quot; service&quot;, e);
</span><span id="__span-24-11"><a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a>    } catch (NoSuchElementException e) {
</span><span id="__span-24-12"><a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a>        Slog.e(CarLog.TAG_SERVICE, &quot;IVehicle/&quot; + instanceName + &quot; service not registered yet&quot;);
</span><span id="__span-24-13"><a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a>    }
</span><span id="__span-24-14"><a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a>    return null;
</span><span id="__span-24-15"><a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a>}
</span></code></pre></div>
<p>好家伙，就是 VehicleHAl 服务。</p>
<h4 id="icarimpl">ICarImpl构造函数<a class="headerlink" href="#icarimpl" title="Permanent link">&para;</a></h4>
<p>构造函数中 new VehicleHal 对象，然后又在 CarImpl 的 init() 函数中调用 VehicleHal 对象的 init() 函数</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="n">packages</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">Car</span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">car</span><span class="o">/</span><span class="n">ICarImpl</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="kd">public</span><span class="w"> </span><span class="nf">ICarImpl</span><span class="p">(</span><span class="n">Context</span><span class="w"> </span><span class="n">serviceContext</span><span class="p">,</span><span class="w"> </span><span class="n">IVehicle</span><span class="w"> </span><span class="n">vehicle</span><span class="p">,</span><span class="w"> </span><span class="n">SystemInterface</span><span class="w"> </span><span class="n">systemInterface</span><span class="p">,</span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">vehicleInterfaceName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="w">    </span><span class="k">this</span><span class="p">(</span><span class="n">serviceContext</span><span class="p">,</span><span class="w"> </span><span class="n">vehicle</span><span class="p">,</span><span class="w"> </span><span class="n">systemInterface</span><span class="p">,</span><span class="w"> </span><span class="n">vehicleInterfaceName</span><span class="p">,</span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="w">            </span><span class="cm">/* carUserService= */</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="cm">/* carWatchdogService= */</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="w">            </span><span class="cm">/* powerPolicyDaemon= */</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="p">}</span>
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a>
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a><span class="nd">@VisibleForTesting</span>
</span><span id="__span-25-11"><a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a><span class="n">ICarImpl</span><span class="p">(</span><span class="n">Context</span><span class="w"> </span><span class="n">serviceContext</span><span class="p">,</span><span class="w"> </span><span class="n">IVehicle</span><span class="w"> </span><span class="n">vehicle</span><span class="p">,</span><span class="w"> </span><span class="n">SystemInterface</span><span class="w"> </span><span class="n">systemInterface</span><span class="p">,</span>
</span><span id="__span-25-12"><a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">vehicleInterfaceName</span><span class="p">,</span>
</span><span id="__span-25-13"><a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a><span class="w">        </span><span class="nd">@Nullable</span><span class="w"> </span><span class="n">CarUserService</span><span class="w"> </span><span class="n">carUserService</span><span class="p">,</span>
</span><span id="__span-25-14"><a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a><span class="w">        </span><span class="nd">@Nullable</span><span class="w"> </span><span class="n">CarWatchdogService</span><span class="w"> </span><span class="n">carWatchdogService</span><span class="p">,</span>
</span><span id="__span-25-15"><a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a><span class="w">        </span><span class="nd">@Nullable</span><span class="w"> </span><span class="n">ICarPowerPolicySystemNotification</span><span class="w"> </span><span class="n">powerPolicyDaemon</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-16"><a id="__codelineno-25-16" name="__codelineno-25-16" href="#__codelineno-25-16"></a>
</span><span id="__span-25-17"><a id="__codelineno-25-17" name="__codelineno-25-17" href="#__codelineno-25-17"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-25-18"><a id="__codelineno-25-18" name="__codelineno-25-18" href="#__codelineno-25-18"></a>
</span><span id="__span-25-19"><a id="__codelineno-25-19" name="__codelineno-25-19" href="#__codelineno-25-19"></a><span class="w">    </span><span class="n">mHal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">constructWithTrace</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">VehicleHal</span><span class="p">.</span><span class="na">class</span><span class="p">,</span>
</span><span id="__span-25-20"><a id="__codelineno-25-20" name="__codelineno-25-20" href="#__codelineno-25-20"></a><span class="w">            </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">VehicleHal</span><span class="p">(</span><span class="n">serviceContext</span><span class="p">,</span><span class="w"> </span><span class="n">vehicle</span><span class="p">));</span>
</span><span id="__span-25-21"><a id="__codelineno-25-21" name="__codelineno-25-21" href="#__codelineno-25-21"></a>
</span><span id="__span-25-22"><a id="__codelineno-25-22" name="__codelineno-25-22" href="#__codelineno-25-22"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-25-23"><a id="__codelineno-25-23" name="__codelineno-25-23" href="#__codelineno-25-23"></a><span class="p">}</span>
</span><span id="__span-25-24"><a id="__codelineno-25-24" name="__codelineno-25-24" href="#__codelineno-25-24"></a>
</span><span id="__span-25-25"><a id="__codelineno-25-25" name="__codelineno-25-25" href="#__codelineno-25-25"></a><span class="nd">@MainThread</span>
</span><span id="__span-25-26"><a id="__codelineno-25-26" name="__codelineno-25-26" href="#__codelineno-25-26"></a><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-27"><a id="__codelineno-25-27" name="__codelineno-25-27" href="#__codelineno-25-27"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-25-28"><a id="__codelineno-25-28" name="__codelineno-25-28" href="#__codelineno-25-28"></a><span class="w">    </span><span class="n">mHal</span><span class="p">.</span><span class="na">init</span><span class="p">();</span>
</span><span id="__span-25-29"><a id="__codelineno-25-29" name="__codelineno-25-29" href="#__codelineno-25-29"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-25-30"><a id="__codelineno-25-30" name="__codelineno-25-30" href="#__codelineno-25-30"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="vehiclehal_3">VehicleHal<a class="headerlink" href="#vehiclehal_3" title="Permanent link">&para;</a></h4>
<p>构造函数new各个HalService（继承于 HalServiceBase ），并且 new HalClient 客户端对象。</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="n">packages</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">Car</span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">car</span><span class="o">/</span><span class="n">hal</span><span class="o">/</span><span class="n">VehicleHal</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="kd">public</span><span class="w"> </span><span class="nf">VehicleHal</span><span class="p">(</span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">IVehicle</span><span class="w"> </span><span class="n">vehicle</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="w">    </span><span class="n">mHandlerThread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CarServiceUtils</span><span class="p">.</span><span class="na">getHandlerThread</span><span class="p">(</span>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="w">            </span><span class="n">VehicleHal</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getSimpleName</span><span class="p">());</span>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="w">    </span><span class="n">mHandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Handler</span><span class="p">(</span><span class="n">mHandlerThread</span><span class="p">.</span><span class="na">getLooper</span><span class="p">());</span>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="w">    </span><span class="n">mPowerHal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PowerHalService</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a><span class="w">    </span><span class="n">mPropertyHal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PropertyHalService</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="w">    </span><span class="n">mInputHal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InputHalService</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="w">    </span><span class="n">mVmsHal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">VmsHalService</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">);</span>
</span><span id="__span-26-11"><a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="w">    </span><span class="n">mUserHal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UserHalService</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span id="__span-26-12"><a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a><span class="w">    </span><span class="n">mDiagnosticHal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DiagnosticHalService</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span id="__span-26-13"><a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a><span class="w">    </span><span class="n">mClusterHalService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ClusterHalService</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span id="__span-26-14"><a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a><span class="w">    </span><span class="n">mEvsHal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">EvsHalService</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span id="__span-26-15"><a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a><span class="w">    </span><span class="n">mTimeHalService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TimeHalService</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">);</span>
</span><span id="__span-26-16"><a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a><span class="w">    </span><span class="c1">//TODO(b/202396546): Dedupe this assignment with the other one in constructor below</span>
</span><span id="__span-26-17"><a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a><span class="w">    </span><span class="n">mAllServices</span><span class="p">.</span><span class="na">addAll</span><span class="p">(</span><span class="n">Arrays</span><span class="p">.</span><span class="na">asList</span><span class="p">(</span><span class="n">mPowerHal</span><span class="p">,</span>
</span><span id="__span-26-18"><a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a><span class="w">            </span><span class="n">mInputHal</span><span class="p">,</span>
</span><span id="__span-26-19"><a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a><span class="w">            </span><span class="n">mDiagnosticHal</span><span class="p">,</span>
</span><span id="__span-26-20"><a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a><span class="w">            </span><span class="n">mVmsHal</span><span class="p">,</span>
</span><span id="__span-26-21"><a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a><span class="w">            </span><span class="n">mUserHal</span><span class="p">,</span>
</span><span id="__span-26-22"><a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a><span class="w">            </span><span class="n">mClusterHalService</span><span class="p">,</span>
</span><span id="__span-26-23"><a id="__codelineno-26-23" name="__codelineno-26-23" href="#__codelineno-26-23"></a><span class="w">            </span><span class="n">mEvsHal</span><span class="p">,</span>
</span><span id="__span-26-24"><a id="__codelineno-26-24" name="__codelineno-26-24" href="#__codelineno-26-24"></a><span class="w">            </span><span class="n">mTimeHalService</span><span class="p">,</span>
</span><span id="__span-26-25"><a id="__codelineno-26-25" name="__codelineno-26-25" href="#__codelineno-26-25"></a><span class="w">            </span><span class="n">mPropertyHal</span><span class="p">));</span><span class="w"> </span><span class="c1">// mPropertyHal should be the last.</span>
</span><span id="__span-26-26"><a id="__codelineno-26-26" name="__codelineno-26-26" href="#__codelineno-26-26"></a><span class="w">    </span><span class="n">mHalClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HalClient</span><span class="p">(</span><span class="n">vehicle</span><span class="p">,</span><span class="w"> </span><span class="n">mHandlerThread</span><span class="p">.</span><span class="na">getLooper</span><span class="p">(),</span>
</span><span id="__span-26-27"><a id="__codelineno-26-27" name="__codelineno-26-27" href="#__codelineno-26-27"></a><span class="w">            </span><span class="cm">/* callback= */</span><span class="w"> </span><span class="k">this</span><span class="p">);</span>
</span><span id="__span-26-28"><a id="__codelineno-26-28" name="__codelineno-26-28" href="#__codelineno-26-28"></a><span class="p">}</span>
</span></code></pre></div>
<h5 id="getallpropconfigs">getAllPropConfigs()<a class="headerlink" href="#getallpropconfigs" title="Permanent link">&para;</a></h5>
<p>mHalClient.getAllPropConfigs() 从 Vehicle HAL(IVehicle.hal) 获取所有的属性。
调用到VehicleHalManager.cpp 的 getAllPropConfigs() 函数。</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="n">packages</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">Car</span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">car</span><span class="o">/</span><span class="n">hal</span><span class="o">/</span><span class="n">VehicleHal</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="w">    </span><span class="n">fetchAllPropConfigs</span><span class="p">();</span>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a>
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="p">}</span>
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a>
</span><span id="__span-27-9"><a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">fetchAllPropConfigs</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-10"><a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a><span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-11"><a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mAllProperties</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// already set</span>
</span><span id="__span-27-12"><a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">CarLog</span><span class="p">.</span><span class="na">TAG_HAL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;fetchAllPropConfigs already fetched&quot;</span><span class="p">);</span>
</span><span id="__span-27-13"><a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a><span class="w">            </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-27-14"><a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-27-15"><a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-27-16"><a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a><span class="w">    </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">VehiclePropConfig</span><span class="o">&gt;</span><span class="w"> </span><span class="n">configs</span><span class="p">;</span>
</span><span id="__span-27-17"><a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-18"><a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a><span class="w">        </span><span class="n">configs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mHalClient</span><span class="p">.</span><span class="na">getAllPropConfigs</span><span class="p">();</span>
</span><span id="__span-27-19"><a id="__codelineno-27-19" name="__codelineno-27-19" href="#__codelineno-27-19"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">configs</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">configs</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-20"><a id="__codelineno-27-20" name="__codelineno-27-20" href="#__codelineno-27-20"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="n">CarLog</span><span class="p">.</span><span class="na">TAG_HAL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;getAllPropConfigs returned empty configs&quot;</span><span class="p">);</span>
</span><span id="__span-27-21"><a id="__codelineno-27-21" name="__codelineno-27-21" href="#__codelineno-27-21"></a><span class="w">            </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-27-22"><a id="__codelineno-27-22" name="__codelineno-27-22" href="#__codelineno-27-22"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-27-23"><a id="__codelineno-27-23" name="__codelineno-27-23" href="#__codelineno-27-23"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-24"><a id="__codelineno-27-24" name="__codelineno-27-24" href="#__codelineno-27-24"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;Unable to retrieve vehicle property configuration&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
</span><span id="__span-27-25"><a id="__codelineno-27-25" name="__codelineno-27-25" href="#__codelineno-27-25"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-27-26"><a id="__codelineno-27-26" name="__codelineno-27-26" href="#__codelineno-27-26"></a>
</span><span id="__span-27-27"><a id="__codelineno-27-27" name="__codelineno-27-27" href="#__codelineno-27-27"></a><span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-28"><a id="__codelineno-27-28" name="__codelineno-27-28" href="#__codelineno-27-28"></a><span class="w">        </span><span class="c1">// Create map of all properties</span>
</span><span id="__span-27-29"><a id="__codelineno-27-29" name="__codelineno-27-29" href="#__codelineno-27-29"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">VehiclePropConfig</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">configs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-30"><a id="__codelineno-27-30" name="__codelineno-27-30" href="#__codelineno-27-30"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DBG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-31"><a id="__codelineno-27-31" name="__codelineno-27-31" href="#__codelineno-27-31"></a><span class="w">                </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">CarLog</span><span class="p">.</span><span class="na">TAG_HAL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Add config for prop:&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Integer</span><span class="p">.</span><span class="na">toHexString</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="na">prop</span><span class="p">)</span>
</span><span id="__span-27-32"><a id="__codelineno-27-32" name="__codelineno-27-32" href="#__codelineno-27-32"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; config:&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p</span><span class="p">);</span>
</span><span id="__span-27-33"><a id="__codelineno-27-33" name="__codelineno-27-33" href="#__codelineno-27-33"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-27-34"><a id="__codelineno-27-34" name="__codelineno-27-34" href="#__codelineno-27-34"></a><span class="w">            </span><span class="n">mAllProperties</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="na">prop</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">);</span>
</span><span id="__span-27-35"><a id="__codelineno-27-35" name="__codelineno-27-35" href="#__codelineno-27-35"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-27-36"><a id="__codelineno-27-36" name="__codelineno-27-36" href="#__codelineno-27-36"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-27-37"><a id="__codelineno-27-37" name="__codelineno-27-37" href="#__codelineno-27-37"></a><span class="p">}</span>
</span></code></pre></div>
<h5 id="vehiclehalinit_1">VehicleHal.init()<a class="headerlink" href="#vehiclehalinit_1" title="Permanent link">&para;</a></h5>
<p>在 init() 中调用 fetchAllPropConfigs() 获取到所有的属性，并保存在 mAllProperties 变量中。
接着还有一件很重要的事情是，给每个服务更新对应的属性。</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="n">packages</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">Car</span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">car</span><span class="o">/</span><span class="n">hal</span><span class="o">/</span><span class="n">VehicleHal</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="w">    </span><span class="n">fetchAllPropConfigs</span><span class="p">();</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="w">    </span><span class="c1">// PropertyHalService will take most properties, so make it big enough.</span>
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="w">    </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">VehiclePropConfig</span><span class="o">&gt;</span><span class="w"> </span><span class="n">configsForService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">mAllServices</span><span class="p">.</span><span class="na">size</span><span class="p">());</span>
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">mAllServices</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a><span class="w">        </span><span class="n">HalServiceBase</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mAllServices</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-28-10"><a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a><span class="w">        </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">supportedProps</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">service</span><span class="p">.</span><span class="na">getAllSupportedProperties</span><span class="p">();</span>
</span><span id="__span-28-11"><a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a><span class="w">        </span><span class="n">configsForService</span><span class="p">.</span><span class="na">clear</span><span class="p">();</span>
</span><span id="__span-28-12"><a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a><span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-13"><a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">supportedProps</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-14"><a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Integer</span><span class="w"> </span><span class="n">propId</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">mAllProperties</span><span class="p">.</span><span class="na">keySet</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-15"><a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">service</span><span class="p">.</span><span class="na">isSupportedProperty</span><span class="p">(</span><span class="n">propId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-16"><a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a><span class="w">                        </span><span class="n">VehiclePropConfig</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mAllProperties</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">propId</span><span class="p">);</span>
</span><span id="__span-28-17"><a id="__codelineno-28-17" name="__codelineno-28-17" href="#__codelineno-28-17"></a><span class="w">                        </span><span class="n">mPropertyHandlers</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="n">propId</span><span class="p">,</span><span class="w"> </span><span class="n">service</span><span class="p">);</span>
</span><span id="__span-28-18"><a id="__codelineno-28-18" name="__codelineno-28-18" href="#__codelineno-28-18"></a><span class="w">                        </span><span class="n">configsForService</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
</span><span id="__span-28-19"><a id="__codelineno-28-19" name="__codelineno-28-19" href="#__codelineno-28-19"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-28-20"><a id="__codelineno-28-20" name="__codelineno-28-20" href="#__codelineno-28-20"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-28-21"><a id="__codelineno-28-21" name="__codelineno-28-21" href="#__codelineno-28-21"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-22"><a id="__codelineno-28-22" name="__codelineno-28-22" href="#__codelineno-28-22"></a><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">prop</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">supportedProps</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-23"><a id="__codelineno-28-23" name="__codelineno-28-23" href="#__codelineno-28-23"></a><span class="w">                    </span><span class="n">VehiclePropConfig</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mAllProperties</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">prop</span><span class="p">);</span>
</span><span id="__span-28-24"><a id="__codelineno-28-24" name="__codelineno-28-24" href="#__codelineno-28-24"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">config</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-25"><a id="__codelineno-28-25" name="__codelineno-28-25" href="#__codelineno-28-25"></a><span class="w">                        </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-28-26"><a id="__codelineno-28-26" name="__codelineno-28-26" href="#__codelineno-28-26"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-28-27"><a id="__codelineno-28-27" name="__codelineno-28-27" href="#__codelineno-28-27"></a><span class="w">                    </span><span class="n">mPropertyHandlers</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span><span class="w"> </span><span class="n">service</span><span class="p">);</span>
</span><span id="__span-28-28"><a id="__codelineno-28-28" name="__codelineno-28-28" href="#__codelineno-28-28"></a><span class="w">                    </span><span class="n">configsForService</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
</span><span id="__span-28-29"><a id="__codelineno-28-29" name="__codelineno-28-29" href="#__codelineno-28-29"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-28-30"><a id="__codelineno-28-30" name="__codelineno-28-30" href="#__codelineno-28-30"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-28-31"><a id="__codelineno-28-31" name="__codelineno-28-31" href="#__codelineno-28-31"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-28-32"><a id="__codelineno-28-32" name="__codelineno-28-32" href="#__codelineno-28-32"></a><span class="w">        </span><span class="n">service</span><span class="p">.</span><span class="na">takeProperties</span><span class="p">(</span><span class="n">configsForService</span><span class="p">);</span>
</span><span id="__span-28-33"><a id="__codelineno-28-33" name="__codelineno-28-33" href="#__codelineno-28-33"></a><span class="w">        </span><span class="n">service</span><span class="p">.</span><span class="na">init</span><span class="p">();</span>
</span><span id="__span-28-34"><a id="__codelineno-28-34" name="__codelineno-28-34" href="#__codelineno-28-34"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-28-35"><a id="__codelineno-28-35" name="__codelineno-28-35" href="#__codelineno-28-35"></a><span class="p">}</span>
</span></code></pre></div>
<p>根据签名的构造函数，我们知道 mAllServices 就是各个 HalService，这里我们拿 PowerHalService 举例。</p>
<h4 id="powerhalservicegetallsupportedproperties">PowerHalService.getAllSupportedProperties()<a class="headerlink" href="#powerhalservicegetallsupportedproperties" title="Permanent link">&para;</a></h4>
<p>PowerHalService支持的所有属性是：
- AP_POWER_STATE_REQ
- AP_POWER_STATE_REPORT
- DISPLAY_BRIGHTNESS</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="n">packages</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">Car</span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">car</span><span class="o">/</span><span class="n">hal</span><span class="o">/</span><span class="n">PowerHalService</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PowerHalService</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">HalServiceBase</span><span class="w"> </span><span class="p">{</span><span class="w">    </span>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">SUPPORTED_PROPERTIES</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="p">{</span>
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a><span class="w">            </span><span class="n">AP_POWER_STATE_REQ</span><span class="p">,</span>
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="w">            </span><span class="n">AP_POWER_STATE_REPORT</span><span class="p">,</span>
</span><span id="__span-29-8"><a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a><span class="w">            </span><span class="n">DISPLAY_BRIGHTNESS</span>
</span><span id="__span-29-9"><a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a><span class="w">    </span><span class="p">};</span>
</span><span id="__span-29-10"><a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a>
</span><span id="__span-29-11"><a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a><span class="w">    </span><span class="nd">@Override</span>
</span><span id="__span-29-12"><a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="nf">getAllSupportedProperties</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-29-13"><a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">SUPPORTED_PROPERTIES</span><span class="p">;</span>
</span><span id="__span-29-14"><a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-29-15"><a id="__codelineno-29-15" name="__codelineno-29-15" href="#__codelineno-29-15"></a>
</span><span id="__span-29-16"><a id="__codelineno-29-16" name="__codelineno-29-16" href="#__codelineno-29-16"></a><span class="p">}</span>
</span></code></pre></div>
<p>在回到前面的 init() 函数，从 PowerHalService.getAllSupportedProperties() 是有获取到支持属性的；所以接着从 mAllProperties 去寻找是否有配置，最后调用 PowerHalService.takeProperties(configsForService) 更新</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="n">packages</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">Car</span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">car</span><span class="o">/</span><span class="n">hal</span><span class="o">/</span><span class="n">VehicleHal</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a>
</span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="w">    </span><span class="c1">// PropertyHalService will take most properties, so make it big enough.</span>
</span><span id="__span-30-7"><a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a><span class="w">    </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">VehiclePropConfig</span><span class="o">&gt;</span><span class="w"> </span><span class="n">configsForService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">mAllServices</span><span class="p">.</span><span class="na">size</span><span class="p">());</span>
</span><span id="__span-30-8"><a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">mAllServices</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-9"><a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a><span class="w">        </span><span class="n">HalServiceBase</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mAllServices</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-30-10"><a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a><span class="w">        </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">supportedProps</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">service</span><span class="p">.</span><span class="na">getAllSupportedProperties</span><span class="p">();</span><span class="c1">//有属性</span>
</span><span id="__span-30-11"><a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a><span class="w">        </span><span class="n">configsForService</span><span class="p">.</span><span class="na">clear</span><span class="p">();</span>
</span><span id="__span-30-12"><a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a><span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-13"><a id="__codelineno-30-13" name="__codelineno-30-13" href="#__codelineno-30-13"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">supportedProps</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="c1">//所以不进这里</span>
</span><span id="__span-30-14"><a id="__codelineno-30-14" name="__codelineno-30-14" href="#__codelineno-30-14"></a><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Integer</span><span class="w"> </span><span class="n">propId</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">mAllProperties</span><span class="p">.</span><span class="na">keySet</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-15"><a id="__codelineno-30-15" name="__codelineno-30-15" href="#__codelineno-30-15"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">service</span><span class="p">.</span><span class="na">isSupportedProperty</span><span class="p">(</span><span class="n">propId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-16"><a id="__codelineno-30-16" name="__codelineno-30-16" href="#__codelineno-30-16"></a><span class="w">                        </span><span class="n">VehiclePropConfig</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mAllProperties</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">propId</span><span class="p">);</span>
</span><span id="__span-30-17"><a id="__codelineno-30-17" name="__codelineno-30-17" href="#__codelineno-30-17"></a><span class="w">                        </span><span class="n">mPropertyHandlers</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="n">propId</span><span class="p">,</span><span class="w"> </span><span class="n">service</span><span class="p">);</span>
</span><span id="__span-30-18"><a id="__codelineno-30-18" name="__codelineno-30-18" href="#__codelineno-30-18"></a><span class="w">                        </span><span class="n">configsForService</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
</span><span id="__span-30-19"><a id="__codelineno-30-19" name="__codelineno-30-19" href="#__codelineno-30-19"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-30-20"><a id="__codelineno-30-20" name="__codelineno-30-20" href="#__codelineno-30-20"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-30-21"><a id="__codelineno-30-21" name="__codelineno-30-21" href="#__codelineno-30-21"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-22"><a id="__codelineno-30-22" name="__codelineno-30-22" href="#__codelineno-30-22"></a><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">prop</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">supportedProps</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-23"><a id="__codelineno-30-23" name="__codelineno-30-23" href="#__codelineno-30-23"></a><span class="w">                    </span><span class="c1">//从 hal 里查到是否有匹配的</span>
</span><span id="__span-30-24"><a id="__codelineno-30-24" name="__codelineno-30-24" href="#__codelineno-30-24"></a><span class="w">                    </span><span class="n">VehiclePropConfig</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mAllProperties</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">prop</span><span class="p">);</span>
</span><span id="__span-30-25"><a id="__codelineno-30-25" name="__codelineno-30-25" href="#__codelineno-30-25"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">config</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-26"><a id="__codelineno-30-26" name="__codelineno-30-26" href="#__codelineno-30-26"></a><span class="w">                        </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-30-27"><a id="__codelineno-30-27" name="__codelineno-30-27" href="#__codelineno-30-27"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-30-28"><a id="__codelineno-30-28" name="__codelineno-30-28" href="#__codelineno-30-28"></a><span class="w">                    </span><span class="c1">// 有则添加到 configsForService </span>
</span><span id="__span-30-29"><a id="__codelineno-30-29" name="__codelineno-30-29" href="#__codelineno-30-29"></a><span class="w">                    </span><span class="n">mPropertyHandlers</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span><span class="w"> </span><span class="n">service</span><span class="p">);</span>
</span><span id="__span-30-30"><a id="__codelineno-30-30" name="__codelineno-30-30" href="#__codelineno-30-30"></a><span class="w">                    </span><span class="n">configsForService</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
</span><span id="__span-30-31"><a id="__codelineno-30-31" name="__codelineno-30-31" href="#__codelineno-30-31"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-30-32"><a id="__codelineno-30-32" name="__codelineno-30-32" href="#__codelineno-30-32"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-30-33"><a id="__codelineno-30-33" name="__codelineno-30-33" href="#__codelineno-30-33"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-30-34"><a id="__codelineno-30-34" name="__codelineno-30-34" href="#__codelineno-30-34"></a>
</span><span id="__span-30-35"><a id="__codelineno-30-35" name="__codelineno-30-35" href="#__codelineno-30-35"></a><span class="w">        </span><span class="n">service</span><span class="p">.</span><span class="na">takeProperties</span><span class="p">(</span><span class="n">configsForService</span><span class="p">);</span>
</span><span id="__span-30-36"><a id="__codelineno-30-36" name="__codelineno-30-36" href="#__codelineno-30-36"></a><span class="w">        </span><span class="n">service</span><span class="p">.</span><span class="na">init</span><span class="p">();</span>
</span><span id="__span-30-37"><a id="__codelineno-30-37" name="__codelineno-30-37" href="#__codelineno-30-37"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-30-38"><a id="__codelineno-30-38" name="__codelineno-30-38" href="#__codelineno-30-38"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="powerhalservicetakeproperties">PowerHalService.takeProperties()<a class="headerlink" href="#powerhalservicetakeproperties" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="n">packages</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">Car</span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">car</span><span class="o">/</span><span class="n">hal</span><span class="o">/</span><span class="n">PowerHalService</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PowerHalService</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">HalServiceBase</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="w">    </span><span class="nd">@GuardedBy</span><span class="p">(</span><span class="s">&quot;mLock&quot;</span><span class="p">)</span>
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span><span class="w"> </span><span class="n">VehiclePropConfig</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mProperties</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a>
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="w">    </span><span class="nd">@Override</span>
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">takeProperties</span><span class="p">(</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">VehiclePropConfig</span><span class="o">&gt;</span><span class="w"> </span><span class="n">properties</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-10"><a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">properties</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-11"><a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a><span class="w">            </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-31-12"><a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-31-13"><a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a><span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-14"><a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">VehiclePropConfig</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">properties</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-15"><a id="__codelineno-31-15" name="__codelineno-31-15" href="#__codelineno-31-15"></a><span class="w">                </span><span class="n">mProperties</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="na">prop</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">);</span>
</span><span id="__span-31-16"><a id="__codelineno-31-16" name="__codelineno-31-16" href="#__codelineno-31-16"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-31-17"><a id="__codelineno-31-17" name="__codelineno-31-17" href="#__codelineno-31-17"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-31-18"><a id="__codelineno-31-18" name="__codelineno-31-18" href="#__codelineno-31-18"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-31-19"><a id="__codelineno-31-19" name="__codelineno-31-19" href="#__codelineno-31-19"></a>
</span><span id="__span-31-20"><a id="__codelineno-31-20" name="__codelineno-31-20" href="#__codelineno-31-20"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="powerhalserviceinit">PowerHalService.init()<a class="headerlink" href="#powerhalserviceinit" title="Permanent link">&para;</a></h4>
<p>调用 mHal.subscribeProperty(this, config.prop); 订阅属性。</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="n">packages</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">Car</span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">car</span><span class="o">/</span><span class="n">hal</span><span class="o">/</span><span class="n">PowerHalService</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PowerHalService</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">HalServiceBase</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a>
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="w">    </span><span class="nd">@Override</span>
</span><span id="__span-32-6"><a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-32-7"><a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a><span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-32-8"><a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">VehiclePropConfig</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">mProperties</span><span class="p">.</span><span class="na">values</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-32-9"><a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">VehicleHal</span><span class="p">.</span><span class="na">isPropertySubscribable</span><span class="p">(</span><span class="n">config</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-32-10"><a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a><span class="w">                    </span><span class="n">mHal</span><span class="p">.</span><span class="na">subscribeProperty</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">prop</span><span class="p">);</span>
</span><span id="__span-32-11"><a id="__codelineno-32-11" name="__codelineno-32-11" href="#__codelineno-32-11"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-32-12"><a id="__codelineno-32-12" name="__codelineno-32-12" href="#__codelineno-32-12"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-32-13"><a id="__codelineno-32-13" name="__codelineno-32-13" href="#__codelineno-32-13"></a><span class="w">            </span><span class="n">VehiclePropConfig</span><span class="w"> </span><span class="n">brightnessProperty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mProperties</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">DISPLAY_BRIGHTNESS</span><span class="p">);</span>
</span><span id="__span-32-14"><a id="__codelineno-32-14" name="__codelineno-32-14" href="#__codelineno-32-14"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">brightnessProperty</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-32-15"><a id="__codelineno-32-15" name="__codelineno-32-15" href="#__codelineno-32-15"></a><span class="w">                </span><span class="n">mMaxDisplayBrightness</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">brightnessProperty</span><span class="p">.</span><span class="na">areaConfigs</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-32-16"><a id="__codelineno-32-16" name="__codelineno-32-16" href="#__codelineno-32-16"></a><span class="w">                        </span><span class="o">?</span><span class="w"> </span><span class="n">brightnessProperty</span><span class="p">.</span><span class="na">areaConfigs</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="na">maxInt32Value</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-32-17"><a id="__codelineno-32-17" name="__codelineno-32-17" href="#__codelineno-32-17"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mMaxDisplayBrightness</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-32-18"><a id="__codelineno-32-18" name="__codelineno-32-18" href="#__codelineno-32-18"></a><span class="w">                    </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">CarLog</span><span class="p">.</span><span class="na">TAG_POWER</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Max display brightness from vehicle HAL is invalid:&quot;</span>
</span><span id="__span-32-19"><a id="__codelineno-32-19" name="__codelineno-32-19" href="#__codelineno-32-19"></a><span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">mMaxDisplayBrightness</span><span class="p">);</span>
</span><span id="__span-32-20"><a id="__codelineno-32-20" name="__codelineno-32-20" href="#__codelineno-32-20"></a><span class="w">                    </span><span class="n">mMaxDisplayBrightness</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-32-21"><a id="__codelineno-32-21" name="__codelineno-32-21" href="#__codelineno-32-21"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-32-22"><a id="__codelineno-32-22" name="__codelineno-32-22" href="#__codelineno-32-22"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-32-23"><a id="__codelineno-32-23" name="__codelineno-32-23" href="#__codelineno-32-23"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-32-24"><a id="__codelineno-32-24" name="__codelineno-32-24" href="#__codelineno-32-24"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-32-25"><a id="__codelineno-32-25" name="__codelineno-32-25" href="#__codelineno-32-25"></a>
</span><span id="__span-32-26"><a id="__codelineno-32-26" name="__codelineno-32-26" href="#__codelineno-32-26"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="vehiclehalsubscribeproperty">VehicleHal.subscribeProperty()<a class="headerlink" href="#vehiclehalsubscribeproperty" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="n">packages</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">Car</span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">car</span><span class="o">/</span><span class="n">hal</span><span class="o">/</span><span class="n">VehicleHal</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="cm">/**</span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="cm"> * Subscribes given properties with sampling rate defaults to 0 and no special flags provided.</span>
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a><span class="cm"> *</span>
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a><span class="cm"> * @see #subscribeProperty(HalServiceBase, int, float, int)</span>
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a><span class="cm"> */</span>
</span><span id="__span-33-8"><a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">subscribeProperty</span><span class="p">(</span><span class="n">HalServiceBase</span><span class="w"> </span><span class="n">service</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">property</span><span class="p">)</span>
</span><span id="__span-33-9"><a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a><span class="w">        </span><span class="kd">throws</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-10"><a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a><span class="w">    </span><span class="n">subscribeProperty</span><span class="p">(</span><span class="n">service</span><span class="p">,</span><span class="w"> </span><span class="n">property</span><span class="p">,</span><span class="w"> </span><span class="cm">/* samplingRateHz= */</span><span class="w"> </span><span class="mf">0f</span><span class="p">,</span>
</span><span id="__span-33-11"><a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a><span class="w">            </span><span class="n">SubscribeFlags</span><span class="p">.</span><span class="na">EVENTS_FROM_CAR</span><span class="p">);</span>
</span><span id="__span-33-12"><a id="__codelineno-33-12" name="__codelineno-33-12" href="#__codelineno-33-12"></a><span class="p">}</span>
</span><span id="__span-33-13"><a id="__codelineno-33-13" name="__codelineno-33-13" href="#__codelineno-33-13"></a>
</span><span id="__span-33-14"><a id="__codelineno-33-14" name="__codelineno-33-14" href="#__codelineno-33-14"></a>
</span><span id="__span-33-15"><a id="__codelineno-33-15" name="__codelineno-33-15" href="#__codelineno-33-15"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">subscribeProperty</span><span class="p">(</span><span class="n">HalServiceBase</span><span class="w"> </span><span class="n">service</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">property</span><span class="p">,</span>
</span><span id="__span-33-16"><a id="__codelineno-33-16" name="__codelineno-33-16" href="#__codelineno-33-16"></a><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">samplingRateHz</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-17"><a id="__codelineno-33-17" name="__codelineno-33-17" href="#__codelineno-33-17"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DBG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-18"><a id="__codelineno-33-18" name="__codelineno-33-18" href="#__codelineno-33-18"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">CarLog</span><span class="p">.</span><span class="na">TAG_HAL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;subscribeProperty, service:&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">service</span>
</span><span id="__span-33-19"><a id="__codelineno-33-19" name="__codelineno-33-19" href="#__codelineno-33-19"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">toCarPropertyLog</span><span class="p">(</span><span class="n">property</span><span class="p">));</span>
</span><span id="__span-33-20"><a id="__codelineno-33-20" name="__codelineno-33-20" href="#__codelineno-33-20"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-33-21"><a id="__codelineno-33-21" name="__codelineno-33-21" href="#__codelineno-33-21"></a><span class="w">    </span><span class="n">VehiclePropConfig</span><span class="w"> </span><span class="n">config</span><span class="p">;</span>
</span><span id="__span-33-22"><a id="__codelineno-33-22" name="__codelineno-33-22" href="#__codelineno-33-22"></a><span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-23"><a id="__codelineno-33-23" name="__codelineno-33-23" href="#__codelineno-33-23"></a><span class="w">        </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mAllProperties</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">property</span><span class="p">);</span>
</span><span id="__span-33-24"><a id="__codelineno-33-24" name="__codelineno-33-24" href="#__codelineno-33-24"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-33-25"><a id="__codelineno-33-25" name="__codelineno-33-25" href="#__codelineno-33-25"></a>
</span><span id="__span-33-26"><a id="__codelineno-33-26" name="__codelineno-33-26" href="#__codelineno-33-26"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">config</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-27"><a id="__codelineno-33-27" name="__codelineno-33-27" href="#__codelineno-33-27"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span><span class="s">&quot;subscribe error: config is null for property 0x&quot;</span>
</span><span id="__span-33-28"><a id="__codelineno-33-28" name="__codelineno-33-28" href="#__codelineno-33-28"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">toHexString</span><span class="p">(</span><span class="n">property</span><span class="p">));</span>
</span><span id="__span-33-29"><a id="__codelineno-33-29" name="__codelineno-33-29" href="#__codelineno-33-29"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isPropertySubscribable</span><span class="p">(</span><span class="n">config</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-30"><a id="__codelineno-33-30" name="__codelineno-33-30" href="#__codelineno-33-30"></a><span class="w">        </span><span class="n">SubscribeOptions</span><span class="w"> </span><span class="n">opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SubscribeOptions</span><span class="p">();</span>
</span><span id="__span-33-31"><a id="__codelineno-33-31" name="__codelineno-33-31" href="#__codelineno-33-31"></a><span class="w">        </span><span class="n">opts</span><span class="p">.</span><span class="na">propId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">property</span><span class="p">;</span>
</span><span id="__span-33-32"><a id="__codelineno-33-32" name="__codelineno-33-32" href="#__codelineno-33-32"></a><span class="w">        </span><span class="n">opts</span><span class="p">.</span><span class="na">sampleRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">samplingRateHz</span><span class="p">;</span>
</span><span id="__span-33-33"><a id="__codelineno-33-33" name="__codelineno-33-33" href="#__codelineno-33-33"></a><span class="w">        </span><span class="n">opts</span><span class="p">.</span><span class="na">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span>
</span><span id="__span-33-34"><a id="__codelineno-33-34" name="__codelineno-33-34" href="#__codelineno-33-34"></a><span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-35"><a id="__codelineno-33-35" name="__codelineno-33-35" href="#__codelineno-33-35"></a><span class="w">            </span><span class="n">assertServiceOwnerLocked</span><span class="p">(</span><span class="n">service</span><span class="p">,</span><span class="w"> </span><span class="n">property</span><span class="p">);</span>
</span><span id="__span-33-36"><a id="__codelineno-33-36" name="__codelineno-33-36" href="#__codelineno-33-36"></a><span class="w">            </span><span class="n">mSubscribedProperties</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">property</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="p">);</span>
</span><span id="__span-33-37"><a id="__codelineno-33-37" name="__codelineno-33-37" href="#__codelineno-33-37"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-33-38"><a id="__codelineno-33-38" name="__codelineno-33-38" href="#__codelineno-33-38"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-39"><a id="__codelineno-33-39" name="__codelineno-33-39" href="#__codelineno-33-39"></a><span class="w">            </span><span class="n">mHalClient</span><span class="p">.</span><span class="na">subscribe</span><span class="p">(</span><span class="n">opts</span><span class="p">);</span>
</span><span id="__span-33-40"><a id="__codelineno-33-40" name="__codelineno-33-40" href="#__codelineno-33-40"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-41"><a id="__codelineno-33-41" name="__codelineno-33-41" href="#__codelineno-33-41"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="n">CarLog</span><span class="p">.</span><span class="na">TAG_HAL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Failed to subscribe to &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">toCarPropertyLog</span><span class="p">(</span><span class="n">property</span><span class="p">),</span>
</span><span id="__span-33-42"><a id="__codelineno-33-42" name="__codelineno-33-42" href="#__codelineno-33-42"></a><span class="w">                    </span><span class="n">e</span><span class="p">);</span>
</span><span id="__span-33-43"><a id="__codelineno-33-43" name="__codelineno-33-43" href="#__codelineno-33-43"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-33-44"><a id="__codelineno-33-44" name="__codelineno-33-44" href="#__codelineno-33-44"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-45"><a id="__codelineno-33-45" name="__codelineno-33-45" href="#__codelineno-33-45"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="n">CarLog</span><span class="p">.</span><span class="na">TAG_HAL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Cannot subscribe to &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">toCarPropertyLog</span><span class="p">(</span><span class="n">property</span><span class="p">));</span>
</span><span id="__span-33-46"><a id="__codelineno-33-46" name="__codelineno-33-46" href="#__codelineno-33-46"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-33-47"><a id="__codelineno-33-47" name="__codelineno-33-47" href="#__codelineno-33-47"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="halclientsubscribe">HalClient.subscribe()<a class="headerlink" href="#halclientsubscribe" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="n">packages</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">Car</span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">car</span><span class="o">/</span><span class="n">hal</span><span class="o">/</span><span class="n">HalClient</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">subscribe</span><span class="p">(</span><span class="n">SubscribeOptions</span><span class="p">...</span><span class="w"> </span><span class="n">options</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">RemoteException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="w">    </span><span class="n">mVehicle</span><span class="p">.</span><span class="na">subscribe</span><span class="p">(</span><span class="n">mInternalCallback</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">Arrays</span><span class="p">.</span><span class="na">asList</span><span class="p">(</span><span class="n">options</span><span class="p">)));</span>
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a><span class="p">}</span>
</span></code></pre></div>
<p>最终会调用到 IVehicle.hal 的 subscribe()，也就是 VehicleHalManager.cpp 的 subscribe()</p>
<h4 id="vehiclehalmanagersubscribe">VehicleHalManager.subscribe()<a class="headerlink" href="#vehiclehalmanagersubscribe" title="Permanent link">&para;</a></h4>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="k">default</span><span class="o">/</span><span class="n">common</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">VehicleHalManager</span><span class="p">.</span><span class="n">cpp</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="n">Return</span><span class="o">&lt;</span><span class="n">StatusCode</span><span class="o">&gt;</span><span class="w"> </span><span class="n">VehicleHalManager</span><span class="o">::</span><span class="n">subscribe</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">sp</span><span class="o">&lt;</span><span class="n">IVehicleCallback</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">callback</span><span class="p">,</span>
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="n">hidl_vec</span><span class="o">&lt;</span><span class="n">SubscribeOptions</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="w">    </span><span class="n">hidl_vec</span><span class="o">&lt;</span><span class="n">SubscribeOptions</span><span class="o">&gt;</span><span class="w"> </span><span class="n">verifiedOptions</span><span class="p">(</span><span class="n">options</span><span class="p">);</span><span class="w">  </span><span class="c1">// 创建一个与options相同的verifiedOptions向量</span>
</span><span id="__span-35-6"><a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a>
</span><span id="__span-35-7"><a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">verifiedOptions</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// 遍历verifiedOptions向量</span>
</span><span id="__span-35-8"><a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a><span class="w">        </span><span class="n">SubscribeOptions</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">verifiedOptions</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w">  </span><span class="c1">// 获取当前遍历到的元素</span>
</span><span id="__span-35-9"><a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">prop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ops</span><span class="p">.</span><span class="n">propId</span><span class="p">;</span><span class="w">  </span><span class="c1">// 获取ops的propId属性</span>
</span><span id="__span-35-10"><a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a>
</span><span id="__span-35-11"><a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">*</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getPropConfigOrNull</span><span class="p">(</span><span class="n">prop</span><span class="p">);</span><span class="w">  </span><span class="c1">// 根据propId获取属性配置信息</span>
</span><span id="__span-35-12"><a id="__codelineno-35-12" name="__codelineno-35-12" href="#__codelineno-35-12"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">config</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-13"><a id="__codelineno-35-13" name="__codelineno-35-13" href="#__codelineno-35-13"></a><span class="w">            </span><span class="n">ALOGE</span><span class="p">(</span><span class="s">&quot;Failed to subscribe: config not found, property: 0x%x&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">prop</span><span class="p">);</span>
</span><span id="__span-35-14"><a id="__codelineno-35-14" name="__codelineno-35-14" href="#__codelineno-35-14"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">StatusCode</span><span class="o">::</span><span class="n">INVALID_ARG</span><span class="p">;</span><span class="w">  </span><span class="c1">// 返回无效参数错误码</span>
</span><span id="__span-35-15"><a id="__codelineno-35-15" name="__codelineno-35-15" href="#__codelineno-35-15"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-35-16"><a id="__codelineno-35-16" name="__codelineno-35-16" href="#__codelineno-35-16"></a>
</span><span id="__span-35-17"><a id="__codelineno-35-17" name="__codelineno-35-17" href="#__codelineno-35-17"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ops</span><span class="p">.</span><span class="n">flags</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SubscribeFlags</span><span class="o">::</span><span class="n">UNDEFINED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// 如果ops的flags属性为未定义</span>
</span><span id="__span-35-18"><a id="__codelineno-35-18" name="__codelineno-35-18" href="#__codelineno-35-18"></a><span class="w">            </span><span class="n">ALOGE</span><span class="p">(</span><span class="s">&quot;Failed to subscribe: undefined flag in options provided&quot;</span><span class="p">);</span><span class="w">  </span><span class="c1">// 打印错误信息</span>
</span><span id="__span-35-19"><a id="__codelineno-35-19" name="__codelineno-35-19" href="#__codelineno-35-19"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">StatusCode</span><span class="o">::</span><span class="n">INVALID_ARG</span><span class="p">;</span><span class="w">  </span><span class="c1">// 返回无效参数错误码</span>
</span><span id="__span-35-20"><a id="__codelineno-35-20" name="__codelineno-35-20" href="#__codelineno-35-20"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-35-21"><a id="__codelineno-35-21" name="__codelineno-35-21" href="#__codelineno-35-21"></a>
</span><span id="__span-35-22"><a id="__codelineno-35-22" name="__codelineno-35-22" href="#__codelineno-35-22"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isSubscribable</span><span class="p">(</span><span class="o">*</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">ops</span><span class="p">.</span><span class="n">flags</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// 如果属性不可订阅</span>
</span><span id="__span-35-23"><a id="__codelineno-35-23" name="__codelineno-35-23" href="#__codelineno-35-23"></a><span class="w">            </span><span class="n">ALOGE</span><span class="p">(</span><span class="s">&quot;Failed to subscribe: property 0x%x is not subscribable&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">prop</span><span class="p">);</span><span class="w">  </span><span class="c1">// 打印错误信息</span>
</span><span id="__span-35-24"><a id="__codelineno-35-24" name="__codelineno-35-24" href="#__codelineno-35-24"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">StatusCode</span><span class="o">::</span><span class="n">INVALID_ARG</span><span class="p">;</span><span class="w">  </span><span class="c1">// 返回无效参数错误码</span>
</span><span id="__span-35-25"><a id="__codelineno-35-25" name="__codelineno-35-25" href="#__codelineno-35-25"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-35-26"><a id="__codelineno-35-26" name="__codelineno-35-26" href="#__codelineno-35-26"></a>
</span><span id="__span-35-27"><a id="__codelineno-35-27" name="__codelineno-35-27" href="#__codelineno-35-27"></a><span class="w">        </span><span class="n">ops</span><span class="p">.</span><span class="n">sampleRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">checkSampleRate</span><span class="p">(</span><span class="o">*</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">ops</span><span class="p">.</span><span class="n">sampleRate</span><span class="p">);</span><span class="w">  </span><span class="c1">// 检查并更新ops的sampleRate属性</span>
</span><span id="__span-35-28"><a id="__codelineno-35-28" name="__codelineno-35-28" href="#__codelineno-35-28"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-35-29"><a id="__codelineno-35-29" name="__codelineno-35-29" href="#__codelineno-35-29"></a>
</span><span id="__span-35-30"><a id="__codelineno-35-30" name="__codelineno-35-30" href="#__codelineno-35-30"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">SubscribeOptions</span><span class="o">&gt;</span><span class="w"> </span><span class="n">updatedOptions</span><span class="p">;</span><span class="w">  </span><span class="c1">// 创建一个空的updatedOptions列表</span>
</span><span id="__span-35-31"><a id="__codelineno-35-31" name="__codelineno-35-31" href="#__codelineno-35-31"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mSubscriptionManager</span><span class="p">.</span><span class="n">addOrUpdateSubscription</span><span class="p">(</span><span class="n">getClientId</span><span class="p">(</span><span class="n">callback</span><span class="p">),</span>
</span><span id="__span-35-32"><a id="__codelineno-35-32" name="__codelineno-35-32" href="#__codelineno-35-32"></a><span class="w">                                                            </span><span class="n">callback</span><span class="p">,</span><span class="w"> </span><span class="n">verifiedOptions</span><span class="p">,</span>
</span><span id="__span-35-33"><a id="__codelineno-35-33" name="__codelineno-35-33" href="#__codelineno-35-33"></a><span class="w">                                                            </span><span class="o">&amp;</span><span class="n">updatedOptions</span><span class="p">);</span><span class="w">  </span><span class="c1">// 添加或更新订阅信息，并将更新后的选项存储在updatedOptions列表中</span>
</span><span id="__span-35-34"><a id="__codelineno-35-34" name="__codelineno-35-34" href="#__codelineno-35-34"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StatusCode</span><span class="o">::</span><span class="n">OK</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-35"><a id="__codelineno-35-35" name="__codelineno-35-35" href="#__codelineno-35-35"></a><span class="w">        </span><span class="n">ALOGW</span><span class="p">(</span><span class="s">&quot;%s failed to subscribe, error code: %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">);</span>
</span><span id="__span-35-36"><a id="__codelineno-35-36" name="__codelineno-35-36" href="#__codelineno-35-36"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span><span class="w">  </span><span class="c1">// 返回错误码</span>
</span><span id="__span-35-37"><a id="__codelineno-35-37" name="__codelineno-35-37" href="#__codelineno-35-37"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-35-38"><a id="__codelineno-35-38" name="__codelineno-35-38" href="#__codelineno-35-38"></a>
</span><span id="__span-35-39"><a id="__codelineno-35-39" name="__codelineno-35-39" href="#__codelineno-35-39"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">opt</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">updatedOptions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// 遍历updatedOptions列表</span>
</span><span id="__span-35-40"><a id="__codelineno-35-40" name="__codelineno-35-40" href="#__codelineno-35-40"></a><span class="w">        </span><span class="n">mHal</span><span class="o">-&gt;</span><span class="n">subscribe</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">propId</span><span class="p">,</span><span class="w"> </span><span class="n">opt</span><span class="p">.</span><span class="n">sampleRate</span><span class="p">);</span><span class="w">  </span><span class="c1">// 调用mHal的subscribe方法订阅属性</span>
</span><span id="__span-35-41"><a id="__codelineno-35-41" name="__codelineno-35-41" href="#__codelineno-35-41"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-35-42"><a id="__codelineno-35-42" name="__codelineno-35-42" href="#__codelineno-35-42"></a>
</span><span id="__span-35-43"><a id="__codelineno-35-43" name="__codelineno-35-43" href="#__codelineno-35-43"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">StatusCode</span><span class="o">::</span><span class="n">OK</span><span class="p">;</span><span class="w">  </span><span class="c1">// 返回成功状态码</span>
</span><span id="__span-35-44"><a id="__codelineno-35-44" name="__codelineno-35-44" href="#__codelineno-35-44"></a><span class="p">}</span>
</span></code></pre></div>
<p>先检查这属性的配置是否存在，如果不存在则返回错误。接着 SubscriptionManager.addOrUpdateSubscription() 添加或更新订阅信息。</p>
<p>根据前面的分析，mHal 就是 EmulatedVehicleHal ， 所以 mHal-&gt;subscribe(opt.propId, opt.sampleRate) 就是 EmulatedVehicleHal.subscribe()</p>
<h4 id="emulatedvehiclehalsubscribe">EmulatedVehicleHal.subscribe()<a class="headerlink" href="#emulatedvehiclehalsubscribe" title="Permanent link">&para;</a></h4>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="k">default</span><span class="o">/</span><span class="n">impl</span><span class="o">/</span><span class="n">vhal_v2_0</span><span class="o">/</span><span class="n">EmulatedVehicleHal</span><span class="p">.</span><span class="n">cpp</span>
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="n">StatusCode</span><span class="w"> </span><span class="n">EmulatedVehicleHal</span><span class="o">::</span><span class="n">subscribe</span><span class="p">(</span><span class="kt">int32_t</span><span class="w"> </span><span class="n">property</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">sampleRate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="w">    </span><span class="n">ALOGI</span><span class="p">(</span><span class="s">&quot;%s propId: 0x%x, sampleRate: %f&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">,</span><span class="w"> </span><span class="n">property</span><span class="p">,</span><span class="w"> </span><span class="n">sampleRate</span><span class="p">);</span>
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a>
</span><span id="__span-36-6"><a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isContinuousProperty</span><span class="p">(</span><span class="n">property</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-36-7"><a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a><span class="w">        </span><span class="n">mRecurrentTimer</span><span class="p">.</span><span class="n">registerRecurrentEvent</span><span class="p">(</span><span class="n">hertzToNanoseconds</span><span class="p">(</span><span class="n">sampleRate</span><span class="p">),</span><span class="w"> </span><span class="n">property</span><span class="p">);</span>
</span><span id="__span-36-8"><a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-36-9"><a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">StatusCode</span><span class="o">::</span><span class="n">OK</span><span class="p">;</span>
</span><span id="__span-36-10"><a id="__codelineno-36-10" name="__codelineno-36-10" href="#__codelineno-36-10"></a><span class="p">}</span>
</span></code></pre></div>
<p>isContinuousProperty() 改变 VehiclePropConfig 的 changemode 为 CONTINUOUS（即不断的周期性的发送变化）</p>
<p>以上我们只是拿 PowerHalService ，在 VehicleHal.init() 中会遍历所以的 HalService 去做同样的事情，所以 <strong>所有属性都subscribe，CarService就可以所有接收到Vehicle HAL发上来的所有属性变化</strong></p>
<p>同理，unsubscribe注销订阅。</p>
<h3 id="set">set 设置属性<a class="headerlink" href="#set" title="Permanent link">&para;</a></h3>
<p>我们还是以 PowerHalService 为例，如下：</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="n">packages</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">Car</span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">car</span><span class="o">/</span><span class="n">hal</span><span class="o">/</span><span class="n">PowerHalService</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setPowerState</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">additionalParam</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isPowerStateSupported</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a><span class="w">        </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">additionalParam</span><span class="w"> </span><span class="p">};</span>
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a><span class="w">            </span><span class="n">mHal</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">VehicleProperty</span><span class="p">.</span><span class="na">AP_POWER_STATE_REPORT</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">).</span><span class="na">to</span><span class="p">(</span><span class="n">values</span><span class="p">);</span>
</span><span id="__span-37-8"><a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">CarLog</span><span class="p">.</span><span class="na">TAG_POWER</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;setPowerState=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">powerStateReportName</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="__span-37-9"><a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; param=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">additionalParam</span>
</span><span id="__span-37-10"><a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; VehicleProperty.AP_POWER_STATE_REPORT=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">VehicleProperty</span><span class="p">.</span><span class="na">AP_POWER_STATE_REPORT</span><span class="p">);</span>
</span><span id="__span-37-11"><a id="__codelineno-37-11" name="__codelineno-37-11" href="#__codelineno-37-11"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ServiceSpecificException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-37-12"><a id="__codelineno-37-12" name="__codelineno-37-12" href="#__codelineno-37-12"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="n">CarLog</span><span class="p">.</span><span class="na">TAG_POWER</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cannot set to AP_POWER_STATE_REPORT&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
</span><span id="__span-37-13"><a id="__codelineno-37-13" name="__codelineno-37-13" href="#__codelineno-37-13"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-37-14"><a id="__codelineno-37-14" name="__codelineno-37-14" href="#__codelineno-37-14"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-37-15"><a id="__codelineno-37-15" name="__codelineno-37-15" href="#__codelineno-37-15"></a><span class="p">}</span>
</span></code></pre></div>
<p>mHal 是 VehicleHal，所以会调到 VehicleHal.set() 。看到调到的 VehicleHal.set() 之后，我突然觉得用这个例子来举例不太好。
这里我就用一个简单的代码流程来举例非 car-service 进程怎么设置属性的。</p>
<ul>
<li>CarHvacManager.setBooleanProperty()</li>
</ul>
<div class="language-java highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="n">packages</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">Car</span><span class="o">/</span><span class="n">car</span><span class="o">-</span><span class="n">lib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">car</span><span class="o">/</span><span class="n">hardware</span><span class="o">/</span><span class="n">hvac</span><span class="o">/</span><span class="n">CarHvacManager</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setBooleanProperty</span><span class="p">(</span><span class="nd">@PropertyId</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">propertyId</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">area</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mHvacPropertyIds</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">propertyId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a><span class="w">        </span><span class="n">mCarPropertyMgr</span><span class="p">.</span><span class="na">setBooleanProperty</span><span class="p">(</span><span class="n">propertyId</span><span class="p">,</span><span class="w"> </span><span class="n">area</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
</span><span id="__span-38-6"><a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-38-7"><a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>CarPropertyManager.setProperty()</li>
</ul>
<div class="language-java highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="n">packages</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">Car</span><span class="o">/</span><span class="n">car</span><span class="o">-</span><span class="n">lib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">car</span><span class="o">/</span><span class="n">hardware</span><span class="o">/</span><span class="n">property</span><span class="o">/</span><span class="n">CarPropertyManager</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a>
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setBooleanProperty</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">prop</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">areaId</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="w">    </span><span class="n">setProperty</span><span class="p">(</span><span class="n">Boolean</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">prop</span><span class="p">,</span><span class="w"> </span><span class="n">areaId</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="p">}</span>
</span><span id="__span-39-6"><a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a>
</span><span id="__span-39-7"><a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a><span class="kd">public</span><span class="w"> </span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setProperty</span><span class="p">(</span><span class="nd">@NonNull</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">propId</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">areaId</span><span class="p">,</span><span class="w"> </span><span class="nd">@NonNull</span><span class="w"> </span><span class="n">E</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-8"><a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-39-9"><a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a>
</span><span id="__span-39-10"><a id="__codelineno-39-10" name="__codelineno-39-10" href="#__codelineno-39-10"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-11"><a id="__codelineno-39-11" name="__codelineno-39-11" href="#__codelineno-39-11"></a><span class="w">        </span><span class="n">mService</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">CarPropertyValue</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">propId</span><span class="p">,</span><span class="w"> </span><span class="n">areaId</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">),</span>
</span><span id="__span-39-12"><a id="__codelineno-39-12" name="__codelineno-39-12" href="#__codelineno-39-12"></a><span class="w">                </span><span class="n">mCarPropertyEventToService</span><span class="p">);</span>
</span><span id="__span-39-13"><a id="__codelineno-39-13" name="__codelineno-39-13" href="#__codelineno-39-13"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-39-14"><a id="__codelineno-39-14" name="__codelineno-39-14" href="#__codelineno-39-14"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>CarPropertyService.setProperty()</li>
</ul>
<div class="language-java highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="n">packages</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">Car</span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">car</span><span class="o">/</span><span class="n">CarPropertyService</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a>
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="nd">@Override</span>
</span><span id="__span-40-4"><a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setProperty</span><span class="p">(</span><span class="n">CarPropertyValue</span><span class="w"> </span><span class="n">prop</span><span class="p">,</span><span class="w"> </span><span class="n">ICarPropertyEventListener</span><span class="w"> </span><span class="n">listener</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-5"><a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-40-6"><a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a><span class="w">    </span><span class="n">mHal</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="n">prop</span><span class="p">);</span>
</span><span id="__span-40-7"><a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-40-8"><a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a><span class="p">}</span>
</span></code></pre></div>
<p>这里的 mHal 是 PropertyHalService </p>
<ul>
<li>PropertyHalService.set()</li>
</ul>
<div class="language-java highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="n">packages</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">Car</span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">car</span><span class="o">/</span><span class="n">hal</span><span class="o">/</span><span class="n">PropertyHalService</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setProperty</span><span class="p">(</span><span class="n">CarPropertyValue</span><span class="w"> </span><span class="n">prop</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-41-5"><a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="w">    </span><span class="n">mVehicleHal</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">halProp</span><span class="p">);</span>
</span><span id="__span-41-6"><a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>VehicleHal.setValue()</li>
</ul>
<div class="language-java highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="n">packages</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">Car</span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">car</span><span class="o">/</span><span class="n">hal</span><span class="o">/</span><span class="n">VehicleHal</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a>
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span><span class="n">VehiclePropValue</span><span class="w"> </span><span class="n">propValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a><span class="w">    </span><span class="n">mHalClient</span><span class="p">.</span><span class="na">setValue</span><span class="p">(</span><span class="n">propValue</span><span class="p">);</span>
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>HalClient.set()</li>
</ul>
<div class="language-java highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="n">packages</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">Car</span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">car</span><span class="o">/</span><span class="n">hal</span><span class="o">/</span><span class="n">HalClient</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a>
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setValue</span><span class="p">(</span><span class="n">VehiclePropValue</span><span class="w"> </span><span class="n">propValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">mVehicle</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">propValue</span><span class="p">);</span>
</span><span id="__span-43-5"><a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="p">}</span>
</span></code></pre></div>
<p>好，走到这里已经很清晰了。我们还是回到刚才的例子当中。</p>
<h4 id="vehiclehalset">VehicleHal.set()<a class="headerlink" href="#vehiclehalset" title="Permanent link">&para;</a></h4>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="n">packages</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">Car</span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">car</span><span class="o">/</span><span class="n">hal</span><span class="o">/</span><span class="n">VehicleHal</span><span class="p">.</span><span class="n">java</span>
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a>
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a><span class="err">@</span><span class="n">CheckResult</span>
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a><span class="n">VehiclePropValueSetter</span><span class="w"> </span><span class="n">set</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">propId</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">areaId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">VehiclePropValueSetter</span><span class="p">(</span><span class="n">mHalClient</span><span class="p">,</span><span class="w"> </span><span class="n">propId</span><span class="p">,</span><span class="w"> </span><span class="n">areaId</span><span class="p">);</span>
</span><span id="__span-44-6"><a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a><span class="p">}</span>
</span><span id="__span-44-7"><a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a>
</span><span id="__span-44-8"><a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a><span class="n">packages</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">Car</span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">car</span><span class="o">/</span><span class="n">hal</span><span class="o">/</span><span class="n">VehicleHal</span><span class="p">.</span><span class="n">java</span>
</span><span id="__span-44-9"><a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a>
</span><span id="__span-44-10"><a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a><span class="k">final</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">VehiclePropValueSetter</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-44-11"><a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a><span class="w">    </span><span class="k">final</span><span class="w"> </span><span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">HalClient</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mClient</span><span class="p">;</span>
</span><span id="__span-44-12"><a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a><span class="w">    </span><span class="k">final</span><span class="w"> </span><span class="n">VehiclePropValue</span><span class="w"> </span><span class="n">mPropValue</span><span class="p">;</span>
</span><span id="__span-44-13"><a id="__codelineno-44-13" name="__codelineno-44-13" href="#__codelineno-44-13"></a>
</span><span id="__span-44-14"><a id="__codelineno-44-14" name="__codelineno-44-14" href="#__codelineno-44-14"></a><span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="n">VehiclePropValueSetter</span><span class="p">(</span><span class="n">HalClient</span><span class="w"> </span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">propId</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">areaId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-44-15"><a id="__codelineno-44-15" name="__codelineno-44-15" href="#__codelineno-44-15"></a><span class="w">        </span><span class="n">mClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">WeakReference</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
</span><span id="__span-44-16"><a id="__codelineno-44-16" name="__codelineno-44-16" href="#__codelineno-44-16"></a><span class="w">        </span><span class="n">mPropValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">VehiclePropValue</span><span class="p">();</span>
</span><span id="__span-44-17"><a id="__codelineno-44-17" name="__codelineno-44-17" href="#__codelineno-44-17"></a><span class="w">        </span><span class="n">mPropValue</span><span class="p">.</span><span class="n">prop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">propId</span><span class="p">;</span>
</span><span id="__span-44-18"><a id="__codelineno-44-18" name="__codelineno-44-18" href="#__codelineno-44-18"></a><span class="w">        </span><span class="n">mPropValue</span><span class="p">.</span><span class="n">areaId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">areaId</span><span class="p">;</span>
</span><span id="__span-44-19"><a id="__codelineno-44-19" name="__codelineno-44-19" href="#__codelineno-44-19"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-44-20"><a id="__codelineno-44-20" name="__codelineno-44-20" href="#__codelineno-44-20"></a>
</span><span id="__span-44-21"><a id="__codelineno-44-21" name="__codelineno-44-21" href="#__codelineno-44-21"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">to</span><span class="p">(</span><span class="n">boolean</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-44-22"><a id="__codelineno-44-22" name="__codelineno-44-22" href="#__codelineno-44-22"></a><span class="w">        </span><span class="n">to</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-44-23"><a id="__codelineno-44-23" name="__codelineno-44-23" href="#__codelineno-44-23"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-44-24"><a id="__codelineno-44-24" name="__codelineno-44-24" href="#__codelineno-44-24"></a>
</span><span id="__span-44-25"><a id="__codelineno-44-25" name="__codelineno-44-25" href="#__codelineno-44-25"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">to</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-44-26"><a id="__codelineno-44-26" name="__codelineno-44-26" href="#__codelineno-44-26"></a><span class="w">        </span><span class="n">mPropValue</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">int32Values</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
</span><span id="__span-44-27"><a id="__codelineno-44-27" name="__codelineno-44-27" href="#__codelineno-44-27"></a><span class="w">        </span><span class="n">submit</span><span class="p">();</span>
</span><span id="__span-44-28"><a id="__codelineno-44-28" name="__codelineno-44-28" href="#__codelineno-44-28"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-44-29"><a id="__codelineno-44-29" name="__codelineno-44-29" href="#__codelineno-44-29"></a>
</span><span id="__span-44-30"><a id="__codelineno-44-30" name="__codelineno-44-30" href="#__codelineno-44-30"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">to</span><span class="p">(</span><span class="kt">int</span><span class="p">[]</span><span class="w"> </span><span class="n">values</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-44-31"><a id="__codelineno-44-31" name="__codelineno-44-31" href="#__codelineno-44-31"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">values</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-44-32"><a id="__codelineno-44-32" name="__codelineno-44-32" href="#__codelineno-44-32"></a><span class="w">            </span><span class="n">mPropValue</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">int32Values</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
</span><span id="__span-44-33"><a id="__codelineno-44-33" name="__codelineno-44-33" href="#__codelineno-44-33"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-44-34"><a id="__codelineno-44-34" name="__codelineno-44-34" href="#__codelineno-44-34"></a><span class="w">        </span><span class="n">submit</span><span class="p">();</span>
</span><span id="__span-44-35"><a id="__codelineno-44-35" name="__codelineno-44-35" href="#__codelineno-44-35"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-44-36"><a id="__codelineno-44-36" name="__codelineno-44-36" href="#__codelineno-44-36"></a>
</span><span id="__span-44-37"><a id="__codelineno-44-37" name="__codelineno-44-37" href="#__codelineno-44-37"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">to</span><span class="p">(</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">values</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-44-38"><a id="__codelineno-44-38" name="__codelineno-44-38" href="#__codelineno-44-38"></a><span class="w">        </span><span class="n">mPropValue</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">int32Values</span><span class="p">.</span><span class="n">addAll</span><span class="p">(</span><span class="n">values</span><span class="p">);</span>
</span><span id="__span-44-39"><a id="__codelineno-44-39" name="__codelineno-44-39" href="#__codelineno-44-39"></a><span class="w">        </span><span class="n">submit</span><span class="p">();</span>
</span><span id="__span-44-40"><a id="__codelineno-44-40" name="__codelineno-44-40" href="#__codelineno-44-40"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-44-41"><a id="__codelineno-44-41" name="__codelineno-44-41" href="#__codelineno-44-41"></a>
</span><span id="__span-44-42"><a id="__codelineno-44-42" name="__codelineno-44-42" href="#__codelineno-44-42"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">submit</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-44-43"><a id="__codelineno-44-43" name="__codelineno-44-43" href="#__codelineno-44-43"></a><span class="w">        </span><span class="n">HalClient</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">mClient</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
</span><span id="__span-44-44"><a id="__codelineno-44-44" name="__codelineno-44-44" href="#__codelineno-44-44"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">client</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-44-45"><a id="__codelineno-44-45" name="__codelineno-44-45" href="#__codelineno-44-45"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DBG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-44-46"><a id="__codelineno-44-46" name="__codelineno-44-46" href="#__codelineno-44-46"></a><span class="w">                </span><span class="n">Slog</span><span class="p">.</span><span class="n">i</span><span class="p">(</span><span class="n">CarLog</span><span class="p">.</span><span class="n">TAG_HAL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;set, &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">toCarPropertyLog</span><span class="p">(</span><span class="n">mPropValue</span><span class="p">.</span><span class="n">prop</span><span class="p">)</span>
</span><span id="__span-44-47"><a id="__codelineno-44-47" name="__codelineno-44-47" href="#__codelineno-44-47"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">toCarAreaLog</span><span class="p">(</span><span class="n">mPropValue</span><span class="p">.</span><span class="n">areaId</span><span class="p">));</span>
</span><span id="__span-44-48"><a id="__codelineno-44-48" name="__codelineno-44-48" href="#__codelineno-44-48"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-44-49"><a id="__codelineno-44-49" name="__codelineno-44-49" href="#__codelineno-44-49"></a><span class="w">            </span><span class="n">client</span><span class="p">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">mPropValue</span><span class="p">);</span>
</span><span id="__span-44-50"><a id="__codelineno-44-50" name="__codelineno-44-50" href="#__codelineno-44-50"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-44-51"><a id="__codelineno-44-51" name="__codelineno-44-51" href="#__codelineno-44-51"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-44-52"><a id="__codelineno-44-52" name="__codelineno-44-52" href="#__codelineno-44-52"></a><span class="p">}</span>
</span></code></pre></div>
<p>VehicleHal 里有几个 set() 函数，不管是那个 set() 函数，最终都是调 mHalClient.setValue(propValue) 设置属性。</p>
<h4 id="halclientsetvalue">HalClient.setValue()<a class="headerlink" href="#halclientsetvalue" title="Permanent link">&para;</a></h4>
<p>还记得之前在 VehicleHal 构造函数里的 vehicle 是从哪里来的吗？
其实 CarService.getVehicle() 获取到并通过构造 ICarImpl 一步一步传进来的。</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="n">packages</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">Car</span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">car</span><span class="o">/</span><span class="n">hal</span><span class="o">/</span><span class="n">VehicleHal</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a>
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="kd">public</span><span class="w"> </span><span class="nf">VehicleHal</span><span class="p">(</span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">IVehicle</span><span class="w"> </span><span class="n">vehicle</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="w">    </span><span class="n">mHalClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HalClient</span><span class="p">(</span><span class="n">vehicle</span><span class="p">,</span><span class="w"> </span><span class="n">mHandlerThread</span><span class="p">.</span><span class="na">getLooper</span><span class="p">(),</span>
</span><span id="__span-45-6"><a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a><span class="w">            </span><span class="cm">/* callback= */</span><span class="w"> </span><span class="k">this</span><span class="p">);</span>
</span><span id="__span-45-7"><a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a><span class="p">}</span>
</span></code></pre></div>
<p>所以 mVehicle 就是 VehicleHal 。也就是 IVehicle.hal 的 set() 接口。
最终是调到 VehicleHalManager.cpp 的 set() 接口。</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="n">packages</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">Car</span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">car</span><span class="o">/</span><span class="n">hal</span><span class="o">/</span><span class="n">HalClient</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a>
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setValue</span><span class="p">(</span><span class="n">VehiclePropValue</span><span class="w"> </span><span class="n">propValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">mVehicle</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">propValue</span><span class="p">);</span>
</span><span id="__span-46-6"><a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-46-7"><a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="vehiclehalmanagerset">VehicleHalManager.set()<a class="headerlink" href="#vehiclehalmanagerset" title="Permanent link">&para;</a></h4>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="k">default</span><span class="o">/</span><span class="n">common</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">VehicleHalManager</span><span class="p">.</span><span class="n">cpp</span>
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a>
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="cm">/**</span>
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="cm"> * @brief 设置车辆属性值</span>
</span><span id="__span-47-5"><a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a><span class="cm"> * @param value 要设置的属性值</span>
</span><span id="__span-47-6"><a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a><span class="cm"> * @return 返回设置结果的状态码</span>
</span><span id="__span-47-7"><a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a><span class="cm"> */</span>
</span><span id="__span-47-8"><a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a><span class="n">Return</span><span class="o">&lt;</span><span class="n">StatusCode</span><span class="o">&gt;</span><span class="w"> </span><span class="n">VehicleHalManager</span><span class="o">::</span><span class="n">set</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">VehiclePropValue</span><span class="w"> </span><span class="o">&amp;</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-9"><a id="__codelineno-47-9" name="__codelineno-47-9" href="#__codelineno-47-9"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">prop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">.</span><span class="n">prop</span><span class="p">;</span><span class="w"> </span><span class="c1">// 获取属性</span>
</span><span id="__span-47-10"><a id="__codelineno-47-10" name="__codelineno-47-10" href="#__codelineno-47-10"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">*</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getPropConfigOrNull</span><span class="p">(</span><span class="n">prop</span><span class="p">);</span><span class="w"> </span><span class="c1">// 获取属性配置</span>
</span><span id="__span-47-11"><a id="__codelineno-47-11" name="__codelineno-47-11" href="#__codelineno-47-11"></a>
</span><span id="__span-47-12"><a id="__codelineno-47-12" name="__codelineno-47-12" href="#__codelineno-47-12"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">config</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 如果配置为空</span>
</span><span id="__span-47-13"><a id="__codelineno-47-13" name="__codelineno-47-13" href="#__codelineno-47-13"></a><span class="w">        </span><span class="n">ALOGE</span><span class="p">(</span><span class="s">&quot;Failed to set value: config not found, property: 0x%x&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">prop</span><span class="p">);</span>
</span><span id="__span-47-14"><a id="__codelineno-47-14" name="__codelineno-47-14" href="#__codelineno-47-14"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">StatusCode</span><span class="o">::</span><span class="n">INVALID_ARG</span><span class="p">;</span>
</span><span id="__span-47-15"><a id="__codelineno-47-15" name="__codelineno-47-15" href="#__codelineno-47-15"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-47-16"><a id="__codelineno-47-16" name="__codelineno-47-16" href="#__codelineno-47-16"></a>
</span><span id="__span-47-17"><a id="__codelineno-47-17" name="__codelineno-47-17" href="#__codelineno-47-17"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">checkWritePermission</span><span class="p">(</span><span class="o">*</span><span class="n">config</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 如果没有写权限</span>
</span><span id="__span-47-18"><a id="__codelineno-47-18" name="__codelineno-47-18" href="#__codelineno-47-18"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">StatusCode</span><span class="o">::</span><span class="n">ACCESS_DENIED</span><span class="p">;</span>
</span><span id="__span-47-19"><a id="__codelineno-47-19" name="__codelineno-47-19" href="#__codelineno-47-19"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-47-20"><a id="__codelineno-47-20" name="__codelineno-47-20" href="#__codelineno-47-20"></a>
</span><span id="__span-47-21"><a id="__codelineno-47-21" name="__codelineno-47-21" href="#__codelineno-47-21"></a><span class="w">    </span><span class="n">handlePropertySetEvent</span><span class="p">(</span><span class="n">value</span><span class="p">);</span><span class="w"> </span><span class="c1">// 处理属性设置事件</span>
</span><span id="__span-47-22"><a id="__codelineno-47-22" name="__codelineno-47-22" href="#__codelineno-47-22"></a>
</span><span id="__span-47-23"><a id="__codelineno-47-23" name="__codelineno-47-23" href="#__codelineno-47-23"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mHal</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="p">);</span><span class="w"> </span><span class="c1">// 调用mHal的set方法设置属性值</span>
</span><span id="__span-47-24"><a id="__codelineno-47-24" name="__codelineno-47-24" href="#__codelineno-47-24"></a>
</span><span id="__span-47-25"><a id="__codelineno-47-25" name="__codelineno-47-25" href="#__codelineno-47-25"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Return</span><span class="o">&lt;</span><span class="n">StatusCode</span><span class="o">&gt;</span><span class="p">(</span><span class="n">status</span><span class="p">);</span><span class="w"> </span><span class="c1">// 返回设置结果的状态码</span>
</span><span id="__span-47-26"><a id="__codelineno-47-26" name="__codelineno-47-26" href="#__codelineno-47-26"></a><span class="p">}</span>
</span></code></pre></div>
<p>其中这里的 handlePropertySetEvent() 函数非常重要，主要是用来调用  SubscriptionManager 把事件回调到客户端的；关于这一点，我们后面会分析。</p>
<p>现在先看 mHal-&gt;set(value) ，还是根据前面的分析，mHal 就是 EmulatedVehicleHal。</p>
<h4 id="emulatedvehiclehalset">EmulatedVehicleHal.set()<a class="headerlink" href="#emulatedvehiclehalset" title="Permanent link">&para;</a></h4>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="k">default</span><span class="o">/</span><span class="n">impl</span><span class="o">/</span><span class="n">vhal_v2_0</span><span class="o">/</span><span class="n">EmulatedVehicleHal</span><span class="p">.</span><span class="n">cpp</span>
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a>
</span><span id="__span-48-3"><a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a><span class="n">StatusCode</span><span class="w"> </span><span class="n">EmulatedVehicleHal</span><span class="o">::</span><span class="n">set</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">VehiclePropValue</span><span class="o">&amp;</span><span class="w"> </span><span class="n">propValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-48-4"><a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a><span class="w">     </span><span class="p">...</span>
</span><span id="__span-48-5"><a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a>
</span><span id="__span-48-6"><a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a><span class="w">    </span><span class="c1">// 将值发送给车辆服务器，服务器将与（真实或模拟的）汽车通信</span>
</span><span id="__span-48-7"><a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">setValueStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mVehicleClient</span><span class="o">-&gt;</span><span class="n">setProperty</span><span class="p">(</span><span class="n">propValue</span><span class="p">,</span><span class="w"> </span><span class="n">updateStatus</span><span class="p">);</span>
</span><span id="__span-48-8"><a id="__codelineno-48-8" name="__codelineno-48-8" href="#__codelineno-48-8"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">setValueStatus</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">StatusCode</span><span class="o">::</span><span class="n">OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-48-9"><a id="__codelineno-48-9" name="__codelineno-48-9" href="#__codelineno-48-9"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">setValueStatus</span><span class="p">;</span>
</span><span id="__span-48-10"><a id="__codelineno-48-10" name="__codelineno-48-10" href="#__codelineno-48-10"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-48-11"><a id="__codelineno-48-11" name="__codelineno-48-11" href="#__codelineno-48-11"></a>
</span><span id="__span-48-12"><a id="__codelineno-48-12" name="__codelineno-48-12" href="#__codelineno-48-12"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">StatusCode</span><span class="o">::</span><span class="n">OK</span><span class="p">;</span>
</span><span id="__span-48-13"><a id="__codelineno-48-13" name="__codelineno-48-13" href="#__codelineno-48-13"></a><span class="p">}</span>
</span></code></pre></div>
<p>通过 VehicleHal 初始化的流程其实可以知道，mVehicleClient 就是 VehicleHalClient 。但这里显然是预留的厂商实现的。
我们通过厂商的代码可以知道 mVehicleClient 是 VehicleClientImpl 。</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a>StatusCode VehicleClientImpl::setProperty(const VehiclePropValue&amp; value, bool updateStatus) {  
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a>    return mVehicleServer-&gt;onSetProperty(value);  
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a>}
</span></code></pre></div>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="n">StatusCode</span><span class="w"> </span><span class="nf">VehicleHalServer::onSetProperty</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">VehiclePropValue</span><span class="o">&amp;</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a><span class="p">}</span>
</span></code></pre></div>
<p>这里就涉及到厂商自己的业务逻辑了，而从这里我们也知道了，aosp 里 VehicleService 初始化时，并没有创建 VehicleHalClient、VehicleHalServer；而是需要厂商自己的创建。</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="mf">1.</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">VehicleHalServer</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">property</span><span class="o">::</span><span class="n">IPropertyTransfer</span>
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a>
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a><span class="mf">2.</span><span class="w"> </span><span class="n">在</span><span class="w"> </span><span class="n">VehicleHalServer</span><span class="o">::</span><span class="n">initAllProperties</span><span class="p">()</span><span class="w"> </span><span class="n">里</span><span class="err">，</span><span class="n">会调用</span><span class="w"> </span><span class="n">prop</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="err">，</span>
</span><span id="__span-51-4"><a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a>
</span><span id="__span-51-5"><a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a><span class="mf">3.</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">Property</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">IPropertyTransfer</span><span class="o">*</span><span class="w"> </span><span class="n">transfer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-6"><a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a><span class="w">    </span><span class="n">mProperty</span><span class="o">-&gt;</span><span class="n">registerWritePropValueListener</span><span class="p">(</span><span class="w">  </span>
</span><span id="__span-51-7"><a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a><span class="w">                </span><span class="p">[</span><span class="n">transfer</span><span class="p">](</span><span class="k">const</span><span class="w"> </span><span class="n">VehiclePropValue</span><span class="o">&amp;</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">CommitMode</span><span class="w"> </span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">updateStatus</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-51-8"><a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a><span class="w">                </span><span class="n">transfer</span><span class="o">-&gt;</span><span class="n">onPropertyValue</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="n">updateStatus</span><span class="p">);</span><span class="w">  </span>
</span><span id="__span-51-9"><a id="__codelineno-51-9" name="__codelineno-51-9" href="#__codelineno-51-9"></a><span class="w">              </span><span class="p">});</span>
</span><span id="__span-51-10"><a id="__codelineno-51-10" name="__codelineno-51-10" href="#__codelineno-51-10"></a><span class="p">}</span>
</span><span id="__span-51-11"><a id="__codelineno-51-11" name="__codelineno-51-11" href="#__codelineno-51-11"></a>
</span><span id="__span-51-12"><a id="__codelineno-51-12" name="__codelineno-51-12" href="#__codelineno-51-12"></a><span class="mf">4.</span><span class="w"> </span><span class="n">mReportQueue</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">propValue</span><span class="p">);</span>
</span><span id="__span-51-13"><a id="__codelineno-51-13" name="__codelineno-51-13" href="#__codelineno-51-13"></a>
</span><span id="__span-51-14"><a id="__codelineno-51-14" name="__codelineno-51-14" href="#__codelineno-51-14"></a><span class="mf">5.</span><span class="w">  </span><span class="n">PropValueStore</span><span class="o">::</span><span class="n">PropValueStore</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">mReportQueue</span><span class="p">(</span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-15"><a id="__codelineno-51-15" name="__codelineno-51-15" href="#__codelineno-51-15"></a><span class="w">        </span><span class="n">mBatchTaskConsumer</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mReportQueue</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">PropValueStore</span><span class="o">::</span><span class="n">onVehiclePropertyValueFromStore</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;ReportConsumer&quot;</span><span class="p">);</span>
</span><span id="__span-51-16"><a id="__codelineno-51-16" name="__codelineno-51-16" href="#__codelineno-51-16"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-51-17"><a id="__codelineno-51-17" name="__codelineno-51-17" href="#__codelineno-51-17"></a>
</span><span id="__span-51-18"><a id="__codelineno-51-18" name="__codelineno-51-18" href="#__codelineno-51-18"></a><span class="n">VehicleHalServer</span><span class="o">::</span><span class="n">onSetProperty</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span>
</span><span id="__span-51-19"><a id="__codelineno-51-19" name="__codelineno-51-19" href="#__codelineno-51-19"></a><span class="w">    </span><span class="n">IProperty</span><span class="o">::</span><span class="n">onSetPropertyValue</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span>
</span><span id="__span-51-20"><a id="__codelineno-51-20" name="__codelineno-51-20" href="#__codelineno-51-20"></a><span class="w">        </span><span class="n">Area</span><span class="o">::</span><span class="n">onSetPropertyAreaValue</span><span class="w"> </span><span class="o">-&gt;</span>
</span><span id="__span-51-21"><a id="__codelineno-51-21" name="__codelineno-51-21" href="#__codelineno-51-21"></a><span class="w">            </span><span class="n">IProperty</span><span class="o">::</span><span class="n">writeToStore</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span>
</span><span id="__span-51-22"><a id="__codelineno-51-22" name="__codelineno-51-22" href="#__codelineno-51-22"></a><span class="w">                </span><span class="p">(</span><span class="n">由1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="n">可知</span><span class="p">)</span>
</span><span id="__span-51-23"><a id="__codelineno-51-23" name="__codelineno-51-23" href="#__codelineno-51-23"></a><span class="w">                </span><span class="n">VehicleHalServer</span><span class="o">::</span><span class="n">onPropertyValue</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span>
</span><span id="__span-51-24"><a id="__codelineno-51-24" name="__codelineno-51-24" href="#__codelineno-51-24"></a><span class="w">                    </span><span class="n">PropValueStore</span><span class="o">::</span><span class="n">writeValue</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span>
</span><span id="__span-51-25"><a id="__codelineno-51-25" name="__codelineno-51-25" href="#__codelineno-51-25"></a><span class="w">                        </span><span class="p">(</span><span class="n">由4</span><span class="p">,</span><span class="mi">5</span><span class="n">可知</span><span class="p">)</span>
</span><span id="__span-51-26"><a id="__codelineno-51-26" name="__codelineno-51-26" href="#__codelineno-51-26"></a><span class="w">                        </span><span class="n">PropValueStore</span><span class="o">::</span><span class="n">onVehiclePropertyValueFromStore</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span>
</span><span id="__span-51-27"><a id="__codelineno-51-27" name="__codelineno-51-27" href="#__codelineno-51-27"></a><span class="w">                            </span><span class="n">VehicleHalClient</span><span class="o">::</span><span class="n">onPropertyValue</span><span class="p">()</span>
</span><span id="__span-51-28"><a id="__codelineno-51-28" name="__codelineno-51-28" href="#__codelineno-51-28"></a><span class="w">                            </span><span class="n">DHUVehicleHal</span><span class="o">::</span><span class="n">onPropertyValue</span><span class="p">()</span>
</span><span id="__span-51-29"><a id="__codelineno-51-29" name="__codelineno-51-29" href="#__codelineno-51-29"></a>
</span><span id="__span-51-30"><a id="__codelineno-51-30" name="__codelineno-51-30" href="#__codelineno-51-30"></a><span class="n">最终会调到</span><span class="w"> </span><span class="n">VehiclePropertyStore</span><span class="w"> </span><span class="n">去写属性</span><span class="err">。</span>
</span></code></pre></div>
<h4 id="vehiclepropertystorewritevalue">VehiclePropertyStore.writeValue()<a class="headerlink" href="#vehiclepropertystorewritevalue" title="Permanent link">&para;</a></h4>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="k">default</span><span class="o">/</span><span class="n">common</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">VehiclePropertyStore</span><span class="p">.</span><span class="n">cpp</span>
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a>
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a><span class="kt">bool</span><span class="w"> </span><span class="n">VehiclePropertyStore</span><span class="o">::</span><span class="n">writeValue</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">VehiclePropValue</span><span class="o">&amp;</span><span class="w"> </span><span class="n">propValue</span><span class="p">,</span>
</span><span id="__span-52-4"><a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a><span class="w">                                        </span><span class="kt">bool</span><span class="w"> </span><span class="n">updateStatus</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-52-5"><a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a><span class="w">    </span><span class="n">MuxGuard</span><span class="w"> </span><span class="nf">g</span><span class="p">(</span><span class="n">mLock</span><span class="p">);</span>
</span><span id="__span-52-6"><a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a>
</span><span id="__span-52-7"><a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a><span class="w">    </span><span class="c1">// 属性id是否已经注册，如果当前属性id没有注册，则返回false，写入失败。</span>
</span><span id="__span-52-8"><a id="__codelineno-52-8" name="__codelineno-52-8" href="#__codelineno-52-8"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mConfigs</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">propValue</span><span class="p">.</span><span class="n">prop</span><span class="p">))</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
</span><span id="__span-52-9"><a id="__codelineno-52-9" name="__codelineno-52-9" href="#__codelineno-52-9"></a>
</span><span id="__span-52-10"><a id="__codelineno-52-10" name="__codelineno-52-10" href="#__codelineno-52-10"></a>
</span><span id="__span-52-11"><a id="__codelineno-52-11" name="__codelineno-52-11" href="#__codelineno-52-11"></a><span class="w">    </span><span class="n">RecordId</span><span class="w"> </span><span class="n">recId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getRecordIdLocked</span><span class="p">(</span><span class="n">propValue</span><span class="p">);</span><span class="w"> </span><span class="c1">// 获取记录ID</span>
</span><span id="__span-52-12"><a id="__codelineno-52-12" name="__codelineno-52-12" href="#__codelineno-52-12"></a><span class="w">    </span><span class="n">VehiclePropValue</span><span class="o">*</span><span class="w"> </span><span class="n">valueToUpdate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">const_cast</span><span class="o">&lt;</span><span class="n">VehiclePropValue</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">getValueOrNullLocked</span><span class="p">(</span><span class="n">recId</span><span class="p">));</span><span class="w"> </span><span class="c1">// 获取要更新的值</span>
</span><span id="__span-52-13"><a id="__codelineno-52-13" name="__codelineno-52-13" href="#__codelineno-52-13"></a>
</span><span id="__span-52-14"><a id="__codelineno-52-14" name="__codelineno-52-14" href="#__codelineno-52-14"></a><span class="w">    </span><span class="c1">// 如果当前没有保存该属性，则加入一条新的记录</span>
</span><span id="__span-52-15"><a id="__codelineno-52-15" name="__codelineno-52-15" href="#__codelineno-52-15"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">valueToUpdate</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-52-16"><a id="__codelineno-52-16" name="__codelineno-52-16" href="#__codelineno-52-16"></a><span class="w">        </span><span class="n">mPropertyValues</span><span class="p">.</span><span class="n">insert</span><span class="p">({</span><span class="w"> </span><span class="n">recId</span><span class="p">,</span><span class="w"> </span><span class="n">propValue</span><span class="w"> </span><span class="p">});</span>
</span><span id="__span-52-17"><a id="__codelineno-52-17" name="__codelineno-52-17" href="#__codelineno-52-17"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
</span><span id="__span-52-18"><a id="__codelineno-52-18" name="__codelineno-52-18" href="#__codelineno-52-18"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-52-19"><a id="__codelineno-52-19" name="__codelineno-52-19" href="#__codelineno-52-19"></a>
</span><span id="__span-52-20"><a id="__codelineno-52-20" name="__codelineno-52-20" href="#__codelineno-52-20"></a><span class="w">    </span><span class="c1">// 如果要更新的值的时间戳大于propValue的时间戳，则返回false</span>
</span><span id="__span-52-21"><a id="__codelineno-52-21" name="__codelineno-52-21" href="#__codelineno-52-21"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">valueToUpdate</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">propValue</span><span class="p">.</span><span class="n">timestamp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-52-22"><a id="__codelineno-52-22" name="__codelineno-52-22" href="#__codelineno-52-22"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
</span><span id="__span-52-23"><a id="__codelineno-52-23" name="__codelineno-52-23" href="#__codelineno-52-23"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-52-24"><a id="__codelineno-52-24" name="__codelineno-52-24" href="#__codelineno-52-24"></a>
</span><span id="__span-52-25"><a id="__codelineno-52-25" name="__codelineno-52-25" href="#__codelineno-52-25"></a><span class="w">    </span><span class="c1">// 更新valueToUpdate的时间戳和值</span>
</span><span id="__span-52-26"><a id="__codelineno-52-26" name="__codelineno-52-26" href="#__codelineno-52-26"></a><span class="w">    </span><span class="c1">// propertyStore中的时间戳应该只由服务器端更新，它表示服务器生成事件的时间</span>
</span><span id="__span-52-27"><a id="__codelineno-52-27" name="__codelineno-52-27" href="#__codelineno-52-27"></a><span class="w">    </span><span class="n">valueToUpdate</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">propValue</span><span class="p">.</span><span class="n">timestamp</span><span class="p">;</span>
</span><span id="__span-52-28"><a id="__codelineno-52-28" name="__codelineno-52-28" href="#__codelineno-52-28"></a><span class="w">    </span><span class="n">valueToUpdate</span><span class="o">-&gt;</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">propValue</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
</span><span id="__span-52-29"><a id="__codelineno-52-29" name="__codelineno-52-29" href="#__codelineno-52-29"></a>
</span><span id="__span-52-30"><a id="__codelineno-52-30" name="__codelineno-52-30" href="#__codelineno-52-30"></a><span class="w">    </span><span class="c1">// 如果需要更新状态，则更新valueToUpdate的状态</span>
</span><span id="__span-52-31"><a id="__codelineno-52-31" name="__codelineno-52-31" href="#__codelineno-52-31"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">updateStatus</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-52-32"><a id="__codelineno-52-32" name="__codelineno-52-32" href="#__codelineno-52-32"></a><span class="w">        </span><span class="n">valueToUpdate</span><span class="o">-&gt;</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">propValue</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
</span><span id="__span-52-33"><a id="__codelineno-52-33" name="__codelineno-52-33" href="#__codelineno-52-33"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-52-34"><a id="__codelineno-52-34" name="__codelineno-52-34" href="#__codelineno-52-34"></a>
</span><span id="__span-52-35"><a id="__codelineno-52-35" name="__codelineno-52-35" href="#__codelineno-52-35"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
</span><span id="__span-52-36"><a id="__codelineno-52-36" name="__codelineno-52-36" href="#__codelineno-52-36"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>如果要写的属性id 还没有注册，则不写入值，返回失败</li>
<li>如果要写的属性id 还没有保存过，这保存在 mPropertyValues 中</li>
<li>如果要更新的值的时间戳小于 propValue 的时间戳，则更新</li>
</ul>
<blockquote>
<p>这里有个疑问，更新的值并没有更新到 mPropertyValues，那下次通过 get() 获取不就有问题么？</p>
</blockquote>
<h4 id="vehiclehalmanagerhandlepropertysetevent">VehicleHalManager.handlePropertySetEvent()<a class="headerlink" href="#vehiclehalmanagerhandlepropertysetevent" title="Permanent link">&para;</a></h4>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="k">default</span><span class="o">/</span><span class="n">common</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">VehicleHalManager</span><span class="p">.</span><span class="n">cpp</span>
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a>
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a><span class="kt">void</span><span class="w"> </span><span class="n">VehicleHalManager</span><span class="o">::</span><span class="n">handlePropertySetEvent</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">VehiclePropValue</span><span class="o">&amp;</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-53-4"><a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">clients</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-53-5"><a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a><span class="w">        </span><span class="n">mSubscriptionManager</span><span class="p">.</span><span class="n">getSubscribedClients</span><span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="n">prop</span><span class="p">,</span><span class="w"> </span><span class="n">SubscribeFlags</span><span class="o">::</span><span class="n">EVENTS_FROM_ANDROID</span><span class="p">);</span>
</span><span id="__span-53-6"><a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">clients</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-53-7"><a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a><span class="w">        </span><span class="n">client</span><span class="o">-&gt;</span><span class="n">getCallback</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">onPropertySet</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
</span><span id="__span-53-8"><a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-53-9"><a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a><span class="p">}</span>
</span><span id="__span-53-10"><a id="__codelineno-53-10" name="__codelineno-53-10" href="#__codelineno-53-10"></a>
</span><span id="__span-53-11"><a id="__codelineno-53-11" name="__codelineno-53-11" href="#__codelineno-53-11"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="k">default</span><span class="o">/</span><span class="n">common</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">SubscriptionManager</span><span class="p">.</span><span class="n">cpp</span>
</span><span id="__span-53-12"><a id="__codelineno-53-12" name="__codelineno-53-12" href="#__codelineno-53-12"></a>
</span><span id="__span-53-13"><a id="__codelineno-53-13" name="__codelineno-53-13" href="#__codelineno-53-13"></a><span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">sp</span><span class="o">&lt;</span><span class="n">HalClient</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">SubscriptionManager</span><span class="o">::</span><span class="n">getSubscribedClients</span><span class="p">(</span><span class="kt">int32_t</span><span class="w"> </span><span class="n">propId</span><span class="p">,</span>
</span><span id="__span-53-14"><a id="__codelineno-53-14" name="__codelineno-53-14" href="#__codelineno-53-14"></a><span class="w">                                                                   </span><span class="n">SubscribeFlags</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-53-15"><a id="__codelineno-53-15" name="__codelineno-53-15" href="#__codelineno-53-15"></a><span class="w">    </span><span class="n">MuxGuard</span><span class="w"> </span><span class="nf">g</span><span class="p">(</span><span class="n">mLock</span><span class="p">);</span>
</span><span id="__span-53-16"><a id="__codelineno-53-16" name="__codelineno-53-16" href="#__codelineno-53-16"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">getSubscribedClientsLocked</span><span class="p">(</span><span class="n">propId</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
</span><span id="__span-53-17"><a id="__codelineno-53-17" name="__codelineno-53-17" href="#__codelineno-53-17"></a><span class="p">}</span>
</span><span id="__span-53-18"><a id="__codelineno-53-18" name="__codelineno-53-18" href="#__codelineno-53-18"></a>
</span><span id="__span-53-19"><a id="__codelineno-53-19" name="__codelineno-53-19" href="#__codelineno-53-19"></a><span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">sp</span><span class="o">&lt;</span><span class="n">HalClient</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">SubscriptionManager</span><span class="o">::</span><span class="n">getSubscribedClientsLocked</span><span class="p">(</span>
</span><span id="__span-53-20"><a id="__codelineno-53-20" name="__codelineno-53-20" href="#__codelineno-53-20"></a><span class="w">    </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">propId</span><span class="p">,</span><span class="w"> </span><span class="n">SubscribeFlags</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-53-21"><a id="__codelineno-53-21" name="__codelineno-53-21" href="#__codelineno-53-21"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">sp</span><span class="o">&lt;</span><span class="n">HalClient</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">subscribedClients</span><span class="p">;</span>
</span><span id="__span-53-22"><a id="__codelineno-53-22" name="__codelineno-53-22" href="#__codelineno-53-22"></a>
</span><span id="__span-53-23"><a id="__codelineno-53-23" name="__codelineno-53-23" href="#__codelineno-53-23"></a><span class="w">    </span><span class="n">sp</span><span class="o">&lt;</span><span class="n">HalClientVector</span><span class="o">&gt;</span><span class="w"> </span><span class="n">propClients</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getClientsForPropertyLocked</span><span class="p">(</span><span class="n">propId</span><span class="p">);</span>
</span><span id="__span-53-24"><a id="__codelineno-53-24" name="__codelineno-53-24" href="#__codelineno-53-24"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">propClients</span><span class="p">.</span><span class="n">get</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-53-25"><a id="__codelineno-53-25" name="__codelineno-53-25" href="#__codelineno-53-25"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">propClients</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-53-26"><a id="__codelineno-53-26" name="__codelineno-53-26" href="#__codelineno-53-26"></a><span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">propClients</span><span class="o">-&gt;</span><span class="n">itemAt</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-53-27"><a id="__codelineno-53-27" name="__codelineno-53-27" href="#__codelineno-53-27"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">isSubscribed</span><span class="p">(</span><span class="n">propId</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-53-28"><a id="__codelineno-53-28" name="__codelineno-53-28" href="#__codelineno-53-28"></a><span class="w">                </span><span class="n">subscribedClients</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
</span><span id="__span-53-29"><a id="__codelineno-53-29" name="__codelineno-53-29" href="#__codelineno-53-29"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-53-30"><a id="__codelineno-53-30" name="__codelineno-53-30" href="#__codelineno-53-30"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-53-31"><a id="__codelineno-53-31" name="__codelineno-53-31" href="#__codelineno-53-31"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-53-32"><a id="__codelineno-53-32" name="__codelineno-53-32" href="#__codelineno-53-32"></a>
</span><span id="__span-53-33"><a id="__codelineno-53-33" name="__codelineno-53-33" href="#__codelineno-53-33"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">subscribedClients</span><span class="p">;</span>
</span><span id="__span-53-34"><a id="__codelineno-53-34" name="__codelineno-53-34" href="#__codelineno-53-34"></a><span class="p">}</span>
</span></code></pre></div>
<p>handlePropertySetEvent 调用 SubscriptionManager.getSubscribedClients() 返回订阅的HalClient对象list列表；然后会遍历 HalClient 调用其 onPropertySet(value) 回调接口。</p>
<h4 id="vehiclecallback">VehicleCallback<a class="headerlink" href="#vehiclecallback" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="n">packages</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">Car</span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">car</span><span class="o">/</span><span class="n">hal</span><span class="o">/</span><span class="n">HalClient</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a>
</span><span id="__span-54-3"><a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a><span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">HalClient</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-4"><a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a>
</span><span id="__span-54-5"><a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">IVehicleCallback</span><span class="w"> </span><span class="n">mInternalCallback</span><span class="p">;</span>
</span><span id="__span-54-6"><a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a>
</span><span id="__span-54-7"><a id="__codelineno-54-7" name="__codelineno-54-7" href="#__codelineno-54-7"></a><span class="w">    </span><span class="n">HalClient</span><span class="p">(</span><span class="n">IVehicle</span><span class="w"> </span><span class="n">vehicle</span><span class="p">,</span><span class="w"> </span><span class="n">Looper</span><span class="w"> </span><span class="n">looper</span><span class="p">,</span><span class="w"> </span><span class="n">IVehicleCallback</span><span class="w"> </span><span class="n">callback</span><span class="p">,</span>
</span><span id="__span-54-8"><a id="__codelineno-54-8" name="__codelineno-54-8" href="#__codelineno-54-8"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">waitCapMs</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">sleepMs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-9"><a id="__codelineno-54-9" name="__codelineno-54-9" href="#__codelineno-54-9"></a><span class="w">        </span><span class="n">mInternalCallback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">VehicleCallback</span><span class="p">(</span><span class="n">handler</span><span class="p">);</span>
</span><span id="__span-54-10"><a id="__codelineno-54-10" name="__codelineno-54-10" href="#__codelineno-54-10"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-54-11"><a id="__codelineno-54-11" name="__codelineno-54-11" href="#__codelineno-54-11"></a>
</span><span id="__span-54-12"><a id="__codelineno-54-12" name="__codelineno-54-12" href="#__codelineno-54-12"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">VehicleCallback</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">IVehicleCallback</span><span class="p">.</span><span class="na">Stub</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-13"><a id="__codelineno-54-13" name="__codelineno-54-13" href="#__codelineno-54-13"></a><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Handler</span><span class="w"> </span><span class="n">mHandler</span><span class="p">;</span>
</span><span id="__span-54-14"><a id="__codelineno-54-14" name="__codelineno-54-14" href="#__codelineno-54-14"></a>
</span><span id="__span-54-15"><a id="__codelineno-54-15" name="__codelineno-54-15" href="#__codelineno-54-15"></a><span class="w">        </span><span class="n">VehicleCallback</span><span class="p">(</span><span class="n">Handler</span><span class="w"> </span><span class="n">handler</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-16"><a id="__codelineno-54-16" name="__codelineno-54-16" href="#__codelineno-54-16"></a><span class="w">            </span><span class="n">mHandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">handler</span><span class="p">;</span>
</span><span id="__span-54-17"><a id="__codelineno-54-17" name="__codelineno-54-17" href="#__codelineno-54-17"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-54-18"><a id="__codelineno-54-18" name="__codelineno-54-18" href="#__codelineno-54-18"></a>
</span><span id="__span-54-19"><a id="__codelineno-54-19" name="__codelineno-54-19" href="#__codelineno-54-19"></a><span class="w">        </span><span class="nd">@Override</span>
</span><span id="__span-54-20"><a id="__codelineno-54-20" name="__codelineno-54-20" href="#__codelineno-54-20"></a><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onPropertyEvent</span><span class="p">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">VehiclePropValue</span><span class="o">&gt;</span><span class="w"> </span><span class="n">propValues</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-21"><a id="__codelineno-54-21" name="__codelineno-54-21" href="#__codelineno-54-21"></a><span class="w">            </span><span class="n">mHandler</span><span class="p">.</span><span class="na">sendMessage</span><span class="p">(</span><span class="n">Message</span><span class="p">.</span><span class="na">obtain</span><span class="p">(</span>
</span><span id="__span-54-22"><a id="__codelineno-54-22" name="__codelineno-54-22" href="#__codelineno-54-22"></a><span class="w">                    </span><span class="n">mHandler</span><span class="p">,</span><span class="w"> </span><span class="n">CallbackHandler</span><span class="p">.</span><span class="na">MSG_ON_PROPERTY_EVENT</span><span class="p">,</span><span class="w"> </span><span class="n">propValues</span><span class="p">));</span>
</span><span id="__span-54-23"><a id="__codelineno-54-23" name="__codelineno-54-23" href="#__codelineno-54-23"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-54-24"><a id="__codelineno-54-24" name="__codelineno-54-24" href="#__codelineno-54-24"></a>
</span><span id="__span-54-25"><a id="__codelineno-54-25" name="__codelineno-54-25" href="#__codelineno-54-25"></a><span class="w">        </span><span class="nd">@Override</span>
</span><span id="__span-54-26"><a id="__codelineno-54-26" name="__codelineno-54-26" href="#__codelineno-54-26"></a><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onPropertySet</span><span class="p">(</span><span class="n">VehiclePropValue</span><span class="w"> </span><span class="n">propValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-27"><a id="__codelineno-54-27" name="__codelineno-54-27" href="#__codelineno-54-27"></a><span class="w">            </span><span class="n">mHandler</span><span class="p">.</span><span class="na">sendMessage</span><span class="p">(</span><span class="n">Message</span><span class="p">.</span><span class="na">obtain</span><span class="p">(</span>
</span><span id="__span-54-28"><a id="__codelineno-54-28" name="__codelineno-54-28" href="#__codelineno-54-28"></a><span class="w">                    </span><span class="n">mHandler</span><span class="p">,</span><span class="w"> </span><span class="n">CallbackHandler</span><span class="p">.</span><span class="na">MSG_ON_PROPERTY_SET</span><span class="p">,</span><span class="w"> </span><span class="n">propValue</span><span class="p">));</span>
</span><span id="__span-54-29"><a id="__codelineno-54-29" name="__codelineno-54-29" href="#__codelineno-54-29"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-54-30"><a id="__codelineno-54-30" name="__codelineno-54-30" href="#__codelineno-54-30"></a>
</span><span id="__span-54-31"><a id="__codelineno-54-31" name="__codelineno-54-31" href="#__codelineno-54-31"></a><span class="w">        </span><span class="nd">@Override</span>
</span><span id="__span-54-32"><a id="__codelineno-54-32" name="__codelineno-54-32" href="#__codelineno-54-32"></a><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onPropertySetError</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">errorCode</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">propId</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">areaId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-33"><a id="__codelineno-54-33" name="__codelineno-54-33" href="#__codelineno-54-33"></a><span class="w">            </span><span class="n">mHandler</span><span class="p">.</span><span class="na">sendMessage</span><span class="p">(</span><span class="n">Message</span><span class="p">.</span><span class="na">obtain</span><span class="p">(</span>
</span><span id="__span-54-34"><a id="__codelineno-54-34" name="__codelineno-54-34" href="#__codelineno-54-34"></a><span class="w">                    </span><span class="n">mHandler</span><span class="p">,</span><span class="w"> </span><span class="n">CallbackHandler</span><span class="p">.</span><span class="na">MSG_ON_SET_ERROR</span><span class="p">,</span>
</span><span id="__span-54-35"><a id="__codelineno-54-35" name="__codelineno-54-35" href="#__codelineno-54-35"></a><span class="w">                    </span><span class="k">new</span><span class="w"> </span><span class="n">PropertySetError</span><span class="p">(</span><span class="n">errorCode</span><span class="p">,</span><span class="w"> </span><span class="n">propId</span><span class="p">,</span><span class="w"> </span><span class="n">areaId</span><span class="p">)));</span>
</span><span id="__span-54-36"><a id="__codelineno-54-36" name="__codelineno-54-36" href="#__codelineno-54-36"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-54-37"><a id="__codelineno-54-37" name="__codelineno-54-37" href="#__codelineno-54-37"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-54-38"><a id="__codelineno-54-38" name="__codelineno-54-38" href="#__codelineno-54-38"></a><span class="p">}</span>
</span></code></pre></div>
<p>回调 onPropertySet() 被触发后，通过sendMessage()，然后 handlemessage() 处理消息。
最后调回到 VehicleHal.onPropertySet() 。</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="n">packages</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">Car</span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">car</span><span class="o">/</span><span class="n">hal</span><span class="o">/</span><span class="n">VehicleHal</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a>
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a><span class="nd">@Override</span><span class="w">  </span>
</span><span id="__span-55-4"><a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onPropertySet</span><span class="p">(</span><span class="n">VehiclePropValue</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
</span><span id="__span-55-5"><a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a><span class="w">    </span><span class="c1">// No need to handle on-property-set events in HAL service yet.  </span>
</span><span id="__span-55-6"><a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="get">get 获取属性<a class="headerlink" href="#get" title="Permanent link">&para;</a></h3>
<p>我们还是以 PowerHalService 为例，如下：</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="n">packages</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">Car</span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">car</span><span class="o">/</span><span class="n">hal</span><span class="o">/</span><span class="n">PowerHalService</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a>
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a><span class="nd">@Nullable</span>
</span><span id="__span-56-4"><a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a><span class="kd">public</span><span class="w"> </span><span class="n">PowerState</span><span class="w"> </span><span class="nf">getCurrentPowerState</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-56-5"><a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a><span class="w">    </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">state</span><span class="p">;</span>
</span><span id="__span-56-6"><a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-56-7"><a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a><span class="w">        </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mHal</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="kt">int</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">VehicleProperty</span><span class="p">.</span><span class="na">AP_POWER_STATE_REQ</span><span class="p">);</span>
</span><span id="__span-56-8"><a id="__codelineno-56-8" name="__codelineno-56-8" href="#__codelineno-56-8"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ServiceSpecificException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-56-9"><a id="__codelineno-56-9" name="__codelineno-56-9" href="#__codelineno-56-9"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="n">CarLog</span><span class="p">.</span><span class="na">TAG_POWER</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Cannot get AP_POWER_STATE_REQ&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
</span><span id="__span-56-10"><a id="__codelineno-56-10" name="__codelineno-56-10" href="#__codelineno-56-10"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-56-11"><a id="__codelineno-56-11" name="__codelineno-56-11" href="#__codelineno-56-11"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-56-12"><a id="__codelineno-56-12" name="__codelineno-56-12" href="#__codelineno-56-12"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PowerState</span><span class="p">(</span><span class="n">state</span><span class="o">[</span><span class="n">VehicleApPowerStateReqIndex</span><span class="p">.</span><span class="na">STATE</span><span class="o">]</span><span class="p">,</span>
</span><span id="__span-56-13"><a id="__codelineno-56-13" name="__codelineno-56-13" href="#__codelineno-56-13"></a><span class="w">            </span><span class="n">state</span><span class="o">[</span><span class="n">VehicleApPowerStateReqIndex</span><span class="p">.</span><span class="na">ADDITIONAL</span><span class="o">]</span><span class="p">);</span>
</span><span id="__span-56-14"><a id="__codelineno-56-14" name="__codelineno-56-14" href="#__codelineno-56-14"></a><span class="p">}</span>
</span></code></pre></div>
<p>mHal 是 VehicleHal，所以会调到 VehicleHal.get() 。</p>
<p>这里我们还是用一个简单的代码流程来举例非 car-service 进程怎么获取属性的。</p>
<ul>
<li>CarHvacManager.getIntProperty()</li>
</ul>
<div class="language-java highlight"><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="n">packages</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">Car</span><span class="o">/</span><span class="n">car</span><span class="o">-</span><span class="n">lib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">car</span><span class="o">/</span><span class="n">hardware</span><span class="o">/</span><span class="n">hvac</span><span class="o">/</span><span class="n">CarHvacManager</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-57-2"><a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a>
</span><span id="__span-57-3"><a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getIntProperty</span><span class="p">(</span><span class="nd">@PropertyId</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">propertyId</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">area</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-57-4"><a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">mCarPropertyMgr</span><span class="p">.</span><span class="na">getIntProperty</span><span class="p">(</span><span class="n">propertyId</span><span class="p">,</span><span class="w"> </span><span class="n">area</span><span class="p">);</span>
</span><span id="__span-57-5"><a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>CarPropertyManager.getProperty()</li>
</ul>
<div class="language-java highlight"><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="n">packages</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">Car</span><span class="o">/</span><span class="n">car</span><span class="o">-</span><span class="n">lib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">car</span><span class="o">/</span><span class="n">hardware</span><span class="o">/</span><span class="n">property</span><span class="o">/</span><span class="n">CarPropertyManager</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-58-2"><a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a>
</span><span id="__span-58-3"><a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getIntProperty</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">prop</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">area</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-58-4"><a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a><span class="w">    </span><span class="n">checkSupportedProperty</span><span class="p">(</span><span class="n">prop</span><span class="p">);</span>
</span><span id="__span-58-5"><a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a><span class="w">    </span><span class="n">CarPropertyValue</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">carProp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getProperty</span><span class="p">(</span><span class="n">Integer</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">prop</span><span class="p">,</span><span class="w"> </span><span class="n">area</span><span class="p">);</span>
</span><span id="__span-58-6"><a id="__codelineno-58-6" name="__codelineno-58-6" href="#__codelineno-58-6"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">handleNullAndPropertyStatus</span><span class="p">(</span><span class="n">carProp</span><span class="p">,</span><span class="w"> </span><span class="n">area</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-58-7"><a id="__codelineno-58-7" name="__codelineno-58-7" href="#__codelineno-58-7"></a><span class="p">}</span>
</span><span id="__span-58-8"><a id="__codelineno-58-8" name="__codelineno-58-8" href="#__codelineno-58-8"></a>
</span><span id="__span-58-9"><a id="__codelineno-58-9" name="__codelineno-58-9" href="#__codelineno-58-9"></a><span class="nd">@Nullable</span>
</span><span id="__span-58-10"><a id="__codelineno-58-10" name="__codelineno-58-10" href="#__codelineno-58-10"></a><span class="kd">public</span><span class="w"> </span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">CarPropertyValue</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getProperty</span><span class="p">(</span><span class="nd">@NonNull</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">propId</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">areaId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-58-11"><a id="__codelineno-58-11" name="__codelineno-58-11" href="#__codelineno-58-11"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-58-12"><a id="__codelineno-58-12" name="__codelineno-58-12" href="#__codelineno-58-12"></a>
</span><span id="__span-58-13"><a id="__codelineno-58-13" name="__codelineno-58-13" href="#__codelineno-58-13"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-58-14"><a id="__codelineno-58-14" name="__codelineno-58-14" href="#__codelineno-58-14"></a><span class="w">        </span><span class="n">CarPropertyValue</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">propVal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mService</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="n">propId</span><span class="p">,</span><span class="w"> </span><span class="n">areaId</span><span class="p">);</span>
</span><span id="__span-58-15"><a id="__codelineno-58-15" name="__codelineno-58-15" href="#__codelineno-58-15"></a><span class="w">        </span><span class="p">...</span>
</span><span id="__span-58-16"><a id="__codelineno-58-16" name="__codelineno-58-16" href="#__codelineno-58-16"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">propVal</span><span class="p">;</span>
</span><span id="__span-58-17"><a id="__codelineno-58-17" name="__codelineno-58-17" href="#__codelineno-58-17"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-58-18"><a id="__codelineno-58-18" name="__codelineno-58-18" href="#__codelineno-58-18"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>CarPropertyService.getProperty()</li>
</ul>
<div class="language-java highlight"><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="n">packages</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">Car</span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">car</span><span class="o">/</span><span class="n">CarPropertyService</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-59-2"><a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a>
</span><span id="__span-59-3"><a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a><span class="nd">@Override</span>
</span><span id="__span-59-4"><a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a><span class="kd">public</span><span class="w"> </span><span class="n">CarPropertyValue</span><span class="w"> </span><span class="nf">getProperty</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">prop</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">zone</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-59-5"><a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-59-6"><a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">mHal</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span><span class="w"> </span><span class="n">zone</span><span class="p">);</span>
</span><span id="__span-59-7"><a id="__codelineno-59-7" name="__codelineno-59-7" href="#__codelineno-59-7"></a><span class="p">}</span>
</span></code></pre></div>
<p>这里的 mHal 是 PropertyHalService </p>
<ul>
<li>PropertyHalService.get()</li>
</ul>
<div class="language-java highlight"><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="n">packages</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">Car</span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">car</span><span class="o">/</span><span class="n">hal</span><span class="o">/</span><span class="n">PropertyHalService</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-60-2"><a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a>
</span><span id="__span-60-3"><a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a><span class="nd">@Nullable</span>
</span><span id="__span-60-4"><a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a><span class="kd">public</span><span class="w"> </span><span class="n">CarPropertyValue</span><span class="w"> </span><span class="nf">getProperty</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">mgrPropId</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">areaId</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">ServiceSpecificException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-60-5"><a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-60-6"><a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a><span class="w">    </span><span class="n">VehiclePropValue</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mVehicleHal</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">halPropId</span><span class="p">,</span><span class="w"> </span><span class="n">areaId</span><span class="p">);</span>
</span><span id="__span-60-7"><a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-60-8"><a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>VehicleHal.get()</li>
</ul>
<div class="language-java highlight"><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="n">packages</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">Car</span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">car</span><span class="o">/</span><span class="n">hal</span><span class="o">/</span><span class="n">VehicleHal</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-61-2"><a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a>
</span><span id="__span-61-3"><a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a><span class="w"> </span><span class="kd">public</span><span class="w"> </span><span class="n">VehiclePropValue</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">propertyId</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">areaId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-4"><a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-61-5"><a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">mHalClient</span><span class="p">.</span><span class="na">getValue</span><span class="p">(</span><span class="n">createPropValue</span><span class="p">(</span><span class="n">propertyId</span><span class="p">,</span><span class="w"> </span><span class="n">areaId</span><span class="p">));</span>
</span><span id="__span-61-6"><a id="__codelineno-61-6" name="__codelineno-61-6" href="#__codelineno-61-6"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>HalClient.getValue()</li>
</ul>
<div class="language-java highlight"><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="n">packages</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">Car</span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">car</span><span class="o">/</span><span class="n">hal</span><span class="o">/</span><span class="n">HalClient</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-62-2"><a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a>
</span><span id="__span-62-3"><a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a><span class="n">VehiclePropValue</span><span class="w"> </span><span class="nf">getValue</span><span class="p">(</span><span class="n">VehiclePropValue</span><span class="w"> </span><span class="n">requestedPropValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-62-4"><a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-62-5"><a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a><span class="w">    </span><span class="n">ValueResult</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">internalGet</span><span class="p">(</span><span class="n">requestedPropValue</span><span class="p">);</span>
</span><span id="__span-62-6"><a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-62-7"><a id="__codelineno-62-7" name="__codelineno-62-7" href="#__codelineno-62-7"></a><span class="p">}</span>
</span><span id="__span-62-8"><a id="__codelineno-62-8" name="__codelineno-62-8" href="#__codelineno-62-8"></a>
</span><span id="__span-62-9"><a id="__codelineno-62-9" name="__codelineno-62-9" href="#__codelineno-62-9"></a>
</span><span id="__span-62-10"><a id="__codelineno-62-10" name="__codelineno-62-10" href="#__codelineno-62-10"></a><span class="kd">private</span><span class="w"> </span><span class="n">ValueResult</span><span class="w"> </span><span class="nf">internalGet</span><span class="p">(</span><span class="n">VehiclePropValue</span><span class="w"> </span><span class="n">requestedPropValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-62-11"><a id="__codelineno-62-11" name="__codelineno-62-11" href="#__codelineno-62-11"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-62-12"><a id="__codelineno-62-12" name="__codelineno-62-12" href="#__codelineno-62-12"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-62-13"><a id="__codelineno-62-13" name="__codelineno-62-13" href="#__codelineno-62-13"></a><span class="w">        </span><span class="n">mVehicle</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">requestedPropValue</span><span class="p">,</span>
</span><span id="__span-62-14"><a id="__codelineno-62-14" name="__codelineno-62-14" href="#__codelineno-62-14"></a><span class="w">                </span><span class="p">(</span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">propValue</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-62-15"><a id="__codelineno-62-15" name="__codelineno-62-15" href="#__codelineno-62-15"></a><span class="w">                    </span><span class="n">result</span><span class="p">.</span><span class="na">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
</span><span id="__span-62-16"><a id="__codelineno-62-16" name="__codelineno-62-16" href="#__codelineno-62-16"></a><span class="w">                    </span><span class="n">result</span><span class="p">.</span><span class="na">propValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">propValue</span><span class="p">;</span>
</span><span id="__span-62-17"><a id="__codelineno-62-17" name="__codelineno-62-17" href="#__codelineno-62-17"></a><span class="w">                </span><span class="p">});</span>
</span><span id="__span-62-18"><a id="__codelineno-62-18" name="__codelineno-62-18" href="#__codelineno-62-18"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span>
</span><span id="__span-62-19"><a id="__codelineno-62-19" name="__codelineno-62-19" href="#__codelineno-62-19"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-62-20"><a id="__codelineno-62-20" name="__codelineno-62-20" href="#__codelineno-62-20"></a><span class="p">}</span>
</span></code></pre></div>
<p>好，走到这里已经很清晰了。我们还是回到刚才的例子当中。</p>
<h4 id="vehiclehalget">VehicleHal.get()<a class="headerlink" href="#vehiclehalget" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="n">packages</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">Car</span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">car</span><span class="o">/</span><span class="n">hal</span><span class="o">/</span><span class="n">VehicleHal</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-63-2"><a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a>
</span><span id="__span-63-3"><a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a><span class="kd">public</span><span class="w"> </span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="n">Class</span><span class="w"> </span><span class="n">clazz</span><span class="p">,</span><span class="w"> </span><span class="n">VehiclePropValue</span><span class="w"> </span><span class="n">requestedPropValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-4"><a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a><span class="w">    </span><span class="n">VehiclePropValue</span><span class="w"> </span><span class="n">propValue</span><span class="p">;</span>
</span><span id="__span-63-5"><a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a><span class="w">    </span><span class="n">propValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mHalClient</span><span class="p">.</span><span class="na">getValue</span><span class="p">(</span><span class="n">requestedPropValue</span><span class="p">);</span>
</span><span id="__span-63-6"><a id="__codelineno-63-6" name="__codelineno-63-6" href="#__codelineno-63-6"></a>
</span><span id="__span-63-7"><a id="__codelineno-63-7" name="__codelineno-63-7" href="#__codelineno-63-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clazz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Long</span><span class="p">.</span><span class="na">class</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kt">long</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-8"><a id="__codelineno-63-8" name="__codelineno-63-8" href="#__codelineno-63-8"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="w"> </span><span class="n">propValue</span><span class="p">.</span><span class="na">value</span><span class="p">.</span><span class="na">int64Values</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-63-9"><a id="__codelineno-63-9" name="__codelineno-63-9" href="#__codelineno-63-9"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clazz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Integer</span><span class="p">.</span><span class="na">class</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kt">int</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-10"><a id="__codelineno-63-10" name="__codelineno-63-10" href="#__codelineno-63-10"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="w"> </span><span class="n">propValue</span><span class="p">.</span><span class="na">value</span><span class="p">.</span><span class="na">int32Values</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-63-11"><a id="__codelineno-63-11" name="__codelineno-63-11" href="#__codelineno-63-11"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clazz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Boolean</span><span class="p">.</span><span class="na">class</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kt">boolean</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-12"><a id="__codelineno-63-12" name="__codelineno-63-12" href="#__codelineno-63-12"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="w"> </span><span class="n">Boolean</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">propValue</span><span class="p">.</span><span class="na">value</span><span class="p">.</span><span class="na">int32Values</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-63-13"><a id="__codelineno-63-13" name="__codelineno-63-13" href="#__codelineno-63-13"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clazz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Float</span><span class="p">.</span><span class="na">class</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kt">float</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-14"><a id="__codelineno-63-14" name="__codelineno-63-14" href="#__codelineno-63-14"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="w"> </span><span class="n">propValue</span><span class="p">.</span><span class="na">value</span><span class="p">.</span><span class="na">floatValues</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-63-15"><a id="__codelineno-63-15" name="__codelineno-63-15" href="#__codelineno-63-15"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clazz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Long</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-16"><a id="__codelineno-63-16" name="__codelineno-63-16" href="#__codelineno-63-16"></a><span class="w">        </span><span class="n">Long</span><span class="o">[]</span><span class="w"> </span><span class="n">longArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Long</span><span class="o">[</span><span class="n">propValue</span><span class="p">.</span><span class="na">value</span><span class="p">.</span><span class="na">int64Values</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="o">]</span><span class="p">;</span>
</span><span id="__span-63-17"><a id="__codelineno-63-17" name="__codelineno-63-17" href="#__codelineno-63-17"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="w"> </span><span class="n">propValue</span><span class="p">.</span><span class="na">value</span><span class="p">.</span><span class="na">int32Values</span><span class="p">.</span><span class="na">toArray</span><span class="p">(</span><span class="n">longArray</span><span class="p">);</span>
</span><span id="__span-63-18"><a id="__codelineno-63-18" name="__codelineno-63-18" href="#__codelineno-63-18"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clazz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Integer</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-19"><a id="__codelineno-63-19" name="__codelineno-63-19" href="#__codelineno-63-19"></a><span class="w">        </span><span class="n">Integer</span><span class="o">[]</span><span class="w"> </span><span class="n">intArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Integer</span><span class="o">[</span><span class="n">propValue</span><span class="p">.</span><span class="na">value</span><span class="p">.</span><span class="na">int32Values</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="o">]</span><span class="p">;</span>
</span><span id="__span-63-20"><a id="__codelineno-63-20" name="__codelineno-63-20" href="#__codelineno-63-20"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="w"> </span><span class="n">propValue</span><span class="p">.</span><span class="na">value</span><span class="p">.</span><span class="na">int32Values</span><span class="p">.</span><span class="na">toArray</span><span class="p">(</span><span class="n">intArray</span><span class="p">);</span>
</span><span id="__span-63-21"><a id="__codelineno-63-21" name="__codelineno-63-21" href="#__codelineno-63-21"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clazz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Float</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-22"><a id="__codelineno-63-22" name="__codelineno-63-22" href="#__codelineno-63-22"></a><span class="w">        </span><span class="n">Float</span><span class="o">[]</span><span class="w"> </span><span class="n">floatArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Float</span><span class="o">[</span><span class="n">propValue</span><span class="p">.</span><span class="na">value</span><span class="p">.</span><span class="na">floatValues</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="o">]</span><span class="p">;</span>
</span><span id="__span-63-23"><a id="__codelineno-63-23" name="__codelineno-63-23" href="#__codelineno-63-23"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="w"> </span><span class="n">propValue</span><span class="p">.</span><span class="na">value</span><span class="p">.</span><span class="na">floatValues</span><span class="p">.</span><span class="na">toArray</span><span class="p">(</span><span class="n">floatArray</span><span class="p">);</span>
</span><span id="__span-63-24"><a id="__codelineno-63-24" name="__codelineno-63-24" href="#__codelineno-63-24"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clazz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kt">long</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-25"><a id="__codelineno-63-25" name="__codelineno-63-25" href="#__codelineno-63-25"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="w"> </span><span class="n">toLongArray</span><span class="p">(</span><span class="n">propValue</span><span class="p">.</span><span class="na">value</span><span class="p">.</span><span class="na">int64Values</span><span class="p">);</span>
</span><span id="__span-63-26"><a id="__codelineno-63-26" name="__codelineno-63-26" href="#__codelineno-63-26"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clazz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-27"><a id="__codelineno-63-27" name="__codelineno-63-27" href="#__codelineno-63-27"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="w"> </span><span class="n">toIntArray</span><span class="p">(</span><span class="n">propValue</span><span class="p">.</span><span class="na">value</span><span class="p">.</span><span class="na">int32Values</span><span class="p">);</span>
</span><span id="__span-63-28"><a id="__codelineno-63-28" name="__codelineno-63-28" href="#__codelineno-63-28"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clazz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kt">float</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-29"><a id="__codelineno-63-29" name="__codelineno-63-29" href="#__codelineno-63-29"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="w"> </span><span class="n">toFloatArray</span><span class="p">(</span><span class="n">propValue</span><span class="p">.</span><span class="na">value</span><span class="p">.</span><span class="na">floatValues</span><span class="p">);</span>
</span><span id="__span-63-30"><a id="__codelineno-63-30" name="__codelineno-63-30" href="#__codelineno-63-30"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clazz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-31"><a id="__codelineno-63-31" name="__codelineno-63-31" href="#__codelineno-63-31"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="w"> </span><span class="n">toByteArray</span><span class="p">(</span><span class="n">propValue</span><span class="p">.</span><span class="na">value</span><span class="p">.</span><span class="na">bytes</span><span class="p">);</span>
</span><span id="__span-63-32"><a id="__codelineno-63-32" name="__codelineno-63-32" href="#__codelineno-63-32"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clazz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-33"><a id="__codelineno-63-33" name="__codelineno-63-33" href="#__codelineno-63-33"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="w"> </span><span class="n">propValue</span><span class="p">.</span><span class="na">value</span><span class="p">.</span><span class="na">stringValue</span><span class="p">;</span>
</span><span id="__span-63-34"><a id="__codelineno-63-34" name="__codelineno-63-34" href="#__codelineno-63-34"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-35"><a id="__codelineno-63-35" name="__codelineno-63-35" href="#__codelineno-63-35"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span><span class="s">&quot;Unexpected type: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">clazz</span><span class="p">);</span>
</span><span id="__span-63-36"><a id="__codelineno-63-36" name="__codelineno-63-36" href="#__codelineno-63-36"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-63-37"><a id="__codelineno-63-37" name="__codelineno-63-37" href="#__codelineno-63-37"></a><span class="p">}</span>
</span></code></pre></div>
<p>VehicleHal 里有几个 get() 函数，不管是那个 get() 函数，最终都是调 mHalClient.getValue() 获取属性。</p>
<h4 id="halclientgetvalue">HalClient.getValue()<a class="headerlink" href="#halclientgetvalue" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="n">packages</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">Car</span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">car</span><span class="o">/</span><span class="n">hal</span><span class="o">/</span><span class="n">HalClient</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a>
</span><span id="__span-64-3"><a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a><span class="n">VehiclePropValue</span><span class="w"> </span><span class="nf">getValue</span><span class="p">(</span><span class="n">VehiclePropValue</span><span class="w"> </span><span class="n">requestedPropValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-64-4"><a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">ObjectWrapper</span><span class="o">&lt;</span><span class="n">VehiclePropValue</span><span class="o">&gt;</span><span class="w"> </span><span class="n">valueWrapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectWrapper</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-64-5"><a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">invokeRetriable</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-64-6"><a id="__codelineno-64-6" name="__codelineno-64-6" href="#__codelineno-64-6"></a><span class="w">        </span><span class="n">ValueResult</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">internalGet</span><span class="p">(</span><span class="n">requestedPropValue</span><span class="p">);</span>
</span><span id="__span-64-7"><a id="__codelineno-64-7" name="__codelineno-64-7" href="#__codelineno-64-7"></a><span class="w">        </span><span class="n">valueWrapper</span><span class="p">.</span><span class="na">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">res</span><span class="p">.</span><span class="na">propValue</span><span class="p">;</span>
</span><span id="__span-64-8"><a id="__codelineno-64-8" name="__codelineno-64-8" href="#__codelineno-64-8"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">.</span><span class="na">status</span><span class="p">;</span>
</span><span id="__span-64-9"><a id="__codelineno-64-9" name="__codelineno-64-9" href="#__codelineno-64-9"></a><span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="n">mWaitCapMs</span><span class="p">,</span><span class="w"> </span><span class="n">mSleepMs</span><span class="p">);</span>
</span><span id="__span-64-10"><a id="__codelineno-64-10" name="__codelineno-64-10" href="#__codelineno-64-10"></a>
</span><span id="__span-64-11"><a id="__codelineno-64-11" name="__codelineno-64-11" href="#__codelineno-64-11"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-64-12"><a id="__codelineno-64-12" name="__codelineno-64-12" href="#__codelineno-64-12"></a><span class="p">}</span>
</span><span id="__span-64-13"><a id="__codelineno-64-13" name="__codelineno-64-13" href="#__codelineno-64-13"></a>
</span><span id="__span-64-14"><a id="__codelineno-64-14" name="__codelineno-64-14" href="#__codelineno-64-14"></a><span class="kd">private</span><span class="w"> </span><span class="n">ValueResult</span><span class="w"> </span><span class="nf">internalGet</span><span class="p">(</span><span class="n">VehiclePropValue</span><span class="w"> </span><span class="n">requestedPropValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-64-15"><a id="__codelineno-64-15" name="__codelineno-64-15" href="#__codelineno-64-15"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">ValueResult</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ValueResult</span><span class="p">();</span>
</span><span id="__span-64-16"><a id="__codelineno-64-16" name="__codelineno-64-16" href="#__codelineno-64-16"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-64-17"><a id="__codelineno-64-17" name="__codelineno-64-17" href="#__codelineno-64-17"></a><span class="w">        </span><span class="n">mVehicle</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">requestedPropValue</span><span class="p">,</span>
</span><span id="__span-64-18"><a id="__codelineno-64-18" name="__codelineno-64-18" href="#__codelineno-64-18"></a><span class="w">                </span><span class="p">(</span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">propValue</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-64-19"><a id="__codelineno-64-19" name="__codelineno-64-19" href="#__codelineno-64-19"></a><span class="w">                    </span><span class="n">result</span><span class="p">.</span><span class="na">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
</span><span id="__span-64-20"><a id="__codelineno-64-20" name="__codelineno-64-20" href="#__codelineno-64-20"></a><span class="w">                    </span><span class="n">result</span><span class="p">.</span><span class="na">propValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">propValue</span><span class="p">;</span>
</span><span id="__span-64-21"><a id="__codelineno-64-21" name="__codelineno-64-21" href="#__codelineno-64-21"></a><span class="w">                </span><span class="p">});</span>
</span><span id="__span-64-22"><a id="__codelineno-64-22" name="__codelineno-64-22" href="#__codelineno-64-22"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-64-23"><a id="__codelineno-64-23" name="__codelineno-64-23" href="#__codelineno-64-23"></a><span class="w">        </span><span class="n">Slogf</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="n">getValueErrorMessage</span><span class="p">(</span><span class="s">&quot;get&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">requestedPropValue</span><span class="p">),</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
</span><span id="__span-64-24"><a id="__codelineno-64-24" name="__codelineno-64-24" href="#__codelineno-64-24"></a><span class="w">        </span><span class="n">result</span><span class="p">.</span><span class="na">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StatusCode</span><span class="p">.</span><span class="na">TRY_AGAIN</span><span class="p">;</span>
</span><span id="__span-64-25"><a id="__codelineno-64-25" name="__codelineno-64-25" href="#__codelineno-64-25"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-64-26"><a id="__codelineno-64-26" name="__codelineno-64-26" href="#__codelineno-64-26"></a>
</span><span id="__span-64-27"><a id="__codelineno-64-27" name="__codelineno-64-27" href="#__codelineno-64-27"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
</span><span id="__span-64-28"><a id="__codelineno-64-28" name="__codelineno-64-28" href="#__codelineno-64-28"></a><span class="p">}</span>
</span></code></pre></div>
<p>根据前面的分析 mVehicle 是 VehicleHal 。也就是 IVehicle.hal 的 get() 接口。
最终是调到 VehicleHalManager.cpp 的 get() 接口。</p>
<h4 id="vehiclehalmanagerget">VehicleHalManager.get()<a class="headerlink" href="#vehiclehalmanagerget" title="Permanent link">&para;</a></h4>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="k">default</span><span class="o">/</span><span class="n">common</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">VehicleHalManager</span><span class="p">.</span><span class="n">cpp</span>
</span><span id="__span-65-2"><a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a>
</span><span id="__span-65-3"><a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a><span class="n">Return</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span><span class="w"> </span><span class="n">VehicleHalManager</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">VehiclePropValue</span><span class="o">&amp;</span><span class="w"> </span><span class="n">requestedPropValue</span><span class="p">,</span><span class="w"> </span><span class="n">get_cb</span><span class="w"> </span><span class="n">_hidl_cb</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-65-4"><a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">*</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getPropConfigOrNull</span><span class="p">(</span><span class="n">requestedPropValue</span><span class="p">.</span><span class="n">prop</span><span class="p">);</span><span class="w">  </span><span class="c1">// 获取指定属性的配置信息</span>
</span><span id="__span-65-5"><a id="__codelineno-65-5" name="__codelineno-65-5" href="#__codelineno-65-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">config</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-65-6"><a id="__codelineno-65-6" name="__codelineno-65-6" href="#__codelineno-65-6"></a><span class="w">        </span><span class="n">ALOGE</span><span class="p">(</span><span class="s">&quot;Failed to get value: config not found, property: 0x%x&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">requestedPropValue</span><span class="p">.</span><span class="n">prop</span><span class="p">);</span>
</span><span id="__span-65-7"><a id="__codelineno-65-7" name="__codelineno-65-7" href="#__codelineno-65-7"></a><span class="w">        </span><span class="n">_hidl_cb</span><span class="p">(</span><span class="n">StatusCode</span><span class="o">::</span><span class="n">INVALID_ARG</span><span class="p">,</span><span class="w"> </span><span class="n">kEmptyValue</span><span class="p">);</span>
</span><span id="__span-65-8"><a id="__codelineno-65-8" name="__codelineno-65-8" href="#__codelineno-65-8"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Void</span><span class="p">();</span>
</span><span id="__span-65-9"><a id="__codelineno-65-9" name="__codelineno-65-9" href="#__codelineno-65-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-65-10"><a id="__codelineno-65-10" name="__codelineno-65-10" href="#__codelineno-65-10"></a>
</span><span id="__span-65-11"><a id="__codelineno-65-11" name="__codelineno-65-11" href="#__codelineno-65-11"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">checkReadPermission</span><span class="p">(</span><span class="o">*</span><span class="n">config</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// 如果没有读取权限</span>
</span><span id="__span-65-12"><a id="__codelineno-65-12" name="__codelineno-65-12" href="#__codelineno-65-12"></a><span class="w">        </span><span class="n">_hidl_cb</span><span class="p">(</span><span class="n">StatusCode</span><span class="o">::</span><span class="n">ACCESS_DENIED</span><span class="p">,</span><span class="w"> </span><span class="n">kEmptyValue</span><span class="p">);</span><span class="w">  </span><span class="c1">// 回调ACCESS_DENIED错误码和空值</span>
</span><span id="__span-65-13"><a id="__codelineno-65-13" name="__codelineno-65-13" href="#__codelineno-65-13"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Void</span><span class="p">();</span><span class="w">  </span><span class="c1">// 返回空值</span>
</span><span id="__span-65-14"><a id="__codelineno-65-14" name="__codelineno-65-14" href="#__codelineno-65-14"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-65-15"><a id="__codelineno-65-15" name="__codelineno-65-15" href="#__codelineno-65-15"></a>
</span><span id="__span-65-16"><a id="__codelineno-65-16" name="__codelineno-65-16" href="#__codelineno-65-16"></a><span class="w">    </span><span class="n">StatusCode</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
</span><span id="__span-65-17"><a id="__codelineno-65-17" name="__codelineno-65-17" href="#__codelineno-65-17"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mHal</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">requestedPropValue</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span><span class="w">  </span><span class="c1">// 调用mHal的get方法获取属性值</span>
</span><span id="__span-65-18"><a id="__codelineno-65-18" name="__codelineno-65-18" href="#__codelineno-65-18"></a><span class="w">    </span><span class="n">_hidl_cb</span><span class="p">(</span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">.</span><span class="n">get</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="o">*</span><span class="n">value</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">kEmptyValue</span><span class="p">);</span><span class="w">  </span><span class="c1">// 回调获取的状态码和属性值（如果有）</span>
</span><span id="__span-65-19"><a id="__codelineno-65-19" name="__codelineno-65-19" href="#__codelineno-65-19"></a>
</span><span id="__span-65-20"><a id="__codelineno-65-20" name="__codelineno-65-20" href="#__codelineno-65-20"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Void</span><span class="p">();</span><span class="w">  </span><span class="c1">// 返回空值</span>
</span><span id="__span-65-21"><a id="__codelineno-65-21" name="__codelineno-65-21" href="#__codelineno-65-21"></a><span class="p">}</span>
</span></code></pre></div>
<p>还是根据前面的分析，mHal 就是 EmulatedVehicleHal。</p>
<h4 id="emulatedvehiclehalget">EmulatedVehicleHal.get()<a class="headerlink" href="#emulatedvehiclehalget" title="Permanent link">&para;</a></h4>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="k">default</span><span class="o">/</span><span class="n">impl</span><span class="o">/</span><span class="n">vhal_v2_0</span><span class="o">/</span><span class="n">EmulatedVehicleHal</span><span class="p">.</span><span class="n">cpp</span>
</span><span id="__span-66-2"><a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a>
</span><span id="__span-66-3"><a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a><span class="n">VehicleHal</span><span class="o">::</span><span class="n">VehiclePropValuePtr</span><span class="w"> </span><span class="n">EmulatedVehicleHal</span><span class="o">::</span><span class="n">get</span><span class="p">(</span>
</span><span id="__span-66-4"><a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">VehiclePropValue</span><span class="o">&amp;</span><span class="w"> </span><span class="n">requestedPropValue</span><span class="p">,</span><span class="w"> </span><span class="n">StatusCode</span><span class="o">*</span><span class="w"> </span><span class="n">outStatus</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-66-5"><a id="__codelineno-66-5" name="__codelineno-66-5" href="#__codelineno-66-5"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">propId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requestedPropValue</span><span class="p">.</span><span class="n">prop</span><span class="p">;</span>
</span><span id="__span-66-6"><a id="__codelineno-66-6" name="__codelineno-66-6" href="#__codelineno-66-6"></a><span class="w">    </span><span class="n">ALOGV</span><span class="p">(</span><span class="s">&quot;get(%d)&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">propId</span><span class="p">);</span>
</span><span id="__span-66-7"><a id="__codelineno-66-7" name="__codelineno-66-7" href="#__codelineno-66-7"></a>
</span><span id="__span-66-8"><a id="__codelineno-66-8" name="__codelineno-66-8" href="#__codelineno-66-8"></a><span class="w">    </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">pool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">getValuePool</span><span class="p">();</span>
</span><span id="__span-66-9"><a id="__codelineno-66-9" name="__codelineno-66-9" href="#__codelineno-66-9"></a><span class="w">    </span><span class="n">VehiclePropValuePtr</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"> </span><span class="c1">// 定义一个指向VehiclePropValue的智能指针v，并初始化为nullptr</span>
</span><span id="__span-66-10"><a id="__codelineno-66-10" name="__codelineno-66-10" href="#__codelineno-66-10"></a>
</span><span id="__span-66-11"><a id="__codelineno-66-11" name="__codelineno-66-11" href="#__codelineno-66-11"></a><span class="w">    </span><span class="c1">// 根据propId来获取值</span>
</span><span id="__span-66-12"><a id="__codelineno-66-12" name="__codelineno-66-12" href="#__codelineno-66-12"></a><span class="w">    </span><span class="c1">// OBD2_FREEZE_FRAME 是 0BD 检测到故障信息</span>
</span><span id="__span-66-13"><a id="__codelineno-66-13" name="__codelineno-66-13" href="#__codelineno-66-13"></a><span class="w">    </span><span class="c1">// OBD2_FREEZE_FRAME_INFO 是故障检测到得时间戳</span>
</span><span id="__span-66-14"><a id="__codelineno-66-14" name="__codelineno-66-14" href="#__codelineno-66-14"></a><span class="w">    </span><span class="c1">// 一般要获取 OBD2_FREEZE_FRAME 的数据之前，都要通过 OBD2_FREEZE_FRAME_INFO 获取时间戳。</span>
</span><span id="__span-66-15"><a id="__codelineno-66-15" name="__codelineno-66-15" href="#__codelineno-66-15"></a><span class="w">    </span><span class="c1">//除了这两个属性值，其他的都直接从临时的Store里面获取当前属性的状态值。</span>
</span><span id="__span-66-16"><a id="__codelineno-66-16" name="__codelineno-66-16" href="#__codelineno-66-16"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">propId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-66-17"><a id="__codelineno-66-17" name="__codelineno-66-17" href="#__codelineno-66-17"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">OBD2_FREEZE_FRAME</span><span class="p">:</span>
</span><span id="__span-66-18"><a id="__codelineno-66-18" name="__codelineno-66-18" href="#__codelineno-66-18"></a><span class="w">            </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="p">.</span><span class="n">obtainComplex</span><span class="p">();</span>
</span><span id="__span-66-19"><a id="__codelineno-66-19" name="__codelineno-66-19" href="#__codelineno-66-19"></a><span class="w">            </span><span class="o">*</span><span class="n">outStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fillObd2FreezeFrame</span><span class="p">(</span><span class="n">requestedPropValue</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
</span><span id="__span-66-20"><a id="__codelineno-66-20" name="__codelineno-66-20" href="#__codelineno-66-20"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-66-21"><a id="__codelineno-66-21" name="__codelineno-66-21" href="#__codelineno-66-21"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">OBD2_FREEZE_FRAME_INFO</span><span class="p">:</span>
</span><span id="__span-66-22"><a id="__codelineno-66-22" name="__codelineno-66-22" href="#__codelineno-66-22"></a><span class="w">            </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="p">.</span><span class="n">obtainComplex</span><span class="p">();</span>
</span><span id="__span-66-23"><a id="__codelineno-66-23" name="__codelineno-66-23" href="#__codelineno-66-23"></a><span class="w">            </span><span class="o">*</span><span class="n">outStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fillObd2DtcInfo</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
</span><span id="__span-66-24"><a id="__codelineno-66-24" name="__codelineno-66-24" href="#__codelineno-66-24"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-66-25"><a id="__codelineno-66-25" name="__codelineno-66-25" href="#__codelineno-66-25"></a><span class="w">        </span><span class="k">default</span><span class="o">:</span>
</span><span id="__span-66-26"><a id="__codelineno-66-26" name="__codelineno-66-26" href="#__codelineno-66-26"></a><span class="w">            </span><span class="c1">// 如果 EmulatedUserHal 支持这个属性，则调用 EmulatedUserHal.onGetProperty() 函数获取属性值</span>
</span><span id="__span-66-27"><a id="__codelineno-66-27" name="__codelineno-66-27" href="#__codelineno-66-27"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mEmulatedUserHal</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mEmulatedUserHal</span><span class="o">-&gt;</span><span class="n">isSupported</span><span class="p">(</span><span class="n">propId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-66-28"><a id="__codelineno-66-28" name="__codelineno-66-28" href="#__codelineno-66-28"></a><span class="w">                </span><span class="n">ALOGI</span><span class="p">(</span><span class="s">&quot;get(): getting value for prop %d from User HAL&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">propId</span><span class="p">);</span>
</span><span id="__span-66-29"><a id="__codelineno-66-29" name="__codelineno-66-29" href="#__codelineno-66-29"></a><span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mEmulatedUserHal</span><span class="o">-&gt;</span><span class="n">onGetProperty</span><span class="p">(</span><span class="n">requestedPropValue</span><span class="p">);</span>
</span><span id="__span-66-30"><a id="__codelineno-66-30" name="__codelineno-66-30" href="#__codelineno-66-30"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-66-31"><a id="__codelineno-66-31" name="__codelineno-66-31" href="#__codelineno-66-31"></a><span class="w">                    </span><span class="n">ALOGE</span><span class="p">(</span><span class="s">&quot;get(): User HAL returned error: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">.</span><span class="n">error</span><span class="p">().</span><span class="n">message</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
</span><span id="__span-66-32"><a id="__codelineno-66-32" name="__codelineno-66-32" href="#__codelineno-66-32"></a><span class="w">                    </span><span class="o">*</span><span class="n">outStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StatusCode</span><span class="p">(</span><span class="n">ret</span><span class="p">.</span><span class="n">error</span><span class="p">().</span><span class="n">code</span><span class="p">());</span><span class="w"> </span>
</span><span id="__span-66-33"><a id="__codelineno-66-33" name="__codelineno-66-33" href="#__codelineno-66-33"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-66-34"><a id="__codelineno-66-34" name="__codelineno-66-34" href="#__codelineno-66-34"></a><span class="w">                    </span><span class="k">auto</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ret</span><span class="p">.</span><span class="n">value</span><span class="p">().</span><span class="n">get</span><span class="p">();</span>
</span><span id="__span-66-35"><a id="__codelineno-66-35" name="__codelineno-66-35" href="#__codelineno-66-35"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-66-36"><a id="__codelineno-66-36" name="__codelineno-66-36" href="#__codelineno-66-36"></a><span class="w">                        </span><span class="n">ALOGI</span><span class="p">(</span><span class="s">&quot;get(): User HAL returned value: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">toString</span><span class="p">(</span><span class="o">*</span><span class="n">value</span><span class="p">).</span><span class="n">c_str</span><span class="p">());</span>
</span><span id="__span-66-37"><a id="__codelineno-66-37" name="__codelineno-66-37" href="#__codelineno-66-37"></a><span class="w">                        </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getValuePool</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">obtain</span><span class="p">(</span><span class="o">*</span><span class="n">value</span><span class="p">);</span>
</span><span id="__span-66-38"><a id="__codelineno-66-38" name="__codelineno-66-38" href="#__codelineno-66-38"></a><span class="w">                        </span><span class="o">*</span><span class="n">outStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StatusCode</span><span class="o">::</span><span class="n">OK</span><span class="p">;</span>
</span><span id="__span-66-39"><a id="__codelineno-66-39" name="__codelineno-66-39" href="#__codelineno-66-39"></a><span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-66-40"><a id="__codelineno-66-40" name="__codelineno-66-40" href="#__codelineno-66-40"></a><span class="w">                        </span><span class="n">ALOGE</span><span class="p">(</span><span class="s">&quot;get(): User HAL returned null value&quot;</span><span class="p">);</span>
</span><span id="__span-66-41"><a id="__codelineno-66-41" name="__codelineno-66-41" href="#__codelineno-66-41"></a><span class="w">                        </span><span class="o">*</span><span class="n">outStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StatusCode</span><span class="o">::</span><span class="n">INTERNAL_ERROR</span><span class="p">;</span>
</span><span id="__span-66-42"><a id="__codelineno-66-42" name="__codelineno-66-42" href="#__codelineno-66-42"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-66-43"><a id="__codelineno-66-43" name="__codelineno-66-43" href="#__codelineno-66-43"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-66-44"><a id="__codelineno-66-44" name="__codelineno-66-44" href="#__codelineno-66-44"></a><span class="w">                </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-66-45"><a id="__codelineno-66-45" name="__codelineno-66-45" href="#__codelineno-66-45"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-66-46"><a id="__codelineno-66-46" name="__codelineno-66-46" href="#__codelineno-66-46"></a>
</span><span id="__span-66-47"><a id="__codelineno-66-47" name="__codelineno-66-47" href="#__codelineno-66-47"></a><span class="w">            </span><span class="c1">// 空调电源属性 </span>
</span><span id="__span-66-48"><a id="__codelineno-66-48" name="__codelineno-66-48" href="#__codelineno-66-48"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mHvacPowerProps</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">propId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-66-49"><a id="__codelineno-66-49" name="__codelineno-66-49" href="#__codelineno-66-49"></a><span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">hvacPowerOn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mPropStore</span><span class="o">-&gt;</span><span class="n">readValueOrNull</span><span class="p">(</span>
</span><span id="__span-66-50"><a id="__codelineno-66-50" name="__codelineno-66-50" href="#__codelineno-66-50"></a><span class="w">                    </span><span class="n">toInt</span><span class="p">(</span><span class="n">VehicleProperty</span><span class="o">::</span><span class="n">HVAC_POWER_ON</span><span class="p">),</span>
</span><span id="__span-66-51"><a id="__codelineno-66-51" name="__codelineno-66-51" href="#__codelineno-66-51"></a><span class="w">                    </span><span class="p">(</span><span class="n">VehicleAreaSeat</span><span class="o">::</span><span class="n">ROW_1_LEFT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">VehicleAreaSeat</span><span class="o">::</span><span class="n">ROW_1_RIGHT</span><span class="w"> </span><span class="o">|</span>
</span><span id="__span-66-52"><a id="__codelineno-66-52" name="__codelineno-66-52" href="#__codelineno-66-52"></a><span class="w">                    </span><span class="n">VehicleAreaSeat</span><span class="o">::</span><span class="n">ROW_2_LEFT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">VehicleAreaSeat</span><span class="o">::</span><span class="n">ROW_2_CENTER</span><span class="w"> </span><span class="o">|</span>
</span><span id="__span-66-53"><a id="__codelineno-66-53" name="__codelineno-66-53" href="#__codelineno-66-53"></a><span class="w">                    </span><span class="n">VehicleAreaSeat</span><span class="o">::</span><span class="n">ROW_2_RIGHT</span><span class="p">));</span>
</span><span id="__span-66-54"><a id="__codelineno-66-54" name="__codelineno-66-54" href="#__codelineno-66-54"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hvacPowerOn</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">hvacPowerOn</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">int32Values</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-66-55"><a id="__codelineno-66-55" name="__codelineno-66-55" href="#__codelineno-66-55"></a><span class="w">                        </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">hvacPowerOn</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">int32Values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-66-56"><a id="__codelineno-66-56" name="__codelineno-66-56" href="#__codelineno-66-56"></a><span class="w">                    </span><span class="o">*</span><span class="n">outStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StatusCode</span><span class="o">::</span><span class="n">NOT_AVAILABLE</span><span class="p">;</span><span class="w"> </span><span class="c1">// 将状态码设置为NOT_AVAILABLE</span>
</span><span id="__span-66-57"><a id="__codelineno-66-57" name="__codelineno-66-57" href="#__codelineno-66-57"></a><span class="w">                    </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-66-58"><a id="__codelineno-66-58" name="__codelineno-66-58" href="#__codelineno-66-58"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-66-59"><a id="__codelineno-66-59" name="__codelineno-66-59" href="#__codelineno-66-59"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-66-60"><a id="__codelineno-66-60" name="__codelineno-66-60" href="#__codelineno-66-60"></a>
</span><span id="__span-66-61"><a id="__codelineno-66-61" name="__codelineno-66-61" href="#__codelineno-66-61"></a><span class="w">            </span><span class="c1">// mPropStore 就是 VehiclePropertyStore ，也就是从 VehiclePropertyStore 获取属性</span>
</span><span id="__span-66-62"><a id="__codelineno-66-62" name="__codelineno-66-62" href="#__codelineno-66-62"></a><span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">internalPropValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mPropStore</span><span class="o">-&gt;</span><span class="n">readValueOrNull</span><span class="p">(</span><span class="n">requestedPropValue</span><span class="p">);</span>
</span><span id="__span-66-63"><a id="__codelineno-66-63" name="__codelineno-66-63" href="#__codelineno-66-63"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">internalPropValue</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-66-64"><a id="__codelineno-66-64" name="__codelineno-66-64" href="#__codelineno-66-64"></a><span class="w">                </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getValuePool</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">obtain</span><span class="p">(</span><span class="o">*</span><span class="n">internalPropValue</span><span class="p">);</span>
</span><span id="__span-66-65"><a id="__codelineno-66-65" name="__codelineno-66-65" href="#__codelineno-66-65"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-66-66"><a id="__codelineno-66-66" name="__codelineno-66-66" href="#__codelineno-66-66"></a>
</span><span id="__span-66-67"><a id="__codelineno-66-67" name="__codelineno-66-67" href="#__codelineno-66-67"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-66-68"><a id="__codelineno-66-68" name="__codelineno-66-68" href="#__codelineno-66-68"></a><span class="w">                </span><span class="o">*</span><span class="n">outStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StatusCode</span><span class="o">::</span><span class="n">INVALID_ARG</span><span class="p">;</span>
</span><span id="__span-66-69"><a id="__codelineno-66-69" name="__codelineno-66-69" href="#__codelineno-66-69"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">VehiclePropertyStatus</span><span class="o">::</span><span class="n">AVAILABLE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-66-70"><a id="__codelineno-66-70" name="__codelineno-66-70" href="#__codelineno-66-70"></a><span class="w">                </span><span class="o">*</span><span class="n">outStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StatusCode</span><span class="o">::</span><span class="n">OK</span><span class="p">;</span>
</span><span id="__span-66-71"><a id="__codelineno-66-71" name="__codelineno-66-71" href="#__codelineno-66-71"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-66-72"><a id="__codelineno-66-72" name="__codelineno-66-72" href="#__codelineno-66-72"></a><span class="w">                </span><span class="o">*</span><span class="n">outStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StatusCode</span><span class="o">::</span><span class="n">TRY_AGAIN</span><span class="p">;</span>
</span><span id="__span-66-73"><a id="__codelineno-66-73" name="__codelineno-66-73" href="#__codelineno-66-73"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-66-74"><a id="__codelineno-66-74" name="__codelineno-66-74" href="#__codelineno-66-74"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-66-75"><a id="__codelineno-66-75" name="__codelineno-66-75" href="#__codelineno-66-75"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-66-76"><a id="__codelineno-66-76" name="__codelineno-66-76" href="#__codelineno-66-76"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">get</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-66-77"><a id="__codelineno-66-77" name="__codelineno-66-77" href="#__codelineno-66-77"></a><span class="w">        </span><span class="n">v</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">elapsedRealtimeNano</span><span class="p">();</span>
</span><span id="__span-66-78"><a id="__codelineno-66-78" name="__codelineno-66-78" href="#__codelineno-66-78"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-66-79"><a id="__codelineno-66-79" name="__codelineno-66-79" href="#__codelineno-66-79"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v</span><span class="p">;</span>
</span><span id="__span-66-80"><a id="__codelineno-66-80" name="__codelineno-66-80" href="#__codelineno-66-80"></a><span class="p">}</span>
</span></code></pre></div>
<p>这里其实很简单：
- 故障 相关的属性，则相关函数单独出来，但最终都还是调用到 VehiclePropertyStore 里获取的。
- EmulatedUserHal 支持这个属性，则从 EmulatedUserHal 获取
- 空调电源属性，单独处理
- 如果以上情况都不满足，则正常从 VehiclePropertyStore 获取属性。</p>
<h4 id="vehiclepropertystore_1">VehiclePropertyStore<a class="headerlink" href="#vehiclepropertystore_1" title="Permanent link">&para;</a></h4>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="n">hardware</span><span class="o">/</span><span class="n">interfaces</span><span class="o">/</span><span class="n">automotive</span><span class="o">/</span><span class="n">vehicle</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="k">default</span><span class="o">/</span><span class="n">common</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">VehiclePropertyStore</span><span class="p">.</span><span class="n">cpp</span>
</span><span id="__span-67-2"><a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a>
</span><span id="__span-67-3"><a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">VehiclePropValue</span><span class="o">&gt;</span><span class="w"> </span><span class="n">VehiclePropertyStore</span><span class="o">::</span><span class="n">readValueOrNull</span><span class="p">(</span>
</span><span id="__span-67-4"><a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">VehiclePropValue</span><span class="o">&amp;</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-67-5"><a id="__codelineno-67-5" name="__codelineno-67-5" href="#__codelineno-67-5"></a><span class="w">    </span><span class="n">MuxGuard</span><span class="w"> </span><span class="nf">g</span><span class="p">(</span><span class="n">mLock</span><span class="p">);</span>
</span><span id="__span-67-6"><a id="__codelineno-67-6" name="__codelineno-67-6" href="#__codelineno-67-6"></a><span class="w">    </span><span class="n">RecordId</span><span class="w"> </span><span class="n">recId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getRecordIdLocked</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
</span><span id="__span-67-7"><a id="__codelineno-67-7" name="__codelineno-67-7" href="#__codelineno-67-7"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VehiclePropValue</span><span class="o">*</span><span class="w"> </span><span class="n">internalValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getValueOrNullLocked</span><span class="p">(</span><span class="n">recId</span><span class="p">);</span>
</span><span id="__span-67-8"><a id="__codelineno-67-8" name="__codelineno-67-8" href="#__codelineno-67-8"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">internalValue</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">VehiclePropValue</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">internalValue</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
</span><span id="__span-67-9"><a id="__codelineno-67-9" name="__codelineno-67-9" href="#__codelineno-67-9"></a><span class="p">}</span>
</span><span id="__span-67-10"><a id="__codelineno-67-10" name="__codelineno-67-10" href="#__codelineno-67-10"></a>
</span><span id="__span-67-11"><a id="__codelineno-67-11" name="__codelineno-67-11" href="#__codelineno-67-11"></a><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">VehiclePropValue</span><span class="o">&gt;</span><span class="w"> </span><span class="n">VehiclePropertyStore</span><span class="o">::</span><span class="n">readValueOrNull</span><span class="p">(</span>
</span><span id="__span-67-12"><a id="__codelineno-67-12" name="__codelineno-67-12" href="#__codelineno-67-12"></a><span class="w">        </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">prop</span><span class="p">,</span><span class="w"> </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">area</span><span class="p">,</span><span class="w"> </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">token</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-67-13"><a id="__codelineno-67-13" name="__codelineno-67-13" href="#__codelineno-67-13"></a><span class="w">    </span><span class="n">RecordId</span><span class="w"> </span><span class="n">recId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">prop</span><span class="p">,</span><span class="w"> </span><span class="n">isGlobalProp</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">area</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="p">};</span>
</span><span id="__span-67-14"><a id="__codelineno-67-14" name="__codelineno-67-14" href="#__codelineno-67-14"></a><span class="w">    </span><span class="n">MuxGuard</span><span class="w"> </span><span class="nf">g</span><span class="p">(</span><span class="n">mLock</span><span class="p">);</span>
</span><span id="__span-67-15"><a id="__codelineno-67-15" name="__codelineno-67-15" href="#__codelineno-67-15"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VehiclePropValue</span><span class="o">*</span><span class="w"> </span><span class="n">internalValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getValueOrNullLocked</span><span class="p">(</span><span class="n">recId</span><span class="p">);</span>
</span><span id="__span-67-16"><a id="__codelineno-67-16" name="__codelineno-67-16" href="#__codelineno-67-16"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">internalValue</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">VehiclePropValue</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">internalValue</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
</span><span id="__span-67-17"><a id="__codelineno-67-17" name="__codelineno-67-17" href="#__codelineno-67-17"></a><span class="p">}</span>
</span><span id="__span-67-18"><a id="__codelineno-67-18" name="__codelineno-67-18" href="#__codelineno-67-18"></a>
</span><span id="__span-67-19"><a id="__codelineno-67-19" name="__codelineno-67-19" href="#__codelineno-67-19"></a><span class="k">const</span><span class="w"> </span><span class="n">VehiclePropValue</span><span class="o">*</span><span class="w"> </span><span class="n">VehiclePropertyStore</span><span class="o">::</span><span class="n">getValueOrNullLocked</span><span class="p">(</span>
</span><span id="__span-67-20"><a id="__codelineno-67-20" name="__codelineno-67-20" href="#__codelineno-67-20"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">VehiclePropertyStore</span><span class="o">::</span><span class="n">RecordId</span><span class="o">&amp;</span><span class="w"> </span><span class="n">recId</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w">  </span><span class="p">{</span>
</span><span id="__span-67-21"><a id="__codelineno-67-21" name="__codelineno-67-21" href="#__codelineno-67-21"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mPropertyValues</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">recId</span><span class="p">);</span>
</span><span id="__span-67-22"><a id="__codelineno-67-22" name="__codelineno-67-22" href="#__codelineno-67-22"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">mPropertyValues</span><span class="p">.</span><span class="n">end</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">&amp;</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
</span><span id="__span-67-23"><a id="__codelineno-67-23" name="__codelineno-67-23" href="#__codelineno-67-23"></a><span class="p">}</span>
</span></code></pre></div>
<p><strong>从这里可以看出来，VehicleHal 配置的这些车辆相关的属性，其实并没有通过数据库或者文件进程存储。而是通过 VehiclePropertyStore 存储在内存中。</strong> </p>
<p>其实前面我们提到 VehiclePropertyStore 的类，其中有一个 registerProperty() 函数，就是每次进程起来的时候把所有的属性都加载到内存中。</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="c1">//hardware/interfaces/automotive/vehicle/2.0/default/impl/vhal_v2_0/VehicleEmulator.h</span>
</span><span id="__span-68-2"><a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">EmulatedVehicleHalIface</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">VehicleHal</span><span class="p">{.....}</span>
</span><span id="__span-68-3"><a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a>
</span><span id="__span-68-4"><a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a><span class="c1">//hardware/interfaces/automotive/vehicle/2.0/default/impl/vhal_v2_0/EmulatedVehicleHal.h</span>
</span><span id="__span-68-5"><a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">EmulatedVehicleHal</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">EmulatedVehicleHalIface</span><span class="p">{....}</span>
</span><span id="__span-68-6"><a id="__codelineno-68-6" name="__codelineno-68-6" href="#__codelineno-68-6"></a>
</span><span id="__span-68-7"><a id="__codelineno-68-7" name="__codelineno-68-7" href="#__codelineno-68-7"></a><span class="c1">//hardware/interfaces/automotive/vehicle/2.0/default/impl/vhal_v2_0/EmulatedVehicleHal.cpp</span>
</span><span id="__span-68-8"><a id="__codelineno-68-8" name="__codelineno-68-8" href="#__codelineno-68-8"></a><span class="n">VehicleHal</span><span class="o">::</span><span class="n">VehiclePropValuePtr</span><span class="w"> </span><span class="n">EmulatedVehicleHal</span><span class="o">::</span><span class="n">get</span><span class="p">(</span>
</span><span id="__span-68-9"><a id="__codelineno-68-9" name="__codelineno-68-9" href="#__codelineno-68-9"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">VehiclePropValue</span><span class="o">&amp;</span><span class="w"> </span><span class="n">requestedPropValue</span><span class="p">,</span><span class="w"> </span><span class="n">StatusCode</span><span class="o">*</span><span class="w"> </span><span class="n">outStatus</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-68-10"><a id="__codelineno-68-10" name="__codelineno-68-10" href="#__codelineno-68-10"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">propId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requestedPropValue</span><span class="p">.</span><span class="n">prop</span><span class="p">;</span>
</span><span id="__span-68-11"><a id="__codelineno-68-11" name="__codelineno-68-11" href="#__codelineno-68-11"></a><span class="w">    </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">pool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">getValuePool</span><span class="p">();</span>
</span><span id="__span-68-12"><a id="__codelineno-68-12" name="__codelineno-68-12" href="#__codelineno-68-12"></a><span class="w">    </span><span class="n">VehiclePropValuePtr</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
</span><span id="__span-68-13"><a id="__codelineno-68-13" name="__codelineno-68-13" href="#__codelineno-68-13"></a>
</span><span id="__span-68-14"><a id="__codelineno-68-14" name="__codelineno-68-14" href="#__codelineno-68-14"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">propId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-68-15"><a id="__codelineno-68-15" name="__codelineno-68-15" href="#__codelineno-68-15"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">OBD2_FREEZE_FRAME</span><span class="p">:</span>
</span><span id="__span-68-16"><a id="__codelineno-68-16" name="__codelineno-68-16" href="#__codelineno-68-16"></a><span class="w">            </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="p">.</span><span class="n">obtainComplex</span><span class="p">();</span>
</span><span id="__span-68-17"><a id="__codelineno-68-17" name="__codelineno-68-17" href="#__codelineno-68-17"></a><span class="w">            </span><span class="o">*</span><span class="n">outStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fillObd2FreezeFrame</span><span class="p">(</span><span class="n">requestedPropValue</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
</span><span id="__span-68-18"><a id="__codelineno-68-18" name="__codelineno-68-18" href="#__codelineno-68-18"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-68-19"><a id="__codelineno-68-19" name="__codelineno-68-19" href="#__codelineno-68-19"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">OBD2_FREEZE_FRAME_INFO</span><span class="p">:</span>
</span><span id="__span-68-20"><a id="__codelineno-68-20" name="__codelineno-68-20" href="#__codelineno-68-20"></a><span class="w">            </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="p">.</span><span class="n">obtainComplex</span><span class="p">();</span>
</span><span id="__span-68-21"><a id="__codelineno-68-21" name="__codelineno-68-21" href="#__codelineno-68-21"></a><span class="w">            </span><span class="o">*</span><span class="n">outStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fillObd2DtcInfo</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
</span><span id="__span-68-22"><a id="__codelineno-68-22" name="__codelineno-68-22" href="#__codelineno-68-22"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-68-23"><a id="__codelineno-68-23" name="__codelineno-68-23" href="#__codelineno-68-23"></a><span class="w">        </span><span class="k">default</span><span class="o">:</span>
</span><span id="__span-68-24"><a id="__codelineno-68-24" name="__codelineno-68-24" href="#__codelineno-68-24"></a><span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">internalPropValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mPropStore</span><span class="o">-&gt;</span><span class="n">readValueOrNull</span><span class="p">(</span><span class="n">requestedPropValue</span><span class="p">);</span>
</span><span id="__span-68-25"><a id="__codelineno-68-25" name="__codelineno-68-25" href="#__codelineno-68-25"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">internalPropValue</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-68-26"><a id="__codelineno-68-26" name="__codelineno-68-26" href="#__codelineno-68-26"></a><span class="w">                </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getValuePool</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">obtain</span><span class="p">(</span><span class="o">*</span><span class="n">internalPropValue</span><span class="p">);</span>
</span><span id="__span-68-27"><a id="__codelineno-68-27" name="__codelineno-68-27" href="#__codelineno-68-27"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-68-28"><a id="__codelineno-68-28" name="__codelineno-68-28" href="#__codelineno-68-28"></a><span class="w">            </span><span class="o">*</span><span class="n">outStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">StatusCode</span><span class="o">::</span><span class="n">OK</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">StatusCode</span><span class="o">::</span><span class="n">INVALID_ARG</span><span class="p">;</span>
</span><span id="__span-68-29"><a id="__codelineno-68-29" name="__codelineno-68-29" href="#__codelineno-68-29"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-68-30"><a id="__codelineno-68-30" name="__codelineno-68-30" href="#__codelineno-68-30"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-68-31"><a id="__codelineno-68-31" name="__codelineno-68-31" href="#__codelineno-68-31"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v</span><span class="p">;</span>
</span><span id="__span-68-32"><a id="__codelineno-68-32" name="__codelineno-68-32" href="#__codelineno-68-32"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>
<p>VehiclePropertyStore.cpp - readValueOrNull</p>
</li>
<li>
<p>getRecordIdLocked 根据入参VehiclePropValue获取RecordId，关于VehiclePropValue对象可查看上层VehicleHal.java的get函数的流程</p>
</li>
<li>
<p>调用getValueOrNullLocked，根据RecordId从VehiclePropertyStore中读取</p>
</li>
</ul>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="c1">//VehiclePropertyStore.cpp</span>
</span><span id="__span-69-2"><a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a><span class="n">VehiclePropertyStore</span><span class="o">::</span><span class="n">RecordId</span><span class="w"> </span><span class="nf">VehiclePropertyStore::getRecordIdLocked</span><span class="p">(</span>
</span><span id="__span-69-3"><a id="__codelineno-69-3" name="__codelineno-69-3" href="#__codelineno-69-3"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">VehiclePropValue</span><span class="o">&amp;</span><span class="w"> </span><span class="n">valuePrototype</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-69-4"><a id="__codelineno-69-4" name="__codelineno-69-4" href="#__codelineno-69-4"></a><span class="w">    </span><span class="n">RecordId</span><span class="w"> </span><span class="n">recId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-69-5"><a id="__codelineno-69-5" name="__codelineno-69-5" href="#__codelineno-69-5"></a><span class="w">        </span><span class="p">.</span><span class="n">prop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">valuePrototype</span><span class="p">.</span><span class="n">prop</span><span class="p">,</span>
</span><span id="__span-69-6"><a id="__codelineno-69-6" name="__codelineno-69-6" href="#__codelineno-69-6"></a><span class="w">        </span><span class="p">.</span><span class="n">area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isGlobalProp</span><span class="p">(</span><span class="n">valuePrototype</span><span class="p">.</span><span class="n">prop</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">valuePrototype</span><span class="p">.</span><span class="n">areaId</span><span class="p">,</span>
</span><span id="__span-69-7"><a id="__codelineno-69-7" name="__codelineno-69-7" href="#__codelineno-69-7"></a><span class="w">        </span><span class="p">.</span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-69-8"><a id="__codelineno-69-8" name="__codelineno-69-8" href="#__codelineno-69-8"></a><span class="w">    </span><span class="p">};</span>
</span><span id="__span-69-9"><a id="__codelineno-69-9" name="__codelineno-69-9" href="#__codelineno-69-9"></a>
</span><span id="__span-69-10"><a id="__codelineno-69-10" name="__codelineno-69-10" href="#__codelineno-69-10"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mConfigs</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">recId</span><span class="p">.</span><span class="n">prop</span><span class="p">);</span>
</span><span id="__span-69-11"><a id="__codelineno-69-11" name="__codelineno-69-11" href="#__codelineno-69-11"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">mConfigs</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">{};</span>
</span><span id="__span-69-12"><a id="__codelineno-69-12" name="__codelineno-69-12" href="#__codelineno-69-12"></a>
</span><span id="__span-69-13"><a id="__codelineno-69-13" name="__codelineno-69-13" href="#__codelineno-69-13"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">tokenFunction</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-69-14"><a id="__codelineno-69-14" name="__codelineno-69-14" href="#__codelineno-69-14"></a><span class="w">        </span><span class="n">recId</span><span class="p">.</span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">tokenFunction</span><span class="p">(</span><span class="n">valuePrototype</span><span class="p">);</span>
</span><span id="__span-69-15"><a id="__codelineno-69-15" name="__codelineno-69-15" href="#__codelineno-69-15"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-69-16"><a id="__codelineno-69-16" name="__codelineno-69-16" href="#__codelineno-69-16"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">recId</span><span class="p">;</span>
</span><span id="__span-69-17"><a id="__codelineno-69-17" name="__codelineno-69-17" href="#__codelineno-69-17"></a><span class="p">}</span>
</span><span id="__span-69-18"><a id="__codelineno-69-18" name="__codelineno-69-18" href="#__codelineno-69-18"></a>
</span><span id="__span-69-19"><a id="__codelineno-69-19" name="__codelineno-69-19" href="#__codelineno-69-19"></a><span class="k">const</span><span class="w"> </span><span class="n">VehiclePropValue</span><span class="o">*</span><span class="w"> </span><span class="nf">VehiclePropertyStore::getValueOrNullLocked</span><span class="p">(</span>
</span><span id="__span-69-20"><a id="__codelineno-69-20" name="__codelineno-69-20" href="#__codelineno-69-20"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">VehiclePropertyStore</span><span class="o">::</span><span class="n">RecordId</span><span class="o">&amp;</span><span class="w"> </span><span class="n">recId</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w">  </span><span class="p">{</span>
</span><span id="__span-69-21"><a id="__codelineno-69-21" name="__codelineno-69-21" href="#__codelineno-69-21"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mPropertyValues</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">recId</span><span class="p">);</span>
</span><span id="__span-69-22"><a id="__codelineno-69-22" name="__codelineno-69-22" href="#__codelineno-69-22"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">mPropertyValues</span><span class="p">.</span><span class="n">end</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">&amp;</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
</span><span id="__span-69-23"><a id="__codelineno-69-23" name="__codelineno-69-23" href="#__codelineno-69-23"></a><span class="p">}</span>
</span><span id="__span-69-24"><a id="__codelineno-69-24" name="__codelineno-69-24" href="#__codelineno-69-24"></a>
</span><span id="__span-69-25"><a id="__codelineno-69-25" name="__codelineno-69-25" href="#__codelineno-69-25"></a>
</span><span id="__span-69-26"><a id="__codelineno-69-26" name="__codelineno-69-26" href="#__codelineno-69-26"></a><span class="c1">//VehiclePropertyStore.h</span>
</span><span id="__span-69-27"><a id="__codelineno-69-27" name="__codelineno-69-27" href="#__codelineno-69-27"></a><span class="k">class</span><span class="w"> </span><span class="nc">VehiclePropertyStore</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-69-28"><a id="__codelineno-69-28" name="__codelineno-69-28" href="#__codelineno-69-28"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-69-29"><a id="__codelineno-69-29" name="__codelineno-69-29" href="#__codelineno-69-29"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">RecordId</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-69-30"><a id="__codelineno-69-30" name="__codelineno-69-30" href="#__codelineno-69-30"></a><span class="w">        </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">prop</span><span class="p">;</span>
</span><span id="__span-69-31"><a id="__codelineno-69-31" name="__codelineno-69-31" href="#__codelineno-69-31"></a><span class="w">        </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">area</span><span class="p">;</span>
</span><span id="__span-69-32"><a id="__codelineno-69-32" name="__codelineno-69-32" href="#__codelineno-69-32"></a><span class="w">        </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">token</span><span class="p">;</span>
</span><span id="__span-69-33"><a id="__codelineno-69-33" name="__codelineno-69-33" href="#__codelineno-69-33"></a>
</span><span id="__span-69-34"><a id="__codelineno-69-34" name="__codelineno-69-34" href="#__codelineno-69-34"></a><span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="k">operator</span><span class="o">==</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">RecordId</span><span class="o">&amp;</span><span class="w"> </span><span class="n">other</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
</span><span id="__span-69-35"><a id="__codelineno-69-35" name="__codelineno-69-35" href="#__codelineno-69-35"></a><span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="k">operator</span><span class="o">&lt;</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">RecordId</span><span class="o">&amp;</span><span class="w"> </span><span class="n">other</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
</span><span id="__span-69-36"><a id="__codelineno-69-36" name="__codelineno-69-36" href="#__codelineno-69-36"></a><span class="w">    </span><span class="p">};</span>
</span><span id="__span-69-37"><a id="__codelineno-69-37" name="__codelineno-69-37" href="#__codelineno-69-37"></a>
</span><span id="__span-69-38"><a id="__codelineno-69-38" name="__codelineno-69-38" href="#__codelineno-69-38"></a><span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">PropertyMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">RecordId</span><span class="p">,</span><span class="w"> </span><span class="n">VehiclePropValue</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-69-39"><a id="__codelineno-69-39" name="__codelineno-69-39" href="#__codelineno-69-39"></a><span class="w">    </span><span class="p">.....</span>
</span><span id="__span-69-40"><a id="__codelineno-69-40" name="__codelineno-69-40" href="#__codelineno-69-40"></a><span class="w">    </span><span class="n">PropertyMap</span><span class="w"> </span><span class="n">mPropertyValues</span><span class="p">;</span>
</span><span id="__span-69-41"><a id="__codelineno-69-41" name="__codelineno-69-41" href="#__codelineno-69-41"></a><span class="p">}</span>
</span></code></pre></div>
<h2 id="_2">附录<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>文中提到的一个接口文件会在编译的时候自动生成，主要目录是在：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a>out/soong/.intermediates/hardware/interfaces/automotive/vehicle/2.0
</span><span id="__span-70-2"><a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a>
</span><span id="__span-70-3"><a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a>android.hardware.automotive.vehicle@2.0_genc++
</span><span id="__span-70-4"><a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a>android.hardware.automotive.vehicle@2.0_genc++_headers
</span><span id="__span-70-5"><a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a>android.hardware.automotive.vehicle-V2.0-java_gen_java
</span></code></pre></div>







  
  






  <h2 id="__comments">评论</h2>
  <!-- Insert generated snippet here -->

    <script src="https://giscus.app/client.js"
        data-repo="i-rtfsc/i-rtfsc.github.io"
        data-repo-id="MDEwOlJlcG9zaXRvcnkxNTU2NzA2OTE="
        data-category="Q&A"
        data-category-id="DIC_kwDOCUdYo84CeZYU"
        data-mapping="pathname"
        data-strict="1"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="preferred_color_scheme"
        data-lang="zh-CN"
        data-loading="lazy"
        data-default-reactions-enabled="1"
        crossorigin="anonymous"
        async>
    </script>

  <!-- Synchronize Giscus theme with palette -->
  <script>
    var giscus = document.querySelector("script[src*=giscus]")

    // Set palette on initial load
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object") {
      var theme = palette.color.scheme === "slate"
        ? "transparent_dark"
        : "light"

      // Instruct Giscus to set theme
      giscus.setAttribute("data-theme", theme)
    }

    // Register event handlers after documented loaded
    document.addEventListener("DOMContentLoaded", function() {
      var ref = document.querySelector("[data-md-component=palette]")
      ref.addEventListener("change", function() {
        var palette = __md_get("__palette")
        if (palette && typeof palette.color === "object") {
          var theme = palette.color.scheme === "slate"
            ? "transparent_dark"
            : "light"

          // Instruct Giscus to change theme
          var frame = document.querySelector(".giscus-frame")
          frame.contentWindow.postMessage(
            { giscus: { setConfig: { theme } } },
            "https://giscus.app"
          )
        }
      })
    })
  </script>


<script src="//code.tidio.co/rqu0g9yeqzoipyjjehe84aqmiqt1ap9r.js" async></script>


                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
    
    
    
    <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
        
        <a href="../../carservice/car-wifi-service/" class="md-footer__link md-footer__link--prev"
           aria-label="上一页: Android 15 CarService源码07-CarWifiService">
            <div class="md-footer__button md-icon">
                
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
                <div class="md-ellipsis">
                    Android 15 CarService源码07-CarWifiService
                </div>
            </div>
        </a>
        
        
        
        <a href="../android-u-hal-intro/" class="md-footer__link md-footer__link--next"
           aria-label="下一页: Android-U Vehicle HAL架构">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
                <div class="md-ellipsis">
                    Android-U Vehicle HAL架构
                </div>
            </div>
            <div class="md-footer__button md-icon">
                
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
        </a>
        
    </nav>
    
    
    <div class="md-footer-meta md-typeset">
        <div class="md-footer-meta__inner md-grid">
            <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2015-2025 Solo</br>The website content is licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a>
    </div>
  
  
</div>

            
            <div class="md-copyright">
    <font size=1>
        
        <a href="https://icp.gov.moe/?keyword=20243250" target="_blank">萌ICP备20243250号</a>
        

        
        <span>&nbsp;|&nbsp;本站访问量：</span>
        <script async src="//finicounter.eu.org/finicounter.js"></script>
        <span id="finicount_views"></span>
        

        
        
        <span>&nbsp;|&nbsp;本站已经运行：</span>
        <span id="uptime"></span>
        <script>
            function calculateUptime() {
                let dateString = '2018-11-1'
                let start = new Date(dateString);
                let currentTime = new Date();
                let difference = currentTime - start;
                let days = Math.floor(difference / (1000 * 60 * 60 * 24));
                document.getElementById('uptime').textContent = days + '天';
            }

            calculateUptime()
        </script>
        
    </font>
</div>
            

            
            <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/i-rtfsc" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
    <a href="mailto:<anqi.huang@outlook.com>" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 493.2 160 480v-83.6c0-4 1.5-7.8 4.2-10.8l167.6-182.8c5.8-6.3 5.6-16-.4-22s-15.7-6.4-22-.7L106 360.8l-88.3-44.2C7.1 311.3.3 300.7 0 288.9s5.9-22.8 16.1-28.7l448-256c10.7-6.1 23.9-5.5 34 1.4"/></svg>
    </a>
  
</div>
            
        </div>
    </div>

</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": ["announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.code.select", "content.tooltips", "navigation.indexes", "navigation.top", "navigation.footer", "navigation.tracking", "navigation.path", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.tabs", "navigation.tabs.sticky", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": {"Default": "default-tag", "Hardware": "hardware-tag", "Software": "software-tag"}, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.60a45f97.min.js"></script>
      
        <script src="../../../../javascripts/extra.js"></script>
      
        <script src="../../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mermaid@10.0.2/dist/add-html-label-6e56ed67.min.js"></script>
      
    
  </body>
</html>