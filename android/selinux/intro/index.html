
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="本文会从语法、Android SE流程等详细介绍SELinux相关知识。如果读者不感兴趣，只想快速的解决某个进程缺少SELinux导致的错误，可以直接跳到“万能公式”这一节。">
      
      
        <meta name="author" content="Solo">
      
      
        <link rel="canonical" href="https://0.0.0.0:8000/android/selinux/intro/">
      
      
        <link rel="prev" href="../../broadcast/intro/">
      
      
        <link rel="next" href="../genfscon/">
      
      
      <link rel="icon" href="../../../assets/images/logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.50">
    
    
      
        <title>Android SELinux介绍 - Solo's Blog</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.a40c8224.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../fonts/lxgw-wenkai.css">
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
      <link rel="stylesheet" href="../../../stylesheets/extra2.css">
    
      <link rel="stylesheet" href="../../../stylesheets/link.css">
    
      <link rel="stylesheet" href="../../../stylesheets/customize.css">
    
      <link rel="stylesheet" href="../../../stylesheets/bannerSlider.css">
    
      <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.css">
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1.1.0/style.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      



<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
    <nav class="md-header__inner md-grid" aria-label="页眉">
        <a href="../../.." title="Solo&#39;s Blog"
           class="md-header__button md-logo" aria-label="Solo's Blog" data-md-component="logo">
            
  <img src="../../../assets/images/logo.png" alt="logo">

        </a>
        <label class="md-header__button md-icon" for="__drawer">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
        </label>
        <div class="md-header__title" data-md-component="header-title">
            <div class="md-header__ellipsis">
                <div class="md-header__topic">
          <span class="md-ellipsis">
            Solo's Blog
          </span>
                </div>
                <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Android SELinux介绍
            
          </span>
                </div>
            </div>
        </div>
        
        



<div class="md-copyright">
    
    <font color=#608DBD size=3>
        <span id="jinrishici-sentence">正在加载今日诗词....</span>
        <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
    </font>
    

    
</div>
        
        
        
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="purple"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
        
        
        
        <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
        
        
        
        <label class="md-header__button md-icon" for="__search">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="分享" aria-label="分享" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
        
        <div class="md-header__source">
            <a href="https://github.com/i-rtfsc/note" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    i-rtfsc/note
  </div>
</a>
        </div>
        
    </nav>
    
    
    
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
    
  
  首页

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../brightness/automatic-brightness-intro/" class="md-tabs__link">
          
  
    
  
  Android

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../base/51-android-rules/" class="md-tabs__link">
          
  
    
  
  基础技术

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../development-board/raspberry-pi/intro/" class="md-tabs__link">
          
  
    
  
  开发板

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../source-code/personal-source-code-intro/" class="md-tabs__link">
          
  
    
  
  源码工程

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
    
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Solo&#39;s Blog" class="md-nav__button md-logo" aria-label="Solo's Blog" data-md-component="logo">
      
  <img src="../../../assets/images/logo.png" alt="logo">

    </a>
    Solo's Blog
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/i-rtfsc/note" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    i-rtfsc/note
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    首页
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Android
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Android
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../brightness/automatic-brightness-intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android自动背光机制
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tombstones/tombstones-intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NativeTombstoneManager
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bootanimation/bootanimation-intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    bootanimation程序简介
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" >
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    AMS
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            AMS
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ams/launch-modes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Activity四大启动模式
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ams/client_transaction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Activity框架01-客户端事务管理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ams/activity_client_record/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Activity框架02-ActivityClientRecord
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ams/activity_thread/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Activity框架03-ActivityThread
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ams/activity_context/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Activity框架04-Activity和Context的关系
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ams/lifecycle/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Activity生命周期
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ams/android11-activity-start/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android11 Activity启动流程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ams/wm-layout-params/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    WindowManager.LayoutParams
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ams/frida-dump-activity-lifecycle/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    frida dump activity生命周期
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5" >
        
          
          <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Broadcast
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5">
            <span class="md-nav__icon md-icon"></span>
            Broadcast
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../broadcast/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Broadcast概述
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6" checked>
        
          
          <label class="md-nav__link" for="__nav_2_6" id="__nav_2_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    SELinux
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_6">
            <span class="md-nav__icon md-icon"></span>
            SELinux
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Android SELinux介绍
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Android SELinux介绍
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      前言
    </span>
  </a>
  
    <nav class="md-nav" aria-label="前言">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      简介
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      工作模式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      工作原理
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#android" class="md-nav__link">
    <span class="md-ellipsis">
      Android实现
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Android实现">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      差异
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#se" class="md-nav__link">
    <span class="md-ellipsis">
      SE相关文件
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      语法
    </span>
  </a>
  
    <nav class="md-nav" aria-label="语法">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#type-statements" class="md-nav__link">
    <span class="md-ellipsis">
      Type Statements
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Type Statements">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#type" class="md-nav__link">
    <span class="md-ellipsis">
      type
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attribute" class="md-nav__link">
    <span class="md-ellipsis">
      attribute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#access-vector-rules" class="md-nav__link">
    <span class="md-ellipsis">
      Access Vector Rules
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Access Vector Rules">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#allow" class="md-nav__link">
    <span class="md-ellipsis">
      allow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neverallow" class="md-nav__link">
    <span class="md-ellipsis">
      neverallow
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#android-se" class="md-nav__link">
    <span class="md-ellipsis">
      Android SE流程
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Android SE流程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#se_1" class="md-nav__link">
    <span class="md-ellipsis">
      SE加载流程
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SE加载流程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#first_stage_mainmain" class="md-nav__link">
    <span class="md-ellipsis">
      first_stage_main.main()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#first_stage_initfirststagemain" class="md-nav__link">
    <span class="md-ellipsis">
      first_stage_init.FirstStageMain()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mainmain" class="md-nav__link">
    <span class="md-ellipsis">
      main.main()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#selinuxsetupselinux" class="md-nav__link">
    <span class="md-ellipsis">
      selinux.SetupSelinux()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#selinuxreadpolicy" class="md-nav__link">
    <span class="md-ellipsis">
      selinux.ReadPolicy()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="selinux.ReadPolicy()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#selinuxopensplitpolicy" class="md-nav__link">
    <span class="md-ellipsis">
      selinux.OpenSplitPolicy()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#selinuxfindprecompiledsplitpolicy" class="md-nav__link">
    <span class="md-ellipsis">
      selinux.FindPrecompiledSplitPolicy()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#selinuxselinuxsetenforcement" class="md-nav__link">
    <span class="md-ellipsis">
      selinux.SelinuxSetEnforcement()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      总结
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pid" class="md-nav__link">
    <span class="md-ellipsis">
      设置应用pid流程
    </span>
  </a>
  
    <nav class="md-nav" aria-label="设置应用pid流程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#forkandspecialize" class="md-nav__link">
    <span class="md-ellipsis">
      forkAndSpecialize
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nativeforkandspecialize" class="md-nav__link">
    <span class="md-ellipsis">
      nativeForkAndSpecialize
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#specializecommon" class="md-nav__link">
    <span class="md-ellipsis">
      SpecializeCommon
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#selinux_android_setcontext" class="md-nav__link">
    <span class="md-ellipsis">
      selinux_android_setcontext
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#seapp_context_lookup" class="md-nav__link">
    <span class="md-ellipsis">
      seapp_context_lookup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#selinux_android_seapp_context_init" class="md-nav__link">
    <span class="md-ellipsis">
      selinux_android_seapp_context_init
    </span>
  </a>
  
    <nav class="md-nav" aria-label="selinux_android_seapp_context_init">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#seapp_context_init" class="md-nav__link">
    <span class="md-ellipsis">
      seapp_context_init
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#selinux_android_seapp_context_reload" class="md-nav__link">
    <span class="md-ellipsis">
      selinux_android_seapp_context_reload
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      疑问
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#java-seinfo" class="md-nav__link">
    <span class="md-ellipsis">
      Java seinfo
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Java seinfo">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#processinstallrequestsasync" class="md-nav__link">
    <span class="md-ellipsis">
      processInstallRequestsAsync
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installpackagestracedli" class="md-nav__link">
    <span class="md-ellipsis">
      installPackagesTracedLI
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installpackagesli" class="md-nav__link">
    <span class="md-ellipsis">
      installPackagesLI
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scanpackagetracedli" class="md-nav__link">
    <span class="md-ellipsis">
      scanPackageTracedLI
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scanpackageli" class="md-nav__link">
    <span class="md-ellipsis">
      scanPackageLI
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#addforinitli" class="md-nav__link">
    <span class="md-ellipsis">
      addForInitLI
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scanpackageonlyli" class="md-nav__link">
    <span class="md-ellipsis">
      scanPackageOnlyLI
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getseinfo" class="md-nav__link">
    <span class="md-ellipsis">
      getSeInfo
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xxx_mac_permissionsxml" class="md-nav__link">
    <span class="md-ellipsis">
      xxx_mac_permissions.xml
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      编译验证
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      辅助工具
    </span>
  </a>
  
    <nav class="md-nav" aria-label="辅助工具">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sys" class="md-nav__link">
    <span class="md-ellipsis">
      内核/sys/驱动节点
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#faq" class="md-nav__link">
    <span class="md-ellipsis">
      FAQ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FAQ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#security-context" class="md-nav__link">
    <span class="md-ellipsis">
      安全上下文(security context)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#file_contexts" class="md-nav__link">
    <span class="md-ellipsis">
      file_contexts 如何生效？
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-the-policies-built-through-the-intermediates-files" class="md-nav__link">
    <span class="md-ellipsis">
      Check the policies built through the intermediates files.
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-to-check-that-your-modifications-are-allowed" class="md-nav__link">
    <span class="md-ellipsis">
      How to check that your modifications are allowed？
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-to-disable-it" class="md-nav__link">
    <span class="md-ellipsis">
      How to disable it?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      如何在设备上默认打开或关闭？
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-to-createextend-a-policy" class="md-nav__link">
    <span class="md-ellipsis">
      How to create/extend a policy?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-to-custom-security-context-of-process" class="md-nav__link">
    <span class="md-ellipsis">
      How to custom Security Context of process?
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      万能公式
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reference" class="md-nav__link">
    <span class="md-ellipsis">
      Reference
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../genfscon/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    genfscon
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7" >
        
          
          <label class="md-nav__link" for="__nav_2_7" id="__nav_2_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Binder
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_7">
            <span class="md-nav__icon md-icon"></span>
            Binder
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../binder/android12-native-binder-change/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 12 Native Binder 代码变迁
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../binder/ashmem/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ashmem简介（Android IPC传输大数据）
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../binder/driver/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Binder机制01-驱动
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../binder/service-manager/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Binder机制02-ServiceManager
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../binder/framework-native/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Binder机制03-Framework-Native
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../binder/framework-java/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Binder机制04-Framework-Java
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../binder/aidl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Binder机制05-AIDL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../binder/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Binder概述
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../binder/am-trace-ipc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    am trace-ipc 分析
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_8" >
        
          
          <label class="md-nav__link" for="__nav_2_8" id="__nav_2_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Car
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_8">
            <span class="md-nav__icon md-icon"></span>
            Car
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_8_1" >
        
          
          <label class="md-nav__link" for="__nav_2_8_1" id="__nav_2_8_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    CarService
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_8_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_8_1">
            <span class="md-nav__icon md-icon"></span>
            CarService
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../car/carservice/start-service/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 15 CarService源码01-服务启动
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../car/carservice/init-service/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 15 CarService源码02-服务初始化
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../car/carservice/all-service/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 15 CarService源码03-服务及接口
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../car/carservice/carservice-call-vhal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 15 CarService源码04-CarService与Vehicle HAL交互
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../car/carservice/system-interface/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 15 CarService源码05-SystemInterface
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../car/carservice/car-input-service/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 15 CarService源码06-CarInputService
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../car/carservice/car-wifi-service/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 15 CarService源码07-CarWifiService
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_8_2" >
        
          
          <label class="md-nav__link" for="__nav_2_8_2" id="__nav_2_8_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Vehicle
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_8_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_8_2">
            <span class="md-nav__icon md-icon"></span>
            Vehicle
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../car/vehicle/android-s-hal-intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android-S Vehicle HAL架构
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../car/vehicle/android-u-hal-intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android-U Vehicle HAL架构
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_9" >
        
          
          <label class="md-nav__link" for="__nav_2_9" id="__nav_2_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Input
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_9">
            <span class="md-nav__icon md-icon"></span>
            Input
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../input/focused-window/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 窗口焦点介绍
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../input/inotify-epoll/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    INotify与Epoll机制
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../input/inputDispatcher-inputChannel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    InputDispatcher与InputChannel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../input/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Input概述
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../input/start/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Input系统01-Input启动过程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../input/input-reader/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Input系统02-InputReader线程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../input/scancode-keycode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Scancode到Keycode的映射
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../input/add-new-key/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    新增物理按键处理流程
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_10" >
        
          
          <label class="md-nav__link" for="__nav_2_10" id="__nav_2_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    基础与工具
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_10">
            <span class="md-nav__icon md-icon"></span>
            基础与工具
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../base-tools/adb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ADB
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../base-tools/api-levels/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android API Levels
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../base-tools/as-shortcut-keys/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android Studio 快捷键
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../base-tools/as-compdb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Compdb
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../base-tools/c-ifdef/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    c代码中 ifdef 多条件判断
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../base-tools/repo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    repo常用操作
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../base-tools/ccache/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    使用ccache加快编译速度
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../base-tools/winscope/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    编译winscope
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_11" >
        
          
          <label class="md-nav__link" for="__nav_2_11" id="__nav_2_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    巧夺天工
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_11">
            <span class="md-nav__icon md-icon"></span>
            巧夺天工
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../divine-skill/android-bp-if-else/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android.bp 添加宏控
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../divine-skill/service-extra-func-without-aidl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    aosp原生Service快捷扩展接口
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../divine-skill/mem-pressure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    内存加压
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../divine-skill/log-to-line-chart/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    通过log中的坐标转成折线图
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_12" >
        
          
          <label class="md-nav__link" for="__nav_2_12" id="__nav_2_12_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    调试技巧
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_12">
            <span class="md-nav__icon md-icon"></span>
            调试技巧
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../debug-skill/tomestone-stack/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android Native crash tomestone trace tools
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../debug-skill/call-stack/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android打印函数调用流程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../debug-skill/am-set-debug-app/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    am set-debug-app 介绍
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../debug-skill/privapp-permissions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    privapp permissions检查
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../debug-skill/event-log/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    借助 event log 有效排查问题
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../debug-skill/merge-sort-log/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    按时间顺序合并log
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../debug-skill/jdwp-enabled/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    无法打断点调试
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_12_8" >
        
          
          <label class="md-nav__link" for="__nav_2_12_8" id="__nav_2_12_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    调频命令
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_12_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_12_8">
            <span class="md-nav__icon md-icon"></span>
            调频命令
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../debug-skill/frequency/cpu/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CPU提频命令
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../debug-skill/frequency/gpu/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GPU提频命令
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_13" >
        
          
          <label class="md-nav__link" for="__nav_2_13" id="__nav_2_13_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    问题及方案
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_13">
            <span class="md-nav__icon md-icon"></span>
            问题及方案
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../issue-solution/set-affinity/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android进程绑核方案
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../issue_solution/car-service-updatable-call-hide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CarServiceUpdatable引用hide接口
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    基础技术
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            基础技术
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base/51-android-rules/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    51-android.rules
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base/jar-delete/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Jar包删除部分内容
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base/jetbrains_directories/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    JetBrains配置目录
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base/git_branch_commit_single/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    git小技巧-commit single
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base/hexo-next/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    hexo、next主题美化
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base/linux-service/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    linux service
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base/mkdocs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mkdocs博客搭建
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base/sshfs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    sshfs命令
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base/tmux/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    tmux
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base/tar/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    tar命令
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    开发板
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            开发板
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    树莓派
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            树莓派
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../development-board/raspberry-pi/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    树莓派基础配置
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    源码工程
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            源码工程
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../source-code/personal-source-code-intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    个人源码工程简介
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    ExtFrameworks
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            ExtFrameworks
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../source-code/aosp-ext/fwk-ext/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    aosp frameworks扩展方案
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Android feature
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            Android feature
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../source-code/android-feature/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android Device Feature
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4" >
        
          
          <label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    As aosp
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4">
            <span class="md-nav__icon md-icon"></span>
            As aosp
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../source-code/as-aosp/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    as-aosp工程简介
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../source-code/as-aosp/first-configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    教程001-首次配置
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../source-code/as-aosp/design/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    教程002-设计思路
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../source-code/as-aosp/simple-extra/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    教程003-简单扩展
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../source-code/as-aosp/plugin-extra/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    教程004-插件扩展
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../source-code/as-aosp/jump-system-code/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    教程005-跳转系统源码[6.x版本默认跳转]
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../source-code/as-aosp/jump-aidl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    教程006-aidl跳转
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../source-code/as-aosp/jump-cpp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    教程007-c++跳转
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../source-code/as-aosp/jump-system-code-2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    教程008-跳转系统源码[进阶版]
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_5" >
        
          
          <label class="md-nav__link" for="__nav_5_5" id="__nav_5_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Global scripts
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_5">
            <span class="md-nav__icon md-icon"></span>
            Global scripts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../source-code/global-scripts/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    global_scripts工程简介
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      前言
    </span>
  </a>
  
    <nav class="md-nav" aria-label="前言">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      简介
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      工作模式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      工作原理
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#android" class="md-nav__link">
    <span class="md-ellipsis">
      Android实现
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Android实现">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      差异
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#se" class="md-nav__link">
    <span class="md-ellipsis">
      SE相关文件
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      语法
    </span>
  </a>
  
    <nav class="md-nav" aria-label="语法">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#type-statements" class="md-nav__link">
    <span class="md-ellipsis">
      Type Statements
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Type Statements">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#type" class="md-nav__link">
    <span class="md-ellipsis">
      type
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attribute" class="md-nav__link">
    <span class="md-ellipsis">
      attribute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#access-vector-rules" class="md-nav__link">
    <span class="md-ellipsis">
      Access Vector Rules
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Access Vector Rules">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#allow" class="md-nav__link">
    <span class="md-ellipsis">
      allow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#neverallow" class="md-nav__link">
    <span class="md-ellipsis">
      neverallow
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#android-se" class="md-nav__link">
    <span class="md-ellipsis">
      Android SE流程
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Android SE流程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#se_1" class="md-nav__link">
    <span class="md-ellipsis">
      SE加载流程
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SE加载流程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#first_stage_mainmain" class="md-nav__link">
    <span class="md-ellipsis">
      first_stage_main.main()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#first_stage_initfirststagemain" class="md-nav__link">
    <span class="md-ellipsis">
      first_stage_init.FirstStageMain()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mainmain" class="md-nav__link">
    <span class="md-ellipsis">
      main.main()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#selinuxsetupselinux" class="md-nav__link">
    <span class="md-ellipsis">
      selinux.SetupSelinux()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#selinuxreadpolicy" class="md-nav__link">
    <span class="md-ellipsis">
      selinux.ReadPolicy()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="selinux.ReadPolicy()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#selinuxopensplitpolicy" class="md-nav__link">
    <span class="md-ellipsis">
      selinux.OpenSplitPolicy()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#selinuxfindprecompiledsplitpolicy" class="md-nav__link">
    <span class="md-ellipsis">
      selinux.FindPrecompiledSplitPolicy()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#selinuxselinuxsetenforcement" class="md-nav__link">
    <span class="md-ellipsis">
      selinux.SelinuxSetEnforcement()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      总结
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pid" class="md-nav__link">
    <span class="md-ellipsis">
      设置应用pid流程
    </span>
  </a>
  
    <nav class="md-nav" aria-label="设置应用pid流程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#forkandspecialize" class="md-nav__link">
    <span class="md-ellipsis">
      forkAndSpecialize
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nativeforkandspecialize" class="md-nav__link">
    <span class="md-ellipsis">
      nativeForkAndSpecialize
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#specializecommon" class="md-nav__link">
    <span class="md-ellipsis">
      SpecializeCommon
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#selinux_android_setcontext" class="md-nav__link">
    <span class="md-ellipsis">
      selinux_android_setcontext
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#seapp_context_lookup" class="md-nav__link">
    <span class="md-ellipsis">
      seapp_context_lookup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#selinux_android_seapp_context_init" class="md-nav__link">
    <span class="md-ellipsis">
      selinux_android_seapp_context_init
    </span>
  </a>
  
    <nav class="md-nav" aria-label="selinux_android_seapp_context_init">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#seapp_context_init" class="md-nav__link">
    <span class="md-ellipsis">
      seapp_context_init
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#selinux_android_seapp_context_reload" class="md-nav__link">
    <span class="md-ellipsis">
      selinux_android_seapp_context_reload
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      疑问
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#java-seinfo" class="md-nav__link">
    <span class="md-ellipsis">
      Java seinfo
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Java seinfo">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#processinstallrequestsasync" class="md-nav__link">
    <span class="md-ellipsis">
      processInstallRequestsAsync
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installpackagestracedli" class="md-nav__link">
    <span class="md-ellipsis">
      installPackagesTracedLI
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installpackagesli" class="md-nav__link">
    <span class="md-ellipsis">
      installPackagesLI
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scanpackagetracedli" class="md-nav__link">
    <span class="md-ellipsis">
      scanPackageTracedLI
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scanpackageli" class="md-nav__link">
    <span class="md-ellipsis">
      scanPackageLI
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#addforinitli" class="md-nav__link">
    <span class="md-ellipsis">
      addForInitLI
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scanpackageonlyli" class="md-nav__link">
    <span class="md-ellipsis">
      scanPackageOnlyLI
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getseinfo" class="md-nav__link">
    <span class="md-ellipsis">
      getSeInfo
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xxx_mac_permissionsxml" class="md-nav__link">
    <span class="md-ellipsis">
      xxx_mac_permissions.xml
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      编译验证
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      辅助工具
    </span>
  </a>
  
    <nav class="md-nav" aria-label="辅助工具">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sys" class="md-nav__link">
    <span class="md-ellipsis">
      内核/sys/驱动节点
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#faq" class="md-nav__link">
    <span class="md-ellipsis">
      FAQ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FAQ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#security-context" class="md-nav__link">
    <span class="md-ellipsis">
      安全上下文(security context)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#file_contexts" class="md-nav__link">
    <span class="md-ellipsis">
      file_contexts 如何生效？
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-the-policies-built-through-the-intermediates-files" class="md-nav__link">
    <span class="md-ellipsis">
      Check the policies built through the intermediates files.
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-to-check-that-your-modifications-are-allowed" class="md-nav__link">
    <span class="md-ellipsis">
      How to check that your modifications are allowed？
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-to-disable-it" class="md-nav__link">
    <span class="md-ellipsis">
      How to disable it?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      如何在设备上默认打开或关闭？
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-to-createextend-a-policy" class="md-nav__link">
    <span class="md-ellipsis">
      How to create/extend a policy?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-to-custom-security-context-of-process" class="md-nav__link">
    <span class="md-ellipsis">
      How to custom Security Context of process?
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      万能公式
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reference" class="md-nav__link">
    <span class="md-ellipsis">
      Reference
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

<nav class="md-tags" >
  
    
    
      
      
    
    
      <span class="md-tag md-tag-icon">Android</span>
    
  
    
    
      
      
    
    
      <span class="md-tag md-tag-icon">SELinux</span>
    
  
</nav>


  
    <a href="https://github.com/i-rtfsc/note/edit/main/docs/Android/SELinux/Android SELinux介绍.md" title="编辑此页" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  


<h1>Android SELinux介绍</h1>

<h2 id="_1">前言<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>自Android L开始，Android全面启用了SELinux。本文旨在介绍SELinux背后的一些细节，Android的实现，此外还有创建，拓展，删除规则的不同选项。
本文会从语法、Android SE流程等详细介绍SELinux相关知识。如果读者不感兴趣，只想快速的解决某个进程缺少SELinux导致的错误，可以直接跳到“<strong>万能公式</strong>”这一节。</p>
<h3 id="_2">简介<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>SElinux是linux操作系统的一个MAC（mandatory access control）子系统。MAC不同于树枝的DAC（ discretionary access control）系统，它通过授权中心来决定是否有资格访问目标资源。
SElinux已经在LSM（Linux Security Module）框架中实现，它会识别各种内核组件，以及对这些组件的敏感操作。当执行一个操作时，会通过调用一个hook函数来确定当前操作是否被合法。hook函数由SELinux实现，SELinux基于自己的规则数据来确定当前操作的合法性。具体流程如下图所示：</p>
<p><img alt="" src="../../../Android/SELinux/res/se_linux_01.png" /></p>
<h3 id="_3">工作模式<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<ul>
<li>permissive：所有访问资源的操作都被允许（即没有MAC），但是如果有违反权限的话，会记录日志。</li>
<li>enforcing：所有访问资源的操作都会对其进行权限检查。</li>
</ul>
<h3 id="_4">工作原理<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>SELinux 的工作理念是用标签**（labels）<strong>来匹配各种操作和各种规则。SELinuxz中，Socket，文件以及进程都会被打上标签，然后基于用户对各种标签定义的访问规则来做出判断。
SELinux中，标签的格式为：**user:role:type:mls_level</strong>。其中，type段最为常用。
SELinux中，规则**（rules）<strong>的格式为：**allow domains types:classes permissions;</strong>。其中：</p>
<ul>
<li><strong>Domain</strong>：一个或一组进程的标签，理解为进程标签中的 type 部分。</li>
<li><strong>Type</strong>：一个或一组对象的标签，理解为非进程对象标签中的 type 部分。</li>
<li><strong>Class</strong>：表示对象的类型，理解：多个对象可以打上相同的标签，意味着文件，文件夹，sokcet等不同类型的文件都可能打上相同标签，所以需要class来区分不同类型。</li>
<li><strong>Permission</strong>：表示进程对对象执行的动作，比如 read，write等。</li>
</ul>
<p>示例：<strong>allow appdomain app_data_file:file rw_file_perms;</strong></p>
<h2 id="android">Android实现<a class="headerlink" href="#android" title="Permanent link">&para;</a></h2>
<p>Android的安全模型是建立在应用沙盒的概念上的，Android4.3之前，Android通过给不同应用分配不同uid来建立沙盒环境，4.3之后，Android引入了SELinux机制，为沙盒增加了新的边界。SEAndroid采用默认拒绝的策略，即默认情况下，系统进程无法访问任何对象，所有的访问需要被明确定义，以此增强Android的安全性。这意味着一个策略文件会包含大量的信息，包括规则（rules），类型（types），类别（classes），权限（permissions）等。</p>
<h3 id="_5">差异<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>与标准SELinux的差异主要是：Android针对其平台特性，增加了BInder IPC机制的相关SE策略，以此来控制Binder通信策略。相关patch如下：</p>
<ul>
<li><a href="https://android.googlesource.com/kernel/common/+/c76b9f83">https://android.googlesource.com/kernel/common/+/c76b9f83</a></li>
</ul>
<p>Android简化SE标签的使用，实际上，Android只用了其中两个部分：<em>role</em> 和 <em>type</em>，另外两个部分依然存在，不过被写死成 <code>u:role:type:s0</code>。<code>role</code>部分有两个取值分别为：</p>
<ul>
<li><em>r</em> ：domains (processes)</li>
<li><em>object_r</em> ：对象 objects.</li>
</ul>
<h3 id="se">SE相关文件<a class="headerlink" href="#se" title="Permanent link">&para;</a></h3>
<ul>
<li>***.te**：SE规则定义文件。该文件中定义域（domain）及其标签（label）。新增的<code>te</code>文件会与系统所有的 <code>te</code> 文件整合成一个单独的 SE 内核规则文件。</li>
<li><a href="http://boardconfig.mk/"><strong>BoardConfig.mk</strong></a>：引入额外存放SE规则定义目录的mk文件。SE规则文件可以存放到任意目录下，但需要在 <code>[BoardConfig.mk](http://boardconfig.mk/)</code> 中引入对应目录方可生效。</li>
<li><strong>file_contexts</strong>：系统中各文件贴标签处。用于为文件分配标签，被各种用户空间的组件使用。当创建新的 <code>te</code> 文件来定义新类型时，需要修改（或新建）<code>file_contexts</code> 文件使新建的类型得以生效。修改 <code>file_contexts</code> 后需要重编ROM使之生效。</li>
<li><strong>genfs_contexts</strong>： 系统中各种特殊文件（例如，<code>proc</code> 或 <code>vfat</code>）贴标签处。该配置会作为内核SE规则的一部分进行加载。</li>
<li><strong>property_contexts</strong>： Android 系统属性贴标签处。以此控制进程对属性的访问。在启动期间，<code>init</code> 进程会读取此配置。</li>
<li><strong>service_contexts</strong>： Android Binder 服务贴标签处。以此控制进程添加（register）和查找（lookup）Binder 引用。在启动期间，<code>servicemanager</code> 进程会读取此配置。</li>
<li><strong>seapp_contexts</strong>： 应用进程和 <code>/data/data</code> 目录贴标签处。在每次应用启动时，<code>zygote</code> 进程据此确定应用的SE标签；<code>installd</code> 据此确定 <code>/data/data</code> 的SE标签。</li>
<li><strong>mac_permissions.xml</strong>：根据应用签名和应用软件包名称（optionally）为应用分配 <code>seinfo</code> 标记。<code>seapp_contexts</code> 文件会根据 <code>seinfo</code> 标记为应用分配特定标签。在启动期间，<code>system_server</code> 会读取此配置。</li>
</ul>
<h2 id="_6">语法<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<p>SE相关的语法大致可以分为如下几类：</p>
<ul>
<li><a href="https://selinuxproject.org/page/Policy_Configuration_Statements">Policy Configuration Statements</a></li>
<li><a href="https://selinuxproject.org/page/DefaultRules">Default Rules</a></li>
<li><a href="https://selinuxproject.org/page/UserStatements">User Statements</a></li>
<li><a href="https://selinuxproject.org/page/RoleStatements">Role Statements</a></li>
<li><a href="https://selinuxproject.org/page/TypeStatements">Type Statements</a></li>
<li><a href="https://selinuxproject.org/page/Bounds_Rules">Bounds Rules</a></li>
<li><a href="https://selinuxproject.org/page/AVCRules">Access Vector Rules</a></li>
<li><a href="https://selinuxproject.org/page/XpermRules">Extended Permission Access Vector Rules</a></li>
<li><a href="https://selinuxproject.org/page/ObjectClassStatements">Object Class and Permission Statements</a></li>
<li><a href="https://selinuxproject.org/page/ConditionalStatements">Conditional Policy Statements</a></li>
<li><a href="https://selinuxproject.org/page/ConstraintStatements">Constraint Statements</a></li>
<li><a href="https://selinuxproject.org/page/MLSStatements">MLS Statements</a></li>
<li><a href="https://selinuxproject.org/page/SIDStatements">Security ID (SID) Statement</a></li>
<li><a href="https://selinuxproject.org/page/FileStatements">File System Labeling Statements</a></li>
<li><a href="https://selinuxproject.org/page/NetworkStatements">Network Labeling Statements</a></li>
<li><a href="https://selinuxproject.org/page/PolicyStatements">Modular Policy Support Statements</a></li>
<li><a href="https://selinuxproject.org/page/XENStatements">XEN Statements</a></li>
</ul>
<p>本文只列出几个常用的语法，其他语法自查上述连接。</p>
<h3 id="type-statements">Type Statements<a class="headerlink" href="#type-statements" title="Permanent link">&para;</a></h3>
<h4 id="type">type<a class="headerlink" href="#type" title="Permanent link">&para;</a></h4>
<p>在使用类型前，必须使用type语句明确地声明一个类型标识符，SELinux没有预定义类型，我们必须自行声明，声明了类型后就可以在安全上下文、TE规则和其它策略语句中使用它们了。</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="err">##</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="n">类型名称</span><span class="w"> </span><span class="o">[</span><span class="n">alias</span><span class="w"> </span><span class="n">别名集</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="p">,</span><span class="n">属性集</span><span class="o">]</span><span class="p">;</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="err">##</span><span class="w"> </span><span class="n">别名集</span><span class="err">：</span><span class="n">即异名同意</span><span class="err">。</span><span class="n">如果指定的不止一个别名标识符</span><span class="err">，</span><span class="n">要在一对大括号中用空格将各个别名区别开来</span><span class="err">，</span><span class="n">如</span><span class="err">：</span><span class="n">alias</span><span class="w"> </span><span class="p">{</span><span class="n">aliasa_t</span><span class="w"> </span><span class="n">aliasb_t</span><span class="p">}</span><span class="err">。</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="err">##</span><span class="w"> </span><span class="n">属性集</span><span class="err">：</span><span class="n">赋予该type定义的属性之中</span><span class="err">。</span><span class="n">是一个或多个预先声明的属性标识符</span><span class="err">，</span><span class="n">如果同时指定多个属性标识符</span><span class="err">，</span><span class="n">属性之间使用逗号进行分隔</span><span class="err">，</span><span class="n">如</span><span class="err">：</span><span class="n">type</span><span class="w"> </span><span class="n">bin_t</span><span class="p">,</span><span class="w"> </span><span class="n">file_type</span><span class="p">,</span><span class="w"> </span><span class="n">exec_type</span><span class="p">;</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="n">type</span><span class="w"> </span><span class="n">type_id</span><span class="w"> </span><span class="o">[</span><span class="n">alias</span><span class="w"> </span><span class="n">alias_id</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="p">,</span><span class="w"> </span><span class="n">attribute_id</span><span class="o">]</span><span class="p">;</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="err">##</span><span class="w"> </span><span class="n">type</span><span class="w">            </span><span class="n">The</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="n">keyword</span><span class="p">.</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="err">##</span><span class="w"> </span><span class="n">type_id</span><span class="w">         </span><span class="n">The</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="n">identifier</span><span class="p">.</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="err">##</span><span class="w"> </span><span class="n">alias</span><span class="w">           </span><span class="n">Optional</span><span class="w"> </span><span class="n">alias</span><span class="w"> </span><span class="n">keyword</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">signifies</span><span class="w"> </span><span class="n">alternate</span><span class="w"> </span><span class="n">identifiers</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">type_id</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">declared</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">alias_id</span><span class="w"> </span><span class="n">list</span><span class="p">.</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="err">##</span><span class="w"> </span><span class="n">alias_id</span><span class="w">        </span><span class="n">One</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">alias</span><span class="w"> </span><span class="n">identifiers</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">been</span><span class="w"> </span><span class="n">previously</span><span class="w"> </span><span class="n">declared</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="o">[</span><span class="n">typealias</span><span class="o">]</span><span class="p">(</span><span class="n">https</span><span class="p">:</span><span class="c1">//selinuxproject.org/page/TypeStatements#typealias) statement.</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="err">##</span><span class="w">                 </span><span class="n">Multiple</span><span class="w"> </span><span class="n">entries</span><span class="w"> </span><span class="n">consist</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">space</span><span class="w"> </span><span class="n">separated</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">enclosed</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nf">braces</span><span class="w"> </span><span class="p">({}).</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="err">##</span><span class="w"> </span><span class="n">attribute_id</span><span class="w">    </span><span class="n">One</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">optional</span><span class="w"> </span><span class="n">attribute</span><span class="w"> </span><span class="n">identifiers</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">been</span><span class="w"> </span><span class="n">previously</span><span class="w"> </span><span class="n">declared</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="o">[</span><span class="n">attribute</span><span class="o">]</span><span class="p">(</span><span class="n">https</span><span class="p">:</span><span class="c1">//selinuxproject.org/page/TypeStatements#attribute)</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="err">##</span><span class="w">                 </span><span class="n">statement</span><span class="p">.</span><span class="w"> </span><span class="n">Multiple</span><span class="w"> </span><span class="n">entries</span><span class="w"> </span><span class="n">consist</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="nf">comma</span><span class="w"> </span><span class="p">(,)</span><span class="w"> </span><span class="n">separated</span><span class="w"> </span><span class="n">list</span><span class="p">,</span><span class="w"> </span><span class="n">also</span><span class="w"> </span><span class="n">note</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">lead</span><span class="w"> </span><span class="n">comma</span><span class="p">.</span>
</span></code></pre></div>
<p>例子:</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="err">##</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="n">statement</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">declare</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">shell_exec_t</span><span class="p">,</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="err">##</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="n">exec_t</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">identify</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">executable</span><span class="w"> </span><span class="n">type</span><span class="p">.</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="n">type</span><span class="w"> </span><span class="n">shell_exec_t</span><span class="p">;</span>
</span></code></pre></div>
<div class="language-java highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="err">##</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="n">statement</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">declare</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="n">of</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="err">##</span><span class="w"> </span><span class="n">ssh_server_packet_t</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">also</span><span class="w"> </span><span class="n">associates</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">two</span><span class="w"> </span><span class="n">previously</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="err">##</span><span class="w"> </span><span class="n">declared</span><span class="w"> </span><span class="n">attributes</span><span class="w"> </span><span class="n">packet_type</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">server_packet_type</span><span class="p">.</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="n">attribute</span><span class="w"> </span><span class="n">packet_type</span><span class="p">;</span><span class="w">        </span><span class="err">##</span><span class="w"> </span><span class="n">declare</span><span class="w"> </span><span class="n">attribute</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="n">attribute</span><span class="w"> </span><span class="n">server_packet_type</span><span class="p">;</span><span class="w"> </span><span class="err">##</span><span class="w"> </span><span class="n">declare</span><span class="w"> </span><span class="n">attribute</span><span class="w"> </span><span class="mi">2</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="err">##</span><span class="w"> </span><span class="n">Associate</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="n">identifier</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">two</span><span class="w"> </span><span class="n">attributes</span><span class="p">:</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="n">type</span><span class="w"> </span><span class="n">ssh_server_packet_t</span><span class="p">,</span><span class="w"> </span><span class="n">packet_type</span><span class="p">,</span><span class="w"> </span><span class="n">server_packet_type</span><span class="p">;</span>
</span></code></pre></div>
<h4 id="attribute">attribute<a class="headerlink" href="#attribute" title="Permanent link">&para;</a></h4>
<p>由于SELinux的默认的规则是拒绝所有的访问，所以任何一个访问都需要有一个规则定义与之匹配。Android中的type好几百，逐个定义耗时巨大，所以引入属性，可以将一个属性赋予多个type，以此达到批量定义规则的目的。
<div class="language-java highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="err">##</span><span class="w"> </span><span class="n">attribute</span><span class="w"> </span><span class="n">属性名称</span><span class="p">;</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="n">attribute</span><span class="w"> </span><span class="n">attribute_id</span><span class="p">;</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="err">##</span><span class="w"> </span><span class="n">attribute</span><span class="w">       </span><span class="n">The</span><span class="w"> </span><span class="n">attribute</span><span class="w"> </span><span class="n">keyword</span><span class="p">.</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="err">##</span><span class="w"> </span><span class="n">attribute_id</span><span class="w">    </span><span class="n">The</span><span class="w"> </span><span class="n">attribute</span><span class="w"> </span><span class="n">identifier</span><span class="p">.</span>
</span></code></pre></div></p>
<p>例子:</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="err">##</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">attribute</span><span class="w"> </span><span class="n">statement</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">declare</span><span class="w"> </span><span class="n">attributes</span><span class="w"> </span><span class="n">domain</span><span class="p">,</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="err">##</span><span class="w"> </span><span class="n">daemon</span><span class="p">,</span><span class="w"> </span><span class="n">file_type</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">non_security_file_type</span><span class="p">:</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="n">attribute</span><span class="w"> </span><span class="n">domain</span><span class="p">;</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="n">attribute</span><span class="w"> </span><span class="n">daemon</span><span class="p">;</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="n">attribute</span><span class="w"> </span><span class="n">file_type</span><span class="p">;</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="n">attribute</span><span class="w"> </span><span class="n">non_security_file_type</span><span class="p">;</span>
</span></code></pre></div>
<h3 id="access-vector-rules"><a href="https://selinuxproject.org/page/AVCRules">Access Vector Rules</a><a class="headerlink" href="#access-vector-rules" title="Permanent link">&para;</a></h3>
<p>The common format of the Access Vector Rule is:</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="n">rule_name</span><span class="w"> </span><span class="n">source_type</span><span class="w"> </span><span class="n">target_type</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kd">class</span> <span class="nc">perm_set</span><span class="p">;</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="err">##</span><span class="w"> </span><span class="n">rule_name</span><span class="w">                </span><span class="n">The</span><span class="w"> </span><span class="n">applicable</span><span class="w"> </span><span class="n">allow</span><span class="p">,</span><span class="w"> </span><span class="n">dontaudit</span><span class="p">,</span><span class="w"> </span><span class="n">auditallow</span><span class="p">,</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">neverallow</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="n">keyword</span><span class="p">.</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="err">#</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="err">##</span><span class="w"> </span><span class="n">source_type</span><span class="o">/</span><span class="n">target_type</span><span class="w">  </span><span class="n">One</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">source</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">typealias</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">attribute</span><span class="w"> </span><span class="n">identifiers</span><span class="p">.</span><span class="w"> </span><span class="n">Multiple</span><span class="w"> </span><span class="n">entries</span><span class="w"> </span><span class="n">consist</span><span class="w"> </span><span class="n">of</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="err">##</span><span class="w">                          </span><span class="n">a</span><span class="w"> </span><span class="n">space</span><span class="w"> </span><span class="n">separated</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">enclosed</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nf">braces</span><span class="w"> </span><span class="p">({}).</span><span class="w"> </span><span class="n">Entries</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">excluded</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">using</span><span class="w"> </span><span class="n">the</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="err">##</span><span class="w">                          </span><span class="n">negative</span><span class="w"> </span><span class="nf">operator</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="p">).</span><span class="na">The</span><span class="w"> </span><span class="n">target_type</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">self</span><span class="w"> </span><span class="n">keyword</span><span class="w"> </span><span class="n">instead</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">typealias</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">attribute</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="err">##</span><span class="w">                          </span><span class="n">identifiers</span><span class="p">.</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">means</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">target_type</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">same</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">source_type</span><span class="p">.</span><span class="na">The</span><span class="w"> </span><span class="n">neverallow</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="n">also</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="err">##</span><span class="w">                          </span><span class="n">supports</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">wildcard</span><span class="w"> </span><span class="nf">operator</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">specify</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">types</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">included</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">complement</span><span class="w"> </span><span class="nf">operator</span><span class="w"> </span><span class="p">(</span><span class="o">~</span><span class="p">)</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="err">##</span><span class="w">                          </span><span class="n">to</span><span class="w"> </span><span class="n">specify</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">types</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">included</span><span class="w"> </span><span class="n">except</span><span class="w"> </span><span class="n">those</span><span class="w"> </span><span class="n">explicitly</span><span class="w"> </span><span class="n">listed</span><span class="p">.</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="err">#</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="err">##</span><span class="w"> </span><span class="kd">class</span>                    <span class="nc">One</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="n">classes</span><span class="p">.</span><span class="w"> </span><span class="n">Multiple</span><span class="w"> </span><span class="n">entries</span><span class="w"> </span><span class="n">consist</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">space</span><span class="w"> </span><span class="n">separated</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">enclosed</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nf">braces</span><span class="w"> </span><span class="p">({}).</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="err">#</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="err">##</span><span class="w"> </span><span class="n">perm_set</span><span class="w">                 </span><span class="n">The</span><span class="w"> </span><span class="n">access</span><span class="w"> </span><span class="n">permissions</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">source</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">allowed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">access</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="nf">object</span><span class="w"> </span><span class="p">(</span><span class="n">also</span><span class="w"> </span><span class="n">known</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">Acess</span><span class="w"> </span><span class="n">Vector</span><span class="p">).</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="err">##</span><span class="w">                          </span><span class="n">Multiple</span><span class="w"> </span><span class="n">entries</span><span class="w"> </span><span class="n">consist</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">space</span><span class="w"> </span><span class="n">separated</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">enclosed</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nf">braces</span><span class="w"> </span><span class="p">({}).</span><span class="na">The</span><span class="w"> </span><span class="n">optional</span><span class="w"> </span><span class="n">wildcard</span><span class="w"> </span><span class="nf">operator</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="err">##</span><span class="w">                          </span><span class="n">specifies</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">permissions</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="kd">class</span> <span class="nc">can</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">used</span><span class="p">.</span><span class="na">The</span><span class="w"> </span><span class="n">complement</span><span class="w"> </span><span class="nf">operator</span><span class="w"> </span><span class="p">(</span><span class="o">~</span><span class="p">)</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">specify</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="err">##</span><span class="w">                          </span><span class="n">all</span><span class="w"> </span><span class="n">permissions</span><span class="w"> </span><span class="n">except</span><span class="w"> </span><span class="n">those</span><span class="w"> </span><span class="n">explicitly</span><span class="w"> </span><span class="nf">listed</span><span class="w"> </span><span class="p">(</span><span class="n">although</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">compiler</span><span class="w"> </span><span class="n">issues</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">warning</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">dontaudit</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="sc">&#39;~&#39;</span><span class="p">).</span>
</span></code></pre></div>
<h4 id="allow">allow<a class="headerlink" href="#allow" title="Permanent link">&para;</a></h4>
<p>allow规则检查定义进程是否有权访问某个系统资源。</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="err">##</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">allow</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">initrc_t</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">allowed</span><span class="w"> </span><span class="n">access</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="err">##</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">files</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="n">acct_exec_t</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">getattr</span><span class="p">,</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="n">and</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="err">##</span><span class="w"> </span><span class="n">execute</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">permissions</span><span class="p">:</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="n">allow</span><span class="w"> </span><span class="n">initrc_t</span><span class="w"> </span><span class="n">acct_exec_t</span><span class="p">:</span><span class="n">file</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">getattr</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="n">execute</span><span class="w"> </span><span class="p">};</span>
</span></code></pre></div>
<h4 id="neverallow">neverallow<a class="headerlink" href="#neverallow" title="Permanent link">&para;</a></h4>
<p>该规则指定即使该操作先前已被允许，也不能为该操作生成允许规则。 neverallow语句是编译器强制执行的操作，其中checkpolicy或checkmodule [1]编译器检查策略源中是否已生成任何允许规则，如果是，它将发出警告并停止。</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="err">##</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">neverallow</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">allow</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">ever</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="err">##</span><span class="w"> </span><span class="n">grant</span><span class="w"> </span><span class="n">any</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="n">access</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="n">shadow_t</span><span class="w"> </span><span class="n">except</span><span class="w"> </span><span class="n">those</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="err">##</span><span class="w"> </span><span class="n">associated</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">can_read_shadow_passwords</span><span class="w"> </span><span class="n">attribute</span><span class="p">:</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="n">neverallow</span><span class="w"> </span><span class="o">~</span><span class="n">can_read_shadow_passwords</span><span class="w"> </span><span class="n">shadow_t</span><span class="p">:</span><span class="n">file</span><span class="w"> </span><span class="n">read</span><span class="p">;</span>
</span></code></pre></div>
<h2 id="android-se">Android SE流程<a class="headerlink" href="#android-se" title="Permanent link">&para;</a></h2>
<h3 id="se_1">SE加载流程<a class="headerlink" href="#se_1" title="Permanent link">&para;</a></h3>
<h4 id="first_stage_mainmain">first_stage_main.main()<a class="headerlink" href="#first_stage_mainmain" title="Permanent link">&para;</a></h4>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="nl">http</span><span class="p">:</span><span class="c1">//aospxref.com/android-12.0.0_r3/xref/system/core/init/first_stage_main.cpp</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;first_stage_init.h&quot;</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">argv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">android</span><span class="o">::</span><span class="n">init</span><span class="o">::</span><span class="n">FirstStageMain</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="first_stage_initfirststagemain">first_stage_init.FirstStageMain()<a class="headerlink" href="#first_stage_initfirststagemain" title="Permanent link">&para;</a></h4>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="nl">http</span><span class="p">:</span><span class="c1">//aospxref.com/android-12.0.0_r3/xref/system/core/init/first_stage_init.cpp</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="kt">int</span><span class="w"> </span><span class="nf">FirstStageMain</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">argv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/system/bin/init&quot;</span><span class="p">;</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;selinux_setup&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">};</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="w">    </span><span class="n">execv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="k">const_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">**&gt;</span><span class="p">(</span><span class="n">args</span><span class="p">));</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="mainmain">main.main()<a class="headerlink" href="#mainmain" title="Permanent link">&para;</a></h4>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="nl">http</span><span class="p">:</span><span class="c1">//aospxref.com/android-12.0.0_r3/xref/system/core/init/main.cpp</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">argv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">        </span><span class="p">...</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;selinux_setup&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">SetupSelinux</span><span class="p">(</span><span class="n">argv</span><span class="p">);</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="w">        </span><span class="p">...</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="selinuxsetupselinux">selinux.SetupSelinux()<a class="headerlink" href="#selinuxsetupselinux" title="Permanent link">&para;</a></h4>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="nl">http</span><span class="p">:</span><span class="c1">//aospxref.com/android-12.0.0_r3/xref/system/core/init/selinux.cpp</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="c1">// The SELinux setup process is carefully orchestrated around snapuserd. Policy</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="c1">// must be loaded off dynamic partitions, and during an OTA, those partitions</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="c1">// cannot be read without snapuserd. But, with kernel-privileged snapuserd</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="c1">// running, loading the policy will immediately trigger audits.</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="c1">//</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="c1">// We use a five-step process to address this:</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="c1">//  (1) Read the policy into a string, with snapuserd running.</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="c1">//  (2) Rewrite the snapshot device-mapper tables, to generate new dm-user</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="c1">//      devices and to flush I/O.</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="c1">//  (3) Kill snapuserd, which no longer has any dm-user devices to attach to.</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="c1">//  (4) Load the sepolicy and issue critical restorecons in /dev, carefully</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a><span class="c1">//      avoiding anything that would read from /system.</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="c1">//  (5) Re-launch snapuserd and attach it to the dm-user devices from step (2).</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a><span class="c1">//</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="c1">// After this sequence, it is safe to enable enforcing mode and continue booting.</span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a><span class="kt">int</span><span class="w"> </span><span class="nf">SetupSelinux</span><span class="p">(</span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">argv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a><span class="w">    </span><span class="c1">// Read the policy before potentially killing snapuserd.</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">policy</span><span class="p">;</span>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a><span class="w">    </span><span class="n">ReadPolicy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">policy</span><span class="p">);</span>
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a>
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a>
</span><span id="__span-11-27"><a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a><span class="w">    </span><span class="n">LoadSelinuxPolicy</span><span class="p">(</span><span class="n">policy</span><span class="p">);</span>
</span><span id="__span-11-28"><a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a>
</span><span id="__span-11-29"><a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">snapuserd_helper</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-30"><a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a><span class="w">        </span><span class="c1">// Before enforcing, finish the pending snapuserd transition.</span>
</span><span id="__span-11-31"><a id="__codelineno-11-31" name="__codelineno-11-31" href="#__codelineno-11-31"></a><span class="w">        </span><span class="n">snapuserd_helper</span><span class="o">-&gt;</span><span class="n">FinishTransition</span><span class="p">();</span>
</span><span id="__span-11-32"><a id="__codelineno-11-32" name="__codelineno-11-32" href="#__codelineno-11-32"></a><span class="w">        </span><span class="n">snapuserd_helper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
</span><span id="__span-11-33"><a id="__codelineno-11-33" name="__codelineno-11-33" href="#__codelineno-11-33"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-11-34"><a id="__codelineno-11-34" name="__codelineno-11-34" href="#__codelineno-11-34"></a>
</span><span id="__span-11-35"><a id="__codelineno-11-35" name="__codelineno-11-35" href="#__codelineno-11-35"></a><span class="w">    </span><span class="n">SelinuxSetEnforcement</span><span class="p">();</span>
</span><span id="__span-11-36"><a id="__codelineno-11-36" name="__codelineno-11-36" href="#__codelineno-11-36"></a>
</span><span id="__span-11-37"><a id="__codelineno-11-37" name="__codelineno-11-37" href="#__codelineno-11-37"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-11-38"><a id="__codelineno-11-38" name="__codelineno-11-38" href="#__codelineno-11-38"></a>
</span><span id="__span-11-39"><a id="__codelineno-11-39" name="__codelineno-11-39" href="#__codelineno-11-39"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/system/bin/init&quot;</span><span class="p">;</span>
</span><span id="__span-11-40"><a id="__codelineno-11-40" name="__codelineno-11-40" href="#__codelineno-11-40"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">args</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;second_stage&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">};</span>
</span><span id="__span-11-41"><a id="__codelineno-11-41" name="__codelineno-11-41" href="#__codelineno-11-41"></a><span class="w">    </span><span class="n">execv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="k">const_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">**&gt;</span><span class="p">(</span><span class="n">args</span><span class="p">));</span>
</span><span id="__span-11-42"><a id="__codelineno-11-42" name="__codelineno-11-42" href="#__codelineno-11-42"></a>
</span><span id="__span-11-43"><a id="__codelineno-11-43" name="__codelineno-11-43" href="#__codelineno-11-43"></a><span class="w">    </span><span class="c1">// execv() only returns if an error happened, in which case we</span>
</span><span id="__span-11-44"><a id="__codelineno-11-44" name="__codelineno-11-44" href="#__codelineno-11-44"></a><span class="w">    </span><span class="c1">// panic and never return from this function.</span>
</span><span id="__span-11-45"><a id="__codelineno-11-45" name="__codelineno-11-45" href="#__codelineno-11-45"></a><span class="w">    </span><span class="n">PLOG</span><span class="p">(</span><span class="n">FATAL</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;execv(</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">) failed&quot;</span><span class="p">;</span>
</span><span id="__span-11-46"><a id="__codelineno-11-46" name="__codelineno-11-46" href="#__codelineno-11-46"></a>
</span><span id="__span-11-47"><a id="__codelineno-11-47" name="__codelineno-11-47" href="#__codelineno-11-47"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-11-48"><a id="__codelineno-11-48" name="__codelineno-11-48" href="#__codelineno-11-48"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="selinuxreadpolicy">selinux.ReadPolicy()<a class="headerlink" href="#selinuxreadpolicy" title="Permanent link">&para;</a></h4>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="nl">http</span><span class="p">:</span><span class="c1">//aospxref.com/android-12.0.0_r3/xref/system/core/init/selinux.cpp</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="kt">void</span><span class="w"> </span><span class="nf">ReadPolicy</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span><span class="w"> </span><span class="n">policy</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">    </span><span class="n">PolicyFile</span><span class="w"> </span><span class="n">policy_file</span><span class="p">;</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">    </span><span class="c1">//IsSplitPolicyDevice()为true</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IsSplitPolicyDevice</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">OpenSplitPolicy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">policy_file</span><span class="p">)</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="w">                                    </span><span class="o">:</span><span class="w"> </span><span class="n">OpenMonolithicPolicy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">policy_file</span><span class="p">);</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="w">        </span><span class="n">LOG</span><span class="p">(</span><span class="n">FATAL</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Unable to open SELinux policy&quot;</span><span class="p">;</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">android</span><span class="o">::</span><span class="n">base</span><span class="o">::</span><span class="n">ReadFdToString</span><span class="p">(</span><span class="n">policy_file</span><span class="p">.</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">policy</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="w">        </span><span class="n">PLOG</span><span class="p">(</span><span class="n">FATAL</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Failed to read policy file: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">policy_file</span><span class="p">.</span><span class="n">path</span><span class="p">;</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a><span class="p">}</span>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a><span class="k">constexpr</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">plat_policy_cil_file</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/system/etc/selinux/plat_sepolicy.cil&quot;</span><span class="p">;</span>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a><span class="kt">bool</span><span class="w"> </span><span class="nf">IsSplitPolicyDevice</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">access</span><span class="p">(</span><span class="n">plat_policy_cil_file</span><span class="p">,</span><span class="w"> </span><span class="n">R_OK</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a><span class="p">}</span>
</span></code></pre></div>
<h5 id="selinuxopensplitpolicy">selinux.OpenSplitPolicy()<a class="headerlink" href="#selinuxopensplitpolicy" title="Permanent link">&para;</a></h5>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="nl">http</span><span class="p">:</span><span class="c1">//aospxref.com/android-12.0.0_r3/xref/system/core/init/selinux.cpp</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="kt">bool</span><span class="w"> </span><span class="nf">OpenSplitPolicy</span><span class="p">(</span><span class="n">PolicyFile</span><span class="o">*</span><span class="w"> </span><span class="n">policy_file</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">use_userdebug_policy</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FindPrecompiledSplitPolicy</span><span class="p">();</span><span class="w"> </span><span class="n">res</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="w">            </span><span class="n">unique_fd</span><span class="w"> </span><span class="n">fd</span><span class="p">(</span><span class="n">open</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">O_RDONLY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">O_CLOEXEC</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">O_BINARY</span><span class="p">));</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="w">                </span><span class="n">policy_file</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="w">                </span><span class="n">policy_file</span><span class="o">-&gt;</span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">);</span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a><span class="w">            </span><span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">res</span><span class="p">.</span><span class="n">error</span><span class="p">();</span>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a>
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a><span class="w">    </span><span class="c1">// Determine which mapping file to include</span>
</span><span id="__span-13-22"><a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a><span class="w">    </span><span class="c1">// Determine which mapping file to include</span>
</span><span id="__span-13-23"><a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">vend_plat_vers</span><span class="p">;</span>
</span><span id="__span-13-24"><a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">GetVendorMappingVersion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vend_plat_vers</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-25"><a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
</span><span id="__span-13-26"><a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-27"><a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">plat_mapping_file</span><span class="p">(</span><span class="s">&quot;/system/etc/selinux/mapping/&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">vend_plat_vers</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;.cil&quot;</span><span class="p">);</span>
</span><span id="__span-13-28"><a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a>
</span><span id="__span-13-29"><a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">plat_compat_cil_file</span><span class="p">(</span><span class="s">&quot;/system/etc/selinux/mapping/&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">vend_plat_vers</span><span class="w"> </span><span class="o">+</span>
</span><span id="__span-13-30"><a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a><span class="w">                                     </span><span class="s">&quot;.compat.cil&quot;</span><span class="p">);</span>
</span><span id="__span-13-31"><a id="__codelineno-13-31" name="__codelineno-13-31" href="#__codelineno-13-31"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">plat_compat_cil_file</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">F_OK</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-32"><a id="__codelineno-13-32" name="__codelineno-13-32" href="#__codelineno-13-32"></a><span class="w">        </span><span class="n">plat_compat_cil_file</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span><span id="__span-13-33"><a id="__codelineno-13-33" name="__codelineno-13-33" href="#__codelineno-13-33"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-34"><a id="__codelineno-13-34" name="__codelineno-13-34" href="#__codelineno-13-34"></a>
</span><span id="__span-13-35"><a id="__codelineno-13-35" name="__codelineno-13-35" href="#__codelineno-13-35"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">system_ext_policy_cil_file</span><span class="p">(</span><span class="s">&quot;/system_ext/etc/selinux/system_ext_sepolicy.cil&quot;</span><span class="p">);</span>
</span><span id="__span-13-36"><a id="__codelineno-13-36" name="__codelineno-13-36" href="#__codelineno-13-36"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">system_ext_policy_cil_file</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">F_OK</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-37"><a id="__codelineno-13-37" name="__codelineno-13-37" href="#__codelineno-13-37"></a><span class="w">        </span><span class="n">system_ext_policy_cil_file</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span><span id="__span-13-38"><a id="__codelineno-13-38" name="__codelineno-13-38" href="#__codelineno-13-38"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-39"><a id="__codelineno-13-39" name="__codelineno-13-39" href="#__codelineno-13-39"></a>
</span><span id="__span-13-40"><a id="__codelineno-13-40" name="__codelineno-13-40" href="#__codelineno-13-40"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">system_ext_mapping_file</span><span class="p">(</span><span class="s">&quot;/system_ext/etc/selinux/mapping/&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">vend_plat_vers</span><span class="w"> </span><span class="o">+</span>
</span><span id="__span-13-41"><a id="__codelineno-13-41" name="__codelineno-13-41" href="#__codelineno-13-41"></a><span class="w">                                        </span><span class="s">&quot;.cil&quot;</span><span class="p">);</span>
</span><span id="__span-13-42"><a id="__codelineno-13-42" name="__codelineno-13-42" href="#__codelineno-13-42"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">system_ext_mapping_file</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">F_OK</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-43"><a id="__codelineno-13-43" name="__codelineno-13-43" href="#__codelineno-13-43"></a><span class="w">        </span><span class="n">system_ext_mapping_file</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span><span id="__span-13-44"><a id="__codelineno-13-44" name="__codelineno-13-44" href="#__codelineno-13-44"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-45"><a id="__codelineno-13-45" name="__codelineno-13-45" href="#__codelineno-13-45"></a>
</span><span id="__span-13-46"><a id="__codelineno-13-46" name="__codelineno-13-46" href="#__codelineno-13-46"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">system_ext_compat_cil_file</span><span class="p">(</span><span class="s">&quot;/system_ext/etc/selinux/mapping/&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">vend_plat_vers</span><span class="w"> </span><span class="o">+</span>
</span><span id="__span-13-47"><a id="__codelineno-13-47" name="__codelineno-13-47" href="#__codelineno-13-47"></a><span class="w">                                           </span><span class="s">&quot;.compat.cil&quot;</span><span class="p">);</span>
</span><span id="__span-13-48"><a id="__codelineno-13-48" name="__codelineno-13-48" href="#__codelineno-13-48"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">system_ext_compat_cil_file</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">F_OK</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-49"><a id="__codelineno-13-49" name="__codelineno-13-49" href="#__codelineno-13-49"></a><span class="w">        </span><span class="n">system_ext_compat_cil_file</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span><span id="__span-13-50"><a id="__codelineno-13-50" name="__codelineno-13-50" href="#__codelineno-13-50"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-51"><a id="__codelineno-13-51" name="__codelineno-13-51" href="#__codelineno-13-51"></a>
</span><span id="__span-13-52"><a id="__codelineno-13-52" name="__codelineno-13-52" href="#__codelineno-13-52"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">product_policy_cil_file</span><span class="p">(</span><span class="s">&quot;/product/etc/selinux/product_sepolicy.cil&quot;</span><span class="p">);</span>
</span><span id="__span-13-53"><a id="__codelineno-13-53" name="__codelineno-13-53" href="#__codelineno-13-53"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">product_policy_cil_file</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">F_OK</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-54"><a id="__codelineno-13-54" name="__codelineno-13-54" href="#__codelineno-13-54"></a><span class="w">        </span><span class="n">product_policy_cil_file</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span><span id="__span-13-55"><a id="__codelineno-13-55" name="__codelineno-13-55" href="#__codelineno-13-55"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-56"><a id="__codelineno-13-56" name="__codelineno-13-56" href="#__codelineno-13-56"></a>
</span><span id="__span-13-57"><a id="__codelineno-13-57" name="__codelineno-13-57" href="#__codelineno-13-57"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">product_mapping_file</span><span class="p">(</span><span class="s">&quot;/product/etc/selinux/mapping/&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">vend_plat_vers</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;.cil&quot;</span><span class="p">);</span>
</span><span id="__span-13-58"><a id="__codelineno-13-58" name="__codelineno-13-58" href="#__codelineno-13-58"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">product_mapping_file</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">F_OK</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-59"><a id="__codelineno-13-59" name="__codelineno-13-59" href="#__codelineno-13-59"></a><span class="w">        </span><span class="n">product_mapping_file</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span><span id="__span-13-60"><a id="__codelineno-13-60" name="__codelineno-13-60" href="#__codelineno-13-60"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-61"><a id="__codelineno-13-61" name="__codelineno-13-61" href="#__codelineno-13-61"></a>
</span><span id="__span-13-62"><a id="__codelineno-13-62" name="__codelineno-13-62" href="#__codelineno-13-62"></a><span class="w">    </span><span class="c1">// vendor_sepolicy.cil and plat_pub_versioned.cil are the new design to replace</span>
</span><span id="__span-13-63"><a id="__codelineno-13-63" name="__codelineno-13-63" href="#__codelineno-13-63"></a><span class="w">    </span><span class="c1">// nonplat_sepolicy.cil.</span>
</span><span id="__span-13-64"><a id="__codelineno-13-64" name="__codelineno-13-64" href="#__codelineno-13-64"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">plat_pub_versioned_cil_file</span><span class="p">(</span><span class="s">&quot;/vendor/etc/selinux/plat_pub_versioned.cil&quot;</span><span class="p">);</span>
</span><span id="__span-13-65"><a id="__codelineno-13-65" name="__codelineno-13-65" href="#__codelineno-13-65"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">vendor_policy_cil_file</span><span class="p">(</span><span class="s">&quot;/vendor/etc/selinux/vendor_sepolicy.cil&quot;</span><span class="p">);</span>
</span><span id="__span-13-66"><a id="__codelineno-13-66" name="__codelineno-13-66" href="#__codelineno-13-66"></a>
</span><span id="__span-13-67"><a id="__codelineno-13-67" name="__codelineno-13-67" href="#__codelineno-13-67"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">vendor_policy_cil_file</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">F_OK</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-68"><a id="__codelineno-13-68" name="__codelineno-13-68" href="#__codelineno-13-68"></a><span class="w">        </span><span class="c1">// For backward compatibility.</span>
</span><span id="__span-13-69"><a id="__codelineno-13-69" name="__codelineno-13-69" href="#__codelineno-13-69"></a><span class="w">        </span><span class="c1">// TODO: remove this after no device is using nonplat_sepolicy.cil.</span>
</span><span id="__span-13-70"><a id="__codelineno-13-70" name="__codelineno-13-70" href="#__codelineno-13-70"></a><span class="w">        </span><span class="n">vendor_policy_cil_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/vendor/etc/selinux/nonplat_sepolicy.cil&quot;</span><span class="p">;</span>
</span><span id="__span-13-71"><a id="__codelineno-13-71" name="__codelineno-13-71" href="#__codelineno-13-71"></a><span class="w">        </span><span class="n">plat_pub_versioned_cil_file</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span><span id="__span-13-72"><a id="__codelineno-13-72" name="__codelineno-13-72" href="#__codelineno-13-72"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">plat_pub_versioned_cil_file</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">F_OK</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-73"><a id="__codelineno-13-73" name="__codelineno-13-73" href="#__codelineno-13-73"></a><span class="w">        </span><span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Missing &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">plat_pub_versioned_cil_file</span><span class="p">;</span>
</span><span id="__span-13-74"><a id="__codelineno-13-74" name="__codelineno-13-74" href="#__codelineno-13-74"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
</span><span id="__span-13-75"><a id="__codelineno-13-75" name="__codelineno-13-75" href="#__codelineno-13-75"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-76"><a id="__codelineno-13-76" name="__codelineno-13-76" href="#__codelineno-13-76"></a>
</span><span id="__span-13-77"><a id="__codelineno-13-77" name="__codelineno-13-77" href="#__codelineno-13-77"></a><span class="w">    </span><span class="c1">// odm_sepolicy.cil is default but optional.</span>
</span><span id="__span-13-78"><a id="__codelineno-13-78" name="__codelineno-13-78" href="#__codelineno-13-78"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">odm_policy_cil_file</span><span class="p">(</span><span class="s">&quot;/odm/etc/selinux/odm_sepolicy.cil&quot;</span><span class="p">);</span>
</span><span id="__span-13-79"><a id="__codelineno-13-79" name="__codelineno-13-79" href="#__codelineno-13-79"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">odm_policy_cil_file</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">F_OK</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-80"><a id="__codelineno-13-80" name="__codelineno-13-80" href="#__codelineno-13-80"></a><span class="w">        </span><span class="n">odm_policy_cil_file</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span><span id="__span-13-81"><a id="__codelineno-13-81" name="__codelineno-13-81" href="#__codelineno-13-81"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-82"><a id="__codelineno-13-82" name="__codelineno-13-82" href="#__codelineno-13-82"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">version_as_string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">SEPOLICY_VERSION</span><span class="p">);</span>
</span><span id="__span-13-83"><a id="__codelineno-13-83" name="__codelineno-13-83" href="#__codelineno-13-83"></a>
</span><span id="__span-13-84"><a id="__codelineno-13-84" name="__codelineno-13-84" href="#__codelineno-13-84"></a><span class="w">    </span><span class="c1">// clang-format off</span>
</span><span id="__span-13-85"><a id="__codelineno-13-85" name="__codelineno-13-85" href="#__codelineno-13-85"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">compile_args</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-86"><a id="__codelineno-13-86" name="__codelineno-13-86" href="#__codelineno-13-86"></a><span class="w">        </span><span class="s">&quot;/system/bin/secilc&quot;</span><span class="p">,</span>
</span><span id="__span-13-87"><a id="__codelineno-13-87" name="__codelineno-13-87" href="#__codelineno-13-87"></a><span class="w">        </span><span class="n">use_userdebug_policy</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">kDebugRamdiskSEPolicy</span><span class="o">:</span><span class="w"> </span><span class="n">plat_policy_cil_file</span><span class="p">,</span>
</span><span id="__span-13-88"><a id="__codelineno-13-88" name="__codelineno-13-88" href="#__codelineno-13-88"></a><span class="w">        </span><span class="s">&quot;-m&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-M&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-G&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-N&quot;</span><span class="p">,</span>
</span><span id="__span-13-89"><a id="__codelineno-13-89" name="__codelineno-13-89" href="#__codelineno-13-89"></a><span class="w">        </span><span class="s">&quot;-c&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">version_as_string</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span>
</span><span id="__span-13-90"><a id="__codelineno-13-90" name="__codelineno-13-90" href="#__codelineno-13-90"></a><span class="w">        </span><span class="n">plat_mapping_file</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span>
</span><span id="__span-13-91"><a id="__codelineno-13-91" name="__codelineno-13-91" href="#__codelineno-13-91"></a><span class="w">        </span><span class="s">&quot;-o&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">compiled_sepolicy</span><span class="p">,</span>
</span><span id="__span-13-92"><a id="__codelineno-13-92" name="__codelineno-13-92" href="#__codelineno-13-92"></a><span class="w">        </span><span class="c1">// We don&#39;t care about file_contexts output by the compiler</span>
</span><span id="__span-13-93"><a id="__codelineno-13-93" name="__codelineno-13-93" href="#__codelineno-13-93"></a><span class="w">        </span><span class="s">&quot;-f&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/sys/fs/selinux/null&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1">// /dev/null is not yet available</span>
</span><span id="__span-13-94"><a id="__codelineno-13-94" name="__codelineno-13-94" href="#__codelineno-13-94"></a><span class="w">    </span><span class="p">};</span>
</span><span id="__span-13-95"><a id="__codelineno-13-95" name="__codelineno-13-95" href="#__codelineno-13-95"></a><span class="w">    </span><span class="c1">// clang-format on</span>
</span><span id="__span-13-96"><a id="__codelineno-13-96" name="__codelineno-13-96" href="#__codelineno-13-96"></a>
</span><span id="__span-13-97"><a id="__codelineno-13-97" name="__codelineno-13-97" href="#__codelineno-13-97"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-13-98"><a id="__codelineno-13-98" name="__codelineno-13-98" href="#__codelineno-13-98"></a><span class="p">}</span>
</span></code></pre></div>
<h5 id="selinuxfindprecompiledsplitpolicy">selinux.FindPrecompiledSplitPolicy()<a class="headerlink" href="#selinuxfindprecompiledsplitpolicy" title="Permanent link">&para;</a></h5>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="nl">http</span><span class="p">:</span><span class="c1">//aospxref.com/android-12.0.0_r3/xref/system/core/init/selinux.cpp</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="n">Result</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">FindPrecompiledSplitPolicy</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">precompiled_sepolicy</span><span class="p">;</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="w">    </span><span class="c1">// If there is an odm partition, precompiled_sepolicy will be in</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="w">    </span><span class="c1">// odm/etc/selinux. Otherwise it will be in vendor/etc/selinux.</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">vendor_precompiled_sepolicy</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="w">        </span><span class="s">&quot;/vendor/etc/selinux/precompiled_sepolicy&quot;</span><span class="p">;</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">odm_precompiled_sepolicy</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="w">        </span><span class="s">&quot;/odm/etc/selinux/precompiled_sepolicy&quot;</span><span class="p">;</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">odm_precompiled_sepolicy</span><span class="p">,</span><span class="w"> </span><span class="n">R_OK</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="w">        </span><span class="n">precompiled_sepolicy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">odm_precompiled_sepolicy</span><span class="p">;</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">vendor_precompiled_sepolicy</span><span class="p">,</span><span class="w"> </span><span class="n">R_OK</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a><span class="w">        </span><span class="n">precompiled_sepolicy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vendor_precompiled_sepolicy</span><span class="p">;</span>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ErrnoError</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;No precompiled sepolicy at &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">vendor_precompiled_sepolicy</span><span class="p">;</span>
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a>
</span><span id="__span-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a><span class="w">   </span><span class="p">...</span>
</span><span id="__span-14-20"><a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>查看以下两个文件是否存在，如果存在那就尝试加载，如果加载成功则不会再去编译加载cil文件，也就是编译生成的cil文件被push到手机后不能生效。</li>
<li>"/vendor/etc/selinux/precompiled_sepolicy"</li>
<li>
<p>"/odm/etc/selinux/precompiled_sepolicy"</p>
</li>
<li>
<p>对cil文件进行编译</p>
</li>
</ul>
<p>收集平台上如下cil文件，然后调用/system/bin/secilc程序对.cil文件进行编译：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">selinux</span><span class="o">/</span><span class="n">plat_sepolicy</span><span class="p">.</span><span class="n">cil</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">selinux</span><span class="o">/</span><span class="n">mapping</span><span class="cm">/*.cil</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="cm">/system_ext/etc/selinux/plat_sepolicy.cil</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="cm">/system_ext/etc/selinux/mapping/*.cil</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="cm">/product/etc/selinux/product_sepolicy.cil</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="cm">/product/etc/selinux/mapping/*.cil</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="cm">/vendor/etc/selinux/vendor_sepolicy.cil</span>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="cm">/vendor/etc/selinux/plat_pub_versioned.cil</span>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="cm">/vendor/etc/selinux/nonplat_sepolicy.cil</span>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="cm">/odm/etc/selinux/odm_sepolicy.cil</span>
</span></code></pre></div>
<h4 id="selinuxselinuxsetenforcement">selinux.SelinuxSetEnforcement()<a class="headerlink" href="#selinuxselinuxsetenforcement" title="Permanent link">&para;</a></h4>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="nl">http</span><span class="p">:</span><span class="c1">//aospxref.com/android-12.0.0_r3/xref/system/core/init/selinux.cpp</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="kt">void</span><span class="w"> </span><span class="nf">SelinuxSetEnforcement</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">kernel_enforcing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">security_getenforce</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">is_enforcing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IsEnforcing</span><span class="p">();</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kernel_enforcing</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">is_enforcing</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">security_setenforce</span><span class="p">(</span><span class="n">is_enforcing</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="w">            </span><span class="n">PLOG</span><span class="p">(</span><span class="n">FATAL</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;security_setenforce(&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">is_enforcing</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;false&quot;</span><span class="p">)</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="w">                        </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;) failed&quot;</span><span class="p">;</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WriteFile</span><span class="p">(</span><span class="s">&quot;/sys/fs/selinux/checkreqprot&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;0&quot;</span><span class="p">);</span><span class="w"> </span><span class="o">!</span><span class="n">result</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="w">        </span><span class="n">LOG</span><span class="p">(</span><span class="n">FATAL</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Unable to write to /sys/fs/selinux/checkreqprot: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">error</span><span class="p">();</span>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a><span class="p">}</span>
</span></code></pre></div>
<p>设置是否启用selinux。</p>
<h4 id="_7">总结<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h4>
<p>se的初始化是在init中执行的，大概流程为：</p>
<ul>
<li>判断是否有 <code>precompiled_sepolicy</code> 的文件，如果有则直接加载后退出；</li>
<li>如果没有预编译，那么收集指定的 <code>cil</code> 文件，并用 <code>/system/bin/secilc</code> 程序进行实时编译；</li>
<li>最后加载编译好的文件，完成SE的初始化。</li>
</ul>
<h3 id="pid">设置应用pid流程<a class="headerlink" href="#pid" title="Permanent link">&para;</a></h3>
<p>应用进程是通过Zygote进程fork出来的，在SpecializeCommon()中，通过调用seLinux_android_setcontext()函数来设置应用进程的安全上下文。根据进程的用户名和seinfo在seapp_contexts表中进行查找对应的项，如果找到了，把找到的domain设置到安全上下文中就完成了。整个过程如下：</p>
<h4 id="forkandspecialize">forkAndSpecialize<a class="headerlink" href="#forkandspecialize" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="nl">http</span><span class="p">:</span><span class="c1">//aospxref.com/android-12.0.0_r3/xref/frameworks/base/core/java/com/android/internal/os/Zygote.java</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="kd">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">forkAndSpecialize</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">uid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">gid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">gids</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">runtimeFlags</span><span class="p">,</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="w">                             </span><span class="kt">int</span><span class="o">[][]</span><span class="w"> </span><span class="n">rlimits</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mountExternal</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">seInfo</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">niceName</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">fdsToClose</span><span class="p">,</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="w">                             </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">fdsToIgnore</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">startChildZygote</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">instructionSet</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">appDataDir</span><span class="p">,</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="w">                             </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isTopApp</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">pkgDataInfoList</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">allowlistedDataInfoList</span><span class="p">,</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="w">                             </span><span class="kt">boolean</span><span class="w"> </span><span class="n">bindMountAppDataDirs</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">bindMountAppStorageDirs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="w">    </span><span class="n">ZygoteHooks</span><span class="p">.</span><span class="na">preFork</span><span class="p">();</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nativeForkAndSpecialize</span><span class="p">(</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="w">        </span><span class="n">uid</span><span class="p">,</span><span class="w"> </span><span class="n">gid</span><span class="p">,</span><span class="w"> </span><span class="n">gids</span><span class="p">,</span><span class="w"> </span><span class="n">runtimeFlags</span><span class="p">,</span><span class="w"> </span><span class="n">rlimits</span><span class="p">,</span><span class="w"> </span><span class="n">mountExternal</span><span class="p">,</span><span class="w"> </span><span class="n">seInfo</span><span class="p">,</span><span class="w"> </span><span class="n">niceName</span><span class="p">,</span><span class="w"> </span><span class="n">fdsToClose</span><span class="p">,</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="w">        </span><span class="n">fdsToIgnore</span><span class="p">,</span><span class="w"> </span><span class="n">startChildZygote</span><span class="p">,</span><span class="w"> </span><span class="n">instructionSet</span><span class="p">,</span><span class="w"> </span><span class="n">appDataDir</span><span class="p">,</span><span class="w"> </span><span class="n">isTopApp</span><span class="p">,</span>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a><span class="w">        </span><span class="n">pkgDataInfoList</span><span class="p">,</span><span class="w"> </span><span class="n">allowlistedDataInfoList</span><span class="p">,</span><span class="w"> </span><span class="n">bindMountAppDataDirs</span><span class="p">,</span>
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a><span class="w">        </span><span class="n">bindMountAppStorageDirs</span><span class="p">);</span>
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a><span class="p">}</span>
</span></code></pre></div>
<p>通过jni调用调到了nativeForkAndSpecialize。</p>
<h4 id="nativeforkandspecialize">nativeForkAndSpecialize<a class="headerlink" href="#nativeforkandspecialize" title="Permanent link">&para;</a></h4>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="nl">http</span><span class="p">:</span><span class="c1">//aospxref.com/android-12.0.0_r3/xref/frameworks/base/core/jni/com_android_internal_os_Zygote.cpp</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="k">static</span><span class="w"> </span><span class="n">jint</span><span class="w"> </span><span class="nf">com_android_internal_os_Zygote_nativeForkAndSpecialize</span><span class="p">(</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="w">    </span><span class="n">JNIEnv</span><span class="o">*</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">jclass</span><span class="p">,</span><span class="w"> </span><span class="n">jint</span><span class="w"> </span><span class="n">uid</span><span class="p">,</span><span class="w"> </span><span class="n">jint</span><span class="w"> </span><span class="n">gid</span><span class="p">,</span><span class="w"> </span><span class="n">jintArray</span><span class="w"> </span><span class="n">gids</span><span class="p">,</span><span class="w"> </span><span class="n">jint</span><span class="w"> </span><span class="n">runtime_flags</span><span class="p">,</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="w">    </span><span class="n">jobjectArray</span><span class="w"> </span><span class="n">rlimits</span><span class="p">,</span><span class="w"> </span><span class="n">jint</span><span class="w"> </span><span class="n">mount_external</span><span class="p">,</span><span class="w"> </span><span class="n">jstring</span><span class="w"> </span><span class="n">se_info</span><span class="p">,</span><span class="w"> </span><span class="n">jstring</span><span class="w"> </span><span class="n">nice_name</span><span class="p">,</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="w">    </span><span class="n">jintArray</span><span class="w"> </span><span class="n">managed_fds_to_close</span><span class="p">,</span><span class="w"> </span><span class="n">jintArray</span><span class="w"> </span><span class="n">managed_fds_to_ignore</span><span class="p">,</span><span class="w"> </span><span class="n">jboolean</span><span class="w"> </span><span class="n">is_child_zygote</span><span class="p">,</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="w">    </span><span class="n">jstring</span><span class="w"> </span><span class="n">instruction_set</span><span class="p">,</span><span class="w"> </span><span class="n">jstring</span><span class="w"> </span><span class="n">app_data_dir</span><span class="p">,</span><span class="w"> </span><span class="n">jboolean</span><span class="w"> </span><span class="n">is_top_app</span><span class="p">,</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="w">    </span><span class="n">jobjectArray</span><span class="w"> </span><span class="n">pkg_data_info_list</span><span class="p">,</span><span class="w"> </span><span class="n">jobjectArray</span><span class="w"> </span><span class="n">allowlisted_data_info_list</span><span class="p">,</span>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="w">    </span><span class="n">jboolean</span><span class="w"> </span><span class="n">mount_data_dirs</span><span class="p">,</span><span class="w"> </span><span class="n">jboolean</span><span class="w"> </span><span class="n">mount_storage_dirs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="w">            </span><span class="n">SpecializeCommon</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">uid</span><span class="p">,</span><span class="w"> </span><span class="n">gid</span><span class="p">,</span><span class="w"> </span><span class="n">gids</span><span class="p">,</span><span class="w"> </span><span class="n">runtime_flags</span><span class="p">,</span><span class="w"> </span><span class="n">rlimits</span><span class="p">,</span><span class="w"> </span><span class="n">capabilities</span><span class="p">,</span><span class="w"> </span><span class="n">capabilities</span><span class="p">,</span>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="w">                             </span><span class="n">mount_external</span><span class="p">,</span><span class="w"> </span><span class="n">se_info</span><span class="p">,</span><span class="w"> </span><span class="n">nice_name</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="n">is_child_zygote</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">JNI_TRUE</span><span class="p">,</span>
</span><span id="__span-18-15"><a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="w">                             </span><span class="n">instruction_set</span><span class="p">,</span><span class="w"> </span><span class="n">app_data_dir</span><span class="p">,</span><span class="w"> </span><span class="n">is_top_app</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">JNI_TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">pkg_data_info_list</span><span class="p">,</span>
</span><span id="__span-18-16"><a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="w">                             </span><span class="n">allowlisted_data_info_list</span><span class="p">,</span><span class="w"> </span><span class="n">mount_data_dirs</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">JNI_TRUE</span><span class="p">,</span>
</span><span id="__span-18-17"><a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a><span class="w">                             </span><span class="n">mount_storage_dirs</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">JNI_TRUE</span><span class="p">);</span>
</span><span id="__span-18-18"><a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-18-19"><a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">pid</span><span class="p">;</span>
</span><span id="__span-18-20"><a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a><span class="p">}</span>
</span></code></pre></div>
<p>可以看到在com_android_internal_os_Zygote_nativeForkAndSpecialize主要是调用了SpecializeCommon来设置进程安全上下文。</p>
<h4 id="specializecommon">SpecializeCommon<a class="headerlink" href="#specializecommon" title="Permanent link">&para;</a></h4>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="nl">http</span><span class="p">:</span><span class="c1">//aospxref.com/android-12.0.0_r3/xref/frameworks/base/core/jni/com_android_internal_os_Zygote.cpp</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="c1">// Utility routine to specialize a zygote child process.</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">SpecializeCommon</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="kt">uid_t</span><span class="w"> </span><span class="n">uid</span><span class="p">,</span><span class="w"> </span><span class="kt">gid_t</span><span class="w"> </span><span class="n">gid</span><span class="p">,</span><span class="w"> </span><span class="n">jintArray</span><span class="w"> </span><span class="n">gids</span><span class="p">,</span><span class="w"> </span><span class="n">jint</span><span class="w"> </span><span class="n">runtime_flags</span><span class="p">,</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="w">                             </span><span class="n">jobjectArray</span><span class="w"> </span><span class="n">rlimits</span><span class="p">,</span><span class="w"> </span><span class="n">jlong</span><span class="w"> </span><span class="n">permitted_capabilities</span><span class="p">,</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="w">                             </span><span class="n">jlong</span><span class="w"> </span><span class="n">effective_capabilities</span><span class="p">,</span><span class="w"> </span><span class="n">jint</span><span class="w"> </span><span class="n">mount_external</span><span class="p">,</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="w">                             </span><span class="n">jstring</span><span class="w"> </span><span class="n">managed_se_info</span><span class="p">,</span><span class="w"> </span><span class="n">jstring</span><span class="w"> </span><span class="n">managed_nice_name</span><span class="p">,</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="w">                             </span><span class="kt">bool</span><span class="w"> </span><span class="n">is_system_server</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">is_child_zygote</span><span class="p">,</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="w">                             </span><span class="n">jstring</span><span class="w"> </span><span class="n">managed_instruction_set</span><span class="p">,</span><span class="w"> </span><span class="n">jstring</span><span class="w"> </span><span class="n">managed_app_data_dir</span><span class="p">,</span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="w">                             </span><span class="kt">bool</span><span class="w"> </span><span class="n">is_top_app</span><span class="p">,</span><span class="w"> </span><span class="n">jobjectArray</span><span class="w"> </span><span class="n">pkg_data_info_list</span><span class="p">,</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="w">                             </span><span class="n">jobjectArray</span><span class="w"> </span><span class="n">allowlisted_data_info_list</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">mount_data_dirs</span><span class="p">,</span>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="w">                             </span><span class="kt">bool</span><span class="w"> </span><span class="n">mount_storage_dirs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a>
</span><span id="__span-19-15"><a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">selinux_android_setcontext</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span><span class="w"> </span><span class="n">is_system_server</span><span class="p">,</span><span class="w"> </span><span class="n">se_info_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">nice_name_ptr</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-16"><a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a><span class="w">        </span><span class="n">fail_fn</span><span class="p">(</span><span class="n">CREATE_ERROR</span><span class="p">(</span><span class="s">&quot;selinux_android_setcontext(%d, %d, </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">, </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">) failed&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">uid</span><span class="p">,</span>
</span><span id="__span-19-17"><a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="w">                             </span><span class="n">is_system_server</span><span class="p">,</span><span class="w"> </span><span class="n">se_info_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">nice_name_ptr</span><span class="p">));</span>
</span><span id="__span-19-18"><a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-19-19"><a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a>
</span><span id="__span-19-20"><a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-19-21"><a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a><span class="p">}</span>
</span></code></pre></div>
<p>调用selinux_android_setcontext，并传给seinfo和包名，下面来重点分析。</p>
<h4 id="selinux_android_setcontext">selinux_android_setcontext<a class="headerlink" href="#selinux_android_setcontext" title="Permanent link">&para;</a></h4>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="nl">http</span><span class="p">:</span><span class="c1">//aospxref.com/android-12.0.0_r3/xref/external/selinux/libselinux/src/android/android_platform.c#1027</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="kt">int</span><span class="w"> </span><span class="nf">selinux_android_setcontext</span><span class="p">(</span><span class="kt">uid_t</span><span class="w"> </span><span class="n">uid</span><span class="p">,</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="w">                   </span><span class="kt">bool</span><span class="w"> </span><span class="n">isSystemServer</span><span class="p">,</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="w">                   </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">seinfo</span><span class="p">,</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="w">                   </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">pkgname</span><span class="p">)</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="p">{</span>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">orig_ctx_str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">ctx_str</span><span class="p">;</span>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="w">    </span><span class="n">context_t</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a>
</span><span id="__span-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_selinux_enabled</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-20-13"><a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-20-14"><a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a>
</span><span id="__span-20-15"><a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a><span class="w">    </span><span class="c1">//得到当前进程从Zygote进程继承的安全上下文</span>
</span><span id="__span-20-16"><a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a><span class="w">    </span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getcon</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx_str</span><span class="p">);</span>
</span><span id="__span-20-17"><a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rc</span><span class="p">)</span>
</span><span id="__span-20-18"><a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span id="__span-20-19"><a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a>
</span><span id="__span-20-20"><a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a><span class="w">    </span><span class="c1">//以ctx_str为模板创建一个新的安全上下文</span>
</span><span id="__span-20-21"><a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a><span class="w">    </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context_new</span><span class="p">(</span><span class="n">ctx_str</span><span class="p">);</span>
</span><span id="__span-20-22"><a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a><span class="w">    </span><span class="n">orig_ctx_str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx_str</span><span class="p">;</span>
</span><span id="__span-20-23"><a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="p">)</span>
</span><span id="__span-20-24"><a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">oom</span><span class="p">;</span>
</span><span id="__span-20-25"><a id="__codelineno-20-25" name="__codelineno-20-25" href="#__codelineno-20-25"></a>
</span><span id="__span-20-26"><a id="__codelineno-20-26" name="__codelineno-20-26" href="#__codelineno-20-26"></a><span class="w">    </span><span class="c1">//在SEAPP_DOMAIN中查找新的安全上下文</span>
</span><span id="__span-20-27"><a id="__codelineno-20-27" name="__codelineno-20-27" href="#__codelineno-20-27"></a><span class="w">    </span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seapp_context_lookup</span><span class="p">(</span><span class="n">SEAPP_DOMAIN</span><span class="p">,</span><span class="w"> </span><span class="n">uid</span><span class="p">,</span><span class="w"> </span><span class="n">isSystemServer</span><span class="p">,</span><span class="w"> </span><span class="n">seinfo</span><span class="p">,</span><span class="w"> </span><span class="n">pkgname</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">);</span>
</span><span id="__span-20-28"><a id="__codelineno-20-28" name="__codelineno-20-28" href="#__codelineno-20-28"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rc</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span>
</span><span id="__span-20-29"><a id="__codelineno-20-29" name="__codelineno-20-29" href="#__codelineno-20-29"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span id="__span-20-30"><a id="__codelineno-20-30" name="__codelineno-20-30" href="#__codelineno-20-30"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rc</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-2</span><span class="p">)</span>
</span><span id="__span-20-31"><a id="__codelineno-20-31" name="__codelineno-20-31" href="#__codelineno-20-31"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">oom</span><span class="p">;</span>
</span><span id="__span-20-32"><a id="__codelineno-20-32" name="__codelineno-20-32" href="#__codelineno-20-32"></a>
</span><span id="__span-20-33"><a id="__codelineno-20-33" name="__codelineno-20-33" href="#__codelineno-20-33"></a><span class="w">    </span><span class="n">ctx_str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context_str</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
</span><span id="__span-20-34"><a id="__codelineno-20-34" name="__codelineno-20-34" href="#__codelineno-20-34"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ctx_str</span><span class="p">)</span>
</span><span id="__span-20-35"><a id="__codelineno-20-35" name="__codelineno-20-35" href="#__codelineno-20-35"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">oom</span><span class="p">;</span>
</span><span id="__span-20-36"><a id="__codelineno-20-36" name="__codelineno-20-36" href="#__codelineno-20-36"></a>
</span><span id="__span-20-37"><a id="__codelineno-20-37" name="__codelineno-20-37" href="#__codelineno-20-37"></a><span class="w">    </span><span class="c1">//检查新的安全上下文</span>
</span><span id="__span-20-38"><a id="__codelineno-20-38" name="__codelineno-20-38" href="#__codelineno-20-38"></a><span class="w">    </span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">security_check_context</span><span class="p">(</span><span class="n">ctx_str</span><span class="p">);</span>
</span><span id="__span-20-39"><a id="__codelineno-20-39" name="__codelineno-20-39" href="#__codelineno-20-39"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rc</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-20-40"><a id="__codelineno-20-40" name="__codelineno-20-40" href="#__codelineno-20-40"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span id="__span-20-41"><a id="__codelineno-20-41" name="__codelineno-20-41" href="#__codelineno-20-41"></a>
</span><span id="__span-20-42"><a id="__codelineno-20-42" name="__codelineno-20-42" href="#__codelineno-20-42"></a><span class="w">    </span><span class="c1">//如果新的安全上下文和原来的不同</span>
</span><span id="__span-20-43"><a id="__codelineno-20-43" name="__codelineno-20-43" href="#__codelineno-20-43"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ctx_str</span><span class="p">,</span><span class="w"> </span><span class="n">orig_ctx_str</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-20-44"><a id="__codelineno-20-44" name="__codelineno-20-44" href="#__codelineno-20-44"></a><span class="w">        </span><span class="c1">//为当前进程设置安全上下文</span>
</span><span id="__span-20-45"><a id="__codelineno-20-45" name="__codelineno-20-45" href="#__codelineno-20-45"></a><span class="w">        </span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">selinux_android_setcon</span><span class="p">(</span><span class="n">ctx_str</span><span class="p">);</span>
</span><span id="__span-20-46"><a id="__codelineno-20-46" name="__codelineno-20-46" href="#__codelineno-20-46"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rc</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-20-47"><a id="__codelineno-20-47" name="__codelineno-20-47" href="#__codelineno-20-47"></a><span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span id="__span-20-48"><a id="__codelineno-20-48" name="__codelineno-20-48" href="#__codelineno-20-48"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-20-49"><a id="__codelineno-20-49" name="__codelineno-20-49" href="#__codelineno-20-49"></a>
</span><span id="__span-20-50"><a id="__codelineno-20-50" name="__codelineno-20-50" href="#__codelineno-20-50"></a><span class="w">    </span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-20-51"><a id="__codelineno-20-51" name="__codelineno-20-51" href="#__codelineno-20-51"></a><span class="nl">out</span><span class="p">:</span>
</span><span id="__span-20-52"><a id="__codelineno-20-52" name="__codelineno-20-52" href="#__codelineno-20-52"></a><span class="w">    </span><span class="n">freecon</span><span class="p">(</span><span class="n">orig_ctx_str</span><span class="p">);</span>
</span><span id="__span-20-53"><a id="__codelineno-20-53" name="__codelineno-20-53" href="#__codelineno-20-53"></a><span class="w">    </span><span class="n">context_free</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
</span><span id="__span-20-54"><a id="__codelineno-20-54" name="__codelineno-20-54" href="#__codelineno-20-54"></a><span class="w">    </span><span class="n">avc_netlink_close</span><span class="p">();</span>
</span><span id="__span-20-55"><a id="__codelineno-20-55" name="__codelineno-20-55" href="#__codelineno-20-55"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">rc</span><span class="p">;</span>
</span><span id="__span-20-56"><a id="__codelineno-20-56" name="__codelineno-20-56" href="#__codelineno-20-56"></a><span class="nl">err</span><span class="p">:</span>
</span><span id="__span-20-57"><a id="__codelineno-20-57" name="__codelineno-20-57" href="#__codelineno-20-57"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isSystemServer</span><span class="p">)</span>
</span><span id="__span-20-58"><a id="__codelineno-20-58" name="__codelineno-20-58" href="#__codelineno-20-58"></a><span class="w">        </span><span class="n">selinux_log</span><span class="p">(</span><span class="n">SELINUX_ERROR</span><span class="p">,</span>
</span><span id="__span-20-59"><a id="__codelineno-20-59" name="__codelineno-20-59" href="#__codelineno-20-59"></a><span class="w">                </span><span class="s">&quot;%s:  Error setting context for system server: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span id="__span-20-60"><a id="__codelineno-20-60" name="__codelineno-20-60" href="#__codelineno-20-60"></a><span class="w">                </span><span class="n">__FUNCTION__</span><span class="p">,</span><span class="w"> </span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
</span><span id="__span-20-61"><a id="__codelineno-20-61" name="__codelineno-20-61" href="#__codelineno-20-61"></a><span class="w">    </span><span class="k">else</span>
</span><span id="__span-20-62"><a id="__codelineno-20-62" name="__codelineno-20-62" href="#__codelineno-20-62"></a><span class="w">        </span><span class="n">selinux_log</span><span class="p">(</span><span class="n">SELINUX_ERROR</span><span class="p">,</span>
</span><span id="__span-20-63"><a id="__codelineno-20-63" name="__codelineno-20-63" href="#__codelineno-20-63"></a><span class="w">                </span><span class="s">&quot;%s:  Error setting context for app with uid %d, seinfo %s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span id="__span-20-64"><a id="__codelineno-20-64" name="__codelineno-20-64" href="#__codelineno-20-64"></a><span class="w">                </span><span class="n">__FUNCTION__</span><span class="p">,</span><span class="w"> </span><span class="n">uid</span><span class="p">,</span><span class="w"> </span><span class="n">seinfo</span><span class="p">,</span><span class="w"> </span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
</span><span id="__span-20-65"><a id="__codelineno-20-65" name="__codelineno-20-65" href="#__codelineno-20-65"></a>
</span><span id="__span-20-66"><a id="__codelineno-20-66" name="__codelineno-20-66" href="#__codelineno-20-66"></a><span class="w">    </span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
</span><span id="__span-20-67"><a id="__codelineno-20-67" name="__codelineno-20-67" href="#__codelineno-20-67"></a><span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
</span><span id="__span-20-68"><a id="__codelineno-20-68" name="__codelineno-20-68" href="#__codelineno-20-68"></a><span class="nl">oom</span><span class="p">:</span>
</span><span id="__span-20-69"><a id="__codelineno-20-69" name="__codelineno-20-69" href="#__codelineno-20-69"></a><span class="w">    </span><span class="n">selinux_log</span><span class="p">(</span><span class="n">SELINUX_ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s:  Out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__FUNCTION__</span><span class="p">);</span>
</span><span id="__span-20-70"><a id="__codelineno-20-70" name="__codelineno-20-70" href="#__codelineno-20-70"></a><span class="w">    </span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
</span><span id="__span-20-71"><a id="__codelineno-20-71" name="__codelineno-20-71" href="#__codelineno-20-71"></a><span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
</span><span id="__span-20-72"><a id="__codelineno-20-72" name="__codelineno-20-72" href="#__codelineno-20-72"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>得到当前进程从Zygote进程继承的安全上下文；</li>
<li>以ctx_str为模板创建一个新的安全上下文；</li>
<li>在SEAPP_DOMAIN中查找新的安全上下文（重点分析）；</li>
<li>检查新的安全上下文；</li>
<li>如果新的安全上下文和原来的不同，为当前进程设置安全上下文。</li>
</ul>
<h4 id="seapp_context_lookup">seapp_context_lookup<a class="headerlink" href="#seapp_context_lookup" title="Permanent link">&para;</a></h4>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="nl">http</span><span class="p">:</span><span class="c1">//aospxref.com/android-12.0.0_r3/xref/external/selinux/libselinux/src/android/android_platform.c</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">seapp_context_lookup</span><span class="p">(</span><span class="k">enum</span><span class="w"> </span><span class="nc">seapp_kind</span><span class="w"> </span><span class="n">kind</span><span class="p">,</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="w">                </span><span class="kt">uid_t</span><span class="w"> </span><span class="n">uid</span><span class="p">,</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="w">                </span><span class="kt">bool</span><span class="w"> </span><span class="n">isSystemServer</span><span class="p">,</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">seinfo</span><span class="p">,</span>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">pkgname</span><span class="p">,</span>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">path</span><span class="p">,</span>
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a><span class="w">                </span><span class="n">context_t</span><span class="w"> </span><span class="n">ctx</span><span class="p">)</span>
</span><span id="__span-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a><span class="p">{</span>
</span><span id="__span-21-11"><a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">passwd</span><span class="w"> </span><span class="o">*</span><span class="n">pwd</span><span class="p">;</span>
</span><span id="__span-21-12"><a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">isOwner</span><span class="p">;</span>
</span><span id="__span-21-13"><a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-21-14"><a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">seapp_context</span><span class="w"> </span><span class="o">*</span><span class="n">cur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-21-15"><a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
</span><span id="__span-21-16"><a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a><span class="w">    </span><span class="kt">uid_t</span><span class="w"> </span><span class="n">userid</span><span class="p">;</span>
</span><span id="__span-21-17"><a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a><span class="w">    </span><span class="kt">uid_t</span><span class="w"> </span><span class="n">appid</span><span class="p">;</span>
</span><span id="__span-21-18"><a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">isPrivApp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
</span><span id="__span-21-19"><a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">isEphemeralApp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
</span><span id="__span-21-20"><a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a><span class="w">    </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">targetSdkVersion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-21-21"><a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">fromRunAs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
</span><span id="__span-21-22"><a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">parsedseinfo</span><span class="p">[</span><span class="n">BUFSIZ</span><span class="p">];</span>
</span><span id="__span-21-23"><a id="__codelineno-21-23" name="__codelineno-21-23" href="#__codelineno-21-23"></a>
</span><span id="__span-21-24"><a id="__codelineno-21-24" name="__codelineno-21-24" href="#__codelineno-21-24"></a><span class="w">    </span><span class="c1">//初始化 seapp_context</span>
</span><span id="__span-21-25"><a id="__codelineno-21-25" name="__codelineno-21-25" href="#__codelineno-21-25"></a><span class="w">    </span><span class="n">selinux_android_seapp_context_init</span><span class="p">();</span>
</span><span id="__span-21-26"><a id="__codelineno-21-26" name="__codelineno-21-26" href="#__codelineno-21-26"></a>
</span><span id="__span-21-27"><a id="__codelineno-21-27" name="__codelineno-21-27" href="#__codelineno-21-27"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">seinfo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-28"><a id="__codelineno-21-28" name="__codelineno-21-28" href="#__codelineno-21-28"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">seinfo_parse</span><span class="p">(</span><span class="n">parsedseinfo</span><span class="p">,</span><span class="w"> </span><span class="n">seinfo</span><span class="p">,</span><span class="w"> </span><span class="n">BUFSIZ</span><span class="p">))</span>
</span><span id="__span-21-29"><a id="__codelineno-21-29" name="__codelineno-21-29" href="#__codelineno-21-29"></a><span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span id="__span-21-30"><a id="__codelineno-21-30" name="__codelineno-21-30" href="#__codelineno-21-30"></a><span class="w">        </span><span class="n">isPrivApp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strstr</span><span class="p">(</span><span class="n">seinfo</span><span class="p">,</span><span class="w"> </span><span class="n">PRIVILEGED_APP_STR</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
</span><span id="__span-21-31"><a id="__codelineno-21-31" name="__codelineno-21-31" href="#__codelineno-21-31"></a><span class="w">        </span><span class="n">isEphemeralApp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strstr</span><span class="p">(</span><span class="n">seinfo</span><span class="p">,</span><span class="w"> </span><span class="n">EPHEMERAL_APP_STR</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
</span><span id="__span-21-32"><a id="__codelineno-21-32" name="__codelineno-21-32" href="#__codelineno-21-32"></a><span class="w">        </span><span class="n">fromRunAs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strstr</span><span class="p">(</span><span class="n">seinfo</span><span class="p">,</span><span class="w"> </span><span class="n">FROM_RUNAS_STR</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
</span><span id="__span-21-33"><a id="__codelineno-21-33" name="__codelineno-21-33" href="#__codelineno-21-33"></a><span class="w">        </span><span class="n">targetSdkVersion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_app_targetSdkVersion</span><span class="p">(</span><span class="n">seinfo</span><span class="p">);</span>
</span><span id="__span-21-34"><a id="__codelineno-21-34" name="__codelineno-21-34" href="#__codelineno-21-34"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">targetSdkVersion</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-35"><a id="__codelineno-21-35" name="__codelineno-21-35" href="#__codelineno-21-35"></a><span class="w">            </span><span class="n">selinux_log</span><span class="p">(</span><span class="n">SELINUX_ERROR</span><span class="p">,</span>
</span><span id="__span-21-36"><a id="__codelineno-21-36" name="__codelineno-21-36" href="#__codelineno-21-36"></a><span class="w">                    </span><span class="s">&quot;%s:  Invalid targetSdkVersion passed for app with uid %d, seinfo %s, name %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span id="__span-21-37"><a id="__codelineno-21-37" name="__codelineno-21-37" href="#__codelineno-21-37"></a><span class="w">                    </span><span class="n">__FUNCTION__</span><span class="p">,</span><span class="w"> </span><span class="n">uid</span><span class="p">,</span><span class="w"> </span><span class="n">seinfo</span><span class="p">,</span><span class="w"> </span><span class="n">pkgname</span><span class="p">);</span>
</span><span id="__span-21-38"><a id="__codelineno-21-38" name="__codelineno-21-38" href="#__codelineno-21-38"></a><span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span id="__span-21-39"><a id="__codelineno-21-39" name="__codelineno-21-39" href="#__codelineno-21-39"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-21-40"><a id="__codelineno-21-40" name="__codelineno-21-40" href="#__codelineno-21-40"></a><span class="w">        </span><span class="n">seinfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parsedseinfo</span><span class="p">;</span>
</span><span id="__span-21-41"><a id="__codelineno-21-41" name="__codelineno-21-41" href="#__codelineno-21-41"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-21-42"><a id="__codelineno-21-42" name="__codelineno-21-42" href="#__codelineno-21-42"></a>
</span><span id="__span-21-43"><a id="__codelineno-21-43" name="__codelineno-21-43" href="#__codelineno-21-43"></a><span class="w">    </span><span class="n">userid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uid</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">AID_USER</span><span class="p">;</span>
</span><span id="__span-21-44"><a id="__codelineno-21-44" name="__codelineno-21-44" href="#__codelineno-21-44"></a><span class="w">    </span><span class="n">isOwner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">userid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-21-45"><a id="__codelineno-21-45" name="__codelineno-21-45" href="#__codelineno-21-45"></a><span class="w">    </span><span class="n">appid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uid</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">AID_USER</span><span class="p">;</span>
</span><span id="__span-21-46"><a id="__codelineno-21-46" name="__codelineno-21-46" href="#__codelineno-21-46"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">appid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">AID_APP</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="c1">//通过uid获取进程名</span>
</span><span id="__span-21-47"><a id="__codelineno-21-47" name="__codelineno-21-47" href="#__codelineno-21-47"></a><span class="w">            </span><span class="cm">/*</span>
</span><span id="__span-21-48"><a id="__codelineno-21-48" name="__codelineno-21-48" href="#__codelineno-21-48"></a><span class="cm">             * This code is Android specific, bionic guarantees that</span>
</span><span id="__span-21-49"><a id="__codelineno-21-49" name="__codelineno-21-49" href="#__codelineno-21-49"></a><span class="cm">             * calls to non-reentrant getpwuid() are thread safe.</span>
</span><span id="__span-21-50"><a id="__codelineno-21-50" name="__codelineno-21-50" href="#__codelineno-21-50"></a><span class="cm">             */</span>
</span><span id="__span-21-51"><a id="__codelineno-21-51" name="__codelineno-21-51" href="#__codelineno-21-51"></a><span class="cp">#ifndef __BIONIC__</span>
</span><span id="__span-21-52"><a id="__codelineno-21-52" name="__codelineno-21-52" href="#__codelineno-21-52"></a><span class="cp">#warning &quot;This code assumes that getpwuid is thread safe, only true with Bionic!&quot;</span>
</span><span id="__span-21-53"><a id="__codelineno-21-53" name="__codelineno-21-53" href="#__codelineno-21-53"></a><span class="cp">#endif</span>
</span><span id="__span-21-54"><a id="__codelineno-21-54" name="__codelineno-21-54" href="#__codelineno-21-54"></a><span class="w">        </span><span class="n">pwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getpwuid</span><span class="p">(</span><span class="n">appid</span><span class="p">);</span>
</span><span id="__span-21-55"><a id="__codelineno-21-55" name="__codelineno-21-55" href="#__codelineno-21-55"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">pwd</span><span class="p">)</span>
</span><span id="__span-21-56"><a id="__codelineno-21-56" name="__codelineno-21-56" href="#__codelineno-21-56"></a><span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span id="__span-21-57"><a id="__codelineno-21-57" name="__codelineno-21-57" href="#__codelineno-21-57"></a>
</span><span id="__span-21-58"><a id="__codelineno-21-58" name="__codelineno-21-58" href="#__codelineno-21-58"></a><span class="w">        </span><span class="n">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pwd</span><span class="o">-&gt;</span><span class="n">pw_name</span><span class="p">;</span>
</span><span id="__span-21-59"><a id="__codelineno-21-59" name="__codelineno-21-59" href="#__codelineno-21-59"></a>
</span><span id="__span-21-60"><a id="__codelineno-21-60" name="__codelineno-21-60" href="#__codelineno-21-60"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">appid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">AID_ISOLATED_START</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="c1">//如果进程号小于AID_ISOLATED_START，说明是普通进程，设置用户名为&quot;_app&quot;</span>
</span><span id="__span-21-61"><a id="__codelineno-21-61" name="__codelineno-21-61" href="#__codelineno-21-61"></a><span class="w">        </span><span class="n">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;_app&quot;</span><span class="p">;</span>
</span><span id="__span-21-62"><a id="__codelineno-21-62" name="__codelineno-21-62" href="#__codelineno-21-62"></a><span class="w">        </span><span class="n">appid</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">AID_APP</span><span class="p">;</span>
</span><span id="__span-21-63"><a id="__codelineno-21-63" name="__codelineno-21-63" href="#__codelineno-21-63"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="c1">//沙箱进程</span>
</span><span id="__span-21-64"><a id="__codelineno-21-64" name="__codelineno-21-64" href="#__codelineno-21-64"></a><span class="w">        </span><span class="n">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;_isolated&quot;</span><span class="p">;</span>
</span><span id="__span-21-65"><a id="__codelineno-21-65" name="__codelineno-21-65" href="#__codelineno-21-65"></a><span class="w">        </span><span class="n">appid</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">AID_ISOLATED_START</span><span class="p">;</span>
</span><span id="__span-21-66"><a id="__codelineno-21-66" name="__codelineno-21-66" href="#__codelineno-21-66"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-21-67"><a id="__codelineno-21-67" name="__codelineno-21-67" href="#__codelineno-21-67"></a>
</span><span id="__span-21-68"><a id="__codelineno-21-68" name="__codelineno-21-68" href="#__codelineno-21-68"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">appid</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">CAT_MAPPING_MAX_ID</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">userid</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">CAT_MAPPING_MAX_ID</span><span class="p">)</span>
</span><span id="__span-21-69"><a id="__codelineno-21-69" name="__codelineno-21-69" href="#__codelineno-21-69"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span id="__span-21-70"><a id="__codelineno-21-70" name="__codelineno-21-70" href="#__codelineno-21-70"></a>
</span><span id="__span-21-71"><a id="__codelineno-21-71" name="__codelineno-21-71" href="#__codelineno-21-71"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nspec</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="c1">//在seapp_contexts表中进行查找</span>
</span><span id="__span-21-72"><a id="__codelineno-21-72" name="__codelineno-21-72" href="#__codelineno-21-72"></a><span class="w">        </span><span class="n">cur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seapp_contexts</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span id="__span-21-73"><a id="__codelineno-21-73" name="__codelineno-21-73" href="#__codelineno-21-73"></a>
</span><span id="__span-21-74"><a id="__codelineno-21-74" name="__codelineno-21-74" href="#__codelineno-21-74"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">isSystemServer</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">isSystemServer</span><span class="p">)</span><span class="c1">//如果是systemserver进程不做处理</span>
</span><span id="__span-21-75"><a id="__codelineno-21-75" name="__codelineno-21-75" href="#__codelineno-21-75"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-21-76"><a id="__codelineno-21-76" name="__codelineno-21-76" href="#__codelineno-21-76"></a>
</span><span id="__span-21-77"><a id="__codelineno-21-77" name="__codelineno-21-77" href="#__codelineno-21-77"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">isEphemeralAppSet</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">isEphemeralApp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">isEphemeralApp</span><span class="p">)</span>
</span><span id="__span-21-78"><a id="__codelineno-21-78" name="__codelineno-21-78" href="#__codelineno-21-78"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-21-79"><a id="__codelineno-21-79" name="__codelineno-21-79" href="#__codelineno-21-79"></a>
</span><span id="__span-21-80"><a id="__codelineno-21-80" name="__codelineno-21-80" href="#__codelineno-21-80"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">isOwnerSet</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">isOwner</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">isOwner</span><span class="p">)</span>
</span><span id="__span-21-81"><a id="__codelineno-21-81" name="__codelineno-21-81" href="#__codelineno-21-81"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-21-82"><a id="__codelineno-21-82" name="__codelineno-21-82" href="#__codelineno-21-82"></a>
</span><span id="__span-21-83"><a id="__codelineno-21-83" name="__codelineno-21-83" href="#__codelineno-21-83"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">.</span><span class="n">str</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="c1">//先比较文件中的user项和进程的username</span>
</span><span id="__span-21-84"><a id="__codelineno-21-84" name="__codelineno-21-84" href="#__codelineno-21-84"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">.</span><span class="n">is_prefix</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-85"><a id="__codelineno-21-85" name="__codelineno-21-85" href="#__codelineno-21-85"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strncasecmp</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">.</span><span class="n">str</span><span class="p">,</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">.</span><span class="n">len</span><span class="mi">-1</span><span class="p">))</span>
</span><span id="__span-21-86"><a id="__codelineno-21-86" name="__codelineno-21-86" href="#__codelineno-21-86"></a><span class="w">                    </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-21-87"><a id="__codelineno-21-87" name="__codelineno-21-87" href="#__codelineno-21-87"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-88"><a id="__codelineno-21-88" name="__codelineno-21-88" href="#__codelineno-21-88"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">.</span><span class="n">str</span><span class="p">))</span>
</span><span id="__span-21-89"><a id="__codelineno-21-89" name="__codelineno-21-89" href="#__codelineno-21-89"></a><span class="w">                    </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-21-90"><a id="__codelineno-21-90" name="__codelineno-21-90" href="#__codelineno-21-90"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-21-91"><a id="__codelineno-21-91" name="__codelineno-21-91" href="#__codelineno-21-91"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-21-92"><a id="__codelineno-21-92" name="__codelineno-21-92" href="#__codelineno-21-92"></a>
</span><span id="__span-21-93"><a id="__codelineno-21-93" name="__codelineno-21-93" href="#__codelineno-21-93"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">seinfo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="c1">//先比较两者的seinfo是否相同</span>
</span><span id="__span-21-94"><a id="__codelineno-21-94" name="__codelineno-21-94" href="#__codelineno-21-94"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">seinfo</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">seinfo</span><span class="p">,</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">seinfo</span><span class="p">))</span>
</span><span id="__span-21-95"><a id="__codelineno-21-95" name="__codelineno-21-95" href="#__codelineno-21-95"></a><span class="w">                </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-21-96"><a id="__codelineno-21-96" name="__codelineno-21-96" href="#__codelineno-21-96"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-21-97"><a id="__codelineno-21-97" name="__codelineno-21-97" href="#__codelineno-21-97"></a>
</span><span id="__span-21-98"><a id="__codelineno-21-98" name="__codelineno-21-98" href="#__codelineno-21-98"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">.</span><span class="n">str</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="c1">//seapp_contexts中没有哪行定义了name，所以这里不用比较</span>
</span><span id="__span-21-99"><a id="__codelineno-21-99" name="__codelineno-21-99" href="#__codelineno-21-99"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">pkgname</span><span class="p">)</span>
</span><span id="__span-21-100"><a id="__codelineno-21-100" name="__codelineno-21-100" href="#__codelineno-21-100"></a><span class="w">                </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-21-101"><a id="__codelineno-21-101" name="__codelineno-21-101" href="#__codelineno-21-101"></a>
</span><span id="__span-21-102"><a id="__codelineno-21-102" name="__codelineno-21-102" href="#__codelineno-21-102"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">.</span><span class="n">is_prefix</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-103"><a id="__codelineno-21-103" name="__codelineno-21-103" href="#__codelineno-21-103"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strncasecmp</span><span class="p">(</span><span class="n">pkgname</span><span class="p">,</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">.</span><span class="n">str</span><span class="p">,</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">.</span><span class="n">len</span><span class="mi">-1</span><span class="p">))</span>
</span><span id="__span-21-104"><a id="__codelineno-21-104" name="__codelineno-21-104" href="#__codelineno-21-104"></a><span class="w">                    </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-21-105"><a id="__codelineno-21-105" name="__codelineno-21-105" href="#__codelineno-21-105"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-106"><a id="__codelineno-21-106" name="__codelineno-21-106" href="#__codelineno-21-106"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">pkgname</span><span class="p">,</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">.</span><span class="n">str</span><span class="p">))</span>
</span><span id="__span-21-107"><a id="__codelineno-21-107" name="__codelineno-21-107" href="#__codelineno-21-107"></a><span class="w">                    </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-21-108"><a id="__codelineno-21-108" name="__codelineno-21-108" href="#__codelineno-21-108"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-21-109"><a id="__codelineno-21-109" name="__codelineno-21-109" href="#__codelineno-21-109"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-21-110"><a id="__codelineno-21-110" name="__codelineno-21-110" href="#__codelineno-21-110"></a>
</span><span id="__span-21-111"><a id="__codelineno-21-111" name="__codelineno-21-111" href="#__codelineno-21-111"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">isPrivAppSet</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">isPrivApp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">isPrivApp</span><span class="p">)</span><span class="c1">//是否是priv-app</span>
</span><span id="__span-21-112"><a id="__codelineno-21-112" name="__codelineno-21-112" href="#__codelineno-21-112"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-21-113"><a id="__codelineno-21-113" name="__codelineno-21-113" href="#__codelineno-21-113"></a>
</span><span id="__span-21-114"><a id="__codelineno-21-114" name="__codelineno-21-114" href="#__codelineno-21-114"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">minTargetSdkVersion</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">targetSdkVersion</span><span class="p">)</span>
</span><span id="__span-21-115"><a id="__codelineno-21-115" name="__codelineno-21-115" href="#__codelineno-21-115"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-21-116"><a id="__codelineno-21-116" name="__codelineno-21-116" href="#__codelineno-21-116"></a>
</span><span id="__span-21-117"><a id="__codelineno-21-117" name="__codelineno-21-117" href="#__codelineno-21-117"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">fromRunAs</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">fromRunAs</span><span class="p">)</span>
</span><span id="__span-21-118"><a id="__codelineno-21-118" name="__codelineno-21-118" href="#__codelineno-21-118"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-21-119"><a id="__codelineno-21-119" name="__codelineno-21-119" href="#__codelineno-21-119"></a>
</span><span id="__span-21-120"><a id="__codelineno-21-120" name="__codelineno-21-120" href="#__codelineno-21-120"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">str</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-121"><a id="__codelineno-21-121" name="__codelineno-21-121" href="#__codelineno-21-121"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">path</span><span class="p">)</span>
</span><span id="__span-21-122"><a id="__codelineno-21-122" name="__codelineno-21-122" href="#__codelineno-21-122"></a><span class="w">                </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-21-123"><a id="__codelineno-21-123" name="__codelineno-21-123" href="#__codelineno-21-123"></a>
</span><span id="__span-21-124"><a id="__codelineno-21-124" name="__codelineno-21-124" href="#__codelineno-21-124"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">is_prefix</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-125"><a id="__codelineno-21-125" name="__codelineno-21-125" href="#__codelineno-21-125"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">str</span><span class="p">,</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">len</span><span class="mi">-1</span><span class="p">))</span>
</span><span id="__span-21-126"><a id="__codelineno-21-126" name="__codelineno-21-126" href="#__codelineno-21-126"></a><span class="w">                    </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-21-127"><a id="__codelineno-21-127" name="__codelineno-21-127" href="#__codelineno-21-127"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-128"><a id="__codelineno-21-128" name="__codelineno-21-128" href="#__codelineno-21-128"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">str</span><span class="p">))</span>
</span><span id="__span-21-129"><a id="__codelineno-21-129" name="__codelineno-21-129" href="#__codelineno-21-129"></a><span class="w">                    </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-21-130"><a id="__codelineno-21-130" name="__codelineno-21-130" href="#__codelineno-21-130"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-21-131"><a id="__codelineno-21-131" name="__codelineno-21-131" href="#__codelineno-21-131"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-21-132"><a id="__codelineno-21-132" name="__codelineno-21-132" href="#__codelineno-21-132"></a>
</span><span id="__span-21-133"><a id="__codelineno-21-133" name="__codelineno-21-133" href="#__codelineno-21-133"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SEAPP_TYPE</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span><span class="c1">//参数kind等于SEAPP_DOMAIN</span>
</span><span id="__span-21-134"><a id="__codelineno-21-134" name="__codelineno-21-134" href="#__codelineno-21-134"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-21-135"><a id="__codelineno-21-135" name="__codelineno-21-135" href="#__codelineno-21-135"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SEAPP_DOMAIN</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">)</span><span class="c1">//跳过文件中没有domain的项</span>
</span><span id="__span-21-136"><a id="__codelineno-21-136" name="__codelineno-21-136" href="#__codelineno-21-136"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-21-137"><a id="__codelineno-21-137" name="__codelineno-21-137" href="#__codelineno-21-137"></a>
</span><span id="__span-21-138"><a id="__codelineno-21-138" name="__codelineno-21-138" href="#__codelineno-21-138"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SEAPP_TYPE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-139"><a id="__codelineno-21-139" name="__codelineno-21-139" href="#__codelineno-21-139"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">context_type_set</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">))</span>
</span><span id="__span-21-140"><a id="__codelineno-21-140" name="__codelineno-21-140" href="#__codelineno-21-140"></a><span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">oom</span><span class="p">;</span>
</span><span id="__span-21-141"><a id="__codelineno-21-141" name="__codelineno-21-141" href="#__codelineno-21-141"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SEAPP_DOMAIN</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-142"><a id="__codelineno-21-142" name="__codelineno-21-142" href="#__codelineno-21-142"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">context_type_set</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">))</span><span class="c1">//设置安全上下文的域</span>
</span><span id="__span-21-143"><a id="__codelineno-21-143" name="__codelineno-21-143" href="#__codelineno-21-143"></a><span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">oom</span><span class="p">;</span>
</span><span id="__span-21-144"><a id="__codelineno-21-144" name="__codelineno-21-144" href="#__codelineno-21-144"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-21-145"><a id="__codelineno-21-145" name="__codelineno-21-145" href="#__codelineno-21-145"></a>
</span><span id="__span-21-146"><a id="__codelineno-21-146" name="__codelineno-21-146" href="#__codelineno-21-146"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">levelFrom</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">LEVELFROM_NONE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-147"><a id="__codelineno-21-147" name="__codelineno-21-147" href="#__codelineno-21-147"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">set_range_from_level</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">levelFrom</span><span class="p">,</span><span class="w"> </span><span class="n">userid</span><span class="p">,</span><span class="w"> </span><span class="n">appid</span><span class="p">);</span>
</span><span id="__span-21-148"><a id="__codelineno-21-148" name="__codelineno-21-148" href="#__codelineno-21-148"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-149"><a id="__codelineno-21-149" name="__codelineno-21-149" href="#__codelineno-21-149"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
</span><span id="__span-21-150"><a id="__codelineno-21-150" name="__codelineno-21-150" href="#__codelineno-21-150"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-21-151"><a id="__codelineno-21-151" name="__codelineno-21-151" href="#__codelineno-21-151"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-152"><a id="__codelineno-21-152" name="__codelineno-21-152" href="#__codelineno-21-152"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">context_range_set</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">))</span>
</span><span id="__span-21-153"><a id="__codelineno-21-153" name="__codelineno-21-153" href="#__codelineno-21-153"></a><span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">oom</span><span class="p">;</span>
</span><span id="__span-21-154"><a id="__codelineno-21-154" name="__codelineno-21-154" href="#__codelineno-21-154"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-21-155"><a id="__codelineno-21-155" name="__codelineno-21-155" href="#__codelineno-21-155"></a>
</span><span id="__span-21-156"><a id="__codelineno-21-156" name="__codelineno-21-156" href="#__codelineno-21-156"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-21-157"><a id="__codelineno-21-157" name="__codelineno-21-157" href="#__codelineno-21-157"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-21-158"><a id="__codelineno-21-158" name="__codelineno-21-158" href="#__codelineno-21-158"></a>
</span><span id="__span-21-159"><a id="__codelineno-21-159" name="__codelineno-21-159" href="#__codelineno-21-159"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SEAPP_DOMAIN</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">nspec</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-160"><a id="__codelineno-21-160" name="__codelineno-21-160" href="#__codelineno-21-160"></a><span class="w">        </span><span class="cm">/*</span>
</span><span id="__span-21-161"><a id="__codelineno-21-161" name="__codelineno-21-161" href="#__codelineno-21-161"></a><span class="cm">         * No match.</span>
</span><span id="__span-21-162"><a id="__codelineno-21-162" name="__codelineno-21-162" href="#__codelineno-21-162"></a><span class="cm">         * Fail to prevent staying in the zygote&#39;s context.</span>
</span><span id="__span-21-163"><a id="__codelineno-21-163" name="__codelineno-21-163" href="#__codelineno-21-163"></a><span class="cm">         */</span>
</span><span id="__span-21-164"><a id="__codelineno-21-164" name="__codelineno-21-164" href="#__codelineno-21-164"></a><span class="w">        </span><span class="n">selinux_log</span><span class="p">(</span><span class="n">SELINUX_ERROR</span><span class="p">,</span>
</span><span id="__span-21-165"><a id="__codelineno-21-165" name="__codelineno-21-165" href="#__codelineno-21-165"></a><span class="w">                </span><span class="s">&quot;%s:  No match for app with uid %d, seinfo %s, name %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span id="__span-21-166"><a id="__codelineno-21-166" name="__codelineno-21-166" href="#__codelineno-21-166"></a><span class="w">                </span><span class="n">__FUNCTION__</span><span class="p">,</span><span class="w"> </span><span class="n">uid</span><span class="p">,</span><span class="w"> </span><span class="n">seinfo</span><span class="p">,</span><span class="w"> </span><span class="n">pkgname</span><span class="p">);</span>
</span><span id="__span-21-167"><a id="__codelineno-21-167" name="__codelineno-21-167" href="#__codelineno-21-167"></a>
</span><span id="__span-21-168"><a id="__codelineno-21-168" name="__codelineno-21-168" href="#__codelineno-21-168"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">security_getenforce</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-21-169"><a id="__codelineno-21-169" name="__codelineno-21-169" href="#__codelineno-21-169"></a><span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span id="__span-21-170"><a id="__codelineno-21-170" name="__codelineno-21-170" href="#__codelineno-21-170"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-21-171"><a id="__codelineno-21-171" name="__codelineno-21-171" href="#__codelineno-21-171"></a>
</span><span id="__span-21-172"><a id="__codelineno-21-172" name="__codelineno-21-172" href="#__codelineno-21-172"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-21-173"><a id="__codelineno-21-173" name="__codelineno-21-173" href="#__codelineno-21-173"></a><span class="nl">err</span><span class="p">:</span>
</span><span id="__span-21-174"><a id="__codelineno-21-174" name="__codelineno-21-174" href="#__codelineno-21-174"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
</span><span id="__span-21-175"><a id="__codelineno-21-175" name="__codelineno-21-175" href="#__codelineno-21-175"></a><span class="nl">oom</span><span class="p">:</span>
</span><span id="__span-21-176"><a id="__codelineno-21-176" name="__codelineno-21-176" href="#__codelineno-21-176"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">-2</span><span class="p">;</span>
</span><span id="__span-21-177"><a id="__codelineno-21-177" name="__codelineno-21-177" href="#__codelineno-21-177"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>初始化seapp_context（重点分析）；</li>
<li>通过uid获取进程名；</li>
<li>如果进程号小于AID_APP，则通过uid获取进程名；</li>
<li>如果进程号小于AID_ISOLATED_START，说明是普通进程，设置用户名为"_app"；</li>
<li>否则为沙箱进程。</li>
<li>在seapp_contexts表中进行查找；</li>
<li>比较文件中的user项和进程的username；</li>
<li>比较两者的seinfo是否相同；</li>
<li>seapp_contexts中没有哪行定义了name，所以这里不用比较；</li>
<li>是否是priv-app；</li>
<li>最小的TargetSdk是否大于等于当前的TargetSdk。</li>
<li>参数kind等于SEAPP_DOMAIN；</li>
<li>跳过文件中没有domain的项；</li>
<li>设置安全上下文的域。</li>
</ul>
<h4 id="selinux_android_seapp_context_init">selinux_android_seapp_context_init<a class="headerlink" href="#selinux_android_seapp_context_init" title="Permanent link">&para;</a></h4>
<p><div class="language-cpp highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="nl">http</span><span class="p">:</span><span class="c1">//aospxref.com/android-12.0.0_r3/xref/external/selinux/libselinux/src/android/android_platform.c</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="kt">void</span><span class="w"> </span><span class="nf">selinux_android_seapp_context_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="w">    </span><span class="n">__selinux_once</span><span class="p">(</span><span class="n">once</span><span class="p">,</span><span class="w"> </span><span class="n">seapp_context_init</span><span class="p">);</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="p">}</span>
</span></code></pre></div>
从selinux_internal.h可以看到__selinux_once是一个宏，这个宏就很简单了：请注意“参数2”。
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="nl">http</span><span class="p">:</span><span class="c1">//aospxref.com/android-12.0.0_r3/xref/external/selinux/libselinux/src/selinux_internal.h#122</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="cm">/* Call handler iff the first call.  */</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="cp">#define __selinux_once(ONCE_CONTROL, INIT_FUNCTION) \</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="cp">    do {                        \</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="cp">        if (pthread_once != NULL)       \</span>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="cp">            pthread_once (&amp;(ONCE_CONTROL), (INIT_FUNCTION));  \</span>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a><span class="cp">        else if ((ONCE_CONTROL) == PTHREAD_ONCE_INIT) {       \</span>
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a><span class="cp">            INIT_FUNCTION ();       \</span>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="cp">            (ONCE_CONTROL) = 2;     \</span>
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a><span class="cp">        }                   \</span>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a><span class="cp">    } while (0)</span>
</span></code></pre></div></p>
<h5 id="seapp_context_init">seapp_context_init<a class="headerlink" href="#seapp_context_init" title="Permanent link">&para;</a></h5>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="nl">http</span><span class="p">:</span><span class="c1">//aospxref.com/android-12.0.0_r3/xref/external/selinux/libselinux/src/selinux_internal.h#122</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">seapp_context_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="p">{</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="w">        </span><span class="n">selinux_android_seapp_context_reload</span><span class="p">();</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="p">}</span>
</span></code></pre></div>
<h5 id="selinux_android_seapp_context_reload">selinux_android_seapp_context_reload<a class="headerlink" href="#selinux_android_seapp_context_reload" title="Permanent link">&para;</a></h5>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="nl">http</span><span class="p">:</span><span class="c1">//aospxref.com/android-12.0.0_r3/xref/external/selinux/libselinux/src/android/android_platform.c</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="kt">int</span><span class="w"> </span><span class="nf">selinux_android_seapp_context_reload</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="p">{</span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="w">    </span><span class="kt">FILE</span><span class="w"> </span><span class="o">*</span><span class="n">fp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">line_buf</span><span class="p">[</span><span class="n">BUFSIZ</span><span class="p">];</span>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">token</span><span class="p">;</span>
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">lineno</span><span class="p">;</span>
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">seapp_context</span><span class="w"> </span><span class="o">*</span><span class="n">cur</span><span class="p">;</span>
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">saveptr</span><span class="p">;</span>
</span><span id="__span-25-11"><a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">files_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-25-12"><a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
</span><span id="__span-25-13"><a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">seapp_contexts_files</span><span class="p">[</span><span class="n">MAX_FILE_CONTEXT_SIZE</span><span class="p">];</span>
</span><span id="__span-25-14"><a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">seapp_contexts_plat</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-15"><a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">seapp_contexts_plat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">R_OK</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-16"><a id="__codelineno-25-16" name="__codelineno-25-16" href="#__codelineno-25-16"></a><span class="w">            </span><span class="n">seapp_contexts_files</span><span class="p">[</span><span class="n">files_len</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seapp_contexts_plat</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span id="__span-25-17"><a id="__codelineno-25-17" name="__codelineno-25-17" href="#__codelineno-25-17"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-25-18"><a id="__codelineno-25-18" name="__codelineno-25-18" href="#__codelineno-25-18"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-25-19"><a id="__codelineno-25-19" name="__codelineno-25-19" href="#__codelineno-25-19"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-25-20"><a id="__codelineno-25-20" name="__codelineno-25-20" href="#__codelineno-25-20"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">seapp_contexts_system_ext</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-21"><a id="__codelineno-25-21" name="__codelineno-25-21" href="#__codelineno-25-21"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">seapp_contexts_system_ext</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">R_OK</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-22"><a id="__codelineno-25-22" name="__codelineno-25-22" href="#__codelineno-25-22"></a><span class="w">            </span><span class="n">seapp_contexts_files</span><span class="p">[</span><span class="n">files_len</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seapp_contexts_system_ext</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span id="__span-25-23"><a id="__codelineno-25-23" name="__codelineno-25-23" href="#__codelineno-25-23"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-25-24"><a id="__codelineno-25-24" name="__codelineno-25-24" href="#__codelineno-25-24"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-25-25"><a id="__codelineno-25-25" name="__codelineno-25-25" href="#__codelineno-25-25"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-25-26"><a id="__codelineno-25-26" name="__codelineno-25-26" href="#__codelineno-25-26"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">seapp_contexts_product</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-27"><a id="__codelineno-25-27" name="__codelineno-25-27" href="#__codelineno-25-27"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">seapp_contexts_product</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">R_OK</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-28"><a id="__codelineno-25-28" name="__codelineno-25-28" href="#__codelineno-25-28"></a><span class="w">            </span><span class="n">seapp_contexts_files</span><span class="p">[</span><span class="n">files_len</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seapp_contexts_product</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span id="__span-25-29"><a id="__codelineno-25-29" name="__codelineno-25-29" href="#__codelineno-25-29"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-25-30"><a id="__codelineno-25-30" name="__codelineno-25-30" href="#__codelineno-25-30"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-25-31"><a id="__codelineno-25-31" name="__codelineno-25-31" href="#__codelineno-25-31"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-25-32"><a id="__codelineno-25-32" name="__codelineno-25-32" href="#__codelineno-25-32"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">seapp_contexts_vendor</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-33"><a id="__codelineno-25-33" name="__codelineno-25-33" href="#__codelineno-25-33"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">seapp_contexts_vendor</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">R_OK</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-34"><a id="__codelineno-25-34" name="__codelineno-25-34" href="#__codelineno-25-34"></a><span class="w">            </span><span class="n">seapp_contexts_files</span><span class="p">[</span><span class="n">files_len</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seapp_contexts_vendor</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span id="__span-25-35"><a id="__codelineno-25-35" name="__codelineno-25-35" href="#__codelineno-25-35"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-25-36"><a id="__codelineno-25-36" name="__codelineno-25-36" href="#__codelineno-25-36"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-25-37"><a id="__codelineno-25-37" name="__codelineno-25-37" href="#__codelineno-25-37"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-25-38"><a id="__codelineno-25-38" name="__codelineno-25-38" href="#__codelineno-25-38"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">seapp_contexts_odm</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-39"><a id="__codelineno-25-39" name="__codelineno-25-39" href="#__codelineno-25-39"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">seapp_contexts_odm</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">R_OK</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-40"><a id="__codelineno-25-40" name="__codelineno-25-40" href="#__codelineno-25-40"></a><span class="w">            </span><span class="n">seapp_contexts_files</span><span class="p">[</span><span class="n">files_len</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seapp_contexts_odm</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span id="__span-25-41"><a id="__codelineno-25-41" name="__codelineno-25-41" href="#__codelineno-25-41"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-25-42"><a id="__codelineno-25-42" name="__codelineno-25-42" href="#__codelineno-25-42"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-25-43"><a id="__codelineno-25-43" name="__codelineno-25-43" href="#__codelineno-25-43"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-25-44"><a id="__codelineno-25-44" name="__codelineno-25-44" href="#__codelineno-25-44"></a>
</span><span id="__span-25-45"><a id="__codelineno-25-45" name="__codelineno-25-45" href="#__codelineno-25-45"></a><span class="w">    </span><span class="n">free_seapp_contexts</span><span class="p">();</span>
</span><span id="__span-25-46"><a id="__codelineno-25-46" name="__codelineno-25-46" href="#__codelineno-25-46"></a>
</span><span id="__span-25-47"><a id="__codelineno-25-47" name="__codelineno-25-47" href="#__codelineno-25-47"></a><span class="w">    </span><span class="n">nspec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-25-48"><a id="__codelineno-25-48" name="__codelineno-25-48" href="#__codelineno-25-48"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">files_len</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-49"><a id="__codelineno-25-49" name="__codelineno-25-49" href="#__codelineno-25-49"></a><span class="w">        </span><span class="n">fp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fopen</span><span class="p">(</span><span class="n">seapp_contexts_files</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;re&quot;</span><span class="p">);</span>
</span><span id="__span-25-50"><a id="__codelineno-25-50" name="__codelineno-25-50" href="#__codelineno-25-50"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-51"><a id="__codelineno-25-51" name="__codelineno-25-51" href="#__codelineno-25-51"></a><span class="w">            </span><span class="n">selinux_log</span><span class="p">(</span><span class="n">SELINUX_ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s:  could not open seapp_contexts file: %s&quot;</span><span class="p">,</span>
</span><span id="__span-25-52"><a id="__codelineno-25-52" name="__codelineno-25-52" href="#__codelineno-25-52"></a><span class="w">                    </span><span class="n">__FUNCTION__</span><span class="p">,</span><span class="w"> </span><span class="n">seapp_contexts_files</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span id="__span-25-53"><a id="__codelineno-25-53" name="__codelineno-25-53" href="#__codelineno-25-53"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
</span><span id="__span-25-54"><a id="__codelineno-25-54" name="__codelineno-25-54" href="#__codelineno-25-54"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-25-55"><a id="__codelineno-25-55" name="__codelineno-25-55" href="#__codelineno-25-55"></a><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">fgets</span><span class="p">(</span><span class="n">line_buf</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="n">line_buf</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">fp</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-56"><a id="__codelineno-25-56" name="__codelineno-25-56" href="#__codelineno-25-56"></a><span class="w">            </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">line_buf</span><span class="p">;</span>
</span><span id="__span-25-57"><a id="__codelineno-25-57" name="__codelineno-25-57" href="#__codelineno-25-57"></a><span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">))</span>
</span><span id="__span-25-58"><a id="__codelineno-25-58" name="__codelineno-25-58" href="#__codelineno-25-58"></a><span class="w">                </span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-25-59"><a id="__codelineno-25-59" name="__codelineno-25-59" href="#__codelineno-25-59"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;#&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-25-60"><a id="__codelineno-25-60" name="__codelineno-25-60" href="#__codelineno-25-60"></a><span class="w">                </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-25-61"><a id="__codelineno-25-61" name="__codelineno-25-61" href="#__codelineno-25-61"></a><span class="w">            </span><span class="n">nspec</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-25-62"><a id="__codelineno-25-62" name="__codelineno-25-62" href="#__codelineno-25-62"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-25-63"><a id="__codelineno-25-63" name="__codelineno-25-63" href="#__codelineno-25-63"></a><span class="w">        </span><span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span><span id="__span-25-64"><a id="__codelineno-25-64" name="__codelineno-25-64" href="#__codelineno-25-64"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-25-65"><a id="__codelineno-25-65" name="__codelineno-25-65" href="#__codelineno-25-65"></a>
</span><span id="__span-25-66"><a id="__codelineno-25-66" name="__codelineno-25-66" href="#__codelineno-25-66"></a><span class="w">    </span><span class="n">seapp_contexts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">seapp_context</span><span class="w"> </span><span class="o">**</span><span class="p">)</span><span class="w"> </span><span class="n">calloc</span><span class="p">(</span><span class="n">nspec</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">seapp_context</span><span class="w"> </span><span class="o">*</span><span class="p">));</span>
</span><span id="__span-25-67"><a id="__codelineno-25-67" name="__codelineno-25-67" href="#__codelineno-25-67"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">seapp_contexts</span><span class="p">)</span>
</span><span id="__span-25-68"><a id="__codelineno-25-68" name="__codelineno-25-68" href="#__codelineno-25-68"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">oom</span><span class="p">;</span>
</span><span id="__span-25-69"><a id="__codelineno-25-69" name="__codelineno-25-69" href="#__codelineno-25-69"></a>
</span><span id="__span-25-70"><a id="__codelineno-25-70" name="__codelineno-25-70" href="#__codelineno-25-70"></a><span class="w">    </span><span class="n">nspec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-25-71"><a id="__codelineno-25-71" name="__codelineno-25-71" href="#__codelineno-25-71"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">files_len</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-72"><a id="__codelineno-25-72" name="__codelineno-25-72" href="#__codelineno-25-72"></a><span class="w">        </span><span class="n">lineno</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-25-73"><a id="__codelineno-25-73" name="__codelineno-25-73" href="#__codelineno-25-73"></a><span class="w">        </span><span class="n">fp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fopen</span><span class="p">(</span><span class="n">seapp_contexts_files</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;re&quot;</span><span class="p">);</span>
</span><span id="__span-25-74"><a id="__codelineno-25-74" name="__codelineno-25-74" href="#__codelineno-25-74"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-75"><a id="__codelineno-25-75" name="__codelineno-25-75" href="#__codelineno-25-75"></a><span class="w">            </span><span class="n">selinux_log</span><span class="p">(</span><span class="n">SELINUX_ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s:  could not open seapp_contexts file: %s&quot;</span><span class="p">,</span>
</span><span id="__span-25-76"><a id="__codelineno-25-76" name="__codelineno-25-76" href="#__codelineno-25-76"></a><span class="w">                    </span><span class="n">__FUNCTION__</span><span class="p">,</span><span class="w"> </span><span class="n">seapp_contexts_files</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span id="__span-25-77"><a id="__codelineno-25-77" name="__codelineno-25-77" href="#__codelineno-25-77"></a><span class="w">            </span><span class="n">free_seapp_contexts</span><span class="p">();</span>
</span><span id="__span-25-78"><a id="__codelineno-25-78" name="__codelineno-25-78" href="#__codelineno-25-78"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
</span><span id="__span-25-79"><a id="__codelineno-25-79" name="__codelineno-25-79" href="#__codelineno-25-79"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-25-80"><a id="__codelineno-25-80" name="__codelineno-25-80" href="#__codelineno-25-80"></a><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">fgets</span><span class="p">(</span><span class="n">line_buf</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="n">line_buf</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">fp</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-81"><a id="__codelineno-25-81" name="__codelineno-25-81" href="#__codelineno-25-81"></a><span class="w">            </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">line_buf</span><span class="p">);</span>
</span><span id="__span-25-82"><a id="__codelineno-25-82" name="__codelineno-25-82" href="#__codelineno-25-82"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-83"><a id="__codelineno-25-83" name="__codelineno-25-83" href="#__codelineno-25-83"></a><span class="w">                </span><span class="c1">// line contains a NUL byte as its first entry</span>
</span><span id="__span-25-84"><a id="__codelineno-25-84" name="__codelineno-25-84" href="#__codelineno-25-84"></a><span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span id="__span-25-85"><a id="__codelineno-25-85" name="__codelineno-25-85" href="#__codelineno-25-85"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-25-86"><a id="__codelineno-25-86" name="__codelineno-25-86" href="#__codelineno-25-86"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">line_buf</span><span class="p">[</span><span class="n">len</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;\n&#39;</span><span class="p">)</span>
</span><span id="__span-25-87"><a id="__codelineno-25-87" name="__codelineno-25-87" href="#__codelineno-25-87"></a><span class="w">                </span><span class="n">line_buf</span><span class="p">[</span><span class="n">len</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-25-88"><a id="__codelineno-25-88" name="__codelineno-25-88" href="#__codelineno-25-88"></a><span class="w">            </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">line_buf</span><span class="p">;</span>
</span><span id="__span-25-89"><a id="__codelineno-25-89" name="__codelineno-25-89" href="#__codelineno-25-89"></a><span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">))</span>
</span><span id="__span-25-90"><a id="__codelineno-25-90" name="__codelineno-25-90" href="#__codelineno-25-90"></a><span class="w">                </span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-25-91"><a id="__codelineno-25-91" name="__codelineno-25-91" href="#__codelineno-25-91"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;#&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-25-92"><a id="__codelineno-25-92" name="__codelineno-25-92" href="#__codelineno-25-92"></a><span class="w">                </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-25-93"><a id="__codelineno-25-93" name="__codelineno-25-93" href="#__codelineno-25-93"></a>
</span><span id="__span-25-94"><a id="__codelineno-25-94" name="__codelineno-25-94" href="#__codelineno-25-94"></a><span class="w">            </span><span class="n">cur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">seapp_context</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">seapp_context</span><span class="p">));</span>
</span><span id="__span-25-95"><a id="__codelineno-25-95" name="__codelineno-25-95" href="#__codelineno-25-95"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cur</span><span class="p">)</span>
</span><span id="__span-25-96"><a id="__codelineno-25-96" name="__codelineno-25-96" href="#__codelineno-25-96"></a><span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">oom</span><span class="p">;</span>
</span><span id="__span-25-97"><a id="__codelineno-25-97" name="__codelineno-25-97" href="#__codelineno-25-97"></a>
</span><span id="__span-25-98"><a id="__codelineno-25-98" name="__codelineno-25-98" href="#__codelineno-25-98"></a><span class="w">            </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strtok_r</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="s">&quot; </span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">saveptr</span><span class="p">);</span>
</span><span id="__span-25-99"><a id="__codelineno-25-99" name="__codelineno-25-99" href="#__codelineno-25-99"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">token</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-100"><a id="__codelineno-25-100" name="__codelineno-25-100" href="#__codelineno-25-100"></a><span class="w">                </span><span class="n">free_seapp_context</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
</span><span id="__span-25-101"><a id="__codelineno-25-101" name="__codelineno-25-101" href="#__codelineno-25-101"></a><span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span id="__span-25-102"><a id="__codelineno-25-102" name="__codelineno-25-102" href="#__codelineno-25-102"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-25-103"><a id="__codelineno-25-103" name="__codelineno-25-103" href="#__codelineno-25-103"></a>
</span><span id="__span-25-104"><a id="__codelineno-25-104" name="__codelineno-25-104" href="#__codelineno-25-104"></a><span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-105"><a id="__codelineno-25-105" name="__codelineno-25-105" href="#__codelineno-25-105"></a><span class="w">                </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">token</span><span class="p">;</span>
</span><span id="__span-25-106"><a id="__codelineno-25-106" name="__codelineno-25-106" href="#__codelineno-25-106"></a><span class="w">                </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strchr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;=&#39;</span><span class="p">);</span>
</span><span id="__span-25-107"><a id="__codelineno-25-107" name="__codelineno-25-107" href="#__codelineno-25-107"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-108"><a id="__codelineno-25-108" name="__codelineno-25-108" href="#__codelineno-25-108"></a><span class="w">                    </span><span class="n">free_seapp_context</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
</span><span id="__span-25-109"><a id="__codelineno-25-109" name="__codelineno-25-109" href="#__codelineno-25-109"></a><span class="w">                    </span><span class="k">goto</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span id="__span-25-110"><a id="__codelineno-25-110" name="__codelineno-25-110" href="#__codelineno-25-110"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-25-111"><a id="__codelineno-25-111" name="__codelineno-25-111" href="#__codelineno-25-111"></a><span class="w">                </span><span class="o">*</span><span class="n">value</span><span class="o">++</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-25-112"><a id="__codelineno-25-112" name="__codelineno-25-112" href="#__codelineno-25-112"></a>
</span><span id="__span-25-113"><a id="__codelineno-25-113" name="__codelineno-25-113" href="#__codelineno-25-113"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;isSystemServer&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-114"><a id="__codelineno-25-114" name="__codelineno-25-114" href="#__codelineno-25-114"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="p">))</span>
</span><span id="__span-25-115"><a id="__codelineno-25-115" name="__codelineno-25-115" href="#__codelineno-25-115"></a><span class="w">                        </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">isSystemServer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
</span><span id="__span-25-116"><a id="__codelineno-25-116" name="__codelineno-25-116" href="#__codelineno-25-116"></a><span class="w">                    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;false&quot;</span><span class="p">))</span>
</span><span id="__span-25-117"><a id="__codelineno-25-117" name="__codelineno-25-117" href="#__codelineno-25-117"></a><span class="w">                        </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">isSystemServer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
</span><span id="__span-25-118"><a id="__codelineno-25-118" name="__codelineno-25-118" href="#__codelineno-25-118"></a><span class="w">                    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-119"><a id="__codelineno-25-119" name="__codelineno-25-119" href="#__codelineno-25-119"></a><span class="w">                        </span><span class="n">free_seapp_context</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
</span><span id="__span-25-120"><a id="__codelineno-25-120" name="__codelineno-25-120" href="#__codelineno-25-120"></a><span class="w">                        </span><span class="k">goto</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span id="__span-25-121"><a id="__codelineno-25-121" name="__codelineno-25-121" href="#__codelineno-25-121"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-25-122"><a id="__codelineno-25-122" name="__codelineno-25-122" href="#__codelineno-25-122"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;isEphemeralApp&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-123"><a id="__codelineno-25-123" name="__codelineno-25-123" href="#__codelineno-25-123"></a><span class="w">                    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">isEphemeralAppSet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
</span><span id="__span-25-124"><a id="__codelineno-25-124" name="__codelineno-25-124" href="#__codelineno-25-124"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="p">))</span>
</span><span id="__span-25-125"><a id="__codelineno-25-125" name="__codelineno-25-125" href="#__codelineno-25-125"></a><span class="w">                        </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">isEphemeralApp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
</span><span id="__span-25-126"><a id="__codelineno-25-126" name="__codelineno-25-126" href="#__codelineno-25-126"></a><span class="w">                    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;false&quot;</span><span class="p">))</span>
</span><span id="__span-25-127"><a id="__codelineno-25-127" name="__codelineno-25-127" href="#__codelineno-25-127"></a><span class="w">                        </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">isEphemeralApp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
</span><span id="__span-25-128"><a id="__codelineno-25-128" name="__codelineno-25-128" href="#__codelineno-25-128"></a><span class="w">                    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-129"><a id="__codelineno-25-129" name="__codelineno-25-129" href="#__codelineno-25-129"></a><span class="w">                        </span><span class="n">free_seapp_context</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
</span><span id="__span-25-130"><a id="__codelineno-25-130" name="__codelineno-25-130" href="#__codelineno-25-130"></a><span class="w">                        </span><span class="k">goto</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span id="__span-25-131"><a id="__codelineno-25-131" name="__codelineno-25-131" href="#__codelineno-25-131"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-25-132"><a id="__codelineno-25-132" name="__codelineno-25-132" href="#__codelineno-25-132"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;isOwner&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-133"><a id="__codelineno-25-133" name="__codelineno-25-133" href="#__codelineno-25-133"></a><span class="w">                    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">isOwnerSet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
</span><span id="__span-25-134"><a id="__codelineno-25-134" name="__codelineno-25-134" href="#__codelineno-25-134"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="p">))</span>
</span><span id="__span-25-135"><a id="__codelineno-25-135" name="__codelineno-25-135" href="#__codelineno-25-135"></a><span class="w">                        </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">isOwner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
</span><span id="__span-25-136"><a id="__codelineno-25-136" name="__codelineno-25-136" href="#__codelineno-25-136"></a><span class="w">                    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;false&quot;</span><span class="p">))</span>
</span><span id="__span-25-137"><a id="__codelineno-25-137" name="__codelineno-25-137" href="#__codelineno-25-137"></a><span class="w">                        </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">isOwner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
</span><span id="__span-25-138"><a id="__codelineno-25-138" name="__codelineno-25-138" href="#__codelineno-25-138"></a><span class="w">                    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-139"><a id="__codelineno-25-139" name="__codelineno-25-139" href="#__codelineno-25-139"></a><span class="w">                        </span><span class="n">free_seapp_context</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
</span><span id="__span-25-140"><a id="__codelineno-25-140" name="__codelineno-25-140" href="#__codelineno-25-140"></a><span class="w">                        </span><span class="k">goto</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span id="__span-25-141"><a id="__codelineno-25-141" name="__codelineno-25-141" href="#__codelineno-25-141"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-25-142"><a id="__codelineno-25-142" name="__codelineno-25-142" href="#__codelineno-25-142"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;user&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-143"><a id="__codelineno-25-143" name="__codelineno-25-143" href="#__codelineno-25-143"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">.</span><span class="n">str</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-144"><a id="__codelineno-25-144" name="__codelineno-25-144" href="#__codelineno-25-144"></a><span class="w">                        </span><span class="n">free_seapp_context</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
</span><span id="__span-25-145"><a id="__codelineno-25-145" name="__codelineno-25-145" href="#__codelineno-25-145"></a><span class="w">                        </span><span class="k">goto</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span id="__span-25-146"><a id="__codelineno-25-146" name="__codelineno-25-146" href="#__codelineno-25-146"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-25-147"><a id="__codelineno-25-147" name="__codelineno-25-147" href="#__codelineno-25-147"></a><span class="w">                    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">.</span><span class="n">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strdup</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
</span><span id="__span-25-148"><a id="__codelineno-25-148" name="__codelineno-25-148" href="#__codelineno-25-148"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">.</span><span class="n">str</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-149"><a id="__codelineno-25-149" name="__codelineno-25-149" href="#__codelineno-25-149"></a><span class="w">                        </span><span class="n">free_seapp_context</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
</span><span id="__span-25-150"><a id="__codelineno-25-150" name="__codelineno-25-150" href="#__codelineno-25-150"></a><span class="w">                        </span><span class="k">goto</span><span class="w"> </span><span class="n">oom</span><span class="p">;</span>
</span><span id="__span-25-151"><a id="__codelineno-25-151" name="__codelineno-25-151" href="#__codelineno-25-151"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-25-152"><a id="__codelineno-25-152" name="__codelineno-25-152" href="#__codelineno-25-152"></a><span class="w">                    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">.</span><span class="n">str</span><span class="p">);</span>
</span><span id="__span-25-153"><a id="__codelineno-25-153" name="__codelineno-25-153" href="#__codelineno-25-153"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">.</span><span class="n">str</span><span class="p">[</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">.</span><span class="n">len</span><span class="mi">-1</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;*&#39;</span><span class="p">)</span>
</span><span id="__span-25-154"><a id="__codelineno-25-154" name="__codelineno-25-154" href="#__codelineno-25-154"></a><span class="w">                        </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">.</span><span class="n">is_prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-25-155"><a id="__codelineno-25-155" name="__codelineno-25-155" href="#__codelineno-25-155"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;seinfo&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-156"><a id="__codelineno-25-156" name="__codelineno-25-156" href="#__codelineno-25-156"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">seinfo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-157"><a id="__codelineno-25-157" name="__codelineno-25-157" href="#__codelineno-25-157"></a><span class="w">                        </span><span class="n">free_seapp_context</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
</span><span id="__span-25-158"><a id="__codelineno-25-158" name="__codelineno-25-158" href="#__codelineno-25-158"></a><span class="w">                        </span><span class="k">goto</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span id="__span-25-159"><a id="__codelineno-25-159" name="__codelineno-25-159" href="#__codelineno-25-159"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-25-160"><a id="__codelineno-25-160" name="__codelineno-25-160" href="#__codelineno-25-160"></a><span class="w">                    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">seinfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strdup</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
</span><span id="__span-25-161"><a id="__codelineno-25-161" name="__codelineno-25-161" href="#__codelineno-25-161"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">seinfo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-162"><a id="__codelineno-25-162" name="__codelineno-25-162" href="#__codelineno-25-162"></a><span class="w">                        </span><span class="n">free_seapp_context</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
</span><span id="__span-25-163"><a id="__codelineno-25-163" name="__codelineno-25-163" href="#__codelineno-25-163"></a><span class="w">                        </span><span class="k">goto</span><span class="w"> </span><span class="n">oom</span><span class="p">;</span>
</span><span id="__span-25-164"><a id="__codelineno-25-164" name="__codelineno-25-164" href="#__codelineno-25-164"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-25-165"><a id="__codelineno-25-165" name="__codelineno-25-165" href="#__codelineno-25-165"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;:&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-166"><a id="__codelineno-25-166" name="__codelineno-25-166" href="#__codelineno-25-166"></a><span class="w">                        </span><span class="n">free_seapp_context</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
</span><span id="__span-25-167"><a id="__codelineno-25-167" name="__codelineno-25-167" href="#__codelineno-25-167"></a><span class="w">                        </span><span class="k">goto</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span id="__span-25-168"><a id="__codelineno-25-168" name="__codelineno-25-168" href="#__codelineno-25-168"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-25-169"><a id="__codelineno-25-169" name="__codelineno-25-169" href="#__codelineno-25-169"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;name&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-170"><a id="__codelineno-25-170" name="__codelineno-25-170" href="#__codelineno-25-170"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">.</span><span class="n">str</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-171"><a id="__codelineno-25-171" name="__codelineno-25-171" href="#__codelineno-25-171"></a><span class="w">                        </span><span class="n">free_seapp_context</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
</span><span id="__span-25-172"><a id="__codelineno-25-172" name="__codelineno-25-172" href="#__codelineno-25-172"></a><span class="w">                        </span><span class="k">goto</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span id="__span-25-173"><a id="__codelineno-25-173" name="__codelineno-25-173" href="#__codelineno-25-173"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-25-174"><a id="__codelineno-25-174" name="__codelineno-25-174" href="#__codelineno-25-174"></a><span class="w">                    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">.</span><span class="n">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strdup</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
</span><span id="__span-25-175"><a id="__codelineno-25-175" name="__codelineno-25-175" href="#__codelineno-25-175"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">.</span><span class="n">str</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-176"><a id="__codelineno-25-176" name="__codelineno-25-176" href="#__codelineno-25-176"></a><span class="w">                        </span><span class="n">free_seapp_context</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
</span><span id="__span-25-177"><a id="__codelineno-25-177" name="__codelineno-25-177" href="#__codelineno-25-177"></a><span class="w">                        </span><span class="k">goto</span><span class="w"> </span><span class="n">oom</span><span class="p">;</span>
</span><span id="__span-25-178"><a id="__codelineno-25-178" name="__codelineno-25-178" href="#__codelineno-25-178"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-25-179"><a id="__codelineno-25-179" name="__codelineno-25-179" href="#__codelineno-25-179"></a><span class="w">                    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">.</span><span class="n">str</span><span class="p">);</span>
</span><span id="__span-25-180"><a id="__codelineno-25-180" name="__codelineno-25-180" href="#__codelineno-25-180"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">.</span><span class="n">str</span><span class="p">[</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">.</span><span class="n">len</span><span class="mi">-1</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;*&#39;</span><span class="p">)</span>
</span><span id="__span-25-181"><a id="__codelineno-25-181" name="__codelineno-25-181" href="#__codelineno-25-181"></a><span class="w">                        </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">.</span><span class="n">is_prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-25-182"><a id="__codelineno-25-182" name="__codelineno-25-182" href="#__codelineno-25-182"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;domain&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-183"><a id="__codelineno-25-183" name="__codelineno-25-183" href="#__codelineno-25-183"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-184"><a id="__codelineno-25-184" name="__codelineno-25-184" href="#__codelineno-25-184"></a><span class="w">                        </span><span class="n">free_seapp_context</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
</span><span id="__span-25-185"><a id="__codelineno-25-185" name="__codelineno-25-185" href="#__codelineno-25-185"></a><span class="w">                        </span><span class="k">goto</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span id="__span-25-186"><a id="__codelineno-25-186" name="__codelineno-25-186" href="#__codelineno-25-186"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-25-187"><a id="__codelineno-25-187" name="__codelineno-25-187" href="#__codelineno-25-187"></a><span class="w">                    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">domain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strdup</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
</span><span id="__span-25-188"><a id="__codelineno-25-188" name="__codelineno-25-188" href="#__codelineno-25-188"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-189"><a id="__codelineno-25-189" name="__codelineno-25-189" href="#__codelineno-25-189"></a><span class="w">                        </span><span class="n">free_seapp_context</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
</span><span id="__span-25-190"><a id="__codelineno-25-190" name="__codelineno-25-190" href="#__codelineno-25-190"></a><span class="w">                        </span><span class="k">goto</span><span class="w"> </span><span class="n">oom</span><span class="p">;</span>
</span><span id="__span-25-191"><a id="__codelineno-25-191" name="__codelineno-25-191" href="#__codelineno-25-191"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-25-192"><a id="__codelineno-25-192" name="__codelineno-25-192" href="#__codelineno-25-192"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;type&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-193"><a id="__codelineno-25-193" name="__codelineno-25-193" href="#__codelineno-25-193"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-194"><a id="__codelineno-25-194" name="__codelineno-25-194" href="#__codelineno-25-194"></a><span class="w">                        </span><span class="n">free_seapp_context</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
</span><span id="__span-25-195"><a id="__codelineno-25-195" name="__codelineno-25-195" href="#__codelineno-25-195"></a><span class="w">                        </span><span class="k">goto</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span id="__span-25-196"><a id="__codelineno-25-196" name="__codelineno-25-196" href="#__codelineno-25-196"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-25-197"><a id="__codelineno-25-197" name="__codelineno-25-197" href="#__codelineno-25-197"></a><span class="w">                    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strdup</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
</span><span id="__span-25-198"><a id="__codelineno-25-198" name="__codelineno-25-198" href="#__codelineno-25-198"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-199"><a id="__codelineno-25-199" name="__codelineno-25-199" href="#__codelineno-25-199"></a><span class="w">                        </span><span class="n">free_seapp_context</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
</span><span id="__span-25-200"><a id="__codelineno-25-200" name="__codelineno-25-200" href="#__codelineno-25-200"></a><span class="w">                        </span><span class="k">goto</span><span class="w"> </span><span class="n">oom</span><span class="p">;</span>
</span><span id="__span-25-201"><a id="__codelineno-25-201" name="__codelineno-25-201" href="#__codelineno-25-201"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-25-202"><a id="__codelineno-25-202" name="__codelineno-25-202" href="#__codelineno-25-202"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;levelFromUid&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-203"><a id="__codelineno-25-203" name="__codelineno-25-203" href="#__codelineno-25-203"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">levelFrom</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-204"><a id="__codelineno-25-204" name="__codelineno-25-204" href="#__codelineno-25-204"></a><span class="w">                        </span><span class="n">free_seapp_context</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
</span><span id="__span-25-205"><a id="__codelineno-25-205" name="__codelineno-25-205" href="#__codelineno-25-205"></a><span class="w">                        </span><span class="k">goto</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span id="__span-25-206"><a id="__codelineno-25-206" name="__codelineno-25-206" href="#__codelineno-25-206"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-25-207"><a id="__codelineno-25-207" name="__codelineno-25-207" href="#__codelineno-25-207"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="p">))</span>
</span><span id="__span-25-208"><a id="__codelineno-25-208" name="__codelineno-25-208" href="#__codelineno-25-208"></a><span class="w">                        </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">levelFrom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LEVELFROM_APP</span><span class="p">;</span>
</span><span id="__span-25-209"><a id="__codelineno-25-209" name="__codelineno-25-209" href="#__codelineno-25-209"></a><span class="w">                    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;false&quot;</span><span class="p">))</span>
</span><span id="__span-25-210"><a id="__codelineno-25-210" name="__codelineno-25-210" href="#__codelineno-25-210"></a><span class="w">                        </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">levelFrom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LEVELFROM_NONE</span><span class="p">;</span>
</span><span id="__span-25-211"><a id="__codelineno-25-211" name="__codelineno-25-211" href="#__codelineno-25-211"></a><span class="w">                    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-212"><a id="__codelineno-25-212" name="__codelineno-25-212" href="#__codelineno-25-212"></a><span class="w">                        </span><span class="n">free_seapp_context</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
</span><span id="__span-25-213"><a id="__codelineno-25-213" name="__codelineno-25-213" href="#__codelineno-25-213"></a><span class="w">                        </span><span class="k">goto</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span id="__span-25-214"><a id="__codelineno-25-214" name="__codelineno-25-214" href="#__codelineno-25-214"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-25-215"><a id="__codelineno-25-215" name="__codelineno-25-215" href="#__codelineno-25-215"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;levelFrom&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-216"><a id="__codelineno-25-216" name="__codelineno-25-216" href="#__codelineno-25-216"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">levelFrom</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-217"><a id="__codelineno-25-217" name="__codelineno-25-217" href="#__codelineno-25-217"></a><span class="w">                        </span><span class="n">free_seapp_context</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
</span><span id="__span-25-218"><a id="__codelineno-25-218" name="__codelineno-25-218" href="#__codelineno-25-218"></a><span class="w">                        </span><span class="k">goto</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span id="__span-25-219"><a id="__codelineno-25-219" name="__codelineno-25-219" href="#__codelineno-25-219"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-25-220"><a id="__codelineno-25-220" name="__codelineno-25-220" href="#__codelineno-25-220"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;none&quot;</span><span class="p">))</span>
</span><span id="__span-25-221"><a id="__codelineno-25-221" name="__codelineno-25-221" href="#__codelineno-25-221"></a><span class="w">                        </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">levelFrom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LEVELFROM_NONE</span><span class="p">;</span>
</span><span id="__span-25-222"><a id="__codelineno-25-222" name="__codelineno-25-222" href="#__codelineno-25-222"></a><span class="w">                    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;app&quot;</span><span class="p">))</span>
</span><span id="__span-25-223"><a id="__codelineno-25-223" name="__codelineno-25-223" href="#__codelineno-25-223"></a><span class="w">                        </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">levelFrom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LEVELFROM_APP</span><span class="p">;</span>
</span><span id="__span-25-224"><a id="__codelineno-25-224" name="__codelineno-25-224" href="#__codelineno-25-224"></a><span class="w">                    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;user&quot;</span><span class="p">))</span>
</span><span id="__span-25-225"><a id="__codelineno-25-225" name="__codelineno-25-225" href="#__codelineno-25-225"></a><span class="w">                        </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">levelFrom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LEVELFROM_USER</span><span class="p">;</span>
</span><span id="__span-25-226"><a id="__codelineno-25-226" name="__codelineno-25-226" href="#__codelineno-25-226"></a><span class="w">                    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;all&quot;</span><span class="p">))</span>
</span><span id="__span-25-227"><a id="__codelineno-25-227" name="__codelineno-25-227" href="#__codelineno-25-227"></a><span class="w">                        </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">levelFrom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LEVELFROM_ALL</span><span class="p">;</span>
</span><span id="__span-25-228"><a id="__codelineno-25-228" name="__codelineno-25-228" href="#__codelineno-25-228"></a><span class="w">                    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-229"><a id="__codelineno-25-229" name="__codelineno-25-229" href="#__codelineno-25-229"></a><span class="w">                        </span><span class="n">free_seapp_context</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
</span><span id="__span-25-230"><a id="__codelineno-25-230" name="__codelineno-25-230" href="#__codelineno-25-230"></a><span class="w">                        </span><span class="k">goto</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span id="__span-25-231"><a id="__codelineno-25-231" name="__codelineno-25-231" href="#__codelineno-25-231"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-25-232"><a id="__codelineno-25-232" name="__codelineno-25-232" href="#__codelineno-25-232"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;level&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-233"><a id="__codelineno-25-233" name="__codelineno-25-233" href="#__codelineno-25-233"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-234"><a id="__codelineno-25-234" name="__codelineno-25-234" href="#__codelineno-25-234"></a><span class="w">                        </span><span class="n">free_seapp_context</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
</span><span id="__span-25-235"><a id="__codelineno-25-235" name="__codelineno-25-235" href="#__codelineno-25-235"></a><span class="w">                        </span><span class="k">goto</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span id="__span-25-236"><a id="__codelineno-25-236" name="__codelineno-25-236" href="#__codelineno-25-236"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-25-237"><a id="__codelineno-25-237" name="__codelineno-25-237" href="#__codelineno-25-237"></a><span class="w">                    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strdup</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
</span><span id="__span-25-238"><a id="__codelineno-25-238" name="__codelineno-25-238" href="#__codelineno-25-238"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-239"><a id="__codelineno-25-239" name="__codelineno-25-239" href="#__codelineno-25-239"></a><span class="w">                        </span><span class="n">free_seapp_context</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
</span><span id="__span-25-240"><a id="__codelineno-25-240" name="__codelineno-25-240" href="#__codelineno-25-240"></a><span class="w">                        </span><span class="k">goto</span><span class="w"> </span><span class="n">oom</span><span class="p">;</span>
</span><span id="__span-25-241"><a id="__codelineno-25-241" name="__codelineno-25-241" href="#__codelineno-25-241"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-25-242"><a id="__codelineno-25-242" name="__codelineno-25-242" href="#__codelineno-25-242"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;path&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-243"><a id="__codelineno-25-243" name="__codelineno-25-243" href="#__codelineno-25-243"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">str</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-244"><a id="__codelineno-25-244" name="__codelineno-25-244" href="#__codelineno-25-244"></a><span class="w">                        </span><span class="n">free_seapp_context</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
</span><span id="__span-25-245"><a id="__codelineno-25-245" name="__codelineno-25-245" href="#__codelineno-25-245"></a><span class="w">                        </span><span class="k">goto</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span id="__span-25-246"><a id="__codelineno-25-246" name="__codelineno-25-246" href="#__codelineno-25-246"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-25-247"><a id="__codelineno-25-247" name="__codelineno-25-247" href="#__codelineno-25-247"></a><span class="w">                    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strdup</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
</span><span id="__span-25-248"><a id="__codelineno-25-248" name="__codelineno-25-248" href="#__codelineno-25-248"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">str</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-249"><a id="__codelineno-25-249" name="__codelineno-25-249" href="#__codelineno-25-249"></a><span class="w">                        </span><span class="n">free_seapp_context</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
</span><span id="__span-25-250"><a id="__codelineno-25-250" name="__codelineno-25-250" href="#__codelineno-25-250"></a><span class="w">                    </span><span class="k">goto</span><span class="w"> </span><span class="n">oom</span><span class="p">;</span>
</span><span id="__span-25-251"><a id="__codelineno-25-251" name="__codelineno-25-251" href="#__codelineno-25-251"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-25-252"><a id="__codelineno-25-252" name="__codelineno-25-252" href="#__codelineno-25-252"></a><span class="w">                    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">str</span><span class="p">);</span>
</span><span id="__span-25-253"><a id="__codelineno-25-253" name="__codelineno-25-253" href="#__codelineno-25-253"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">str</span><span class="p">[</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">len</span><span class="mi">-1</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;*&#39;</span><span class="p">)</span>
</span><span id="__span-25-254"><a id="__codelineno-25-254" name="__codelineno-25-254" href="#__codelineno-25-254"></a><span class="w">                        </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">is_prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-25-255"><a id="__codelineno-25-255" name="__codelineno-25-255" href="#__codelineno-25-255"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;isPrivApp&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-256"><a id="__codelineno-25-256" name="__codelineno-25-256" href="#__codelineno-25-256"></a><span class="w">                    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">isPrivAppSet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
</span><span id="__span-25-257"><a id="__codelineno-25-257" name="__codelineno-25-257" href="#__codelineno-25-257"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="p">))</span>
</span><span id="__span-25-258"><a id="__codelineno-25-258" name="__codelineno-25-258" href="#__codelineno-25-258"></a><span class="w">                        </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">isPrivApp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
</span><span id="__span-25-259"><a id="__codelineno-25-259" name="__codelineno-25-259" href="#__codelineno-25-259"></a><span class="w">                    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;false&quot;</span><span class="p">))</span>
</span><span id="__span-25-260"><a id="__codelineno-25-260" name="__codelineno-25-260" href="#__codelineno-25-260"></a><span class="w">                        </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">isPrivApp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
</span><span id="__span-25-261"><a id="__codelineno-25-261" name="__codelineno-25-261" href="#__codelineno-25-261"></a><span class="w">                    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-262"><a id="__codelineno-25-262" name="__codelineno-25-262" href="#__codelineno-25-262"></a><span class="w">                        </span><span class="n">free_seapp_context</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
</span><span id="__span-25-263"><a id="__codelineno-25-263" name="__codelineno-25-263" href="#__codelineno-25-263"></a><span class="w">                        </span><span class="k">goto</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span id="__span-25-264"><a id="__codelineno-25-264" name="__codelineno-25-264" href="#__codelineno-25-264"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-25-265"><a id="__codelineno-25-265" name="__codelineno-25-265" href="#__codelineno-25-265"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;minTargetSdkVersion&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-266"><a id="__codelineno-25-266" name="__codelineno-25-266" href="#__codelineno-25-266"></a><span class="w">                    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">minTargetSdkVersion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_minTargetSdkVersion</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
</span><span id="__span-25-267"><a id="__codelineno-25-267" name="__codelineno-25-267" href="#__codelineno-25-267"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">minTargetSdkVersion</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-268"><a id="__codelineno-25-268" name="__codelineno-25-268" href="#__codelineno-25-268"></a><span class="w">                        </span><span class="n">free_seapp_context</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
</span><span id="__span-25-269"><a id="__codelineno-25-269" name="__codelineno-25-269" href="#__codelineno-25-269"></a><span class="w">                        </span><span class="k">goto</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span id="__span-25-270"><a id="__codelineno-25-270" name="__codelineno-25-270" href="#__codelineno-25-270"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-25-271"><a id="__codelineno-25-271" name="__codelineno-25-271" href="#__codelineno-25-271"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;fromRunAs&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-272"><a id="__codelineno-25-272" name="__codelineno-25-272" href="#__codelineno-25-272"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="p">))</span>
</span><span id="__span-25-273"><a id="__codelineno-25-273" name="__codelineno-25-273" href="#__codelineno-25-273"></a><span class="w">                        </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">fromRunAs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
</span><span id="__span-25-274"><a id="__codelineno-25-274" name="__codelineno-25-274" href="#__codelineno-25-274"></a><span class="w">                    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;false&quot;</span><span class="p">))</span>
</span><span id="__span-25-275"><a id="__codelineno-25-275" name="__codelineno-25-275" href="#__codelineno-25-275"></a><span class="w">                        </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">fromRunAs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
</span><span id="__span-25-276"><a id="__codelineno-25-276" name="__codelineno-25-276" href="#__codelineno-25-276"></a><span class="w">                    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-277"><a id="__codelineno-25-277" name="__codelineno-25-277" href="#__codelineno-25-277"></a><span class="w">                        </span><span class="n">free_seapp_context</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
</span><span id="__span-25-278"><a id="__codelineno-25-278" name="__codelineno-25-278" href="#__codelineno-25-278"></a><span class="w">                        </span><span class="k">goto</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span id="__span-25-279"><a id="__codelineno-25-279" name="__codelineno-25-279" href="#__codelineno-25-279"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-25-280"><a id="__codelineno-25-280" name="__codelineno-25-280" href="#__codelineno-25-280"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-281"><a id="__codelineno-25-281" name="__codelineno-25-281" href="#__codelineno-25-281"></a><span class="w">                    </span><span class="n">free_seapp_context</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
</span><span id="__span-25-282"><a id="__codelineno-25-282" name="__codelineno-25-282" href="#__codelineno-25-282"></a><span class="w">                    </span><span class="k">goto</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span id="__span-25-283"><a id="__codelineno-25-283" name="__codelineno-25-283" href="#__codelineno-25-283"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-25-284"><a id="__codelineno-25-284" name="__codelineno-25-284" href="#__codelineno-25-284"></a>
</span><span id="__span-25-285"><a id="__codelineno-25-285" name="__codelineno-25-285" href="#__codelineno-25-285"></a><span class="w">                </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strtok_r</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot; </span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">saveptr</span><span class="p">);</span>
</span><span id="__span-25-286"><a id="__codelineno-25-286" name="__codelineno-25-286" href="#__codelineno-25-286"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">token</span><span class="p">)</span>
</span><span id="__span-25-287"><a id="__codelineno-25-287" name="__codelineno-25-287" href="#__codelineno-25-287"></a><span class="w">                    </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-25-288"><a id="__codelineno-25-288" name="__codelineno-25-288" href="#__codelineno-25-288"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-25-289"><a id="__codelineno-25-289" name="__codelineno-25-289" href="#__codelineno-25-289"></a>
</span><span id="__span-25-290"><a id="__codelineno-25-290" name="__codelineno-25-290" href="#__codelineno-25-290"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">isPrivApp</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">.</span><span class="n">str</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-25-291"><a id="__codelineno-25-291" name="__codelineno-25-291" href="#__codelineno-25-291"></a><span class="w">                </span><span class="p">(</span><span class="o">!</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">seinfo</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">seinfo</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-292"><a id="__codelineno-25-292" name="__codelineno-25-292" href="#__codelineno-25-292"></a><span class="w">                </span><span class="n">selinux_log</span><span class="p">(</span><span class="n">SELINUX_ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s:  No specific seinfo value specified with name=</span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">, on line %u:  insecure configuration!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span id="__span-25-293"><a id="__codelineno-25-293" name="__codelineno-25-293" href="#__codelineno-25-293"></a><span class="w">                        </span><span class="n">seapp_contexts_files</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">.</span><span class="n">str</span><span class="p">,</span><span class="w"> </span><span class="n">lineno</span><span class="p">);</span>
</span><span id="__span-25-294"><a id="__codelineno-25-294" name="__codelineno-25-294" href="#__codelineno-25-294"></a><span class="w">                </span><span class="n">free_seapp_context</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
</span><span id="__span-25-295"><a id="__codelineno-25-295" name="__codelineno-25-295" href="#__codelineno-25-295"></a><span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span id="__span-25-296"><a id="__codelineno-25-296" name="__codelineno-25-296" href="#__codelineno-25-296"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-25-297"><a id="__codelineno-25-297" name="__codelineno-25-297" href="#__codelineno-25-297"></a>
</span><span id="__span-25-298"><a id="__codelineno-25-298" name="__codelineno-25-298" href="#__codelineno-25-298"></a><span class="w">            </span><span class="n">seapp_contexts</span><span class="p">[</span><span class="n">nspec</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="p">;</span>
</span><span id="__span-25-299"><a id="__codelineno-25-299" name="__codelineno-25-299" href="#__codelineno-25-299"></a><span class="w">            </span><span class="n">nspec</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-25-300"><a id="__codelineno-25-300" name="__codelineno-25-300" href="#__codelineno-25-300"></a><span class="w">            </span><span class="n">lineno</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-25-301"><a id="__codelineno-25-301" name="__codelineno-25-301" href="#__codelineno-25-301"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-25-302"><a id="__codelineno-25-302" name="__codelineno-25-302" href="#__codelineno-25-302"></a><span class="w">        </span><span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span><span id="__span-25-303"><a id="__codelineno-25-303" name="__codelineno-25-303" href="#__codelineno-25-303"></a><span class="w">        </span><span class="n">fp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-25-304"><a id="__codelineno-25-304" name="__codelineno-25-304" href="#__codelineno-25-304"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-25-305"><a id="__codelineno-25-305" name="__codelineno-25-305" href="#__codelineno-25-305"></a>
</span><span id="__span-25-306"><a id="__codelineno-25-306" name="__codelineno-25-306" href="#__codelineno-25-306"></a><span class="w">    </span><span class="n">qsort</span><span class="p">(</span><span class="n">seapp_contexts</span><span class="p">,</span><span class="w"> </span><span class="n">nspec</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">seapp_context</span><span class="w"> </span><span class="o">*</span><span class="p">),</span>
</span><span id="__span-25-307"><a id="__codelineno-25-307" name="__codelineno-25-307" href="#__codelineno-25-307"></a><span class="w">          </span><span class="n">seapp_context_cmp</span><span class="p">);</span>
</span><span id="__span-25-308"><a id="__codelineno-25-308" name="__codelineno-25-308" href="#__codelineno-25-308"></a>
</span><span id="__span-25-309"><a id="__codelineno-25-309" name="__codelineno-25-309" href="#__codelineno-25-309"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">seapp_contexts_dup</span><span class="p">)</span>
</span><span id="__span-25-310"><a id="__codelineno-25-310" name="__codelineno-25-310" href="#__codelineno-25-310"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">err_no_log</span><span class="p">;</span>
</span><span id="__span-25-311"><a id="__codelineno-25-311" name="__codelineno-25-311" href="#__codelineno-25-311"></a>
</span><span id="__span-25-312"><a id="__codelineno-25-312" name="__codelineno-25-312" href="#__codelineno-25-312"></a><span class="cp">#if DEBUG</span>
</span><span id="__span-25-313"><a id="__codelineno-25-313" name="__codelineno-25-313" href="#__codelineno-25-313"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-25-314"><a id="__codelineno-25-314" name="__codelineno-25-314" href="#__codelineno-25-314"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
</span><span id="__span-25-315"><a id="__codelineno-25-315" name="__codelineno-25-315" href="#__codelineno-25-315"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nspec</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-316"><a id="__codelineno-25-316" name="__codelineno-25-316" href="#__codelineno-25-316"></a><span class="w">            </span><span class="n">cur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seapp_contexts</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span id="__span-25-317"><a id="__codelineno-25-317" name="__codelineno-25-317" href="#__codelineno-25-317"></a><span class="w">            </span><span class="n">selinux_log</span><span class="p">(</span><span class="n">SELINUX_INFO</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s:  isSystemServer=%s  isEphemeralApp=%s isOwner=%s user=%s seinfo=%s &quot;</span>
</span><span id="__span-25-318"><a id="__codelineno-25-318" name="__codelineno-25-318" href="#__codelineno-25-318"></a><span class="w">                    </span><span class="s">&quot;name=%s path=%s isPrivApp=%s minTargetSdkVersion=%d fromRunAs=%s -&gt; domain=%s type=%s level=%s levelFrom=%s&quot;</span><span class="p">,</span>
</span><span id="__span-25-319"><a id="__codelineno-25-319" name="__codelineno-25-319" href="#__codelineno-25-319"></a><span class="w">                </span><span class="n">__FUNCTION__</span><span class="p">,</span>
</span><span id="__span-25-320"><a id="__codelineno-25-320" name="__codelineno-25-320" href="#__codelineno-25-320"></a><span class="w">                </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">isSystemServer</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;false&quot;</span><span class="p">,</span>
</span><span id="__span-25-321"><a id="__codelineno-25-321" name="__codelineno-25-321" href="#__codelineno-25-321"></a><span class="w">                </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">isEphemeralAppSet</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">isEphemeralApp</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;false&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;null&quot;</span><span class="p">,</span>
</span><span id="__span-25-322"><a id="__codelineno-25-322" name="__codelineno-25-322" href="#__codelineno-25-322"></a><span class="w">                </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">isOwnerSet</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">isOwner</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;false&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;null&quot;</span><span class="p">,</span>
</span><span id="__span-25-323"><a id="__codelineno-25-323" name="__codelineno-25-323" href="#__codelineno-25-323"></a><span class="w">                </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">.</span><span class="n">str</span><span class="p">,</span>
</span><span id="__span-25-324"><a id="__codelineno-25-324" name="__codelineno-25-324" href="#__codelineno-25-324"></a><span class="w">                </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">seinfo</span><span class="p">,</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">.</span><span class="n">str</span><span class="p">,</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">str</span><span class="p">,</span>
</span><span id="__span-25-325"><a id="__codelineno-25-325" name="__codelineno-25-325" href="#__codelineno-25-325"></a><span class="w">                </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">isPrivAppSet</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">isPrivApp</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;false&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;null&quot;</span><span class="p">,</span>
</span><span id="__span-25-326"><a id="__codelineno-25-326" name="__codelineno-25-326" href="#__codelineno-25-326"></a><span class="w">                </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">minTargetSdkVersion</span><span class="p">,</span>
</span><span id="__span-25-327"><a id="__codelineno-25-327" name="__codelineno-25-327" href="#__codelineno-25-327"></a><span class="w">                </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">fromRunAs</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;false&quot;</span><span class="p">,</span>
</span><span id="__span-25-328"><a id="__codelineno-25-328" name="__codelineno-25-328" href="#__codelineno-25-328"></a><span class="w">                </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">,</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">,</span>
</span><span id="__span-25-329"><a id="__codelineno-25-329" name="__codelineno-25-329" href="#__codelineno-25-329"></a><span class="w">                </span><span class="n">levelFromName</span><span class="p">[</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">levelFrom</span><span class="p">]);</span>
</span><span id="__span-25-330"><a id="__codelineno-25-330" name="__codelineno-25-330" href="#__codelineno-25-330"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-25-331"><a id="__codelineno-25-331" name="__codelineno-25-331" href="#__codelineno-25-331"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-25-332"><a id="__codelineno-25-332" name="__codelineno-25-332" href="#__codelineno-25-332"></a><span class="cp">#endif</span>
</span><span id="__span-25-333"><a id="__codelineno-25-333" name="__codelineno-25-333" href="#__codelineno-25-333"></a>
</span><span id="__span-25-334"><a id="__codelineno-25-334" name="__codelineno-25-334" href="#__codelineno-25-334"></a><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-25-335"><a id="__codelineno-25-335" name="__codelineno-25-335" href="#__codelineno-25-335"></a>
</span><span id="__span-25-336"><a id="__codelineno-25-336" name="__codelineno-25-336" href="#__codelineno-25-336"></a><span class="nl">out</span><span class="p">:</span>
</span><span id="__span-25-337"><a id="__codelineno-25-337" name="__codelineno-25-337" href="#__codelineno-25-337"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-338"><a id="__codelineno-25-338" name="__codelineno-25-338" href="#__codelineno-25-338"></a><span class="w">        </span><span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span><span id="__span-25-339"><a id="__codelineno-25-339" name="__codelineno-25-339" href="#__codelineno-25-339"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-25-340"><a id="__codelineno-25-340" name="__codelineno-25-340" href="#__codelineno-25-340"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
</span><span id="__span-25-341"><a id="__codelineno-25-341" name="__codelineno-25-341" href="#__codelineno-25-341"></a>
</span><span id="__span-25-342"><a id="__codelineno-25-342" name="__codelineno-25-342" href="#__codelineno-25-342"></a><span class="nl">err</span><span class="p">:</span>
</span><span id="__span-25-343"><a id="__codelineno-25-343" name="__codelineno-25-343" href="#__codelineno-25-343"></a><span class="w">    </span><span class="n">selinux_log</span><span class="p">(</span><span class="n">SELINUX_ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s:  Invalid entry on line %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span id="__span-25-344"><a id="__codelineno-25-344" name="__codelineno-25-344" href="#__codelineno-25-344"></a><span class="w">            </span><span class="n">seapp_contexts_files</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">lineno</span><span class="p">);</span>
</span><span id="__span-25-345"><a id="__codelineno-25-345" name="__codelineno-25-345" href="#__codelineno-25-345"></a><span class="nl">err_no_log</span><span class="p">:</span>
</span><span id="__span-25-346"><a id="__codelineno-25-346" name="__codelineno-25-346" href="#__codelineno-25-346"></a><span class="w">    </span><span class="n">free_seapp_contexts</span><span class="p">();</span>
</span><span id="__span-25-347"><a id="__codelineno-25-347" name="__codelineno-25-347" href="#__codelineno-25-347"></a><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
</span><span id="__span-25-348"><a id="__codelineno-25-348" name="__codelineno-25-348" href="#__codelineno-25-348"></a><span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
</span><span id="__span-25-349"><a id="__codelineno-25-349" name="__codelineno-25-349" href="#__codelineno-25-349"></a><span class="nl">oom</span><span class="p">:</span>
</span><span id="__span-25-350"><a id="__codelineno-25-350" name="__codelineno-25-350" href="#__codelineno-25-350"></a><span class="w">    </span><span class="n">selinux_log</span><span class="p">(</span><span class="n">SELINUX_ERROR</span><span class="p">,</span>
</span><span id="__span-25-351"><a id="__codelineno-25-351" name="__codelineno-25-351" href="#__codelineno-25-351"></a><span class="w">            </span><span class="s">&quot;%s:  Out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__FUNCTION__</span><span class="p">);</span>
</span><span id="__span-25-352"><a id="__codelineno-25-352" name="__codelineno-25-352" href="#__codelineno-25-352"></a><span class="w">    </span><span class="n">free_seapp_contexts</span><span class="p">();</span>
</span><span id="__span-25-353"><a id="__codelineno-25-353" name="__codelineno-25-353" href="#__codelineno-25-353"></a><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
</span><span id="__span-25-354"><a id="__codelineno-25-354" name="__codelineno-25-354" href="#__codelineno-25-354"></a><span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
</span><span id="__span-25-355"><a id="__codelineno-25-355" name="__codelineno-25-355" href="#__codelineno-25-355"></a><span class="p">}</span>
</span></code></pre></div>
<p>这个函数代码很长，也很复杂。因为这流程是加载se，所以我们只关心相关代码，也就是从以下数组中收集文件并汇总到seapp_contexts_files数组，最后通过fopen打开并作相应的处理。</p>
<ul>
<li>seapp_contexts_plat</li>
<li>"/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/system/&amp;project=external">system</a>/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/system/etc/&amp;project=external">etc</a>/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/system/etc/selinux/&amp;project=external">selinux</a>/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/system/etc/selinux/plat_seapp_contexts&amp;project=external">plat_seapp_contexts</a>"</li>
<li>"/plat_seapp_contexts"</li>
<li>seapp_contexts_system_ext</li>
<li>"/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/system_ext/&amp;project=external">system_ext</a>/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/system_ext/etc/&amp;project=external">etc</a>/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/system_ext/etc/selinux/&amp;project=external">selinux</a>/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/system_ext/etc/selinux/system_ext_seapp_contexts&amp;project=external">system_ext_seapp_contexts</a>"</li>
<li>"/system_ext_seapp_contexts"</li>
<li>seapp_contexts_product</li>
<li>"/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/product/&amp;project=external">product</a>/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/product/etc/&amp;project=external">etc</a>/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/product/etc/selinux/&amp;project=external">selinux</a>/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/product/etc/selinux/product_seapp_contexts&amp;project=external">product_seapp_contexts</a>"</li>
<li>"/product_seapp_contexts"</li>
<li>seapp_contexts_vendor</li>
<li>"/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/vendor/&amp;project=external">vendor</a>/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/vendor/etc/&amp;project=external">etc</a>/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/vendor/etc/selinux/&amp;project=external">selinux</a>/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/vendor/etc/selinux/vendor_seapp_contexts&amp;project=external">vendor_seapp_contexts</a>"</li>
<li>"/vendor_seapp_contexts"</li>
<li>"/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/vendor/&amp;project=external">vendor</a>/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/vendor/etc/&amp;project=external">etc</a>/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/vendor/etc/selinux/&amp;project=external">selinux</a>/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/vendor/etc/selinux/nonplat_seapp_contexts&amp;project=external">nonplat_seapp_contexts</a>"</li>
<li>"/nonplat_seapp_contexts" </li>
<li>seapp_contexts_odm</li>
<li>"/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/odm/&amp;project=external">odm</a>/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/odm/etc/&amp;project=external">etc</a>/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/odm/etc/selinux/&amp;project=external">selinux</a>/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/odm/etc/selinux/odm_seapp_contexts&amp;project=external">odm_seapp_contexts</a>",</li>
<li>"/odm_seapp_contexts"</li>
</ul>
<h4 id="_8">疑问<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h4>
<p>可以看到，<code>seinfo</code> 是贯穿Java到Native的一个重要线索，Native的seinfo是从一堆的 <code>xxx_seapp_contests</code> 中获取的，那Java层的<code>seinfo</code>是来自何处呢？</p>
<h3 id="java-seinfo">Java seinfo<a class="headerlink" href="#java-seinfo" title="Permanent link">&para;</a></h3>
<p>在PackageManagerService扫描apk文件时赋值给各个applicationInfo对象的：</p>
<ul>
<li>PMS在扫描apk时将seinfo赋值给pkg信息对象，其seinfo通过调用 <code>SELinuxMMAC.getSeinfo()</code> 获取。</li>
<li>SELinuxMMAC中的seinfo是在PMS初始化时从各种 <code>/etc/selinux/???_mac_permissions.xml</code> 文件中获取的。</li>
</ul>
<blockquote>
<p>java部分的我们就不做详细分析，只列出调用流程。</p>
</blockquote>
<h4 id="processinstallrequestsasync">processInstallRequestsAsync<a class="headerlink" href="#processinstallrequestsasync" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="nl">http</span><span class="p">:</span><span class="c1">//aospxref.com/android-12.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="c1">// Queue up an async operation since the package installation may take a little while.</span>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">processInstallRequestsAsync</span><span class="p">(</span><span class="kt">boolean</span><span class="w"> </span><span class="n">success</span><span class="p">,</span>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="w">                                         </span><span class="n">List</span><span class="o">&lt;</span><span class="n">InstallRequest</span><span class="o">&gt;</span><span class="w"> </span><span class="n">installRequests</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mInstallLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a><span class="w">        </span><span class="n">installPackagesTracedLI</span><span class="p">(</span><span class="n">apkInstallRequests</span><span class="p">);</span>
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-26-11"><a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="installpackagestracedli">installPackagesTracedLI<a class="headerlink" href="#installpackagestracedli" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="nl">http</span><span class="p">:</span><span class="c1">//aospxref.com/android-12.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="nd">@GuardedBy</span><span class="p">(</span><span class="s">&quot;mInstallLock&quot;</span><span class="p">)</span>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">installPackagesTracedLI</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">InstallRequest</span><span class="o">&gt;</span><span class="w"> </span><span class="n">requests</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="w">        </span><span class="n">Trace</span><span class="p">.</span><span class="na">traceBegin</span><span class="p">(</span><span class="n">TRACE_TAG_PACKAGE_MANAGER</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;installPackages&quot;</span><span class="p">);</span>
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="w">        </span><span class="n">installPackagesLI</span><span class="p">(</span><span class="n">requests</span><span class="p">);</span>
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-9"><a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="w">        </span><span class="n">Trace</span><span class="p">.</span><span class="na">traceEnd</span><span class="p">(</span><span class="n">TRACE_TAG_PACKAGE_MANAGER</span><span class="p">);</span>
</span><span id="__span-27-10"><a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-27-11"><a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="installpackagesli">installPackagesLI<a class="headerlink" href="#installpackagesli" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="nl">http</span><span class="p">:</span><span class="c1">//aospxref.com/android-12.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="cm">/**</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="cm"> * Installs one or more packages atomically. This operation is broken up into four phases:</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="cm"> * &lt;ul&gt;</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="cm"> *     &lt;li&gt;&lt;b&gt;Prepare&lt;/b&gt;</span>
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="cm"> *         &lt;br/&gt;Analyzes any current install state, parses the package and does initial</span>
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="cm"> *         validation on it.&lt;/li&gt;</span>
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a><span class="cm"> *     &lt;li&gt;&lt;b&gt;Scan&lt;/b&gt;</span>
</span><span id="__span-28-10"><a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a><span class="cm"> *         &lt;br/&gt;Interrogates the parsed packages given the context collected in prepare.&lt;/li&gt;</span>
</span><span id="__span-28-11"><a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a><span class="cm"> *     &lt;li&gt;&lt;b&gt;Reconcile&lt;/b&gt;</span>
</span><span id="__span-28-12"><a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a><span class="cm"> *         &lt;br/&gt;Validates scanned packages in the context of each other and the current system</span>
</span><span id="__span-28-13"><a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a><span class="cm"> *         state to ensure that the install will be successful.</span>
</span><span id="__span-28-14"><a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a><span class="cm"> *     &lt;li&gt;&lt;b&gt;Commit&lt;/b&gt;</span>
</span><span id="__span-28-15"><a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a><span class="cm"> *         &lt;br/&gt;Commits all scanned packages and updates system state. This is the only place</span>
</span><span id="__span-28-16"><a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a><span class="cm"> *         that system state may be modified in the install flow and all predictable errors</span>
</span><span id="__span-28-17"><a id="__codelineno-28-17" name="__codelineno-28-17" href="#__codelineno-28-17"></a><span class="cm"> *         must be determined before this phase.&lt;/li&gt;</span>
</span><span id="__span-28-18"><a id="__codelineno-28-18" name="__codelineno-28-18" href="#__codelineno-28-18"></a><span class="cm"> * &lt;/ul&gt;</span>
</span><span id="__span-28-19"><a id="__codelineno-28-19" name="__codelineno-28-19" href="#__codelineno-28-19"></a><span class="cm"> *</span>
</span><span id="__span-28-20"><a id="__codelineno-28-20" name="__codelineno-28-20" href="#__codelineno-28-20"></a><span class="cm"> * Failure at any phase will result in a full failure to install all packages.</span>
</span><span id="__span-28-21"><a id="__codelineno-28-21" name="__codelineno-28-21" href="#__codelineno-28-21"></a><span class="cm"> */</span>
</span><span id="__span-28-22"><a id="__codelineno-28-22" name="__codelineno-28-22" href="#__codelineno-28-22"></a><span class="nd">@GuardedBy</span><span class="p">(</span><span class="s">&quot;mInstallLock&quot;</span><span class="p">)</span>
</span><span id="__span-28-23"><a id="__codelineno-28-23" name="__codelineno-28-23" href="#__codelineno-28-23"></a><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">installPackagesLI</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">InstallRequest</span><span class="o">&gt;</span><span class="w"> </span><span class="n">requests</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-24"><a id="__codelineno-28-24" name="__codelineno-28-24" href="#__codelineno-28-24"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-28-25"><a id="__codelineno-28-25" name="__codelineno-28-25" href="#__codelineno-28-25"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">ScanResult</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scanPackageTracedLI</span><span class="p">(</span>
</span><span id="__span-28-26"><a id="__codelineno-28-26" name="__codelineno-28-26" href="#__codelineno-28-26"></a><span class="w">        </span><span class="n">prepareResult</span><span class="p">.</span><span class="na">packageToScan</span><span class="p">,</span><span class="w"> </span><span class="n">prepareResult</span><span class="p">.</span><span class="na">parseFlags</span><span class="p">,</span>
</span><span id="__span-28-27"><a id="__codelineno-28-27" name="__codelineno-28-27" href="#__codelineno-28-27"></a><span class="w">        </span><span class="n">prepareResult</span><span class="p">.</span><span class="na">scanFlags</span><span class="p">,</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">(),</span>
</span><span id="__span-28-28"><a id="__codelineno-28-28" name="__codelineno-28-28" href="#__codelineno-28-28"></a><span class="w">        </span><span class="n">request</span><span class="p">.</span><span class="na">args</span><span class="p">.</span><span class="na">user</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">args</span><span class="p">.</span><span class="na">abiOverride</span><span class="p">);</span>
</span><span id="__span-28-29"><a id="__codelineno-28-29" name="__codelineno-28-29" href="#__codelineno-28-29"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-28-30"><a id="__codelineno-28-30" name="__codelineno-28-30" href="#__codelineno-28-30"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="scanpackagetracedli">scanPackageTracedLI<a class="headerlink" href="#scanpackagetracedli" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="nl">http</span><span class="p">:</span><span class="c1">//aospxref.com/android-12.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="cm">/**</span>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="cm"> *  Traces a package scan.</span>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="cm"> *  @see #scanPackageLI(File, int, int, long, UserHandle)</span>
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a><span class="cm"> */</span>
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="nd">@GuardedBy</span><span class="p">({</span><span class="s">&quot;mInstallLock&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mLock&quot;</span><span class="p">})</span>
</span><span id="__span-29-8"><a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a><span class="kd">private</span><span class="w"> </span><span class="n">AndroidPackage</span><span class="w"> </span><span class="nf">scanPackageTracedLI</span><span class="p">(</span><span class="n">File</span><span class="w"> </span><span class="n">scanFile</span><span class="p">,</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">parseFlags</span><span class="p">,</span>
</span><span id="__span-29-9"><a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">scanFlags</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">currentTime</span><span class="p">,</span><span class="w"> </span><span class="n">UserHandle</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">PackageManagerException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-29-10"><a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a><span class="w">    </span><span class="n">Trace</span><span class="p">.</span><span class="na">traceBegin</span><span class="p">(</span><span class="n">TRACE_TAG_PACKAGE_MANAGER</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;scanPackage [&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">scanFile</span><span class="p">.</span><span class="na">toString</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;]&quot;</span><span class="p">);</span>
</span><span id="__span-29-11"><a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-29-12"><a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">scanPackageLI</span><span class="p">(</span><span class="n">scanFile</span><span class="p">,</span><span class="w"> </span><span class="n">parseFlags</span><span class="p">,</span><span class="w"> </span><span class="n">scanFlags</span><span class="p">,</span><span class="w"> </span><span class="n">currentTime</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">);</span>
</span><span id="__span-29-13"><a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-29-14"><a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a><span class="w">        </span><span class="n">Trace</span><span class="p">.</span><span class="na">traceEnd</span><span class="p">(</span><span class="n">TRACE_TAG_PACKAGE_MANAGER</span><span class="p">);</span>
</span><span id="__span-29-15"><a id="__codelineno-29-15" name="__codelineno-29-15" href="#__codelineno-29-15"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-29-16"><a id="__codelineno-29-16" name="__codelineno-29-16" href="#__codelineno-29-16"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="scanpackageli">scanPackageLI<a class="headerlink" href="#scanpackageli" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="nl">http</span><span class="p">:</span><span class="c1">//aospxref.com/android-12.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="cm">/**</span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="cm"> *  Scans a package and returns the newly parsed package.</span>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="cm"> *  Returns {@code null} in case of errors and the error code is stored in mLastScanError</span>
</span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="cm"> */</span>
</span><span id="__span-30-7"><a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a><span class="nd">@GuardedBy</span><span class="p">({</span><span class="s">&quot;mInstallLock&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mLock&quot;</span><span class="p">})</span>
</span><span id="__span-30-8"><a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a><span class="kd">private</span><span class="w"> </span><span class="n">AndroidPackage</span><span class="w"> </span><span class="nf">scanPackageLI</span><span class="p">(</span><span class="n">File</span><span class="w"> </span><span class="n">scanFile</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">parseFlags</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">scanFlags</span><span class="p">,</span>
</span><span id="__span-30-9"><a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">currentTime</span><span class="p">,</span><span class="w"> </span><span class="n">UserHandle</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">PackageManagerException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-10"><a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-30-11"><a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a>
</span><span id="__span-30-12"><a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">addForInitLI</span><span class="p">(</span><span class="n">parsedPackage</span><span class="p">,</span><span class="w"> </span><span class="n">parseFlags</span><span class="p">,</span><span class="w"> </span><span class="n">scanFlags</span><span class="p">,</span><span class="w"> </span><span class="n">currentTime</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">);</span>
</span><span id="__span-30-13"><a id="__codelineno-30-13" name="__codelineno-30-13" href="#__codelineno-30-13"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="addforinitli">addForInitLI<a class="headerlink" href="#addforinitli" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="nl">http</span><span class="p">:</span><span class="c1">//aospxref.com/android-12.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="cm">/**</span>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="cm"> * Adds a new package to the internal data structures during platform initialization.</span>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="cm"> * &lt;p&gt;After adding, the package is known to the system and available for querying.</span>
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="cm"> * &lt;p&gt;For packages located on the device ROM [eg. packages located in /system, /vendor,</span>
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="cm"> * etc...], additional checks are performed. Basic verification [such as ensuring</span>
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="cm"> * matching signatures, checking version codes, etc...] occurs if the package is</span>
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a><span class="cm"> * identical to a previously known package. If the package fails a signature check,</span>
</span><span id="__span-31-10"><a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a><span class="cm"> * the version installed on /data will be removed. If the version of the new package</span>
</span><span id="__span-31-11"><a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a><span class="cm"> * is less than or equal than the version on /data, it will be ignored.</span>
</span><span id="__span-31-12"><a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a><span class="cm"> * &lt;p&gt;Regardless of the package location, the results are applied to the internal</span>
</span><span id="__span-31-13"><a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a><span class="cm"> * structures and the package is made available to the rest of the system.</span>
</span><span id="__span-31-14"><a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a><span class="cm"> * &lt;p&gt;NOTE: The return value should be removed. It&#39;s the passed in package object.</span>
</span><span id="__span-31-15"><a id="__codelineno-31-15" name="__codelineno-31-15" href="#__codelineno-31-15"></a><span class="cm"> */</span>
</span><span id="__span-31-16"><a id="__codelineno-31-16" name="__codelineno-31-16" href="#__codelineno-31-16"></a><span class="nd">@GuardedBy</span><span class="p">({</span><span class="s">&quot;mInstallLock&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mLock&quot;</span><span class="p">})</span>
</span><span id="__span-31-17"><a id="__codelineno-31-17" name="__codelineno-31-17" href="#__codelineno-31-17"></a><span class="kd">private</span><span class="w"> </span><span class="n">AndroidPackage</span><span class="w"> </span><span class="nf">addForInitLI</span><span class="p">(</span><span class="n">ParsedPackage</span><span class="w"> </span><span class="n">parsedPackage</span><span class="p">,</span>
</span><span id="__span-31-18"><a id="__codelineno-31-18" name="__codelineno-31-18" href="#__codelineno-31-18"></a><span class="w">        </span><span class="nd">@ParseFlags</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">parseFlags</span><span class="p">,</span><span class="w"> </span><span class="nd">@ScanFlags</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">scanFlags</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">currentTime</span><span class="p">,</span>
</span><span id="__span-31-19"><a id="__codelineno-31-19" name="__codelineno-31-19" href="#__codelineno-31-19"></a><span class="w">        </span><span class="nd">@Nullable</span><span class="w"> </span><span class="n">UserHandle</span><span class="w"> </span><span class="n">user</span><span class="p">)</span>
</span><span id="__span-31-20"><a id="__codelineno-31-20" name="__codelineno-31-20" href="#__codelineno-31-20"></a><span class="w">                </span><span class="kd">throws</span><span class="w"> </span><span class="n">PackageManagerException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-21"><a id="__codelineno-31-21" name="__codelineno-31-21" href="#__codelineno-31-21"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-31-22"><a id="__codelineno-31-22" name="__codelineno-31-22" href="#__codelineno-31-22"></a><span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-23"><a id="__codelineno-31-23" name="__codelineno-31-23" href="#__codelineno-31-23"></a><span class="w">        </span><span class="p">...</span>
</span><span id="__span-31-24"><a id="__codelineno-31-24" name="__codelineno-31-24" href="#__codelineno-31-24"></a><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">ScanResult</span><span class="w"> </span><span class="n">scanResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scanPackageOnlyLI</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">mInjector</span><span class="p">,</span><span class="w"> </span><span class="n">mFactoryTest</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1L</span><span class="p">);</span>
</span><span id="__span-31-25"><a id="__codelineno-31-25" name="__codelineno-31-25" href="#__codelineno-31-25"></a><span class="w">        </span><span class="p">...</span>
</span><span id="__span-31-26"><a id="__codelineno-31-26" name="__codelineno-31-26" href="#__codelineno-31-26"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-31-27"><a id="__codelineno-31-27" name="__codelineno-31-27" href="#__codelineno-31-27"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-31-28"><a id="__codelineno-31-28" name="__codelineno-31-28" href="#__codelineno-31-28"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="scanpackageonlyli">scanPackageOnlyLI<a class="headerlink" href="#scanpackageonlyli" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="nl">http</span><span class="p">:</span><span class="c1">//aospxref.com/android-12.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="cm">/**</span>
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="cm"> * Just scans the package without any side effects.</span>
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="cm"> * &lt;p&gt;Not entirely true at the moment. There is still one side effect -- this</span>
</span><span id="__span-32-6"><a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a><span class="cm"> * method potentially modifies a live {@link PackageSetting} object representing</span>
</span><span id="__span-32-7"><a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a><span class="cm"> * the package being scanned. This will be resolved in the future.</span>
</span><span id="__span-32-8"><a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a><span class="cm"> *</span>
</span><span id="__span-32-9"><a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a><span class="cm"> * @param injector injector for acquiring dependencies</span>
</span><span id="__span-32-10"><a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a><span class="cm"> * @param request Information about the package to be scanned</span>
</span><span id="__span-32-11"><a id="__codelineno-32-11" name="__codelineno-32-11" href="#__codelineno-32-11"></a><span class="cm"> * @param isUnderFactoryTest Whether or not the device is under factory test</span>
</span><span id="__span-32-12"><a id="__codelineno-32-12" name="__codelineno-32-12" href="#__codelineno-32-12"></a><span class="cm"> * @param currentTime The current time, in millis</span>
</span><span id="__span-32-13"><a id="__codelineno-32-13" name="__codelineno-32-13" href="#__codelineno-32-13"></a><span class="cm"> * @return The results of the scan</span>
</span><span id="__span-32-14"><a id="__codelineno-32-14" name="__codelineno-32-14" href="#__codelineno-32-14"></a><span class="cm"> */</span>
</span><span id="__span-32-15"><a id="__codelineno-32-15" name="__codelineno-32-15" href="#__codelineno-32-15"></a><span class="nd">@GuardedBy</span><span class="p">(</span><span class="s">&quot;mInstallLock&quot;</span><span class="p">)</span>
</span><span id="__span-32-16"><a id="__codelineno-32-16" name="__codelineno-32-16" href="#__codelineno-32-16"></a><span class="nd">@VisibleForTesting</span>
</span><span id="__span-32-17"><a id="__codelineno-32-17" name="__codelineno-32-17" href="#__codelineno-32-17"></a><span class="nd">@NonNull</span>
</span><span id="__span-32-18"><a id="__codelineno-32-18" name="__codelineno-32-18" href="#__codelineno-32-18"></a><span class="kd">static</span><span class="w"> </span><span class="n">ScanResult</span><span class="w"> </span><span class="nf">scanPackageOnlyLI</span><span class="p">(</span><span class="nd">@NonNull</span><span class="w"> </span><span class="n">ScanRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span>
</span><span id="__span-32-19"><a id="__codelineno-32-19" name="__codelineno-32-19" href="#__codelineno-32-19"></a><span class="w">        </span><span class="n">Injector</span><span class="w"> </span><span class="n">injector</span><span class="p">,</span>
</span><span id="__span-32-20"><a id="__codelineno-32-20" name="__codelineno-32-20" href="#__codelineno-32-20"></a><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isUnderFactoryTest</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">currentTime</span><span class="p">)</span>
</span><span id="__span-32-21"><a id="__codelineno-32-21" name="__codelineno-32-21" href="#__codelineno-32-21"></a><span class="w">        </span><span class="kd">throws</span><span class="w"> </span><span class="n">PackageManagerException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-32-22"><a id="__codelineno-32-22" name="__codelineno-32-22" href="#__codelineno-32-22"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-32-23"><a id="__codelineno-32-23" name="__codelineno-32-23" href="#__codelineno-32-23"></a>
</span><span id="__span-32-24"><a id="__codelineno-32-24" name="__codelineno-32-24" href="#__codelineno-32-24"></a><span class="w">    </span><span class="n">parsedPackage</span>
</span><span id="__span-32-25"><a id="__codelineno-32-25" name="__codelineno-32-25" href="#__codelineno-32-25"></a><span class="w">            </span><span class="p">.</span><span class="na">setSeInfo</span><span class="p">(</span><span class="n">SELinuxMMAC</span><span class="p">.</span><span class="na">getSeInfo</span><span class="p">(</span><span class="n">parsedPackage</span><span class="p">,</span><span class="w"> </span><span class="n">sharedUserSetting</span><span class="p">,</span>
</span><span id="__span-32-26"><a id="__codelineno-32-26" name="__codelineno-32-26" href="#__codelineno-32-26"></a><span class="w">                    </span><span class="n">injector</span><span class="p">.</span><span class="na">getCompatibility</span><span class="p">()))</span>
</span><span id="__span-32-27"><a id="__codelineno-32-27" name="__codelineno-32-27" href="#__codelineno-32-27"></a><span class="w">            </span><span class="p">.</span><span class="na">setSeInfoUser</span><span class="p">(</span><span class="n">SELinuxUtil</span><span class="p">.</span><span class="na">assignSeinfoUser</span><span class="p">(</span><span class="n">pkgSetting</span><span class="p">.</span><span class="na">readUserState</span><span class="p">(</span>
</span><span id="__span-32-28"><a id="__codelineno-32-28" name="__codelineno-32-28" href="#__codelineno-32-28"></a><span class="w">                    </span><span class="n">userId</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">USER_ALL</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">USER_SYSTEM</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">userId</span><span class="p">)));</span>
</span><span id="__span-32-29"><a id="__codelineno-32-29" name="__codelineno-32-29" href="#__codelineno-32-29"></a>
</span><span id="__span-32-30"><a id="__codelineno-32-30" name="__codelineno-32-30" href="#__codelineno-32-30"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-32-31"><a id="__codelineno-32-31" name="__codelineno-32-31" href="#__codelineno-32-31"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="getseinfo">getSeInfo<a class="headerlink" href="#getseinfo" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="nl">http</span><span class="p">:</span><span class="c1">//aospxref.com/android-12.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/pm/SELinuxMMAC.java</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="cm">/**</span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="cm">     * Selects a security label to a package based on input parameters and the seinfo tag taken</span>
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a><span class="cm">     * from a matched policy. All signature based policy stanzas are consulted and, if no match</span>
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a><span class="cm">     * is found, the default seinfo label of &#39;default&#39; is used. The security label is attached to</span>
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a><span class="cm">     * the ApplicationInfo instance of the package.</span>
</span><span id="__span-33-8"><a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a><span class="cm">     *</span>
</span><span id="__span-33-9"><a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a><span class="cm">     * @param pkg               object representing the package to be labeled.</span>
</span><span id="__span-33-10"><a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a><span class="cm">     * @param sharedUserSetting if the app shares a sharedUserId, then this has the shared setting.</span>
</span><span id="__span-33-11"><a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a><span class="cm">     * @param compatibility     the PlatformCompat service to ask about state of compat changes.</span>
</span><span id="__span-33-12"><a id="__codelineno-33-12" name="__codelineno-33-12" href="#__codelineno-33-12"></a><span class="cm">     * @return String representing the resulting seinfo.</span>
</span><span id="__span-33-13"><a id="__codelineno-33-13" name="__codelineno-33-13" href="#__codelineno-33-13"></a><span class="cm">     */</span>
</span><span id="__span-33-14"><a id="__codelineno-33-14" name="__codelineno-33-14" href="#__codelineno-33-14"></a><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getSeInfo</span><span class="p">(</span><span class="n">AndroidPackage</span><span class="w"> </span><span class="n">pkg</span><span class="p">,</span><span class="w"> </span><span class="n">SharedUserSetting</span><span class="w"> </span><span class="n">sharedUserSetting</span><span class="p">,</span>
</span><span id="__span-33-15"><a id="__codelineno-33-15" name="__codelineno-33-15" href="#__codelineno-33-15"></a><span class="w">                               </span><span class="n">PlatformCompat</span><span class="w"> </span><span class="n">compatibility</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-16"><a id="__codelineno-33-16" name="__codelineno-33-16" href="#__codelineno-33-16"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">targetSdkVersion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getTargetSdkVersionForSeInfo</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span><span class="w"> </span><span class="n">sharedUserSetting</span><span class="p">,</span>
</span><span id="__span-33-17"><a id="__codelineno-33-17" name="__codelineno-33-17" href="#__codelineno-33-17"></a><span class="w">                                                              </span><span class="n">compatibility</span><span class="p">);</span>
</span><span id="__span-33-18"><a id="__codelineno-33-18" name="__codelineno-33-18" href="#__codelineno-33-18"></a><span class="w">    </span><span class="c1">// TODO(b/71593002): isPrivileged for sharedUser and appInfo should never be out of sync.</span>
</span><span id="__span-33-19"><a id="__codelineno-33-19" name="__codelineno-33-19" href="#__codelineno-33-19"></a><span class="w">    </span><span class="c1">// They currently can be if the sharedUser apps are signed with the platform key.</span>
</span><span id="__span-33-20"><a id="__codelineno-33-20" name="__codelineno-33-20" href="#__codelineno-33-20"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isPrivileged</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">sharedUserSetting</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span>
</span><span id="__span-33-21"><a id="__codelineno-33-21" name="__codelineno-33-21" href="#__codelineno-33-21"></a><span class="w">        </span><span class="o">?</span><span class="w"> </span><span class="n">sharedUserSetting</span><span class="p">.</span><span class="na">isPrivileged</span><span class="p">()</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">pkg</span><span class="p">.</span><span class="na">isPrivileged</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">pkg</span><span class="p">.</span><span class="na">isPrivileged</span><span class="p">();</span>
</span><span id="__span-33-22"><a id="__codelineno-33-22" name="__codelineno-33-22" href="#__codelineno-33-22"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">getSeInfo</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span><span class="w"> </span><span class="n">isPrivileged</span><span class="p">,</span><span class="w"> </span><span class="n">targetSdkVersion</span><span class="p">);</span>
</span><span id="__span-33-23"><a id="__codelineno-33-23" name="__codelineno-33-23" href="#__codelineno-33-23"></a><span class="p">}</span>
</span><span id="__span-33-24"><a id="__codelineno-33-24" name="__codelineno-33-24" href="#__codelineno-33-24"></a>
</span><span id="__span-33-25"><a id="__codelineno-33-25" name="__codelineno-33-25" href="#__codelineno-33-25"></a><span class="cm">/**</span>
</span><span id="__span-33-26"><a id="__codelineno-33-26" name="__codelineno-33-26" href="#__codelineno-33-26"></a><span class="cm"> * Selects a security label to a package based on input parameters and the seinfo tag taken</span>
</span><span id="__span-33-27"><a id="__codelineno-33-27" name="__codelineno-33-27" href="#__codelineno-33-27"></a><span class="cm"> * from a matched policy. All signature based policy stanzas are consulted and, if no match</span>
</span><span id="__span-33-28"><a id="__codelineno-33-28" name="__codelineno-33-28" href="#__codelineno-33-28"></a><span class="cm"> * is found, the default seinfo label of &#39;default&#39; is used. The security label is attached to</span>
</span><span id="__span-33-29"><a id="__codelineno-33-29" name="__codelineno-33-29" href="#__codelineno-33-29"></a><span class="cm"> * the ApplicationInfo instance of the package.</span>
</span><span id="__span-33-30"><a id="__codelineno-33-30" name="__codelineno-33-30" href="#__codelineno-33-30"></a><span class="cm"> *</span>
</span><span id="__span-33-31"><a id="__codelineno-33-31" name="__codelineno-33-31" href="#__codelineno-33-31"></a><span class="cm"> * @param pkg object representing the package to be labeled.</span>
</span><span id="__span-33-32"><a id="__codelineno-33-32" name="__codelineno-33-32" href="#__codelineno-33-32"></a><span class="cm"> * @param isPrivileged boolean.</span>
</span><span id="__span-33-33"><a id="__codelineno-33-33" name="__codelineno-33-33" href="#__codelineno-33-33"></a><span class="cm"> * @param targetSdkVersion int. If this pkg runs as a sharedUser, targetSdkVersion is the</span>
</span><span id="__span-33-34"><a id="__codelineno-33-34" name="__codelineno-33-34" href="#__codelineno-33-34"></a><span class="cm"> *        greater of: lowest targetSdk for all pkgs in the sharedUser, or</span>
</span><span id="__span-33-35"><a id="__codelineno-33-35" name="__codelineno-33-35" href="#__codelineno-33-35"></a><span class="cm"> *        MINIMUM_TARGETSDKVERSION.</span>
</span><span id="__span-33-36"><a id="__codelineno-33-36" name="__codelineno-33-36" href="#__codelineno-33-36"></a><span class="cm"> * @return String representing the resulting seinfo.</span>
</span><span id="__span-33-37"><a id="__codelineno-33-37" name="__codelineno-33-37" href="#__codelineno-33-37"></a><span class="cm"> */</span>
</span><span id="__span-33-38"><a id="__codelineno-33-38" name="__codelineno-33-38" href="#__codelineno-33-38"></a><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getSeInfo</span><span class="p">(</span><span class="n">AndroidPackage</span><span class="w"> </span><span class="n">pkg</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isPrivileged</span><span class="p">,</span>
</span><span id="__span-33-39"><a id="__codelineno-33-39" name="__codelineno-33-39" href="#__codelineno-33-39"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">targetSdkVersion</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-40"><a id="__codelineno-33-40" name="__codelineno-33-40" href="#__codelineno-33-40"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">seInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-33-41"><a id="__codelineno-33-41" name="__codelineno-33-41" href="#__codelineno-33-41"></a><span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">sPolicies</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-42"><a id="__codelineno-33-42" name="__codelineno-33-42" href="#__codelineno-33-42"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">sPolicyRead</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-43"><a id="__codelineno-33-43" name="__codelineno-33-43" href="#__codelineno-33-43"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_POLICY</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-44"><a id="__codelineno-33-44" name="__codelineno-33-44" href="#__codelineno-33-44"></a><span class="w">                </span><span class="n">Slog</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Policy not read&quot;</span><span class="p">);</span>
</span><span id="__span-33-45"><a id="__codelineno-33-45" name="__codelineno-33-45" href="#__codelineno-33-45"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-33-46"><a id="__codelineno-33-46" name="__codelineno-33-46" href="#__codelineno-33-46"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-47"><a id="__codelineno-33-47" name="__codelineno-33-47" href="#__codelineno-33-47"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Policy</span><span class="w"> </span><span class="n">policy</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">sPolicies</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-48"><a id="__codelineno-33-48" name="__codelineno-33-48" href="#__codelineno-33-48"></a><span class="w">                </span><span class="n">seInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">policy</span><span class="p">.</span><span class="na">getMatchedSeInfo</span><span class="p">(</span><span class="n">pkg</span><span class="p">);</span>
</span><span id="__span-33-49"><a id="__codelineno-33-49" name="__codelineno-33-49" href="#__codelineno-33-49"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">seInfo</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-50"><a id="__codelineno-33-50" name="__codelineno-33-50" href="#__codelineno-33-50"></a><span class="w">                    </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-33-51"><a id="__codelineno-33-51" name="__codelineno-33-51" href="#__codelineno-33-51"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-33-52"><a id="__codelineno-33-52" name="__codelineno-33-52" href="#__codelineno-33-52"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-33-53"><a id="__codelineno-33-53" name="__codelineno-33-53" href="#__codelineno-33-53"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-33-54"><a id="__codelineno-33-54" name="__codelineno-33-54" href="#__codelineno-33-54"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-33-55"><a id="__codelineno-33-55" name="__codelineno-33-55" href="#__codelineno-33-55"></a>
</span><span id="__span-33-56"><a id="__codelineno-33-56" name="__codelineno-33-56" href="#__codelineno-33-56"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">seInfo</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-57"><a id="__codelineno-33-57" name="__codelineno-33-57" href="#__codelineno-33-57"></a><span class="w">        </span><span class="n">seInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DEFAULT_SEINFO</span><span class="p">;</span>
</span><span id="__span-33-58"><a id="__codelineno-33-58" name="__codelineno-33-58" href="#__codelineno-33-58"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-33-59"><a id="__codelineno-33-59" name="__codelineno-33-59" href="#__codelineno-33-59"></a>
</span><span id="__span-33-60"><a id="__codelineno-33-60" name="__codelineno-33-60" href="#__codelineno-33-60"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isPrivileged</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-61"><a id="__codelineno-33-61" name="__codelineno-33-61" href="#__codelineno-33-61"></a><span class="w">        </span><span class="n">seInfo</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PRIVILEGED_APP_STR</span><span class="p">;</span>
</span><span id="__span-33-62"><a id="__codelineno-33-62" name="__codelineno-33-62" href="#__codelineno-33-62"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-33-63"><a id="__codelineno-33-63" name="__codelineno-33-63" href="#__codelineno-33-63"></a>
</span><span id="__span-33-64"><a id="__codelineno-33-64" name="__codelineno-33-64" href="#__codelineno-33-64"></a><span class="w">    </span><span class="n">seInfo</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">TARGETSDKVERSION_STR</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">targetSdkVersion</span><span class="p">;</span>
</span><span id="__span-33-65"><a id="__codelineno-33-65" name="__codelineno-33-65" href="#__codelineno-33-65"></a>
</span><span id="__span-33-66"><a id="__codelineno-33-66" name="__codelineno-33-66" href="#__codelineno-33-66"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_POLICY_INSTALL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-67"><a id="__codelineno-33-67" name="__codelineno-33-67" href="#__codelineno-33-67"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;package (&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pkg</span><span class="p">.</span><span class="na">getPackageName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;) labeled with &quot;</span>
</span><span id="__span-33-68"><a id="__codelineno-33-68" name="__codelineno-33-68" href="#__codelineno-33-68"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;seinfo=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">seInfo</span><span class="p">);</span>
</span><span id="__span-33-69"><a id="__codelineno-33-69" name="__codelineno-33-69" href="#__codelineno-33-69"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-33-70"><a id="__codelineno-33-70" name="__codelineno-33-70" href="#__codelineno-33-70"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">seInfo</span><span class="p">;</span>
</span><span id="__span-33-71"><a id="__codelineno-33-71" name="__codelineno-33-71" href="#__codelineno-33-71"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="xxx_mac_permissionsxml">xxx_mac_permissions.xml<a class="headerlink" href="#xxx_mac_permissionsxml" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="nl">http</span><span class="p">:</span><span class="c1">//aospxref.com/android-12.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/pm/SELinuxMMAC.java</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="c1">// Only initialize sMacPermissions once.</span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="kd">static</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a><span class="w">    </span><span class="c1">// Platform mac permissions.</span>
</span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a><span class="w">    </span><span class="n">sMacPermissions</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span>
</span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a><span class="w">        </span><span class="n">Environment</span><span class="p">.</span><span class="na">getRootDirectory</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;/etc/selinux/plat_mac_permissions.xml&quot;</span><span class="p">));</span>
</span><span id="__span-34-8"><a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a>
</span><span id="__span-34-9"><a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a><span class="w">    </span><span class="c1">// SystemExt mac permissions (optional).</span>
</span><span id="__span-34-10"><a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">File</span><span class="w"> </span><span class="n">systemExtMacPermission</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span>
</span><span id="__span-34-11"><a id="__codelineno-34-11" name="__codelineno-34-11" href="#__codelineno-34-11"></a><span class="w">            </span><span class="n">Environment</span><span class="p">.</span><span class="na">getSystemExtDirectory</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;/etc/selinux/system_ext_mac_permissions.xml&quot;</span><span class="p">);</span>
</span><span id="__span-34-12"><a id="__codelineno-34-12" name="__codelineno-34-12" href="#__codelineno-34-12"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">systemExtMacPermission</span><span class="p">.</span><span class="na">exists</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-13"><a id="__codelineno-34-13" name="__codelineno-34-13" href="#__codelineno-34-13"></a><span class="w">        </span><span class="n">sMacPermissions</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">systemExtMacPermission</span><span class="p">);</span>
</span><span id="__span-34-14"><a id="__codelineno-34-14" name="__codelineno-34-14" href="#__codelineno-34-14"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-34-15"><a id="__codelineno-34-15" name="__codelineno-34-15" href="#__codelineno-34-15"></a>
</span><span id="__span-34-16"><a id="__codelineno-34-16" name="__codelineno-34-16" href="#__codelineno-34-16"></a><span class="w">    </span><span class="c1">// Product mac permissions (optional).</span>
</span><span id="__span-34-17"><a id="__codelineno-34-17" name="__codelineno-34-17" href="#__codelineno-34-17"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">File</span><span class="w"> </span><span class="n">productMacPermission</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span>
</span><span id="__span-34-18"><a id="__codelineno-34-18" name="__codelineno-34-18" href="#__codelineno-34-18"></a><span class="w">            </span><span class="n">Environment</span><span class="p">.</span><span class="na">getProductDirectory</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;/etc/selinux/product_mac_permissions.xml&quot;</span><span class="p">);</span>
</span><span id="__span-34-19"><a id="__codelineno-34-19" name="__codelineno-34-19" href="#__codelineno-34-19"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">productMacPermission</span><span class="p">.</span><span class="na">exists</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-20"><a id="__codelineno-34-20" name="__codelineno-34-20" href="#__codelineno-34-20"></a><span class="w">        </span><span class="n">sMacPermissions</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">productMacPermission</span><span class="p">);</span>
</span><span id="__span-34-21"><a id="__codelineno-34-21" name="__codelineno-34-21" href="#__codelineno-34-21"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-34-22"><a id="__codelineno-34-22" name="__codelineno-34-22" href="#__codelineno-34-22"></a>
</span><span id="__span-34-23"><a id="__codelineno-34-23" name="__codelineno-34-23" href="#__codelineno-34-23"></a><span class="w">    </span><span class="c1">// Vendor mac permissions.</span>
</span><span id="__span-34-24"><a id="__codelineno-34-24" name="__codelineno-34-24" href="#__codelineno-34-24"></a><span class="w">    </span><span class="c1">// The filename has been renamed from nonplat_mac_permissions to</span>
</span><span id="__span-34-25"><a id="__codelineno-34-25" name="__codelineno-34-25" href="#__codelineno-34-25"></a><span class="w">    </span><span class="c1">// vendor_mac_permissions. Either of them should exist.</span>
</span><span id="__span-34-26"><a id="__codelineno-34-26" name="__codelineno-34-26" href="#__codelineno-34-26"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">File</span><span class="w"> </span><span class="n">vendorMacPermission</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span>
</span><span id="__span-34-27"><a id="__codelineno-34-27" name="__codelineno-34-27" href="#__codelineno-34-27"></a><span class="w">        </span><span class="n">Environment</span><span class="p">.</span><span class="na">getVendorDirectory</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;/etc/selinux/vendor_mac_permissions.xml&quot;</span><span class="p">);</span>
</span><span id="__span-34-28"><a id="__codelineno-34-28" name="__codelineno-34-28" href="#__codelineno-34-28"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vendorMacPermission</span><span class="p">.</span><span class="na">exists</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-29"><a id="__codelineno-34-29" name="__codelineno-34-29" href="#__codelineno-34-29"></a><span class="w">        </span><span class="n">sMacPermissions</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">vendorMacPermission</span><span class="p">);</span>
</span><span id="__span-34-30"><a id="__codelineno-34-30" name="__codelineno-34-30" href="#__codelineno-34-30"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-31"><a id="__codelineno-34-31" name="__codelineno-34-31" href="#__codelineno-34-31"></a><span class="w">        </span><span class="c1">// For backward compatibility.</span>
</span><span id="__span-34-32"><a id="__codelineno-34-32" name="__codelineno-34-32" href="#__codelineno-34-32"></a><span class="w">        </span><span class="n">sMacPermissions</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">Environment</span><span class="p">.</span><span class="na">getVendorDirectory</span><span class="p">(),</span>
</span><span id="__span-34-33"><a id="__codelineno-34-33" name="__codelineno-34-33" href="#__codelineno-34-33"></a><span class="w">                                     </span><span class="s">&quot;/etc/selinux/nonplat_mac_permissions.xml&quot;</span><span class="p">));</span>
</span><span id="__span-34-34"><a id="__codelineno-34-34" name="__codelineno-34-34" href="#__codelineno-34-34"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-34-35"><a id="__codelineno-34-35" name="__codelineno-34-35" href="#__codelineno-34-35"></a>
</span><span id="__span-34-36"><a id="__codelineno-34-36" name="__codelineno-34-36" href="#__codelineno-34-36"></a><span class="w">    </span><span class="c1">// ODM mac permissions (optional).</span>
</span><span id="__span-34-37"><a id="__codelineno-34-37" name="__codelineno-34-37" href="#__codelineno-34-37"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">File</span><span class="w"> </span><span class="n">odmMacPermission</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span>
</span><span id="__span-34-38"><a id="__codelineno-34-38" name="__codelineno-34-38" href="#__codelineno-34-38"></a><span class="w">        </span><span class="n">Environment</span><span class="p">.</span><span class="na">getOdmDirectory</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;/etc/selinux/odm_mac_permissions.xml&quot;</span><span class="p">);</span>
</span><span id="__span-34-39"><a id="__codelineno-34-39" name="__codelineno-34-39" href="#__codelineno-34-39"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">odmMacPermission</span><span class="p">.</span><span class="na">exists</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-40"><a id="__codelineno-34-40" name="__codelineno-34-40" href="#__codelineno-34-40"></a><span class="w">        </span><span class="n">sMacPermissions</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">odmMacPermission</span><span class="p">);</span>
</span><span id="__span-34-41"><a id="__codelineno-34-41" name="__codelineno-34-41" href="#__codelineno-34-41"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-34-42"><a id="__codelineno-34-42" name="__codelineno-34-42" href="#__codelineno-34-42"></a><span class="p">}</span>
</span><span id="__span-34-43"><a id="__codelineno-34-43" name="__codelineno-34-43" href="#__codelineno-34-43"></a>
</span><span id="__span-34-44"><a id="__codelineno-34-44" name="__codelineno-34-44" href="#__codelineno-34-44"></a><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">readInstallPolicy</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-45"><a id="__codelineno-34-45" name="__codelineno-34-45" href="#__codelineno-34-45"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-34-46"><a id="__codelineno-34-46" name="__codelineno-34-46" href="#__codelineno-34-46"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sMacPermissions</span><span class="p">.</span><span class="na">size</span><span class="p">();</span>
</span><span id="__span-34-47"><a id="__codelineno-34-47" name="__codelineno-34-47" href="#__codelineno-34-47"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-48"><a id="__codelineno-34-48" name="__codelineno-34-48" href="#__codelineno-34-48"></a><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">File</span><span class="w"> </span><span class="n">macPermission</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sMacPermissions</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-34-49"><a id="__codelineno-34-49" name="__codelineno-34-49" href="#__codelineno-34-49"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-50"><a id="__codelineno-34-50" name="__codelineno-34-50" href="#__codelineno-34-50"></a><span class="w">            </span><span class="n">policyFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileReader</span><span class="p">(</span><span class="n">macPermission</span><span class="p">);</span>
</span><span id="__span-34-51"><a id="__codelineno-34-51" name="__codelineno-34-51" href="#__codelineno-34-51"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Using policy file &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">macPermission</span><span class="p">);</span>
</span><span id="__span-34-52"><a id="__codelineno-34-52" name="__codelineno-34-52" href="#__codelineno-34-52"></a>
</span><span id="__span-34-53"><a id="__codelineno-34-53" name="__codelineno-34-53" href="#__codelineno-34-53"></a><span class="w">            </span><span class="n">parser</span><span class="p">.</span><span class="na">setInput</span><span class="p">(</span><span class="n">policyFile</span><span class="p">);</span>
</span><span id="__span-34-54"><a id="__codelineno-34-54" name="__codelineno-34-54" href="#__codelineno-34-54"></a><span class="w">            </span><span class="p">...</span>
</span><span id="__span-34-55"><a id="__codelineno-34-55" name="__codelineno-34-55" href="#__codelineno-34-55"></a>
</span><span id="__span-34-56"><a id="__codelineno-34-56" name="__codelineno-34-56" href="#__codelineno-34-56"></a><span class="w">            </span><span class="n">policies</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">readSignerOrThrow</span><span class="p">(</span><span class="n">parser</span><span class="p">));</span>
</span><span id="__span-34-57"><a id="__codelineno-34-57" name="__codelineno-34-57" href="#__codelineno-34-57"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-34-58"><a id="__codelineno-34-58" name="__codelineno-34-58" href="#__codelineno-34-58"></a><span class="w">        </span><span class="p">...</span>
</span><span id="__span-34-59"><a id="__codelineno-34-59" name="__codelineno-34-59" href="#__codelineno-34-59"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-34-60"><a id="__codelineno-34-60" name="__codelineno-34-60" href="#__codelineno-34-60"></a>
</span><span id="__span-34-61"><a id="__codelineno-34-61" name="__codelineno-34-61" href="#__codelineno-34-61"></a><span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">sPolicies</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-62"><a id="__codelineno-34-62" name="__codelineno-34-62" href="#__codelineno-34-62"></a><span class="w">        </span><span class="n">sPolicies</span><span class="p">.</span><span class="na">clear</span><span class="p">();</span>
</span><span id="__span-34-63"><a id="__codelineno-34-63" name="__codelineno-34-63" href="#__codelineno-34-63"></a><span class="w">        </span><span class="n">sPolicies</span><span class="p">.</span><span class="na">addAll</span><span class="p">(</span><span class="n">policies</span><span class="p">);</span>
</span><span id="__span-34-64"><a id="__codelineno-34-64" name="__codelineno-34-64" href="#__codelineno-34-64"></a>
</span><span id="__span-34-65"><a id="__codelineno-34-65" name="__codelineno-34-65" href="#__codelineno-34-65"></a><span class="w">        </span><span class="p">...</span>
</span><span id="__span-34-66"><a id="__codelineno-34-66" name="__codelineno-34-66" href="#__codelineno-34-66"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-34-67"><a id="__codelineno-34-67" name="__codelineno-34-67" href="#__codelineno-34-67"></a>
</span><span id="__span-34-68"><a id="__codelineno-34-68" name="__codelineno-34-68" href="#__codelineno-34-68"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-34-69"><a id="__codelineno-34-69" name="__codelineno-34-69" href="#__codelineno-34-69"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>"/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/etc/&amp;project=frameworks">etc</a>/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/etc/selinux/&amp;project=frameworks">selinux</a>/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/etc/selinux/plat_mac_permissions.xml&amp;project=frameworks">plat_mac_permissions.xml</a>"</li>
<li>"/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/etc/&amp;project=frameworks">etc</a>/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/etc/selinux/&amp;project=frameworks">selinux</a>/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/etc/selinux/system_ext_mac_permissions.xml&amp;project=frameworks">system_ext_mac_permissions.xml</a>"</li>
<li>"/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/etc/&amp;project=frameworks">etc</a>/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/etc/selinux/&amp;project=frameworks">selinux</a>/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/etc/selinux/product_mac_permissions.xml&amp;project=frameworks">product_mac_permissions.xml</a>"</li>
<li>"/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/etc/&amp;project=frameworks">etc</a>/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/etc/selinux/&amp;project=frameworks">selinux</a>/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/etc/selinux/vendor_mac_permissions.xml&amp;project=frameworks">vendor_mac_permissions.xml</a>"</li>
<li>"/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/etc/&amp;project=frameworks">etc</a>/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/etc/selinux/&amp;project=frameworks">selinux</a>/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/etc/selinux/nonplat_mac_permissions.xml&amp;project=frameworks">nonplat_mac_permissions.xml</a>"</li>
<li>"/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/etc/&amp;project=frameworks">etc</a>/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/etc/selinux/&amp;project=frameworks">selinux</a>/<a href="http://aospxref.com/android-12.0.0_r3/s?path=/etc/selinux/odm_mac_permissions.xml&amp;project=frameworks">odm_mac_permissions.xml</a>"</li>
</ul>
<p>比如： <a href="http://aospxref.com/android-12.0.0_r3/xref/system/sepolicy/private/mac_permissions.xml">system/sepolicy/private/mac_permissions.xml</a> 的内容如下：</p>
<div class="language-xml highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="nt">&lt;policy&gt;</span>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="w">    </span><span class="cm">&lt;!-- Platform dev key in AOSP --&gt;</span>
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="w">    </span><span class="nt">&lt;signer</span><span class="w"> </span><span class="na">signature=</span><span class="s">&quot;@PLATFORM&quot;</span><span class="w"> </span><span class="nt">&gt;</span>
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="w">      </span><span class="nt">&lt;seinfo</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;platform&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
</span><span id="__span-35-6"><a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a><span class="w">    </span><span class="nt">&lt;/signer&gt;</span>
</span><span id="__span-35-7"><a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a>
</span><span id="__span-35-8"><a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a><span class="w">    </span><span class="cm">&lt;!-- Media key in AOSP --&gt;</span>
</span><span id="__span-35-9"><a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a><span class="w">    </span><span class="nt">&lt;signer</span><span class="w"> </span><span class="na">signature=</span><span class="s">&quot;@MEDIA&quot;</span><span class="w"> </span><span class="nt">&gt;</span>
</span><span id="__span-35-10"><a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a><span class="w">      </span><span class="nt">&lt;seinfo</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;media&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
</span><span id="__span-35-11"><a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a><span class="w">    </span><span class="nt">&lt;/signer&gt;</span>
</span><span id="__span-35-12"><a id="__codelineno-35-12" name="__codelineno-35-12" href="#__codelineno-35-12"></a>
</span><span id="__span-35-13"><a id="__codelineno-35-13" name="__codelineno-35-13" href="#__codelineno-35-13"></a><span class="w">    </span><span class="nt">&lt;signer</span><span class="w"> </span><span class="na">signature=</span><span class="s">&quot;@NETWORK_STACK&quot;</span><span class="w"> </span><span class="nt">&gt;</span>
</span><span id="__span-35-14"><a id="__codelineno-35-14" name="__codelineno-35-14" href="#__codelineno-35-14"></a><span class="w">      </span><span class="nt">&lt;seinfo</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;network_stack&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
</span><span id="__span-35-15"><a id="__codelineno-35-15" name="__codelineno-35-15" href="#__codelineno-35-15"></a><span class="w">    </span><span class="nt">&lt;/signer&gt;</span>
</span><span id="__span-35-16"><a id="__codelineno-35-16" name="__codelineno-35-16" href="#__codelineno-35-16"></a><span class="nt">&lt;/policy&gt;</span>
</span></code></pre></div>
<p>至此，简要的说明了一个app进程在启动时被贴SE标签的过程。</p>
<h2 id="_9">编译验证<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h2>
<p>从上一小节可知，系统会实时编译 CIL 文件，所以编译验证按如下步骤：</p>
<ul>
<li>删除 <code>/odm/etc/selinux/precompiled_sepolicy</code> 文件</li>
<li>编译生成 <code>"/system/etc/selinux/plat_sepolicy.cil"</code> 或 <code>"/vendor/etc/selinux/vendor_sepolicy.cil"</code></li>
<li>将编译生成的 <code>.cil</code> 文件push到手机</li>
<li>重启手机
<div class="language-shell highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>$<span class="w"> </span><span class="nb">time</span><span class="w"> </span>prebuilts/build-tools/linux-x86/bin/ninja<span class="w"> </span>-f<span class="w"> </span>out/combined-lemonadep.ninja<span class="w"> </span>-j64<span class="w"> </span>plat_sepolicy.cil
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="o">[</span><span class="m">2</span>/2<span class="o">]</span><span class="w"> </span>Install:<span class="w"> </span>out/target/product/lemonadep/system/etc/selinux/plat_sepolicy.cil
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a>real<span class="w">    </span>0m0.932s
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a>user<span class="w">    </span>0m17.872s
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a>sys<span class="w"> </span>0m1.028s
</span><span id="__span-36-6"><a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a>
</span><span id="__span-36-7"><a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a>adb<span class="w"> </span>push<span class="w"> </span>/out/target/product/lemonadep/system/etc/selinux/plat_sepolicy.cil<span class="w"> </span>/system/etc/selinux/plat_sepolicy.cil
</span><span id="__span-36-8"><a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a>
</span><span id="__span-36-9"><a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a>adb<span class="w"> </span>reboot
</span></code></pre></div></li>
</ul>
<h2 id="_10">辅助工具<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h2>
<p>Android平台上提供了一些辅助工具，以便可以更好的来管理和调试SE规则：</p>
<ul>
<li><strong>chcon</strong>: 变更文件的SE标签。</li>
<li><strong>getenforce/setenforce</strong>: 获取/设置当前环境的 SELinux 模式。</li>
<li><strong>ls -Z</strong>: 查看文件的SE标签。</li>
<li><strong>ps -Z</strong>: 查看进程的SE标签。</li>
<li><strong>restorecon</strong>: 根据平台SE配置，回复某个文件的SE标签。</li>
<li><strong>runcon</strong>: 以指定的SE标签启动某个进程。</li>
</ul>
<h3 id="sys">内核/sys/驱动节点<a class="headerlink" href="#sys" title="Permanent link">&para;</a></h3>
<p><code>/sys/fs/selinux/</code> 目录是SELinux的相关内核驱动节点，可以通过 <code>cat</code> 获取一些关于SE的状态信息。如，查看当前SE的enforce状态：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a>lemonadep:/sys/fs/selinux<span class="w"> </span><span class="c1">## cat /sys/fs/selinux/enforce</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="m">1</span>
</span></code></pre></div>
<h2 id="faq">FAQ<a class="headerlink" href="#faq" title="Permanent link">&para;</a></h2>
<h3 id="security-context">安全上下文(security context)<a class="headerlink" href="#security-context" title="Permanent link">&para;</a></h3>
<p>SEAndroid是一种基于安全策略的MAC安全机制。这种安全策略又是建立在对象的安全上下文的基础上的。这里所说的对象分为两种类型，一种称主体（Subject），一种称为客体（Object）。主体通常就是指进程，而客观就是指进程所要访问的资源，例如文件、系统属性等。
安全上下文实际上就是一个附加在对象上的标签（Tag）。这个标签实际上就是一个字符串，它由四部分内容组成，分别是SELinux用户、SELinux角色、类型、安全级别，每一个部分都通过一个冒号来分隔，格式为：<strong>user:role:type:sensitivity</strong>。</p>
<ul>
<li><strong>安全级别</strong>：最开始的目的是用来对美国政府分类文件进行访问控制的。在基于安全级别的MAC安全机制中，主体（subject）和客体（object）都关联有一个安全级别。其中，安全级别较高的主体可以读取安全级别较低的客体，而安全级别较低的主体可以写入安全级别较高的客体。前者称为“read down”，而后者称为“write up”。通过这种规则，可以允许数据从安全级别较低的主体流向安全级别较高的主体，而限制数据从安全级别较高的主体流向安全级别较低的主体，从而有效地保护了数据。注意，如果主体和客体的安全级别是相同的，那么主体是可以对客体进行读和写的。</li>
</ul>
<h3 id="file_contexts">file_contexts 如何生效？<a class="headerlink" href="#file_contexts" title="Permanent link">&para;</a></h3>
<p>在创建新 <code>te</code> 时，请创建或更新该文件，以便为文件分配新标签。如需应用新的 <code>file_contexts</code>，请重新构建文件系统映像，或对要重新添加标签的文件运行 <code>restorecon</code>。在升级时，对 <code>file_contexts</code> 所做的更改会在升级过程中自动应用于系统和用户数据分区。此外，您还可以通过以下方式使这些更改在升级过程中自动应用于其他分区：在以允许读写的方式装载相应分区后，将 <code>restorecon_recursive</code> 调用添加到 init.board.rc 文件中。
<em>创建文件时， 若无特殊指定， 会继承其父目录的安全上下文</em> （<a href="http://lishiwen4.github.io/android/selinux-security-context">####7.2 文件的安全上下文</a>）
SELinux中所有的文件系统的初始安全上下文是在挂载时标记的的，根据文件系统的不同，其labeling的规则有所差异。</p>
<h3 id="check-the-policies-built-through-the-intermediates-files">Check the policies built through the intermediates files.<a class="headerlink" href="#check-the-policies-built-through-the-intermediates-files" title="Permanent link">&para;</a></h3>
<p><code>$OUT/obj/ETC/sepolicy_intermediates/policy.conf</code>
The file will list all the processed policies with a comment detailing the source</p>
<h3 id="how-to-check-that-your-modifications-are-allowed">How to check that your modifications are allowed？<a class="headerlink" href="#how-to-check-that-your-modifications-are-allowed" title="Permanent link">&para;</a></h3>
<p>build only the sepolicy project：<code>mmm -B external/sepolicy</code></p>
<h3 id="how-to-disable-it">How to disable it?<a class="headerlink" href="#how-to-disable-it" title="Permanent link">&para;</a></h3>
<p>Since SELinux can impede development, it might be useful to disable it during debugging phase. For a runtime disablement, you can use setenforce.</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a>$<span class="w"> </span>adb<span class="w"> </span>shell<span class="w"> </span>setenforce<span class="w"> </span><span class="m">0</span>
</span></code></pre></div>
<p><strong>kernel**中彻底关闭：修改<code>LINUX/android/kernel/arch/arm64/configs/xxx_defconfig</code>文件（xxx一般为手机产品名）， 去掉<code>CONFIG_SECURITY_SELINUX=y</code>的配置项
For a more permanent option, we’ve added a trigger to the boot script that allows you to disable enforcement from **U-Boot</strong>.</p>
<ul>
<li>If you want to be permissive (denials logged in dmesg but not enforced)</li>
</ul>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a>U-Boot<span class="w"> </span>&gt;<span class="w"> </span>setenv<span class="w"> </span>selinux<span class="w"> </span>permissive
</span></code></pre></div>
<ul>
<li>If you want to disable selinux completely (no logs)</li>
</ul>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a>U-Boot<span class="w"> </span>&gt;<span class="w"> </span>setenv<span class="w"> </span>selinux<span class="w"> </span>disabled
</span></code></pre></div>
<blockquote>
<p>NOTE: disabling SELinux completely isn’t possible since Android Nougat due to <a href="https://android.googlesource.com/platform/system/core/+/d34e407aeb5898f19d4f042b7558420bbb3a1817">this patch</a>.</p>
</blockquote>
<h3 id="_11">如何在设备上默认打开或关闭？<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<p>如下code会检测cmdline对selinux的配置，可以直接写死 <code>status</code> 变量来打开/关闭 SELinux。</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="nl">http</span><span class="p">:</span><span class="c1">//aospxref.com/android-12.0.0_r3/xref/system/core/init/selinux.cpp</span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="k">enum</span><span class="w"> </span><span class="nc">EnforcingStatus</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">SELINUX_PERMISSIVE</span><span class="p">,</span><span class="w"> </span><span class="n">SELINUX_ENFORCING</span><span class="w"> </span><span class="p">};</span>
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a>
</span><span id="__span-41-5"><a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="n">EnforcingStatus</span><span class="w"> </span><span class="nf">StatusFromProperty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-6"><a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a><span class="w">    </span><span class="n">EnforcingStatus</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SELINUX_ENFORCING</span><span class="p">;</span>
</span><span id="__span-41-7"><a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a>
</span><span id="__span-41-8"><a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a><span class="w">    </span><span class="n">ImportKernelCmdline</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-9"><a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">key</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;androidboot.selinux&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;permissive&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-10"><a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a><span class="w">            </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SELINUX_PERMISSIVE</span><span class="p">;</span>
</span><span id="__span-41-11"><a id="__codelineno-41-11" name="__codelineno-41-11" href="#__codelineno-41-11"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-41-12"><a id="__codelineno-41-12" name="__codelineno-41-12" href="#__codelineno-41-12"></a><span class="w">    </span><span class="p">});</span>
</span><span id="__span-41-13"><a id="__codelineno-41-13" name="__codelineno-41-13" href="#__codelineno-41-13"></a>
</span><span id="__span-41-14"><a id="__codelineno-41-14" name="__codelineno-41-14" href="#__codelineno-41-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SELINUX_ENFORCING</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-15"><a id="__codelineno-41-15" name="__codelineno-41-15" href="#__codelineno-41-15"></a><span class="w">        </span><span class="n">ImportBootconfig</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-16"><a id="__codelineno-41-16" name="__codelineno-41-16" href="#__codelineno-41-16"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">key</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;androidboot.selinux&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;permissive&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-17"><a id="__codelineno-41-17" name="__codelineno-41-17" href="#__codelineno-41-17"></a><span class="w">                </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SELINUX_PERMISSIVE</span><span class="p">;</span>
</span><span id="__span-41-18"><a id="__codelineno-41-18" name="__codelineno-41-18" href="#__codelineno-41-18"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-41-19"><a id="__codelineno-41-19" name="__codelineno-41-19" href="#__codelineno-41-19"></a><span class="w">        </span><span class="p">});</span>
</span><span id="__span-41-20"><a id="__codelineno-41-20" name="__codelineno-41-20" href="#__codelineno-41-20"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-41-21"><a id="__codelineno-41-21" name="__codelineno-41-21" href="#__codelineno-41-21"></a>
</span><span id="__span-41-22"><a id="__codelineno-41-22" name="__codelineno-41-22" href="#__codelineno-41-22"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
</span><span id="__span-41-23"><a id="__codelineno-41-23" name="__codelineno-41-23" href="#__codelineno-41-23"></a><span class="p">}</span>
</span></code></pre></div>
<p>编译和运行</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a>$<span class="w"> </span><span class="nb">time</span><span class="w"> </span>prebuilts/build-tools/linux-x86/bin/ninja<span class="w"> </span>-f<span class="w"> </span>out/combined-lemonadep.ninja<span class="w"> </span>-j64<span class="w"> </span>init_second_stage
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="o">[</span><span class="m">7</span>/7<span class="o">]</span><span class="w"> </span>Install:<span class="w"> </span>out/target/product/lemonadep/system/bin/init
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a>
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a>real<span class="w">    </span>0m3.198s
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a>user<span class="w">    </span>0m19.220s
</span><span id="__span-42-6"><a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a>sys<span class="w"> </span>0m1.744s
</span><span id="__span-42-7"><a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a>
</span><span id="__span-42-8"><a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a>
</span><span id="__span-42-9"><a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a>adb<span class="w"> </span>push<span class="w"> </span>out/target/product/lemonadep/system/bin/init<span class="w"> </span>/system/bin/init
</span></code></pre></div>
<h3 id="how-to-createextend-a-policy">How to create/extend a policy?<a class="headerlink" href="#how-to-createextend-a-policy" title="Permanent link">&para;</a></h3>
<p>The first step is to be able to identify the denials from. If SELinux is set to be <em>permissive</em> or <em>enforcing</em>, you can simply look at the kernel logs.</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a>$<span class="w"> </span>adb<span class="w"> </span>shell<span class="w"> </span>dmesg<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="sb">``</span>grep<span class="sb">`</span><span class="w"> </span><span class="sb">`</span>avc
</span></code></pre></div>
<p>Some tools exist to generate policies directly from the above logs.</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>policycoreutils
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a>$<span class="w"> </span>adb<span class="w"> </span>shell<span class="w"> </span>dmesg<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>avc<span class="w"> </span><span class="p">|</span><span class="w"> </span>audit2allow
</span></code></pre></div>
<p>Once the policy has been generated, it needs to be included to the SELinux system configuration.
The first rule to add a policy is to <strong>NEVER</strong> modify the <code>external/sepolicy</code> project. Instead your <code>[BoardConfig.mk](http://boardconfig.mk/)</code> should specify some <code>BOARD_SEPOLICY_DIRS</code> directories from which policy can be overridden or unionised. In our BSP, every <code>[BoardConfig.mk](http://boardconfig.mk/)</code> include <code>[sepolicy.mk](https://github.com/boundarydevices/android_device_boundary/blob/boundary-imx-l5.0.0_1.0.0-ga/sepolicy.mk)</code> which specify the .te files location/</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a>BOARD_SEPOLICY_DIRS<span class="w"> </span>:<span class="o">=</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="w"> </span>device/boundary/sepolicy<span class="w"> </span><span class="se">\</span>
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="w"> </span>device/fsl/sabresd_6dq/sepolicy
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a>
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a>BOARD_SEPOLICY_UNION<span class="w"> </span>:<span class="o">=</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-45-6"><a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a><span class="w"> </span>app.te<span class="w"> </span><span class="se">\</span>
</span><span id="__span-45-7"><a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a><span class="w"> </span>file_contexts<span class="w"> </span><span class="se">\</span>
</span><span id="__span-45-8"><a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a><span class="w"> </span>fs_use<span class="w"> </span><span class="se">\</span>
</span><span id="__span-45-9"><a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a><span class="w"> </span>genfs_contexts<span class="w"> </span><span class="se">\</span>
</span><span id="__span-45-10"><a id="__codelineno-45-10" name="__codelineno-45-10" href="#__codelineno-45-10"></a><span class="w"> </span>netd.te<span class="w"> </span><span class="se">\</span>
</span><span id="__span-45-11"><a id="__codelineno-45-11" name="__codelineno-45-11" href="#__codelineno-45-11"></a><span class="w"> </span>untrusted_app.te<span class="w"> </span><span class="se">\</span>
</span></code></pre></div>
<p>We invite you to browse our policy changes made for the Lollipop release: 
<a href="https://github.com/boundarydevices/android_device_boundary/tree/boundary-imx-l5.0.0_1.0.0-ga/sepolicy">https://github.com/boundarydevices/android_device_boundary/tree/boundary-imx-l5.0.0_1.0.0-ga/sepolicy</a></p>
<h3 id="how-to-custom-security-context-of-process">How to custom Security Context of process?<a class="headerlink" href="#how-to-custom-security-context-of-process" title="Permanent link">&para;</a></h3>
<p><strong>1. Define a Context</strong></p>
<p>Let's assume you want to create a custom context called <code>np_mybinary</code> for your binary.
This is what your <code>.te</code> file will have to contain:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="nb">type</span><span class="w"> </span>np_mybinary,<span class="w"> </span>domain<span class="p">;</span>
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="nb">type</span><span class="w"> </span>np_mybinary_exec,<span class="w"> </span>exec_type,<span class="w"> </span>vendor_file_type,<span class="w"> </span>file_type<span class="p">;</span>
</span></code></pre></div>
<p>This is what your <code>file_contexts</code> file will have to contain:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a>/system/bin/mymodule<span class="w">  </span>u:object_r:np_mybinary_exec:s0
</span></code></pre></div>
<p><strong>2. Define a Transition</strong></p>
<p>You need to define the transition from the parent process context to <code>np_mybinary_exec</code>.</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a>domain_auto_trans<span class="o">(</span>&lt;parent-context&gt;,<span class="w"> </span>np_mybinary,<span class="w"> </span>np_mybinary_exec<span class="o">)</span>
</span></code></pre></div>
<p>If your process is started by init, there is a <a href="https://android.googlesource.com/platform/system/sepolicy/+/refs/heads/pie-release/public/te_macros#162">simple macro</a> available:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a>init_daemon_domain<span class="o">(</span>np_mybinary<span class="o">)</span><span class="p">;</span>
</span></code></pre></div>
<p>手动添加SEPolicy权限。</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="c1">## denied log</span>
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="nv">type</span><span class="o">=</span><span class="m">1400</span><span class="w"> </span>audit<span class="o">(</span><span class="m">32</span>.939:25<span class="o">)</span>:<span class="w"> </span>avc:<span class="w"> </span>denied<span class="w"> </span><span class="o">{</span><span class="w"> </span>open<span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">pid</span><span class="o">=</span><span class="m">2592</span><span class="w"> </span><span class="nv">comm</span><span class="o">=</span><span class="s2">&quot;chmod&quot;</span><span class="w"> </span><span class="nv">path</span><span class="o">=</span><span class="s2">&quot;/dev/block/mmcblk0p25&quot;</span><span class="w"> </span><span class="nv">dev</span><span class="o">=</span><span class="s2">&quot;tmpfs&quot;</span><span class="w"> </span><span class="nv">ino</span><span class="o">=</span><span class="m">6494</span>
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a><span class="nv">scontext</span><span class="o">=</span>u:r:init_shell:s0<span class="w"> </span><span class="nv">tcontext</span><span class="o">=</span>u:object_r:block_device:s0<span class="w"> </span><span class="nv">tclass</span><span class="o">=</span>blk_file<span class="w"> </span><span class="nv">permissive</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-50-4"><a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a>
</span><span id="__span-50-5"><a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a><span class="c1">## 关键信息</span>
</span><span id="__span-50-6"><a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a><span class="c1">## avc: denied {操作权限} for pid=7201 comm=&quot;进程名&quot; scontext=u:r:源类型:s0 tcontext=u:r:目标类型:s0 tclass=访问类型 permissive=0</span>
</span><span id="__span-50-7"><a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a>denied<span class="w"> </span><span class="o">{</span><span class="w"> </span>open<span class="w"> </span><span class="o">}</span><span class="w">             </span>u:r:init_shell:s0<span class="w">            </span>u:object_r:block_device:s0<span class="w">       </span>blk_file
</span><span id="__span-50-8"><a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a><span class="w">             </span>A<span class="w">              </span>B<span class="w">                            </span>C<span class="w">                                </span>D
</span><span id="__span-50-9"><a id="__codelineno-50-9" name="__codelineno-50-9" href="#__codelineno-50-9"></a>
</span><span id="__span-50-10"><a id="__codelineno-50-10" name="__codelineno-50-10" href="#__codelineno-50-10"></a><span class="c1">## 生成规则：/system/sepolicy/private/init_shell.te</span>
</span><span id="__span-50-11"><a id="__codelineno-50-11" name="__codelineno-50-11" href="#__codelineno-50-11"></a><span class="c1">## 格式：allow  源类型 目标类型:访问类型 {操作权限};</span>
</span><span id="__span-50-12"><a id="__codelineno-50-12" name="__codelineno-50-12" href="#__codelineno-50-12"></a>allow<span class="w"> </span>init_shell<span class="w">  </span>block_device:blk_file<span class="w"> </span>open<span class="p">;</span>
</span><span id="__span-50-13"><a id="__codelineno-50-13" name="__codelineno-50-13" href="#__codelineno-50-13"></a><span class="w">      </span>B<span class="w">           </span>C<span class="w">            </span>D<span class="w">        </span>A
</span></code></pre></div>
<h2 id="_12">万能公式<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h2>
<p><div class="language-java highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="mi">11</span><span class="o">-</span><span class="mo">04</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">37</span><span class="p">:</span><span class="mf">12.143</span><span class="w">   </span><span class="mi">653</span><span class="w">   </span><span class="mi">653</span><span class="w"> </span><span class="n">W</span><span class="w"> </span><span class="n">boot</span><span class="err">@</span><span class="mf">1.1</span><span class="o">-</span><span class="n">servic</span><span class="p">:</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="mi">1400</span><span class="w"> </span><span class="n">audit</span><span class="p">(</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">93</span><span class="p">):</span><span class="w"> </span><span class="n">avc</span><span class="p">:</span><span class="w"> </span><span class="n">denied</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">getattr</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">path</span><span class="o">=</span><span class="s">&quot;/dev/block/sde21&quot;</span><span class="w"> </span><span class="n">dev</span><span class="o">=</span><span class="s">&quot;tmpfs&quot;</span><span class="w"> </span><span class="n">ino</span><span class="o">=</span><span class="mi">2240</span><span class="w"> </span><span class="n">scontext</span><span class="o">=</span><span class="n">u</span><span class="p">:</span><span class="n">r</span><span class="p">:</span><span class="n">hal_bootctl_default</span><span class="p">:</span><span class="n">s0</span><span class="w"> </span><span class="n">tcontext</span><span class="o">=</span><span class="n">u</span><span class="p">:</span><span class="n">object_r</span><span class="p">:</span><span class="n">vendor_uefi_block_device</span><span class="p">:</span><span class="n">s0</span><span class="w"> </span><span class="n">tclass</span><span class="o">=</span><span class="n">blk_file</span><span class="w"> </span><span class="n">permissive</span><span class="o">=</span><span class="mi">0</span>
</span></code></pre></div>
如上log是android.hardware.boot@1.1-service没有权限。
根据打印出来的avclog：</p>
<ul>
<li>缺少什么权限：avc: denied { getattr }</li>
<li>谁缺少权限：scontext=u:r:hal_bootctl_default</li>
<li>对哪个文件缺少权限：tcontext=u:object_r:vendor_uefi_block_device:s0</li>
<li>什么类型的文件：tclass=blk_file</li>
</ul>
<p>也就是说：hal_bootctl_default进程对vendor_uefi_block_device类型的blk_file缺少getattr权限。所以添加的权限如下：</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="n">allow</span><span class="w"> </span><span class="n">hal_bootctl_default</span><span class="w"> </span><span class="n">vendor_uefi_block_device</span><span class="p">:</span><span class="n">blk_file</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">getattr</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div>
<p>但是，这有一个巨大的坑！有时候avc denied的log不是一次性暴露所有权限问题，要等解决一个权限问题之后，才会暴露另外一个权限问题。比如提示缺少某个目录的read权限，加入read之后，才显示缺少write权限，要一次次一次试，一次一次加，时间成本极大。所以我们直接给最高的权限（一般不建议），代码如下：</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="n">allow</span><span class="w"> </span><span class="n">hal_bootctl_default</span><span class="w"> </span><span class="n">vendor_uefi_block_device</span><span class="p">:</span><span class="n">blk_file</span><span class="w"> </span><span class="n">create_dir_perms</span>
</span></code></pre></div>
<p>有的同学比较喜欢用audit2allow，我刚接触seliunx时也是极度依赖audit2allow。后来学习了selinux一些知识并总结这个万能公式后，就不再用audit2allow了。</p>
<h2 id="reference">Reference<a class="headerlink" href="#reference" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://selinuxproject.org/page/NewUsers">https://selinuxproject.org/page/NewUsers</a></li>
<li><a href="https://boundarydevices.com/android-security-part-3-security-enhanced-linux-in-android/">https://boundarydevices.com/android-security-part-3-security-enhanced-linux-in-android/</a></li>
<li>CIL (Common Intermediate Language)：<a href="https://github.com/SELinuxProject/selinux/blob/master/secilc/docs/README.md">https://github.com/SELinuxProject/selinux/blob/master/secilc/docs/README.md</a></li>
<li><a href="https://source.android.com/security/selinux">https://source.android.com/security/selinux</a></li>
</ul>







  
  






  <h2 id="__comments">评论</h2>
  <!-- Insert generated snippet here -->

    <script src="https://giscus.app/client.js"
        data-repo="i-rtfsc/i-rtfsc.github.io"
        data-repo-id="MDEwOlJlcG9zaXRvcnkxNTU2NzA2OTE="
        data-category="Q&A"
        data-category-id="DIC_kwDOCUdYo84CeZYU"
        data-mapping="pathname"
        data-strict="1"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="preferred_color_scheme"
        data-lang="zh-CN"
        data-loading="lazy"
        data-default-reactions-enabled="1"
        crossorigin="anonymous"
        async>
    </script>

  <!-- Synchronize Giscus theme with palette -->
  <script>
    var giscus = document.querySelector("script[src*=giscus]")

    // Set palette on initial load
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object") {
      var theme = palette.color.scheme === "slate"
        ? "transparent_dark"
        : "light"

      // Instruct Giscus to set theme
      giscus.setAttribute("data-theme", theme)
    }

    // Register event handlers after documented loaded
    document.addEventListener("DOMContentLoaded", function() {
      var ref = document.querySelector("[data-md-component=palette]")
      ref.addEventListener("change", function() {
        var palette = __md_get("__palette")
        if (palette && typeof palette.color === "object") {
          var theme = palette.color.scheme === "slate"
            ? "transparent_dark"
            : "light"

          // Instruct Giscus to change theme
          var frame = document.querySelector(".giscus-frame")
          frame.contentWindow.postMessage(
            { giscus: { setConfig: { theme } } },
            "https://giscus.app"
          )
        }
      })
    })
  </script>


<script src="//code.tidio.co/rqu0g9yeqzoipyjjehe84aqmiqt1ap9r.js" async></script>


                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
    
    
    
    <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
        
        <a href="../../broadcast/intro/" class="md-footer__link md-footer__link--prev"
           aria-label="上一页: Broadcast概述">
            <div class="md-footer__button md-icon">
                
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
                <div class="md-ellipsis">
                    Broadcast概述
                </div>
            </div>
        </a>
        
        
        
        <a href="../genfscon/" class="md-footer__link md-footer__link--next"
           aria-label="下一页: genfscon">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
                <div class="md-ellipsis">
                    genfscon
                </div>
            </div>
            <div class="md-footer__button md-icon">
                
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
        </a>
        
    </nav>
    
    
    <div class="md-footer-meta md-typeset">
        <div class="md-footer-meta__inner md-grid">
            <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2015-2025 Solo</br>The website content is licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a>
    </div>
  
  
</div>

            
            <div class="md-copyright">
    <font size=1>
        
        <a href="https://icp.gov.moe/?keyword=20243250" target="_blank">萌ICP备20243250号</a>
        

        
        <span>&nbsp;|&nbsp;本站访问量：</span>
        <script async src="//finicounter.eu.org/finicounter.js"></script>
        <span id="finicount_views"></span>
        

        
        
        <span>&nbsp;|&nbsp;本站已经运行：</span>
        <span id="uptime"></span>
        <script>
            function calculateUptime() {
                let dateString = '2018-11-1'
                let start = new Date(dateString);
                let currentTime = new Date();
                let difference = currentTime - start;
                let days = Math.floor(difference / (1000 * 60 * 60 * 24));
                document.getElementById('uptime').textContent = days + '天';
            }

            calculateUptime()
        </script>
        
    </font>
</div>
            

            
            <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/i-rtfsc" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
    <a href="mailto:<anqi.huang@outlook.com>" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 493.2 160 480v-83.6c0-4 1.5-7.8 4.2-10.8l167.6-182.8c5.8-6.3 5.6-16-.4-22s-15.7-6.4-22-.7L106 360.8l-88.3-44.2C7.1 311.3.3 300.7 0 288.9s5.9-22.8 16.1-28.7l448-256c10.7-6.1 23.9-5.5 34 1.4"/></svg>
    </a>
  
</div>
            
        </div>
    </div>

</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.code.select", "content.tooltips", "navigation.indexes", "navigation.top", "navigation.footer", "navigation.tracking", "navigation.path", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.tabs", "navigation.tabs.sticky", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": {"Default": "default-tag", "Hardware": "hardware-tag", "Software": "software-tag"}, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.60a45f97.min.js"></script>
      
        <script src="../../../javascripts/extra.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mermaid@10.0.2/dist/add-html-label-6e56ed67.min.js"></script>
      
    
  </body>
</html>