
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Broadcast概述。">
      
      
        <meta name="author" content="Solo">
      
      
        <link rel="canonical" href="https://0.0.0.0:8000/android/broadcast/intro/">
      
      
        <link rel="prev" href="../../ams/frida-dump-activity-lifecycle/">
      
      
        <link rel="next" href="../../selinux/intro/">
      
      
      <link rel="icon" href="../../../assets/images/logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.50">
    
    
      
        <title>Broadcast概述 - Solo's Blog</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.a40c8224.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../fonts/lxgw-wenkai.css">
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
      <link rel="stylesheet" href="../../../stylesheets/extra2.css">
    
      <link rel="stylesheet" href="../../../stylesheets/link.css">
    
      <link rel="stylesheet" href="../../../stylesheets/customize.css">
    
      <link rel="stylesheet" href="../../../stylesheets/bannerSlider.css">
    
      <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.css">
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1.1.0/style.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      



<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
    <nav class="md-header__inner md-grid" aria-label="页眉">
        <a href="../../.." title="Solo&#39;s Blog"
           class="md-header__button md-logo" aria-label="Solo's Blog" data-md-component="logo">
            
  <img src="../../../assets/images/logo.png" alt="logo">

        </a>
        <label class="md-header__button md-icon" for="__drawer">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
        </label>
        <div class="md-header__title" data-md-component="header-title">
            <div class="md-header__ellipsis">
                <div class="md-header__topic">
          <span class="md-ellipsis">
            Solo's Blog
          </span>
                </div>
                <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Broadcast概述
            
          </span>
                </div>
            </div>
        </div>
        
        



<div class="md-copyright">
    
    <font color=#608DBD size=3>
        <span id="jinrishici-sentence">正在加载今日诗词....</span>
        <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
    </font>
    

    
</div>
        
        
        
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="purple"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
        
        
        
        <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
        
        
        
        <label class="md-header__button md-icon" for="__search">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="分享" aria-label="分享" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
        
        <div class="md-header__source">
            <a href="https://github.com/i-rtfsc/note" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    i-rtfsc/note
  </div>
</a>
        </div>
        
    </nav>
    
    
    
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
    
  
  首页

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../brightness/automatic-brightness-intro/" class="md-tabs__link">
          
  
    
  
  Android

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../base/51-android-rules/" class="md-tabs__link">
          
  
    
  
  基础技术

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../development-board/raspberry-pi/intro/" class="md-tabs__link">
          
  
    
  
  开发板

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../source-code/personal-source-code-intro/" class="md-tabs__link">
          
  
    
  
  源码工程

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
    
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Solo&#39;s Blog" class="md-nav__button md-logo" aria-label="Solo's Blog" data-md-component="logo">
      
  <img src="../../../assets/images/logo.png" alt="logo">

    </a>
    Solo's Blog
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/i-rtfsc/note" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    i-rtfsc/note
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    首页
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Android
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Android
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../brightness/automatic-brightness-intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android自动背光机制
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tombstones/tombstones-intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NativeTombstoneManager
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bootanimation/bootanimation-intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    bootanimation程序简介
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" >
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    AMS
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            AMS
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ams/launch-modes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Activity四大启动模式
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ams/client_transaction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Activity框架01-客户端事务管理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ams/activity_client_record/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Activity框架02-ActivityClientRecord
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ams/activity_thread/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Activity框架03-ActivityThread
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ams/activity_context/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Activity框架04-Activity和Context的关系
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ams/lifecycle/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Activity生命周期
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ams/android11-activity-start/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android11 Activity启动流程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ams/wm-layout-params/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    WindowManager.LayoutParams
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ams/frida-dump-activity-lifecycle/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    frida dump activity生命周期
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5" checked>
        
          
          <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Broadcast
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_5">
            <span class="md-nav__icon md-icon"></span>
            Broadcast
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Broadcast概述
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Broadcast概述
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      简介
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#broadcast" class="md-nav__link">
    <span class="md-ellipsis">
      Broadcast分类
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Broadcast分类">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      注册方式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      发送方式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      处理类型
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      接收者
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      主要源码
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      数据结构
    </span>
  </a>
  
    <nav class="md-nav" aria-label="数据结构">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#broadcastrecord" class="md-nav__link">
    <span class="md-ellipsis">
      BroadcastRecord
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      广播列表
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      静态广播
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      动态广播
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      广播队列
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      使用
    </span>
  </a>
  
    <nav class="md-nav" aria-label="使用">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      注册
    </span>
  </a>
  
    <nav class="md-nav" aria-label="注册">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      静态
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      动态
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      发送
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#faq" class="md-nav__link">
    <span class="md-ellipsis">
      FAQ
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      静态广播注册流程
    </span>
  </a>
  
    <nav class="md-nav" aria-label="静态广播注册流程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      总结
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      动态广播注册流程
    </span>
  </a>
  
    <nav class="md-nav" aria-label="动态广播注册流程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#contextimpl" class="md-nav__link">
    <span class="md-ellipsis">
      ContextImpl
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#contextimplregisterreceiver" class="md-nav__link">
    <span class="md-ellipsis">
      ContextImpl.registerReceiver
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#contextimplregisterreceiverinternal" class="md-nav__link">
    <span class="md-ellipsis">
      ContextImpl.registerReceiverInternal
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loadedapkgetreceiverdispatcher" class="md-nav__link">
    <span class="md-ellipsis">
      LoadedApk.getReceiverDispatcher()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#amsregisterreceiverwithfeature" class="md-nav__link">
    <span class="md-ellipsis">
      AMS.registerReceiverWithFeature
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AMS.registerReceiverWithFeature">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      入参
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    <span class="md-ellipsis">
      判断权限
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    <span class="md-ellipsis">
      初始化
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#action" class="md-nav__link">
    <span class="md-ellipsis">
      获取action
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#receiver" class="md-nav__link">
    <span class="md-ellipsis">
      receiver为空
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#receiver_1" class="md-nav__link">
    <span class="md-ellipsis">
      保存receiver
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    <span class="md-ellipsis">
      粘性广播
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    <span class="md-ellipsis">
      总结
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    <span class="md-ellipsis">
      思考
    </span>
  </a>
  
    <nav class="md-nav" aria-label="思考">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#activitymanagerservicehandledestroyactivity" class="md-nav__link">
    <span class="md-ellipsis">
      ActivityManagerService.handleDestroyActivity
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#contextimplschedulefinalcleanup" class="md-nav__link">
    <span class="md-ellipsis">
      ContextImpl.scheduleFinalCleanup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#activitythreadschedulecontextcleanup" class="md-nav__link">
    <span class="md-ellipsis">
      ActivityThread.scheduleContextCleanup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#contextimplperformfinalcleanup" class="md-nav__link">
    <span class="md-ellipsis">
      ContextImpl.performFinalCleanup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loadedapkremovecontextregistrations" class="md-nav__link">
    <span class="md-ellipsis">
      LoadedApk.removeContextRegistrations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#activitymanagerserviceunregisterreceiver" class="md-nav__link">
    <span class="md-ellipsis">
      ActivityManagerService.unregisterReceiver
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    <span class="md-ellipsis">
      发送广播流程
    </span>
  </a>
  
    <nav class="md-nav" aria-label="发送广播流程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#contextimplsendbroadcast" class="md-nav__link">
    <span class="md-ellipsis">
      ContextImpl.sendBroadcast
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#amsbroadcastintentwithfeature" class="md-nav__link">
    <span class="md-ellipsis">
      AMS.broadcastIntentWithFeature
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#amsbroadcastintentlocked" class="md-nav__link">
    <span class="md-ellipsis">
      AMS.broadcastIntentLocked
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AMS.broadcastIntentLocked">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#instant-app" class="md-nav__link">
    <span class="md-ellipsis">
      instant app
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stop" class="md-nav__link">
    <span class="md-ellipsis">
      不发送给stop应用
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    <span class="md-ellipsis">
      开机未完成
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#user" class="md-nav__link">
    <span class="md-ellipsis">
      user校验
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    <span class="md-ellipsis">
      检查权限
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    <span class="md-ellipsis">
      保护广播
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    <span class="md-ellipsis">
      广播能否发给background进程
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    <span class="md-ellipsis">
      处理粘性广播
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    <span class="md-ellipsis">
      筛选出静态广播接受者
    </span>
  </a>
  
    <nav class="md-nav" aria-label="筛选出静态广播接受者">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#collectreceivercomponents" class="md-nav__link">
    <span class="md-ellipsis">
      collectReceiverComponents()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#packagemanagerservicequeryintentreceivers" class="md-nav__link">
    <span class="md-ellipsis">
      PackageManagerService.queryIntentReceivers
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_32" class="md-nav__link">
    <span class="md-ellipsis">
      筛选出动态广播接收者
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_33" class="md-nav__link">
    <span class="md-ellipsis">
      无序广播
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_34" class="md-nav__link">
    <span class="md-ellipsis">
      有序广播
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_35" class="md-nav__link">
    <span class="md-ellipsis">
      总结
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ams" class="md-nav__link">
    <span class="md-ellipsis">
      AMS创建广播队列
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_36" class="md-nav__link">
    <span class="md-ellipsis">
      广播接收者入队列
    </span>
  </a>
  
    <nav class="md-nav" aria-label="广播接收者入队列">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enqueueparallelbroadcastlocked" class="md-nav__link">
    <span class="md-ellipsis">
      enqueueParallelBroadcastLocked
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enqueueorderedbroadcastlocked" class="md-nav__link">
    <span class="md-ellipsis">
      enqueueOrderedBroadcastLocked
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_37" class="md-nav__link">
    <span class="md-ellipsis">
      广播队列分发
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_38" class="md-nav__link">
    <span class="md-ellipsis">
      处理分发下一个广播
    </span>
  </a>
  
    <nav class="md-nav" aria-label="处理分发下一个广播">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_39" class="md-nav__link">
    <span class="md-ellipsis">
      无序广播
    </span>
  </a>
  
    <nav class="md-nav" aria-label="无序广播">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delivertoregisteredreceiverlocked" class="md-nav__link">
    <span class="md-ellipsis">
      deliverToRegisteredReceiverLocked
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performreceivelocked" class="md-nav__link">
    <span class="md-ellipsis">
      performReceiveLocked
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#activitythreadscheduleregisteredreceiver" class="md-nav__link">
    <span class="md-ellipsis">
      ActivityThread.scheduleRegisteredReceiver
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#innerreceiverperformreceive" class="md-nav__link">
    <span class="md-ellipsis">
      InnerReceiver.performReceive
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#receiverdispatcherperformreceive" class="md-nav__link">
    <span class="md-ellipsis">
      ReceiverDispatcher.performReceive
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#argsrun" class="md-nav__link">
    <span class="md-ellipsis">
      Args.run
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#amsfinishreceiver" class="md-nav__link">
    <span class="md-ellipsis">
      AMS.finishReceiver()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_40" class="md-nav__link">
    <span class="md-ellipsis">
      有序广播
    </span>
  </a>
  
    <nav class="md-nav" aria-label="有序广播">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pending-broadcast" class="md-nav__link">
    <span class="md-ellipsis">
      处理Pending Broadcast
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_41" class="md-nav__link">
    <span class="md-ellipsis">
      取出下一个广播
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_42" class="md-nav__link">
    <span class="md-ellipsis">
      处理下一个接收者
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_43" class="md-nav__link">
    <span class="md-ellipsis">
      发送广播
    </span>
  </a>
  
    <nav class="md-nav" aria-label="发送广播">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_44" class="md-nav__link">
    <span class="md-ellipsis">
      动态注册有序广播接收者
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_45" class="md-nav__link">
    <span class="md-ellipsis">
      进程已经启动的静态有序广播接收者
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#processcurbroadcastlocked" class="md-nav__link">
    <span class="md-ellipsis">
      # processCurBroadcastLocked
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#activitythreadschedulereceiver" class="md-nav__link">
    <span class="md-ellipsis">
      # ActivityThread.scheduleReceiver
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#activitythreadhandlereceiver" class="md-nav__link">
    <span class="md-ellipsis">
      # ActivityThread.handleReceiver
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_46" class="md-nav__link">
    <span class="md-ellipsis">
      进程还未启动的静态有序广播接收者
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_47" class="md-nav__link">
    <span class="md-ellipsis">
      # 进程创建流程
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#amssendpendingbroadcastslocked" class="md-nav__link">
    <span class="md-ellipsis">
      # AMS.sendPendingBroadcastsLocked
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#broadcastqueuesendpendingbroadcastslocked" class="md-nav__link">
    <span class="md-ellipsis">
      BroadcastQueue.sendPendingBroadcastsLocked
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_48" class="md-nav__link">
    <span class="md-ellipsis">
      扩展
    </span>
  </a>
  
    <nav class="md-nav" aria-label="扩展">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_49" class="md-nav__link">
    <span class="md-ellipsis">
      命令
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flag" class="md-nav__link">
    <span class="md-ellipsis">
      flag
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reference" class="md-nav__link">
    <span class="md-ellipsis">
      Reference
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6" >
        
          
          <label class="md-nav__link" for="__nav_2_6" id="__nav_2_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    SELinux
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6">
            <span class="md-nav__icon md-icon"></span>
            SELinux
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../selinux/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android SELinux介绍
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../selinux/genfscon/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    genfscon
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7" >
        
          
          <label class="md-nav__link" for="__nav_2_7" id="__nav_2_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Binder
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_7">
            <span class="md-nav__icon md-icon"></span>
            Binder
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../binder/android12-native-binder-change/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 12 Native Binder 代码变迁
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../binder/ashmem/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ashmem简介（Android IPC传输大数据）
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../binder/driver/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Binder机制01-驱动
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../binder/service-manager/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Binder机制02-ServiceManager
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../binder/framework-native/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Binder机制03-Framework-Native
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../binder/framework-java/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Binder机制04-Framework-Java
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../binder/aidl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Binder机制05-AIDL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../binder/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Binder概述
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../binder/am-trace-ipc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    am trace-ipc 分析
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_8" >
        
          
          <label class="md-nav__link" for="__nav_2_8" id="__nav_2_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Car
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_8">
            <span class="md-nav__icon md-icon"></span>
            Car
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_8_1" >
        
          
          <label class="md-nav__link" for="__nav_2_8_1" id="__nav_2_8_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    CarService
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_8_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_8_1">
            <span class="md-nav__icon md-icon"></span>
            CarService
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../car/carservice/start-service/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 15 CarService源码01-服务启动
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../car/carservice/init-service/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 15 CarService源码02-服务初始化
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../car/carservice/all-service/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 15 CarService源码03-服务及接口
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../car/carservice/carservice-call-vhal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 15 CarService源码04-CarService与Vehicle HAL交互
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../car/carservice/system-interface/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 15 CarService源码05-SystemInterface
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../car/carservice/car-input-service/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 15 CarService源码06-CarInputService
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../car/carservice/car-wifi-service/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 15 CarService源码07-CarWifiService
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_8_2" >
        
          
          <label class="md-nav__link" for="__nav_2_8_2" id="__nav_2_8_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Vehicle
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_8_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_8_2">
            <span class="md-nav__icon md-icon"></span>
            Vehicle
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../car/vehicle/android-s-hal-intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android-S Vehicle HAL架构
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../car/vehicle/android-u-hal-intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android-U Vehicle HAL架构
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_9" >
        
          
          <label class="md-nav__link" for="__nav_2_9" id="__nav_2_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Input
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_9">
            <span class="md-nav__icon md-icon"></span>
            Input
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../input/focused-window/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android 窗口焦点介绍
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../input/inotify-epoll/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    INotify与Epoll机制
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../input/inputDispatcher-inputChannel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    InputDispatcher与InputChannel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../input/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Input概述
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../input/start/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Input系统01-Input启动过程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../input/input-reader/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Input系统02-InputReader线程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../input/scancode-keycode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Scancode到Keycode的映射
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../input/add-new-key/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    新增物理按键处理流程
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_10" >
        
          
          <label class="md-nav__link" for="__nav_2_10" id="__nav_2_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    基础与工具
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_10">
            <span class="md-nav__icon md-icon"></span>
            基础与工具
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../base-tools/adb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ADB
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../base-tools/api-levels/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android API Levels
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../base-tools/as-shortcut-keys/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android Studio 快捷键
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../base-tools/as-compdb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Compdb
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../base-tools/c-ifdef/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    c代码中 ifdef 多条件判断
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../base-tools/repo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    repo常用操作
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../base-tools/ccache/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    使用ccache加快编译速度
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../base-tools/winscope/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    编译winscope
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_11" >
        
          
          <label class="md-nav__link" for="__nav_2_11" id="__nav_2_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    巧夺天工
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_11">
            <span class="md-nav__icon md-icon"></span>
            巧夺天工
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../divine-skill/android-bp-if-else/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android.bp 添加宏控
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../divine-skill/service-extra-func-without-aidl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    aosp原生Service快捷扩展接口
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../divine-skill/mem-pressure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    内存加压
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../divine-skill/log-to-line-chart/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    通过log中的坐标转成折线图
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_12" >
        
          
          <label class="md-nav__link" for="__nav_2_12" id="__nav_2_12_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    调试技巧
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_12">
            <span class="md-nav__icon md-icon"></span>
            调试技巧
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../debug-skill/tomestone-stack/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android Native crash tomestone trace tools
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../debug-skill/call-stack/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android打印函数调用流程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../debug-skill/am-set-debug-app/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    am set-debug-app 介绍
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../debug-skill/privapp-permissions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    privapp permissions检查
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../debug-skill/event-log/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    借助 event log 有效排查问题
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../debug-skill/merge-sort-log/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    按时间顺序合并log
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../debug-skill/jdwp-enabled/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    无法打断点调试
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_12_8" >
        
          
          <label class="md-nav__link" for="__nav_2_12_8" id="__nav_2_12_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    调频命令
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_12_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_12_8">
            <span class="md-nav__icon md-icon"></span>
            调频命令
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../debug-skill/frequency/cpu/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CPU提频命令
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../debug-skill/frequency/gpu/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GPU提频命令
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_13" >
        
          
          <label class="md-nav__link" for="__nav_2_13" id="__nav_2_13_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    问题及方案
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_13">
            <span class="md-nav__icon md-icon"></span>
            问题及方案
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../issue-solution/set-affinity/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android进程绑核方案
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../issue_solution/car-service-updatable-call-hide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CarServiceUpdatable引用hide接口
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    基础技术
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            基础技术
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base/51-android-rules/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    51-android.rules
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base/jar-delete/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Jar包删除部分内容
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base/jetbrains_directories/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    JetBrains配置目录
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base/git_branch_commit_single/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    git小技巧-commit single
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base/hexo-next/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    hexo、next主题美化
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base/linux-service/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    linux service
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base/mkdocs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mkdocs博客搭建
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base/sshfs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    sshfs命令
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base/tmux/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    tmux
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../base/tar/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    tar命令
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    开发板
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            开发板
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    树莓派
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            树莓派
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../development-board/raspberry-pi/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    树莓派基础配置
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    源码工程
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            源码工程
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../source-code/personal-source-code-intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    个人源码工程简介
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    ExtFrameworks
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            ExtFrameworks
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../source-code/aosp-ext/fwk-ext/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    aosp frameworks扩展方案
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Android feature
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            Android feature
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../source-code/android-feature/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android Device Feature
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4" >
        
          
          <label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    As aosp
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4">
            <span class="md-nav__icon md-icon"></span>
            As aosp
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../source-code/as-aosp/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    as-aosp工程简介
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../source-code/as-aosp/first-configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    教程001-首次配置
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../source-code/as-aosp/design/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    教程002-设计思路
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../source-code/as-aosp/simple-extra/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    教程003-简单扩展
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../source-code/as-aosp/plugin-extra/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    教程004-插件扩展
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../source-code/as-aosp/jump-system-code/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    教程005-跳转系统源码[6.x版本默认跳转]
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../source-code/as-aosp/jump-aidl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    教程006-aidl跳转
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../source-code/as-aosp/jump-cpp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    教程007-c++跳转
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../source-code/as-aosp/jump-system-code-2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    教程008-跳转系统源码[进阶版]
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_5" >
        
          
          <label class="md-nav__link" for="__nav_5_5" id="__nav_5_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Global scripts
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_5">
            <span class="md-nav__icon md-icon"></span>
            Global scripts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../source-code/global-scripts/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    global_scripts工程简介
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      简介
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#broadcast" class="md-nav__link">
    <span class="md-ellipsis">
      Broadcast分类
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Broadcast分类">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      注册方式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      发送方式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      处理类型
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      接收者
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      主要源码
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      数据结构
    </span>
  </a>
  
    <nav class="md-nav" aria-label="数据结构">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#broadcastrecord" class="md-nav__link">
    <span class="md-ellipsis">
      BroadcastRecord
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      广播列表
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      静态广播
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      动态广播
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      广播队列
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      使用
    </span>
  </a>
  
    <nav class="md-nav" aria-label="使用">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      注册
    </span>
  </a>
  
    <nav class="md-nav" aria-label="注册">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      静态
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      动态
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      发送
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#faq" class="md-nav__link">
    <span class="md-ellipsis">
      FAQ
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      静态广播注册流程
    </span>
  </a>
  
    <nav class="md-nav" aria-label="静态广播注册流程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      总结
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      动态广播注册流程
    </span>
  </a>
  
    <nav class="md-nav" aria-label="动态广播注册流程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#contextimpl" class="md-nav__link">
    <span class="md-ellipsis">
      ContextImpl
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#contextimplregisterreceiver" class="md-nav__link">
    <span class="md-ellipsis">
      ContextImpl.registerReceiver
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#contextimplregisterreceiverinternal" class="md-nav__link">
    <span class="md-ellipsis">
      ContextImpl.registerReceiverInternal
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loadedapkgetreceiverdispatcher" class="md-nav__link">
    <span class="md-ellipsis">
      LoadedApk.getReceiverDispatcher()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#amsregisterreceiverwithfeature" class="md-nav__link">
    <span class="md-ellipsis">
      AMS.registerReceiverWithFeature
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AMS.registerReceiverWithFeature">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      入参
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    <span class="md-ellipsis">
      判断权限
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    <span class="md-ellipsis">
      初始化
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#action" class="md-nav__link">
    <span class="md-ellipsis">
      获取action
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#receiver" class="md-nav__link">
    <span class="md-ellipsis">
      receiver为空
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#receiver_1" class="md-nav__link">
    <span class="md-ellipsis">
      保存receiver
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    <span class="md-ellipsis">
      粘性广播
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    <span class="md-ellipsis">
      总结
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    <span class="md-ellipsis">
      思考
    </span>
  </a>
  
    <nav class="md-nav" aria-label="思考">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#activitymanagerservicehandledestroyactivity" class="md-nav__link">
    <span class="md-ellipsis">
      ActivityManagerService.handleDestroyActivity
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#contextimplschedulefinalcleanup" class="md-nav__link">
    <span class="md-ellipsis">
      ContextImpl.scheduleFinalCleanup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#activitythreadschedulecontextcleanup" class="md-nav__link">
    <span class="md-ellipsis">
      ActivityThread.scheduleContextCleanup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#contextimplperformfinalcleanup" class="md-nav__link">
    <span class="md-ellipsis">
      ContextImpl.performFinalCleanup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loadedapkremovecontextregistrations" class="md-nav__link">
    <span class="md-ellipsis">
      LoadedApk.removeContextRegistrations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#activitymanagerserviceunregisterreceiver" class="md-nav__link">
    <span class="md-ellipsis">
      ActivityManagerService.unregisterReceiver
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    <span class="md-ellipsis">
      发送广播流程
    </span>
  </a>
  
    <nav class="md-nav" aria-label="发送广播流程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#contextimplsendbroadcast" class="md-nav__link">
    <span class="md-ellipsis">
      ContextImpl.sendBroadcast
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#amsbroadcastintentwithfeature" class="md-nav__link">
    <span class="md-ellipsis">
      AMS.broadcastIntentWithFeature
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#amsbroadcastintentlocked" class="md-nav__link">
    <span class="md-ellipsis">
      AMS.broadcastIntentLocked
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AMS.broadcastIntentLocked">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#instant-app" class="md-nav__link">
    <span class="md-ellipsis">
      instant app
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stop" class="md-nav__link">
    <span class="md-ellipsis">
      不发送给stop应用
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    <span class="md-ellipsis">
      开机未完成
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#user" class="md-nav__link">
    <span class="md-ellipsis">
      user校验
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    <span class="md-ellipsis">
      检查权限
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    <span class="md-ellipsis">
      保护广播
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    <span class="md-ellipsis">
      广播能否发给background进程
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    <span class="md-ellipsis">
      处理粘性广播
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    <span class="md-ellipsis">
      筛选出静态广播接受者
    </span>
  </a>
  
    <nav class="md-nav" aria-label="筛选出静态广播接受者">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#collectreceivercomponents" class="md-nav__link">
    <span class="md-ellipsis">
      collectReceiverComponents()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#packagemanagerservicequeryintentreceivers" class="md-nav__link">
    <span class="md-ellipsis">
      PackageManagerService.queryIntentReceivers
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_32" class="md-nav__link">
    <span class="md-ellipsis">
      筛选出动态广播接收者
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_33" class="md-nav__link">
    <span class="md-ellipsis">
      无序广播
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_34" class="md-nav__link">
    <span class="md-ellipsis">
      有序广播
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_35" class="md-nav__link">
    <span class="md-ellipsis">
      总结
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ams" class="md-nav__link">
    <span class="md-ellipsis">
      AMS创建广播队列
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_36" class="md-nav__link">
    <span class="md-ellipsis">
      广播接收者入队列
    </span>
  </a>
  
    <nav class="md-nav" aria-label="广播接收者入队列">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enqueueparallelbroadcastlocked" class="md-nav__link">
    <span class="md-ellipsis">
      enqueueParallelBroadcastLocked
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enqueueorderedbroadcastlocked" class="md-nav__link">
    <span class="md-ellipsis">
      enqueueOrderedBroadcastLocked
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_37" class="md-nav__link">
    <span class="md-ellipsis">
      广播队列分发
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_38" class="md-nav__link">
    <span class="md-ellipsis">
      处理分发下一个广播
    </span>
  </a>
  
    <nav class="md-nav" aria-label="处理分发下一个广播">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_39" class="md-nav__link">
    <span class="md-ellipsis">
      无序广播
    </span>
  </a>
  
    <nav class="md-nav" aria-label="无序广播">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#delivertoregisteredreceiverlocked" class="md-nav__link">
    <span class="md-ellipsis">
      deliverToRegisteredReceiverLocked
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performreceivelocked" class="md-nav__link">
    <span class="md-ellipsis">
      performReceiveLocked
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#activitythreadscheduleregisteredreceiver" class="md-nav__link">
    <span class="md-ellipsis">
      ActivityThread.scheduleRegisteredReceiver
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#innerreceiverperformreceive" class="md-nav__link">
    <span class="md-ellipsis">
      InnerReceiver.performReceive
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#receiverdispatcherperformreceive" class="md-nav__link">
    <span class="md-ellipsis">
      ReceiverDispatcher.performReceive
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#argsrun" class="md-nav__link">
    <span class="md-ellipsis">
      Args.run
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#amsfinishreceiver" class="md-nav__link">
    <span class="md-ellipsis">
      AMS.finishReceiver()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_40" class="md-nav__link">
    <span class="md-ellipsis">
      有序广播
    </span>
  </a>
  
    <nav class="md-nav" aria-label="有序广播">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pending-broadcast" class="md-nav__link">
    <span class="md-ellipsis">
      处理Pending Broadcast
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_41" class="md-nav__link">
    <span class="md-ellipsis">
      取出下一个广播
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_42" class="md-nav__link">
    <span class="md-ellipsis">
      处理下一个接收者
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_43" class="md-nav__link">
    <span class="md-ellipsis">
      发送广播
    </span>
  </a>
  
    <nav class="md-nav" aria-label="发送广播">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_44" class="md-nav__link">
    <span class="md-ellipsis">
      动态注册有序广播接收者
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_45" class="md-nav__link">
    <span class="md-ellipsis">
      进程已经启动的静态有序广播接收者
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#processcurbroadcastlocked" class="md-nav__link">
    <span class="md-ellipsis">
      # processCurBroadcastLocked
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#activitythreadschedulereceiver" class="md-nav__link">
    <span class="md-ellipsis">
      # ActivityThread.scheduleReceiver
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#activitythreadhandlereceiver" class="md-nav__link">
    <span class="md-ellipsis">
      # ActivityThread.handleReceiver
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_46" class="md-nav__link">
    <span class="md-ellipsis">
      进程还未启动的静态有序广播接收者
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_47" class="md-nav__link">
    <span class="md-ellipsis">
      # 进程创建流程
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#amssendpendingbroadcastslocked" class="md-nav__link">
    <span class="md-ellipsis">
      # AMS.sendPendingBroadcastsLocked
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#broadcastqueuesendpendingbroadcastslocked" class="md-nav__link">
    <span class="md-ellipsis">
      BroadcastQueue.sendPendingBroadcastsLocked
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_48" class="md-nav__link">
    <span class="md-ellipsis">
      扩展
    </span>
  </a>
  
    <nav class="md-nav" aria-label="扩展">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_49" class="md-nav__link">
    <span class="md-ellipsis">
      命令
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flag" class="md-nav__link">
    <span class="md-ellipsis">
      flag
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reference" class="md-nav__link">
    <span class="md-ellipsis">
      Reference
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

<nav class="md-tags" >
  
    
    
      
      
    
    
      <span class="md-tag md-tag-icon">Android</span>
    
  
    
    
      
      
    
    
      <span class="md-tag md-tag-icon">Broadcast</span>
    
  
</nav>


  
    <a href="https://github.com/i-rtfsc/note/edit/main/docs/Android/Broadcast/Broadcast概述.md" title="编辑此页" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  


<h1>Broadcast概述</h1>

<h2 id="_1">简介<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>Broadcast(广播)是Android四大组件之一，在四大组件的另外两个组件Activity和Service拥有发送和接收广播的能力。Android是在Binder进程间通信机制的基础上实现的，内部基于消息发布和订阅的事件驱动模型，广播发送者负责发送消息，广播接收者需要先订阅消息，然后才能收到消息。Binder进程间通信与Broadcast的区别在于：</p>
<ul>
<li>Binder</li>
</ul>
<p>客户端需要先知道服务端的存在，并获取到它的一个代理对象；</p>
<ul>
<li>Broadcast</li>
</ul>
<p>广播发送者实现不需要知道广播接收者的存在，这样可以降低发送者和接收者的耦合度。提高系统的可扩展性和可维护性。</p>
<h2 id="broadcast">Broadcast分类<a class="headerlink" href="#broadcast" title="Permanent link">&para;</a></h2>
<h3 id="_2">注册方式<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<ul>
<li>静态注册</li>
</ul>
<p>android manifest文件注册，常驻广播。</p>
<ul>
<li>动态注册</li>
</ul>
<p>在代码中手动调用Context.registerReceiver讲BroadcastReceiver注册到AMS中，所以要求程序必须在运行时才能进行，有一定的局限性。</p>
<h3 id="_3">发送方式<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>静态注册的广播，一律按照串行广播处理，因为可能会设计到拉起多个进程等，串行广播才有超时处理。</p>
<ul>
<li>有序广播</li>
</ul>
<p>发送的广播被接收者有序的接收，根据接收对象的优先级（Priority属性的值决定，值越大，优先级越高；Priority属性相同时，动态注册的广播优先于静态注册的广播）来决定接受顺序。有序广播可以对广播进行拦截，这样之后的接收者就接受不到广播了，也可以对广播内容进行修改。</p>
<ul>
<li>无序广播</li>
</ul>
<p>默认无序；并行分发；不可以被拦截、终止、修改；无优先级问题；传递数据用intent.putExtra。</p>
<h3 id="_4">处理类型<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>AMS中前台广播和后台广播分别有一个广播队列，互不干扰。</p>
<ul>
<li>前台广播</li>
</ul>
<p>发送时添加Intent.FLAG_RECEIVER_FOREGROUND，超时时间10s</p>
<ul>
<li>后台广播</li>
</ul>
<p>默认后台，超时时间60s</p>
<h3 id="_5">接收者<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<ul>
<li>显示广播</li>
</ul>
<p>指定接收方的class类型</p>
<ul>
<li>隐式广播</li>
</ul>
<p>只指定action，uri等, android 8.0开始限制了隐式广播的接收</p>
<h2 id="_6">主要源码<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>frameworks/base/services/core/java/com/android/server/am/
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>├──<span class="w"> </span>ActivityManagerService.java
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>├──<span class="w"> </span>BroadcastConstants.java
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>├──<span class="w"> </span>BroadcastDispatcher.java
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>├──<span class="w"> </span>BroadcastFilter.java
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>├──<span class="w"> </span>BroadcastQueue.java
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>├──<span class="w"> </span>BroadcastRecord.java
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>├──<span class="w"> </span>BroadcastStats.java
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>├──<span class="w"> </span>ProcessRecord.java
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>└──<span class="w"> </span>ReceiverList.java
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>frameworks/base/core/java/android/content/
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>├──<span class="w"> </span>BroadcastReceiver.java
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>└──<span class="w"> </span>IntentFilter.java
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>frameworks/base/services/core/java/com/android/server/pm
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>├──<span class="w"> </span>PackageManagerService.java
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>├──<span class="w"> </span>parsing
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>│<span class="w">   </span>└──<span class="w"> </span>PackageParser2.java
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>└──<span class="w"> </span>pkg
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="w">    </span>└──<span class="w"> </span>parsing
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="w">        </span>├──<span class="w"> </span>ParsingPackageImpl.java
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="w">        </span>└──<span class="w"> </span>ParsingPackageUtils.java
</span></code></pre></div>
<h2 id="_7">数据结构<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<p><img alt="" src="../../../Android/Broadcast/res/Broadcast_01.png" /></p>
<h3 id="broadcastrecord">BroadcastRecord<a class="headerlink" href="#broadcastrecord" title="Permanent link">&para;</a></h3>
<div class="language-java highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">BroadcastRecord</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Binder</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="p">;</span><span class="w">    </span><span class="c1">// the original intent that generated us</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">ComponentName</span><span class="w"> </span><span class="n">targetComp</span><span class="p">;</span><span class="w"> </span><span class="c1">// original component name set on the intent</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">    </span><span class="c1">//广播发送者的进程</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">ProcessRecord</span><span class="w"> </span><span class="n">callerApp</span><span class="p">;</span><span class="w"> </span><span class="c1">// process that sent this</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">    </span><span class="c1">//广播发送者的包名</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">;</span><span class="w"> </span><span class="c1">// who sent this</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="nd">@Nullable</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">callerFeatureId</span><span class="p">;</span><span class="w"> </span><span class="c1">// which feature in the package sent this</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="w">    </span><span class="c1">//广播发送者的pid</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">callingPid</span><span class="p">;</span><span class="w">   </span><span class="c1">// the pid of who sent this</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="w">    </span><span class="c1">//广播发送者的uid</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">callingUid</span><span class="p">;</span><span class="w">   </span><span class="c1">// the uid of who sent this</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="w">    </span><span class="c1">//广播发送者是否是Instant App</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">callerInstantApp</span><span class="p">;</span><span class="w"> </span><span class="c1">// caller is an Instant App?</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="w">    </span><span class="c1">//是否有序广播</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">ordered</span><span class="p">;</span><span class="w">  </span><span class="c1">// serialize the send to receivers?</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="w">    </span><span class="c1">//是否粘性广播</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">sticky</span><span class="p">;</span><span class="w">   </span><span class="c1">// originated from existing sticky data?</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">initialSticky</span><span class="p">;</span><span class="w"> </span><span class="c1">// initial broadcast from register to sticky?</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">userId</span><span class="p">;</span><span class="w">       </span><span class="c1">// user id this broadcast was for</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">resolvedType</span><span class="p">;</span><span class="w"> </span><span class="c1">// the resolved data type</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a><span class="w">    </span><span class="c1">//广播发送者的要求的权限</span>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">requiredPermissions</span><span class="p">;</span><span class="w"> </span><span class="c1">// permissions the caller has required</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">excludedPermissions</span><span class="p">;</span><span class="w"> </span><span class="c1">// permissions to exclude</span>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">excludedPackages</span><span class="p">;</span><span class="w"> </span><span class="c1">// packages to exclude</span>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">appOp</span><span class="p">;</span><span class="w">        </span><span class="c1">// an app op that is associated with this broadcast</span>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">BroadcastOptions</span><span class="w"> </span><span class="n">options</span><span class="p">;</span><span class="w"> </span><span class="c1">// BroadcastOptions supplied by caller</span>
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a><span class="w">    </span><span class="c1">//广播接收器，包括动态注册(BroadcastFilter)和静态注册(ResolveInfo)；</span>
</span><span id="__span-1-29"><a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">List</span><span class="w"> </span><span class="n">receivers</span><span class="p">;</span><span class="w">   </span><span class="c1">// contains BroadcastFilter and ResolveInfo</span>
</span><span id="__span-1-30"><a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">delivery</span><span class="p">;</span><span class="w">   </span><span class="c1">// delivery state of each receiver</span>
</span><span id="__span-1-31"><a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="o">[]</span><span class="w"> </span><span class="n">duration</span><span class="p">;</span><span class="w">   </span><span class="c1">// duration a receiver took to process broadcast</span>
</span><span id="__span-1-32"><a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a><span class="w">    </span><span class="n">IIntentReceiver</span><span class="w"> </span><span class="n">resultTo</span><span class="p">;</span><span class="w"> </span><span class="c1">// who receives final result if non-null</span>
</span><span id="__span-1-33"><a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">deferred</span><span class="p">;</span>
</span><span id="__span-1-34"><a id="__codelineno-1-34" name="__codelineno-1-34" href="#__codelineno-1-34"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">splitCount</span><span class="p">;</span><span class="w">         </span><span class="c1">// refcount for result callback, when split</span>
</span><span id="__span-1-35"><a id="__codelineno-1-35" name="__codelineno-1-35" href="#__codelineno-1-35"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">splitToken</span><span class="p">;</span><span class="w">         </span><span class="c1">// identifier for cross-BroadcastRecord refcount</span>
</span><span id="__span-1-36"><a id="__codelineno-1-36" name="__codelineno-1-36" href="#__codelineno-1-36"></a><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">enqueueTime</span><span class="p">;</span><span class="w">       </span><span class="c1">// uptimeMillis when the broadcast was enqueued</span>
</span><span id="__span-1-37"><a id="__codelineno-1-37" name="__codelineno-1-37" href="#__codelineno-1-37"></a><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">enqueueRealTime</span><span class="p">;</span><span class="w">   </span><span class="c1">// elapsedRealtime when the broadcast was enqueued</span>
</span><span id="__span-1-38"><a id="__codelineno-1-38" name="__codelineno-1-38" href="#__codelineno-1-38"></a><span class="w">    </span><span class="c1">//广播入队列时间点</span>
</span><span id="__span-1-39"><a id="__codelineno-1-39" name="__codelineno-1-39" href="#__codelineno-1-39"></a><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">enqueueClockTime</span><span class="p">;</span><span class="w">  </span><span class="c1">// the clock time the broadcast was enqueued</span>
</span><span id="__span-1-40"><a id="__codelineno-1-40" name="__codelineno-1-40" href="#__codelineno-1-40"></a><span class="w">    </span><span class="c1">//广播分发时间点</span>
</span><span id="__span-1-41"><a id="__codelineno-1-41" name="__codelineno-1-41" href="#__codelineno-1-41"></a><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">dispatchTime</span><span class="p">;</span><span class="w">      </span><span class="c1">// when dispatch started on this set of receivers</span>
</span><span id="__span-1-42"><a id="__codelineno-1-42" name="__codelineno-1-42" href="#__codelineno-1-42"></a><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">dispatchRealTime</span><span class="p">;</span><span class="w">  </span><span class="c1">// elapsedRealtime when the broadcast was dispatched</span>
</span><span id="__span-1-43"><a id="__codelineno-1-43" name="__codelineno-1-43" href="#__codelineno-1-43"></a><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">dispatchClockTime</span><span class="p">;</span><span class="w"> </span><span class="c1">// the clock time the dispatch started</span>
</span><span id="__span-1-44"><a id="__codelineno-1-44" name="__codelineno-1-44" href="#__codelineno-1-44"></a><span class="w">    </span><span class="c1">//当前receiver开始处理时间点</span>
</span><span id="__span-1-45"><a id="__codelineno-1-45" name="__codelineno-1-45" href="#__codelineno-1-45"></a><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">receiverTime</span><span class="p">;</span><span class="w">      </span><span class="c1">// when current receiver started for timeouts.</span>
</span><span id="__span-1-46"><a id="__codelineno-1-46" name="__codelineno-1-46" href="#__codelineno-1-46"></a><span class="w">    </span><span class="c1">//广播处理完成时间点</span>
</span><span id="__span-1-47"><a id="__codelineno-1-47" name="__codelineno-1-47" href="#__codelineno-1-47"></a><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">finishTime</span><span class="p">;</span><span class="w">        </span><span class="c1">// when we finished the current receiver.</span>
</span><span id="__span-1-48"><a id="__codelineno-1-48" name="__codelineno-1-48" href="#__codelineno-1-48"></a><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">timeoutExempt</span><span class="p">;</span><span class="w">  </span><span class="c1">// true if this broadcast is not subject to receiver timeouts</span>
</span><span id="__span-1-49"><a id="__codelineno-1-49" name="__codelineno-1-49" href="#__codelineno-1-49"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">resultCode</span><span class="p">;</span><span class="w">         </span><span class="c1">// current result code value.</span>
</span><span id="__span-1-50"><a id="__codelineno-1-50" name="__codelineno-1-50" href="#__codelineno-1-50"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">resultData</span><span class="p">;</span><span class="w">      </span><span class="c1">// current result data value.</span>
</span><span id="__span-1-51"><a id="__codelineno-1-51" name="__codelineno-1-51" href="#__codelineno-1-51"></a><span class="w">    </span><span class="n">Bundle</span><span class="w"> </span><span class="n">resultExtras</span><span class="p">;</span><span class="w">    </span><span class="c1">// current result extra data values.</span>
</span><span id="__span-1-52"><a id="__codelineno-1-52" name="__codelineno-1-52" href="#__codelineno-1-52"></a><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">resultAbort</span><span class="p">;</span><span class="w">    </span><span class="c1">// current result abortBroadcast value.</span>
</span><span id="__span-1-53"><a id="__codelineno-1-53" name="__codelineno-1-53" href="#__codelineno-1-53"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nextReceiver</span><span class="p">;</span><span class="w">       </span><span class="c1">// next receiver to be executed.</span>
</span><span id="__span-1-54"><a id="__codelineno-1-54" name="__codelineno-1-54" href="#__codelineno-1-54"></a><span class="w">    </span><span class="c1">//数据类型为IBinder，保存的广播所在进程的ApplicationThread对象的代理端</span>
</span><span id="__span-1-55"><a id="__codelineno-1-55" name="__codelineno-1-55" href="#__codelineno-1-55"></a><span class="w">    </span><span class="n">IBinder</span><span class="w"> </span><span class="n">receiver</span><span class="p">;</span><span class="w">       </span><span class="c1">// who is currently running, null if none.</span>
</span><span id="__span-1-56"><a id="__codelineno-1-56" name="__codelineno-1-56" href="#__codelineno-1-56"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">state</span><span class="p">;</span>
</span><span id="__span-1-57"><a id="__codelineno-1-57" name="__codelineno-1-57" href="#__codelineno-1-57"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">anrCount</span><span class="p">;</span><span class="w">           </span><span class="c1">// has this broadcast record hit any ANRs?</span>
</span><span id="__span-1-58"><a id="__codelineno-1-58" name="__codelineno-1-58" href="#__codelineno-1-58"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">manifestCount</span><span class="p">;</span><span class="w">      </span><span class="c1">// number of manifest receivers dispatched.</span>
</span><span id="__span-1-59"><a id="__codelineno-1-59" name="__codelineno-1-59" href="#__codelineno-1-59"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">manifestSkipCount</span><span class="p">;</span><span class="w">  </span><span class="c1">// number of manifest receivers skipped.</span>
</span><span id="__span-1-60"><a id="__codelineno-1-60" name="__codelineno-1-60" href="#__codelineno-1-60"></a><span class="w">    </span><span class="n">BroadcastQueue</span><span class="w"> </span><span class="n">queue</span><span class="p">;</span><span class="w">   </span><span class="c1">// the outbound queue handling this broadcast</span>
</span><span id="__span-1-61"><a id="__codelineno-1-61" name="__codelineno-1-61" href="#__codelineno-1-61"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="_8">广播列表<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<div class="language-java highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">BroadcastQueue</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">    </span><span class="c1">//保存了将要发送的 无序广播</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">BroadcastRecord</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mParallelBroadcasts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">    </span><span class="c1">//有序 Dispatcher</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">BroadcastDispatcher</span><span class="w"> </span><span class="n">mDispatcher</span><span class="p">;</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="p">}</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">BroadcastDispatcher</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="w">    </span><span class="c1">//保存了将要发送的 有序广播</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">BroadcastRecord</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mOrderedBroadcasts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="_9">静态广播<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<div class="language-java highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PackageManagerService</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">PackageSender</span><span class="p">,</span><span class="w"> </span><span class="n">TestUtilityService</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">    </span><span class="c1">//PackageManagerService成员变量mComponentResolver就是通过ParsingPackageImpl.receivers拿到所有安装应用的receiver</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">ComponentResolver</span><span class="w"> </span><span class="n">mComponentResolver</span><span class="p">;</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="_10">动态广播<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<div class="language-java highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ActivityManagerService</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">IActivityManager</span><span class="p">.</span><span class="na">Stub</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">        </span><span class="kd">implements</span><span class="w"> </span><span class="n">Watchdog</span><span class="p">.</span><span class="na">Monitor</span><span class="p">,</span><span class="w"> </span><span class="n">BatteryStatsImpl</span><span class="p">.</span><span class="na">BatteryCallback</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityManagerGlobalLock</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">    </span><span class="c1">//保存了系统中所有的动态注册的广播，以应用进程中的IIntentReceiver的binder代理端为key, 保存了该Receiver对应的所有IntentFilter，是一个一对多的关系，一个BroadcastReceiver对应多个intentFilter。</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">IBinder</span><span class="p">,</span><span class="w"> </span><span class="n">ReceiverList</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mRegisteredReceivers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="_11">广播队列<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<div class="language-java highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ActivityManagerService</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">IActivityManager</span><span class="p">.</span><span class="na">Stub</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">        </span><span class="kd">implements</span><span class="w"> </span><span class="n">Watchdog</span><span class="p">.</span><span class="na">Monitor</span><span class="p">,</span><span class="w"> </span><span class="n">BatteryStatsImpl</span><span class="p">.</span><span class="na">BatteryCallback</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityManagerGlobalLock</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">BroadcastQueue</span><span class="w"> </span><span class="n">mFgBroadcastQueue</span><span class="p">;</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">BroadcastQueue</span><span class="w"> </span><span class="n">mBgBroadcastQueue</span><span class="p">;</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">BroadcastQueue</span><span class="w"> </span><span class="n">mBgOffloadBroadcastQueue</span><span class="p">;</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">BroadcastQueue</span><span class="w"> </span><span class="n">mFgOffloadBroadcastQueue</span><span class="p">;</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="p">}</span>
</span></code></pre></div>
<h2 id="_12">使用<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h2>
<h3 id="_13">注册<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h3>
<h4 id="_14">静态<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h4>
<div class="language-xml highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="nt">&lt;receiver</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">    </span><span class="na">android:name=</span><span class="s">&quot;.TestBroadcastReceiver&quot;</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">    </span><span class="na">android:exported=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">    </span><span class="nt">&lt;intent-filter&gt;</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">        </span><span class="nt">&lt;action</span><span class="w"> </span><span class="na">android:name=</span><span class="s">&quot;android.intent.action.BOOT_COMPLETED&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">    </span><span class="nt">&lt;/intent-filter&gt;</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="nt">&lt;/receiver&gt;</span>
</span></code></pre></div>
<div class="language-java highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">BootCompletedReceiver</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">BroadcastReceiver</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="w">    </span><span class="nd">@Override</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onReceive</span><span class="p">(</span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_BOOT_COMPLETED</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">            </span><span class="c1">//接收到开机广播</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>android:permission<br />
    如果设置，<strong>具有相应权限的广播发送方发送的广播才能被此broadcastReceiver所接收</strong></li>
<li>android:priority="999"</li>
</ul>
<p>Priority属性的值决定，值越大，优先级越高；Priority属性相同时，动态注册的广播优先于静态注册的广播</p>
<h4 id="_15">动态<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="n">IntentFilter</span><span class="w"> </span><span class="n">filter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IntentFilter</span><span class="p">();</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="n">filter</span><span class="p">.</span><span class="na">addAction</span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_SCREEN_ON</span><span class="p">);</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="n">filter</span><span class="p">.</span><span class="na">addAction</span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_SCREEN_OFF</span><span class="p">);</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="n">ScreenBroadcastReceiver</span><span class="w"> </span><span class="n">receiver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ScreenBroadcastReceiver</span><span class="p">();</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="n">mContext</span><span class="p">.</span><span class="na">registerReceiver</span><span class="p">(</span><span class="n">receiver</span><span class="p">,</span><span class="w"> </span><span class="n">filter</span><span class="p">);</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="kd">private</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ScreenBroadcastReceiver</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">BroadcastReceiver</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="w">    </span><span class="nd">@Override</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onReceive</span><span class="p">(</span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">();</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_SCREEN_ON</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">action</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="w">            </span><span class="c1">//TODO</span>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_SCREEN_OFF</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">action</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span class="w">            </span><span class="c1">//TODO</span>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="_16">发送<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h3>
<div class="language-java highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Intent</span><span class="p">();</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="n">intent</span><span class="p">.</span><span class="na">setAction</span><span class="p">(</span><span class="s">&quot;action...&quot;</span><span class="p">);</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="n">mContext</span><span class="p">.</span><span class="na">sendBroadcast</span><span class="p">(</span><span class="n">intent</span><span class="p">);</span>
</span></code></pre></div>
<h2 id="faq">FAQ<a class="headerlink" href="#faq" title="Permanent link">&para;</a></h2>
<ul>
<li>"W BroadcastQueue: Background execution not allowed: receiving"</li>
</ul>
<p>不能启动后台进程</p>
<ul>
<li>"W BroadcastQueue: Permission Denial: broadcasting"</li>
</ul>
<p>注册者 申请权限</p>
<p>发送者 未设置权限</p>
<ul>
<li>"W BroadcastQueue: Permission Denial: receiving"</li>
</ul>
<p>注册者 未申请权限</p>
<p>发送者 设置权限</p>
<h2 id="_17">静态广播注册流程<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h2>
<p>AndroidManifest静态注册的安装过程是在PMS处理的，这里我们省略PMS启动过程、处理安装请求过程等，直接从解析包的信息开始分析。</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="n">ParsingPackageUtils</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w"> </span><span class="kd">public</span><span class="w"> </span><span class="n">ParseResult</span><span class="o">&lt;</span><span class="n">ParsingPackage</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">parsePackage</span><span class="p">(</span><span class="n">ParseInput</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">File</span><span class="w"> </span><span class="n">packageFile</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span><span class="w"> </span><span class="n">frameworkSplits</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(((</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PARSE_FRAMEWORK_RES_SPLITS</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">            </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">frameworkSplits</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">            </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">packageFile</span><span class="p">.</span><span class="na">getAbsolutePath</span><span class="p">().</span><span class="na">endsWith</span><span class="p">(</span><span class="s">&quot;/framework-res.apk&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">parseClusterPackage</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">packageFile</span><span class="p">,</span><span class="w"> </span><span class="n">frameworkSplits</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">packageFile</span><span class="p">.</span><span class="na">isDirectory</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">parseClusterPackage</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">packageFile</span><span class="p">,</span><span class="w"> </span><span class="cm">/* frameworkSplits= */</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">parseMonolithicPackage</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">packageFile</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="p">}</span>
</span></code></pre></div>
<p>当前流程是走到parseClusterPackage</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="n">ParsingPackageUtils</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="kd">private</span><span class="w"> </span><span class="n">ParseResult</span><span class="o">&lt;</span><span class="n">ParsingPackage</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">parseClusterPackage</span><span class="p">(</span><span class="n">ParseInput</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">File</span><span class="w"> </span><span class="n">packageDir</span><span class="p">,</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span><span class="w"> </span><span class="n">frameworkSplits</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">ParseResult</span><span class="o">&lt;</span><span class="n">PackageLite</span><span class="o">&gt;</span><span class="w"> </span><span class="n">liteResult</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="w">            </span><span class="n">ApkLiteParseUtils</span><span class="p">.</span><span class="na">parseClusterPackageLite</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">packageDir</span><span class="p">,</span><span class="w"> </span><span class="n">frameworkSplits</span><span class="p">,</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="w">                    </span><span class="n">liteParseFlags</span><span class="p">);</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">File</span><span class="w"> </span><span class="n">baseApk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">lite</span><span class="p">.</span><span class="na">getBaseApkPath</span><span class="p">());</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">ParseResult</span><span class="o">&lt;</span><span class="n">ParsingPackage</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseBaseApk</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">baseApk</span><span class="p">,</span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a><span class="w">                </span><span class="n">lite</span><span class="p">.</span><span class="na">getPath</span><span class="p">(),</span><span class="w"> </span><span class="n">assetLoader</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a><span class="w">        </span><span class="p">...</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a><span class="p">}</span>
</span></code></pre></div>
<p>调用ApkLiteParseUtils.parseClusterPackageLite得到包的一些基本信息。</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="n">PackageLite</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PackageLite</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">    </span><span class="c1">//apk包名</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="nd">@NonNull</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">mPackageName</span><span class="p">;</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">    </span><span class="c1">//apk目录</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="nd">@NonNull</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">mPath</span><span class="p">;</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="w">    </span><span class="c1">//apk路径</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="nd">@NonNull</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">mBaseApkPath</span><span class="p">;</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="w">    </span><span class="cm">/** Major and minor version number of this package */</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mVersionCodeMajor</span><span class="p">;</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mVersionCode</span><span class="p">;</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mTargetSdk</span><span class="p">;</span>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a><span class="p">}</span>
</span></code></pre></div>
<p>调用parseBaseApk解析BaseApk。</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="n">ParsingPackageUtils</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="kd">private</span><span class="w"> </span><span class="n">ParseResult</span><span class="o">&lt;</span><span class="n">ParsingPackage</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">parseBaseApk</span><span class="p">(</span><span class="n">ParseInput</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">File</span><span class="w"> </span><span class="n">apkFile</span><span class="p">,</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">codePath</span><span class="p">,</span><span class="w"> </span><span class="n">SplitAssetLoader</span><span class="w"> </span><span class="n">assetLoader</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="w">    </span><span class="c1">//创建解析器parser，来解析ANDROID_MANIFEST_FILENAME = &quot;AndroidManifest.xml&quot;</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">(</span><span class="n">XmlResourceParser</span><span class="w"> </span><span class="n">parser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">assets</span><span class="p">.</span><span class="na">openXmlResourceParser</span><span class="p">(</span><span class="n">cookie</span><span class="p">,</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="w">            </span><span class="n">ANDROID_MANIFEST_FILENAME</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">Resources</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Resources</span><span class="p">(</span><span class="n">assets</span><span class="p">,</span><span class="w"> </span><span class="n">mDisplayMetrics</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="w">        </span><span class="c1">//传入解析器parser，解析BaseApk</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="w">        </span><span class="n">ParseResult</span><span class="o">&lt;</span><span class="n">ParsingPackage</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseBaseApk</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">apkPath</span><span class="p">,</span><span class="w"> </span><span class="n">codePath</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">,</span>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="w">                </span><span class="n">parser</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a><span class="w">        </span><span class="p">...</span>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a><span class="p">}</span>
</span></code></pre></div>
<p>创建AndroidManifest.xml解析器XmlResourceParser，并调用parseBaseApk传入解析器parser，解析BaseApk。</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="n">ParsingPackageUtils</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="cm">/**</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="cm"> * Parse the manifest of a &lt;em&gt;base APK&lt;/em&gt;. When adding new features you need to consider</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="cm"> * whether they should be supported by split APKs and child packages.</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="cm"> *</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="cm"> * @param apkPath The package apk file path</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="cm"> * @param res     The resources from which to resolve values</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="cm"> * @param parser  The manifest parser</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="cm"> * @param flags   Flags how to parse</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="cm"> * @return Parsed package or null on error.</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="cm"> */</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a><span class="kd">private</span><span class="w"> </span><span class="n">ParseResult</span><span class="o">&lt;</span><span class="n">ParsingPackage</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">parseBaseApk</span><span class="p">(</span><span class="n">ParseInput</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">apkPath</span><span class="p">,</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">codePath</span><span class="p">,</span><span class="w"> </span><span class="n">Resources</span><span class="w"> </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">XmlResourceParser</span><span class="w"> </span><span class="n">parser</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="w">        </span><span class="kd">throws</span><span class="w"> </span><span class="n">XmlPullParserException</span><span class="p">,</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a>
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">TypedArray</span><span class="w"> </span><span class="n">manifestArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">res</span><span class="p">.</span><span class="na">obtainAttributes</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="na">styleable</span><span class="p">.</span><span class="na">AndroidManifest</span><span class="p">);</span>
</span><span id="__span-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-20"><a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a><span class="w">        </span><span class="p">...</span>
</span><span id="__span-14-21"><a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">ParseResult</span><span class="o">&lt;</span><span class="n">ParsingPackage</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-14-22"><a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a><span class="w">                </span><span class="n">parseBaseApkTags</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">pkg</span><span class="p">,</span><span class="w"> </span><span class="n">manifestArray</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">parser</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
</span><span id="__span-14-23"><a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a><span class="w">        </span><span class="p">...</span>
</span><span id="__span-14-24"><a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-14-25"><a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-14-26"><a id="__codelineno-14-26" name="__codelineno-14-26" href="#__codelineno-14-26"></a><span class="p">}</span>
</span></code></pre></div>
<p>调用parseBaseApkTags解析manifest中的各类TAG。</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="kd">private</span><span class="w"> </span><span class="n">ParseResult</span><span class="o">&lt;</span><span class="n">ParsingPackage</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">parseBaseApkTags</span><span class="p">(</span><span class="n">ParseInput</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">ParsingPackage</span><span class="w"> </span><span class="n">pkg</span><span class="p">,</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="w">        </span><span class="n">TypedArray</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="w"> </span><span class="n">Resources</span><span class="w"> </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">XmlResourceParser</span><span class="w"> </span><span class="n">parser</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="w">        </span><span class="kd">throws</span><span class="w"> </span><span class="n">XmlPullParserException</span><span class="p">,</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parser</span><span class="p">.</span><span class="na">next</span><span class="p">())</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">XmlPullParser</span><span class="p">.</span><span class="na">END_DOCUMENT</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="w">            </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">XmlPullParser</span><span class="p">.</span><span class="na">END_TAG</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="w">            </span><span class="o">||</span><span class="w"> </span><span class="n">parser</span><span class="p">.</span><span class="na">getDepth</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">depth</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="w">        </span><span class="p">...</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="w">        </span><span class="c1">// &lt;application&gt; has special logic, so it&#39;s handled outside the general method</span>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">TAG_APPLICATION</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">tagName</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">foundApp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a><span class="w">                </span><span class="p">...</span>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a><span class="w">                </span><span class="n">foundApp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a><span class="w">                </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseBaseApplication</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">pkg</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">parser</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a><span class="w">        </span><span class="p">...</span>
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a>
</span><span id="__span-15-22"><a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-15-23"><a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a>
</span><span id="__span-15-24"><a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">input</span><span class="p">.</span><span class="na">success</span><span class="p">(</span><span class="n">pkg</span><span class="p">);</span>
</span><span id="__span-15-25"><a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a><span class="p">}</span>
</span></code></pre></div>
<p>TAG_APPLICATION = "application"时，则调用parseBaseApplication进行application的内容解析。</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="kd">private</span><span class="w"> </span><span class="n">ParseResult</span><span class="o">&lt;</span><span class="n">ParsingPackage</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">parseBaseApplication</span><span class="p">(</span><span class="n">ParseInput</span><span class="w"> </span><span class="n">input</span><span class="p">,</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">        </span><span class="n">ParsingPackage</span><span class="w"> </span><span class="n">pkg</span><span class="p">,</span><span class="w"> </span><span class="n">Resources</span><span class="w"> </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">XmlResourceParser</span><span class="w"> </span><span class="n">parser</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">        </span><span class="kd">throws</span><span class="w"> </span><span class="n">XmlPullParserException</span><span class="p">,</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parser</span><span class="p">.</span><span class="na">next</span><span class="p">())</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">XmlPullParser</span><span class="p">.</span><span class="na">END_DOCUMENT</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="w">            </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">XmlPullParser</span><span class="p">.</span><span class="na">END_TAG</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="w">            </span><span class="o">||</span><span class="w"> </span><span class="n">parser</span><span class="p">.</span><span class="na">getDepth</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">depth</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="w">        </span><span class="p">...</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isActivity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">tagName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;activity&quot;</span><span class="p">:</span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="w">                </span><span class="n">isActivity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="w">                </span><span class="c1">// fall-through</span>
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;receiver&quot;</span><span class="p">:</span>
</span><span id="__span-16-17"><a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a><span class="w">                </span><span class="n">ParseResult</span><span class="o">&lt;</span><span class="n">ParsedActivity</span><span class="o">&gt;</span><span class="w"> </span><span class="n">activityResult</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-16-18"><a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a><span class="w">                        </span><span class="n">ParsedActivityUtils</span><span class="p">.</span><span class="na">parseActivityOrReceiver</span><span class="p">(</span><span class="n">mSeparateProcesses</span><span class="p">,</span><span class="w"> </span><span class="n">pkg</span><span class="p">,</span>
</span><span id="__span-16-19"><a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a><span class="w">                                </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">parser</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">sUseRoundIcon</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="cm">/*defaultSplitName*/</span><span class="p">,</span>
</span><span id="__span-16-20"><a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a><span class="w">                                </span><span class="n">input</span><span class="p">);</span>
</span><span id="__span-16-21"><a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a>
</span><span id="__span-16-22"><a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">activityResult</span><span class="p">.</span><span class="na">isSuccess</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-23"><a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a><span class="w">                    </span><span class="n">ParsedActivity</span><span class="w"> </span><span class="n">activity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activityResult</span><span class="p">.</span><span class="na">getResult</span><span class="p">();</span>
</span><span id="__span-16-24"><a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isActivity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-25"><a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a><span class="w">                        </span><span class="n">hasActivityOrder</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="n">activity</span><span class="p">.</span><span class="na">getOrder</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-16-26"><a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a><span class="w">                        </span><span class="n">pkg</span><span class="p">.</span><span class="na">addActivity</span><span class="p">(</span><span class="n">activity</span><span class="p">);</span>
</span><span id="__span-16-27"><a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a><span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-28"><a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a><span class="w">                        </span><span class="n">hasReceiverOrder</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="n">activity</span><span class="p">.</span><span class="na">getOrder</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-16-29"><a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a><span class="w">                        </span><span class="n">pkg</span><span class="p">.</span><span class="na">addReceiver</span><span class="p">(</span><span class="n">activity</span><span class="p">);</span>
</span><span id="__span-16-30"><a id="__codelineno-16-30" name="__codelineno-16-30" href="#__codelineno-16-30"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-16-31"><a id="__codelineno-16-31" name="__codelineno-16-31" href="#__codelineno-16-31"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-16-32"><a id="__codelineno-16-32" name="__codelineno-16-32" href="#__codelineno-16-32"></a>
</span><span id="__span-16-33"><a id="__codelineno-16-33" name="__codelineno-16-33" href="#__codelineno-16-33"></a><span class="w">                </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activityResult</span><span class="p">;</span>
</span><span id="__span-16-34"><a id="__codelineno-16-34" name="__codelineno-16-34" href="#__codelineno-16-34"></a><span class="w">                </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-16-35"><a id="__codelineno-16-35" name="__codelineno-16-35" href="#__codelineno-16-35"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;service&quot;</span><span class="p">:</span>
</span><span id="__span-16-36"><a id="__codelineno-16-36" name="__codelineno-16-36" href="#__codelineno-16-36"></a><span class="w">                </span><span class="p">...</span>
</span><span id="__span-16-37"><a id="__codelineno-16-37" name="__codelineno-16-37" href="#__codelineno-16-37"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;provider&quot;</span><span class="p">:</span>
</span><span id="__span-16-38"><a id="__codelineno-16-38" name="__codelineno-16-38" href="#__codelineno-16-38"></a><span class="w">                </span><span class="p">...</span>
</span><span id="__span-16-39"><a id="__codelineno-16-39" name="__codelineno-16-39" href="#__codelineno-16-39"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;activity-alias&quot;</span><span class="p">:</span>
</span><span id="__span-16-40"><a id="__codelineno-16-40" name="__codelineno-16-40" href="#__codelineno-16-40"></a><span class="w">                </span><span class="p">...</span>
</span><span id="__span-16-41"><a id="__codelineno-16-41" name="__codelineno-16-41" href="#__codelineno-16-41"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;apex-system-service&quot;</span><span class="p">:</span>
</span><span id="__span-16-42"><a id="__codelineno-16-42" name="__codelineno-16-42" href="#__codelineno-16-42"></a><span class="w">                </span><span class="p">...</span>
</span><span id="__span-16-43"><a id="__codelineno-16-43" name="__codelineno-16-43" href="#__codelineno-16-43"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-16-44"><a id="__codelineno-16-44" name="__codelineno-16-44" href="#__codelineno-16-44"></a>
</span><span id="__span-16-45"><a id="__codelineno-16-45" name="__codelineno-16-45" href="#__codelineno-16-45"></a><span class="w">        </span><span class="p">...</span>
</span><span id="__span-16-46"><a id="__codelineno-16-46" name="__codelineno-16-46" href="#__codelineno-16-46"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-16-47"><a id="__codelineno-16-47" name="__codelineno-16-47" href="#__codelineno-16-47"></a>
</span><span id="__span-16-48"><a id="__codelineno-16-48" name="__codelineno-16-48" href="#__codelineno-16-48"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-16-49"><a id="__codelineno-16-49" name="__codelineno-16-49" href="#__codelineno-16-49"></a>
</span><span id="__span-16-50"><a id="__codelineno-16-50" name="__codelineno-16-50" href="#__codelineno-16-50"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hasReceiverOrder</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-51"><a id="__codelineno-16-51" name="__codelineno-16-51" href="#__codelineno-16-51"></a><span class="w">        </span><span class="n">pkg</span><span class="p">.</span><span class="na">sortReceivers</span><span class="p">();</span>
</span><span id="__span-16-52"><a id="__codelineno-16-52" name="__codelineno-16-52" href="#__codelineno-16-52"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-16-53"><a id="__codelineno-16-53" name="__codelineno-16-53" href="#__codelineno-16-53"></a>
</span><span id="__span-16-54"><a id="__codelineno-16-54" name="__codelineno-16-54" href="#__codelineno-16-54"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-16-55"><a id="__codelineno-16-55" name="__codelineno-16-55" href="#__codelineno-16-55"></a>
</span><span id="__span-16-56"><a id="__codelineno-16-56" name="__codelineno-16-56" href="#__codelineno-16-56"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>这里发现进入activity这个case没有break，这意味着activity和receiver的解析是一样的，它们比较类似；从调用函数名字parseActivityOrReceiver也可以看出。</li>
<li>ParsedActivityUtils.parseActivityOrReceiver-&gt;ParsedActivityUtils.parseActivityOrAlias中每一个"intent-filter"会对应一个ParsedIntentInfo。</li>
<li>pkg.addReceiver(activity) 将该ParsedActivity activity(receiver)放入ParsingPackageImpl的receivers。</li>
<li>hasReceiverOrder 按照android:order进行排序，order越大的receiver放在receivers列表的前面。</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>ParsingPackageImpl.java
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>public ParsingPackageImpl addReceiver(ParsedActivity parsedReceiver) {
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>    this.receivers = CollectionUtils.add(this.receivers, parsedReceiver);
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>    addMimeGroupsFromComponent(parsedReceiver);
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>    return this;
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>}
</span></code></pre></div>
<p>在后续的PMS流程里（InstallPackageHelper.installPackagesLI() -&gt; InstallPackageHelper.commitPackagesLocked() -&gt; InstallPackageHelper.commitReconciledScanResultLocked() -&gt; InstallPackageHelper.commitPackageSettings() -&gt; ComponentResolver.addAllComponents() -&gt; ComponentResolver.addReceiversLocked() ）</p>
<p>PackageManagerService成员变量mComponentResolver就是通过ParsingPackageImpl.receivers拿到所有安装应用的receiver。</p>
<h3 id="_18">总结<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h3>
<ul>
<li>AndroidManifest.xml中的receiver解析成ParsedActivity, 存放在PackageImpl的receivers(PackageImpl父类是ParsingPackageImpl而且实现了AndroidPackage接口)。</li>
<li>receivers最终会存放在mComponentResolver(PMS)的mReceivers中，mReceivers包含了所有安装应用的receiver。</li>
</ul>
<h2 id="_19">动态广播注册流程<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h2>
<p>在前面使用介绍到了动态注册调用Context.registerReceiver进行注册。</p>
<h3 id="contextimpl">ContextImpl<a class="headerlink" href="#contextimpl" title="Permanent link">&para;</a></h3>
<p>平时我们在activity中经常调用Context.startActivity()、Context.startService()、、Context.bindService()、Context.registerReceiver()、Context.sendBroadcast()等等，但我们使用Android Studio点进去之后发现Context是一个抽象类。有Android经验的同学都知道其实是调到了ContextImpl。那ContextImpl怎么跟Context关联起来的呢？</p>
<p>启动应用时发出的LaunchActivityItem会执行activity生命周期的内容，在ActivityThread.java的performLaunchActivity函数里。</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="n">ActivityThread</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="kd">private</span><span class="w"> </span><span class="n">Activity</span><span class="w"> </span><span class="nf">performLaunchActivity</span><span class="p">(</span><span class="n">ActivityClientRecord</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">Intent</span><span class="w"> </span><span class="n">customIntent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="w">    </span><span class="n">ContextImpl</span><span class="w"> </span><span class="n">appContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createBaseContextForActivity</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="w">        </span><span class="p">...</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="w">        </span><span class="n">appContext</span><span class="p">.</span><span class="na">setOuterContext</span><span class="p">(</span><span class="n">activity</span><span class="p">);</span>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="w">        </span><span class="n">activity</span><span class="p">.</span><span class="na">attach</span><span class="p">(</span><span class="n">appContext</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">getInstrumentation</span><span class="p">(),</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">token</span><span class="p">,</span>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="w">                </span><span class="n">r</span><span class="p">.</span><span class="na">ident</span><span class="p">,</span><span class="w"> </span><span class="n">app</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">,</span><span class="w"> </span><span class="n">title</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">parent</span><span class="p">,</span>
</span><span id="__span-18-15"><a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="w">                </span><span class="n">r</span><span class="p">.</span><span class="na">embeddedID</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">lastNonConfigurationInstances</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">,</span>
</span><span id="__span-18-16"><a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="w">                </span><span class="n">r</span><span class="p">.</span><span class="na">referrer</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">voiceInteractor</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">activityConfigCallback</span><span class="p">,</span>
</span><span id="__span-18-17"><a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a><span class="w">                </span><span class="n">r</span><span class="p">.</span><span class="na">assistToken</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">shareableActivityToken</span><span class="p">);</span>
</span><span id="__span-18-18"><a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a>
</span><span id="__span-18-19"><a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a><span class="w">        </span><span class="p">...</span>
</span><span id="__span-18-20"><a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a>
</span><span id="__span-18-21"><a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span>
</span><span id="__span-18-22"><a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a>
</span><span id="__span-18-23"><a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-18-24"><a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a>
</span><span id="__span-18-25"><a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">activity</span><span class="p">;</span>
</span><span id="__span-18-26"><a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a><span class="p">}</span>
</span><span id="__span-18-27"><a id="__codelineno-18-27" name="__codelineno-18-27" href="#__codelineno-18-27"></a>
</span><span id="__span-18-28"><a id="__codelineno-18-28" name="__codelineno-18-28" href="#__codelineno-18-28"></a><span class="kd">private</span><span class="w"> </span><span class="n">ContextImpl</span><span class="w"> </span><span class="nf">createBaseContextForActivity</span><span class="p">(</span><span class="n">ActivityClientRecord</span><span class="w"> </span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-29"><a id="__codelineno-18-29" name="__codelineno-18-29" href="#__codelineno-18-29"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">displayId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ActivityClient</span><span class="p">.</span><span class="na">getInstance</span><span class="p">().</span><span class="na">getDisplayId</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">token</span><span class="p">);</span>
</span><span id="__span-18-30"><a id="__codelineno-18-30" name="__codelineno-18-30" href="#__codelineno-18-30"></a><span class="w">    </span><span class="n">ContextImpl</span><span class="w"> </span><span class="n">appContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ContextImpl</span><span class="p">.</span><span class="na">createActivityContext</span><span class="p">(</span>
</span><span id="__span-18-31"><a id="__codelineno-18-31" name="__codelineno-18-31" href="#__codelineno-18-31"></a><span class="w">            </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">packageInfo</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">token</span><span class="p">,</span><span class="w"> </span><span class="n">displayId</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">overrideConfig</span><span class="p">);</span>
</span><span id="__span-18-32"><a id="__codelineno-18-32" name="__codelineno-18-32" href="#__codelineno-18-32"></a>
</span><span id="__span-18-33"><a id="__codelineno-18-33" name="__codelineno-18-33" href="#__codelineno-18-33"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-18-34"><a id="__codelineno-18-34" name="__codelineno-18-34" href="#__codelineno-18-34"></a>
</span><span id="__span-18-35"><a id="__codelineno-18-35" name="__codelineno-18-35" href="#__codelineno-18-35"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">appContext</span><span class="p">;</span>
</span><span id="__span-18-36"><a id="__codelineno-18-36" name="__codelineno-18-36" href="#__codelineno-18-36"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>调用createBaseContextForActivity创建ContextImpl。</li>
</ul>
<div class="language-java highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="n">ContextImpl</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="kd">static</span><span class="w"> </span><span class="n">ContextImpl</span><span class="w"> </span><span class="nf">createActivityContext</span><span class="p">(</span><span class="n">ActivityThread</span><span class="w"> </span><span class="n">mainThread</span><span class="p">,</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="w">        </span><span class="n">LoadedApk</span><span class="w"> </span><span class="n">packageInfo</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityInfo</span><span class="w"> </span><span class="n">activityInfo</span><span class="p">,</span><span class="w"> </span><span class="n">IBinder</span><span class="w"> </span><span class="n">activityToken</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">displayId</span><span class="p">,</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="w">        </span><span class="n">Configuration</span><span class="w"> </span><span class="n">overrideConfiguration</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="w">    </span><span class="n">ContextImpl</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ContextImpl</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">mainThread</span><span class="p">,</span><span class="w"> </span><span class="n">packageInfo</span><span class="p">,</span><span class="w"> </span><span class="n">ContextParams</span><span class="p">.</span><span class="na">EMPTY</span><span class="p">,</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="w">            </span><span class="n">attributionTag</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">activityInfo</span><span class="p">.</span><span class="na">splitName</span><span class="p">,</span><span class="w"> </span><span class="n">activityToken</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">classLoader</span><span class="p">,</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="w">            </span><span class="kc">null</span><span class="p">);</span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">context</span><span class="p">;</span>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="contextimplregisterreceiver">ContextImpl.registerReceiver<a class="headerlink" href="#contextimplregisterreceiver" title="Permanent link">&para;</a></h3>
<div class="language-java highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="n">ContextImpl</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="nd">@Override</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="kd">public</span><span class="w"> </span><span class="n">Intent</span><span class="w"> </span><span class="nf">registerReceiver</span><span class="p">(</span><span class="n">BroadcastReceiver</span><span class="w"> </span><span class="n">receiver</span><span class="p">,</span><span class="w"> </span><span class="n">IntentFilter</span><span class="w"> </span><span class="n">filter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">registerReceiver</span><span class="p">(</span><span class="n">receiver</span><span class="p">,</span><span class="w"> </span><span class="n">filter</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="p">}</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="nd">@Override</span>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="kd">public</span><span class="w"> </span><span class="n">Intent</span><span class="w"> </span><span class="nf">registerReceiver</span><span class="p">(</span><span class="n">BroadcastReceiver</span><span class="w"> </span><span class="n">receiver</span><span class="p">,</span><span class="w"> </span><span class="n">IntentFilter</span><span class="w"> </span><span class="n">filter</span><span class="p">,</span>
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">registerReceiver</span><span class="p">(</span><span class="n">receiver</span><span class="p">,</span><span class="w"> </span><span class="n">filter</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
</span><span id="__span-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="p">}</span>
</span><span id="__span-20-13"><a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a>
</span><span id="__span-20-14"><a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a><span class="nd">@Override</span>
</span><span id="__span-20-15"><a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a><span class="kd">public</span><span class="w"> </span><span class="n">Intent</span><span class="w"> </span><span class="nf">registerReceiver</span><span class="p">(</span><span class="n">BroadcastReceiver</span><span class="w"> </span><span class="n">receiver</span><span class="p">,</span><span class="w"> </span><span class="n">IntentFilter</span><span class="w"> </span><span class="n">filter</span><span class="p">,</span>
</span><span id="__span-20-16"><a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">broadcastPermission</span><span class="p">,</span><span class="w"> </span><span class="n">Handler</span><span class="w"> </span><span class="n">scheduler</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-20-17"><a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">registerReceiverInternal</span><span class="p">(</span><span class="n">receiver</span><span class="p">,</span><span class="w"> </span><span class="n">getUserId</span><span class="p">(),</span>
</span><span id="__span-20-18"><a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a><span class="w">            </span><span class="n">filter</span><span class="p">,</span><span class="w"> </span><span class="n">broadcastPermission</span><span class="p">,</span><span class="w"> </span><span class="n">scheduler</span><span class="p">,</span><span class="w"> </span><span class="n">getOuterContext</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-20-19"><a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a><span class="p">}</span>
</span><span id="__span-20-20"><a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a>
</span><span id="__span-20-21"><a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a><span class="nd">@Override</span>
</span><span id="__span-20-22"><a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a><span class="kd">public</span><span class="w"> </span><span class="n">Intent</span><span class="w"> </span><span class="nf">registerReceiver</span><span class="p">(</span><span class="n">BroadcastReceiver</span><span class="w"> </span><span class="n">receiver</span><span class="p">,</span><span class="w"> </span><span class="n">IntentFilter</span><span class="w"> </span><span class="n">filter</span><span class="p">,</span>
</span><span id="__span-20-23"><a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">broadcastPermission</span><span class="p">,</span><span class="w"> </span><span class="n">Handler</span><span class="w"> </span><span class="n">scheduler</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-20-24"><a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">registerReceiverInternal</span><span class="p">(</span><span class="n">receiver</span><span class="p">,</span><span class="w"> </span><span class="n">getUserId</span><span class="p">(),</span>
</span><span id="__span-20-25"><a id="__codelineno-20-25" name="__codelineno-20-25" href="#__codelineno-20-25"></a><span class="w">            </span><span class="n">filter</span><span class="p">,</span><span class="w"> </span><span class="n">broadcastPermission</span><span class="p">,</span><span class="w"> </span><span class="n">scheduler</span><span class="p">,</span><span class="w"> </span><span class="n">getOuterContext</span><span class="p">(),</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
</span><span id="__span-20-26"><a id="__codelineno-20-26" name="__codelineno-20-26" href="#__codelineno-20-26"></a><span class="p">}</span>
</span><span id="__span-20-27"><a id="__codelineno-20-27" name="__codelineno-20-27" href="#__codelineno-20-27"></a>
</span><span id="__span-20-28"><a id="__codelineno-20-28" name="__codelineno-20-28" href="#__codelineno-20-28"></a><span class="nd">@Override</span>
</span><span id="__span-20-29"><a id="__codelineno-20-29" name="__codelineno-20-29" href="#__codelineno-20-29"></a><span class="kd">public</span><span class="w"> </span><span class="n">Intent</span><span class="w"> </span><span class="nf">registerReceiverForAllUsers</span><span class="p">(</span><span class="n">BroadcastReceiver</span><span class="w"> </span><span class="n">receiver</span><span class="p">,</span>
</span><span id="__span-20-30"><a id="__codelineno-20-30" name="__codelineno-20-30" href="#__codelineno-20-30"></a><span class="w">        </span><span class="n">IntentFilter</span><span class="w"> </span><span class="n">filter</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">broadcastPermission</span><span class="p">,</span><span class="w"> </span><span class="n">Handler</span><span class="w"> </span><span class="n">scheduler</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-20-31"><a id="__codelineno-20-31" name="__codelineno-20-31" href="#__codelineno-20-31"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">registerReceiverAsUser</span><span class="p">(</span><span class="n">receiver</span><span class="p">,</span><span class="w"> </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">ALL</span><span class="p">,</span>
</span><span id="__span-20-32"><a id="__codelineno-20-32" name="__codelineno-20-32" href="#__codelineno-20-32"></a><span class="w">            </span><span class="n">filter</span><span class="p">,</span><span class="w"> </span><span class="n">broadcastPermission</span><span class="p">,</span><span class="w"> </span><span class="n">scheduler</span><span class="p">);</span>
</span><span id="__span-20-33"><a id="__codelineno-20-33" name="__codelineno-20-33" href="#__codelineno-20-33"></a><span class="p">}</span>
</span><span id="__span-20-34"><a id="__codelineno-20-34" name="__codelineno-20-34" href="#__codelineno-20-34"></a>
</span><span id="__span-20-35"><a id="__codelineno-20-35" name="__codelineno-20-35" href="#__codelineno-20-35"></a><span class="nd">@Override</span>
</span><span id="__span-20-36"><a id="__codelineno-20-36" name="__codelineno-20-36" href="#__codelineno-20-36"></a><span class="kd">public</span><span class="w"> </span><span class="n">Intent</span><span class="w"> </span><span class="nf">registerReceiverForAllUsers</span><span class="p">(</span><span class="n">BroadcastReceiver</span><span class="w"> </span><span class="n">receiver</span><span class="p">,</span>
</span><span id="__span-20-37"><a id="__codelineno-20-37" name="__codelineno-20-37" href="#__codelineno-20-37"></a><span class="w">        </span><span class="n">IntentFilter</span><span class="w"> </span><span class="n">filter</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">broadcastPermission</span><span class="p">,</span><span class="w"> </span><span class="n">Handler</span><span class="w"> </span><span class="n">scheduler</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-20-38"><a id="__codelineno-20-38" name="__codelineno-20-38" href="#__codelineno-20-38"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">registerReceiverAsUser</span><span class="p">(</span><span class="n">receiver</span><span class="p">,</span><span class="w"> </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">ALL</span><span class="p">,</span>
</span><span id="__span-20-39"><a id="__codelineno-20-39" name="__codelineno-20-39" href="#__codelineno-20-39"></a><span class="w">            </span><span class="n">filter</span><span class="p">,</span><span class="w"> </span><span class="n">broadcastPermission</span><span class="p">,</span><span class="w"> </span><span class="n">scheduler</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
</span><span id="__span-20-40"><a id="__codelineno-20-40" name="__codelineno-20-40" href="#__codelineno-20-40"></a><span class="p">}</span>
</span><span id="__span-20-41"><a id="__codelineno-20-41" name="__codelineno-20-41" href="#__codelineno-20-41"></a>
</span><span id="__span-20-42"><a id="__codelineno-20-42" name="__codelineno-20-42" href="#__codelineno-20-42"></a><span class="nd">@Override</span>
</span><span id="__span-20-43"><a id="__codelineno-20-43" name="__codelineno-20-43" href="#__codelineno-20-43"></a><span class="kd">public</span><span class="w"> </span><span class="n">Intent</span><span class="w"> </span><span class="nf">registerReceiverAsUser</span><span class="p">(</span><span class="n">BroadcastReceiver</span><span class="w"> </span><span class="n">receiver</span><span class="p">,</span><span class="w"> </span><span class="n">UserHandle</span><span class="w"> </span><span class="n">user</span><span class="p">,</span>
</span><span id="__span-20-44"><a id="__codelineno-20-44" name="__codelineno-20-44" href="#__codelineno-20-44"></a><span class="w">        </span><span class="n">IntentFilter</span><span class="w"> </span><span class="n">filter</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">broadcastPermission</span><span class="p">,</span><span class="w"> </span><span class="n">Handler</span><span class="w"> </span><span class="n">scheduler</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-20-45"><a id="__codelineno-20-45" name="__codelineno-20-45" href="#__codelineno-20-45"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">registerReceiverInternal</span><span class="p">(</span><span class="n">receiver</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="na">getIdentifier</span><span class="p">(),</span>
</span><span id="__span-20-46"><a id="__codelineno-20-46" name="__codelineno-20-46" href="#__codelineno-20-46"></a><span class="w">            </span><span class="n">filter</span><span class="p">,</span><span class="w"> </span><span class="n">broadcastPermission</span><span class="p">,</span><span class="w"> </span><span class="n">scheduler</span><span class="p">,</span><span class="w"> </span><span class="n">getOuterContext</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-20-47"><a id="__codelineno-20-47" name="__codelineno-20-47" href="#__codelineno-20-47"></a><span class="p">}</span>
</span><span id="__span-20-48"><a id="__codelineno-20-48" name="__codelineno-20-48" href="#__codelineno-20-48"></a>
</span><span id="__span-20-49"><a id="__codelineno-20-49" name="__codelineno-20-49" href="#__codelineno-20-49"></a><span class="nd">@Override</span>
</span><span id="__span-20-50"><a id="__codelineno-20-50" name="__codelineno-20-50" href="#__codelineno-20-50"></a><span class="kd">public</span><span class="w"> </span><span class="n">Intent</span><span class="w"> </span><span class="nf">registerReceiverAsUser</span><span class="p">(</span><span class="n">BroadcastReceiver</span><span class="w"> </span><span class="n">receiver</span><span class="p">,</span><span class="w"> </span><span class="n">UserHandle</span><span class="w"> </span><span class="n">user</span><span class="p">,</span>
</span><span id="__span-20-51"><a id="__codelineno-20-51" name="__codelineno-20-51" href="#__codelineno-20-51"></a><span class="w">        </span><span class="n">IntentFilter</span><span class="w"> </span><span class="n">filter</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">broadcastPermission</span><span class="p">,</span><span class="w"> </span><span class="n">Handler</span><span class="w"> </span><span class="n">scheduler</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-20-52"><a id="__codelineno-20-52" name="__codelineno-20-52" href="#__codelineno-20-52"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">registerReceiverInternal</span><span class="p">(</span><span class="n">receiver</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="na">getIdentifier</span><span class="p">(),</span>
</span><span id="__span-20-53"><a id="__codelineno-20-53" name="__codelineno-20-53" href="#__codelineno-20-53"></a><span class="w">            </span><span class="n">filter</span><span class="p">,</span><span class="w"> </span><span class="n">broadcastPermission</span><span class="p">,</span><span class="w"> </span><span class="n">scheduler</span><span class="p">,</span><span class="w"> </span><span class="n">getOuterContext</span><span class="p">(),</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
</span><span id="__span-20-54"><a id="__codelineno-20-54" name="__codelineno-20-54" href="#__codelineno-20-54"></a><span class="p">}</span>
</span></code></pre></div>
<p>平时我们注册广播调用最多的就是registerReceiver(BroadcastReceiver receiver, IntentFilter filter)</p>
<ul>
<li>将广播权限broadcastPermission设置成null</li>
<li>scheduler调度动态广播的线程设置成null</li>
</ul>
<p>从上面的代码可以看到注册广播有很多方法，可以指定权限、用户ID、Handler、flags等，无论你调的是哪个接口，最终都是调到了registerReceiverInternal方法。</p>
<h3 id="contextimplregisterreceiverinternal">ContextImpl.registerReceiverInternal<a class="headerlink" href="#contextimplregisterreceiverinternal" title="Permanent link">&para;</a></h3>
<div class="language-java highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="n">ContextImpl</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="kd">private</span><span class="w"> </span><span class="n">Intent</span><span class="w"> </span><span class="nf">registerReceiverInternal</span><span class="p">(</span><span class="n">BroadcastReceiver</span><span class="w"> </span><span class="n">receiver</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="w">        </span><span class="n">IntentFilter</span><span class="w"> </span><span class="n">filter</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">broadcastPermission</span><span class="p">,</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="w">        </span><span class="n">Handler</span><span class="w"> </span><span class="n">scheduler</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="w">    </span><span class="n">IIntentReceiver</span><span class="w"> </span><span class="n">rd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">receiver</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mPackageInfo</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">scheduler</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a><span class="w">                </span><span class="n">scheduler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mMainThread</span><span class="p">.</span><span class="na">getHandler</span><span class="p">();</span>
</span><span id="__span-21-11"><a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-21-12"><a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="w">            </span><span class="n">rd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mPackageInfo</span><span class="p">.</span><span class="na">getReceiverDispatcher</span><span class="p">(</span>
</span><span id="__span-21-13"><a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a><span class="w">                </span><span class="n">receiver</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">scheduler</span><span class="p">,</span>
</span><span id="__span-21-14"><a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a><span class="w">                </span><span class="n">mMainThread</span><span class="p">.</span><span class="na">getInstrumentation</span><span class="p">(),</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
</span><span id="__span-21-15"><a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-16"><a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">scheduler</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-17"><a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a><span class="w">                </span><span class="n">scheduler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mMainThread</span><span class="p">.</span><span class="na">getHandler</span><span class="p">();</span>
</span><span id="__span-21-18"><a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-21-19"><a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a><span class="w">            </span><span class="n">rd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LoadedApk</span><span class="p">.</span><span class="na">ReceiverDispatcher</span><span class="p">(</span>
</span><span id="__span-21-20"><a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a><span class="w">                    </span><span class="n">receiver</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">scheduler</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">).</span><span class="na">getIIntentReceiver</span><span class="p">();</span>
</span><span id="__span-21-21"><a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-21-22"><a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-21-23"><a id="__codelineno-21-23" name="__codelineno-21-23" href="#__codelineno-21-23"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-24"><a id="__codelineno-21-24" name="__codelineno-21-24" href="#__codelineno-21-24"></a><span class="w">        </span><span class="n">ActivityThread</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ActivityThread</span><span class="p">.</span><span class="na">currentActivityThread</span><span class="p">();</span>
</span><span id="__span-21-25"><a id="__codelineno-21-25" name="__codelineno-21-25" href="#__codelineno-21-25"></a><span class="w">        </span><span class="n">Instrumentation</span><span class="w"> </span><span class="n">instrumentation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thread</span><span class="p">.</span><span class="na">getInstrumentation</span><span class="p">();</span>
</span><span id="__span-21-26"><a id="__codelineno-21-26" name="__codelineno-21-26" href="#__codelineno-21-26"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">instrumentation</span><span class="p">.</span><span class="na">isInstrumenting</span><span class="p">()</span>
</span><span id="__span-21-27"><a id="__codelineno-21-27" name="__codelineno-21-27" href="#__codelineno-21-27"></a><span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">((</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Context</span><span class="p">.</span><span class="na">RECEIVER_NOT_EXPORTED</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-28"><a id="__codelineno-21-28" name="__codelineno-21-28" href="#__codelineno-21-28"></a><span class="w">            </span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flags</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Context</span><span class="p">.</span><span class="na">RECEIVER_EXPORTED</span><span class="p">;</span>
</span><span id="__span-21-29"><a id="__codelineno-21-29" name="__codelineno-21-29" href="#__codelineno-21-29"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-21-30"><a id="__codelineno-21-30" name="__codelineno-21-30" href="#__codelineno-21-30"></a><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">getService</span><span class="p">().</span><span class="na">registerReceiverWithFeature</span><span class="p">(</span>
</span><span id="__span-21-31"><a id="__codelineno-21-31" name="__codelineno-21-31" href="#__codelineno-21-31"></a><span class="w">                </span><span class="n">mMainThread</span><span class="p">.</span><span class="na">getApplicationThread</span><span class="p">(),</span><span class="w"> </span><span class="n">mBasePackageName</span><span class="p">,</span><span class="w"> </span><span class="n">getAttributionTag</span><span class="p">(),</span>
</span><span id="__span-21-32"><a id="__codelineno-21-32" name="__codelineno-21-32" href="#__codelineno-21-32"></a><span class="w">                </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">toReceiverId</span><span class="p">(</span><span class="n">receiver</span><span class="p">),</span><span class="w"> </span><span class="n">rd</span><span class="p">,</span><span class="w"> </span><span class="n">filter</span><span class="p">,</span><span class="w"> </span><span class="n">broadcastPermission</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span>
</span><span id="__span-21-33"><a id="__codelineno-21-33" name="__codelineno-21-33" href="#__codelineno-21-33"></a><span class="w">                </span><span class="n">flags</span><span class="p">);</span>
</span><span id="__span-21-34"><a id="__codelineno-21-34" name="__codelineno-21-34" href="#__codelineno-21-34"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intent</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-35"><a id="__codelineno-21-35" name="__codelineno-21-35" href="#__codelineno-21-35"></a><span class="w">            </span><span class="n">intent</span><span class="p">.</span><span class="na">setExtrasClassLoader</span><span class="p">(</span><span class="n">getClassLoader</span><span class="p">());</span>
</span><span id="__span-21-36"><a id="__codelineno-21-36" name="__codelineno-21-36" href="#__codelineno-21-36"></a><span class="w">            </span><span class="c1">// TODO: determine at registration time if caller is</span>
</span><span id="__span-21-37"><a id="__codelineno-21-37" name="__codelineno-21-37" href="#__codelineno-21-37"></a><span class="w">            </span><span class="c1">// protecting themselves with signature permission</span>
</span><span id="__span-21-38"><a id="__codelineno-21-38" name="__codelineno-21-38" href="#__codelineno-21-38"></a><span class="w">            </span><span class="n">intent</span><span class="p">.</span><span class="na">prepareToEnterProcess</span><span class="p">(</span><span class="n">ActivityThread</span><span class="p">.</span><span class="na">isProtectedBroadcast</span><span class="p">(</span><span class="n">intent</span><span class="p">),</span>
</span><span id="__span-21-39"><a id="__codelineno-21-39" name="__codelineno-21-39" href="#__codelineno-21-39"></a><span class="w">                    </span><span class="n">getAttributionSource</span><span class="p">());</span>
</span><span id="__span-21-40"><a id="__codelineno-21-40" name="__codelineno-21-40" href="#__codelineno-21-40"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-21-41"><a id="__codelineno-21-41" name="__codelineno-21-41" href="#__codelineno-21-41"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">intent</span><span class="p">;</span>
</span><span id="__span-21-42"><a id="__codelineno-21-42" name="__codelineno-21-42" href="#__codelineno-21-42"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-43"><a id="__codelineno-21-43" name="__codelineno-21-43" href="#__codelineno-21-43"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">rethrowFromSystemServer</span><span class="p">();</span>
</span><span id="__span-21-44"><a id="__codelineno-21-44" name="__codelineno-21-44" href="#__codelineno-21-44"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-21-45"><a id="__codelineno-21-45" name="__codelineno-21-45" href="#__codelineno-21-45"></a><span class="p">}</span>
</span></code></pre></div>
<p><strong>看到这里就迷惑了，为什么receiver为空的时候不直接抛异常？难道还可以为空？带着这个问题，不知道后面在何处能找到答案。</strong></p>
<ul>
<li>传入的广播调度器scheduler是null，那就直接使用主线程ActivityThread的handler(mH)作为调度器；</li>
<li>从mPackageInfo中取得IIntentReceiver，并将该receiver放入LoadedApk mPackageInfo的mReceivers中</li>
<li>调用的是AMS的registerReceiverWithFeature</li>
</ul>
<h3 id="loadedapkgetreceiverdispatcher">LoadedApk.getReceiverDispatcher()<a class="headerlink" href="#loadedapkgetreceiverdispatcher" title="Permanent link">&para;</a></h3>
<div class="language-java highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="n">LoadedApk</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="kd">public</span><span class="w"> </span><span class="n">IIntentReceiver</span><span class="w"> </span><span class="nf">getReceiverDispatcher</span><span class="p">(</span><span class="n">BroadcastReceiver</span><span class="w"> </span><span class="n">r</span><span class="p">,</span>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="w">        </span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">Handler</span><span class="w"> </span><span class="n">handler</span><span class="p">,</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="w">        </span><span class="n">Instrumentation</span><span class="w"> </span><span class="n">instrumentation</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">registered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mReceivers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="w">        </span><span class="n">LoadedApk</span><span class="p">.</span><span class="na">ReceiverDispatcher</span><span class="w"> </span><span class="n">rd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="w">        </span><span class="n">ArrayMap</span><span class="o">&lt;</span><span class="n">BroadcastReceiver</span><span class="p">,</span><span class="w"> </span><span class="n">LoadedApk</span><span class="p">.</span><span class="na">ReceiverDispatcher</span><span class="o">&gt;</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">registered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a><span class="w">            </span><span class="n">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mReceivers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">map</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a><span class="w">                </span><span class="n">rd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">map</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-22-13"><a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-22-14"><a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-15"><a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-16"><a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a><span class="w">            </span><span class="n">rd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReceiverDispatcher</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">handler</span><span class="p">,</span>
</span><span id="__span-22-17"><a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a><span class="w">                    </span><span class="n">instrumentation</span><span class="p">,</span><span class="w"> </span><span class="n">registered</span><span class="p">);</span>
</span><span id="__span-22-18"><a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">registered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-19"><a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">map</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-20"><a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a><span class="w">                    </span><span class="n">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayMap</span><span class="o">&lt;</span><span class="n">BroadcastReceiver</span><span class="p">,</span><span class="w"> </span><span class="n">LoadedApk</span><span class="p">.</span><span class="na">ReceiverDispatcher</span><span class="o">&gt;</span><span class="p">();</span>
</span><span id="__span-22-21"><a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a><span class="w">                    </span><span class="n">mReceivers</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">map</span><span class="p">);</span>
</span><span id="__span-22-22"><a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-22-23"><a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a><span class="w">                </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">rd</span><span class="p">);</span>
</span><span id="__span-22-24"><a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-22-25"><a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-26"><a id="__codelineno-22-26" name="__codelineno-22-26" href="#__codelineno-22-26"></a><span class="w">            </span><span class="n">rd</span><span class="p">.</span><span class="na">validate</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">handler</span><span class="p">);</span>
</span><span id="__span-22-27"><a id="__codelineno-22-27" name="__codelineno-22-27" href="#__codelineno-22-27"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-28"><a id="__codelineno-22-28" name="__codelineno-22-28" href="#__codelineno-22-28"></a><span class="w">        </span><span class="n">rd</span><span class="p">.</span><span class="na">mForgotten</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-22-29"><a id="__codelineno-22-29" name="__codelineno-22-29" href="#__codelineno-22-29"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">rd</span><span class="p">.</span><span class="na">getIIntentReceiver</span><span class="p">();</span>
</span><span id="__span-22-30"><a id="__codelineno-22-30" name="__codelineno-22-30" href="#__codelineno-22-30"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-22-31"><a id="__codelineno-22-31" name="__codelineno-22-31" href="#__codelineno-22-31"></a><span class="p">}</span>
</span><span id="__span-22-32"><a id="__codelineno-22-32" name="__codelineno-22-32" href="#__codelineno-22-32"></a>
</span><span id="__span-22-33"><a id="__codelineno-22-33" name="__codelineno-22-33" href="#__codelineno-22-33"></a><span class="n">ReceiverDispatcher</span><span class="p">(</span><span class="n">BroadcastReceiver</span><span class="w"> </span><span class="n">receiver</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">,</span>
</span><span id="__span-22-34"><a id="__codelineno-22-34" name="__codelineno-22-34" href="#__codelineno-22-34"></a><span class="w">        </span><span class="n">Handler</span><span class="w"> </span><span class="n">activityThread</span><span class="p">,</span><span class="w"> </span><span class="n">Instrumentation</span><span class="w"> </span><span class="n">instrumentation</span><span class="p">,</span>
</span><span id="__span-22-35"><a id="__codelineno-22-35" name="__codelineno-22-35" href="#__codelineno-22-35"></a><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">registered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-36"><a id="__codelineno-22-36" name="__codelineno-22-36" href="#__codelineno-22-36"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">activityThread</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-37"><a id="__codelineno-22-37" name="__codelineno-22-37" href="#__codelineno-22-37"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">NullPointerException</span><span class="p">(</span><span class="s">&quot;Handler must not be null&quot;</span><span class="p">);</span>
</span><span id="__span-22-38"><a id="__codelineno-22-38" name="__codelineno-22-38" href="#__codelineno-22-38"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-22-39"><a id="__codelineno-22-39" name="__codelineno-22-39" href="#__codelineno-22-39"></a>
</span><span id="__span-22-40"><a id="__codelineno-22-40" name="__codelineno-22-40" href="#__codelineno-22-40"></a><span class="w">    </span><span class="n">mIIntentReceiver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InnerReceiver</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="o">!</span><span class="n">registered</span><span class="p">);</span>
</span><span id="__span-22-41"><a id="__codelineno-22-41" name="__codelineno-22-41" href="#__codelineno-22-41"></a><span class="w">    </span><span class="n">mReceiver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">receiver</span><span class="p">;</span>
</span><span id="__span-22-42"><a id="__codelineno-22-42" name="__codelineno-22-42" href="#__codelineno-22-42"></a><span class="w">    </span><span class="n">mContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">;</span>
</span><span id="__span-22-43"><a id="__codelineno-22-43" name="__codelineno-22-43" href="#__codelineno-22-43"></a><span class="w">    </span><span class="n">mActivityThread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activityThread</span><span class="p">;</span>
</span><span id="__span-22-44"><a id="__codelineno-22-44" name="__codelineno-22-44" href="#__codelineno-22-44"></a><span class="w">    </span><span class="n">mInstrumentation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instrumentation</span><span class="p">;</span>
</span><span id="__span-22-45"><a id="__codelineno-22-45" name="__codelineno-22-45" href="#__codelineno-22-45"></a><span class="w">    </span><span class="n">mRegistered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">registered</span><span class="p">;</span>
</span><span id="__span-22-46"><a id="__codelineno-22-46" name="__codelineno-22-46" href="#__codelineno-22-46"></a><span class="w">    </span><span class="n">mLocation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IntentReceiverLeaked</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
</span><span id="__span-22-47"><a id="__codelineno-22-47" name="__codelineno-22-47" href="#__codelineno-22-47"></a><span class="w">    </span><span class="n">mLocation</span><span class="p">.</span><span class="na">fillInStackTrace</span><span class="p">();</span>
</span><span id="__span-22-48"><a id="__codelineno-22-48" name="__codelineno-22-48" href="#__codelineno-22-48"></a><span class="p">}</span>
</span><span id="__span-22-49"><a id="__codelineno-22-49" name="__codelineno-22-49" href="#__codelineno-22-49"></a>
</span><span id="__span-22-50"><a id="__codelineno-22-50" name="__codelineno-22-50" href="#__codelineno-22-50"></a><span class="n">IIntentReceiver</span><span class="w"> </span><span class="nf">getIIntentReceiver</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-51"><a id="__codelineno-22-51" name="__codelineno-22-51" href="#__codelineno-22-51"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">mIIntentReceiver</span><span class="p">;</span>
</span><span id="__span-22-52"><a id="__codelineno-22-52" name="__codelineno-22-52" href="#__codelineno-22-52"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>从mReceivers取出对于该context的ReceiverDispatcher(map)</li>
<li>从map取出对于该BroadcastReceiver的ReceiverDispatcher</li>
<li>如果没有BroadcastReceiver对应的ReceiverDispatcher，根据BroadcastReceiver r新建一个ReceiverDispatcher，并存到mReceivers中。</li>
</ul>
<p>一个BroadcastReceiver对应一个ReceiverDispatcher</p>
<p>退出进程的时候会用到mReceivers</p>
<h3 id="amsregisterreceiverwithfeature">AMS.registerReceiverWithFeature<a class="headerlink" href="#amsregisterreceiverwithfeature" title="Permanent link">&para;</a></h3>
<div class="language-java highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="kd">public</span><span class="w"> </span><span class="n">Intent</span><span class="w"> </span><span class="nf">registerReceiverWithFeature</span><span class="p">(</span><span class="n">IApplicationThread</span><span class="w"> </span><span class="n">caller</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">,</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">callerFeatureId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">receiverId</span><span class="p">,</span><span class="w"> </span><span class="n">IIntentReceiver</span><span class="w"> </span><span class="n">receiver</span><span class="p">,</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="w">        </span><span class="n">IntentFilter</span><span class="w"> </span><span class="n">filter</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">permission</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="w">    </span><span class="c1">// Allow Sandbox process to register only unexported receivers.</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Context</span><span class="p">.</span><span class="na">RECEIVER_NOT_EXPORTED</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="w">        </span><span class="n">enforceNotIsolatedCaller</span><span class="p">(</span><span class="s">&quot;registerReceiver&quot;</span><span class="p">);</span>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mSdkSandboxSettings</span><span class="p">.</span><span class="na">isBroadcastReceiverRestrictionsEnforced</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a><span class="w">        </span><span class="n">enforceNotIsolatedOrSdkSandboxCaller</span><span class="p">(</span><span class="s">&quot;registerReceiver&quot;</span><span class="p">);</span>
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="w">    </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Intent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stickyIntents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a><span class="w">    </span><span class="n">ProcessRecord</span><span class="w"> </span><span class="n">callerApp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">visibleToInstantApps</span>
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Context</span><span class="p">.</span><span class="na">RECEIVER_VISIBLE_TO_INSTANT_APPS</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-23-14"><a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a>
</span><span id="__span-23-15"><a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">callingUid</span><span class="p">;</span>
</span><span id="__span-23-16"><a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">callingPid</span><span class="p">;</span>
</span><span id="__span-23-17"><a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">instantApp</span><span class="p">;</span>
</span><span id="__span-23-18"><a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a><span class="w">    </span><span class="kd">synchronized</span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-19"><a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">caller</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-20"><a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a><span class="w">            </span><span class="n">callerApp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getRecordForAppLOSP</span><span class="p">(</span><span class="n">caller</span><span class="p">);</span>
</span><span id="__span-23-21"><a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">callerApp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-22"><a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecurityException</span><span class="p">(</span>
</span><span id="__span-23-23"><a id="__codelineno-23-23" name="__codelineno-23-23" href="#__codelineno-23-23"></a><span class="w">                        </span><span class="s">&quot;Unable to find app for caller &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">caller</span>
</span><span id="__span-23-24"><a id="__codelineno-23-24" name="__codelineno-23-24" href="#__codelineno-23-24"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; (pid=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Binder</span><span class="p">.</span><span class="na">getCallingPid</span><span class="p">()</span>
</span><span id="__span-23-25"><a id="__codelineno-23-25" name="__codelineno-23-25" href="#__codelineno-23-25"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;) when registering receiver &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">receiver</span><span class="p">);</span>
</span><span id="__span-23-26"><a id="__codelineno-23-26" name="__codelineno-23-26" href="#__codelineno-23-26"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-23-27"><a id="__codelineno-23-27" name="__codelineno-23-27" href="#__codelineno-23-27"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">callerApp</span><span class="p">.</span><span class="na">info</span><span class="p">.</span><span class="na">uid</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">SYSTEM_UID</span>
</span><span id="__span-23-28"><a id="__codelineno-23-28" name="__codelineno-23-28" href="#__codelineno-23-28"></a><span class="w">                    </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">callerApp</span><span class="p">.</span><span class="na">getPkgList</span><span class="p">().</span><span class="na">containsKey</span><span class="p">(</span><span class="n">callerPackage</span><span class="p">)</span>
</span><span id="__span-23-29"><a id="__codelineno-23-29" name="__codelineno-23-29" href="#__codelineno-23-29"></a><span class="w">                    </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="s">&quot;android&quot;</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">callerPackage</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-30"><a id="__codelineno-23-30" name="__codelineno-23-30" href="#__codelineno-23-30"></a><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecurityException</span><span class="p">(</span><span class="s">&quot;Given caller package &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callerPackage</span>
</span><span id="__span-23-31"><a id="__codelineno-23-31" name="__codelineno-23-31" href="#__codelineno-23-31"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; is not running in process &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callerApp</span><span class="p">);</span>
</span><span id="__span-23-32"><a id="__codelineno-23-32" name="__codelineno-23-32" href="#__codelineno-23-32"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-23-33"><a id="__codelineno-23-33" name="__codelineno-23-33" href="#__codelineno-23-33"></a><span class="w">            </span><span class="n">callingUid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">callerApp</span><span class="p">.</span><span class="na">info</span><span class="p">.</span><span class="na">uid</span><span class="p">;</span>
</span><span id="__span-23-34"><a id="__codelineno-23-34" name="__codelineno-23-34" href="#__codelineno-23-34"></a><span class="w">            </span><span class="n">callingPid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">callerApp</span><span class="p">.</span><span class="na">getPid</span><span class="p">();</span>
</span><span id="__span-23-35"><a id="__codelineno-23-35" name="__codelineno-23-35" href="#__codelineno-23-35"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-36"><a id="__codelineno-23-36" name="__codelineno-23-36" href="#__codelineno-23-36"></a><span class="w">            </span><span class="n">callerPackage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-23-37"><a id="__codelineno-23-37" name="__codelineno-23-37" href="#__codelineno-23-37"></a><span class="w">            </span><span class="n">callingUid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Binder</span><span class="p">.</span><span class="na">getCallingUid</span><span class="p">();</span>
</span><span id="__span-23-38"><a id="__codelineno-23-38" name="__codelineno-23-38" href="#__codelineno-23-38"></a><span class="w">            </span><span class="n">callingPid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Binder</span><span class="p">.</span><span class="na">getCallingPid</span><span class="p">();</span>
</span><span id="__span-23-39"><a id="__codelineno-23-39" name="__codelineno-23-39" href="#__codelineno-23-39"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-23-40"><a id="__codelineno-23-40" name="__codelineno-23-40" href="#__codelineno-23-40"></a>
</span><span id="__span-23-41"><a id="__codelineno-23-41" name="__codelineno-23-41" href="#__codelineno-23-41"></a><span class="w">        </span><span class="n">instantApp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isInstantApp</span><span class="p">(</span><span class="n">callerApp</span><span class="p">,</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">);</span>
</span><span id="__span-23-42"><a id="__codelineno-23-42" name="__codelineno-23-42" href="#__codelineno-23-42"></a><span class="w">        </span><span class="n">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mUserController</span><span class="p">.</span><span class="na">handleIncomingUser</span><span class="p">(</span><span class="n">callingPid</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-23-43"><a id="__codelineno-23-43" name="__codelineno-23-43" href="#__codelineno-23-43"></a><span class="w">                </span><span class="n">ALLOW_FULL_ONLY</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;registerReceiver&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">);</span>
</span><span id="__span-23-44"><a id="__codelineno-23-44" name="__codelineno-23-44" href="#__codelineno-23-44"></a>
</span><span id="__span-23-45"><a id="__codelineno-23-45" name="__codelineno-23-45" href="#__codelineno-23-45"></a><span class="w">        </span><span class="n">Iterator</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">actions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="na">actionsIterator</span><span class="p">();</span>
</span><span id="__span-23-46"><a id="__codelineno-23-46" name="__codelineno-23-46" href="#__codelineno-23-46"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">actions</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-47"><a id="__codelineno-23-47" name="__codelineno-23-47" href="#__codelineno-23-47"></a><span class="w">            </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">noAction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-23-48"><a id="__codelineno-23-48" name="__codelineno-23-48" href="#__codelineno-23-48"></a><span class="w">            </span><span class="n">noAction</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
</span><span id="__span-23-49"><a id="__codelineno-23-49" name="__codelineno-23-49" href="#__codelineno-23-49"></a><span class="w">            </span><span class="n">actions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">noAction</span><span class="p">.</span><span class="na">iterator</span><span class="p">();</span>
</span><span id="__span-23-50"><a id="__codelineno-23-50" name="__codelineno-23-50" href="#__codelineno-23-50"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-23-51"><a id="__codelineno-23-51" name="__codelineno-23-51" href="#__codelineno-23-51"></a><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">onlyProtectedBroadcasts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-23-52"><a id="__codelineno-23-52" name="__codelineno-23-52" href="#__codelineno-23-52"></a>
</span><span id="__span-23-53"><a id="__codelineno-23-53" name="__codelineno-23-53" href="#__codelineno-23-53"></a><span class="w">        </span><span class="c1">// Collect stickies of users and check if broadcast is only registered for protected</span>
</span><span id="__span-23-54"><a id="__codelineno-23-54" name="__codelineno-23-54" href="#__codelineno-23-54"></a><span class="w">        </span><span class="c1">// broadcasts</span>
</span><span id="__span-23-55"><a id="__codelineno-23-55" name="__codelineno-23-55" href="#__codelineno-23-55"></a><span class="w">        </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">userIds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">USER_ALL</span><span class="p">,</span><span class="w"> </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(</span><span class="n">callingUid</span><span class="p">)</span><span class="w"> </span><span class="p">};</span>
</span><span id="__span-23-56"><a id="__codelineno-23-56" name="__codelineno-23-56" href="#__codelineno-23-56"></a><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">actions</span><span class="p">.</span><span class="na">hasNext</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-57"><a id="__codelineno-23-57" name="__codelineno-23-57" href="#__codelineno-23-57"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">actions</span><span class="p">.</span><span class="na">next</span><span class="p">();</span>
</span><span id="__span-23-58"><a id="__codelineno-23-58" name="__codelineno-23-58" href="#__codelineno-23-58"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">userIds</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-59"><a id="__codelineno-23-59" name="__codelineno-23-59" href="#__codelineno-23-59"></a><span class="w">                </span><span class="n">ArrayMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Intent</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">stickies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mStickyBroadcasts</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
</span><span id="__span-23-60"><a id="__codelineno-23-60" name="__codelineno-23-60" href="#__codelineno-23-60"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stickies</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-61"><a id="__codelineno-23-61" name="__codelineno-23-61" href="#__codelineno-23-61"></a><span class="w">                    </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Intent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">intents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stickies</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">action</span><span class="p">);</span>
</span><span id="__span-23-62"><a id="__codelineno-23-62" name="__codelineno-23-62" href="#__codelineno-23-62"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intents</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-63"><a id="__codelineno-23-63" name="__codelineno-23-63" href="#__codelineno-23-63"></a><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stickyIntents</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-64"><a id="__codelineno-23-64" name="__codelineno-23-64" href="#__codelineno-23-64"></a><span class="w">                            </span><span class="n">stickyIntents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Intent</span><span class="o">&gt;</span><span class="p">();</span>
</span><span id="__span-23-65"><a id="__codelineno-23-65" name="__codelineno-23-65" href="#__codelineno-23-65"></a><span class="w">                        </span><span class="p">}</span>
</span><span id="__span-23-66"><a id="__codelineno-23-66" name="__codelineno-23-66" href="#__codelineno-23-66"></a><span class="w">                        </span><span class="n">stickyIntents</span><span class="p">.</span><span class="na">addAll</span><span class="p">(</span><span class="n">intents</span><span class="p">);</span>
</span><span id="__span-23-67"><a id="__codelineno-23-67" name="__codelineno-23-67" href="#__codelineno-23-67"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-23-68"><a id="__codelineno-23-68" name="__codelineno-23-68" href="#__codelineno-23-68"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-23-69"><a id="__codelineno-23-69" name="__codelineno-23-69" href="#__codelineno-23-69"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-23-70"><a id="__codelineno-23-70" name="__codelineno-23-70" href="#__codelineno-23-70"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">onlyProtectedBroadcasts</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-71"><a id="__codelineno-23-71" name="__codelineno-23-71" href="#__codelineno-23-71"></a><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-72"><a id="__codelineno-23-72" name="__codelineno-23-72" href="#__codelineno-23-72"></a><span class="w">                    </span><span class="n">onlyProtectedBroadcasts</span><span class="w"> </span><span class="o">&amp;=</span>
</span><span id="__span-23-73"><a id="__codelineno-23-73" name="__codelineno-23-73" href="#__codelineno-23-73"></a><span class="w">                            </span><span class="n">AppGlobals</span><span class="p">.</span><span class="na">getPackageManager</span><span class="p">().</span><span class="na">isProtectedBroadcast</span><span class="p">(</span><span class="n">action</span><span class="p">);</span>
</span><span id="__span-23-74"><a id="__codelineno-23-74" name="__codelineno-23-74" href="#__codelineno-23-74"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-75"><a id="__codelineno-23-75" name="__codelineno-23-75" href="#__codelineno-23-75"></a><span class="w">                    </span><span class="n">onlyProtectedBroadcasts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-23-76"><a id="__codelineno-23-76" name="__codelineno-23-76" href="#__codelineno-23-76"></a><span class="w">                    </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Remote exception&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
</span><span id="__span-23-77"><a id="__codelineno-23-77" name="__codelineno-23-77" href="#__codelineno-23-77"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-23-78"><a id="__codelineno-23-78" name="__codelineno-23-78" href="#__codelineno-23-78"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-23-79"><a id="__codelineno-23-79" name="__codelineno-23-79" href="#__codelineno-23-79"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-23-80"><a id="__codelineno-23-80" name="__codelineno-23-80" href="#__codelineno-23-80"></a>
</span><span id="__span-23-81"><a id="__codelineno-23-81" name="__codelineno-23-81" href="#__codelineno-23-81"></a><span class="w">        </span><span class="c1">// If the change is enabled, but neither exported or not exported is set, we need to log</span>
</span><span id="__span-23-82"><a id="__codelineno-23-82" name="__codelineno-23-82" href="#__codelineno-23-82"></a><span class="w">        </span><span class="c1">// an error so the consumer can know to explicitly set the value for their flag.</span>
</span><span id="__span-23-83"><a id="__codelineno-23-83" name="__codelineno-23-83" href="#__codelineno-23-83"></a><span class="w">        </span><span class="c1">// If the caller is registering for a sticky broadcast with a null receiver, we won&#39;t</span>
</span><span id="__span-23-84"><a id="__codelineno-23-84" name="__codelineno-23-84" href="#__codelineno-23-84"></a><span class="w">        </span><span class="c1">// require a flag</span>
</span><span id="__span-23-85"><a id="__codelineno-23-85" name="__codelineno-23-85" href="#__codelineno-23-85"></a><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">explicitExportStateDefined</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-23-86"><a id="__codelineno-23-86" name="__codelineno-23-86" href="#__codelineno-23-86"></a><span class="w">                </span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">RECEIVER_EXPORTED</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Context</span><span class="p">.</span><span class="na">RECEIVER_NOT_EXPORTED</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-23-87"><a id="__codelineno-23-87" name="__codelineno-23-87" href="#__codelineno-23-87"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(((</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Context</span><span class="p">.</span><span class="na">RECEIVER_EXPORTED</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-23-88"><a id="__codelineno-23-88" name="__codelineno-23-88" href="#__codelineno-23-88"></a><span class="w">                </span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Context</span><span class="p">.</span><span class="na">RECEIVER_NOT_EXPORTED</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-89"><a id="__codelineno-23-89" name="__codelineno-23-89" href="#__codelineno-23-89"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span>
</span><span id="__span-23-90"><a id="__codelineno-23-90" name="__codelineno-23-90" href="#__codelineno-23-90"></a><span class="w">                    </span><span class="s">&quot;Receiver can&#39;t specify both RECEIVER_EXPORTED and RECEIVER_NOT_EXPORTED&quot;</span>
</span><span id="__span-23-91"><a id="__codelineno-23-91" name="__codelineno-23-91" href="#__codelineno-23-91"></a><span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;flag&quot;</span><span class="p">);</span>
</span><span id="__span-23-92"><a id="__codelineno-23-92" name="__codelineno-23-92" href="#__codelineno-23-92"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-23-93"><a id="__codelineno-23-93" name="__codelineno-23-93" href="#__codelineno-23-93"></a>
</span><span id="__span-23-94"><a id="__codelineno-23-94" name="__codelineno-23-94" href="#__codelineno-23-94"></a><span class="w">        </span><span class="c1">// Don&#39;t enforce the flag check if we&#39;re EITHER registering for only protected</span>
</span><span id="__span-23-95"><a id="__codelineno-23-95" name="__codelineno-23-95" href="#__codelineno-23-95"></a><span class="w">        </span><span class="c1">// broadcasts, or the receiver is null (a sticky broadcast). Sticky broadcasts should</span>
</span><span id="__span-23-96"><a id="__codelineno-23-96" name="__codelineno-23-96" href="#__codelineno-23-96"></a><span class="w">        </span><span class="c1">// not be used generally, so we will be marking them as exported by default</span>
</span><span id="__span-23-97"><a id="__codelineno-23-97" name="__codelineno-23-97" href="#__codelineno-23-97"></a><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">requireExplicitFlagForDynamicReceivers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CompatChanges</span><span class="p">.</span><span class="na">isChangeEnabled</span><span class="p">(</span>
</span><span id="__span-23-98"><a id="__codelineno-23-98" name="__codelineno-23-98" href="#__codelineno-23-98"></a><span class="w">                </span><span class="n">DYNAMIC_RECEIVER_EXPLICIT_EXPORT_REQUIRED</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">);</span>
</span><span id="__span-23-99"><a id="__codelineno-23-99" name="__codelineno-23-99" href="#__codelineno-23-99"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">onlyProtectedBroadcasts</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-100"><a id="__codelineno-23-100" name="__codelineno-23-100" href="#__codelineno-23-100"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">receiver</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">explicitExportStateDefined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-101"><a id="__codelineno-23-101" name="__codelineno-23-101" href="#__codelineno-23-101"></a><span class="w">                </span><span class="c1">// sticky broadcast, no flag specified (flag isn&#39;t required)</span>
</span><span id="__span-23-102"><a id="__codelineno-23-102" name="__codelineno-23-102" href="#__codelineno-23-102"></a><span class="w">                </span><span class="n">flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">Context</span><span class="p">.</span><span class="na">RECEIVER_EXPORTED</span><span class="p">;</span>
</span><span id="__span-23-103"><a id="__codelineno-23-103" name="__codelineno-23-103" href="#__codelineno-23-103"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">requireExplicitFlagForDynamicReceivers</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">explicitExportStateDefined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-104"><a id="__codelineno-23-104" name="__codelineno-23-104" href="#__codelineno-23-104"></a><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecurityException</span><span class="p">(</span>
</span><span id="__span-23-105"><a id="__codelineno-23-105" name="__codelineno-23-105" href="#__codelineno-23-105"></a><span class="w">                        </span><span class="n">callerPackage</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;: One of RECEIVER_EXPORTED or &quot;</span>
</span><span id="__span-23-106"><a id="__codelineno-23-106" name="__codelineno-23-106" href="#__codelineno-23-106"></a><span class="w">                                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;RECEIVER_NOT_EXPORTED should be specified when a receiver &quot;</span>
</span><span id="__span-23-107"><a id="__codelineno-23-107" name="__codelineno-23-107" href="#__codelineno-23-107"></a><span class="w">                                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;isn&#39;t being registered exclusively for system broadcasts&quot;</span><span class="p">);</span>
</span><span id="__span-23-108"><a id="__codelineno-23-108" name="__codelineno-23-108" href="#__codelineno-23-108"></a><span class="w">                </span><span class="c1">// Assume default behavior-- flag check is not enforced</span>
</span><span id="__span-23-109"><a id="__codelineno-23-109" name="__codelineno-23-109" href="#__codelineno-23-109"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">requireExplicitFlagForDynamicReceivers</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-23-110"><a id="__codelineno-23-110" name="__codelineno-23-110" href="#__codelineno-23-110"></a><span class="w">                    </span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Context</span><span class="p">.</span><span class="na">RECEIVER_NOT_EXPORTED</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-111"><a id="__codelineno-23-111" name="__codelineno-23-111" href="#__codelineno-23-111"></a><span class="w">                </span><span class="c1">// Change is not enabled, assume exported unless otherwise specified.</span>
</span><span id="__span-23-112"><a id="__codelineno-23-112" name="__codelineno-23-112" href="#__codelineno-23-112"></a><span class="w">                </span><span class="n">flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">Context</span><span class="p">.</span><span class="na">RECEIVER_EXPORTED</span><span class="p">;</span>
</span><span id="__span-23-113"><a id="__codelineno-23-113" name="__codelineno-23-113" href="#__codelineno-23-113"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-23-114"><a id="__codelineno-23-114" name="__codelineno-23-114" href="#__codelineno-23-114"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Context</span><span class="p">.</span><span class="na">RECEIVER_NOT_EXPORTED</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-115"><a id="__codelineno-23-115" name="__codelineno-23-115" href="#__codelineno-23-115"></a><span class="w">            </span><span class="n">flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">Context</span><span class="p">.</span><span class="na">RECEIVER_EXPORTED</span><span class="p">;</span>
</span><span id="__span-23-116"><a id="__codelineno-23-116" name="__codelineno-23-116" href="#__codelineno-23-116"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-23-117"><a id="__codelineno-23-117" name="__codelineno-23-117" href="#__codelineno-23-117"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-23-118"><a id="__codelineno-23-118" name="__codelineno-23-118" href="#__codelineno-23-118"></a>
</span><span id="__span-23-119"><a id="__codelineno-23-119" name="__codelineno-23-119" href="#__codelineno-23-119"></a><span class="w">    </span><span class="c1">// Dynamic receivers are exported by default for versions prior to T</span>
</span><span id="__span-23-120"><a id="__codelineno-23-120" name="__codelineno-23-120" href="#__codelineno-23-120"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">exported</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Context</span><span class="p">.</span><span class="na">RECEIVER_EXPORTED</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-23-121"><a id="__codelineno-23-121" name="__codelineno-23-121" href="#__codelineno-23-121"></a>
</span><span id="__span-23-122"><a id="__codelineno-23-122" name="__codelineno-23-122" href="#__codelineno-23-122"></a><span class="w">    </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Intent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">allSticky</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-23-123"><a id="__codelineno-23-123" name="__codelineno-23-123" href="#__codelineno-23-123"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stickyIntents</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-124"><a id="__codelineno-23-124" name="__codelineno-23-124" href="#__codelineno-23-124"></a><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">ContentResolver</span><span class="w"> </span><span class="n">resolver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mContext</span><span class="p">.</span><span class="na">getContentResolver</span><span class="p">();</span>
</span><span id="__span-23-125"><a id="__codelineno-23-125" name="__codelineno-23-125" href="#__codelineno-23-125"></a><span class="w">        </span><span class="c1">// Look for any matching sticky broadcasts...</span>
</span><span id="__span-23-126"><a id="__codelineno-23-126" name="__codelineno-23-126" href="#__codelineno-23-126"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stickyIntents</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-127"><a id="__codelineno-23-127" name="__codelineno-23-127" href="#__codelineno-23-127"></a><span class="w">            </span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stickyIntents</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-23-128"><a id="__codelineno-23-128" name="__codelineno-23-128" href="#__codelineno-23-128"></a><span class="w">            </span><span class="c1">// Don&#39;t provided intents that aren&#39;t available to instant apps.</span>
</span><span id="__span-23-129"><a id="__codelineno-23-129" name="__codelineno-23-129" href="#__codelineno-23-129"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">instantApp</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-23-130"><a id="__codelineno-23-130" name="__codelineno-23-130" href="#__codelineno-23-130"></a><span class="w">                    </span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getFlags</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">FLAG_RECEIVER_VISIBLE_TO_INSTANT_APPS</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-131"><a id="__codelineno-23-131" name="__codelineno-23-131" href="#__codelineno-23-131"></a><span class="w">                </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-23-132"><a id="__codelineno-23-132" name="__codelineno-23-132" href="#__codelineno-23-132"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-23-133"><a id="__codelineno-23-133" name="__codelineno-23-133" href="#__codelineno-23-133"></a><span class="w">            </span><span class="c1">// If intent has scheme &quot;content&quot;, it will need to access</span>
</span><span id="__span-23-134"><a id="__codelineno-23-134" name="__codelineno-23-134" href="#__codelineno-23-134"></a><span class="w">            </span><span class="c1">// provider that needs to lock mProviderMap in ActivityThread</span>
</span><span id="__span-23-135"><a id="__codelineno-23-135" name="__codelineno-23-135" href="#__codelineno-23-135"></a><span class="w">            </span><span class="c1">// and also it may need to wait application response, so we</span>
</span><span id="__span-23-136"><a id="__codelineno-23-136" name="__codelineno-23-136" href="#__codelineno-23-136"></a><span class="w">            </span><span class="c1">// cannot lock ActivityManagerService here.</span>
</span><span id="__span-23-137"><a id="__codelineno-23-137" name="__codelineno-23-137" href="#__codelineno-23-137"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">filter</span><span class="p">.</span><span class="na">match</span><span class="p">(</span><span class="n">resolver</span><span class="p">,</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">TAG</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-138"><a id="__codelineno-23-138" name="__codelineno-23-138" href="#__codelineno-23-138"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">allSticky</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-139"><a id="__codelineno-23-139" name="__codelineno-23-139" href="#__codelineno-23-139"></a><span class="w">                    </span><span class="n">allSticky</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Intent</span><span class="o">&gt;</span><span class="p">();</span>
</span><span id="__span-23-140"><a id="__codelineno-23-140" name="__codelineno-23-140" href="#__codelineno-23-140"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-23-141"><a id="__codelineno-23-141" name="__codelineno-23-141" href="#__codelineno-23-141"></a><span class="w">                </span><span class="n">allSticky</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">intent</span><span class="p">);</span>
</span><span id="__span-23-142"><a id="__codelineno-23-142" name="__codelineno-23-142" href="#__codelineno-23-142"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-23-143"><a id="__codelineno-23-143" name="__codelineno-23-143" href="#__codelineno-23-143"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-23-144"><a id="__codelineno-23-144" name="__codelineno-23-144" href="#__codelineno-23-144"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-23-145"><a id="__codelineno-23-145" name="__codelineno-23-145" href="#__codelineno-23-145"></a>
</span><span id="__span-23-146"><a id="__codelineno-23-146" name="__codelineno-23-146" href="#__codelineno-23-146"></a><span class="w">    </span><span class="c1">// The first sticky in the list is returned directly back to the client.</span>
</span><span id="__span-23-147"><a id="__codelineno-23-147" name="__codelineno-23-147" href="#__codelineno-23-147"></a><span class="w">    </span><span class="n">Intent</span><span class="w"> </span><span class="n">sticky</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allSticky</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">allSticky</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-23-148"><a id="__codelineno-23-148" name="__codelineno-23-148" href="#__codelineno-23-148"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Register receiver &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">filter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sticky</span><span class="p">);</span>
</span><span id="__span-23-149"><a id="__codelineno-23-149" name="__codelineno-23-149" href="#__codelineno-23-149"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">receiver</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-150"><a id="__codelineno-23-150" name="__codelineno-23-150" href="#__codelineno-23-150"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">sticky</span><span class="p">;</span>
</span><span id="__span-23-151"><a id="__codelineno-23-151" name="__codelineno-23-151" href="#__codelineno-23-151"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-23-152"><a id="__codelineno-23-152" name="__codelineno-23-152" href="#__codelineno-23-152"></a>
</span><span id="__span-23-153"><a id="__codelineno-23-153" name="__codelineno-23-153" href="#__codelineno-23-153"></a><span class="w">    </span><span class="c1">// SafetyNet logging for b/177931370. If any process other than system_server tries to</span>
</span><span id="__span-23-154"><a id="__codelineno-23-154" name="__codelineno-23-154" href="#__codelineno-23-154"></a><span class="w">    </span><span class="c1">// listen to this broadcast action, then log it.</span>
</span><span id="__span-23-155"><a id="__codelineno-23-155" name="__codelineno-23-155" href="#__codelineno-23-155"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">callingPid</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">Process</span><span class="p">.</span><span class="na">myPid</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-156"><a id="__codelineno-23-156" name="__codelineno-23-156" href="#__codelineno-23-156"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">filter</span><span class="p">.</span><span class="na">hasAction</span><span class="p">(</span><span class="s">&quot;com.android.server.net.action.SNOOZE_WARNING&quot;</span><span class="p">)</span>
</span><span id="__span-23-157"><a id="__codelineno-23-157" name="__codelineno-23-157" href="#__codelineno-23-157"></a><span class="w">                </span><span class="o">||</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="na">hasAction</span><span class="p">(</span><span class="s">&quot;com.android.server.net.action.SNOOZE_RAPID&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-158"><a id="__codelineno-23-158" name="__codelineno-23-158" href="#__codelineno-23-158"></a><span class="w">            </span><span class="n">EventLog</span><span class="p">.</span><span class="na">writeEvent</span><span class="p">(</span><span class="mh">0x534e4554</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;177931370&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">);</span>
</span><span id="__span-23-159"><a id="__codelineno-23-159" name="__codelineno-23-159" href="#__codelineno-23-159"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-23-160"><a id="__codelineno-23-160" name="__codelineno-23-160" href="#__codelineno-23-160"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-23-161"><a id="__codelineno-23-161" name="__codelineno-23-161" href="#__codelineno-23-161"></a>
</span><span id="__span-23-162"><a id="__codelineno-23-162" name="__codelineno-23-162" href="#__codelineno-23-162"></a><span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-163"><a id="__codelineno-23-163" name="__codelineno-23-163" href="#__codelineno-23-163"></a><span class="w">        </span><span class="n">IApplicationThread</span><span class="w"> </span><span class="n">thread</span><span class="p">;</span>
</span><span id="__span-23-164"><a id="__codelineno-23-164" name="__codelineno-23-164" href="#__codelineno-23-164"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">callerApp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">((</span><span class="n">thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">callerApp</span><span class="p">.</span><span class="na">getThread</span><span class="p">())</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span>
</span><span id="__span-23-165"><a id="__codelineno-23-165" name="__codelineno-23-165" href="#__codelineno-23-165"></a><span class="w">                </span><span class="o">||</span><span class="w"> </span><span class="n">thread</span><span class="p">.</span><span class="na">asBinder</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">caller</span><span class="p">.</span><span class="na">asBinder</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-166"><a id="__codelineno-23-166" name="__codelineno-23-166" href="#__codelineno-23-166"></a><span class="w">            </span><span class="c1">// Original caller already died</span>
</span><span id="__span-23-167"><a id="__codelineno-23-167" name="__codelineno-23-167" href="#__codelineno-23-167"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-23-168"><a id="__codelineno-23-168" name="__codelineno-23-168" href="#__codelineno-23-168"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-23-169"><a id="__codelineno-23-169" name="__codelineno-23-169" href="#__codelineno-23-169"></a><span class="w">        </span><span class="n">ReceiverList</span><span class="w"> </span><span class="n">rl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mRegisteredReceivers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">receiver</span><span class="p">.</span><span class="na">asBinder</span><span class="p">());</span>
</span><span id="__span-23-170"><a id="__codelineno-23-170" name="__codelineno-23-170" href="#__codelineno-23-170"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rl</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-171"><a id="__codelineno-23-171" name="__codelineno-23-171" href="#__codelineno-23-171"></a><span class="w">            </span><span class="n">rl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReceiverList</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">callerApp</span><span class="p">,</span><span class="w"> </span><span class="n">callingPid</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">,</span>
</span><span id="__span-23-172"><a id="__codelineno-23-172" name="__codelineno-23-172" href="#__codelineno-23-172"></a><span class="w">                    </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">receiver</span><span class="p">);</span>
</span><span id="__span-23-173"><a id="__codelineno-23-173" name="__codelineno-23-173" href="#__codelineno-23-173"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rl</span><span class="p">.</span><span class="na">app</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-174"><a id="__codelineno-23-174" name="__codelineno-23-174" href="#__codelineno-23-174"></a><span class="w">                </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">totalReceiversForApp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rl</span><span class="p">.</span><span class="na">app</span><span class="p">.</span><span class="na">mReceivers</span><span class="p">.</span><span class="na">numberOfReceivers</span><span class="p">();</span>
</span><span id="__span-23-175"><a id="__codelineno-23-175" name="__codelineno-23-175" href="#__codelineno-23-175"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">totalReceiversForApp</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">MAX_RECEIVERS_ALLOWED_PER_APP</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-176"><a id="__codelineno-23-176" name="__codelineno-23-176" href="#__codelineno-23-176"></a><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;Too many receivers, total of &quot;</span>
</span><span id="__span-23-177"><a id="__codelineno-23-177" name="__codelineno-23-177" href="#__codelineno-23-177"></a><span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">totalReceiversForApp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, registered for pid: &quot;</span>
</span><span id="__span-23-178"><a id="__codelineno-23-178" name="__codelineno-23-178" href="#__codelineno-23-178"></a><span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">rl</span><span class="p">.</span><span class="na">pid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, callerPackage: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">);</span>
</span><span id="__span-23-179"><a id="__codelineno-23-179" name="__codelineno-23-179" href="#__codelineno-23-179"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-23-180"><a id="__codelineno-23-180" name="__codelineno-23-180" href="#__codelineno-23-180"></a><span class="w">                </span><span class="n">rl</span><span class="p">.</span><span class="na">app</span><span class="p">.</span><span class="na">mReceivers</span><span class="p">.</span><span class="na">addReceiver</span><span class="p">(</span><span class="n">rl</span><span class="p">);</span>
</span><span id="__span-23-181"><a id="__codelineno-23-181" name="__codelineno-23-181" href="#__codelineno-23-181"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-182"><a id="__codelineno-23-182" name="__codelineno-23-182" href="#__codelineno-23-182"></a><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-183"><a id="__codelineno-23-183" name="__codelineno-23-183" href="#__codelineno-23-183"></a><span class="w">                    </span><span class="n">receiver</span><span class="p">.</span><span class="na">asBinder</span><span class="p">().</span><span class="na">linkToDeath</span><span class="p">(</span><span class="n">rl</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-23-184"><a id="__codelineno-23-184" name="__codelineno-23-184" href="#__codelineno-23-184"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-185"><a id="__codelineno-23-185" name="__codelineno-23-185" href="#__codelineno-23-185"></a><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">sticky</span><span class="p">;</span>
</span><span id="__span-23-186"><a id="__codelineno-23-186" name="__codelineno-23-186" href="#__codelineno-23-186"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-23-187"><a id="__codelineno-23-187" name="__codelineno-23-187" href="#__codelineno-23-187"></a><span class="w">                </span><span class="n">rl</span><span class="p">.</span><span class="na">linkedToDeath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-23-188"><a id="__codelineno-23-188" name="__codelineno-23-188" href="#__codelineno-23-188"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-23-189"><a id="__codelineno-23-189" name="__codelineno-23-189" href="#__codelineno-23-189"></a><span class="w">            </span><span class="n">mRegisteredReceivers</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">receiver</span><span class="p">.</span><span class="na">asBinder</span><span class="p">(),</span><span class="w"> </span><span class="n">rl</span><span class="p">);</span>
</span><span id="__span-23-190"><a id="__codelineno-23-190" name="__codelineno-23-190" href="#__codelineno-23-190"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rl</span><span class="p">.</span><span class="na">uid</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">callingUid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-191"><a id="__codelineno-23-191" name="__codelineno-23-191" href="#__codelineno-23-191"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span>
</span><span id="__span-23-192"><a id="__codelineno-23-192" name="__codelineno-23-192" href="#__codelineno-23-192"></a><span class="w">                    </span><span class="s">&quot;Receiver requested to register for uid &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callingUid</span>
</span><span id="__span-23-193"><a id="__codelineno-23-193" name="__codelineno-23-193" href="#__codelineno-23-193"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; was previously registered for uid &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rl</span><span class="p">.</span><span class="na">uid</span>
</span><span id="__span-23-194"><a id="__codelineno-23-194" name="__codelineno-23-194" href="#__codelineno-23-194"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; callerPackage is &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">);</span>
</span><span id="__span-23-195"><a id="__codelineno-23-195" name="__codelineno-23-195" href="#__codelineno-23-195"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rl</span><span class="p">.</span><span class="na">pid</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">callingPid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-196"><a id="__codelineno-23-196" name="__codelineno-23-196" href="#__codelineno-23-196"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span>
</span><span id="__span-23-197"><a id="__codelineno-23-197" name="__codelineno-23-197" href="#__codelineno-23-197"></a><span class="w">                    </span><span class="s">&quot;Receiver requested to register for pid &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callingPid</span>
</span><span id="__span-23-198"><a id="__codelineno-23-198" name="__codelineno-23-198" href="#__codelineno-23-198"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; was previously registered for pid &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rl</span><span class="p">.</span><span class="na">pid</span>
</span><span id="__span-23-199"><a id="__codelineno-23-199" name="__codelineno-23-199" href="#__codelineno-23-199"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; callerPackage is &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">);</span>
</span><span id="__span-23-200"><a id="__codelineno-23-200" name="__codelineno-23-200" href="#__codelineno-23-200"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rl</span><span class="p">.</span><span class="na">userId</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-201"><a id="__codelineno-23-201" name="__codelineno-23-201" href="#__codelineno-23-201"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span>
</span><span id="__span-23-202"><a id="__codelineno-23-202" name="__codelineno-23-202" href="#__codelineno-23-202"></a><span class="w">                    </span><span class="s">&quot;Receiver requested to register for user &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">userId</span>
</span><span id="__span-23-203"><a id="__codelineno-23-203" name="__codelineno-23-203" href="#__codelineno-23-203"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; was previously registered for user &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rl</span><span class="p">.</span><span class="na">userId</span>
</span><span id="__span-23-204"><a id="__codelineno-23-204" name="__codelineno-23-204" href="#__codelineno-23-204"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; callerPackage is &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">);</span>
</span><span id="__span-23-205"><a id="__codelineno-23-205" name="__codelineno-23-205" href="#__codelineno-23-205"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-23-206"><a id="__codelineno-23-206" name="__codelineno-23-206" href="#__codelineno-23-206"></a><span class="w">        </span><span class="n">BroadcastFilter</span><span class="w"> </span><span class="n">bf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BroadcastFilter</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span><span class="w"> </span><span class="n">rl</span><span class="p">,</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">,</span><span class="w"> </span><span class="n">callerFeatureId</span><span class="p">,</span>
</span><span id="__span-23-207"><a id="__codelineno-23-207" name="__codelineno-23-207" href="#__codelineno-23-207"></a><span class="w">                </span><span class="n">receiverId</span><span class="p">,</span><span class="w"> </span><span class="n">permission</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">instantApp</span><span class="p">,</span><span class="w"> </span><span class="n">visibleToInstantApps</span><span class="p">,</span>
</span><span id="__span-23-208"><a id="__codelineno-23-208" name="__codelineno-23-208" href="#__codelineno-23-208"></a><span class="w">                </span><span class="n">exported</span><span class="p">);</span>
</span><span id="__span-23-209"><a id="__codelineno-23-209" name="__codelineno-23-209" href="#__codelineno-23-209"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rl</span><span class="p">.</span><span class="na">containsFilter</span><span class="p">(</span><span class="n">filter</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-210"><a id="__codelineno-23-210" name="__codelineno-23-210" href="#__codelineno-23-210"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Receiver with filter &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">filter</span>
</span><span id="__span-23-211"><a id="__codelineno-23-211" name="__codelineno-23-211" href="#__codelineno-23-211"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; already registered for pid &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rl</span><span class="p">.</span><span class="na">pid</span>
</span><span id="__span-23-212"><a id="__codelineno-23-212" name="__codelineno-23-212" href="#__codelineno-23-212"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, callerPackage is &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">);</span>
</span><span id="__span-23-213"><a id="__codelineno-23-213" name="__codelineno-23-213" href="#__codelineno-23-213"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-214"><a id="__codelineno-23-214" name="__codelineno-23-214" href="#__codelineno-23-214"></a><span class="w">            </span><span class="n">rl</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">bf</span><span class="p">);</span>
</span><span id="__span-23-215"><a id="__codelineno-23-215" name="__codelineno-23-215" href="#__codelineno-23-215"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">bf</span><span class="p">.</span><span class="na">debugCheck</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-216"><a id="__codelineno-23-216" name="__codelineno-23-216" href="#__codelineno-23-216"></a><span class="w">                </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;==&gt; For Dynamic broadcast&quot;</span><span class="p">);</span>
</span><span id="__span-23-217"><a id="__codelineno-23-217" name="__codelineno-23-217" href="#__codelineno-23-217"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-23-218"><a id="__codelineno-23-218" name="__codelineno-23-218" href="#__codelineno-23-218"></a><span class="w">            </span><span class="n">mReceiverResolver</span><span class="p">.</span><span class="na">addFilter</span><span class="p">(</span><span class="n">getPackageManagerInternal</span><span class="p">().</span><span class="na">snapshot</span><span class="p">(),</span><span class="w"> </span><span class="n">bf</span><span class="p">);</span>
</span><span id="__span-23-219"><a id="__codelineno-23-219" name="__codelineno-23-219" href="#__codelineno-23-219"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-23-220"><a id="__codelineno-23-220" name="__codelineno-23-220" href="#__codelineno-23-220"></a>
</span><span id="__span-23-221"><a id="__codelineno-23-221" name="__codelineno-23-221" href="#__codelineno-23-221"></a><span class="w">        </span><span class="c1">// Enqueue broadcasts for all existing stickies that match</span>
</span><span id="__span-23-222"><a id="__codelineno-23-222" name="__codelineno-23-222" href="#__codelineno-23-222"></a><span class="w">        </span><span class="c1">// this filter.</span>
</span><span id="__span-23-223"><a id="__codelineno-23-223" name="__codelineno-23-223" href="#__codelineno-23-223"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">allSticky</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-224"><a id="__codelineno-23-224" name="__codelineno-23-224" href="#__codelineno-23-224"></a><span class="w">            </span><span class="n">ArrayList</span><span class="w"> </span><span class="n">receivers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="p">();</span>
</span><span id="__span-23-225"><a id="__codelineno-23-225" name="__codelineno-23-225" href="#__codelineno-23-225"></a><span class="w">            </span><span class="n">receivers</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">bf</span><span class="p">);</span>
</span><span id="__span-23-226"><a id="__codelineno-23-226" name="__codelineno-23-226" href="#__codelineno-23-226"></a>
</span><span id="__span-23-227"><a id="__codelineno-23-227" name="__codelineno-23-227" href="#__codelineno-23-227"></a><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">stickyCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allSticky</span><span class="p">.</span><span class="na">size</span><span class="p">();</span>
</span><span id="__span-23-228"><a id="__codelineno-23-228" name="__codelineno-23-228" href="#__codelineno-23-228"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">stickyCount</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-229"><a id="__codelineno-23-229" name="__codelineno-23-229" href="#__codelineno-23-229"></a><span class="w">                </span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allSticky</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-23-230"><a id="__codelineno-23-230" name="__codelineno-23-230" href="#__codelineno-23-230"></a><span class="w">                </span><span class="n">BroadcastQueue</span><span class="w"> </span><span class="n">queue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">broadcastQueueForIntent</span><span class="p">(</span><span class="n">intent</span><span class="p">);</span>
</span><span id="__span-23-231"><a id="__codelineno-23-231" name="__codelineno-23-231" href="#__codelineno-23-231"></a><span class="w">                </span><span class="n">BroadcastRecord</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
</span><span id="__span-23-232"><a id="__codelineno-23-232" name="__codelineno-23-232" href="#__codelineno-23-232"></a><span class="w">                        </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">OP_NONE</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
</span><span id="__span-23-233"><a id="__codelineno-23-233" name="__codelineno-23-233" href="#__codelineno-23-233"></a><span class="w">                        </span><span class="n">receivers</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
</span><span id="__span-23-234"><a id="__codelineno-23-234" name="__codelineno-23-234" href="#__codelineno-23-234"></a><span class="w">                        </span><span class="kc">false</span><span class="w"> </span><span class="cm">/* only PRE_BOOT_COMPLETED should be exempt, no stickies */</span><span class="p">);</span>
</span><span id="__span-23-235"><a id="__codelineno-23-235" name="__codelineno-23-235" href="#__codelineno-23-235"></a><span class="w">                </span><span class="n">queue</span><span class="p">.</span><span class="na">enqueueParallelBroadcastLocked</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-23-236"><a id="__codelineno-23-236" name="__codelineno-23-236" href="#__codelineno-23-236"></a><span class="w">                </span><span class="n">queue</span><span class="p">.</span><span class="na">scheduleBroadcastsLocked</span><span class="p">();</span>
</span><span id="__span-23-237"><a id="__codelineno-23-237" name="__codelineno-23-237" href="#__codelineno-23-237"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-23-238"><a id="__codelineno-23-238" name="__codelineno-23-238" href="#__codelineno-23-238"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-23-239"><a id="__codelineno-23-239" name="__codelineno-23-239" href="#__codelineno-23-239"></a>
</span><span id="__span-23-240"><a id="__codelineno-23-240" name="__codelineno-23-240" href="#__codelineno-23-240"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">sticky</span><span class="p">;</span>
</span><span id="__span-23-241"><a id="__codelineno-23-241" name="__codelineno-23-241" href="#__codelineno-23-241"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-23-242"><a id="__codelineno-23-242" name="__codelineno-23-242" href="#__codelineno-23-242"></a><span class="p">}</span>
</span></code></pre></div>
<p>上面为这个函数的完整代码，下面我们从几个方面来分析：</p>
<h4 id="_20">入参<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="kd">public</span><span class="w"> </span><span class="n">Intent</span><span class="w"> </span><span class="nf">registerReceiverWithFeature</span><span class="p">(</span><span class="n">IApplicationThread</span><span class="w"> </span><span class="n">caller</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">,</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">callerFeatureId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">receiverId</span><span class="p">,</span><span class="w"> </span><span class="n">IIntentReceiver</span><span class="w"> </span><span class="n">receiver</span><span class="p">,</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="w">        </span><span class="n">IntentFilter</span><span class="w"> </span><span class="n">filter</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">permission</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
</span></code></pre></div>
<ul>
<li>IApplicationThread caller = mMainThread.getApplicationThread(); //应用的ApplicationThread</li>
<li>String callerPackage = mBasePackageName; //是调用者的包名</li>
<li>IIntentReceiver receiver = rd; //就是LoadedApk.ReceiverDispatcher用户接受广播的地方</li>
<li>IntentFilter filter = filter; //是意图过滤器</li>
<li>String permission = broadcastPermission; //是发送这个广播需要的权限，一般不设置，</li>
<li>int userId = userId; //用户ID</li>
</ul>
<h4 id="_21">判断权限<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="c1">// Allow Sandbox process to register only unexported receivers.</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Context</span><span class="p">.</span><span class="na">RECEIVER_NOT_EXPORTED</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="w">    </span><span class="n">enforceNotIsolatedCaller</span><span class="p">(</span><span class="s">&quot;registerReceiver&quot;</span><span class="p">);</span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mSdkSandboxSettings</span><span class="p">.</span><span class="na">isBroadcastReceiverRestrictionsEnforced</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="w">    </span><span class="n">enforceNotIsolatedOrSdkSandboxCaller</span><span class="p">(</span><span class="s">&quot;registerReceiver&quot;</span><span class="p">);</span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="p">}</span>
</span></code></pre></div>
<p>Isolated、Sandbox 进程不允许注册。</p>
<h4 id="_22">初始化<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">callingUid</span><span class="p">;</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="kt">int</span><span class="w"> </span><span class="n">callingPid</span><span class="p">;</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="kt">boolean</span><span class="w"> </span><span class="n">instantApp</span><span class="p">;</span>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="kd">synchronized</span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">caller</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="w">        </span><span class="n">callerApp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getRecordForAppLOSP</span><span class="p">(</span><span class="n">caller</span><span class="p">);</span>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">callerApp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecurityException</span><span class="p">(</span>
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="w">                    </span><span class="s">&quot;Unable to find app for caller &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">caller</span>
</span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; (pid=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Binder</span><span class="p">.</span><span class="na">getCallingPid</span><span class="p">()</span>
</span><span id="__span-26-11"><a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;) when registering receiver &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">receiver</span><span class="p">);</span>
</span><span id="__span-26-12"><a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-26-13"><a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">callerApp</span><span class="p">.</span><span class="na">info</span><span class="p">.</span><span class="na">uid</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">SYSTEM_UID</span>
</span><span id="__span-26-14"><a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a><span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">callerApp</span><span class="p">.</span><span class="na">getPkgList</span><span class="p">().</span><span class="na">containsKey</span><span class="p">(</span><span class="n">callerPackage</span><span class="p">)</span>
</span><span id="__span-26-15"><a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a><span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="s">&quot;android&quot;</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">callerPackage</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-16"><a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecurityException</span><span class="p">(</span><span class="s">&quot;Given caller package &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callerPackage</span>
</span><span id="__span-26-17"><a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; is not running in process &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callerApp</span><span class="p">);</span>
</span><span id="__span-26-18"><a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-26-19"><a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a><span class="w">        </span><span class="n">callingUid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">callerApp</span><span class="p">.</span><span class="na">info</span><span class="p">.</span><span class="na">uid</span><span class="p">;</span>
</span><span id="__span-26-20"><a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a><span class="w">        </span><span class="n">callingPid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">callerApp</span><span class="p">.</span><span class="na">getPid</span><span class="p">();</span>
</span><span id="__span-26-21"><a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-22"><a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a><span class="w">        </span><span class="n">callerPackage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-26-23"><a id="__codelineno-26-23" name="__codelineno-26-23" href="#__codelineno-26-23"></a><span class="w">        </span><span class="n">callingUid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Binder</span><span class="p">.</span><span class="na">getCallingUid</span><span class="p">();</span>
</span><span id="__span-26-24"><a id="__codelineno-26-24" name="__codelineno-26-24" href="#__codelineno-26-24"></a><span class="w">        </span><span class="n">callingPid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Binder</span><span class="p">.</span><span class="na">getCallingPid</span><span class="p">();</span>
</span><span id="__span-26-25"><a id="__codelineno-26-25" name="__codelineno-26-25" href="#__codelineno-26-25"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-26-26"><a id="__codelineno-26-26" name="__codelineno-26-26" href="#__codelineno-26-26"></a>
</span><span id="__span-26-27"><a id="__codelineno-26-27" name="__codelineno-26-27" href="#__codelineno-26-27"></a><span class="w">    </span><span class="n">instantApp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isInstantApp</span><span class="p">(</span><span class="n">callerApp</span><span class="p">,</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">);</span>
</span><span id="__span-26-28"><a id="__codelineno-26-28" name="__codelineno-26-28" href="#__codelineno-26-28"></a><span class="w">    </span><span class="n">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mUserController</span><span class="p">.</span><span class="na">handleIncomingUser</span><span class="p">(</span><span class="n">callingPid</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-26-29"><a id="__codelineno-26-29" name="__codelineno-26-29" href="#__codelineno-26-29"></a><span class="w">            </span><span class="n">ALLOW_FULL_ONLY</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;registerReceiver&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">);</span>
</span><span id="__span-26-30"><a id="__codelineno-26-30" name="__codelineno-26-30" href="#__codelineno-26-30"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-26-31"><a id="__codelineno-26-31" name="__codelineno-26-31" href="#__codelineno-26-31"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>通过getRecordForAppLOSP获取callerApp，就可以根据callerApp获取到调用者的uid、pid信息</li>
<li>判断是不是instant app</li>
<li>如果是callingUid、userId同一个用户组，则直接返回userId。</li>
</ul>
<p>Android Instant App 这是一种用户无需安装即可运行 Android 应用的全新方式：基本思路是有一个空壳APK+一个干活的APK，空壳APK classloader干活的APK。</p>
<p>所以干活的APK不需要事先安装应用，开发者就需要将空壳APK做好下载业务，下载完成后重新加载dex即可。</p>
<h4 id="action">获取action<a class="headerlink" href="#action" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="c1">//遍历IntentFilter中包含的所有action</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="n">Iterator</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">actions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="na">actionsIterator</span><span class="p">();</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">actions</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="w">    </span><span class="c1">//如果没有action，则放入一个null的noAction到actions中，确保actions不为null</span>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="w">    </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">noAction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="w">    </span><span class="n">noAction</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="w">    </span><span class="n">actions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">noAction</span><span class="p">.</span><span class="na">iterator</span><span class="p">();</span>
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a><span class="p">}</span>
</span><span id="__span-27-9"><a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="kt">boolean</span><span class="w"> </span><span class="n">onlyProtectedBroadcasts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-27-10"><a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a>
</span><span id="__span-27-11"><a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a><span class="c1">// Collect stickies of users and check if broadcast is only registered for protected</span>
</span><span id="__span-27-12"><a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a><span class="c1">// broadcasts</span>
</span><span id="__span-27-13"><a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">userIds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">USER_ALL</span><span class="p">,</span><span class="w"> </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(</span><span class="n">callingUid</span><span class="p">)</span><span class="w"> </span><span class="p">};</span>
</span><span id="__span-27-14"><a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a><span class="c1">//遍历所有的action</span>
</span><span id="__span-27-15"><a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">actions</span><span class="p">.</span><span class="na">hasNext</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-16"><a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">actions</span><span class="p">.</span><span class="na">next</span><span class="p">();</span>
</span><span id="__span-27-17"><a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">userIds</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-18"><a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a><span class="w">        </span><span class="c1">//遍历mStickyBroadcasts已经发送了的粘性广播列表stickies</span>
</span><span id="__span-27-19"><a id="__codelineno-27-19" name="__codelineno-27-19" href="#__codelineno-27-19"></a><span class="w">        </span><span class="n">ArrayMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Intent</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">stickies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mStickyBroadcasts</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
</span><span id="__span-27-20"><a id="__codelineno-27-20" name="__codelineno-27-20" href="#__codelineno-27-20"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stickies</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-21"><a id="__codelineno-27-21" name="__codelineno-27-21" href="#__codelineno-27-21"></a><span class="w">            </span><span class="c1">//获取这个动态注册接受者action的粘性广播</span>
</span><span id="__span-27-22"><a id="__codelineno-27-22" name="__codelineno-27-22" href="#__codelineno-27-22"></a><span class="w">            </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Intent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">intents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stickies</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">action</span><span class="p">);</span>
</span><span id="__span-27-23"><a id="__codelineno-27-23" name="__codelineno-27-23" href="#__codelineno-27-23"></a><span class="w">            </span><span class="c1">//如果系统发送过这个action的粘性广播</span>
</span><span id="__span-27-24"><a id="__codelineno-27-24" name="__codelineno-27-24" href="#__codelineno-27-24"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intents</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-25"><a id="__codelineno-27-25" name="__codelineno-27-25" href="#__codelineno-27-25"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stickyIntents</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-26"><a id="__codelineno-27-26" name="__codelineno-27-26" href="#__codelineno-27-26"></a><span class="w">                    </span><span class="n">stickyIntents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Intent</span><span class="o">&gt;</span><span class="p">();</span>
</span><span id="__span-27-27"><a id="__codelineno-27-27" name="__codelineno-27-27" href="#__codelineno-27-27"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-27-28"><a id="__codelineno-27-28" name="__codelineno-27-28" href="#__codelineno-27-28"></a><span class="w">                </span><span class="c1">//则将粘性广播intents全部放入stickyIntents</span>
</span><span id="__span-27-29"><a id="__codelineno-27-29" name="__codelineno-27-29" href="#__codelineno-27-29"></a><span class="w">                </span><span class="n">stickyIntents</span><span class="p">.</span><span class="na">addAll</span><span class="p">(</span><span class="n">intents</span><span class="p">);</span>
</span><span id="__span-27-30"><a id="__codelineno-27-30" name="__codelineno-27-30" href="#__codelineno-27-30"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-27-31"><a id="__codelineno-27-31" name="__codelineno-27-31" href="#__codelineno-27-31"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-27-32"><a id="__codelineno-27-32" name="__codelineno-27-32" href="#__codelineno-27-32"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-27-33"><a id="__codelineno-27-33" name="__codelineno-27-33" href="#__codelineno-27-33"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">onlyProtectedBroadcasts</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-34"><a id="__codelineno-27-34" name="__codelineno-27-34" href="#__codelineno-27-34"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-35"><a id="__codelineno-27-35" name="__codelineno-27-35" href="#__codelineno-27-35"></a><span class="w">            </span><span class="n">onlyProtectedBroadcasts</span><span class="w"> </span><span class="o">&amp;=</span>
</span><span id="__span-27-36"><a id="__codelineno-27-36" name="__codelineno-27-36" href="#__codelineno-27-36"></a><span class="w">                    </span><span class="n">AppGlobals</span><span class="p">.</span><span class="na">getPackageManager</span><span class="p">().</span><span class="na">isProtectedBroadcast</span><span class="p">(</span><span class="n">action</span><span class="p">);</span>
</span><span id="__span-27-37"><a id="__codelineno-27-37" name="__codelineno-27-37" href="#__codelineno-27-37"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-38"><a id="__codelineno-27-38" name="__codelineno-27-38" href="#__codelineno-27-38"></a><span class="w">            </span><span class="n">onlyProtectedBroadcasts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-27-39"><a id="__codelineno-27-39" name="__codelineno-27-39" href="#__codelineno-27-39"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Remote exception&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
</span><span id="__span-27-40"><a id="__codelineno-27-40" name="__codelineno-27-40" href="#__codelineno-27-40"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-27-41"><a id="__codelineno-27-41" name="__codelineno-27-41" href="#__codelineno-27-41"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-27-42"><a id="__codelineno-27-42" name="__codelineno-27-42" href="#__codelineno-27-42"></a><span class="p">}</span>
</span><span id="__span-27-43"><a id="__codelineno-27-43" name="__codelineno-27-43" href="#__codelineno-27-43"></a>
</span><span id="__span-27-44"><a id="__codelineno-27-44" name="__codelineno-27-44" href="#__codelineno-27-44"></a><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Intent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">allSticky</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-27-45"><a id="__codelineno-27-45" name="__codelineno-27-45" href="#__codelineno-27-45"></a><span class="c1">//如果之前已经发送过这个action的粘性广播，则stickyIntents不为null，否则为null</span>
</span><span id="__span-27-46"><a id="__codelineno-27-46" name="__codelineno-27-46" href="#__codelineno-27-46"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stickyIntents</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-47"><a id="__codelineno-27-47" name="__codelineno-27-47" href="#__codelineno-27-47"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">ContentResolver</span><span class="w"> </span><span class="n">resolver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mContext</span><span class="p">.</span><span class="na">getContentResolver</span><span class="p">();</span>
</span><span id="__span-27-48"><a id="__codelineno-27-48" name="__codelineno-27-48" href="#__codelineno-27-48"></a><span class="w">    </span><span class="c1">// Look for any matching sticky broadcasts...</span>
</span><span id="__span-27-49"><a id="__codelineno-27-49" name="__codelineno-27-49" href="#__codelineno-27-49"></a><span class="w">    </span><span class="c1">//遍历粘性广播的Intent：stickyIntents</span>
</span><span id="__span-27-50"><a id="__codelineno-27-50" name="__codelineno-27-50" href="#__codelineno-27-50"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stickyIntents</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-51"><a id="__codelineno-27-51" name="__codelineno-27-51" href="#__codelineno-27-51"></a><span class="w">        </span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stickyIntents</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-27-52"><a id="__codelineno-27-52" name="__codelineno-27-52" href="#__codelineno-27-52"></a><span class="w">        </span><span class="c1">// Don&#39;t provided intents that aren&#39;t available to instant apps.</span>
</span><span id="__span-27-53"><a id="__codelineno-27-53" name="__codelineno-27-53" href="#__codelineno-27-53"></a><span class="w">        </span><span class="c1">//如果是instantApp，而且没有单独设置接受粘性广播FLAG_RECEIVER_VISIBLE_TO_INSTANT_APPS</span>
</span><span id="__span-27-54"><a id="__codelineno-27-54" name="__codelineno-27-54" href="#__codelineno-27-54"></a><span class="w">        </span><span class="c1">//则默认是处理粘性广播的</span>
</span><span id="__span-27-55"><a id="__codelineno-27-55" name="__codelineno-27-55" href="#__codelineno-27-55"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">instantApp</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-27-56"><a id="__codelineno-27-56" name="__codelineno-27-56" href="#__codelineno-27-56"></a><span class="w">                </span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getFlags</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">FLAG_RECEIVER_VISIBLE_TO_INSTANT_APPS</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-57"><a id="__codelineno-27-57" name="__codelineno-27-57" href="#__codelineno-27-57"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-27-58"><a id="__codelineno-27-58" name="__codelineno-27-58" href="#__codelineno-27-58"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-27-59"><a id="__codelineno-27-59" name="__codelineno-27-59" href="#__codelineno-27-59"></a><span class="w">        </span><span class="c1">// If intent has scheme &quot;content&quot;, it will need to access</span>
</span><span id="__span-27-60"><a id="__codelineno-27-60" name="__codelineno-27-60" href="#__codelineno-27-60"></a><span class="w">        </span><span class="c1">// provider that needs to lock mProviderMap in ActivityThread</span>
</span><span id="__span-27-61"><a id="__codelineno-27-61" name="__codelineno-27-61" href="#__codelineno-27-61"></a><span class="w">        </span><span class="c1">// and also it may need to wait application response, so we</span>
</span><span id="__span-27-62"><a id="__codelineno-27-62" name="__codelineno-27-62" href="#__codelineno-27-62"></a><span class="w">        </span><span class="c1">// cannot lock ActivityManagerService here.</span>
</span><span id="__span-27-63"><a id="__codelineno-27-63" name="__codelineno-27-63" href="#__codelineno-27-63"></a><span class="w">        </span><span class="c1">//匹配一下注册广播的filter，是否和intent一致，如果大于0则表示匹配成功</span>
</span><span id="__span-27-64"><a id="__codelineno-27-64" name="__codelineno-27-64" href="#__codelineno-27-64"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">filter</span><span class="p">.</span><span class="na">match</span><span class="p">(</span><span class="n">resolver</span><span class="p">,</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">TAG</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-65"><a id="__codelineno-27-65" name="__codelineno-27-65" href="#__codelineno-27-65"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">allSticky</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-66"><a id="__codelineno-27-66" name="__codelineno-27-66" href="#__codelineno-27-66"></a><span class="w">                </span><span class="n">allSticky</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Intent</span><span class="o">&gt;</span><span class="p">();</span>
</span><span id="__span-27-67"><a id="__codelineno-27-67" name="__codelineno-27-67" href="#__codelineno-27-67"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-27-68"><a id="__codelineno-27-68" name="__codelineno-27-68" href="#__codelineno-27-68"></a><span class="w">            </span><span class="c1">//如果匹配成功则将该粘性广播intent保存在allSticky</span>
</span><span id="__span-27-69"><a id="__codelineno-27-69" name="__codelineno-27-69" href="#__codelineno-27-69"></a><span class="w">            </span><span class="n">allSticky</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">intent</span><span class="p">);</span>
</span><span id="__span-27-70"><a id="__codelineno-27-70" name="__codelineno-27-70" href="#__codelineno-27-70"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-27-71"><a id="__codelineno-27-71" name="__codelineno-27-71" href="#__codelineno-27-71"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-27-72"><a id="__codelineno-27-72" name="__codelineno-27-72" href="#__codelineno-27-72"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>遍历IntentFilter中包含的所有action</li>
<li>遍历所有的action，将粘性广播intents全部放入stickyIntents</li>
<li>遍历粘性广播的stickyIntents，匹配一下注册广播的filter，是否和intent一致</li>
</ul>
<h4 id="receiver">receiver为空<a class="headerlink" href="#receiver" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="c1">// The first sticky in the list is returned directly back to the client.</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="c1">//取得匹配成功后的第一个粘性广播sticky</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="n">Intent</span><span class="w"> </span><span class="n">sticky</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allSticky</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">allSticky</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Register receiver &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">filter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sticky</span><span class="p">);</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="c1">// 判断receiver是否为空，如果为空则直接返回找到的对应Sticky Intent。</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">receiver</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">sticky</span><span class="p">;</span>
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="p">}</span>
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a>
</span><span id="__span-28-10"><a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a><span class="c1">// SafetyNet logging for b/177931370. If any process other than system_server tries to</span>
</span><span id="__span-28-11"><a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a><span class="c1">// listen to this broadcast action, then log it.</span>
</span><span id="__span-28-12"><a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">callingPid</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">Process</span><span class="p">.</span><span class="na">myPid</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-13"><a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">filter</span><span class="p">.</span><span class="na">hasAction</span><span class="p">(</span><span class="s">&quot;com.android.server.net.action.SNOOZE_WARNING&quot;</span><span class="p">)</span>
</span><span id="__span-28-14"><a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a><span class="w">            </span><span class="o">||</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="na">hasAction</span><span class="p">(</span><span class="s">&quot;com.android.server.net.action.SNOOZE_RAPID&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-15"><a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a><span class="w">        </span><span class="n">EventLog</span><span class="p">.</span><span class="na">writeEvent</span><span class="p">(</span><span class="mh">0x534e4554</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;177931370&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">);</span>
</span><span id="__span-28-16"><a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-28-17"><a id="__codelineno-28-17" name="__codelineno-28-17" href="#__codelineno-28-17"></a><span class="p">}</span>
</span></code></pre></div>
<p>如果receiver为空则直接返回找到的对应Sticky Intent。想起来前面ContextImpl.registerReceiverInternal提到receiver为空的问题了吧。</p>
<p>正常情况下receiver是不为空的，但是有时候为了获取粘性广播的一些信息（比如电池信息），可以将receiver设为空，只为了从返回的Sticky Intent中获取这些信息。</p>
<p>这时的注册广播可以写成这种形式，但是注意，这种形式只能在注册的时候获得一次信息，而不会有后续的继续监听。</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="n">mBatteryBroadcast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mContext</span><span class="p">.</span><span class="na">registerReceiver</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IntentFilter</span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_BATTERY_CHANGED</span><span class="p">));</span>
</span></code></pre></div>
<h4 id="receiver_1">保存receiver<a class="headerlink" href="#receiver_1" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="w">    </span><span class="c1">//取得callerApp的IApplicationThread应用线程</span>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="w">    </span><span class="n">IApplicationThread</span><span class="w"> </span><span class="n">thread</span><span class="p">;</span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">callerApp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">((</span><span class="n">thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">callerApp</span><span class="p">.</span><span class="na">getThread</span><span class="p">())</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="w">            </span><span class="o">||</span><span class="w"> </span><span class="n">thread</span><span class="p">.</span><span class="na">asBinder</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">caller</span><span class="p">.</span><span class="na">asBinder</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="w">        </span><span class="c1">// Original caller already died</span>
</span><span id="__span-30-7"><a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a><span class="w">        </span><span class="c1">//如果callerApp没有IApplicationThread(或者caller和callerApp的IApplicationThread不一致)，</span>
</span><span id="__span-30-8"><a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a><span class="w">        </span><span class="c1">// 则代表进程之前已经死掉了</span>
</span><span id="__span-30-9"><a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-30-10"><a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-30-11"><a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a><span class="w">    </span><span class="c1">///获取这个接受者receiver，是否已经保存在AMS的mRegisteredReceivers动态注册者列表里面</span>
</span><span id="__span-30-12"><a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a><span class="w">    </span><span class="n">ReceiverList</span><span class="w"> </span><span class="n">rl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mRegisteredReceivers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">receiver</span><span class="p">.</span><span class="na">asBinder</span><span class="p">());</span>
</span><span id="__span-30-13"><a id="__codelineno-30-13" name="__codelineno-30-13" href="#__codelineno-30-13"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rl</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="c1">//如果之前没有注册过(没有在mRegisteredReceivers中)</span>
</span><span id="__span-30-14"><a id="__codelineno-30-14" name="__codelineno-30-14" href="#__codelineno-30-14"></a><span class="w">        </span><span class="c1">//构建一个ReceiverList：传入参数是: AMS, callerApp, callingPid, callingUid, userId, receiver(接受者)</span>
</span><span id="__span-30-15"><a id="__codelineno-30-15" name="__codelineno-30-15" href="#__codelineno-30-15"></a><span class="w">        </span><span class="n">rl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReceiverList</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">callerApp</span><span class="p">,</span><span class="w"> </span><span class="n">callingPid</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">,</span>
</span><span id="__span-30-16"><a id="__codelineno-30-16" name="__codelineno-30-16" href="#__codelineno-30-16"></a><span class="w">                </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">receiver</span><span class="p">);</span>
</span><span id="__span-30-17"><a id="__codelineno-30-17" name="__codelineno-30-17" href="#__codelineno-30-17"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rl</span><span class="p">.</span><span class="na">app</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="c1">//如果callerApp不为null，获取一下当前mReceivers</span>
</span><span id="__span-30-18"><a id="__codelineno-30-18" name="__codelineno-30-18" href="#__codelineno-30-18"></a><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">totalReceiversForApp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rl</span><span class="p">.</span><span class="na">app</span><span class="p">.</span><span class="na">mReceivers</span><span class="p">.</span><span class="na">numberOfReceivers</span><span class="p">();</span>
</span><span id="__span-30-19"><a id="__codelineno-30-19" name="__codelineno-30-19" href="#__codelineno-30-19"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">totalReceiversForApp</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">MAX_RECEIVERS_ALLOWED_PER_APP</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="c1">//一个进程最多1000个接受者(动态)</span>
</span><span id="__span-30-20"><a id="__codelineno-30-20" name="__codelineno-30-20" href="#__codelineno-30-20"></a><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;Too many receivers, total of &quot;</span>
</span><span id="__span-30-21"><a id="__codelineno-30-21" name="__codelineno-30-21" href="#__codelineno-30-21"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">totalReceiversForApp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, registered for pid: &quot;</span>
</span><span id="__span-30-22"><a id="__codelineno-30-22" name="__codelineno-30-22" href="#__codelineno-30-22"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">rl</span><span class="p">.</span><span class="na">pid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, callerPackage: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">);</span>
</span><span id="__span-30-23"><a id="__codelineno-30-23" name="__codelineno-30-23" href="#__codelineno-30-23"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-30-24"><a id="__codelineno-30-24" name="__codelineno-30-24" href="#__codelineno-30-24"></a><span class="w">            </span><span class="c1">//将ReceiverList rl添加到mReceivers(ProcessReceiverRecord.java)中(有点循环的感觉)</span>
</span><span id="__span-30-25"><a id="__codelineno-30-25" name="__codelineno-30-25" href="#__codelineno-30-25"></a><span class="w">            </span><span class="n">rl</span><span class="p">.</span><span class="na">app</span><span class="p">.</span><span class="na">mReceivers</span><span class="p">.</span><span class="na">addReceiver</span><span class="p">(</span><span class="n">rl</span><span class="p">);</span>
</span><span id="__span-30-26"><a id="__codelineno-30-26" name="__codelineno-30-26" href="#__codelineno-30-26"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-27"><a id="__codelineno-30-27" name="__codelineno-30-27" href="#__codelineno-30-27"></a><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-28"><a id="__codelineno-30-28" name="__codelineno-30-28" href="#__codelineno-30-28"></a><span class="w">                </span><span class="n">receiver</span><span class="p">.</span><span class="na">asBinder</span><span class="p">().</span><span class="na">linkToDeath</span><span class="p">(</span><span class="n">rl</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-30-29"><a id="__codelineno-30-29" name="__codelineno-30-29" href="#__codelineno-30-29"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-30"><a id="__codelineno-30-30" name="__codelineno-30-30" href="#__codelineno-30-30"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">sticky</span><span class="p">;</span>
</span><span id="__span-30-31"><a id="__codelineno-30-31" name="__codelineno-30-31" href="#__codelineno-30-31"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-30-32"><a id="__codelineno-30-32" name="__codelineno-30-32" href="#__codelineno-30-32"></a><span class="w">            </span><span class="n">rl</span><span class="p">.</span><span class="na">linkedToDeath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-30-33"><a id="__codelineno-30-33" name="__codelineno-30-33" href="#__codelineno-30-33"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-30-34"><a id="__codelineno-30-34" name="__codelineno-30-34" href="#__codelineno-30-34"></a><span class="w">        </span><span class="c1">//mRegisteredReceivers保存了所有的动态注册的receiver</span>
</span><span id="__span-30-35"><a id="__codelineno-30-35" name="__codelineno-30-35" href="#__codelineno-30-35"></a><span class="w">        </span><span class="n">mRegisteredReceivers</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">receiver</span><span class="p">.</span><span class="na">asBinder</span><span class="p">(),</span><span class="w"> </span><span class="n">rl</span><span class="p">);</span>
</span><span id="__span-30-36"><a id="__codelineno-30-36" name="__codelineno-30-36" href="#__codelineno-30-36"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rl</span><span class="p">.</span><span class="na">uid</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">callingUid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-37"><a id="__codelineno-30-37" name="__codelineno-30-37" href="#__codelineno-30-37"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span>
</span><span id="__span-30-38"><a id="__codelineno-30-38" name="__codelineno-30-38" href="#__codelineno-30-38"></a><span class="w">                </span><span class="s">&quot;Receiver requested to register for uid &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callingUid</span>
</span><span id="__span-30-39"><a id="__codelineno-30-39" name="__codelineno-30-39" href="#__codelineno-30-39"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; was previously registered for uid &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rl</span><span class="p">.</span><span class="na">uid</span>
</span><span id="__span-30-40"><a id="__codelineno-30-40" name="__codelineno-30-40" href="#__codelineno-30-40"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; callerPackage is &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">);</span>
</span><span id="__span-30-41"><a id="__codelineno-30-41" name="__codelineno-30-41" href="#__codelineno-30-41"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rl</span><span class="p">.</span><span class="na">pid</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">callingPid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-42"><a id="__codelineno-30-42" name="__codelineno-30-42" href="#__codelineno-30-42"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span>
</span><span id="__span-30-43"><a id="__codelineno-30-43" name="__codelineno-30-43" href="#__codelineno-30-43"></a><span class="w">                </span><span class="s">&quot;Receiver requested to register for pid &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callingPid</span>
</span><span id="__span-30-44"><a id="__codelineno-30-44" name="__codelineno-30-44" href="#__codelineno-30-44"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; was previously registered for pid &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rl</span><span class="p">.</span><span class="na">pid</span>
</span><span id="__span-30-45"><a id="__codelineno-30-45" name="__codelineno-30-45" href="#__codelineno-30-45"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; callerPackage is &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">);</span>
</span><span id="__span-30-46"><a id="__codelineno-30-46" name="__codelineno-30-46" href="#__codelineno-30-46"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rl</span><span class="p">.</span><span class="na">userId</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-47"><a id="__codelineno-30-47" name="__codelineno-30-47" href="#__codelineno-30-47"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span>
</span><span id="__span-30-48"><a id="__codelineno-30-48" name="__codelineno-30-48" href="#__codelineno-30-48"></a><span class="w">                </span><span class="s">&quot;Receiver requested to register for user &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">userId</span>
</span><span id="__span-30-49"><a id="__codelineno-30-49" name="__codelineno-30-49" href="#__codelineno-30-49"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; was previously registered for user &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rl</span><span class="p">.</span><span class="na">userId</span>
</span><span id="__span-30-50"><a id="__codelineno-30-50" name="__codelineno-30-50" href="#__codelineno-30-50"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; callerPackage is &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">);</span>
</span><span id="__span-30-51"><a id="__codelineno-30-51" name="__codelineno-30-51" href="#__codelineno-30-51"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-30-52"><a id="__codelineno-30-52" name="__codelineno-30-52" href="#__codelineno-30-52"></a><span class="w">    </span><span class="c1">// ReceiverList rl接收列表 (ReceiverList extends ArrayList&lt;BroadcastFilter&gt;),它的元素是BroadcastFilter bf</span>
</span><span id="__span-30-53"><a id="__codelineno-30-53" name="__codelineno-30-53" href="#__codelineno-30-53"></a><span class="w">    </span><span class="c1">// BroadcastFilter bf广播过滤器</span>
</span><span id="__span-30-54"><a id="__codelineno-30-54" name="__codelineno-30-54" href="#__codelineno-30-54"></a><span class="w">    </span><span class="c1">// 上面只是把广播接收着receiver的一些信息保存在ReceiverList rl中，但是还没有把它和filter关联起来，</span>
</span><span id="__span-30-55"><a id="__codelineno-30-55" name="__codelineno-30-55" href="#__codelineno-30-55"></a><span class="w">    </span><span class="c1">// 这里就创建一个BroadcastFilter(bf)来把广播接收器列表rl和filter关联起来</span>
</span><span id="__span-30-56"><a id="__codelineno-30-56" name="__codelineno-30-56" href="#__codelineno-30-56"></a><span class="w">    </span><span class="n">BroadcastFilter</span><span class="w"> </span><span class="n">bf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BroadcastFilter</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span><span class="w"> </span><span class="n">rl</span><span class="p">,</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">,</span><span class="w"> </span><span class="n">callerFeatureId</span><span class="p">,</span>
</span><span id="__span-30-57"><a id="__codelineno-30-57" name="__codelineno-30-57" href="#__codelineno-30-57"></a><span class="w">            </span><span class="n">receiverId</span><span class="p">,</span><span class="w"> </span><span class="n">permission</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">instantApp</span><span class="p">,</span><span class="w"> </span><span class="n">visibleToInstantApps</span><span class="p">,</span>
</span><span id="__span-30-58"><a id="__codelineno-30-58" name="__codelineno-30-58" href="#__codelineno-30-58"></a><span class="w">            </span><span class="n">exported</span><span class="p">);</span>
</span><span id="__span-30-59"><a id="__codelineno-30-59" name="__codelineno-30-59" href="#__codelineno-30-59"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rl</span><span class="p">.</span><span class="na">containsFilter</span><span class="p">(</span><span class="n">filter</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="c1">//如果ReceiverList rl已经包含这个filter，则不再加入</span>
</span><span id="__span-30-60"><a id="__codelineno-30-60" name="__codelineno-30-60" href="#__codelineno-30-60"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Receiver with filter &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">filter</span>
</span><span id="__span-30-61"><a id="__codelineno-30-61" name="__codelineno-30-61" href="#__codelineno-30-61"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; already registered for pid &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rl</span><span class="p">.</span><span class="na">pid</span>
</span><span id="__span-30-62"><a id="__codelineno-30-62" name="__codelineno-30-62" href="#__codelineno-30-62"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, callerPackage is &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">);</span>
</span><span id="__span-30-63"><a id="__codelineno-30-63" name="__codelineno-30-63" href="#__codelineno-30-63"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="c1">//如果ReceiverList rl之前没添加过BroadcastFilter(bf)，则加入接收列表中</span>
</span><span id="__span-30-64"><a id="__codelineno-30-64" name="__codelineno-30-64" href="#__codelineno-30-64"></a><span class="w">        </span><span class="n">rl</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">bf</span><span class="p">);</span>
</span><span id="__span-30-65"><a id="__codelineno-30-65" name="__codelineno-30-65" href="#__codelineno-30-65"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">bf</span><span class="p">.</span><span class="na">debugCheck</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-66"><a id="__codelineno-30-66" name="__codelineno-30-66" href="#__codelineno-30-66"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;==&gt; For Dynamic broadcast&quot;</span><span class="p">);</span>
</span><span id="__span-30-67"><a id="__codelineno-30-67" name="__codelineno-30-67" href="#__codelineno-30-67"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-30-68"><a id="__codelineno-30-68" name="__codelineno-30-68" href="#__codelineno-30-68"></a><span class="w">        </span><span class="c1">//同时添加bf到mReceiverResolver中去</span>
</span><span id="__span-30-69"><a id="__codelineno-30-69" name="__codelineno-30-69" href="#__codelineno-30-69"></a><span class="w">        </span><span class="c1">//该变量用于在broadcastIntentLocked分发广播的时候, 查询符合条件的动态注册的广播</span>
</span><span id="__span-30-70"><a id="__codelineno-30-70" name="__codelineno-30-70" href="#__codelineno-30-70"></a><span class="w">        </span><span class="n">mReceiverResolver</span><span class="p">.</span><span class="na">addFilter</span><span class="p">(</span><span class="n">getPackageManagerInternal</span><span class="p">().</span><span class="na">snapshot</span><span class="p">(),</span><span class="w"> </span><span class="n">bf</span><span class="p">);</span>
</span><span id="__span-30-71"><a id="__codelineno-30-71" name="__codelineno-30-71" href="#__codelineno-30-71"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-30-72"><a id="__codelineno-30-72" name="__codelineno-30-72" href="#__codelineno-30-72"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-30-73"><a id="__codelineno-30-73" name="__codelineno-30-73" href="#__codelineno-30-73"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>判断应用是否死掉</li>
<li>mRegisteredReceivers.put(receiver.asBinder(), rl);保存所有的动态注册的receiver</li>
<li>mReceiverResolver.addFilter(getPackageManagerInternal().snapshot(), bf);</li>
</ul>
<h4 id="_23">粘性广播<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="c1">// Enqueue broadcasts for all existing stickies that match</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="c1">// this filter.</span>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">allSticky</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="c1">//广播接受者注册的广播的是粘性广播</span>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="w">    </span><span class="c1">//BroadcastFilter bf才是实际的接受者，接受者receivers只有一个BroadcastFilter bf，</span>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="w">    </span><span class="c1">//也就是单发给BroadcastFilter bf</span>
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="w">    </span><span class="n">ArrayList</span><span class="w"> </span><span class="n">receivers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="p">();</span>
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="w">    </span><span class="n">receivers</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">bf</span><span class="p">);</span>
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a>
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">stickyCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allSticky</span><span class="p">.</span><span class="na">size</span><span class="p">();</span>
</span><span id="__span-31-10"><a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a><span class="w">    </span><span class="c1">//遍历匹配成功的粘性广播列表allSticky</span>
</span><span id="__span-31-11"><a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">stickyCount</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-12"><a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a><span class="w">        </span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allSticky</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-31-13"><a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a><span class="w">        </span><span class="c1">//取出intent对应的广播队列</span>
</span><span id="__span-31-14"><a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a><span class="w">        </span><span class="n">BroadcastQueue</span><span class="w"> </span><span class="n">queue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">broadcastQueueForIntent</span><span class="p">(</span><span class="n">intent</span><span class="p">);</span>
</span><span id="__span-31-15"><a id="__codelineno-31-15" name="__codelineno-31-15" href="#__codelineno-31-15"></a><span class="w">        </span><span class="n">BroadcastRecord</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
</span><span id="__span-31-16"><a id="__codelineno-31-16" name="__codelineno-31-16" href="#__codelineno-31-16"></a><span class="w">                </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">OP_NONE</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
</span><span id="__span-31-17"><a id="__codelineno-31-17" name="__codelineno-31-17" href="#__codelineno-31-17"></a><span class="w">                </span><span class="n">receivers</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
</span><span id="__span-31-18"><a id="__codelineno-31-18" name="__codelineno-31-18" href="#__codelineno-31-18"></a><span class="w">                </span><span class="kc">false</span><span class="w"> </span><span class="cm">/* only PRE_BOOT_COMPLETED should be exempt, no stickies */</span><span class="p">);</span>
</span><span id="__span-31-19"><a id="__codelineno-31-19" name="__codelineno-31-19" href="#__codelineno-31-19"></a><span class="w">        </span><span class="c1">//粘性广播接受者注册后, 就放入mParallelBroadcasts中</span>
</span><span id="__span-31-20"><a id="__codelineno-31-20" name="__codelineno-31-20" href="#__codelineno-31-20"></a><span class="w">        </span><span class="n">queue</span><span class="p">.</span><span class="na">enqueueParallelBroadcastLocked</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-31-21"><a id="__codelineno-31-21" name="__codelineno-31-21" href="#__codelineno-31-21"></a><span class="w">        </span><span class="c1">//这里会马上处理刚才的平行广播队列,也就是达到注册了之后马上执行的效果</span>
</span><span id="__span-31-22"><a id="__codelineno-31-22" name="__codelineno-31-22" href="#__codelineno-31-22"></a><span class="w">        </span><span class="n">queue</span><span class="p">.</span><span class="na">scheduleBroadcastsLocked</span><span class="p">();</span>
</span><span id="__span-31-23"><a id="__codelineno-31-23" name="__codelineno-31-23" href="#__codelineno-31-23"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-31-24"><a id="__codelineno-31-24" name="__codelineno-31-24" href="#__codelineno-31-24"></a><span class="p">}</span>
</span><span id="__span-31-25"><a id="__codelineno-31-25" name="__codelineno-31-25" href="#__codelineno-31-25"></a>
</span><span id="__span-31-26"><a id="__codelineno-31-26" name="__codelineno-31-26" href="#__codelineno-31-26"></a><span class="k">return</span><span class="w"> </span><span class="n">sticky</span><span class="p">;</span>
</span></code></pre></div>
<h3 id="_24">总结<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h3>
<ul>
<li>广播分发通过LoadedApk.ReceiverDispatcher.getIIntentReceiver获得的IIntentReceiver对象来实现的</li>
<li>动态广播注册其实最终构建的是BroadcastFilter bf，并放入mReceiverResolver中去</li>
<li>粘性广播注册的时候就会收到之前已经发送的粘性广播</li>
<li>粘性广播注册可以不传入IIntentReceiver receiver，而获取一次信息</li>
<li>广播处理如果没有特殊设定广播处理的Handler，默认在ActivityThread的主线程(mH)中执行，主线程卡住会导致广播处理的延迟(超时发生广播anr)。</li>
</ul>
<h3 id="_25">思考<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h3>
<p>动态注册的广播没有在进程推出时解注册，经常会看到如下log：</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="o">***</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">leaked</span><span class="w"> </span><span class="n">IntentReceiver</span><span class="w"> </span><span class="o">***</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">originally</span><span class="w"> </span><span class="n">registered</span><span class="w"> </span><span class="n">here</span><span class="p">.</span><span class="w"> </span><span class="n">Are</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">missing</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="nf">unregisterReceiver</span><span class="p">()</span>
</span></code></pre></div>
<p>Android是怎么判断关闭的进程没有解注册的？我们从在activity退出流程分析：</p>
<h4 id="activitymanagerservicehandledestroyactivity">ActivityManagerService.handleDestroyActivity<a class="headerlink" href="#activitymanagerservicehandledestroyactivity" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="n">ActivityManagerService</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handleDestroyActivity</span><span class="p">(</span><span class="n">ActivityClientRecord</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">finishing</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">configChanges</span><span class="p">,</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="w">            </span><span class="kt">boolean</span><span class="w"> </span><span class="n">getNonConfigInstance</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">reason</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a><span class="w">    </span><span class="n">Context</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">activity</span><span class="p">.</span><span class="na">getBaseContext</span><span class="p">();</span>
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">ContextImpl</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a><span class="w">        </span><span class="p">((</span><span class="n">ContextImpl</span><span class="p">)</span><span class="w"> </span><span class="n">c</span><span class="p">).</span><span class="na">scheduleFinalCleanup</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">activity</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getName</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;Activity&quot;</span><span class="p">);</span>
</span><span id="__span-33-8"><a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-33-9"><a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-33-10"><a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="contextimplschedulefinalcleanup">ContextImpl.scheduleFinalCleanup<a class="headerlink" href="#contextimplschedulefinalcleanup" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="n">ContextImpl</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="nd">@UnsupportedAppUsage</span>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="kd">final</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">scheduleFinalCleanup</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">who</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">what</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="w">    </span><span class="n">mMainThread</span><span class="p">.</span><span class="na">scheduleContextCleanup</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">who</span><span class="p">,</span><span class="w"> </span><span class="n">what</span><span class="p">);</span>
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a><span class="p">}</span>
</span></code></pre></div>
<p>这里的mMainThread就是ActivityThread</p>
<h4 id="activitythreadschedulecontextcleanup">ActivityThread.scheduleContextCleanup<a class="headerlink" href="#activitythreadschedulecontextcleanup" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="n">ActivityThread</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="kd">final</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">scheduleContextCleanup</span><span class="p">(</span><span class="n">ContextImpl</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">who</span><span class="p">,</span>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">what</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="w">    </span><span class="n">ContextCleanupInfo</span><span class="w"> </span><span class="n">cci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ContextCleanupInfo</span><span class="p">();</span>
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="w">    </span><span class="n">cci</span><span class="p">.</span><span class="na">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">;</span>
</span><span id="__span-35-6"><a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a><span class="w">    </span><span class="n">cci</span><span class="p">.</span><span class="na">who</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">who</span><span class="p">;</span>
</span><span id="__span-35-7"><a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a><span class="w">    </span><span class="n">cci</span><span class="p">.</span><span class="na">what</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">what</span><span class="p">;</span>
</span><span id="__span-35-8"><a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a><span class="w">    </span><span class="n">sendMessage</span><span class="p">(</span><span class="n">H</span><span class="p">.</span><span class="na">CLEAN_UP_CONTEXT</span><span class="p">,</span><span class="w"> </span><span class="n">cci</span><span class="p">);</span>
</span><span id="__span-35-9"><a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a><span class="p">}</span>
</span><span id="__span-35-10"><a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a>
</span><span id="__span-35-11"><a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a><span class="kd">class</span> <span class="nc">H</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Handler</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-12"><a id="__codelineno-35-12" name="__codelineno-35-12" href="#__codelineno-35-12"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handleMessage</span><span class="p">(</span><span class="n">Message</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-13"><a id="__codelineno-35-13" name="__codelineno-35-13" href="#__codelineno-35-13"></a><span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="na">what</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-14"><a id="__codelineno-35-14" name="__codelineno-35-14" href="#__codelineno-35-14"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">CLEAN_UP_CONTEXT</span><span class="p">:</span>
</span><span id="__span-35-15"><a id="__codelineno-35-15" name="__codelineno-35-15" href="#__codelineno-35-15"></a><span class="w">                </span><span class="n">ContextCleanupInfo</span><span class="w"> </span><span class="n">cci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ContextCleanupInfo</span><span class="p">)</span><span class="n">msg</span><span class="p">.</span><span class="na">obj</span><span class="p">;</span>
</span><span id="__span-35-16"><a id="__codelineno-35-16" name="__codelineno-35-16" href="#__codelineno-35-16"></a><span class="w">                </span><span class="n">cci</span><span class="p">.</span><span class="na">context</span><span class="p">.</span><span class="na">performFinalCleanup</span><span class="p">(</span><span class="n">cci</span><span class="p">.</span><span class="na">who</span><span class="p">,</span><span class="w"> </span><span class="n">cci</span><span class="p">.</span><span class="na">what</span><span class="p">);</span>
</span><span id="__span-35-17"><a id="__codelineno-35-17" name="__codelineno-35-17" href="#__codelineno-35-17"></a><span class="w">                </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-35-18"><a id="__codelineno-35-18" name="__codelineno-35-18" href="#__codelineno-35-18"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-35-19"><a id="__codelineno-35-19" name="__codelineno-35-19" href="#__codelineno-35-19"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-35-20"><a id="__codelineno-35-20" name="__codelineno-35-20" href="#__codelineno-35-20"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="contextimplperformfinalcleanup">ContextImpl.performFinalCleanup<a class="headerlink" href="#contextimplperformfinalcleanup" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="n">ContextImpl</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="kd">final</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">performFinalCleanup</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">who</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">what</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="w">    </span><span class="c1">//Log.i(TAG, &quot;Cleanup up context: &quot; + this);</span>
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="w">    </span><span class="n">mPackageInfo</span><span class="p">.</span><span class="na">removeContextRegistrations</span><span class="p">(</span><span class="n">getOuterContext</span><span class="p">(),</span><span class="w"> </span><span class="n">who</span><span class="p">,</span><span class="w"> </span><span class="n">what</span><span class="p">);</span>
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mContextType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CONTEXT_TYPE_SYSTEM_OR_SYSTEM_UI</span>
</span><span id="__span-36-6"><a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a><span class="w">            </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mToken</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">WindowTokenClient</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-36-7"><a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a><span class="w">        </span><span class="n">mMainThread</span><span class="p">.</span><span class="na">onSystemUiContextCleanup</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span id="__span-36-8"><a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-36-9"><a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a><span class="p">}</span>
</span></code></pre></div>
<p>mPackageInfo就是LoadedApk。</p>
<h4 id="loadedapkremovecontextregistrations">LoadedApk.removeContextRegistrations<a class="headerlink" href="#loadedapkremovecontextregistrations" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="n">LoadedApk</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">removeContextRegistrations</span><span class="p">(</span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">,</span>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">who</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">what</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">reportRegistrationLeaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StrictMode</span><span class="p">.</span><span class="na">vmRegistrationLeaksEnabled</span><span class="p">();</span>
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a><span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mReceivers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a><span class="w">        </span><span class="c1">//从mReceivers移除掉并返回ArrayMap&lt;BroadcastReceiver, ReceiverDispatcher&gt;</span>
</span><span id="__span-37-8"><a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a><span class="w">        </span><span class="n">ArrayMap</span><span class="o">&lt;</span><span class="n">BroadcastReceiver</span><span class="p">,</span><span class="w"> </span><span class="n">LoadedApk</span><span class="p">.</span><span class="na">ReceiverDispatcher</span><span class="o">&gt;</span><span class="w"> </span><span class="n">rmap</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-37-9"><a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a><span class="w">                </span><span class="n">mReceivers</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
</span><span id="__span-37-10"><a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rmap</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="c1">//rmap不为空，则表示进程退出时没有解注册</span>
</span><span id="__span-37-11"><a id="__codelineno-37-11" name="__codelineno-37-11" href="#__codelineno-37-11"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">rmap</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-37-12"><a id="__codelineno-37-12" name="__codelineno-37-12" href="#__codelineno-37-12"></a><span class="w">                </span><span class="n">LoadedApk</span><span class="p">.</span><span class="na">ReceiverDispatcher</span><span class="w"> </span><span class="n">rd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rmap</span><span class="p">.</span><span class="na">valueAt</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-37-13"><a id="__codelineno-37-13" name="__codelineno-37-13" href="#__codelineno-37-13"></a><span class="w">                </span><span class="n">IntentReceiverLeaked</span><span class="w"> </span><span class="n">leak</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IntentReceiverLeaked</span><span class="p">(</span>
</span><span id="__span-37-14"><a id="__codelineno-37-14" name="__codelineno-37-14" href="#__codelineno-37-14"></a><span class="w">                        </span><span class="n">what</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">who</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; has leaked IntentReceiver &quot;</span>
</span><span id="__span-37-15"><a id="__codelineno-37-15" name="__codelineno-37-15" href="#__codelineno-37-15"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">rd</span><span class="p">.</span><span class="na">getIntentReceiver</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; that was &quot;</span><span class="w"> </span><span class="o">+</span>
</span><span id="__span-37-16"><a id="__codelineno-37-16" name="__codelineno-37-16" href="#__codelineno-37-16"></a><span class="w">                        </span><span class="s">&quot;originally registered here. Are you missing a &quot;</span><span class="w"> </span><span class="o">+</span>
</span><span id="__span-37-17"><a id="__codelineno-37-17" name="__codelineno-37-17" href="#__codelineno-37-17"></a><span class="w">                        </span><span class="s">&quot;call to unregisterReceiver()?&quot;</span><span class="p">);</span>
</span><span id="__span-37-18"><a id="__codelineno-37-18" name="__codelineno-37-18" href="#__codelineno-37-18"></a><span class="w">                </span><span class="n">leak</span><span class="p">.</span><span class="na">setStackTrace</span><span class="p">(</span><span class="n">rd</span><span class="p">.</span><span class="na">getLocation</span><span class="p">().</span><span class="na">getStackTrace</span><span class="p">());</span>
</span><span id="__span-37-19"><a id="__codelineno-37-19" name="__codelineno-37-19" href="#__codelineno-37-19"></a><span class="w">                </span><span class="n">Slog</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="n">ActivityThread</span><span class="p">.</span><span class="na">TAG</span><span class="p">,</span><span class="w"> </span><span class="n">leak</span><span class="p">.</span><span class="na">getMessage</span><span class="p">(),</span><span class="w"> </span><span class="n">leak</span><span class="p">);</span>
</span><span id="__span-37-20"><a id="__codelineno-37-20" name="__codelineno-37-20" href="#__codelineno-37-20"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reportRegistrationLeaks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-37-21"><a id="__codelineno-37-21" name="__codelineno-37-21" href="#__codelineno-37-21"></a><span class="w">                    </span><span class="n">StrictMode</span><span class="p">.</span><span class="na">onIntentReceiverLeaked</span><span class="p">(</span><span class="n">leak</span><span class="p">);</span>
</span><span id="__span-37-22"><a id="__codelineno-37-22" name="__codelineno-37-22" href="#__codelineno-37-22"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-37-23"><a id="__codelineno-37-23" name="__codelineno-37-23" href="#__codelineno-37-23"></a><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-37-24"><a id="__codelineno-37-24" name="__codelineno-37-24" href="#__codelineno-37-24"></a><span class="w">                    </span><span class="c1">//调用AMS解注册</span>
</span><span id="__span-37-25"><a id="__codelineno-37-25" name="__codelineno-37-25" href="#__codelineno-37-25"></a><span class="w">                    </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">getService</span><span class="p">().</span><span class="na">unregisterReceiver</span><span class="p">(</span>
</span><span id="__span-37-26"><a id="__codelineno-37-26" name="__codelineno-37-26" href="#__codelineno-37-26"></a><span class="w">                            </span><span class="n">rd</span><span class="p">.</span><span class="na">getIIntentReceiver</span><span class="p">());</span>
</span><span id="__span-37-27"><a id="__codelineno-37-27" name="__codelineno-37-27" href="#__codelineno-37-27"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-37-28"><a id="__codelineno-37-28" name="__codelineno-37-28" href="#__codelineno-37-28"></a><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">rethrowFromSystemServer</span><span class="p">();</span>
</span><span id="__span-37-29"><a id="__codelineno-37-29" name="__codelineno-37-29" href="#__codelineno-37-29"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-37-30"><a id="__codelineno-37-30" name="__codelineno-37-30" href="#__codelineno-37-30"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-37-31"><a id="__codelineno-37-31" name="__codelineno-37-31" href="#__codelineno-37-31"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-37-32"><a id="__codelineno-37-32" name="__codelineno-37-32" href="#__codelineno-37-32"></a><span class="w">        </span><span class="n">mUnregisteredReceivers</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
</span><span id="__span-37-33"><a id="__codelineno-37-33" name="__codelineno-37-33" href="#__codelineno-37-33"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-37-34"><a id="__codelineno-37-34" name="__codelineno-37-34" href="#__codelineno-37-34"></a>
</span><span id="__span-37-35"><a id="__codelineno-37-35" name="__codelineno-37-35" href="#__codelineno-37-35"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-37-36"><a id="__codelineno-37-36" name="__codelineno-37-36" href="#__codelineno-37-36"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>mReceivers在前面动态注册流程LoadedApk.getReceiverDispatcher()中</li>
<li>判断是否解注册，如果没有则从mReceivers移除并调用AMS解注册</li>
</ul>
<h4 id="activitymanagerserviceunregisterreceiver">ActivityManagerService.unregisterReceiver<a class="headerlink" href="#activitymanagerserviceunregisterreceiver" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">unregisterReceiver</span><span class="p">(</span><span class="n">IIntentReceiver</span><span class="w"> </span><span class="n">receiver</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Unregister receiver: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">receiver</span><span class="p">);</span>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a>
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">origId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Binder</span><span class="p">.</span><span class="na">clearCallingIdentity</span><span class="p">();</span>
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-6"><a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">doTrim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-38-7"><a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a>
</span><span id="__span-38-8"><a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a><span class="w">        </span><span class="kd">synchronized</span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-9"><a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a><span class="w">            </span><span class="n">ReceiverList</span><span class="w"> </span><span class="n">rl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mRegisteredReceivers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">receiver</span><span class="p">.</span><span class="na">asBinder</span><span class="p">());</span>
</span><span id="__span-38-10"><a id="__codelineno-38-10" name="__codelineno-38-10" href="#__codelineno-38-10"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rl</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-11"><a id="__codelineno-38-11" name="__codelineno-38-11" href="#__codelineno-38-11"></a><span class="w">                </span><span class="kd">final</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rl</span><span class="p">.</span><span class="na">curBroadcast</span><span class="p">;</span>
</span><span id="__span-38-12"><a id="__codelineno-38-12" name="__codelineno-38-12" href="#__codelineno-38-12"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">queue</span><span class="p">.</span><span class="na">getMatchingOrderedReceiver</span><span class="p">(</span><span class="n">r</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-13"><a id="__codelineno-38-13" name="__codelineno-38-13" href="#__codelineno-38-13"></a><span class="w">                    </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">doNext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">queue</span><span class="p">.</span><span class="na">finishReceiverLocked</span><span class="p">(</span>
</span><span id="__span-38-14"><a id="__codelineno-38-14" name="__codelineno-38-14" href="#__codelineno-38-14"></a><span class="w">                            </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">resultCode</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">resultData</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">resultExtras</span><span class="p">,</span>
</span><span id="__span-38-15"><a id="__codelineno-38-15" name="__codelineno-38-15" href="#__codelineno-38-15"></a><span class="w">                            </span><span class="n">r</span><span class="p">.</span><span class="na">resultAbort</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
</span><span id="__span-38-16"><a id="__codelineno-38-16" name="__codelineno-38-16" href="#__codelineno-38-16"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">doNext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-17"><a id="__codelineno-38-17" name="__codelineno-38-17" href="#__codelineno-38-17"></a><span class="w">                        </span><span class="n">doTrim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-38-18"><a id="__codelineno-38-18" name="__codelineno-38-18" href="#__codelineno-38-18"></a><span class="w">                        </span><span class="n">r</span><span class="p">.</span><span class="na">queue</span><span class="p">.</span><span class="na">processNextBroadcastLocked</span><span class="p">(</span><span class="cm">/* frommsg */</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
</span><span id="__span-38-19"><a id="__codelineno-38-19" name="__codelineno-38-19" href="#__codelineno-38-19"></a><span class="w">                                </span><span class="cm">/* skipOomAdj */</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
</span><span id="__span-38-20"><a id="__codelineno-38-20" name="__codelineno-38-20" href="#__codelineno-38-20"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-38-21"><a id="__codelineno-38-21" name="__codelineno-38-21" href="#__codelineno-38-21"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-38-22"><a id="__codelineno-38-22" name="__codelineno-38-22" href="#__codelineno-38-22"></a>
</span><span id="__span-38-23"><a id="__codelineno-38-23" name="__codelineno-38-23" href="#__codelineno-38-23"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rl</span><span class="p">.</span><span class="na">app</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-24"><a id="__codelineno-38-24" name="__codelineno-38-24" href="#__codelineno-38-24"></a><span class="w">                    </span><span class="n">rl</span><span class="p">.</span><span class="na">app</span><span class="p">.</span><span class="na">mReceivers</span><span class="p">.</span><span class="na">removeReceiver</span><span class="p">(</span><span class="n">rl</span><span class="p">);</span>
</span><span id="__span-38-25"><a id="__codelineno-38-25" name="__codelineno-38-25" href="#__codelineno-38-25"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-38-26"><a id="__codelineno-38-26" name="__codelineno-38-26" href="#__codelineno-38-26"></a><span class="w">                </span><span class="n">removeReceiverLocked</span><span class="p">(</span><span class="n">rl</span><span class="p">);</span>
</span><span id="__span-38-27"><a id="__codelineno-38-27" name="__codelineno-38-27" href="#__codelineno-38-27"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rl</span><span class="p">.</span><span class="na">linkedToDeath</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-28"><a id="__codelineno-38-28" name="__codelineno-38-28" href="#__codelineno-38-28"></a><span class="w">                    </span><span class="n">rl</span><span class="p">.</span><span class="na">linkedToDeath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-38-29"><a id="__codelineno-38-29" name="__codelineno-38-29" href="#__codelineno-38-29"></a><span class="w">                    </span><span class="n">rl</span><span class="p">.</span><span class="na">receiver</span><span class="p">.</span><span class="na">asBinder</span><span class="p">().</span><span class="na">unlinkToDeath</span><span class="p">(</span><span class="n">rl</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-38-30"><a id="__codelineno-38-30" name="__codelineno-38-30" href="#__codelineno-38-30"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-38-31"><a id="__codelineno-38-31" name="__codelineno-38-31" href="#__codelineno-38-31"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-38-32"><a id="__codelineno-38-32" name="__codelineno-38-32" href="#__codelineno-38-32"></a>
</span><span id="__span-38-33"><a id="__codelineno-38-33" name="__codelineno-38-33" href="#__codelineno-38-33"></a><span class="w">            </span><span class="c1">// If we actually concluded any broadcasts, we might now be able</span>
</span><span id="__span-38-34"><a id="__codelineno-38-34" name="__codelineno-38-34" href="#__codelineno-38-34"></a><span class="w">            </span><span class="c1">// to trim the recipients&#39; apps from our working set</span>
</span><span id="__span-38-35"><a id="__codelineno-38-35" name="__codelineno-38-35" href="#__codelineno-38-35"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">doTrim</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-36"><a id="__codelineno-38-36" name="__codelineno-38-36" href="#__codelineno-38-36"></a><span class="w">                </span><span class="n">trimApplicationsLocked</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">OomAdjuster</span><span class="p">.</span><span class="na">OOM_ADJ_REASON_FINISH_RECEIVER</span><span class="p">);</span>
</span><span id="__span-38-37"><a id="__codelineno-38-37" name="__codelineno-38-37" href="#__codelineno-38-37"></a><span class="w">                </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-38-38"><a id="__codelineno-38-38" name="__codelineno-38-38" href="#__codelineno-38-38"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-38-39"><a id="__codelineno-38-39" name="__codelineno-38-39" href="#__codelineno-38-39"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-38-40"><a id="__codelineno-38-40" name="__codelineno-38-40" href="#__codelineno-38-40"></a>
</span><span id="__span-38-41"><a id="__codelineno-38-41" name="__codelineno-38-41" href="#__codelineno-38-41"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-42"><a id="__codelineno-38-42" name="__codelineno-38-42" href="#__codelineno-38-42"></a><span class="w">        </span><span class="n">Binder</span><span class="p">.</span><span class="na">restoreCallingIdentity</span><span class="p">(</span><span class="n">origId</span><span class="p">);</span>
</span><span id="__span-38-43"><a id="__codelineno-38-43" name="__codelineno-38-43" href="#__codelineno-38-43"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-38-44"><a id="__codelineno-38-44" name="__codelineno-38-44" href="#__codelineno-38-44"></a><span class="p">}</span>
</span><span id="__span-38-45"><a id="__codelineno-38-45" name="__codelineno-38-45" href="#__codelineno-38-45"></a>
</span><span id="__span-38-46"><a id="__codelineno-38-46" name="__codelineno-38-46" href="#__codelineno-38-46"></a><span class="kt">void</span><span class="w"> </span><span class="nf">removeReceiverLocked</span><span class="p">(</span><span class="n">ReceiverList</span><span class="w"> </span><span class="n">rl</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-47"><a id="__codelineno-38-47" name="__codelineno-38-47" href="#__codelineno-38-47"></a><span class="w">    </span><span class="n">mRegisteredReceivers</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">rl</span><span class="p">.</span><span class="na">receiver</span><span class="p">.</span><span class="na">asBinder</span><span class="p">());</span>
</span><span id="__span-38-48"><a id="__codelineno-38-48" name="__codelineno-38-48" href="#__codelineno-38-48"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rl</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-49"><a id="__codelineno-38-49" name="__codelineno-38-49" href="#__codelineno-38-49"></a><span class="w">        </span><span class="n">mReceiverResolver</span><span class="p">.</span><span class="na">removeFilter</span><span class="p">(</span><span class="n">rl</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
</span><span id="__span-38-50"><a id="__codelineno-38-50" name="__codelineno-38-50" href="#__codelineno-38-50"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-38-51"><a id="__codelineno-38-51" name="__codelineno-38-51" href="#__codelineno-38-51"></a><span class="p">}</span>
</span></code></pre></div>
<p>前面提到过AMS把所有动态注册的receiver保存到mRegisteredReceivers，所以解注册的时候移除掉就可以了。</p>
<h2 id="_26">发送广播流程<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h2>
<p>发送广播是在Activity或Service中调用sendBroadcast()方法，而Activity或Service都间接继承于Context抽象类，真正干活是交给ContextImpl类。</p>
<h3 id="contextimplsendbroadcast">ContextImpl.sendBroadcast<a class="headerlink" href="#contextimplsendbroadcast" title="Permanent link">&para;</a></h3>
<div class="language-java highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="n">ContextImpl</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a>
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="nd">@Override</span>
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendBroadcast</span><span class="p">(</span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="w">    </span><span class="n">warnIfCallingFromSystemProcess</span><span class="p">();</span>
</span><span id="__span-39-6"><a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">resolvedType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">resolveTypeIfNeeded</span><span class="p">(</span><span class="n">getContentResolver</span><span class="p">());</span>
</span><span id="__span-39-7"><a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-8"><a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a><span class="w">        </span><span class="n">intent</span><span class="p">.</span><span class="na">prepareToLeaveProcess</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span id="__span-39-9"><a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a><span class="w">        </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">getService</span><span class="p">().</span><span class="na">broadcastIntentWithFeature</span><span class="p">(</span>
</span><span id="__span-39-10"><a id="__codelineno-39-10" name="__codelineno-39-10" href="#__codelineno-39-10"></a><span class="w">                </span><span class="n">mMainThread</span><span class="p">.</span><span class="na">getApplicationThread</span><span class="p">(),</span><span class="w"> </span><span class="n">getAttributionTag</span><span class="p">(),</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">resolvedType</span><span class="p">,</span>
</span><span id="__span-39-11"><a id="__codelineno-39-11" name="__codelineno-39-11" href="#__codelineno-39-11"></a><span class="w">                </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">Activity</span><span class="p">.</span><span class="na">RESULT_OK</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="cm">/*excludedPermissions=*/</span><span class="p">,</span>
</span><span id="__span-39-12"><a id="__codelineno-39-12" name="__codelineno-39-12" href="#__codelineno-39-12"></a><span class="w">                </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">OP_NONE</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">getUserId</span><span class="p">());</span>
</span><span id="__span-39-13"><a id="__codelineno-39-13" name="__codelineno-39-13" href="#__codelineno-39-13"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-14"><a id="__codelineno-39-14" name="__codelineno-39-14" href="#__codelineno-39-14"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">rethrowFromSystemServer</span><span class="p">();</span>
</span><span id="__span-39-15"><a id="__codelineno-39-15" name="__codelineno-39-15" href="#__codelineno-39-15"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-39-16"><a id="__codelineno-39-16" name="__codelineno-39-16" href="#__codelineno-39-16"></a><span class="p">}</span>
</span><span id="__span-39-17"><a id="__codelineno-39-17" name="__codelineno-39-17" href="#__codelineno-39-17"></a>
</span><span id="__span-39-18"><a id="__codelineno-39-18" name="__codelineno-39-18" href="#__codelineno-39-18"></a><span class="nd">@Override</span>
</span><span id="__span-39-19"><a id="__codelineno-39-19" name="__codelineno-39-19" href="#__codelineno-39-19"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendBroadcast</span><span class="p">(</span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">receiverPermission</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-20"><a id="__codelineno-39-20" name="__codelineno-39-20" href="#__codelineno-39-20"></a><span class="w">    </span><span class="n">warnIfCallingFromSystemProcess</span><span class="p">();</span>
</span><span id="__span-39-21"><a id="__codelineno-39-21" name="__codelineno-39-21" href="#__codelineno-39-21"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">resolvedType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">resolveTypeIfNeeded</span><span class="p">(</span><span class="n">getContentResolver</span><span class="p">());</span>
</span><span id="__span-39-22"><a id="__codelineno-39-22" name="__codelineno-39-22" href="#__codelineno-39-22"></a><span class="w">    </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">receiverPermissions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">receiverPermission</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kc">null</span>
</span><span id="__span-39-23"><a id="__codelineno-39-23" name="__codelineno-39-23" href="#__codelineno-39-23"></a><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="n">receiverPermission</span><span class="p">};</span>
</span><span id="__span-39-24"><a id="__codelineno-39-24" name="__codelineno-39-24" href="#__codelineno-39-24"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-25"><a id="__codelineno-39-25" name="__codelineno-39-25" href="#__codelineno-39-25"></a><span class="w">        </span><span class="n">intent</span><span class="p">.</span><span class="na">prepareToLeaveProcess</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span id="__span-39-26"><a id="__codelineno-39-26" name="__codelineno-39-26" href="#__codelineno-39-26"></a><span class="w">        </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">getService</span><span class="p">().</span><span class="na">broadcastIntentWithFeature</span><span class="p">(</span>
</span><span id="__span-39-27"><a id="__codelineno-39-27" name="__codelineno-39-27" href="#__codelineno-39-27"></a><span class="w">                </span><span class="n">mMainThread</span><span class="p">.</span><span class="na">getApplicationThread</span><span class="p">(),</span><span class="w"> </span><span class="n">getAttributionTag</span><span class="p">(),</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">resolvedType</span><span class="p">,</span>
</span><span id="__span-39-28"><a id="__codelineno-39-28" name="__codelineno-39-28" href="#__codelineno-39-28"></a><span class="w">                </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">Activity</span><span class="p">.</span><span class="na">RESULT_OK</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">receiverPermissions</span><span class="p">,</span>
</span><span id="__span-39-29"><a id="__codelineno-39-29" name="__codelineno-39-29" href="#__codelineno-39-29"></a><span class="w">                </span><span class="kc">null</span><span class="w"> </span><span class="cm">/*excludedPermissions=*/</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">OP_NONE</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
</span><span id="__span-39-30"><a id="__codelineno-39-30" name="__codelineno-39-30" href="#__codelineno-39-30"></a><span class="w">                </span><span class="n">getUserId</span><span class="p">());</span>
</span><span id="__span-39-31"><a id="__codelineno-39-31" name="__codelineno-39-31" href="#__codelineno-39-31"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-32"><a id="__codelineno-39-32" name="__codelineno-39-32" href="#__codelineno-39-32"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">rethrowFromSystemServer</span><span class="p">();</span>
</span><span id="__span-39-33"><a id="__codelineno-39-33" name="__codelineno-39-33" href="#__codelineno-39-33"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-39-34"><a id="__codelineno-39-34" name="__codelineno-39-34" href="#__codelineno-39-34"></a><span class="p">}</span>
</span><span id="__span-39-35"><a id="__codelineno-39-35" name="__codelineno-39-35" href="#__codelineno-39-35"></a>
</span><span id="__span-39-36"><a id="__codelineno-39-36" name="__codelineno-39-36" href="#__codelineno-39-36"></a><span class="nd">@Override</span>
</span><span id="__span-39-37"><a id="__codelineno-39-37" name="__codelineno-39-37" href="#__codelineno-39-37"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendBroadcastMultiplePermissions</span><span class="p">(</span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">receiverPermissions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-38"><a id="__codelineno-39-38" name="__codelineno-39-38" href="#__codelineno-39-38"></a><span class="w">    </span><span class="n">warnIfCallingFromSystemProcess</span><span class="p">();</span>
</span><span id="__span-39-39"><a id="__codelineno-39-39" name="__codelineno-39-39" href="#__codelineno-39-39"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">resolvedType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">resolveTypeIfNeeded</span><span class="p">(</span><span class="n">getContentResolver</span><span class="p">());</span>
</span><span id="__span-39-40"><a id="__codelineno-39-40" name="__codelineno-39-40" href="#__codelineno-39-40"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-41"><a id="__codelineno-39-41" name="__codelineno-39-41" href="#__codelineno-39-41"></a><span class="w">        </span><span class="n">intent</span><span class="p">.</span><span class="na">prepareToLeaveProcess</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span id="__span-39-42"><a id="__codelineno-39-42" name="__codelineno-39-42" href="#__codelineno-39-42"></a><span class="w">        </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">getService</span><span class="p">().</span><span class="na">broadcastIntentWithFeature</span><span class="p">(</span>
</span><span id="__span-39-43"><a id="__codelineno-39-43" name="__codelineno-39-43" href="#__codelineno-39-43"></a><span class="w">                </span><span class="n">mMainThread</span><span class="p">.</span><span class="na">getApplicationThread</span><span class="p">(),</span><span class="w"> </span><span class="n">getAttributionTag</span><span class="p">(),</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">resolvedType</span><span class="p">,</span>
</span><span id="__span-39-44"><a id="__codelineno-39-44" name="__codelineno-39-44" href="#__codelineno-39-44"></a><span class="w">                </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">Activity</span><span class="p">.</span><span class="na">RESULT_OK</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">receiverPermissions</span><span class="p">,</span>
</span><span id="__span-39-45"><a id="__codelineno-39-45" name="__codelineno-39-45" href="#__codelineno-39-45"></a><span class="w">                </span><span class="kc">null</span><span class="w"> </span><span class="cm">/*excludedPermissions=*/</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">OP_NONE</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
</span><span id="__span-39-46"><a id="__codelineno-39-46" name="__codelineno-39-46" href="#__codelineno-39-46"></a><span class="w">                </span><span class="n">getUserId</span><span class="p">());</span>
</span><span id="__span-39-47"><a id="__codelineno-39-47" name="__codelineno-39-47" href="#__codelineno-39-47"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-48"><a id="__codelineno-39-48" name="__codelineno-39-48" href="#__codelineno-39-48"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">rethrowFromSystemServer</span><span class="p">();</span>
</span><span id="__span-39-49"><a id="__codelineno-39-49" name="__codelineno-39-49" href="#__codelineno-39-49"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-39-50"><a id="__codelineno-39-50" name="__codelineno-39-50" href="#__codelineno-39-50"></a><span class="p">}</span>
</span><span id="__span-39-51"><a id="__codelineno-39-51" name="__codelineno-39-51" href="#__codelineno-39-51"></a>
</span><span id="__span-39-52"><a id="__codelineno-39-52" name="__codelineno-39-52" href="#__codelineno-39-52"></a><span class="nd">@Override</span>
</span><span id="__span-39-53"><a id="__codelineno-39-53" name="__codelineno-39-53" href="#__codelineno-39-53"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendBroadcastMultiplePermissions</span><span class="p">(</span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">receiverPermissions</span><span class="p">,</span>
</span><span id="__span-39-54"><a id="__codelineno-39-54" name="__codelineno-39-54" href="#__codelineno-39-54"></a><span class="w">        </span><span class="n">Bundle</span><span class="w"> </span><span class="n">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-55"><a id="__codelineno-39-55" name="__codelineno-39-55" href="#__codelineno-39-55"></a><span class="w">    </span><span class="n">warnIfCallingFromSystemProcess</span><span class="p">();</span>
</span><span id="__span-39-56"><a id="__codelineno-39-56" name="__codelineno-39-56" href="#__codelineno-39-56"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">resolvedType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">resolveTypeIfNeeded</span><span class="p">(</span><span class="n">getContentResolver</span><span class="p">());</span>
</span><span id="__span-39-57"><a id="__codelineno-39-57" name="__codelineno-39-57" href="#__codelineno-39-57"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-58"><a id="__codelineno-39-58" name="__codelineno-39-58" href="#__codelineno-39-58"></a><span class="w">        </span><span class="n">intent</span><span class="p">.</span><span class="na">prepareToLeaveProcess</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span id="__span-39-59"><a id="__codelineno-39-59" name="__codelineno-39-59" href="#__codelineno-39-59"></a><span class="w">        </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">getService</span><span class="p">().</span><span class="na">broadcastIntentWithFeature</span><span class="p">(</span>
</span><span id="__span-39-60"><a id="__codelineno-39-60" name="__codelineno-39-60" href="#__codelineno-39-60"></a><span class="w">                </span><span class="n">mMainThread</span><span class="p">.</span><span class="na">getApplicationThread</span><span class="p">(),</span><span class="w"> </span><span class="n">getAttributionTag</span><span class="p">(),</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">resolvedType</span><span class="p">,</span>
</span><span id="__span-39-61"><a id="__codelineno-39-61" name="__codelineno-39-61" href="#__codelineno-39-61"></a><span class="w">                </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">Activity</span><span class="p">.</span><span class="na">RESULT_OK</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">receiverPermissions</span><span class="p">,</span>
</span><span id="__span-39-62"><a id="__codelineno-39-62" name="__codelineno-39-62" href="#__codelineno-39-62"></a><span class="w">                </span><span class="kc">null</span><span class="w"> </span><span class="cm">/*excludedPermissions=*/</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="cm">/*excludedPackages*/</span><span class="p">,</span>
</span><span id="__span-39-63"><a id="__codelineno-39-63" name="__codelineno-39-63" href="#__codelineno-39-63"></a><span class="w">                </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">OP_NONE</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">getUserId</span><span class="p">());</span>
</span><span id="__span-39-64"><a id="__codelineno-39-64" name="__codelineno-39-64" href="#__codelineno-39-64"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-65"><a id="__codelineno-39-65" name="__codelineno-39-65" href="#__codelineno-39-65"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">rethrowFromSystemServer</span><span class="p">();</span>
</span><span id="__span-39-66"><a id="__codelineno-39-66" name="__codelineno-39-66" href="#__codelineno-39-66"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-39-67"><a id="__codelineno-39-67" name="__codelineno-39-67" href="#__codelineno-39-67"></a><span class="p">}</span>
</span><span id="__span-39-68"><a id="__codelineno-39-68" name="__codelineno-39-68" href="#__codelineno-39-68"></a>
</span><span id="__span-39-69"><a id="__codelineno-39-69" name="__codelineno-39-69" href="#__codelineno-39-69"></a><span class="nd">@Override</span>
</span><span id="__span-39-70"><a id="__codelineno-39-70" name="__codelineno-39-70" href="#__codelineno-39-70"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendBroadcastAsUserMultiplePermissions</span><span class="p">(</span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">UserHandle</span><span class="w"> </span><span class="n">user</span><span class="p">,</span>
</span><span id="__span-39-71"><a id="__codelineno-39-71" name="__codelineno-39-71" href="#__codelineno-39-71"></a><span class="w">        </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">receiverPermissions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-72"><a id="__codelineno-39-72" name="__codelineno-39-72" href="#__codelineno-39-72"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">resolvedType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">resolveTypeIfNeeded</span><span class="p">(</span><span class="n">getContentResolver</span><span class="p">());</span>
</span><span id="__span-39-73"><a id="__codelineno-39-73" name="__codelineno-39-73" href="#__codelineno-39-73"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-74"><a id="__codelineno-39-74" name="__codelineno-39-74" href="#__codelineno-39-74"></a><span class="w">        </span><span class="n">intent</span><span class="p">.</span><span class="na">prepareToLeaveProcess</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span id="__span-39-75"><a id="__codelineno-39-75" name="__codelineno-39-75" href="#__codelineno-39-75"></a><span class="w">        </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">getService</span><span class="p">().</span><span class="na">broadcastIntentWithFeature</span><span class="p">(</span>
</span><span id="__span-39-76"><a id="__codelineno-39-76" name="__codelineno-39-76" href="#__codelineno-39-76"></a><span class="w">                </span><span class="n">mMainThread</span><span class="p">.</span><span class="na">getApplicationThread</span><span class="p">(),</span><span class="w"> </span><span class="n">getAttributionTag</span><span class="p">(),</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">resolvedType</span><span class="p">,</span>
</span><span id="__span-39-77"><a id="__codelineno-39-77" name="__codelineno-39-77" href="#__codelineno-39-77"></a><span class="w">                </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">Activity</span><span class="p">.</span><span class="na">RESULT_OK</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">receiverPermissions</span><span class="p">,</span>
</span><span id="__span-39-78"><a id="__codelineno-39-78" name="__codelineno-39-78" href="#__codelineno-39-78"></a><span class="w">                </span><span class="kc">null</span><span class="w"> </span><span class="cm">/*excludedPermissions=*/</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">OP_NONE</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
</span><span id="__span-39-79"><a id="__codelineno-39-79" name="__codelineno-39-79" href="#__codelineno-39-79"></a><span class="w">                </span><span class="n">user</span><span class="p">.</span><span class="na">getIdentifier</span><span class="p">());</span>
</span><span id="__span-39-80"><a id="__codelineno-39-80" name="__codelineno-39-80" href="#__codelineno-39-80"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-81"><a id="__codelineno-39-81" name="__codelineno-39-81" href="#__codelineno-39-81"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">rethrowFromSystemServer</span><span class="p">();</span>
</span><span id="__span-39-82"><a id="__codelineno-39-82" name="__codelineno-39-82" href="#__codelineno-39-82"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-39-83"><a id="__codelineno-39-83" name="__codelineno-39-83" href="#__codelineno-39-83"></a><span class="p">}</span>
</span><span id="__span-39-84"><a id="__codelineno-39-84" name="__codelineno-39-84" href="#__codelineno-39-84"></a>
</span><span id="__span-39-85"><a id="__codelineno-39-85" name="__codelineno-39-85" href="#__codelineno-39-85"></a><span class="nd">@Override</span>
</span><span id="__span-39-86"><a id="__codelineno-39-86" name="__codelineno-39-86" href="#__codelineno-39-86"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendBroadcastMultiplePermissions</span><span class="p">(</span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">receiverPermissions</span><span class="p">,</span>
</span><span id="__span-39-87"><a id="__codelineno-39-87" name="__codelineno-39-87" href="#__codelineno-39-87"></a><span class="w">        </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">excludedPermissions</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">excludedPackages</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-88"><a id="__codelineno-39-88" name="__codelineno-39-88" href="#__codelineno-39-88"></a><span class="w">    </span><span class="n">warnIfCallingFromSystemProcess</span><span class="p">();</span>
</span><span id="__span-39-89"><a id="__codelineno-39-89" name="__codelineno-39-89" href="#__codelineno-39-89"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">resolvedType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">resolveTypeIfNeeded</span><span class="p">(</span><span class="n">getContentResolver</span><span class="p">());</span>
</span><span id="__span-39-90"><a id="__codelineno-39-90" name="__codelineno-39-90" href="#__codelineno-39-90"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-91"><a id="__codelineno-39-91" name="__codelineno-39-91" href="#__codelineno-39-91"></a><span class="w">        </span><span class="n">intent</span><span class="p">.</span><span class="na">prepareToLeaveProcess</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span id="__span-39-92"><a id="__codelineno-39-92" name="__codelineno-39-92" href="#__codelineno-39-92"></a><span class="w">        </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">getService</span><span class="p">().</span><span class="na">broadcastIntentWithFeature</span><span class="p">(</span>
</span><span id="__span-39-93"><a id="__codelineno-39-93" name="__codelineno-39-93" href="#__codelineno-39-93"></a><span class="w">                </span><span class="n">mMainThread</span><span class="p">.</span><span class="na">getApplicationThread</span><span class="p">(),</span><span class="w"> </span><span class="n">getAttributionTag</span><span class="p">(),</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">resolvedType</span><span class="p">,</span>
</span><span id="__span-39-94"><a id="__codelineno-39-94" name="__codelineno-39-94" href="#__codelineno-39-94"></a><span class="w">                </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">Activity</span><span class="p">.</span><span class="na">RESULT_OK</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">receiverPermissions</span><span class="p">,</span><span class="w"> </span><span class="n">excludedPermissions</span><span class="p">,</span>
</span><span id="__span-39-95"><a id="__codelineno-39-95" name="__codelineno-39-95" href="#__codelineno-39-95"></a><span class="w">                </span><span class="n">excludedPackages</span><span class="p">,</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">OP_NONE</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">getUserId</span><span class="p">());</span>
</span><span id="__span-39-96"><a id="__codelineno-39-96" name="__codelineno-39-96" href="#__codelineno-39-96"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-97"><a id="__codelineno-39-97" name="__codelineno-39-97" href="#__codelineno-39-97"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">rethrowFromSystemServer</span><span class="p">();</span>
</span><span id="__span-39-98"><a id="__codelineno-39-98" name="__codelineno-39-98" href="#__codelineno-39-98"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-39-99"><a id="__codelineno-39-99" name="__codelineno-39-99" href="#__codelineno-39-99"></a><span class="p">}</span>
</span><span id="__span-39-100"><a id="__codelineno-39-100" name="__codelineno-39-100" href="#__codelineno-39-100"></a>
</span><span id="__span-39-101"><a id="__codelineno-39-101" name="__codelineno-39-101" href="#__codelineno-39-101"></a><span class="nd">@Override</span>
</span><span id="__span-39-102"><a id="__codelineno-39-102" name="__codelineno-39-102" href="#__codelineno-39-102"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendBroadcast</span><span class="p">(</span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">receiverPermission</span><span class="p">,</span><span class="w"> </span><span class="n">Bundle</span><span class="w"> </span><span class="n">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-103"><a id="__codelineno-39-103" name="__codelineno-39-103" href="#__codelineno-39-103"></a><span class="w">    </span><span class="n">warnIfCallingFromSystemProcess</span><span class="p">();</span>
</span><span id="__span-39-104"><a id="__codelineno-39-104" name="__codelineno-39-104" href="#__codelineno-39-104"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">resolvedType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">resolveTypeIfNeeded</span><span class="p">(</span><span class="n">getContentResolver</span><span class="p">());</span>
</span><span id="__span-39-105"><a id="__codelineno-39-105" name="__codelineno-39-105" href="#__codelineno-39-105"></a><span class="w">    </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">receiverPermissions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">receiverPermission</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kc">null</span>
</span><span id="__span-39-106"><a id="__codelineno-39-106" name="__codelineno-39-106" href="#__codelineno-39-106"></a><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="n">receiverPermission</span><span class="p">};</span>
</span><span id="__span-39-107"><a id="__codelineno-39-107" name="__codelineno-39-107" href="#__codelineno-39-107"></a><span class="w">    </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">excludedPermissions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-39-108"><a id="__codelineno-39-108" name="__codelineno-39-108" href="#__codelineno-39-108"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">options</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-109"><a id="__codelineno-39-109" name="__codelineno-39-109" href="#__codelineno-39-109"></a><span class="w">        </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">receiverPermissionsBundle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="na">getStringArray</span><span class="p">(</span>
</span><span id="__span-39-110"><a id="__codelineno-39-110" name="__codelineno-39-110" href="#__codelineno-39-110"></a><span class="w">                </span><span class="n">BroadcastOptions</span><span class="p">.</span><span class="na">KEY_REQUIRE_ALL_OF_PERMISSIONS</span><span class="p">);</span>
</span><span id="__span-39-111"><a id="__codelineno-39-111" name="__codelineno-39-111" href="#__codelineno-39-111"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">receiverPermissionsBundle</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-112"><a id="__codelineno-39-112" name="__codelineno-39-112" href="#__codelineno-39-112"></a><span class="w">            </span><span class="n">receiverPermissions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">receiverPermissionsBundle</span><span class="p">;</span>
</span><span id="__span-39-113"><a id="__codelineno-39-113" name="__codelineno-39-113" href="#__codelineno-39-113"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-39-114"><a id="__codelineno-39-114" name="__codelineno-39-114" href="#__codelineno-39-114"></a><span class="w">        </span><span class="n">excludedPermissions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="na">getStringArray</span><span class="p">(</span>
</span><span id="__span-39-115"><a id="__codelineno-39-115" name="__codelineno-39-115" href="#__codelineno-39-115"></a><span class="w">                </span><span class="n">BroadcastOptions</span><span class="p">.</span><span class="na">KEY_REQUIRE_NONE_OF_PERMISSIONS</span><span class="p">);</span>
</span><span id="__span-39-116"><a id="__codelineno-39-116" name="__codelineno-39-116" href="#__codelineno-39-116"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-39-117"><a id="__codelineno-39-117" name="__codelineno-39-117" href="#__codelineno-39-117"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-118"><a id="__codelineno-39-118" name="__codelineno-39-118" href="#__codelineno-39-118"></a><span class="w">        </span><span class="n">intent</span><span class="p">.</span><span class="na">prepareToLeaveProcess</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span id="__span-39-119"><a id="__codelineno-39-119" name="__codelineno-39-119" href="#__codelineno-39-119"></a><span class="w">        </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">getService</span><span class="p">().</span><span class="na">broadcastIntentWithFeature</span><span class="p">(</span>
</span><span id="__span-39-120"><a id="__codelineno-39-120" name="__codelineno-39-120" href="#__codelineno-39-120"></a><span class="w">                </span><span class="n">mMainThread</span><span class="p">.</span><span class="na">getApplicationThread</span><span class="p">(),</span><span class="w"> </span><span class="n">getAttributionTag</span><span class="p">(),</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">resolvedType</span><span class="p">,</span>
</span><span id="__span-39-121"><a id="__codelineno-39-121" name="__codelineno-39-121" href="#__codelineno-39-121"></a><span class="w">                </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">Activity</span><span class="p">.</span><span class="na">RESULT_OK</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">receiverPermissions</span><span class="p">,</span>
</span><span id="__span-39-122"><a id="__codelineno-39-122" name="__codelineno-39-122" href="#__codelineno-39-122"></a><span class="w">                </span><span class="n">excludedPermissions</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">OP_NONE</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
</span><span id="__span-39-123"><a id="__codelineno-39-123" name="__codelineno-39-123" href="#__codelineno-39-123"></a><span class="w">                </span><span class="n">getUserId</span><span class="p">());</span>
</span><span id="__span-39-124"><a id="__codelineno-39-124" name="__codelineno-39-124" href="#__codelineno-39-124"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-125"><a id="__codelineno-39-125" name="__codelineno-39-125" href="#__codelineno-39-125"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">rethrowFromSystemServer</span><span class="p">();</span>
</span><span id="__span-39-126"><a id="__codelineno-39-126" name="__codelineno-39-126" href="#__codelineno-39-126"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-39-127"><a id="__codelineno-39-127" name="__codelineno-39-127" href="#__codelineno-39-127"></a><span class="p">}</span>
</span><span id="__span-39-128"><a id="__codelineno-39-128" name="__codelineno-39-128" href="#__codelineno-39-128"></a>
</span><span id="__span-39-129"><a id="__codelineno-39-129" name="__codelineno-39-129" href="#__codelineno-39-129"></a><span class="nd">@Override</span>
</span><span id="__span-39-130"><a id="__codelineno-39-130" name="__codelineno-39-130" href="#__codelineno-39-130"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendBroadcast</span><span class="p">(</span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">receiverPermission</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">appOp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-131"><a id="__codelineno-39-131" name="__codelineno-39-131" href="#__codelineno-39-131"></a><span class="w">    </span><span class="n">warnIfCallingFromSystemProcess</span><span class="p">();</span>
</span><span id="__span-39-132"><a id="__codelineno-39-132" name="__codelineno-39-132" href="#__codelineno-39-132"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">resolvedType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">resolveTypeIfNeeded</span><span class="p">(</span><span class="n">getContentResolver</span><span class="p">());</span>
</span><span id="__span-39-133"><a id="__codelineno-39-133" name="__codelineno-39-133" href="#__codelineno-39-133"></a><span class="w">    </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">receiverPermissions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">receiverPermission</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kc">null</span>
</span><span id="__span-39-134"><a id="__codelineno-39-134" name="__codelineno-39-134" href="#__codelineno-39-134"></a><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="n">receiverPermission</span><span class="p">};</span>
</span><span id="__span-39-135"><a id="__codelineno-39-135" name="__codelineno-39-135" href="#__codelineno-39-135"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-136"><a id="__codelineno-39-136" name="__codelineno-39-136" href="#__codelineno-39-136"></a><span class="w">        </span><span class="n">intent</span><span class="p">.</span><span class="na">prepareToLeaveProcess</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span id="__span-39-137"><a id="__codelineno-39-137" name="__codelineno-39-137" href="#__codelineno-39-137"></a><span class="w">        </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">getService</span><span class="p">().</span><span class="na">broadcastIntentWithFeature</span><span class="p">(</span>
</span><span id="__span-39-138"><a id="__codelineno-39-138" name="__codelineno-39-138" href="#__codelineno-39-138"></a><span class="w">                </span><span class="n">mMainThread</span><span class="p">.</span><span class="na">getApplicationThread</span><span class="p">(),</span><span class="w"> </span><span class="n">getAttributionTag</span><span class="p">(),</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">resolvedType</span><span class="p">,</span>
</span><span id="__span-39-139"><a id="__codelineno-39-139" name="__codelineno-39-139" href="#__codelineno-39-139"></a><span class="w">                </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">Activity</span><span class="p">.</span><span class="na">RESULT_OK</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">receiverPermissions</span><span class="p">,</span>
</span><span id="__span-39-140"><a id="__codelineno-39-140" name="__codelineno-39-140" href="#__codelineno-39-140"></a><span class="w">                </span><span class="kc">null</span><span class="w"> </span><span class="cm">/*excludedPermissions=*/</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">appOp</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">getUserId</span><span class="p">());</span>
</span><span id="__span-39-141"><a id="__codelineno-39-141" name="__codelineno-39-141" href="#__codelineno-39-141"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-142"><a id="__codelineno-39-142" name="__codelineno-39-142" href="#__codelineno-39-142"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">rethrowFromSystemServer</span><span class="p">();</span>
</span><span id="__span-39-143"><a id="__codelineno-39-143" name="__codelineno-39-143" href="#__codelineno-39-143"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-39-144"><a id="__codelineno-39-144" name="__codelineno-39-144" href="#__codelineno-39-144"></a><span class="p">}</span>
</span><span id="__span-39-145"><a id="__codelineno-39-145" name="__codelineno-39-145" href="#__codelineno-39-145"></a>
</span><span id="__span-39-146"><a id="__codelineno-39-146" name="__codelineno-39-146" href="#__codelineno-39-146"></a><span class="nd">@Override</span>
</span><span id="__span-39-147"><a id="__codelineno-39-147" name="__codelineno-39-147" href="#__codelineno-39-147"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendOrderedBroadcast</span><span class="p">(</span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">receiverPermission</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-148"><a id="__codelineno-39-148" name="__codelineno-39-148" href="#__codelineno-39-148"></a><span class="w">    </span><span class="n">warnIfCallingFromSystemProcess</span><span class="p">();</span>
</span><span id="__span-39-149"><a id="__codelineno-39-149" name="__codelineno-39-149" href="#__codelineno-39-149"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">resolvedType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">resolveTypeIfNeeded</span><span class="p">(</span><span class="n">getContentResolver</span><span class="p">());</span>
</span><span id="__span-39-150"><a id="__codelineno-39-150" name="__codelineno-39-150" href="#__codelineno-39-150"></a><span class="w">    </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">receiverPermissions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">receiverPermission</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kc">null</span>
</span><span id="__span-39-151"><a id="__codelineno-39-151" name="__codelineno-39-151" href="#__codelineno-39-151"></a><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="n">receiverPermission</span><span class="p">};</span>
</span><span id="__span-39-152"><a id="__codelineno-39-152" name="__codelineno-39-152" href="#__codelineno-39-152"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-153"><a id="__codelineno-39-153" name="__codelineno-39-153" href="#__codelineno-39-153"></a><span class="w">        </span><span class="n">intent</span><span class="p">.</span><span class="na">prepareToLeaveProcess</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span id="__span-39-154"><a id="__codelineno-39-154" name="__codelineno-39-154" href="#__codelineno-39-154"></a><span class="w">        </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">getService</span><span class="p">().</span><span class="na">broadcastIntentWithFeature</span><span class="p">(</span>
</span><span id="__span-39-155"><a id="__codelineno-39-155" name="__codelineno-39-155" href="#__codelineno-39-155"></a><span class="w">                </span><span class="n">mMainThread</span><span class="p">.</span><span class="na">getApplicationThread</span><span class="p">(),</span><span class="w"> </span><span class="n">getAttributionTag</span><span class="p">(),</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">resolvedType</span><span class="p">,</span>
</span><span id="__span-39-156"><a id="__codelineno-39-156" name="__codelineno-39-156" href="#__codelineno-39-156"></a><span class="w">                </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">Activity</span><span class="p">.</span><span class="na">RESULT_OK</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">receiverPermissions</span><span class="p">,</span>
</span><span id="__span-39-157"><a id="__codelineno-39-157" name="__codelineno-39-157" href="#__codelineno-39-157"></a><span class="w">                </span><span class="kc">null</span><span class="w"> </span><span class="cm">/*excludedPermissions=*/</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">OP_NONE</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
</span><span id="__span-39-158"><a id="__codelineno-39-158" name="__codelineno-39-158" href="#__codelineno-39-158"></a><span class="w">                </span><span class="n">getUserId</span><span class="p">());</span>
</span><span id="__span-39-159"><a id="__codelineno-39-159" name="__codelineno-39-159" href="#__codelineno-39-159"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-160"><a id="__codelineno-39-160" name="__codelineno-39-160" href="#__codelineno-39-160"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">rethrowFromSystemServer</span><span class="p">();</span>
</span><span id="__span-39-161"><a id="__codelineno-39-161" name="__codelineno-39-161" href="#__codelineno-39-161"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-39-162"><a id="__codelineno-39-162" name="__codelineno-39-162" href="#__codelineno-39-162"></a><span class="p">}</span>
</span><span id="__span-39-163"><a id="__codelineno-39-163" name="__codelineno-39-163" href="#__codelineno-39-163"></a>
</span><span id="__span-39-164"><a id="__codelineno-39-164" name="__codelineno-39-164" href="#__codelineno-39-164"></a><span class="nd">@Override</span>
</span><span id="__span-39-165"><a id="__codelineno-39-165" name="__codelineno-39-165" href="#__codelineno-39-165"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendOrderedBroadcast</span><span class="p">(</span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span>
</span><span id="__span-39-166"><a id="__codelineno-39-166" name="__codelineno-39-166" href="#__codelineno-39-166"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">receiverPermission</span><span class="p">,</span><span class="w"> </span><span class="n">BroadcastReceiver</span><span class="w"> </span><span class="n">resultReceiver</span><span class="p">,</span>
</span><span id="__span-39-167"><a id="__codelineno-39-167" name="__codelineno-39-167" href="#__codelineno-39-167"></a><span class="w">        </span><span class="n">Handler</span><span class="w"> </span><span class="n">scheduler</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">initialCode</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">initialData</span><span class="p">,</span>
</span><span id="__span-39-168"><a id="__codelineno-39-168" name="__codelineno-39-168" href="#__codelineno-39-168"></a><span class="w">        </span><span class="n">Bundle</span><span class="w"> </span><span class="n">initialExtras</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-169"><a id="__codelineno-39-169" name="__codelineno-39-169" href="#__codelineno-39-169"></a><span class="w">    </span><span class="n">sendOrderedBroadcast</span><span class="p">(</span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">receiverPermission</span><span class="p">,</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">OP_NONE</span><span class="p">,</span>
</span><span id="__span-39-170"><a id="__codelineno-39-170" name="__codelineno-39-170" href="#__codelineno-39-170"></a><span class="w">            </span><span class="n">resultReceiver</span><span class="p">,</span><span class="w"> </span><span class="n">scheduler</span><span class="p">,</span><span class="w"> </span><span class="n">initialCode</span><span class="p">,</span><span class="w"> </span><span class="n">initialData</span><span class="p">,</span><span class="w"> </span><span class="n">initialExtras</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
</span><span id="__span-39-171"><a id="__codelineno-39-171" name="__codelineno-39-171" href="#__codelineno-39-171"></a><span class="p">}</span>
</span><span id="__span-39-172"><a id="__codelineno-39-172" name="__codelineno-39-172" href="#__codelineno-39-172"></a>
</span><span id="__span-39-173"><a id="__codelineno-39-173" name="__codelineno-39-173" href="#__codelineno-39-173"></a><span class="nd">@Override</span>
</span><span id="__span-39-174"><a id="__codelineno-39-174" name="__codelineno-39-174" href="#__codelineno-39-174"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendOrderedBroadcast</span><span class="p">(</span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span>
</span><span id="__span-39-175"><a id="__codelineno-39-175" name="__codelineno-39-175" href="#__codelineno-39-175"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">receiverPermission</span><span class="p">,</span><span class="w"> </span><span class="n">Bundle</span><span class="w"> </span><span class="n">options</span><span class="p">,</span><span class="w"> </span><span class="n">BroadcastReceiver</span><span class="w"> </span><span class="n">resultReceiver</span><span class="p">,</span>
</span><span id="__span-39-176"><a id="__codelineno-39-176" name="__codelineno-39-176" href="#__codelineno-39-176"></a><span class="w">        </span><span class="n">Handler</span><span class="w"> </span><span class="n">scheduler</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">initialCode</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">initialData</span><span class="p">,</span>
</span><span id="__span-39-177"><a id="__codelineno-39-177" name="__codelineno-39-177" href="#__codelineno-39-177"></a><span class="w">        </span><span class="n">Bundle</span><span class="w"> </span><span class="n">initialExtras</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-178"><a id="__codelineno-39-178" name="__codelineno-39-178" href="#__codelineno-39-178"></a><span class="w">    </span><span class="n">sendOrderedBroadcast</span><span class="p">(</span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">receiverPermission</span><span class="p">,</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">OP_NONE</span><span class="p">,</span>
</span><span id="__span-39-179"><a id="__codelineno-39-179" name="__codelineno-39-179" href="#__codelineno-39-179"></a><span class="w">            </span><span class="n">resultReceiver</span><span class="p">,</span><span class="w"> </span><span class="n">scheduler</span><span class="p">,</span><span class="w"> </span><span class="n">initialCode</span><span class="p">,</span><span class="w"> </span><span class="n">initialData</span><span class="p">,</span><span class="w"> </span><span class="n">initialExtras</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">);</span>
</span><span id="__span-39-180"><a id="__codelineno-39-180" name="__codelineno-39-180" href="#__codelineno-39-180"></a><span class="p">}</span>
</span><span id="__span-39-181"><a id="__codelineno-39-181" name="__codelineno-39-181" href="#__codelineno-39-181"></a>
</span><span id="__span-39-182"><a id="__codelineno-39-182" name="__codelineno-39-182" href="#__codelineno-39-182"></a><span class="nd">@Override</span>
</span><span id="__span-39-183"><a id="__codelineno-39-183" name="__codelineno-39-183" href="#__codelineno-39-183"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendOrderedBroadcast</span><span class="p">(</span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span>
</span><span id="__span-39-184"><a id="__codelineno-39-184" name="__codelineno-39-184" href="#__codelineno-39-184"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">receiverPermission</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">appOp</span><span class="p">,</span><span class="w"> </span><span class="n">BroadcastReceiver</span><span class="w"> </span><span class="n">resultReceiver</span><span class="p">,</span>
</span><span id="__span-39-185"><a id="__codelineno-39-185" name="__codelineno-39-185" href="#__codelineno-39-185"></a><span class="w">        </span><span class="n">Handler</span><span class="w"> </span><span class="n">scheduler</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">initialCode</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">initialData</span><span class="p">,</span>
</span><span id="__span-39-186"><a id="__codelineno-39-186" name="__codelineno-39-186" href="#__codelineno-39-186"></a><span class="w">        </span><span class="n">Bundle</span><span class="w"> </span><span class="n">initialExtras</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-187"><a id="__codelineno-39-187" name="__codelineno-39-187" href="#__codelineno-39-187"></a><span class="w">    </span><span class="n">sendOrderedBroadcast</span><span class="p">(</span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">receiverPermission</span><span class="p">,</span><span class="w"> </span><span class="n">appOp</span><span class="p">,</span>
</span><span id="__span-39-188"><a id="__codelineno-39-188" name="__codelineno-39-188" href="#__codelineno-39-188"></a><span class="w">            </span><span class="n">resultReceiver</span><span class="p">,</span><span class="w"> </span><span class="n">scheduler</span><span class="p">,</span><span class="w"> </span><span class="n">initialCode</span><span class="p">,</span><span class="w"> </span><span class="n">initialData</span><span class="p">,</span><span class="w"> </span><span class="n">initialExtras</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
</span><span id="__span-39-189"><a id="__codelineno-39-189" name="__codelineno-39-189" href="#__codelineno-39-189"></a><span class="p">}</span>
</span><span id="__span-39-190"><a id="__codelineno-39-190" name="__codelineno-39-190" href="#__codelineno-39-190"></a>
</span><span id="__span-39-191"><a id="__codelineno-39-191" name="__codelineno-39-191" href="#__codelineno-39-191"></a><span class="kt">void</span><span class="w"> </span><span class="nf">sendOrderedBroadcast</span><span class="p">(</span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span>
</span><span id="__span-39-192"><a id="__codelineno-39-192" name="__codelineno-39-192" href="#__codelineno-39-192"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">receiverPermission</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">appOp</span><span class="p">,</span><span class="w"> </span><span class="n">BroadcastReceiver</span><span class="w"> </span><span class="n">resultReceiver</span><span class="p">,</span>
</span><span id="__span-39-193"><a id="__codelineno-39-193" name="__codelineno-39-193" href="#__codelineno-39-193"></a><span class="w">        </span><span class="n">Handler</span><span class="w"> </span><span class="n">scheduler</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">initialCode</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">initialData</span><span class="p">,</span>
</span><span id="__span-39-194"><a id="__codelineno-39-194" name="__codelineno-39-194" href="#__codelineno-39-194"></a><span class="w">        </span><span class="n">Bundle</span><span class="w"> </span><span class="n">initialExtras</span><span class="p">,</span><span class="w"> </span><span class="n">Bundle</span><span class="w"> </span><span class="n">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-195"><a id="__codelineno-39-195" name="__codelineno-39-195" href="#__codelineno-39-195"></a><span class="w">    </span><span class="n">warnIfCallingFromSystemProcess</span><span class="p">();</span>
</span><span id="__span-39-196"><a id="__codelineno-39-196" name="__codelineno-39-196" href="#__codelineno-39-196"></a><span class="w">    </span><span class="n">IIntentReceiver</span><span class="w"> </span><span class="n">rd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-39-197"><a id="__codelineno-39-197" name="__codelineno-39-197" href="#__codelineno-39-197"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">resultReceiver</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-198"><a id="__codelineno-39-198" name="__codelineno-39-198" href="#__codelineno-39-198"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mPackageInfo</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-199"><a id="__codelineno-39-199" name="__codelineno-39-199" href="#__codelineno-39-199"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">scheduler</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-200"><a id="__codelineno-39-200" name="__codelineno-39-200" href="#__codelineno-39-200"></a><span class="w">                </span><span class="n">scheduler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mMainThread</span><span class="p">.</span><span class="na">getHandler</span><span class="p">();</span>
</span><span id="__span-39-201"><a id="__codelineno-39-201" name="__codelineno-39-201" href="#__codelineno-39-201"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-39-202"><a id="__codelineno-39-202" name="__codelineno-39-202" href="#__codelineno-39-202"></a><span class="w">            </span><span class="n">rd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mPackageInfo</span><span class="p">.</span><span class="na">getReceiverDispatcher</span><span class="p">(</span>
</span><span id="__span-39-203"><a id="__codelineno-39-203" name="__codelineno-39-203" href="#__codelineno-39-203"></a><span class="w">                </span><span class="n">resultReceiver</span><span class="p">,</span><span class="w"> </span><span class="n">getOuterContext</span><span class="p">(),</span><span class="w"> </span><span class="n">scheduler</span><span class="p">,</span>
</span><span id="__span-39-204"><a id="__codelineno-39-204" name="__codelineno-39-204" href="#__codelineno-39-204"></a><span class="w">                </span><span class="n">mMainThread</span><span class="p">.</span><span class="na">getInstrumentation</span><span class="p">(),</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
</span><span id="__span-39-205"><a id="__codelineno-39-205" name="__codelineno-39-205" href="#__codelineno-39-205"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-206"><a id="__codelineno-39-206" name="__codelineno-39-206" href="#__codelineno-39-206"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">scheduler</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-207"><a id="__codelineno-39-207" name="__codelineno-39-207" href="#__codelineno-39-207"></a><span class="w">                </span><span class="n">scheduler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mMainThread</span><span class="p">.</span><span class="na">getHandler</span><span class="p">();</span>
</span><span id="__span-39-208"><a id="__codelineno-39-208" name="__codelineno-39-208" href="#__codelineno-39-208"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-39-209"><a id="__codelineno-39-209" name="__codelineno-39-209" href="#__codelineno-39-209"></a><span class="w">            </span><span class="n">rd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LoadedApk</span><span class="p">.</span><span class="na">ReceiverDispatcher</span><span class="p">(</span>
</span><span id="__span-39-210"><a id="__codelineno-39-210" name="__codelineno-39-210" href="#__codelineno-39-210"></a><span class="w">                    </span><span class="n">resultReceiver</span><span class="p">,</span><span class="w"> </span><span class="n">getOuterContext</span><span class="p">(),</span><span class="w"> </span><span class="n">scheduler</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">).</span><span class="na">getIIntentReceiver</span><span class="p">();</span>
</span><span id="__span-39-211"><a id="__codelineno-39-211" name="__codelineno-39-211" href="#__codelineno-39-211"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-39-212"><a id="__codelineno-39-212" name="__codelineno-39-212" href="#__codelineno-39-212"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-39-213"><a id="__codelineno-39-213" name="__codelineno-39-213" href="#__codelineno-39-213"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">resolvedType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">resolveTypeIfNeeded</span><span class="p">(</span><span class="n">getContentResolver</span><span class="p">());</span>
</span><span id="__span-39-214"><a id="__codelineno-39-214" name="__codelineno-39-214" href="#__codelineno-39-214"></a><span class="w">    </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">receiverPermissions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">receiverPermission</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kc">null</span>
</span><span id="__span-39-215"><a id="__codelineno-39-215" name="__codelineno-39-215" href="#__codelineno-39-215"></a><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="n">receiverPermission</span><span class="p">};</span>
</span><span id="__span-39-216"><a id="__codelineno-39-216" name="__codelineno-39-216" href="#__codelineno-39-216"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-217"><a id="__codelineno-39-217" name="__codelineno-39-217" href="#__codelineno-39-217"></a><span class="w">        </span><span class="n">intent</span><span class="p">.</span><span class="na">prepareToLeaveProcess</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span id="__span-39-218"><a id="__codelineno-39-218" name="__codelineno-39-218" href="#__codelineno-39-218"></a><span class="w">        </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">getService</span><span class="p">().</span><span class="na">broadcastIntentWithFeature</span><span class="p">(</span>
</span><span id="__span-39-219"><a id="__codelineno-39-219" name="__codelineno-39-219" href="#__codelineno-39-219"></a><span class="w">                </span><span class="n">mMainThread</span><span class="p">.</span><span class="na">getApplicationThread</span><span class="p">(),</span><span class="w"> </span><span class="n">getAttributionTag</span><span class="p">(),</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">resolvedType</span><span class="p">,</span>
</span><span id="__span-39-220"><a id="__codelineno-39-220" name="__codelineno-39-220" href="#__codelineno-39-220"></a><span class="w">                </span><span class="n">rd</span><span class="p">,</span><span class="w"> </span><span class="n">initialCode</span><span class="p">,</span><span class="w"> </span><span class="n">initialData</span><span class="p">,</span><span class="w"> </span><span class="n">initialExtras</span><span class="p">,</span><span class="w"> </span><span class="n">receiverPermissions</span><span class="p">,</span>
</span><span id="__span-39-221"><a id="__codelineno-39-221" name="__codelineno-39-221" href="#__codelineno-39-221"></a><span class="w">                </span><span class="kc">null</span><span class="w"> </span><span class="cm">/*excludedPermissions=*/</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">appOp</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">getUserId</span><span class="p">());</span>
</span><span id="__span-39-222"><a id="__codelineno-39-222" name="__codelineno-39-222" href="#__codelineno-39-222"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-223"><a id="__codelineno-39-223" name="__codelineno-39-223" href="#__codelineno-39-223"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">rethrowFromSystemServer</span><span class="p">();</span>
</span><span id="__span-39-224"><a id="__codelineno-39-224" name="__codelineno-39-224" href="#__codelineno-39-224"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-39-225"><a id="__codelineno-39-225" name="__codelineno-39-225" href="#__codelineno-39-225"></a><span class="p">}</span>
</span></code></pre></div>
<p>从ContextImpl.java代码可以看出出来，发送广播的函数很多：</p>
<ul>
<li>普通的广播</li>
</ul>
<p>sendBroadcast()或者sendBroadcastAsUser()，默认是当前userId，带有“AsUser”的是发送给特定的user。</p>
<ul>
<li>带权限的广播</li>
</ul>
<p>endBroadcastMultiplePermissions()或者sendBroadcastAsUserMultiplePermissions()。</p>
<ul>
<li>有序的广播</li>
</ul>
<p>sendOrderedBroadcast()或者sendOrderedBroadcastAsUser()，发送有序广播是一个接收完成下一个才能接收，接收者一个个按顺序接收。</p>
<ul>
<li>粘性广播</li>
</ul>
<p>sendStickyBroadcast()或者sendStickyBroadcastAsUser()或者，粘性广播是注册者注册了就马上能收到该类型(之前已经发送的粘性广播)的广播，接收者的注册不需要在发送者的前面。</p>
<ul>
<li>粘性有序广播</li>
</ul>
<p>sendStickyOrderedBroadcast()或者sendStickyOrderedBroadcastAsUser()。</p>
<p>这些接口最终都是调用到了AMS的broadcastIntentWithFeature()函数。</p>
<h3 id="amsbroadcastintentwithfeature">AMS.broadcastIntentWithFeature<a class="headerlink" href="#amsbroadcastintentwithfeature" title="Permanent link">&para;</a></h3>
<div class="language-java highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="nd">@Override</span>
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">broadcastIntentWithFeature</span><span class="p">(</span><span class="n">IApplicationThread</span><span class="w"> </span><span class="n">caller</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">callingFeatureId</span><span class="p">,</span>
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="w">        </span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">resolvedType</span><span class="p">,</span><span class="w"> </span><span class="n">IIntentReceiver</span><span class="w"> </span><span class="n">resultTo</span><span class="p">,</span>
</span><span id="__span-40-4"><a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">resultCode</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">resultData</span><span class="p">,</span><span class="w"> </span><span class="n">Bundle</span><span class="w"> </span><span class="n">resultExtras</span><span class="p">,</span>
</span><span id="__span-40-5"><a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a><span class="w">        </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">requiredPermissions</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">excludedPermissions</span><span class="p">,</span>
</span><span id="__span-40-6"><a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a><span class="w">        </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">excludedPackages</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">appOp</span><span class="p">,</span><span class="w"> </span><span class="n">Bundle</span><span class="w"> </span><span class="n">bOptions</span><span class="p">,</span>
</span><span id="__span-40-7"><a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">serialized</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">sticky</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-8"><a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a><span class="w">    </span><span class="n">enforceNotIsolatedCaller</span><span class="p">(</span><span class="s">&quot;broadcastIntent&quot;</span><span class="p">);</span>
</span><span id="__span-40-9"><a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a><span class="w">    </span><span class="kd">synchronized</span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-10"><a id="__codelineno-40-10" name="__codelineno-40-10" href="#__codelineno-40-10"></a><span class="w">        </span><span class="n">intent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">verifyBroadcastLocked</span><span class="p">(</span><span class="n">intent</span><span class="p">);</span>
</span><span id="__span-40-11"><a id="__codelineno-40-11" name="__codelineno-40-11" href="#__codelineno-40-11"></a>
</span><span id="__span-40-12"><a id="__codelineno-40-12" name="__codelineno-40-12" href="#__codelineno-40-12"></a><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">ProcessRecord</span><span class="w"> </span><span class="n">callerApp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getRecordForAppLOSP</span><span class="p">(</span><span class="n">caller</span><span class="p">);</span>
</span><span id="__span-40-13"><a id="__codelineno-40-13" name="__codelineno-40-13" href="#__codelineno-40-13"></a><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">callingPid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Binder</span><span class="p">.</span><span class="na">getCallingPid</span><span class="p">();</span>
</span><span id="__span-40-14"><a id="__codelineno-40-14" name="__codelineno-40-14" href="#__codelineno-40-14"></a><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">callingUid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Binder</span><span class="p">.</span><span class="na">getCallingUid</span><span class="p">();</span>
</span><span id="__span-40-15"><a id="__codelineno-40-15" name="__codelineno-40-15" href="#__codelineno-40-15"></a>
</span><span id="__span-40-16"><a id="__codelineno-40-16" name="__codelineno-40-16" href="#__codelineno-40-16"></a><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">origId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Binder</span><span class="p">.</span><span class="na">clearCallingIdentity</span><span class="p">();</span>
</span><span id="__span-40-17"><a id="__codelineno-40-17" name="__codelineno-40-17" href="#__codelineno-40-17"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-18"><a id="__codelineno-40-18" name="__codelineno-40-18" href="#__codelineno-40-18"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">broadcastIntentLocked</span><span class="p">(</span><span class="n">callerApp</span><span class="p">,</span>
</span><span id="__span-40-19"><a id="__codelineno-40-19" name="__codelineno-40-19" href="#__codelineno-40-19"></a><span class="w">                    </span><span class="n">callerApp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">callerApp</span><span class="p">.</span><span class="na">info</span><span class="p">.</span><span class="na">packageName</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">callingFeatureId</span><span class="p">,</span>
</span><span id="__span-40-20"><a id="__codelineno-40-20" name="__codelineno-40-20" href="#__codelineno-40-20"></a><span class="w">                    </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">resolvedType</span><span class="p">,</span><span class="w"> </span><span class="n">resultTo</span><span class="p">,</span><span class="w"> </span><span class="n">resultCode</span><span class="p">,</span><span class="w"> </span><span class="n">resultData</span><span class="p">,</span><span class="w"> </span><span class="n">resultExtras</span><span class="p">,</span>
</span><span id="__span-40-21"><a id="__codelineno-40-21" name="__codelineno-40-21" href="#__codelineno-40-21"></a><span class="w">                    </span><span class="n">requiredPermissions</span><span class="p">,</span><span class="w"> </span><span class="n">excludedPermissions</span><span class="p">,</span><span class="w"> </span><span class="n">excludedPackages</span><span class="p">,</span><span class="w"> </span><span class="n">appOp</span><span class="p">,</span><span class="w"> </span><span class="n">bOptions</span><span class="p">,</span>
</span><span id="__span-40-22"><a id="__codelineno-40-22" name="__codelineno-40-22" href="#__codelineno-40-22"></a><span class="w">                    </span><span class="n">serialized</span><span class="p">,</span><span class="w"> </span><span class="n">sticky</span><span class="p">,</span><span class="w"> </span><span class="n">callingPid</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">,</span><span class="w"> </span><span class="n">callingPid</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">);</span>
</span><span id="__span-40-23"><a id="__codelineno-40-23" name="__codelineno-40-23" href="#__codelineno-40-23"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-24"><a id="__codelineno-40-24" name="__codelineno-40-24" href="#__codelineno-40-24"></a><span class="w">            </span><span class="n">Binder</span><span class="p">.</span><span class="na">restoreCallingIdentity</span><span class="p">(</span><span class="n">origId</span><span class="p">);</span>
</span><span id="__span-40-25"><a id="__codelineno-40-25" name="__codelineno-40-25" href="#__codelineno-40-25"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-40-26"><a id="__codelineno-40-26" name="__codelineno-40-26" href="#__codelineno-40-26"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-40-27"><a id="__codelineno-40-27" name="__codelineno-40-27" href="#__codelineno-40-27"></a><span class="p">}</span>
</span></code></pre></div>
<p>通过getRecordForAppLOSP获取callerApp，就可以根据callerApp获取到调用者的packageName、uid、pid等信息，接着调用broadcastIntentLocked()。</p>
<h3 id="amsbroadcastintentlocked">AMS.broadcastIntentLocked<a class="headerlink" href="#amsbroadcastintentlocked" title="Permanent link">&para;</a></h3>
<div class="language-java highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">broadcastIntentLocked</span><span class="p">(</span><span class="n">ProcessRecord</span><span class="w"> </span><span class="n">callerApp</span><span class="p">,</span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">callerFeatureId</span><span class="p">,</span><span class="w"> </span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">resolvedType</span><span class="p">,</span>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="w">        </span><span class="n">IIntentReceiver</span><span class="w"> </span><span class="n">resultTo</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">resultCode</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">resultData</span><span class="p">,</span>
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="w">        </span><span class="n">Bundle</span><span class="w"> </span><span class="n">resultExtras</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">requiredPermissions</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">excludedPermissions</span><span class="p">,</span>
</span><span id="__span-41-5"><a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="w">        </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">excludedPackages</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">appOp</span><span class="p">,</span><span class="w"> </span><span class="n">Bundle</span><span class="w"> </span><span class="n">bOptions</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">ordered</span><span class="p">,</span>
</span><span id="__span-41-6"><a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">sticky</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">callingPid</span><span class="p">,</span>
</span><span id="__span-41-7"><a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">callingUid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">realCallingUid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">realCallingPid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-8"><a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">broadcastIntentLocked</span><span class="p">(</span><span class="n">callerApp</span><span class="p">,</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">,</span><span class="w"> </span><span class="n">callerFeatureId</span><span class="p">,</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span>
</span><span id="__span-41-9"><a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a><span class="w">            </span><span class="n">resolvedType</span><span class="p">,</span><span class="w"> </span><span class="n">resultTo</span><span class="p">,</span><span class="w"> </span><span class="n">resultCode</span><span class="p">,</span><span class="w"> </span><span class="n">resultData</span><span class="p">,</span><span class="w"> </span><span class="n">resultExtras</span><span class="p">,</span><span class="w"> </span><span class="n">requiredPermissions</span><span class="p">,</span>
</span><span id="__span-41-10"><a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a><span class="w">            </span><span class="n">excludedPermissions</span><span class="p">,</span><span class="w"> </span><span class="n">excludedPackages</span><span class="p">,</span><span class="w"> </span><span class="n">appOp</span><span class="p">,</span><span class="w"> </span><span class="n">bOptions</span><span class="p">,</span><span class="w"> </span><span class="n">ordered</span><span class="p">,</span><span class="w"> </span><span class="n">sticky</span><span class="p">,</span><span class="w"> </span><span class="n">callingPid</span><span class="p">,</span>
</span><span id="__span-41-11"><a id="__codelineno-41-11" name="__codelineno-41-11" href="#__codelineno-41-11"></a><span class="w">            </span><span class="n">callingUid</span><span class="p">,</span><span class="w"> </span><span class="n">realCallingUid</span><span class="p">,</span><span class="w"> </span><span class="n">realCallingPid</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span>
</span><span id="__span-41-12"><a id="__codelineno-41-12" name="__codelineno-41-12" href="#__codelineno-41-12"></a><span class="w">            </span><span class="kc">false</span><span class="w"> </span><span class="cm">/* allowBackgroundActivityStarts */</span><span class="p">,</span>
</span><span id="__span-41-13"><a id="__codelineno-41-13" name="__codelineno-41-13" href="#__codelineno-41-13"></a><span class="w">            </span><span class="kc">null</span><span class="w"> </span><span class="cm">/* tokenNeededForBackgroundActivityStarts */</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="cm">/* broadcastAllowList */</span><span class="p">);</span>
</span><span id="__span-41-14"><a id="__codelineno-41-14" name="__codelineno-41-14" href="#__codelineno-41-14"></a><span class="p">}</span>
</span><span id="__span-41-15"><a id="__codelineno-41-15" name="__codelineno-41-15" href="#__codelineno-41-15"></a>
</span><span id="__span-41-16"><a id="__codelineno-41-16" name="__codelineno-41-16" href="#__codelineno-41-16"></a><span class="nd">@GuardedBy</span><span class="p">(</span><span class="s">&quot;this&quot;</span><span class="p">)</span>
</span><span id="__span-41-17"><a id="__codelineno-41-17" name="__codelineno-41-17" href="#__codelineno-41-17"></a><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">broadcastIntentLocked</span><span class="p">(</span><span class="n">ProcessRecord</span><span class="w"> </span><span class="n">callerApp</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">,</span>
</span><span id="__span-41-18"><a id="__codelineno-41-18" name="__codelineno-41-18" href="#__codelineno-41-18"></a><span class="w">        </span><span class="nd">@Nullable</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">callerFeatureId</span><span class="p">,</span><span class="w"> </span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">resolvedType</span><span class="p">,</span>
</span><span id="__span-41-19"><a id="__codelineno-41-19" name="__codelineno-41-19" href="#__codelineno-41-19"></a><span class="w">        </span><span class="n">IIntentReceiver</span><span class="w"> </span><span class="n">resultTo</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">resultCode</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">resultData</span><span class="p">,</span>
</span><span id="__span-41-20"><a id="__codelineno-41-20" name="__codelineno-41-20" href="#__codelineno-41-20"></a><span class="w">        </span><span class="n">Bundle</span><span class="w"> </span><span class="n">resultExtras</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">requiredPermissions</span><span class="p">,</span>
</span><span id="__span-41-21"><a id="__codelineno-41-21" name="__codelineno-41-21" href="#__codelineno-41-21"></a><span class="w">        </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">excludedPermissions</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">excludedPackages</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">appOp</span><span class="p">,</span><span class="w"> </span><span class="n">Bundle</span><span class="w"> </span><span class="n">bOptions</span><span class="p">,</span>
</span><span id="__span-41-22"><a id="__codelineno-41-22" name="__codelineno-41-22" href="#__codelineno-41-22"></a><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">ordered</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">sticky</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">callingPid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">callingUid</span><span class="p">,</span>
</span><span id="__span-41-23"><a id="__codelineno-41-23" name="__codelineno-41-23" href="#__codelineno-41-23"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">realCallingUid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">realCallingPid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span>
</span><span id="__span-41-24"><a id="__codelineno-41-24" name="__codelineno-41-24" href="#__codelineno-41-24"></a><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">allowBackgroundActivityStarts</span><span class="p">,</span>
</span><span id="__span-41-25"><a id="__codelineno-41-25" name="__codelineno-41-25" href="#__codelineno-41-25"></a><span class="w">        </span><span class="nd">@Nullable</span><span class="w"> </span><span class="n">IBinder</span><span class="w"> </span><span class="n">backgroundActivityStartsToken</span><span class="p">,</span>
</span><span id="__span-41-26"><a id="__codelineno-41-26" name="__codelineno-41-26" href="#__codelineno-41-26"></a><span class="w">        </span><span class="nd">@Nullable</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">broadcastAllowList</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-27"><a id="__codelineno-41-27" name="__codelineno-41-27" href="#__codelineno-41-27"></a><span class="w">    </span><span class="n">intent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Intent</span><span class="p">(</span><span class="n">intent</span><span class="p">);</span>
</span><span id="__span-41-28"><a id="__codelineno-41-28" name="__codelineno-41-28" href="#__codelineno-41-28"></a>
</span><span id="__span-41-29"><a id="__codelineno-41-29" name="__codelineno-41-29" href="#__codelineno-41-29"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">callerInstantApp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isInstantApp</span><span class="p">(</span><span class="n">callerApp</span><span class="p">,</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">);</span>
</span><span id="__span-41-30"><a id="__codelineno-41-30" name="__codelineno-41-30" href="#__codelineno-41-30"></a><span class="w">    </span><span class="c1">// Instant Apps cannot use FLAG_RECEIVER_VISIBLE_TO_INSTANT_APPS</span>
</span><span id="__span-41-31"><a id="__codelineno-41-31" name="__codelineno-41-31" href="#__codelineno-41-31"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">callerInstantApp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-32"><a id="__codelineno-41-32" name="__codelineno-41-32" href="#__codelineno-41-32"></a><span class="w">        </span><span class="n">intent</span><span class="p">.</span><span class="na">setFlags</span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getFlags</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">Intent</span><span class="p">.</span><span class="na">FLAG_RECEIVER_VISIBLE_TO_INSTANT_APPS</span><span class="p">);</span>
</span><span id="__span-41-33"><a id="__codelineno-41-33" name="__codelineno-41-33" href="#__codelineno-41-33"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-41-34"><a id="__codelineno-41-34" name="__codelineno-41-34" href="#__codelineno-41-34"></a>
</span><span id="__span-41-35"><a id="__codelineno-41-35" name="__codelineno-41-35" href="#__codelineno-41-35"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">userId</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">USER_ALL</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">broadcastAllowList</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-36"><a id="__codelineno-41-36" name="__codelineno-41-36" href="#__codelineno-41-36"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;broadcastAllowList only applies when sending to individual users. &quot;</span>
</span><span id="__span-41-37"><a id="__codelineno-41-37" name="__codelineno-41-37" href="#__codelineno-41-37"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;Assuming restrictive whitelist.&quot;</span><span class="p">);</span>
</span><span id="__span-41-38"><a id="__codelineno-41-38" name="__codelineno-41-38" href="#__codelineno-41-38"></a><span class="w">            </span><span class="n">broadcastAllowList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="p">{};</span>
</span><span id="__span-41-39"><a id="__codelineno-41-39" name="__codelineno-41-39" href="#__codelineno-41-39"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-41-40"><a id="__codelineno-41-40" name="__codelineno-41-40" href="#__codelineno-41-40"></a>
</span><span id="__span-41-41"><a id="__codelineno-41-41" name="__codelineno-41-41" href="#__codelineno-41-41"></a><span class="w">    </span><span class="c1">// By default broadcasts do not go to stopped apps.</span>
</span><span id="__span-41-42"><a id="__codelineno-41-42" name="__codelineno-41-42" href="#__codelineno-41-42"></a><span class="w">    </span><span class="n">intent</span><span class="p">.</span><span class="na">addFlags</span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="na">FLAG_EXCLUDE_STOPPED_PACKAGES</span><span class="p">);</span>
</span><span id="__span-41-43"><a id="__codelineno-41-43" name="__codelineno-41-43" href="#__codelineno-41-43"></a>
</span><span id="__span-41-44"><a id="__codelineno-41-44" name="__codelineno-41-44" href="#__codelineno-41-44"></a><span class="w">    </span><span class="c1">// If we have not finished booting, don&#39;t allow this to launch new processes.</span>
</span><span id="__span-41-45"><a id="__codelineno-41-45" name="__codelineno-41-45" href="#__codelineno-41-45"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mProcessesReady</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getFlags</span><span class="p">()</span><span class="o">&amp;</span><span class="n">Intent</span><span class="p">.</span><span class="na">FLAG_RECEIVER_BOOT_UPGRADE</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-46"><a id="__codelineno-41-46" name="__codelineno-41-46" href="#__codelineno-41-46"></a><span class="w">        </span><span class="n">intent</span><span class="p">.</span><span class="na">addFlags</span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="na">FLAG_RECEIVER_REGISTERED_ONLY</span><span class="p">);</span>
</span><span id="__span-41-47"><a id="__codelineno-41-47" name="__codelineno-41-47" href="#__codelineno-41-47"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-41-48"><a id="__codelineno-41-48" name="__codelineno-41-48" href="#__codelineno-41-48"></a>
</span><span id="__span-41-49"><a id="__codelineno-41-49" name="__codelineno-41-49" href="#__codelineno-41-49"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST_LIGHT</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span>
</span><span id="__span-41-50"><a id="__codelineno-41-50" name="__codelineno-41-50" href="#__codelineno-41-50"></a><span class="w">            </span><span class="p">(</span><span class="n">sticky</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;Broadcast sticky: &quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Broadcast: &quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">intent</span>
</span><span id="__span-41-51"><a id="__codelineno-41-51" name="__codelineno-41-51" href="#__codelineno-41-51"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; ordered=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ordered</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; userid=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">userId</span><span class="p">);</span>
</span><span id="__span-41-52"><a id="__codelineno-41-52" name="__codelineno-41-52" href="#__codelineno-41-52"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">resultTo</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">ordered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-53"><a id="__codelineno-41-53" name="__codelineno-41-53" href="#__codelineno-41-53"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Broadcast &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">intent</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; not ordered but result callback requested!&quot;</span><span class="p">);</span>
</span><span id="__span-41-54"><a id="__codelineno-41-54" name="__codelineno-41-54" href="#__codelineno-41-54"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-41-55"><a id="__codelineno-41-55" name="__codelineno-41-55" href="#__codelineno-41-55"></a>
</span><span id="__span-41-56"><a id="__codelineno-41-56" name="__codelineno-41-56" href="#__codelineno-41-56"></a><span class="w">    </span><span class="n">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mUserController</span><span class="p">.</span><span class="na">handleIncomingUser</span><span class="p">(</span><span class="n">callingPid</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-41-57"><a id="__codelineno-41-57" name="__codelineno-41-57" href="#__codelineno-41-57"></a><span class="w">            </span><span class="n">ALLOW_NON_FULL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;broadcast&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">);</span>
</span><span id="__span-41-58"><a id="__codelineno-41-58" name="__codelineno-41-58" href="#__codelineno-41-58"></a>
</span><span id="__span-41-59"><a id="__codelineno-41-59" name="__codelineno-41-59" href="#__codelineno-41-59"></a><span class="w">    </span><span class="c1">// Make sure that the user who is receiving this broadcast or its parent is running.</span>
</span><span id="__span-41-60"><a id="__codelineno-41-60" name="__codelineno-41-60" href="#__codelineno-41-60"></a><span class="w">    </span><span class="c1">// If not, we will just skip it. Make an exception for shutdown broadcasts, upgrade steps.</span>
</span><span id="__span-41-61"><a id="__codelineno-41-61" name="__codelineno-41-61" href="#__codelineno-41-61"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">userId</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">USER_ALL</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">mUserController</span><span class="p">.</span><span class="na">isUserOrItsParentRunning</span><span class="p">(</span><span class="n">userId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-62"><a id="__codelineno-41-62" name="__codelineno-41-62" href="#__codelineno-41-62"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">callingUid</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">SYSTEM_UID</span>
</span><span id="__span-41-63"><a id="__codelineno-41-63" name="__codelineno-41-63" href="#__codelineno-41-63"></a><span class="w">                </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getFlags</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">FLAG_RECEIVER_BOOT_UPGRADE</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-41-64"><a id="__codelineno-41-64" name="__codelineno-41-64" href="#__codelineno-41-64"></a><span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_SHUTDOWN</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-65"><a id="__codelineno-41-65" name="__codelineno-41-65" href="#__codelineno-41-65"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Skipping broadcast of &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">intent</span>
</span><span id="__span-41-66"><a id="__codelineno-41-66" name="__codelineno-41-66" href="#__codelineno-41-66"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;: user &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">userId</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; and its parent (if any) are stopped&quot;</span><span class="p">);</span>
</span><span id="__span-41-67"><a id="__codelineno-41-67" name="__codelineno-41-67" href="#__codelineno-41-67"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">BROADCAST_FAILED_USER_STOPPED</span><span class="p">;</span>
</span><span id="__span-41-68"><a id="__codelineno-41-68" name="__codelineno-41-68" href="#__codelineno-41-68"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-41-69"><a id="__codelineno-41-69" name="__codelineno-41-69" href="#__codelineno-41-69"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-41-70"><a id="__codelineno-41-70" name="__codelineno-41-70" href="#__codelineno-41-70"></a>
</span><span id="__span-41-71"><a id="__codelineno-41-71" name="__codelineno-41-71" href="#__codelineno-41-71"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">();</span>
</span><span id="__span-41-72"><a id="__codelineno-41-72" name="__codelineno-41-72" href="#__codelineno-41-72"></a><span class="w">    </span><span class="n">BroadcastOptions</span><span class="w"> </span><span class="n">brOptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-41-73"><a id="__codelineno-41-73" name="__codelineno-41-73" href="#__codelineno-41-73"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bOptions</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-74"><a id="__codelineno-41-74" name="__codelineno-41-74" href="#__codelineno-41-74"></a><span class="w">        </span><span class="n">brOptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BroadcastOptions</span><span class="p">(</span><span class="n">bOptions</span><span class="p">);</span>
</span><span id="__span-41-75"><a id="__codelineno-41-75" name="__codelineno-41-75" href="#__codelineno-41-75"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">brOptions</span><span class="p">.</span><span class="na">getTemporaryAppAllowlistDuration</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-76"><a id="__codelineno-41-76" name="__codelineno-41-76" href="#__codelineno-41-76"></a><span class="w">            </span><span class="c1">// See if the caller is allowed to do this.  Note we are checking against</span>
</span><span id="__span-41-77"><a id="__codelineno-41-77" name="__codelineno-41-77" href="#__codelineno-41-77"></a><span class="w">            </span><span class="c1">// the actual real caller (not whoever provided the operation as say a</span>
</span><span id="__span-41-78"><a id="__codelineno-41-78" name="__codelineno-41-78" href="#__codelineno-41-78"></a><span class="w">            </span><span class="c1">// PendingIntent), because that who is actually supplied the arguments.</span>
</span><span id="__span-41-79"><a id="__codelineno-41-79" name="__codelineno-41-79" href="#__codelineno-41-79"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">checkComponentPermission</span><span class="p">(</span><span class="n">CHANGE_DEVICE_IDLE_TEMP_WHITELIST</span><span class="p">,</span>
</span><span id="__span-41-80"><a id="__codelineno-41-80" name="__codelineno-41-80" href="#__codelineno-41-80"></a><span class="w">                    </span><span class="n">realCallingPid</span><span class="p">,</span><span class="w"> </span><span class="n">realCallingUid</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
</span><span id="__span-41-81"><a id="__codelineno-41-81" name="__codelineno-41-81" href="#__codelineno-41-81"></a><span class="w">                    </span><span class="o">!=</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="na">PERMISSION_GRANTED</span>
</span><span id="__span-41-82"><a id="__codelineno-41-82" name="__codelineno-41-82" href="#__codelineno-41-82"></a><span class="w">                    </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">checkComponentPermission</span><span class="p">(</span><span class="n">START_ACTIVITIES_FROM_BACKGROUND</span><span class="p">,</span>
</span><span id="__span-41-83"><a id="__codelineno-41-83" name="__codelineno-41-83" href="#__codelineno-41-83"></a><span class="w">                    </span><span class="n">realCallingPid</span><span class="p">,</span><span class="w"> </span><span class="n">realCallingUid</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
</span><span id="__span-41-84"><a id="__codelineno-41-84" name="__codelineno-41-84" href="#__codelineno-41-84"></a><span class="w">                    </span><span class="o">!=</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="na">PERMISSION_GRANTED</span>
</span><span id="__span-41-85"><a id="__codelineno-41-85" name="__codelineno-41-85" href="#__codelineno-41-85"></a><span class="w">                    </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">checkComponentPermission</span><span class="p">(</span><span class="n">START_FOREGROUND_SERVICES_FROM_BACKGROUND</span><span class="p">,</span>
</span><span id="__span-41-86"><a id="__codelineno-41-86" name="__codelineno-41-86" href="#__codelineno-41-86"></a><span class="w">                    </span><span class="n">realCallingPid</span><span class="p">,</span><span class="w"> </span><span class="n">realCallingUid</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
</span><span id="__span-41-87"><a id="__codelineno-41-87" name="__codelineno-41-87" href="#__codelineno-41-87"></a><span class="w">                    </span><span class="o">!=</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="na">PERMISSION_GRANTED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-88"><a id="__codelineno-41-88" name="__codelineno-41-88" href="#__codelineno-41-88"></a><span class="w">                </span><span class="n">String</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Permission Denial: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">()</span>
</span><span id="__span-41-89"><a id="__codelineno-41-89" name="__codelineno-41-89" href="#__codelineno-41-89"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; broadcast from &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callerPackage</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; (pid=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callingPid</span>
</span><span id="__span-41-90"><a id="__codelineno-41-90" name="__codelineno-41-90" href="#__codelineno-41-90"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, uid=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callingUid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;)&quot;</span>
</span><span id="__span-41-91"><a id="__codelineno-41-91" name="__codelineno-41-91" href="#__codelineno-41-91"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; requires &quot;</span>
</span><span id="__span-41-92"><a id="__codelineno-41-92" name="__codelineno-41-92" href="#__codelineno-41-92"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">CHANGE_DEVICE_IDLE_TEMP_WHITELIST</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; or &quot;</span>
</span><span id="__span-41-93"><a id="__codelineno-41-93" name="__codelineno-41-93" href="#__codelineno-41-93"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">START_ACTIVITIES_FROM_BACKGROUND</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; or &quot;</span>
</span><span id="__span-41-94"><a id="__codelineno-41-94" name="__codelineno-41-94" href="#__codelineno-41-94"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">START_FOREGROUND_SERVICES_FROM_BACKGROUND</span><span class="p">;</span>
</span><span id="__span-41-95"><a id="__codelineno-41-95" name="__codelineno-41-95" href="#__codelineno-41-95"></a><span class="w">                </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span>
</span><span id="__span-41-96"><a id="__codelineno-41-96" name="__codelineno-41-96" href="#__codelineno-41-96"></a><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecurityException</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span><span id="__span-41-97"><a id="__codelineno-41-97" name="__codelineno-41-97" href="#__codelineno-41-97"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-41-98"><a id="__codelineno-41-98" name="__codelineno-41-98" href="#__codelineno-41-98"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-41-99"><a id="__codelineno-41-99" name="__codelineno-41-99" href="#__codelineno-41-99"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">brOptions</span><span class="p">.</span><span class="na">isDontSendToRestrictedApps</span><span class="p">()</span>
</span><span id="__span-41-100"><a id="__codelineno-41-100" name="__codelineno-41-100" href="#__codelineno-41-100"></a><span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">isUidActiveLOSP</span><span class="p">(</span><span class="n">callingUid</span><span class="p">)</span>
</span><span id="__span-41-101"><a id="__codelineno-41-101" name="__codelineno-41-101" href="#__codelineno-41-101"></a><span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">isBackgroundRestrictedNoCheck</span><span class="p">(</span><span class="n">callingUid</span><span class="p">,</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-102"><a id="__codelineno-41-102" name="__codelineno-41-102" href="#__codelineno-41-102"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Not sending broadcast &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; - app &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callerPackage</span>
</span><span id="__span-41-103"><a id="__codelineno-41-103" name="__codelineno-41-103" href="#__codelineno-41-103"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; has background restrictions&quot;</span><span class="p">);</span>
</span><span id="__span-41-104"><a id="__codelineno-41-104" name="__codelineno-41-104" href="#__codelineno-41-104"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">START_CANCELED</span><span class="p">;</span>
</span><span id="__span-41-105"><a id="__codelineno-41-105" name="__codelineno-41-105" href="#__codelineno-41-105"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-41-106"><a id="__codelineno-41-106" name="__codelineno-41-106" href="#__codelineno-41-106"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">brOptions</span><span class="p">.</span><span class="na">allowsBackgroundActivityStarts</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-107"><a id="__codelineno-41-107" name="__codelineno-41-107" href="#__codelineno-41-107"></a><span class="w">            </span><span class="c1">// See if the caller is allowed to do this.  Note we are checking against</span>
</span><span id="__span-41-108"><a id="__codelineno-41-108" name="__codelineno-41-108" href="#__codelineno-41-108"></a><span class="w">            </span><span class="c1">// the actual real caller (not whoever provided the operation as say a</span>
</span><span id="__span-41-109"><a id="__codelineno-41-109" name="__codelineno-41-109" href="#__codelineno-41-109"></a><span class="w">            </span><span class="c1">// PendingIntent), because that who is actually supplied the arguments.</span>
</span><span id="__span-41-110"><a id="__codelineno-41-110" name="__codelineno-41-110" href="#__codelineno-41-110"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">checkComponentPermission</span><span class="p">(</span>
</span><span id="__span-41-111"><a id="__codelineno-41-111" name="__codelineno-41-111" href="#__codelineno-41-111"></a><span class="w">                    </span><span class="n">android</span><span class="p">.</span><span class="na">Manifest</span><span class="p">.</span><span class="na">permission</span><span class="p">.</span><span class="na">START_ACTIVITIES_FROM_BACKGROUND</span><span class="p">,</span>
</span><span id="__span-41-112"><a id="__codelineno-41-112" name="__codelineno-41-112" href="#__codelineno-41-112"></a><span class="w">                    </span><span class="n">realCallingPid</span><span class="p">,</span><span class="w"> </span><span class="n">realCallingUid</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
</span><span id="__span-41-113"><a id="__codelineno-41-113" name="__codelineno-41-113" href="#__codelineno-41-113"></a><span class="w">                    </span><span class="o">!=</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="na">PERMISSION_GRANTED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-114"><a id="__codelineno-41-114" name="__codelineno-41-114" href="#__codelineno-41-114"></a><span class="w">                </span><span class="n">String</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Permission Denial: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">()</span>
</span><span id="__span-41-115"><a id="__codelineno-41-115" name="__codelineno-41-115" href="#__codelineno-41-115"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; broadcast from &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callerPackage</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; (pid=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callingPid</span>
</span><span id="__span-41-116"><a id="__codelineno-41-116" name="__codelineno-41-116" href="#__codelineno-41-116"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, uid=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callingUid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;)&quot;</span>
</span><span id="__span-41-117"><a id="__codelineno-41-117" name="__codelineno-41-117" href="#__codelineno-41-117"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; requires &quot;</span>
</span><span id="__span-41-118"><a id="__codelineno-41-118" name="__codelineno-41-118" href="#__codelineno-41-118"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">android</span><span class="p">.</span><span class="na">Manifest</span><span class="p">.</span><span class="na">permission</span><span class="p">.</span><span class="na">START_ACTIVITIES_FROM_BACKGROUND</span><span class="p">;</span>
</span><span id="__span-41-119"><a id="__codelineno-41-119" name="__codelineno-41-119" href="#__codelineno-41-119"></a><span class="w">                </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span>
</span><span id="__span-41-120"><a id="__codelineno-41-120" name="__codelineno-41-120" href="#__codelineno-41-120"></a><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecurityException</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span><span id="__span-41-121"><a id="__codelineno-41-121" name="__codelineno-41-121" href="#__codelineno-41-121"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-122"><a id="__codelineno-41-122" name="__codelineno-41-122" href="#__codelineno-41-122"></a><span class="w">                </span><span class="n">allowBackgroundActivityStarts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-41-123"><a id="__codelineno-41-123" name="__codelineno-41-123" href="#__codelineno-41-123"></a><span class="w">                </span><span class="c1">// We set the token to null since if it wasn&#39;t for it we&#39;d allow anyway here</span>
</span><span id="__span-41-124"><a id="__codelineno-41-124" name="__codelineno-41-124" href="#__codelineno-41-124"></a><span class="w">                </span><span class="n">backgroundActivityStartsToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-41-125"><a id="__codelineno-41-125" name="__codelineno-41-125" href="#__codelineno-41-125"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-41-126"><a id="__codelineno-41-126" name="__codelineno-41-126" href="#__codelineno-41-126"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-41-127"><a id="__codelineno-41-127" name="__codelineno-41-127" href="#__codelineno-41-127"></a>
</span><span id="__span-41-128"><a id="__codelineno-41-128" name="__codelineno-41-128" href="#__codelineno-41-128"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">brOptions</span><span class="p">.</span><span class="na">getIdForResponseEvent</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-129"><a id="__codelineno-41-129" name="__codelineno-41-129" href="#__codelineno-41-129"></a><span class="w">            </span><span class="n">enforcePermission</span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">Manifest</span><span class="p">.</span><span class="na">permission</span><span class="p">.</span><span class="na">ACCESS_BROADCAST_RESPONSE_STATS</span><span class="p">,</span>
</span><span id="__span-41-130"><a id="__codelineno-41-130" name="__codelineno-41-130" href="#__codelineno-41-130"></a><span class="w">                    </span><span class="n">callingPid</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;recordResponseEventWhileInBackground&quot;</span><span class="p">);</span>
</span><span id="__span-41-131"><a id="__codelineno-41-131" name="__codelineno-41-131" href="#__codelineno-41-131"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-41-132"><a id="__codelineno-41-132" name="__codelineno-41-132" href="#__codelineno-41-132"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-41-133"><a id="__codelineno-41-133" name="__codelineno-41-133" href="#__codelineno-41-133"></a>
</span><span id="__span-41-134"><a id="__codelineno-41-134" name="__codelineno-41-134" href="#__codelineno-41-134"></a><span class="w">    </span><span class="c1">// Verify that protected broadcasts are only being sent by system code,</span>
</span><span id="__span-41-135"><a id="__codelineno-41-135" name="__codelineno-41-135" href="#__codelineno-41-135"></a><span class="w">    </span><span class="c1">// and that system code is only sending protected broadcasts.</span>
</span><span id="__span-41-136"><a id="__codelineno-41-136" name="__codelineno-41-136" href="#__codelineno-41-136"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isProtectedBroadcast</span><span class="p">;</span>
</span><span id="__span-41-137"><a id="__codelineno-41-137" name="__codelineno-41-137" href="#__codelineno-41-137"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-138"><a id="__codelineno-41-138" name="__codelineno-41-138" href="#__codelineno-41-138"></a><span class="w">        </span><span class="n">isProtectedBroadcast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AppGlobals</span><span class="p">.</span><span class="na">getPackageManager</span><span class="p">().</span><span class="na">isProtectedBroadcast</span><span class="p">(</span><span class="n">action</span><span class="p">);</span>
</span><span id="__span-41-139"><a id="__codelineno-41-139" name="__codelineno-41-139" href="#__codelineno-41-139"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-140"><a id="__codelineno-41-140" name="__codelineno-41-140" href="#__codelineno-41-140"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Remote exception&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
</span><span id="__span-41-141"><a id="__codelineno-41-141" name="__codelineno-41-141" href="#__codelineno-41-141"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">BROADCAST_SUCCESS</span><span class="p">;</span>
</span><span id="__span-41-142"><a id="__codelineno-41-142" name="__codelineno-41-142" href="#__codelineno-41-142"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-41-143"><a id="__codelineno-41-143" name="__codelineno-41-143" href="#__codelineno-41-143"></a>
</span><span id="__span-41-144"><a id="__codelineno-41-144" name="__codelineno-41-144" href="#__codelineno-41-144"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isCallerSystem</span><span class="p">;</span>
</span><span id="__span-41-145"><a id="__codelineno-41-145" name="__codelineno-41-145" href="#__codelineno-41-145"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">UserHandle</span><span class="p">.</span><span class="na">getAppId</span><span class="p">(</span><span class="n">callingUid</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-146"><a id="__codelineno-41-146" name="__codelineno-41-146" href="#__codelineno-41-146"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">ROOT_UID</span><span class="p">:</span>
</span><span id="__span-41-147"><a id="__codelineno-41-147" name="__codelineno-41-147" href="#__codelineno-41-147"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">SYSTEM_UID</span><span class="p">:</span>
</span><span id="__span-41-148"><a id="__codelineno-41-148" name="__codelineno-41-148" href="#__codelineno-41-148"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">PHONE_UID</span><span class="p">:</span>
</span><span id="__span-41-149"><a id="__codelineno-41-149" name="__codelineno-41-149" href="#__codelineno-41-149"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">BLUETOOTH_UID</span><span class="p">:</span>
</span><span id="__span-41-150"><a id="__codelineno-41-150" name="__codelineno-41-150" href="#__codelineno-41-150"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">NFC_UID</span><span class="p">:</span>
</span><span id="__span-41-151"><a id="__codelineno-41-151" name="__codelineno-41-151" href="#__codelineno-41-151"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">SE_UID</span><span class="p">:</span>
</span><span id="__span-41-152"><a id="__codelineno-41-152" name="__codelineno-41-152" href="#__codelineno-41-152"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">NETWORK_STACK_UID</span><span class="p">:</span>
</span><span id="__span-41-153"><a id="__codelineno-41-153" name="__codelineno-41-153" href="#__codelineno-41-153"></a><span class="w">            </span><span class="n">isCallerSystem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-41-154"><a id="__codelineno-41-154" name="__codelineno-41-154" href="#__codelineno-41-154"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-41-155"><a id="__codelineno-41-155" name="__codelineno-41-155" href="#__codelineno-41-155"></a><span class="w">        </span><span class="k">default</span><span class="p">:</span>
</span><span id="__span-41-156"><a id="__codelineno-41-156" name="__codelineno-41-156" href="#__codelineno-41-156"></a><span class="w">            </span><span class="n">isCallerSystem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">callerApp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">callerApp</span><span class="p">.</span><span class="na">isPersistent</span><span class="p">();</span>
</span><span id="__span-41-157"><a id="__codelineno-41-157" name="__codelineno-41-157" href="#__codelineno-41-157"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-41-158"><a id="__codelineno-41-158" name="__codelineno-41-158" href="#__codelineno-41-158"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-41-159"><a id="__codelineno-41-159" name="__codelineno-41-159" href="#__codelineno-41-159"></a>
</span><span id="__span-41-160"><a id="__codelineno-41-160" name="__codelineno-41-160" href="#__codelineno-41-160"></a><span class="w">    </span><span class="c1">// First line security check before anything else: stop non-system apps from</span>
</span><span id="__span-41-161"><a id="__codelineno-41-161" name="__codelineno-41-161" href="#__codelineno-41-161"></a><span class="w">    </span><span class="c1">// sending protected broadcasts.</span>
</span><span id="__span-41-162"><a id="__codelineno-41-162" name="__codelineno-41-162" href="#__codelineno-41-162"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isCallerSystem</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-163"><a id="__codelineno-41-163" name="__codelineno-41-163" href="#__codelineno-41-163"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isProtectedBroadcast</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-164"><a id="__codelineno-41-164" name="__codelineno-41-164" href="#__codelineno-41-164"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Permission Denial: not allowed to send broadcast &quot;</span>
</span><span id="__span-41-165"><a id="__codelineno-41-165" name="__codelineno-41-165" href="#__codelineno-41-165"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; from pid=&quot;</span>
</span><span id="__span-41-166"><a id="__codelineno-41-166" name="__codelineno-41-166" href="#__codelineno-41-166"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">callingPid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, uid=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callingUid</span><span class="p">;</span>
</span><span id="__span-41-167"><a id="__codelineno-41-167" name="__codelineno-41-167" href="#__codelineno-41-167"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span>
</span><span id="__span-41-168"><a id="__codelineno-41-168" name="__codelineno-41-168" href="#__codelineno-41-168"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecurityException</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span><span id="__span-41-169"><a id="__codelineno-41-169" name="__codelineno-41-169" href="#__codelineno-41-169"></a>
</span><span id="__span-41-170"><a id="__codelineno-41-170" name="__codelineno-41-170" href="#__codelineno-41-170"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">AppWidgetManager</span><span class="p">.</span><span class="na">ACTION_APPWIDGET_CONFIGURE</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
</span><span id="__span-41-171"><a id="__codelineno-41-171" name="__codelineno-41-171" href="#__codelineno-41-171"></a><span class="w">                </span><span class="o">||</span><span class="w"> </span><span class="n">AppWidgetManager</span><span class="p">.</span><span class="na">ACTION_APPWIDGET_UPDATE</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">action</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-172"><a id="__codelineno-41-172" name="__codelineno-41-172" href="#__codelineno-41-172"></a><span class="w">            </span><span class="c1">// Special case for compatibility: we don&#39;t want apps to send this,</span>
</span><span id="__span-41-173"><a id="__codelineno-41-173" name="__codelineno-41-173" href="#__codelineno-41-173"></a><span class="w">            </span><span class="c1">// but historically it has not been protected and apps may be using it</span>
</span><span id="__span-41-174"><a id="__codelineno-41-174" name="__codelineno-41-174" href="#__codelineno-41-174"></a><span class="w">            </span><span class="c1">// to poke their own app widget.  So, instead of making it protected,</span>
</span><span id="__span-41-175"><a id="__codelineno-41-175" name="__codelineno-41-175" href="#__codelineno-41-175"></a><span class="w">            </span><span class="c1">// just limit it to the caller.</span>
</span><span id="__span-41-176"><a id="__codelineno-41-176" name="__codelineno-41-176" href="#__codelineno-41-176"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">callerPackage</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-177"><a id="__codelineno-41-177" name="__codelineno-41-177" href="#__codelineno-41-177"></a><span class="w">                </span><span class="n">String</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Permission Denial: not allowed to send broadcast &quot;</span>
</span><span id="__span-41-178"><a id="__codelineno-41-178" name="__codelineno-41-178" href="#__codelineno-41-178"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; from unknown caller.&quot;</span><span class="p">;</span>
</span><span id="__span-41-179"><a id="__codelineno-41-179" name="__codelineno-41-179" href="#__codelineno-41-179"></a><span class="w">                </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span>
</span><span id="__span-41-180"><a id="__codelineno-41-180" name="__codelineno-41-180" href="#__codelineno-41-180"></a><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecurityException</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span><span id="__span-41-181"><a id="__codelineno-41-181" name="__codelineno-41-181" href="#__codelineno-41-181"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getComponent</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-182"><a id="__codelineno-41-182" name="__codelineno-41-182" href="#__codelineno-41-182"></a><span class="w">                </span><span class="c1">// They are good enough to send to an explicit component...  verify</span>
</span><span id="__span-41-183"><a id="__codelineno-41-183" name="__codelineno-41-183" href="#__codelineno-41-183"></a><span class="w">                </span><span class="c1">// it is being sent to the calling app.</span>
</span><span id="__span-41-184"><a id="__codelineno-41-184" name="__codelineno-41-184" href="#__codelineno-41-184"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">intent</span><span class="p">.</span><span class="na">getComponent</span><span class="p">().</span><span class="na">getPackageName</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span>
</span><span id="__span-41-185"><a id="__codelineno-41-185" name="__codelineno-41-185" href="#__codelineno-41-185"></a><span class="w">                        </span><span class="n">callerPackage</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-186"><a id="__codelineno-41-186" name="__codelineno-41-186" href="#__codelineno-41-186"></a><span class="w">                    </span><span class="n">String</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Permission Denial: not allowed to send broadcast &quot;</span>
</span><span id="__span-41-187"><a id="__codelineno-41-187" name="__codelineno-41-187" href="#__codelineno-41-187"></a><span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; to &quot;</span>
</span><span id="__span-41-188"><a id="__codelineno-41-188" name="__codelineno-41-188" href="#__codelineno-41-188"></a><span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getComponent</span><span class="p">().</span><span class="na">getPackageName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; from &quot;</span>
</span><span id="__span-41-189"><a id="__codelineno-41-189" name="__codelineno-41-189" href="#__codelineno-41-189"></a><span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">;</span>
</span><span id="__span-41-190"><a id="__codelineno-41-190" name="__codelineno-41-190" href="#__codelineno-41-190"></a><span class="w">                    </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span>
</span><span id="__span-41-191"><a id="__codelineno-41-191" name="__codelineno-41-191" href="#__codelineno-41-191"></a><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecurityException</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span><span id="__span-41-192"><a id="__codelineno-41-192" name="__codelineno-41-192" href="#__codelineno-41-192"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-41-193"><a id="__codelineno-41-193" name="__codelineno-41-193" href="#__codelineno-41-193"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-194"><a id="__codelineno-41-194" name="__codelineno-41-194" href="#__codelineno-41-194"></a><span class="w">                </span><span class="c1">// Limit broadcast to their own package.</span>
</span><span id="__span-41-195"><a id="__codelineno-41-195" name="__codelineno-41-195" href="#__codelineno-41-195"></a><span class="w">                </span><span class="n">intent</span><span class="p">.</span><span class="na">setPackage</span><span class="p">(</span><span class="n">callerPackage</span><span class="p">);</span>
</span><span id="__span-41-196"><a id="__codelineno-41-196" name="__codelineno-41-196" href="#__codelineno-41-196"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-41-197"><a id="__codelineno-41-197" name="__codelineno-41-197" href="#__codelineno-41-197"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-41-198"><a id="__codelineno-41-198" name="__codelineno-41-198" href="#__codelineno-41-198"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-41-199"><a id="__codelineno-41-199" name="__codelineno-41-199" href="#__codelineno-41-199"></a>
</span><span id="__span-41-200"><a id="__codelineno-41-200" name="__codelineno-41-200" href="#__codelineno-41-200"></a><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">timeoutExempt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-41-201"><a id="__codelineno-41-201" name="__codelineno-41-201" href="#__codelineno-41-201"></a>
</span><span id="__span-41-202"><a id="__codelineno-41-202" name="__codelineno-41-202" href="#__codelineno-41-202"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">action</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-203"><a id="__codelineno-41-203" name="__codelineno-41-203" href="#__codelineno-41-203"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getBackgroundLaunchBroadcasts</span><span class="p">().</span><span class="na">contains</span><span class="p">(</span><span class="n">action</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-204"><a id="__codelineno-41-204" name="__codelineno-41-204" href="#__codelineno-41-204"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BACKGROUND_CHECK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-205"><a id="__codelineno-41-205" name="__codelineno-41-205" href="#__codelineno-41-205"></a><span class="w">                </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Broadcast action &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; forcing include-background&quot;</span><span class="p">);</span>
</span><span id="__span-41-206"><a id="__codelineno-41-206" name="__codelineno-41-206" href="#__codelineno-41-206"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-41-207"><a id="__codelineno-41-207" name="__codelineno-41-207" href="#__codelineno-41-207"></a><span class="w">            </span><span class="n">intent</span><span class="p">.</span><span class="na">addFlags</span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="na">FLAG_RECEIVER_INCLUDE_BACKGROUND</span><span class="p">);</span>
</span><span id="__span-41-208"><a id="__codelineno-41-208" name="__codelineno-41-208" href="#__codelineno-41-208"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-41-209"><a id="__codelineno-41-209" name="__codelineno-41-209" href="#__codelineno-41-209"></a>
</span><span id="__span-41-210"><a id="__codelineno-41-210" name="__codelineno-41-210" href="#__codelineno-41-210"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Process</span><span class="p">.</span><span class="na">isSdkSandboxUid</span><span class="p">(</span><span class="n">realCallingUid</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-211"><a id="__codelineno-41-211" name="__codelineno-41-211" href="#__codelineno-41-211"></a><span class="w">            </span><span class="n">SdkSandboxManagerLocal</span><span class="w"> </span><span class="n">sdkSandboxManagerLocal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LocalManagerRegistry</span><span class="p">.</span><span class="na">getManager</span><span class="p">(</span>
</span><span id="__span-41-212"><a id="__codelineno-41-212" name="__codelineno-41-212" href="#__codelineno-41-212"></a><span class="w">                    </span><span class="n">SdkSandboxManagerLocal</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
</span><span id="__span-41-213"><a id="__codelineno-41-213" name="__codelineno-41-213" href="#__codelineno-41-213"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sdkSandboxManagerLocal</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-214"><a id="__codelineno-41-214" name="__codelineno-41-214" href="#__codelineno-41-214"></a><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;SdkSandboxManagerLocal not found when sending&quot;</span>
</span><span id="__span-41-215"><a id="__codelineno-41-215" name="__codelineno-41-215" href="#__codelineno-41-215"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; a broadcast from an SDK sandbox uid.&quot;</span><span class="p">);</span>
</span><span id="__span-41-216"><a id="__codelineno-41-216" name="__codelineno-41-216" href="#__codelineno-41-216"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-41-217"><a id="__codelineno-41-217" name="__codelineno-41-217" href="#__codelineno-41-217"></a><span class="w">            </span><span class="n">sdkSandboxManagerLocal</span><span class="p">.</span><span class="na">enforceAllowedToSendBroadcast</span><span class="p">(</span><span class="n">intent</span><span class="p">);</span>
</span><span id="__span-41-218"><a id="__codelineno-41-218" name="__codelineno-41-218" href="#__codelineno-41-218"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-41-219"><a id="__codelineno-41-219" name="__codelineno-41-219" href="#__codelineno-41-219"></a>
</span><span id="__span-41-220"><a id="__codelineno-41-220" name="__codelineno-41-220" href="#__codelineno-41-220"></a><span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">action</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-221"><a id="__codelineno-41-221" name="__codelineno-41-221" href="#__codelineno-41-221"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_MEDIA_SCANNER_SCAN_FILE</span><span class="p">:</span>
</span><span id="__span-41-222"><a id="__codelineno-41-222" name="__codelineno-41-222" href="#__codelineno-41-222"></a><span class="w">                </span><span class="n">UserManagerInternal</span><span class="w"> </span><span class="n">umInternal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LocalServices</span><span class="p">.</span><span class="na">getService</span><span class="p">(</span>
</span><span id="__span-41-223"><a id="__codelineno-41-223" name="__codelineno-41-223" href="#__codelineno-41-223"></a><span class="w">                        </span><span class="n">UserManagerInternal</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
</span><span id="__span-41-224"><a id="__codelineno-41-224" name="__codelineno-41-224" href="#__codelineno-41-224"></a><span class="w">                </span><span class="n">UserInfo</span><span class="w"> </span><span class="n">userInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">umInternal</span><span class="p">.</span><span class="na">getUserInfo</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span>
</span><span id="__span-41-225"><a id="__codelineno-41-225" name="__codelineno-41-225" href="#__codelineno-41-225"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">userInfo</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">userInfo</span><span class="p">.</span><span class="na">isCloneProfile</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-226"><a id="__codelineno-41-226" name="__codelineno-41-226" href="#__codelineno-41-226"></a><span class="w">                    </span><span class="n">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">umInternal</span><span class="p">.</span><span class="na">getProfileParentId</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span>
</span><span id="__span-41-227"><a id="__codelineno-41-227" name="__codelineno-41-227" href="#__codelineno-41-227"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-41-228"><a id="__codelineno-41-228" name="__codelineno-41-228" href="#__codelineno-41-228"></a><span class="w">                </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-41-229"><a id="__codelineno-41-229" name="__codelineno-41-229" href="#__codelineno-41-229"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_UID_REMOVED</span><span class="p">:</span>
</span><span id="__span-41-230"><a id="__codelineno-41-230" name="__codelineno-41-230" href="#__codelineno-41-230"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_PACKAGE_REMOVED</span><span class="p">:</span>
</span><span id="__span-41-231"><a id="__codelineno-41-231" name="__codelineno-41-231" href="#__codelineno-41-231"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_PACKAGE_CHANGED</span><span class="p">:</span>
</span><span id="__span-41-232"><a id="__codelineno-41-232" name="__codelineno-41-232" href="#__codelineno-41-232"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_EXTERNAL_APPLICATIONS_UNAVAILABLE</span><span class="p">:</span>
</span><span id="__span-41-233"><a id="__codelineno-41-233" name="__codelineno-41-233" href="#__codelineno-41-233"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_EXTERNAL_APPLICATIONS_AVAILABLE</span><span class="p">:</span>
</span><span id="__span-41-234"><a id="__codelineno-41-234" name="__codelineno-41-234" href="#__codelineno-41-234"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_PACKAGES_SUSPENDED</span><span class="p">:</span>
</span><span id="__span-41-235"><a id="__codelineno-41-235" name="__codelineno-41-235" href="#__codelineno-41-235"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_PACKAGES_UNSUSPENDED</span><span class="p">:</span>
</span><span id="__span-41-236"><a id="__codelineno-41-236" name="__codelineno-41-236" href="#__codelineno-41-236"></a><span class="w">                </span><span class="c1">// Handle special intents: if this broadcast is from the package</span>
</span><span id="__span-41-237"><a id="__codelineno-41-237" name="__codelineno-41-237" href="#__codelineno-41-237"></a><span class="w">                </span><span class="c1">// manager about a package being removed, we need to remove all of</span>
</span><span id="__span-41-238"><a id="__codelineno-41-238" name="__codelineno-41-238" href="#__codelineno-41-238"></a><span class="w">                </span><span class="c1">// its activities from the history stack.</span>
</span><span id="__span-41-239"><a id="__codelineno-41-239" name="__codelineno-41-239" href="#__codelineno-41-239"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">checkComponentPermission</span><span class="p">(</span>
</span><span id="__span-41-240"><a id="__codelineno-41-240" name="__codelineno-41-240" href="#__codelineno-41-240"></a><span class="w">                        </span><span class="n">android</span><span class="p">.</span><span class="na">Manifest</span><span class="p">.</span><span class="na">permission</span><span class="p">.</span><span class="na">BROADCAST_PACKAGE_REMOVED</span><span class="p">,</span>
</span><span id="__span-41-241"><a id="__codelineno-41-241" name="__codelineno-41-241" href="#__codelineno-41-241"></a><span class="w">                        </span><span class="n">callingPid</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
</span><span id="__span-41-242"><a id="__codelineno-41-242" name="__codelineno-41-242" href="#__codelineno-41-242"></a><span class="w">                        </span><span class="o">!=</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="na">PERMISSION_GRANTED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-243"><a id="__codelineno-41-243" name="__codelineno-41-243" href="#__codelineno-41-243"></a><span class="w">                    </span><span class="n">String</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Permission Denial: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">()</span>
</span><span id="__span-41-244"><a id="__codelineno-41-244" name="__codelineno-41-244" href="#__codelineno-41-244"></a><span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; broadcast from &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callerPackage</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; (pid=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callingPid</span>
</span><span id="__span-41-245"><a id="__codelineno-41-245" name="__codelineno-41-245" href="#__codelineno-41-245"></a><span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, uid=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callingUid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;)&quot;</span>
</span><span id="__span-41-246"><a id="__codelineno-41-246" name="__codelineno-41-246" href="#__codelineno-41-246"></a><span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; requires &quot;</span>
</span><span id="__span-41-247"><a id="__codelineno-41-247" name="__codelineno-41-247" href="#__codelineno-41-247"></a><span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">android</span><span class="p">.</span><span class="na">Manifest</span><span class="p">.</span><span class="na">permission</span><span class="p">.</span><span class="na">BROADCAST_PACKAGE_REMOVED</span><span class="p">;</span>
</span><span id="__span-41-248"><a id="__codelineno-41-248" name="__codelineno-41-248" href="#__codelineno-41-248"></a><span class="w">                    </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span>
</span><span id="__span-41-249"><a id="__codelineno-41-249" name="__codelineno-41-249" href="#__codelineno-41-249"></a><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecurityException</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span><span id="__span-41-250"><a id="__codelineno-41-250" name="__codelineno-41-250" href="#__codelineno-41-250"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-41-251"><a id="__codelineno-41-251" name="__codelineno-41-251" href="#__codelineno-41-251"></a><span class="w">                </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">action</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-252"><a id="__codelineno-41-252" name="__codelineno-41-252" href="#__codelineno-41-252"></a><span class="w">                    </span><span class="k">case</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_UID_REMOVED</span><span class="p">:</span>
</span><span id="__span-41-253"><a id="__codelineno-41-253" name="__codelineno-41-253" href="#__codelineno-41-253"></a><span class="w">                        </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">uid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getUidFromIntent</span><span class="p">(</span><span class="n">intent</span><span class="p">);</span>
</span><span id="__span-41-254"><a id="__codelineno-41-254" name="__codelineno-41-254" href="#__codelineno-41-254"></a><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">uid</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-255"><a id="__codelineno-41-255" name="__codelineno-41-255" href="#__codelineno-41-255"></a><span class="w">                            </span><span class="n">mBatteryStatsService</span><span class="p">.</span><span class="na">removeUid</span><span class="p">(</span><span class="n">uid</span><span class="p">);</span>
</span><span id="__span-41-256"><a id="__codelineno-41-256" name="__codelineno-41-256" href="#__codelineno-41-256"></a><span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getBooleanExtra</span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="na">EXTRA_REPLACING</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-257"><a id="__codelineno-41-257" name="__codelineno-41-257" href="#__codelineno-41-257"></a><span class="w">                                </span><span class="n">mAppOpsService</span><span class="p">.</span><span class="na">resetAllModes</span><span class="p">(</span><span class="n">UserHandle</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(</span><span class="n">uid</span><span class="p">),</span>
</span><span id="__span-41-258"><a id="__codelineno-41-258" name="__codelineno-41-258" href="#__codelineno-41-258"></a><span class="w">                                        </span><span class="n">intent</span><span class="p">.</span><span class="na">getStringExtra</span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="na">EXTRA_PACKAGE_NAME</span><span class="p">));</span>
</span><span id="__span-41-259"><a id="__codelineno-41-259" name="__codelineno-41-259" href="#__codelineno-41-259"></a><span class="w">                            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-260"><a id="__codelineno-41-260" name="__codelineno-41-260" href="#__codelineno-41-260"></a><span class="w">                                </span><span class="n">mAppOpsService</span><span class="p">.</span><span class="na">uidRemoved</span><span class="p">(</span><span class="n">uid</span><span class="p">);</span>
</span><span id="__span-41-261"><a id="__codelineno-41-261" name="__codelineno-41-261" href="#__codelineno-41-261"></a><span class="w">                            </span><span class="p">}</span>
</span><span id="__span-41-262"><a id="__codelineno-41-262" name="__codelineno-41-262" href="#__codelineno-41-262"></a><span class="w">                        </span><span class="p">}</span>
</span><span id="__span-41-263"><a id="__codelineno-41-263" name="__codelineno-41-263" href="#__codelineno-41-263"></a><span class="w">                        </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-41-264"><a id="__codelineno-41-264" name="__codelineno-41-264" href="#__codelineno-41-264"></a><span class="w">                    </span><span class="k">case</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_EXTERNAL_APPLICATIONS_UNAVAILABLE</span><span class="p">:</span>
</span><span id="__span-41-265"><a id="__codelineno-41-265" name="__codelineno-41-265" href="#__codelineno-41-265"></a><span class="w">                        </span><span class="c1">// If resources are unavailable just force stop all those packages</span>
</span><span id="__span-41-266"><a id="__codelineno-41-266" name="__codelineno-41-266" href="#__codelineno-41-266"></a><span class="w">                        </span><span class="c1">// and flush the attribute cache as well.</span>
</span><span id="__span-41-267"><a id="__codelineno-41-267" name="__codelineno-41-267" href="#__codelineno-41-267"></a><span class="w">                        </span><span class="n">String</span><span class="w"> </span><span class="n">list</span><span class="o">[]</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-41-268"><a id="__codelineno-41-268" name="__codelineno-41-268" href="#__codelineno-41-268"></a><span class="w">                                </span><span class="n">intent</span><span class="p">.</span><span class="na">getStringArrayExtra</span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="na">EXTRA_CHANGED_PACKAGE_LIST</span><span class="p">);</span>
</span><span id="__span-41-269"><a id="__codelineno-41-269" name="__codelineno-41-269" href="#__codelineno-41-269"></a><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">list</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">list</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-270"><a id="__codelineno-41-270" name="__codelineno-41-270" href="#__codelineno-41-270"></a><span class="w">                            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">list</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-271"><a id="__codelineno-41-271" name="__codelineno-41-271" href="#__codelineno-41-271"></a><span class="w">                                </span><span class="n">forceStopPackageLocked</span><span class="p">(</span><span class="n">list</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-41-272"><a id="__codelineno-41-272" name="__codelineno-41-272" href="#__codelineno-41-272"></a><span class="w">                                        </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;storage unmount&quot;</span><span class="p">);</span>
</span><span id="__span-41-273"><a id="__codelineno-41-273" name="__codelineno-41-273" href="#__codelineno-41-273"></a><span class="w">                            </span><span class="p">}</span>
</span><span id="__span-41-274"><a id="__codelineno-41-274" name="__codelineno-41-274" href="#__codelineno-41-274"></a><span class="w">                            </span><span class="n">mAtmInternal</span><span class="p">.</span><span class="na">cleanupRecentTasksForUser</span><span class="p">(</span><span class="n">UserHandle</span><span class="p">.</span><span class="na">USER_ALL</span><span class="p">);</span>
</span><span id="__span-41-275"><a id="__codelineno-41-275" name="__codelineno-41-275" href="#__codelineno-41-275"></a><span class="w">                            </span><span class="n">sendPackageBroadcastLocked</span><span class="p">(</span>
</span><span id="__span-41-276"><a id="__codelineno-41-276" name="__codelineno-41-276" href="#__codelineno-41-276"></a><span class="w">                                    </span><span class="n">ApplicationThreadConstants</span><span class="p">.</span><span class="na">EXTERNAL_STORAGE_UNAVAILABLE</span><span class="p">,</span>
</span><span id="__span-41-277"><a id="__codelineno-41-277" name="__codelineno-41-277" href="#__codelineno-41-277"></a><span class="w">                                    </span><span class="n">list</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">);</span>
</span><span id="__span-41-278"><a id="__codelineno-41-278" name="__codelineno-41-278" href="#__codelineno-41-278"></a><span class="w">                        </span><span class="p">}</span>
</span><span id="__span-41-279"><a id="__codelineno-41-279" name="__codelineno-41-279" href="#__codelineno-41-279"></a><span class="w">                        </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-41-280"><a id="__codelineno-41-280" name="__codelineno-41-280" href="#__codelineno-41-280"></a><span class="w">                    </span><span class="k">case</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_EXTERNAL_APPLICATIONS_AVAILABLE</span><span class="p">:</span>
</span><span id="__span-41-281"><a id="__codelineno-41-281" name="__codelineno-41-281" href="#__codelineno-41-281"></a><span class="w">                        </span><span class="n">mAtmInternal</span><span class="p">.</span><span class="na">cleanupRecentTasksForUser</span><span class="p">(</span><span class="n">UserHandle</span><span class="p">.</span><span class="na">USER_ALL</span><span class="p">);</span>
</span><span id="__span-41-282"><a id="__codelineno-41-282" name="__codelineno-41-282" href="#__codelineno-41-282"></a><span class="w">                        </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-41-283"><a id="__codelineno-41-283" name="__codelineno-41-283" href="#__codelineno-41-283"></a><span class="w">                    </span><span class="k">case</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_PACKAGE_REMOVED</span><span class="p">:</span>
</span><span id="__span-41-284"><a id="__codelineno-41-284" name="__codelineno-41-284" href="#__codelineno-41-284"></a><span class="w">                    </span><span class="k">case</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_PACKAGE_CHANGED</span><span class="p">:</span>
</span><span id="__span-41-285"><a id="__codelineno-41-285" name="__codelineno-41-285" href="#__codelineno-41-285"></a><span class="w">                        </span><span class="n">Uri</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getData</span><span class="p">();</span>
</span><span id="__span-41-286"><a id="__codelineno-41-286" name="__codelineno-41-286" href="#__codelineno-41-286"></a><span class="w">                        </span><span class="n">String</span><span class="w"> </span><span class="n">ssp</span><span class="p">;</span>
</span><span id="__span-41-287"><a id="__codelineno-41-287" name="__codelineno-41-287" href="#__codelineno-41-287"></a><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">ssp</span><span class="o">=</span><span class="n">data</span><span class="p">.</span><span class="na">getSchemeSpecificPart</span><span class="p">())</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-288"><a id="__codelineno-41-288" name="__codelineno-41-288" href="#__codelineno-41-288"></a><span class="w">                            </span><span class="kt">boolean</span><span class="w"> </span><span class="n">removed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_PACKAGE_REMOVED</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">action</span><span class="p">);</span>
</span><span id="__span-41-289"><a id="__codelineno-41-289" name="__codelineno-41-289" href="#__codelineno-41-289"></a><span class="w">                            </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">replacing</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-41-290"><a id="__codelineno-41-290" name="__codelineno-41-290" href="#__codelineno-41-290"></a><span class="w">                                    </span><span class="n">intent</span><span class="p">.</span><span class="na">getBooleanExtra</span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="na">EXTRA_REPLACING</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
</span><span id="__span-41-291"><a id="__codelineno-41-291" name="__codelineno-41-291" href="#__codelineno-41-291"></a><span class="w">                            </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">killProcess</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-41-292"><a id="__codelineno-41-292" name="__codelineno-41-292" href="#__codelineno-41-292"></a><span class="w">                                    </span><span class="o">!</span><span class="n">intent</span><span class="p">.</span><span class="na">getBooleanExtra</span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="na">EXTRA_DONT_KILL_APP</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
</span><span id="__span-41-293"><a id="__codelineno-41-293" name="__codelineno-41-293" href="#__codelineno-41-293"></a><span class="w">                            </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">fullUninstall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">removed</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">replacing</span><span class="p">;</span>
</span><span id="__span-41-294"><a id="__codelineno-41-294" name="__codelineno-41-294" href="#__codelineno-41-294"></a><span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">removed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-295"><a id="__codelineno-41-295" name="__codelineno-41-295" href="#__codelineno-41-295"></a><span class="w">                                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">killProcess</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-296"><a id="__codelineno-41-296" name="__codelineno-41-296" href="#__codelineno-41-296"></a><span class="w">                                    </span><span class="n">forceStopPackageLocked</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span><span class="w"> </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">getAppId</span><span class="p">(</span>
</span><span id="__span-41-297"><a id="__codelineno-41-297" name="__codelineno-41-297" href="#__codelineno-41-297"></a><span class="w">                                            </span><span class="n">intent</span><span class="p">.</span><span class="na">getIntExtra</span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="na">EXTRA_UID</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
</span><span id="__span-41-298"><a id="__codelineno-41-298" name="__codelineno-41-298" href="#__codelineno-41-298"></a><span class="w">                                            </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">fullUninstall</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span>
</span><span id="__span-41-299"><a id="__codelineno-41-299" name="__codelineno-41-299" href="#__codelineno-41-299"></a><span class="w">                                            </span><span class="n">removed</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;pkg removed&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">&quot;pkg changed&quot;</span><span class="p">);</span>
</span><span id="__span-41-300"><a id="__codelineno-41-300" name="__codelineno-41-300" href="#__codelineno-41-300"></a><span class="w">                                    </span><span class="n">getPackageManagerInternal</span><span class="p">()</span>
</span><span id="__span-41-301"><a id="__codelineno-41-301" name="__codelineno-41-301" href="#__codelineno-41-301"></a><span class="w">                                            </span><span class="p">.</span><span class="na">onPackageProcessKilledForUninstall</span><span class="p">(</span><span class="n">ssp</span><span class="p">);</span>
</span><span id="__span-41-302"><a id="__codelineno-41-302" name="__codelineno-41-302" href="#__codelineno-41-302"></a><span class="w">                                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-303"><a id="__codelineno-41-303" name="__codelineno-41-303" href="#__codelineno-41-303"></a><span class="w">                                    </span><span class="c1">// Kill any app zygotes always, since they can&#39;t fork new</span>
</span><span id="__span-41-304"><a id="__codelineno-41-304" name="__codelineno-41-304" href="#__codelineno-41-304"></a><span class="w">                                    </span><span class="c1">// processes with references to the old code</span>
</span><span id="__span-41-305"><a id="__codelineno-41-305" name="__codelineno-41-305" href="#__codelineno-41-305"></a><span class="w">                                    </span><span class="n">forceStopAppZygoteLocked</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span><span class="w"> </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">getAppId</span><span class="p">(</span>
</span><span id="__span-41-306"><a id="__codelineno-41-306" name="__codelineno-41-306" href="#__codelineno-41-306"></a><span class="w">                                            </span><span class="n">intent</span><span class="p">.</span><span class="na">getIntExtra</span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="na">EXTRA_UID</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
</span><span id="__span-41-307"><a id="__codelineno-41-307" name="__codelineno-41-307" href="#__codelineno-41-307"></a><span class="w">                                            </span><span class="n">userId</span><span class="p">);</span>
</span><span id="__span-41-308"><a id="__codelineno-41-308" name="__codelineno-41-308" href="#__codelineno-41-308"></a><span class="w">                                </span><span class="p">}</span>
</span><span id="__span-41-309"><a id="__codelineno-41-309" name="__codelineno-41-309" href="#__codelineno-41-309"></a><span class="w">                                </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">killProcess</span>
</span><span id="__span-41-310"><a id="__codelineno-41-310" name="__codelineno-41-310" href="#__codelineno-41-310"></a><span class="w">                                        </span><span class="o">?</span><span class="w"> </span><span class="n">ApplicationThreadConstants</span><span class="p">.</span><span class="na">PACKAGE_REMOVED</span>
</span><span id="__span-41-311"><a id="__codelineno-41-311" name="__codelineno-41-311" href="#__codelineno-41-311"></a><span class="w">                                        </span><span class="p">:</span><span class="w"> </span><span class="n">ApplicationThreadConstants</span><span class="p">.</span><span class="na">PACKAGE_REMOVED_DONT_KILL</span><span class="p">;</span>
</span><span id="__span-41-312"><a id="__codelineno-41-312" name="__codelineno-41-312" href="#__codelineno-41-312"></a><span class="w">                                </span><span class="n">sendPackageBroadcastLocked</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span>
</span><span id="__span-41-313"><a id="__codelineno-41-313" name="__codelineno-41-313" href="#__codelineno-41-313"></a><span class="w">                                        </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="n">ssp</span><span class="p">},</span><span class="w"> </span><span class="n">userId</span><span class="p">);</span>
</span><span id="__span-41-314"><a id="__codelineno-41-314" name="__codelineno-41-314" href="#__codelineno-41-314"></a><span class="w">                                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fullUninstall</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-315"><a id="__codelineno-41-315" name="__codelineno-41-315" href="#__codelineno-41-315"></a><span class="w">                                    </span><span class="n">mAppOpsService</span><span class="p">.</span><span class="na">packageRemoved</span><span class="p">(</span>
</span><span id="__span-41-316"><a id="__codelineno-41-316" name="__codelineno-41-316" href="#__codelineno-41-316"></a><span class="w">                                            </span><span class="n">intent</span><span class="p">.</span><span class="na">getIntExtra</span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="na">EXTRA_UID</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">ssp</span><span class="p">);</span>
</span><span id="__span-41-317"><a id="__codelineno-41-317" name="__codelineno-41-317" href="#__codelineno-41-317"></a>
</span><span id="__span-41-318"><a id="__codelineno-41-318" name="__codelineno-41-318" href="#__codelineno-41-318"></a><span class="w">                                    </span><span class="c1">// Remove all permissions granted from/to this package</span>
</span><span id="__span-41-319"><a id="__codelineno-41-319" name="__codelineno-41-319" href="#__codelineno-41-319"></a><span class="w">                                    </span><span class="n">mUgmInternal</span><span class="p">.</span><span class="na">removeUriPermissionsForPackage</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span>
</span><span id="__span-41-320"><a id="__codelineno-41-320" name="__codelineno-41-320" href="#__codelineno-41-320"></a><span class="w">                                            </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
</span><span id="__span-41-321"><a id="__codelineno-41-321" name="__codelineno-41-321" href="#__codelineno-41-321"></a>
</span><span id="__span-41-322"><a id="__codelineno-41-322" name="__codelineno-41-322" href="#__codelineno-41-322"></a><span class="w">                                    </span><span class="n">mAtmInternal</span><span class="p">.</span><span class="na">removeRecentTasksByPackageName</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">);</span>
</span><span id="__span-41-323"><a id="__codelineno-41-323" name="__codelineno-41-323" href="#__codelineno-41-323"></a>
</span><span id="__span-41-324"><a id="__codelineno-41-324" name="__codelineno-41-324" href="#__codelineno-41-324"></a><span class="w">                                    </span><span class="n">mServices</span><span class="p">.</span><span class="na">forceStopPackageLocked</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">);</span>
</span><span id="__span-41-325"><a id="__codelineno-41-325" name="__codelineno-41-325" href="#__codelineno-41-325"></a><span class="w">                                    </span><span class="n">mAtmInternal</span><span class="p">.</span><span class="na">onPackageUninstalled</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">);</span>
</span><span id="__span-41-326"><a id="__codelineno-41-326" name="__codelineno-41-326" href="#__codelineno-41-326"></a><span class="w">                                    </span><span class="n">mBatteryStatsService</span><span class="p">.</span><span class="na">notePackageUninstalled</span><span class="p">(</span><span class="n">ssp</span><span class="p">);</span>
</span><span id="__span-41-327"><a id="__codelineno-41-327" name="__codelineno-41-327" href="#__codelineno-41-327"></a><span class="w">                                </span><span class="p">}</span>
</span><span id="__span-41-328"><a id="__codelineno-41-328" name="__codelineno-41-328" href="#__codelineno-41-328"></a><span class="w">                            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-329"><a id="__codelineno-41-329" name="__codelineno-41-329" href="#__codelineno-41-329"></a><span class="w">                                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">killProcess</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-330"><a id="__codelineno-41-330" name="__codelineno-41-330" href="#__codelineno-41-330"></a><span class="w">                                    </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">extraUid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getIntExtra</span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="na">EXTRA_UID</span><span class="p">,</span>
</span><span id="__span-41-331"><a id="__codelineno-41-331" name="__codelineno-41-331" href="#__codelineno-41-331"></a><span class="w">                                            </span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-41-332"><a id="__codelineno-41-332" name="__codelineno-41-332" href="#__codelineno-41-332"></a><span class="w">                                    </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mProcLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-333"><a id="__codelineno-41-333" name="__codelineno-41-333" href="#__codelineno-41-333"></a><span class="w">                                        </span><span class="n">mProcessList</span><span class="p">.</span><span class="na">killPackageProcessesLSP</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span>
</span><span id="__span-41-334"><a id="__codelineno-41-334" name="__codelineno-41-334" href="#__codelineno-41-334"></a><span class="w">                                                </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">getAppId</span><span class="p">(</span><span class="n">extraUid</span><span class="p">),</span>
</span><span id="__span-41-335"><a id="__codelineno-41-335" name="__codelineno-41-335" href="#__codelineno-41-335"></a><span class="w">                                                </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">ProcessList</span><span class="p">.</span><span class="na">INVALID_ADJ</span><span class="p">,</span>
</span><span id="__span-41-336"><a id="__codelineno-41-336" name="__codelineno-41-336" href="#__codelineno-41-336"></a><span class="w">                                                </span><span class="n">ApplicationExitInfo</span><span class="p">.</span><span class="na">REASON_USER_REQUESTED</span><span class="p">,</span>
</span><span id="__span-41-337"><a id="__codelineno-41-337" name="__codelineno-41-337" href="#__codelineno-41-337"></a><span class="w">                                                </span><span class="n">ApplicationExitInfo</span><span class="p">.</span><span class="na">SUBREASON_PACKAGE_UPDATE</span><span class="p">,</span>
</span><span id="__span-41-338"><a id="__codelineno-41-338" name="__codelineno-41-338" href="#__codelineno-41-338"></a><span class="w">                                                </span><span class="s">&quot;change &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ssp</span><span class="p">);</span>
</span><span id="__span-41-339"><a id="__codelineno-41-339" name="__codelineno-41-339" href="#__codelineno-41-339"></a><span class="w">                                    </span><span class="p">}</span>
</span><span id="__span-41-340"><a id="__codelineno-41-340" name="__codelineno-41-340" href="#__codelineno-41-340"></a><span class="w">                                </span><span class="p">}</span>
</span><span id="__span-41-341"><a id="__codelineno-41-341" name="__codelineno-41-341" href="#__codelineno-41-341"></a><span class="w">                                </span><span class="n">cleanupDisabledPackageComponentsLocked</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span>
</span><span id="__span-41-342"><a id="__codelineno-41-342" name="__codelineno-41-342" href="#__codelineno-41-342"></a><span class="w">                                        </span><span class="n">intent</span><span class="p">.</span><span class="na">getStringArrayExtra</span><span class="p">(</span>
</span><span id="__span-41-343"><a id="__codelineno-41-343" name="__codelineno-41-343" href="#__codelineno-41-343"></a><span class="w">                                                </span><span class="n">Intent</span><span class="p">.</span><span class="na">EXTRA_CHANGED_COMPONENT_NAME_LIST</span><span class="p">));</span>
</span><span id="__span-41-344"><a id="__codelineno-41-344" name="__codelineno-41-344" href="#__codelineno-41-344"></a><span class="w">                                </span><span class="n">mServices</span><span class="p">.</span><span class="na">schedulePendingServiceStartLocked</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">);</span>
</span><span id="__span-41-345"><a id="__codelineno-41-345" name="__codelineno-41-345" href="#__codelineno-41-345"></a><span class="w">                            </span><span class="p">}</span>
</span><span id="__span-41-346"><a id="__codelineno-41-346" name="__codelineno-41-346" href="#__codelineno-41-346"></a><span class="w">                        </span><span class="p">}</span>
</span><span id="__span-41-347"><a id="__codelineno-41-347" name="__codelineno-41-347" href="#__codelineno-41-347"></a><span class="w">                        </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-41-348"><a id="__codelineno-41-348" name="__codelineno-41-348" href="#__codelineno-41-348"></a><span class="w">                    </span><span class="k">case</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_PACKAGES_SUSPENDED</span><span class="p">:</span>
</span><span id="__span-41-349"><a id="__codelineno-41-349" name="__codelineno-41-349" href="#__codelineno-41-349"></a><span class="w">                    </span><span class="k">case</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_PACKAGES_UNSUSPENDED</span><span class="p">:</span>
</span><span id="__span-41-350"><a id="__codelineno-41-350" name="__codelineno-41-350" href="#__codelineno-41-350"></a><span class="w">                        </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">suspended</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_PACKAGES_SUSPENDED</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span>
</span><span id="__span-41-351"><a id="__codelineno-41-351" name="__codelineno-41-351" href="#__codelineno-41-351"></a><span class="w">                                </span><span class="n">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">());</span>
</span><span id="__span-41-352"><a id="__codelineno-41-352" name="__codelineno-41-352" href="#__codelineno-41-352"></a><span class="w">                        </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">packageNames</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getStringArrayExtra</span><span class="p">(</span>
</span><span id="__span-41-353"><a id="__codelineno-41-353" name="__codelineno-41-353" href="#__codelineno-41-353"></a><span class="w">                                </span><span class="n">Intent</span><span class="p">.</span><span class="na">EXTRA_CHANGED_PACKAGE_LIST</span><span class="p">);</span>
</span><span id="__span-41-354"><a id="__codelineno-41-354" name="__codelineno-41-354" href="#__codelineno-41-354"></a><span class="w">                        </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">userIdExtra</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getIntExtra</span><span class="p">(</span>
</span><span id="__span-41-355"><a id="__codelineno-41-355" name="__codelineno-41-355" href="#__codelineno-41-355"></a><span class="w">                                </span><span class="n">Intent</span><span class="p">.</span><span class="na">EXTRA_USER_HANDLE</span><span class="p">,</span><span class="w"> </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">USER_NULL</span><span class="p">);</span>
</span><span id="__span-41-356"><a id="__codelineno-41-356" name="__codelineno-41-356" href="#__codelineno-41-356"></a>
</span><span id="__span-41-357"><a id="__codelineno-41-357" name="__codelineno-41-357" href="#__codelineno-41-357"></a><span class="w">                        </span><span class="n">mAtmInternal</span><span class="p">.</span><span class="na">onPackagesSuspendedChanged</span><span class="p">(</span><span class="n">packageNames</span><span class="p">,</span><span class="w"> </span><span class="n">suspended</span><span class="p">,</span>
</span><span id="__span-41-358"><a id="__codelineno-41-358" name="__codelineno-41-358" href="#__codelineno-41-358"></a><span class="w">                                </span><span class="n">userIdExtra</span><span class="p">);</span>
</span><span id="__span-41-359"><a id="__codelineno-41-359" name="__codelineno-41-359" href="#__codelineno-41-359"></a><span class="w">                        </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-41-360"><a id="__codelineno-41-360" name="__codelineno-41-360" href="#__codelineno-41-360"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-41-361"><a id="__codelineno-41-361" name="__codelineno-41-361" href="#__codelineno-41-361"></a><span class="w">                </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-41-362"><a id="__codelineno-41-362" name="__codelineno-41-362" href="#__codelineno-41-362"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_PACKAGE_REPLACED</span><span class="p">:</span>
</span><span id="__span-41-363"><a id="__codelineno-41-363" name="__codelineno-41-363" href="#__codelineno-41-363"></a><span class="w">            </span><span class="p">{</span>
</span><span id="__span-41-364"><a id="__codelineno-41-364" name="__codelineno-41-364" href="#__codelineno-41-364"></a><span class="w">                </span><span class="kd">final</span><span class="w"> </span><span class="n">Uri</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getData</span><span class="p">();</span>
</span><span id="__span-41-365"><a id="__codelineno-41-365" name="__codelineno-41-365" href="#__codelineno-41-365"></a><span class="w">                </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">ssp</span><span class="p">;</span>
</span><span id="__span-41-366"><a id="__codelineno-41-366" name="__codelineno-41-366" href="#__codelineno-41-366"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">ssp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="na">getSchemeSpecificPart</span><span class="p">())</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-367"><a id="__codelineno-41-367" name="__codelineno-41-367" href="#__codelineno-41-367"></a><span class="w">                    </span><span class="n">ApplicationInfo</span><span class="w"> </span><span class="n">aInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-41-368"><a id="__codelineno-41-368" name="__codelineno-41-368" href="#__codelineno-41-368"></a><span class="w">                    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-369"><a id="__codelineno-41-369" name="__codelineno-41-369" href="#__codelineno-41-369"></a><span class="w">                        </span><span class="n">aInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AppGlobals</span><span class="p">.</span><span class="na">getPackageManager</span><span class="p">()</span>
</span><span id="__span-41-370"><a id="__codelineno-41-370" name="__codelineno-41-370" href="#__codelineno-41-370"></a><span class="w">                                </span><span class="p">.</span><span class="na">getApplicationInfo</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span><span class="w"> </span><span class="n">STOCK_PM_FLAGS</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">);</span>
</span><span id="__span-41-371"><a id="__codelineno-41-371" name="__codelineno-41-371" href="#__codelineno-41-371"></a><span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">ignore</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-41-372"><a id="__codelineno-41-372" name="__codelineno-41-372" href="#__codelineno-41-372"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">aInfo</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-373"><a id="__codelineno-41-373" name="__codelineno-41-373" href="#__codelineno-41-373"></a><span class="w">                        </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Dropping ACTION_PACKAGE_REPLACED for non-existent pkg:&quot;</span>
</span><span id="__span-41-374"><a id="__codelineno-41-374" name="__codelineno-41-374" href="#__codelineno-41-374"></a><span class="w">                                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; ssp=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ssp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; data=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">data</span><span class="p">);</span>
</span><span id="__span-41-375"><a id="__codelineno-41-375" name="__codelineno-41-375" href="#__codelineno-41-375"></a><span class="w">                        </span><span class="k">return</span><span class="w"> </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">BROADCAST_SUCCESS</span><span class="p">;</span>
</span><span id="__span-41-376"><a id="__codelineno-41-376" name="__codelineno-41-376" href="#__codelineno-41-376"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-41-377"><a id="__codelineno-41-377" name="__codelineno-41-377" href="#__codelineno-41-377"></a><span class="w">                    </span><span class="n">updateAssociationForApp</span><span class="p">(</span><span class="n">aInfo</span><span class="p">);</span>
</span><span id="__span-41-378"><a id="__codelineno-41-378" name="__codelineno-41-378" href="#__codelineno-41-378"></a><span class="w">                    </span><span class="n">mAtmInternal</span><span class="p">.</span><span class="na">onPackageReplaced</span><span class="p">(</span><span class="n">aInfo</span><span class="p">);</span>
</span><span id="__span-41-379"><a id="__codelineno-41-379" name="__codelineno-41-379" href="#__codelineno-41-379"></a><span class="w">                    </span><span class="n">mServices</span><span class="p">.</span><span class="na">updateServiceApplicationInfoLocked</span><span class="p">(</span><span class="n">aInfo</span><span class="p">);</span>
</span><span id="__span-41-380"><a id="__codelineno-41-380" name="__codelineno-41-380" href="#__codelineno-41-380"></a><span class="w">                    </span><span class="n">sendPackageBroadcastLocked</span><span class="p">(</span><span class="n">ApplicationThreadConstants</span><span class="p">.</span><span class="na">PACKAGE_REPLACED</span><span class="p">,</span>
</span><span id="__span-41-381"><a id="__codelineno-41-381" name="__codelineno-41-381" href="#__codelineno-41-381"></a><span class="w">                            </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="n">ssp</span><span class="p">},</span><span class="w"> </span><span class="n">userId</span><span class="p">);</span>
</span><span id="__span-41-382"><a id="__codelineno-41-382" name="__codelineno-41-382" href="#__codelineno-41-382"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-41-383"><a id="__codelineno-41-383" name="__codelineno-41-383" href="#__codelineno-41-383"></a><span class="w">                </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-41-384"><a id="__codelineno-41-384" name="__codelineno-41-384" href="#__codelineno-41-384"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-41-385"><a id="__codelineno-41-385" name="__codelineno-41-385" href="#__codelineno-41-385"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_PACKAGE_ADDED</span><span class="p">:</span>
</span><span id="__span-41-386"><a id="__codelineno-41-386" name="__codelineno-41-386" href="#__codelineno-41-386"></a><span class="w">            </span><span class="p">{</span>
</span><span id="__span-41-387"><a id="__codelineno-41-387" name="__codelineno-41-387" href="#__codelineno-41-387"></a><span class="w">                </span><span class="c1">// Special case for adding a package: by default turn on compatibility mode.</span>
</span><span id="__span-41-388"><a id="__codelineno-41-388" name="__codelineno-41-388" href="#__codelineno-41-388"></a><span class="w">                </span><span class="n">Uri</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getData</span><span class="p">();</span>
</span><span id="__span-41-389"><a id="__codelineno-41-389" name="__codelineno-41-389" href="#__codelineno-41-389"></a><span class="w">                </span><span class="n">String</span><span class="w"> </span><span class="n">ssp</span><span class="p">;</span>
</span><span id="__span-41-390"><a id="__codelineno-41-390" name="__codelineno-41-390" href="#__codelineno-41-390"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">ssp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="na">getSchemeSpecificPart</span><span class="p">())</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-391"><a id="__codelineno-41-391" name="__codelineno-41-391" href="#__codelineno-41-391"></a><span class="w">                    </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">replacing</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-41-392"><a id="__codelineno-41-392" name="__codelineno-41-392" href="#__codelineno-41-392"></a><span class="w">                            </span><span class="n">intent</span><span class="p">.</span><span class="na">getBooleanExtra</span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="na">EXTRA_REPLACING</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
</span><span id="__span-41-393"><a id="__codelineno-41-393" name="__codelineno-41-393" href="#__codelineno-41-393"></a><span class="w">                    </span><span class="n">mAtmInternal</span><span class="p">.</span><span class="na">onPackageAdded</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span><span class="w"> </span><span class="n">replacing</span><span class="p">);</span>
</span><span id="__span-41-394"><a id="__codelineno-41-394" name="__codelineno-41-394" href="#__codelineno-41-394"></a>
</span><span id="__span-41-395"><a id="__codelineno-41-395" name="__codelineno-41-395" href="#__codelineno-41-395"></a><span class="w">                    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-396"><a id="__codelineno-41-396" name="__codelineno-41-396" href="#__codelineno-41-396"></a><span class="w">                        </span><span class="n">ApplicationInfo</span><span class="w"> </span><span class="n">ai</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AppGlobals</span><span class="p">.</span><span class="na">getPackageManager</span><span class="p">().</span>
</span><span id="__span-41-397"><a id="__codelineno-41-397" name="__codelineno-41-397" href="#__codelineno-41-397"></a><span class="w">                                </span><span class="n">getApplicationInfo</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span><span class="w"> </span><span class="n">STOCK_PM_FLAGS</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-41-398"><a id="__codelineno-41-398" name="__codelineno-41-398" href="#__codelineno-41-398"></a><span class="w">                        </span><span class="n">mBatteryStatsService</span><span class="p">.</span><span class="na">notePackageInstalled</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span>
</span><span id="__span-41-399"><a id="__codelineno-41-399" name="__codelineno-41-399" href="#__codelineno-41-399"></a><span class="w">                                </span><span class="n">ai</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">ai</span><span class="p">.</span><span class="na">longVersionCode</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-41-400"><a id="__codelineno-41-400" name="__codelineno-41-400" href="#__codelineno-41-400"></a><span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-401"><a id="__codelineno-41-401" name="__codelineno-41-401" href="#__codelineno-41-401"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-41-402"><a id="__codelineno-41-402" name="__codelineno-41-402" href="#__codelineno-41-402"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-41-403"><a id="__codelineno-41-403" name="__codelineno-41-403" href="#__codelineno-41-403"></a><span class="w">                </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-41-404"><a id="__codelineno-41-404" name="__codelineno-41-404" href="#__codelineno-41-404"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-41-405"><a id="__codelineno-41-405" name="__codelineno-41-405" href="#__codelineno-41-405"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_PACKAGE_DATA_CLEARED</span><span class="p">:</span>
</span><span id="__span-41-406"><a id="__codelineno-41-406" name="__codelineno-41-406" href="#__codelineno-41-406"></a><span class="w">            </span><span class="p">{</span>
</span><span id="__span-41-407"><a id="__codelineno-41-407" name="__codelineno-41-407" href="#__codelineno-41-407"></a><span class="w">                </span><span class="n">Uri</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getData</span><span class="p">();</span>
</span><span id="__span-41-408"><a id="__codelineno-41-408" name="__codelineno-41-408" href="#__codelineno-41-408"></a><span class="w">                </span><span class="n">String</span><span class="w"> </span><span class="n">ssp</span><span class="p">;</span>
</span><span id="__span-41-409"><a id="__codelineno-41-409" name="__codelineno-41-409" href="#__codelineno-41-409"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">ssp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="na">getSchemeSpecificPart</span><span class="p">())</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-410"><a id="__codelineno-41-410" name="__codelineno-41-410" href="#__codelineno-41-410"></a><span class="w">                    </span><span class="n">mAtmInternal</span><span class="p">.</span><span class="na">onPackageDataCleared</span><span class="p">(</span><span class="n">ssp</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">);</span>
</span><span id="__span-41-411"><a id="__codelineno-41-411" name="__codelineno-41-411" href="#__codelineno-41-411"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-41-412"><a id="__codelineno-41-412" name="__codelineno-41-412" href="#__codelineno-41-412"></a><span class="w">                </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-41-413"><a id="__codelineno-41-413" name="__codelineno-41-413" href="#__codelineno-41-413"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-41-414"><a id="__codelineno-41-414" name="__codelineno-41-414" href="#__codelineno-41-414"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_TIMEZONE_CHANGED</span><span class="p">:</span>
</span><span id="__span-41-415"><a id="__codelineno-41-415" name="__codelineno-41-415" href="#__codelineno-41-415"></a><span class="w">                </span><span class="c1">// If this is the time zone changed action, queue up a message that will reset</span>
</span><span id="__span-41-416"><a id="__codelineno-41-416" name="__codelineno-41-416" href="#__codelineno-41-416"></a><span class="w">                </span><span class="c1">// the timezone of all currently running processes. This message will get</span>
</span><span id="__span-41-417"><a id="__codelineno-41-417" name="__codelineno-41-417" href="#__codelineno-41-417"></a><span class="w">                </span><span class="c1">// queued up before the broadcast happens.</span>
</span><span id="__span-41-418"><a id="__codelineno-41-418" name="__codelineno-41-418" href="#__codelineno-41-418"></a><span class="w">                </span><span class="n">mHandler</span><span class="p">.</span><span class="na">sendEmptyMessage</span><span class="p">(</span><span class="n">UPDATE_TIME_ZONE</span><span class="p">);</span>
</span><span id="__span-41-419"><a id="__codelineno-41-419" name="__codelineno-41-419" href="#__codelineno-41-419"></a><span class="w">                </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-41-420"><a id="__codelineno-41-420" name="__codelineno-41-420" href="#__codelineno-41-420"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_TIME_CHANGED</span><span class="p">:</span>
</span><span id="__span-41-421"><a id="__codelineno-41-421" name="__codelineno-41-421" href="#__codelineno-41-421"></a><span class="w">                </span><span class="c1">// EXTRA_TIME_PREF_24_HOUR_FORMAT is optional so we must distinguish between</span>
</span><span id="__span-41-422"><a id="__codelineno-41-422" name="__codelineno-41-422" href="#__codelineno-41-422"></a><span class="w">                </span><span class="c1">// the tri-state value it may contain and &quot;unknown&quot;.</span>
</span><span id="__span-41-423"><a id="__codelineno-41-423" name="__codelineno-41-423" href="#__codelineno-41-423"></a><span class="w">                </span><span class="c1">// For convenience we re-use the Intent extra values.</span>
</span><span id="__span-41-424"><a id="__codelineno-41-424" name="__codelineno-41-424" href="#__codelineno-41-424"></a><span class="w">                </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">NO_EXTRA_VALUE_FOUND</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-41-425"><a id="__codelineno-41-425" name="__codelineno-41-425" href="#__codelineno-41-425"></a><span class="w">                </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">timeFormatPreferenceMsgValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getIntExtra</span><span class="p">(</span>
</span><span id="__span-41-426"><a id="__codelineno-41-426" name="__codelineno-41-426" href="#__codelineno-41-426"></a><span class="w">                        </span><span class="n">Intent</span><span class="p">.</span><span class="na">EXTRA_TIME_PREF_24_HOUR_FORMAT</span><span class="p">,</span>
</span><span id="__span-41-427"><a id="__codelineno-41-427" name="__codelineno-41-427" href="#__codelineno-41-427"></a><span class="w">                        </span><span class="n">NO_EXTRA_VALUE_FOUND</span><span class="w"> </span><span class="cm">/* defaultValue */</span><span class="p">);</span>
</span><span id="__span-41-428"><a id="__codelineno-41-428" name="__codelineno-41-428" href="#__codelineno-41-428"></a><span class="w">                </span><span class="c1">// Only send a message if the time preference is available.</span>
</span><span id="__span-41-429"><a id="__codelineno-41-429" name="__codelineno-41-429" href="#__codelineno-41-429"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">timeFormatPreferenceMsgValue</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NO_EXTRA_VALUE_FOUND</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-430"><a id="__codelineno-41-430" name="__codelineno-41-430" href="#__codelineno-41-430"></a><span class="w">                    </span><span class="n">Message</span><span class="w"> </span><span class="n">updateTimePreferenceMsg</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-41-431"><a id="__codelineno-41-431" name="__codelineno-41-431" href="#__codelineno-41-431"></a><span class="w">                            </span><span class="n">mHandler</span><span class="p">.</span><span class="na">obtainMessage</span><span class="p">(</span><span class="n">UPDATE_TIME_PREFERENCE_MSG</span><span class="p">,</span>
</span><span id="__span-41-432"><a id="__codelineno-41-432" name="__codelineno-41-432" href="#__codelineno-41-432"></a><span class="w">                                    </span><span class="n">timeFormatPreferenceMsgValue</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-41-433"><a id="__codelineno-41-433" name="__codelineno-41-433" href="#__codelineno-41-433"></a><span class="w">                    </span><span class="n">mHandler</span><span class="p">.</span><span class="na">sendMessage</span><span class="p">(</span><span class="n">updateTimePreferenceMsg</span><span class="p">);</span>
</span><span id="__span-41-434"><a id="__codelineno-41-434" name="__codelineno-41-434" href="#__codelineno-41-434"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-41-435"><a id="__codelineno-41-435" name="__codelineno-41-435" href="#__codelineno-41-435"></a><span class="w">                </span><span class="n">mBatteryStatsService</span><span class="p">.</span><span class="na">noteCurrentTimeChanged</span><span class="p">();</span>
</span><span id="__span-41-436"><a id="__codelineno-41-436" name="__codelineno-41-436" href="#__codelineno-41-436"></a><span class="w">                </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-41-437"><a id="__codelineno-41-437" name="__codelineno-41-437" href="#__codelineno-41-437"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">ConnectivityManager</span><span class="p">.</span><span class="na">ACTION_CLEAR_DNS_CACHE</span><span class="p">:</span>
</span><span id="__span-41-438"><a id="__codelineno-41-438" name="__codelineno-41-438" href="#__codelineno-41-438"></a><span class="w">                </span><span class="n">mHandler</span><span class="p">.</span><span class="na">sendEmptyMessage</span><span class="p">(</span><span class="n">CLEAR_DNS_CACHE_MSG</span><span class="p">);</span>
</span><span id="__span-41-439"><a id="__codelineno-41-439" name="__codelineno-41-439" href="#__codelineno-41-439"></a><span class="w">                </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-41-440"><a id="__codelineno-41-440" name="__codelineno-41-440" href="#__codelineno-41-440"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Proxy</span><span class="p">.</span><span class="na">PROXY_CHANGE_ACTION</span><span class="p">:</span>
</span><span id="__span-41-441"><a id="__codelineno-41-441" name="__codelineno-41-441" href="#__codelineno-41-441"></a><span class="w">                </span><span class="n">mHandler</span><span class="p">.</span><span class="na">sendMessage</span><span class="p">(</span><span class="n">mHandler</span><span class="p">.</span><span class="na">obtainMessage</span><span class="p">(</span><span class="n">UPDATE_HTTP_PROXY_MSG</span><span class="p">));</span>
</span><span id="__span-41-442"><a id="__codelineno-41-442" name="__codelineno-41-442" href="#__codelineno-41-442"></a><span class="w">                </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-41-443"><a id="__codelineno-41-443" name="__codelineno-41-443" href="#__codelineno-41-443"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">android</span><span class="p">.</span><span class="na">hardware</span><span class="p">.</span><span class="na">Camera</span><span class="p">.</span><span class="na">ACTION_NEW_PICTURE</span><span class="p">:</span>
</span><span id="__span-41-444"><a id="__codelineno-41-444" name="__codelineno-41-444" href="#__codelineno-41-444"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">android</span><span class="p">.</span><span class="na">hardware</span><span class="p">.</span><span class="na">Camera</span><span class="p">.</span><span class="na">ACTION_NEW_VIDEO</span><span class="p">:</span>
</span><span id="__span-41-445"><a id="__codelineno-41-445" name="__codelineno-41-445" href="#__codelineno-41-445"></a><span class="w">                </span><span class="c1">// In N we just turned these off; in O we are turing them back on partly,</span>
</span><span id="__span-41-446"><a id="__codelineno-41-446" name="__codelineno-41-446" href="#__codelineno-41-446"></a><span class="w">                </span><span class="c1">// only for registered receivers.  This will still address the main problem</span>
</span><span id="__span-41-447"><a id="__codelineno-41-447" name="__codelineno-41-447" href="#__codelineno-41-447"></a><span class="w">                </span><span class="c1">// (a spam of apps waking up when a picture is taken putting significant</span>
</span><span id="__span-41-448"><a id="__codelineno-41-448" name="__codelineno-41-448" href="#__codelineno-41-448"></a><span class="w">                </span><span class="c1">// memory pressure on the system at a bad point), while still allowing apps</span>
</span><span id="__span-41-449"><a id="__codelineno-41-449" name="__codelineno-41-449" href="#__codelineno-41-449"></a><span class="w">                </span><span class="c1">// that are already actively running to know about this happening.</span>
</span><span id="__span-41-450"><a id="__codelineno-41-450" name="__codelineno-41-450" href="#__codelineno-41-450"></a><span class="w">                </span><span class="n">intent</span><span class="p">.</span><span class="na">addFlags</span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="na">FLAG_RECEIVER_REGISTERED_ONLY</span><span class="p">);</span>
</span><span id="__span-41-451"><a id="__codelineno-41-451" name="__codelineno-41-451" href="#__codelineno-41-451"></a><span class="w">                </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-41-452"><a id="__codelineno-41-452" name="__codelineno-41-452" href="#__codelineno-41-452"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">android</span><span class="p">.</span><span class="na">security</span><span class="p">.</span><span class="na">KeyChain</span><span class="p">.</span><span class="na">ACTION_TRUST_STORE_CHANGED</span><span class="p">:</span>
</span><span id="__span-41-453"><a id="__codelineno-41-453" name="__codelineno-41-453" href="#__codelineno-41-453"></a><span class="w">                </span><span class="n">mHandler</span><span class="p">.</span><span class="na">sendEmptyMessage</span><span class="p">(</span><span class="n">HANDLE_TRUST_STORAGE_UPDATE_MSG</span><span class="p">);</span>
</span><span id="__span-41-454"><a id="__codelineno-41-454" name="__codelineno-41-454" href="#__codelineno-41-454"></a><span class="w">                </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-41-455"><a id="__codelineno-41-455" name="__codelineno-41-455" href="#__codelineno-41-455"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;com.android.launcher.action.INSTALL_SHORTCUT&quot;</span><span class="p">:</span>
</span><span id="__span-41-456"><a id="__codelineno-41-456" name="__codelineno-41-456" href="#__codelineno-41-456"></a><span class="w">                </span><span class="c1">// As of O, we no longer support this broadcasts, even for pre-O apps.</span>
</span><span id="__span-41-457"><a id="__codelineno-41-457" name="__codelineno-41-457" href="#__codelineno-41-457"></a><span class="w">                </span><span class="c1">// Apps should now be using ShortcutManager.pinRequestShortcut().</span>
</span><span id="__span-41-458"><a id="__codelineno-41-458" name="__codelineno-41-458" href="#__codelineno-41-458"></a><span class="w">                </span><span class="n">Log</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Broadcast &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">action</span>
</span><span id="__span-41-459"><a id="__codelineno-41-459" name="__codelineno-41-459" href="#__codelineno-41-459"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; no longer supported. It will not be delivered.&quot;</span><span class="p">);</span>
</span><span id="__span-41-460"><a id="__codelineno-41-460" name="__codelineno-41-460" href="#__codelineno-41-460"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">BROADCAST_SUCCESS</span><span class="p">;</span>
</span><span id="__span-41-461"><a id="__codelineno-41-461" name="__codelineno-41-461" href="#__codelineno-41-461"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_PRE_BOOT_COMPLETED</span><span class="p">:</span>
</span><span id="__span-41-462"><a id="__codelineno-41-462" name="__codelineno-41-462" href="#__codelineno-41-462"></a><span class="w">                </span><span class="n">timeoutExempt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-41-463"><a id="__codelineno-41-463" name="__codelineno-41-463" href="#__codelineno-41-463"></a><span class="w">                </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-41-464"><a id="__codelineno-41-464" name="__codelineno-41-464" href="#__codelineno-41-464"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_CLOSE_SYSTEM_DIALOGS</span><span class="p">:</span>
</span><span id="__span-41-465"><a id="__codelineno-41-465" name="__codelineno-41-465" href="#__codelineno-41-465"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mAtmInternal</span><span class="p">.</span><span class="na">checkCanCloseSystemDialogs</span><span class="p">(</span><span class="n">callingPid</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">,</span>
</span><span id="__span-41-466"><a id="__codelineno-41-466" name="__codelineno-41-466" href="#__codelineno-41-466"></a><span class="w">                        </span><span class="n">callerPackage</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-467"><a id="__codelineno-41-467" name="__codelineno-41-467" href="#__codelineno-41-467"></a><span class="w">                    </span><span class="c1">// Returning success seems to be the pattern here</span>
</span><span id="__span-41-468"><a id="__codelineno-41-468" name="__codelineno-41-468" href="#__codelineno-41-468"></a><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">BROADCAST_SUCCESS</span><span class="p">;</span>
</span><span id="__span-41-469"><a id="__codelineno-41-469" name="__codelineno-41-469" href="#__codelineno-41-469"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-41-470"><a id="__codelineno-41-470" name="__codelineno-41-470" href="#__codelineno-41-470"></a><span class="w">                </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-41-471"><a id="__codelineno-41-471" name="__codelineno-41-471" href="#__codelineno-41-471"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-41-472"><a id="__codelineno-41-472" name="__codelineno-41-472" href="#__codelineno-41-472"></a>
</span><span id="__span-41-473"><a id="__codelineno-41-473" name="__codelineno-41-473" href="#__codelineno-41-473"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_PACKAGE_ADDED</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">action</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
</span><span id="__span-41-474"><a id="__codelineno-41-474" name="__codelineno-41-474" href="#__codelineno-41-474"></a><span class="w">                </span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_PACKAGE_REMOVED</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">action</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
</span><span id="__span-41-475"><a id="__codelineno-41-475" name="__codelineno-41-475" href="#__codelineno-41-475"></a><span class="w">                </span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_PACKAGE_REPLACED</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">action</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-476"><a id="__codelineno-41-476" name="__codelineno-41-476" href="#__codelineno-41-476"></a><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">uid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getUidFromIntent</span><span class="p">(</span><span class="n">intent</span><span class="p">);</span>
</span><span id="__span-41-477"><a id="__codelineno-41-477" name="__codelineno-41-477" href="#__codelineno-41-477"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">uid</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-478"><a id="__codelineno-41-478" name="__codelineno-41-478" href="#__codelineno-41-478"></a><span class="w">                </span><span class="kd">final</span><span class="w"> </span><span class="n">UidRecord</span><span class="w"> </span><span class="n">uidRec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mProcessList</span><span class="p">.</span><span class="na">getUidRecordLOSP</span><span class="p">(</span><span class="n">uid</span><span class="p">);</span>
</span><span id="__span-41-479"><a id="__codelineno-41-479" name="__codelineno-41-479" href="#__codelineno-41-479"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">uidRec</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-480"><a id="__codelineno-41-480" name="__codelineno-41-480" href="#__codelineno-41-480"></a><span class="w">                    </span><span class="n">uidRec</span><span class="p">.</span><span class="na">updateHasInternetPermission</span><span class="p">();</span>
</span><span id="__span-41-481"><a id="__codelineno-41-481" name="__codelineno-41-481" href="#__codelineno-41-481"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-41-482"><a id="__codelineno-41-482" name="__codelineno-41-482" href="#__codelineno-41-482"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-41-483"><a id="__codelineno-41-483" name="__codelineno-41-483" href="#__codelineno-41-483"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-41-484"><a id="__codelineno-41-484" name="__codelineno-41-484" href="#__codelineno-41-484"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-41-485"><a id="__codelineno-41-485" name="__codelineno-41-485" href="#__codelineno-41-485"></a>
</span><span id="__span-41-486"><a id="__codelineno-41-486" name="__codelineno-41-486" href="#__codelineno-41-486"></a><span class="w">    </span><span class="c1">// Add to the sticky list if requested.</span>
</span><span id="__span-41-487"><a id="__codelineno-41-487" name="__codelineno-41-487" href="#__codelineno-41-487"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sticky</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-488"><a id="__codelineno-41-488" name="__codelineno-41-488" href="#__codelineno-41-488"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">checkPermission</span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">Manifest</span><span class="p">.</span><span class="na">permission</span><span class="p">.</span><span class="na">BROADCAST_STICKY</span><span class="p">,</span>
</span><span id="__span-41-489"><a id="__codelineno-41-489" name="__codelineno-41-489" href="#__codelineno-41-489"></a><span class="w">                </span><span class="n">callingPid</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">)</span>
</span><span id="__span-41-490"><a id="__codelineno-41-490" name="__codelineno-41-490" href="#__codelineno-41-490"></a><span class="w">                </span><span class="o">!=</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="na">PERMISSION_GRANTED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-491"><a id="__codelineno-41-491" name="__codelineno-41-491" href="#__codelineno-41-491"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Permission Denial: broadcastIntent() requesting a sticky broadcast from pid=&quot;</span>
</span><span id="__span-41-492"><a id="__codelineno-41-492" name="__codelineno-41-492" href="#__codelineno-41-492"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">callingPid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, uid=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callingUid</span>
</span><span id="__span-41-493"><a id="__codelineno-41-493" name="__codelineno-41-493" href="#__codelineno-41-493"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; requires &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">android</span><span class="p">.</span><span class="na">Manifest</span><span class="p">.</span><span class="na">permission</span><span class="p">.</span><span class="na">BROADCAST_STICKY</span><span class="p">;</span>
</span><span id="__span-41-494"><a id="__codelineno-41-494" name="__codelineno-41-494" href="#__codelineno-41-494"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span>
</span><span id="__span-41-495"><a id="__codelineno-41-495" name="__codelineno-41-495" href="#__codelineno-41-495"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecurityException</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span><span id="__span-41-496"><a id="__codelineno-41-496" name="__codelineno-41-496" href="#__codelineno-41-496"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-41-497"><a id="__codelineno-41-497" name="__codelineno-41-497" href="#__codelineno-41-497"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">requiredPermissions</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">requiredPermissions</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-498"><a id="__codelineno-41-498" name="__codelineno-41-498" href="#__codelineno-41-498"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Can&#39;t broadcast sticky intent &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">intent</span>
</span><span id="__span-41-499"><a id="__codelineno-41-499" name="__codelineno-41-499" href="#__codelineno-41-499"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; and enforce permissions &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Arrays</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">requiredPermissions</span><span class="p">));</span>
</span><span id="__span-41-500"><a id="__codelineno-41-500" name="__codelineno-41-500" href="#__codelineno-41-500"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">BROADCAST_STICKY_CANT_HAVE_PERMISSION</span><span class="p">;</span>
</span><span id="__span-41-501"><a id="__codelineno-41-501" name="__codelineno-41-501" href="#__codelineno-41-501"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-41-502"><a id="__codelineno-41-502" name="__codelineno-41-502" href="#__codelineno-41-502"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getComponent</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-503"><a id="__codelineno-41-503" name="__codelineno-41-503" href="#__codelineno-41-503"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecurityException</span><span class="p">(</span>
</span><span id="__span-41-504"><a id="__codelineno-41-504" name="__codelineno-41-504" href="#__codelineno-41-504"></a><span class="w">                    </span><span class="s">&quot;Sticky broadcasts can&#39;t target a specific component&quot;</span><span class="p">);</span>
</span><span id="__span-41-505"><a id="__codelineno-41-505" name="__codelineno-41-505" href="#__codelineno-41-505"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-41-506"><a id="__codelineno-41-506" name="__codelineno-41-506" href="#__codelineno-41-506"></a><span class="w">        </span><span class="c1">// We use userId directly here, since the &quot;all&quot; target is maintained</span>
</span><span id="__span-41-507"><a id="__codelineno-41-507" name="__codelineno-41-507" href="#__codelineno-41-507"></a><span class="w">        </span><span class="c1">// as a separate set of sticky broadcasts.</span>
</span><span id="__span-41-508"><a id="__codelineno-41-508" name="__codelineno-41-508" href="#__codelineno-41-508"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">userId</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">USER_ALL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-509"><a id="__codelineno-41-509" name="__codelineno-41-509" href="#__codelineno-41-509"></a><span class="w">            </span><span class="c1">// But first, if this is not a broadcast to all users, then</span>
</span><span id="__span-41-510"><a id="__codelineno-41-510" name="__codelineno-41-510" href="#__codelineno-41-510"></a><span class="w">            </span><span class="c1">// make sure it doesn&#39;t conflict with an existing broadcast to</span>
</span><span id="__span-41-511"><a id="__codelineno-41-511" name="__codelineno-41-511" href="#__codelineno-41-511"></a><span class="w">            </span><span class="c1">// all users.</span>
</span><span id="__span-41-512"><a id="__codelineno-41-512" name="__codelineno-41-512" href="#__codelineno-41-512"></a><span class="w">            </span><span class="n">ArrayMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Intent</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">stickies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mStickyBroadcasts</span><span class="p">.</span><span class="na">get</span><span class="p">(</span>
</span><span id="__span-41-513"><a id="__codelineno-41-513" name="__codelineno-41-513" href="#__codelineno-41-513"></a><span class="w">                    </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">USER_ALL</span><span class="p">);</span>
</span><span id="__span-41-514"><a id="__codelineno-41-514" name="__codelineno-41-514" href="#__codelineno-41-514"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stickies</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-515"><a id="__codelineno-41-515" name="__codelineno-41-515" href="#__codelineno-41-515"></a><span class="w">                </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Intent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stickies</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">());</span>
</span><span id="__span-41-516"><a id="__codelineno-41-516" name="__codelineno-41-516" href="#__codelineno-41-516"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">list</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-517"><a id="__codelineno-41-517" name="__codelineno-41-517" href="#__codelineno-41-517"></a><span class="w">                    </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">list</span><span class="p">.</span><span class="na">size</span><span class="p">();</span>
</span><span id="__span-41-518"><a id="__codelineno-41-518" name="__codelineno-41-518" href="#__codelineno-41-518"></a><span class="w">                    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
</span><span id="__span-41-519"><a id="__codelineno-41-519" name="__codelineno-41-519" href="#__codelineno-41-519"></a><span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-520"><a id="__codelineno-41-520" name="__codelineno-41-520" href="#__codelineno-41-520"></a><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">filterEquals</span><span class="p">(</span><span class="n">list</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-521"><a id="__codelineno-41-521" name="__codelineno-41-521" href="#__codelineno-41-521"></a><span class="w">                            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span>
</span><span id="__span-41-522"><a id="__codelineno-41-522" name="__codelineno-41-522" href="#__codelineno-41-522"></a><span class="w">                                    </span><span class="s">&quot;Sticky broadcast &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">intent</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; for user &quot;</span>
</span><span id="__span-41-523"><a id="__codelineno-41-523" name="__codelineno-41-523" href="#__codelineno-41-523"></a><span class="w">                                    </span><span class="o">+</span><span class="w"> </span><span class="n">userId</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; conflicts with existing global broadcast&quot;</span><span class="p">);</span>
</span><span id="__span-41-524"><a id="__codelineno-41-524" name="__codelineno-41-524" href="#__codelineno-41-524"></a><span class="w">                        </span><span class="p">}</span>
</span><span id="__span-41-525"><a id="__codelineno-41-525" name="__codelineno-41-525" href="#__codelineno-41-525"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-41-526"><a id="__codelineno-41-526" name="__codelineno-41-526" href="#__codelineno-41-526"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-41-527"><a id="__codelineno-41-527" name="__codelineno-41-527" href="#__codelineno-41-527"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-41-528"><a id="__codelineno-41-528" name="__codelineno-41-528" href="#__codelineno-41-528"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-41-529"><a id="__codelineno-41-529" name="__codelineno-41-529" href="#__codelineno-41-529"></a><span class="w">        </span><span class="n">ArrayMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Intent</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">stickies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mStickyBroadcasts</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span>
</span><span id="__span-41-530"><a id="__codelineno-41-530" name="__codelineno-41-530" href="#__codelineno-41-530"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stickies</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-531"><a id="__codelineno-41-531" name="__codelineno-41-531" href="#__codelineno-41-531"></a><span class="w">            </span><span class="n">stickies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-41-532"><a id="__codelineno-41-532" name="__codelineno-41-532" href="#__codelineno-41-532"></a><span class="w">            </span><span class="n">mStickyBroadcasts</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">stickies</span><span class="p">);</span>
</span><span id="__span-41-533"><a id="__codelineno-41-533" name="__codelineno-41-533" href="#__codelineno-41-533"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-41-534"><a id="__codelineno-41-534" name="__codelineno-41-534" href="#__codelineno-41-534"></a><span class="w">        </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Intent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stickies</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">());</span>
</span><span id="__span-41-535"><a id="__codelineno-41-535" name="__codelineno-41-535" href="#__codelineno-41-535"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">list</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-536"><a id="__codelineno-41-536" name="__codelineno-41-536" href="#__codelineno-41-536"></a><span class="w">            </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-41-537"><a id="__codelineno-41-537" name="__codelineno-41-537" href="#__codelineno-41-537"></a><span class="w">            </span><span class="n">stickies</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">(),</span><span class="w"> </span><span class="n">list</span><span class="p">);</span>
</span><span id="__span-41-538"><a id="__codelineno-41-538" name="__codelineno-41-538" href="#__codelineno-41-538"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-41-539"><a id="__codelineno-41-539" name="__codelineno-41-539" href="#__codelineno-41-539"></a><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">stickiesCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">list</span><span class="p">.</span><span class="na">size</span><span class="p">();</span>
</span><span id="__span-41-540"><a id="__codelineno-41-540" name="__codelineno-41-540" href="#__codelineno-41-540"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
</span><span id="__span-41-541"><a id="__codelineno-41-541" name="__codelineno-41-541" href="#__codelineno-41-541"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">stickiesCount</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-542"><a id="__codelineno-41-542" name="__codelineno-41-542" href="#__codelineno-41-542"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">filterEquals</span><span class="p">(</span><span class="n">list</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-543"><a id="__codelineno-41-543" name="__codelineno-41-543" href="#__codelineno-41-543"></a><span class="w">                </span><span class="c1">// This sticky already exists, replace it.</span>
</span><span id="__span-41-544"><a id="__codelineno-41-544" name="__codelineno-41-544" href="#__codelineno-41-544"></a><span class="w">                </span><span class="n">list</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Intent</span><span class="p">(</span><span class="n">intent</span><span class="p">));</span>
</span><span id="__span-41-545"><a id="__codelineno-41-545" name="__codelineno-41-545" href="#__codelineno-41-545"></a><span class="w">                </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-41-546"><a id="__codelineno-41-546" name="__codelineno-41-546" href="#__codelineno-41-546"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-41-547"><a id="__codelineno-41-547" name="__codelineno-41-547" href="#__codelineno-41-547"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-41-548"><a id="__codelineno-41-548" name="__codelineno-41-548" href="#__codelineno-41-548"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">stickiesCount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-549"><a id="__codelineno-41-549" name="__codelineno-41-549" href="#__codelineno-41-549"></a><span class="w">            </span><span class="n">list</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Intent</span><span class="p">(</span><span class="n">intent</span><span class="p">));</span>
</span><span id="__span-41-550"><a id="__codelineno-41-550" name="__codelineno-41-550" href="#__codelineno-41-550"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-41-551"><a id="__codelineno-41-551" name="__codelineno-41-551" href="#__codelineno-41-551"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-41-552"><a id="__codelineno-41-552" name="__codelineno-41-552" href="#__codelineno-41-552"></a>
</span><span id="__span-41-553"><a id="__codelineno-41-553" name="__codelineno-41-553" href="#__codelineno-41-553"></a><span class="w">    </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">users</span><span class="p">;</span>
</span><span id="__span-41-554"><a id="__codelineno-41-554" name="__codelineno-41-554" href="#__codelineno-41-554"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">userId</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">USER_ALL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-555"><a id="__codelineno-41-555" name="__codelineno-41-555" href="#__codelineno-41-555"></a><span class="w">        </span><span class="c1">// Caller wants broadcast to go to all started users.</span>
</span><span id="__span-41-556"><a id="__codelineno-41-556" name="__codelineno-41-556" href="#__codelineno-41-556"></a><span class="w">        </span><span class="n">users</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mUserController</span><span class="p">.</span><span class="na">getStartedUserArray</span><span class="p">();</span>
</span><span id="__span-41-557"><a id="__codelineno-41-557" name="__codelineno-41-557" href="#__codelineno-41-557"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-558"><a id="__codelineno-41-558" name="__codelineno-41-558" href="#__codelineno-41-558"></a><span class="w">        </span><span class="c1">// Caller wants broadcast to go to one specific user.</span>
</span><span id="__span-41-559"><a id="__codelineno-41-559" name="__codelineno-41-559" href="#__codelineno-41-559"></a><span class="w">        </span><span class="n">users</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="n">userId</span><span class="p">};</span>
</span><span id="__span-41-560"><a id="__codelineno-41-560" name="__codelineno-41-560" href="#__codelineno-41-560"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-41-561"><a id="__codelineno-41-561" name="__codelineno-41-561" href="#__codelineno-41-561"></a>
</span><span id="__span-41-562"><a id="__codelineno-41-562" name="__codelineno-41-562" href="#__codelineno-41-562"></a><span class="w">    </span><span class="c1">// Figure out who all will receive this broadcast.</span>
</span><span id="__span-41-563"><a id="__codelineno-41-563" name="__codelineno-41-563" href="#__codelineno-41-563"></a><span class="w">    </span><span class="n">List</span><span class="w"> </span><span class="n">receivers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-41-564"><a id="__codelineno-41-564" name="__codelineno-41-564" href="#__codelineno-41-564"></a><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">BroadcastFilter</span><span class="o">&gt;</span><span class="w"> </span><span class="n">registeredReceivers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-41-565"><a id="__codelineno-41-565" name="__codelineno-41-565" href="#__codelineno-41-565"></a><span class="w">    </span><span class="c1">// Need to resolve the intent to interested receivers...</span>
</span><span id="__span-41-566"><a id="__codelineno-41-566" name="__codelineno-41-566" href="#__codelineno-41-566"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">intent</span><span class="p">.</span><span class="na">getFlags</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">FLAG_RECEIVER_REGISTERED_ONLY</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-567"><a id="__codelineno-41-567" name="__codelineno-41-567" href="#__codelineno-41-567"></a><span class="w">        </span><span class="n">receivers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">collectReceiverComponents</span><span class="p">(</span>
</span><span id="__span-41-568"><a id="__codelineno-41-568" name="__codelineno-41-568" href="#__codelineno-41-568"></a><span class="w">                </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">resolvedType</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">,</span><span class="w"> </span><span class="n">users</span><span class="p">,</span><span class="w"> </span><span class="n">broadcastAllowList</span><span class="p">);</span>
</span><span id="__span-41-569"><a id="__codelineno-41-569" name="__codelineno-41-569" href="#__codelineno-41-569"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-41-570"><a id="__codelineno-41-570" name="__codelineno-41-570" href="#__codelineno-41-570"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getComponent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-571"><a id="__codelineno-41-571" name="__codelineno-41-571" href="#__codelineno-41-571"></a><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">PackageDataSnapshot</span><span class="w"> </span><span class="n">snapshot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getPackageManagerInternal</span><span class="p">().</span><span class="na">snapshot</span><span class="p">();</span>
</span><span id="__span-41-572"><a id="__codelineno-41-572" name="__codelineno-41-572" href="#__codelineno-41-572"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">userId</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">USER_ALL</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">callingUid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SHELL_UID</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-573"><a id="__codelineno-41-573" name="__codelineno-41-573" href="#__codelineno-41-573"></a><span class="w">            </span><span class="c1">// Query one target user at a time, excluding shell-restricted users</span>
</span><span id="__span-41-574"><a id="__codelineno-41-574" name="__codelineno-41-574" href="#__codelineno-41-574"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">users</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-575"><a id="__codelineno-41-575" name="__codelineno-41-575" href="#__codelineno-41-575"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mUserController</span><span class="p">.</span><span class="na">hasUserRestriction</span><span class="p">(</span>
</span><span id="__span-41-576"><a id="__codelineno-41-576" name="__codelineno-41-576" href="#__codelineno-41-576"></a><span class="w">                        </span><span class="n">UserManager</span><span class="p">.</span><span class="na">DISALLOW_DEBUGGING_FEATURES</span><span class="p">,</span><span class="w"> </span><span class="n">users</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-577"><a id="__codelineno-41-577" name="__codelineno-41-577" href="#__codelineno-41-577"></a><span class="w">                    </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-41-578"><a id="__codelineno-41-578" name="__codelineno-41-578" href="#__codelineno-41-578"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-41-579"><a id="__codelineno-41-579" name="__codelineno-41-579" href="#__codelineno-41-579"></a><span class="w">                </span><span class="n">List</span><span class="o">&lt;</span><span class="n">BroadcastFilter</span><span class="o">&gt;</span><span class="w"> </span><span class="n">registeredReceiversForUser</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-41-580"><a id="__codelineno-41-580" name="__codelineno-41-580" href="#__codelineno-41-580"></a><span class="w">                        </span><span class="n">mReceiverResolver</span><span class="p">.</span><span class="na">queryIntent</span><span class="p">(</span><span class="n">snapshot</span><span class="p">,</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span>
</span><span id="__span-41-581"><a id="__codelineno-41-581" name="__codelineno-41-581" href="#__codelineno-41-581"></a><span class="w">                                </span><span class="n">resolvedType</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="cm">/*defaultOnly*/</span><span class="p">,</span><span class="w"> </span><span class="n">users</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">);</span>
</span><span id="__span-41-582"><a id="__codelineno-41-582" name="__codelineno-41-582" href="#__codelineno-41-582"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">registeredReceivers</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-583"><a id="__codelineno-41-583" name="__codelineno-41-583" href="#__codelineno-41-583"></a><span class="w">                    </span><span class="n">registeredReceivers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">registeredReceiversForUser</span><span class="p">;</span>
</span><span id="__span-41-584"><a id="__codelineno-41-584" name="__codelineno-41-584" href="#__codelineno-41-584"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">registeredReceiversForUser</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-585"><a id="__codelineno-41-585" name="__codelineno-41-585" href="#__codelineno-41-585"></a><span class="w">                    </span><span class="n">registeredReceivers</span><span class="p">.</span><span class="na">addAll</span><span class="p">(</span><span class="n">registeredReceiversForUser</span><span class="p">);</span>
</span><span id="__span-41-586"><a id="__codelineno-41-586" name="__codelineno-41-586" href="#__codelineno-41-586"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-41-587"><a id="__codelineno-41-587" name="__codelineno-41-587" href="#__codelineno-41-587"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-41-588"><a id="__codelineno-41-588" name="__codelineno-41-588" href="#__codelineno-41-588"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-589"><a id="__codelineno-41-589" name="__codelineno-41-589" href="#__codelineno-41-589"></a><span class="w">            </span><span class="n">registeredReceivers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mReceiverResolver</span><span class="p">.</span><span class="na">queryIntent</span><span class="p">(</span><span class="n">snapshot</span><span class="p">,</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span>
</span><span id="__span-41-590"><a id="__codelineno-41-590" name="__codelineno-41-590" href="#__codelineno-41-590"></a><span class="w">                    </span><span class="n">resolvedType</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="cm">/*defaultOnly*/</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">);</span>
</span><span id="__span-41-591"><a id="__codelineno-41-591" name="__codelineno-41-591" href="#__codelineno-41-591"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-41-592"><a id="__codelineno-41-592" name="__codelineno-41-592" href="#__codelineno-41-592"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-41-593"><a id="__codelineno-41-593" name="__codelineno-41-593" href="#__codelineno-41-593"></a>
</span><span id="__span-41-594"><a id="__codelineno-41-594" name="__codelineno-41-594" href="#__codelineno-41-594"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">replacePending</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-41-595"><a id="__codelineno-41-595" name="__codelineno-41-595" href="#__codelineno-41-595"></a><span class="w">            </span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getFlags</span><span class="p">()</span><span class="o">&amp;</span><span class="n">Intent</span><span class="p">.</span><span class="na">FLAG_RECEIVER_REPLACE_PENDING</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-41-596"><a id="__codelineno-41-596" name="__codelineno-41-596" href="#__codelineno-41-596"></a>
</span><span id="__span-41-597"><a id="__codelineno-41-597" name="__codelineno-41-597" href="#__codelineno-41-597"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Enqueueing broadcast: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">()</span>
</span><span id="__span-41-598"><a id="__codelineno-41-598" name="__codelineno-41-598" href="#__codelineno-41-598"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; replacePending=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">replacePending</span><span class="p">);</span>
</span><span id="__span-41-599"><a id="__codelineno-41-599" name="__codelineno-41-599" href="#__codelineno-41-599"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">registeredReceivers</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">broadcastAllowList</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-600"><a id="__codelineno-41-600" name="__codelineno-41-600" href="#__codelineno-41-600"></a><span class="w">        </span><span class="c1">// if a uid whitelist was provided, remove anything in the application space that wasn&#39;t</span>
</span><span id="__span-41-601"><a id="__codelineno-41-601" name="__codelineno-41-601" href="#__codelineno-41-601"></a><span class="w">        </span><span class="c1">// in it.</span>
</span><span id="__span-41-602"><a id="__codelineno-41-602" name="__codelineno-41-602" href="#__codelineno-41-602"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">registeredReceivers</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-603"><a id="__codelineno-41-603" name="__codelineno-41-603" href="#__codelineno-41-603"></a><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">owningAppId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">getAppId</span><span class="p">(</span><span class="n">registeredReceivers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="na">owningUid</span><span class="p">);</span>
</span><span id="__span-41-604"><a id="__codelineno-41-604" name="__codelineno-41-604" href="#__codelineno-41-604"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">owningAppId</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">Process</span><span class="p">.</span><span class="na">FIRST_APPLICATION_UID</span>
</span><span id="__span-41-605"><a id="__codelineno-41-605" name="__codelineno-41-605" href="#__codelineno-41-605"></a><span class="w">                    </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">Arrays</span><span class="p">.</span><span class="na">binarySearch</span><span class="p">(</span><span class="n">broadcastAllowList</span><span class="p">,</span><span class="w"> </span><span class="n">owningAppId</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-606"><a id="__codelineno-41-606" name="__codelineno-41-606" href="#__codelineno-41-606"></a><span class="w">                </span><span class="n">registeredReceivers</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-41-607"><a id="__codelineno-41-607" name="__codelineno-41-607" href="#__codelineno-41-607"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-41-608"><a id="__codelineno-41-608" name="__codelineno-41-608" href="#__codelineno-41-608"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-41-609"><a id="__codelineno-41-609" name="__codelineno-41-609" href="#__codelineno-41-609"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-41-610"><a id="__codelineno-41-610" name="__codelineno-41-610" href="#__codelineno-41-610"></a>
</span><span id="__span-41-611"><a id="__codelineno-41-611" name="__codelineno-41-611" href="#__codelineno-41-611"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">NR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">registeredReceivers</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">registeredReceivers</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-41-612"><a id="__codelineno-41-612" name="__codelineno-41-612" href="#__codelineno-41-612"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ordered</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">NR</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-613"><a id="__codelineno-41-613" name="__codelineno-41-613" href="#__codelineno-41-613"></a><span class="w">        </span><span class="c1">// If we are not serializing this broadcast, then send the</span>
</span><span id="__span-41-614"><a id="__codelineno-41-614" name="__codelineno-41-614" href="#__codelineno-41-614"></a><span class="w">        </span><span class="c1">// registered receivers separately so they don&#39;t wait for the</span>
</span><span id="__span-41-615"><a id="__codelineno-41-615" name="__codelineno-41-615" href="#__codelineno-41-615"></a><span class="w">        </span><span class="c1">// components to be launched.</span>
</span><span id="__span-41-616"><a id="__codelineno-41-616" name="__codelineno-41-616" href="#__codelineno-41-616"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isCallerSystem</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-617"><a id="__codelineno-41-617" name="__codelineno-41-617" href="#__codelineno-41-617"></a><span class="w">            </span><span class="n">checkBroadcastFromSystem</span><span class="p">(</span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">callerApp</span><span class="p">,</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">,</span>
</span><span id="__span-41-618"><a id="__codelineno-41-618" name="__codelineno-41-618" href="#__codelineno-41-618"></a><span class="w">                    </span><span class="n">isProtectedBroadcast</span><span class="p">,</span><span class="w"> </span><span class="n">registeredReceivers</span><span class="p">);</span>
</span><span id="__span-41-619"><a id="__codelineno-41-619" name="__codelineno-41-619" href="#__codelineno-41-619"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-41-620"><a id="__codelineno-41-620" name="__codelineno-41-620" href="#__codelineno-41-620"></a><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">BroadcastQueue</span><span class="w"> </span><span class="n">queue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">broadcastQueueForIntent</span><span class="p">(</span><span class="n">intent</span><span class="p">);</span>
</span><span id="__span-41-621"><a id="__codelineno-41-621" name="__codelineno-41-621" href="#__codelineno-41-621"></a><span class="w">        </span><span class="n">BroadcastRecord</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">callerApp</span><span class="p">,</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">,</span>
</span><span id="__span-41-622"><a id="__codelineno-41-622" name="__codelineno-41-622" href="#__codelineno-41-622"></a><span class="w">                </span><span class="n">callerFeatureId</span><span class="p">,</span><span class="w"> </span><span class="n">callingPid</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">,</span><span class="w"> </span><span class="n">callerInstantApp</span><span class="p">,</span><span class="w"> </span><span class="n">resolvedType</span><span class="p">,</span>
</span><span id="__span-41-623"><a id="__codelineno-41-623" name="__codelineno-41-623" href="#__codelineno-41-623"></a><span class="w">                </span><span class="n">requiredPermissions</span><span class="p">,</span><span class="w"> </span><span class="n">excludedPermissions</span><span class="p">,</span><span class="w"> </span><span class="n">excludedPackages</span><span class="p">,</span><span class="w"> </span><span class="n">appOp</span><span class="p">,</span><span class="w"> </span><span class="n">brOptions</span><span class="p">,</span>
</span><span id="__span-41-624"><a id="__codelineno-41-624" name="__codelineno-41-624" href="#__codelineno-41-624"></a><span class="w">                </span><span class="n">registeredReceivers</span><span class="p">,</span><span class="w"> </span><span class="n">resultTo</span><span class="p">,</span><span class="w"> </span><span class="n">resultCode</span><span class="p">,</span><span class="w"> </span><span class="n">resultData</span><span class="p">,</span><span class="w"> </span><span class="n">resultExtras</span><span class="p">,</span><span class="w"> </span><span class="n">ordered</span><span class="p">,</span>
</span><span id="__span-41-625"><a id="__codelineno-41-625" name="__codelineno-41-625" href="#__codelineno-41-625"></a><span class="w">                </span><span class="n">sticky</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">allowBackgroundActivityStarts</span><span class="p">,</span>
</span><span id="__span-41-626"><a id="__codelineno-41-626" name="__codelineno-41-626" href="#__codelineno-41-626"></a><span class="w">                </span><span class="n">backgroundActivityStartsToken</span><span class="p">,</span><span class="w"> </span><span class="n">timeoutExempt</span><span class="p">);</span>
</span><span id="__span-41-627"><a id="__codelineno-41-627" name="__codelineno-41-627" href="#__codelineno-41-627"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Enqueueing parallel broadcast &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-41-628"><a id="__codelineno-41-628" name="__codelineno-41-628" href="#__codelineno-41-628"></a><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">replaced</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">replacePending</span>
</span><span id="__span-41-629"><a id="__codelineno-41-629" name="__codelineno-41-629" href="#__codelineno-41-629"></a><span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">queue</span><span class="p">.</span><span class="na">replaceParallelBroadcastLocked</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
</span><span id="__span-41-630"><a id="__codelineno-41-630" name="__codelineno-41-630" href="#__codelineno-41-630"></a><span class="w">        </span><span class="c1">// Note: We assume resultTo is null for non-ordered broadcasts.</span>
</span><span id="__span-41-631"><a id="__codelineno-41-631" name="__codelineno-41-631" href="#__codelineno-41-631"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">replaced</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-632"><a id="__codelineno-41-632" name="__codelineno-41-632" href="#__codelineno-41-632"></a><span class="w">            </span><span class="n">queue</span><span class="p">.</span><span class="na">enqueueParallelBroadcastLocked</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-41-633"><a id="__codelineno-41-633" name="__codelineno-41-633" href="#__codelineno-41-633"></a><span class="w">            </span><span class="n">queue</span><span class="p">.</span><span class="na">scheduleBroadcastsLocked</span><span class="p">();</span>
</span><span id="__span-41-634"><a id="__codelineno-41-634" name="__codelineno-41-634" href="#__codelineno-41-634"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-41-635"><a id="__codelineno-41-635" name="__codelineno-41-635" href="#__codelineno-41-635"></a><span class="w">        </span><span class="n">registeredReceivers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-41-636"><a id="__codelineno-41-636" name="__codelineno-41-636" href="#__codelineno-41-636"></a><span class="w">        </span><span class="n">NR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-41-637"><a id="__codelineno-41-637" name="__codelineno-41-637" href="#__codelineno-41-637"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-41-638"><a id="__codelineno-41-638" name="__codelineno-41-638" href="#__codelineno-41-638"></a>
</span><span id="__span-41-639"><a id="__codelineno-41-639" name="__codelineno-41-639" href="#__codelineno-41-639"></a><span class="w">    </span><span class="c1">// Merge into one list.</span>
</span><span id="__span-41-640"><a id="__codelineno-41-640" name="__codelineno-41-640" href="#__codelineno-41-640"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-41-641"><a id="__codelineno-41-641" name="__codelineno-41-641" href="#__codelineno-41-641"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">receivers</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-642"><a id="__codelineno-41-642" name="__codelineno-41-642" href="#__codelineno-41-642"></a><span class="w">        </span><span class="c1">// A special case for PACKAGE_ADDED: do not allow the package</span>
</span><span id="__span-41-643"><a id="__codelineno-41-643" name="__codelineno-41-643" href="#__codelineno-41-643"></a><span class="w">        </span><span class="c1">// being added to see this broadcast.  This prevents them from</span>
</span><span id="__span-41-644"><a id="__codelineno-41-644" name="__codelineno-41-644" href="#__codelineno-41-644"></a><span class="w">        </span><span class="c1">// using this as a back door to get run as soon as they are</span>
</span><span id="__span-41-645"><a id="__codelineno-41-645" name="__codelineno-41-645" href="#__codelineno-41-645"></a><span class="w">        </span><span class="c1">// installed.  Maybe in the future we want to have a special install</span>
</span><span id="__span-41-646"><a id="__codelineno-41-646" name="__codelineno-41-646" href="#__codelineno-41-646"></a><span class="w">        </span><span class="c1">// broadcast or such for apps, but we&#39;d like to deliberately make</span>
</span><span id="__span-41-647"><a id="__codelineno-41-647" name="__codelineno-41-647" href="#__codelineno-41-647"></a><span class="w">        </span><span class="c1">// this decision.</span>
</span><span id="__span-41-648"><a id="__codelineno-41-648" name="__codelineno-41-648" href="#__codelineno-41-648"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">skipPackages</span><span class="o">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-41-649"><a id="__codelineno-41-649" name="__codelineno-41-649" href="#__codelineno-41-649"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_PACKAGE_ADDED</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">())</span>
</span><span id="__span-41-650"><a id="__codelineno-41-650" name="__codelineno-41-650" href="#__codelineno-41-650"></a><span class="w">                </span><span class="o">||</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_PACKAGE_RESTARTED</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">())</span>
</span><span id="__span-41-651"><a id="__codelineno-41-651" name="__codelineno-41-651" href="#__codelineno-41-651"></a><span class="w">                </span><span class="o">||</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_PACKAGE_DATA_CLEARED</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-652"><a id="__codelineno-41-652" name="__codelineno-41-652" href="#__codelineno-41-652"></a><span class="w">            </span><span class="n">Uri</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getData</span><span class="p">();</span>
</span><span id="__span-41-653"><a id="__codelineno-41-653" name="__codelineno-41-653" href="#__codelineno-41-653"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-654"><a id="__codelineno-41-654" name="__codelineno-41-654" href="#__codelineno-41-654"></a><span class="w">                </span><span class="n">String</span><span class="w"> </span><span class="n">pkgName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="na">getSchemeSpecificPart</span><span class="p">();</span>
</span><span id="__span-41-655"><a id="__codelineno-41-655" name="__codelineno-41-655" href="#__codelineno-41-655"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pkgName</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-656"><a id="__codelineno-41-656" name="__codelineno-41-656" href="#__codelineno-41-656"></a><span class="w">                    </span><span class="n">skipPackages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">pkgName</span><span class="w"> </span><span class="p">};</span>
</span><span id="__span-41-657"><a id="__codelineno-41-657" name="__codelineno-41-657" href="#__codelineno-41-657"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-41-658"><a id="__codelineno-41-658" name="__codelineno-41-658" href="#__codelineno-41-658"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-41-659"><a id="__codelineno-41-659" name="__codelineno-41-659" href="#__codelineno-41-659"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_EXTERNAL_APPLICATIONS_AVAILABLE</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-660"><a id="__codelineno-41-660" name="__codelineno-41-660" href="#__codelineno-41-660"></a><span class="w">            </span><span class="n">skipPackages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getStringArrayExtra</span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="na">EXTRA_CHANGED_PACKAGE_LIST</span><span class="p">);</span>
</span><span id="__span-41-661"><a id="__codelineno-41-661" name="__codelineno-41-661" href="#__codelineno-41-661"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-41-662"><a id="__codelineno-41-662" name="__codelineno-41-662" href="#__codelineno-41-662"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">skipPackages</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">skipPackages</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-663"><a id="__codelineno-41-663" name="__codelineno-41-663" href="#__codelineno-41-663"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">skipPackage</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">skipPackages</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-664"><a id="__codelineno-41-664" name="__codelineno-41-664" href="#__codelineno-41-664"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">skipPackage</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-665"><a id="__codelineno-41-665" name="__codelineno-41-665" href="#__codelineno-41-665"></a><span class="w">                    </span><span class="kt">int</span><span class="w"> </span><span class="n">NT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">receivers</span><span class="p">.</span><span class="na">size</span><span class="p">();</span>
</span><span id="__span-41-666"><a id="__codelineno-41-666" name="__codelineno-41-666" href="#__codelineno-41-666"></a><span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">it</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">it</span><span class="o">&lt;</span><span class="n">NT</span><span class="p">;</span><span class="w"> </span><span class="n">it</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-667"><a id="__codelineno-41-667" name="__codelineno-41-667" href="#__codelineno-41-667"></a><span class="w">                        </span><span class="n">ResolveInfo</span><span class="w"> </span><span class="n">curt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ResolveInfo</span><span class="p">)</span><span class="n">receivers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">it</span><span class="p">);</span>
</span><span id="__span-41-668"><a id="__codelineno-41-668" name="__codelineno-41-668" href="#__codelineno-41-668"></a><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">curt</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">packageName</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">skipPackage</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-669"><a id="__codelineno-41-669" name="__codelineno-41-669" href="#__codelineno-41-669"></a><span class="w">                            </span><span class="n">receivers</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">it</span><span class="p">);</span>
</span><span id="__span-41-670"><a id="__codelineno-41-670" name="__codelineno-41-670" href="#__codelineno-41-670"></a><span class="w">                            </span><span class="n">it</span><span class="o">--</span><span class="p">;</span>
</span><span id="__span-41-671"><a id="__codelineno-41-671" name="__codelineno-41-671" href="#__codelineno-41-671"></a><span class="w">                            </span><span class="n">NT</span><span class="o">--</span><span class="p">;</span>
</span><span id="__span-41-672"><a id="__codelineno-41-672" name="__codelineno-41-672" href="#__codelineno-41-672"></a><span class="w">                        </span><span class="p">}</span>
</span><span id="__span-41-673"><a id="__codelineno-41-673" name="__codelineno-41-673" href="#__codelineno-41-673"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-41-674"><a id="__codelineno-41-674" name="__codelineno-41-674" href="#__codelineno-41-674"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-41-675"><a id="__codelineno-41-675" name="__codelineno-41-675" href="#__codelineno-41-675"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-41-676"><a id="__codelineno-41-676" name="__codelineno-41-676" href="#__codelineno-41-676"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-41-677"><a id="__codelineno-41-677" name="__codelineno-41-677" href="#__codelineno-41-677"></a>
</span><span id="__span-41-678"><a id="__codelineno-41-678" name="__codelineno-41-678" href="#__codelineno-41-678"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">NT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">receivers</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">receivers</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-41-679"><a id="__codelineno-41-679" name="__codelineno-41-679" href="#__codelineno-41-679"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-41-680"><a id="__codelineno-41-680" name="__codelineno-41-680" href="#__codelineno-41-680"></a><span class="w">        </span><span class="n">ResolveInfo</span><span class="w"> </span><span class="n">curt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-41-681"><a id="__codelineno-41-681" name="__codelineno-41-681" href="#__codelineno-41-681"></a><span class="w">        </span><span class="n">BroadcastFilter</span><span class="w"> </span><span class="n">curr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-41-682"><a id="__codelineno-41-682" name="__codelineno-41-682" href="#__codelineno-41-682"></a><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NT</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ir</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NR</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-683"><a id="__codelineno-41-683" name="__codelineno-41-683" href="#__codelineno-41-683"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">curt</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-684"><a id="__codelineno-41-684" name="__codelineno-41-684" href="#__codelineno-41-684"></a><span class="w">                </span><span class="n">curt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ResolveInfo</span><span class="p">)</span><span class="n">receivers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">it</span><span class="p">);</span>
</span><span id="__span-41-685"><a id="__codelineno-41-685" name="__codelineno-41-685" href="#__codelineno-41-685"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-41-686"><a id="__codelineno-41-686" name="__codelineno-41-686" href="#__codelineno-41-686"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">curr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-687"><a id="__codelineno-41-687" name="__codelineno-41-687" href="#__codelineno-41-687"></a><span class="w">                </span><span class="n">curr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">registeredReceivers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">ir</span><span class="p">);</span>
</span><span id="__span-41-688"><a id="__codelineno-41-688" name="__codelineno-41-688" href="#__codelineno-41-688"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-41-689"><a id="__codelineno-41-689" name="__codelineno-41-689" href="#__codelineno-41-689"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">curr</span><span class="p">.</span><span class="na">getPriority</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">curt</span><span class="p">.</span><span class="na">priority</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-690"><a id="__codelineno-41-690" name="__codelineno-41-690" href="#__codelineno-41-690"></a><span class="w">                </span><span class="c1">// Insert this broadcast record into the final list.</span>
</span><span id="__span-41-691"><a id="__codelineno-41-691" name="__codelineno-41-691" href="#__codelineno-41-691"></a><span class="w">                </span><span class="n">receivers</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">it</span><span class="p">,</span><span class="w"> </span><span class="n">curr</span><span class="p">);</span>
</span><span id="__span-41-692"><a id="__codelineno-41-692" name="__codelineno-41-692" href="#__codelineno-41-692"></a><span class="w">                </span><span class="n">ir</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-41-693"><a id="__codelineno-41-693" name="__codelineno-41-693" href="#__codelineno-41-693"></a><span class="w">                </span><span class="n">curr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-41-694"><a id="__codelineno-41-694" name="__codelineno-41-694" href="#__codelineno-41-694"></a><span class="w">                </span><span class="n">it</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-41-695"><a id="__codelineno-41-695" name="__codelineno-41-695" href="#__codelineno-41-695"></a><span class="w">                </span><span class="n">NT</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-41-696"><a id="__codelineno-41-696" name="__codelineno-41-696" href="#__codelineno-41-696"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-697"><a id="__codelineno-41-697" name="__codelineno-41-697" href="#__codelineno-41-697"></a><span class="w">                </span><span class="c1">// Skip to the next ResolveInfo in the final list.</span>
</span><span id="__span-41-698"><a id="__codelineno-41-698" name="__codelineno-41-698" href="#__codelineno-41-698"></a><span class="w">                </span><span class="n">it</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-41-699"><a id="__codelineno-41-699" name="__codelineno-41-699" href="#__codelineno-41-699"></a><span class="w">                </span><span class="n">curt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-41-700"><a id="__codelineno-41-700" name="__codelineno-41-700" href="#__codelineno-41-700"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-41-701"><a id="__codelineno-41-701" name="__codelineno-41-701" href="#__codelineno-41-701"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-41-702"><a id="__codelineno-41-702" name="__codelineno-41-702" href="#__codelineno-41-702"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-41-703"><a id="__codelineno-41-703" name="__codelineno-41-703" href="#__codelineno-41-703"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">ir</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NR</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-704"><a id="__codelineno-41-704" name="__codelineno-41-704" href="#__codelineno-41-704"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">receivers</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-705"><a id="__codelineno-41-705" name="__codelineno-41-705" href="#__codelineno-41-705"></a><span class="w">            </span><span class="n">receivers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="p">();</span>
</span><span id="__span-41-706"><a id="__codelineno-41-706" name="__codelineno-41-706" href="#__codelineno-41-706"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-41-707"><a id="__codelineno-41-707" name="__codelineno-41-707" href="#__codelineno-41-707"></a><span class="w">        </span><span class="n">receivers</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">registeredReceivers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
</span><span id="__span-41-708"><a id="__codelineno-41-708" name="__codelineno-41-708" href="#__codelineno-41-708"></a><span class="w">        </span><span class="n">ir</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-41-709"><a id="__codelineno-41-709" name="__codelineno-41-709" href="#__codelineno-41-709"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-41-710"><a id="__codelineno-41-710" name="__codelineno-41-710" href="#__codelineno-41-710"></a>
</span><span id="__span-41-711"><a id="__codelineno-41-711" name="__codelineno-41-711" href="#__codelineno-41-711"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isCallerSystem</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-712"><a id="__codelineno-41-712" name="__codelineno-41-712" href="#__codelineno-41-712"></a><span class="w">        </span><span class="n">checkBroadcastFromSystem</span><span class="p">(</span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">callerApp</span><span class="p">,</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">,</span>
</span><span id="__span-41-713"><a id="__codelineno-41-713" name="__codelineno-41-713" href="#__codelineno-41-713"></a><span class="w">                </span><span class="n">isProtectedBroadcast</span><span class="p">,</span><span class="w"> </span><span class="n">receivers</span><span class="p">);</span>
</span><span id="__span-41-714"><a id="__codelineno-41-714" name="__codelineno-41-714" href="#__codelineno-41-714"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-41-715"><a id="__codelineno-41-715" name="__codelineno-41-715" href="#__codelineno-41-715"></a>
</span><span id="__span-41-716"><a id="__codelineno-41-716" name="__codelineno-41-716" href="#__codelineno-41-716"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">receivers</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">receivers</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-41-717"><a id="__codelineno-41-717" name="__codelineno-41-717" href="#__codelineno-41-717"></a><span class="w">            </span><span class="o">||</span><span class="w"> </span><span class="n">resultTo</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-718"><a id="__codelineno-41-718" name="__codelineno-41-718" href="#__codelineno-41-718"></a><span class="w">        </span><span class="n">BroadcastQueue</span><span class="w"> </span><span class="n">queue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">broadcastQueueForIntent</span><span class="p">(</span><span class="n">intent</span><span class="p">);</span>
</span><span id="__span-41-719"><a id="__codelineno-41-719" name="__codelineno-41-719" href="#__codelineno-41-719"></a><span class="w">        </span><span class="n">BroadcastRecord</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">callerApp</span><span class="p">,</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">,</span>
</span><span id="__span-41-720"><a id="__codelineno-41-720" name="__codelineno-41-720" href="#__codelineno-41-720"></a><span class="w">                </span><span class="n">callerFeatureId</span><span class="p">,</span><span class="w"> </span><span class="n">callingPid</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">,</span><span class="w"> </span><span class="n">callerInstantApp</span><span class="p">,</span><span class="w"> </span><span class="n">resolvedType</span><span class="p">,</span>
</span><span id="__span-41-721"><a id="__codelineno-41-721" name="__codelineno-41-721" href="#__codelineno-41-721"></a><span class="w">                </span><span class="n">requiredPermissions</span><span class="p">,</span><span class="w"> </span><span class="n">excludedPermissions</span><span class="p">,</span><span class="w"> </span><span class="n">excludedPackages</span><span class="p">,</span><span class="w"> </span><span class="n">appOp</span><span class="p">,</span><span class="w"> </span><span class="n">brOptions</span><span class="p">,</span>
</span><span id="__span-41-722"><a id="__codelineno-41-722" name="__codelineno-41-722" href="#__codelineno-41-722"></a><span class="w">                </span><span class="n">receivers</span><span class="p">,</span><span class="w"> </span><span class="n">resultTo</span><span class="p">,</span><span class="w"> </span><span class="n">resultCode</span><span class="p">,</span><span class="w"> </span><span class="n">resultData</span><span class="p">,</span><span class="w"> </span><span class="n">resultExtras</span><span class="p">,</span>
</span><span id="__span-41-723"><a id="__codelineno-41-723" name="__codelineno-41-723" href="#__codelineno-41-723"></a><span class="w">                </span><span class="n">ordered</span><span class="p">,</span><span class="w"> </span><span class="n">sticky</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">allowBackgroundActivityStarts</span><span class="p">,</span>
</span><span id="__span-41-724"><a id="__codelineno-41-724" name="__codelineno-41-724" href="#__codelineno-41-724"></a><span class="w">                </span><span class="n">backgroundActivityStartsToken</span><span class="p">,</span><span class="w"> </span><span class="n">timeoutExempt</span><span class="p">);</span>
</span><span id="__span-41-725"><a id="__codelineno-41-725" name="__codelineno-41-725" href="#__codelineno-41-725"></a>
</span><span id="__span-41-726"><a id="__codelineno-41-726" name="__codelineno-41-726" href="#__codelineno-41-726"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Enqueueing ordered broadcast &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-41-727"><a id="__codelineno-41-727" name="__codelineno-41-727" href="#__codelineno-41-727"></a>
</span><span id="__span-41-728"><a id="__codelineno-41-728" name="__codelineno-41-728" href="#__codelineno-41-728"></a><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="w"> </span><span class="n">oldRecord</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-41-729"><a id="__codelineno-41-729" name="__codelineno-41-729" href="#__codelineno-41-729"></a><span class="w">                </span><span class="n">replacePending</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">queue</span><span class="p">.</span><span class="na">replaceOrderedBroadcastLocked</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-41-730"><a id="__codelineno-41-730" name="__codelineno-41-730" href="#__codelineno-41-730"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oldRecord</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-731"><a id="__codelineno-41-731" name="__codelineno-41-731" href="#__codelineno-41-731"></a><span class="w">            </span><span class="c1">// Replaced, fire the result-to receiver.</span>
</span><span id="__span-41-732"><a id="__codelineno-41-732" name="__codelineno-41-732" href="#__codelineno-41-732"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oldRecord</span><span class="p">.</span><span class="na">resultTo</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-733"><a id="__codelineno-41-733" name="__codelineno-41-733" href="#__codelineno-41-733"></a><span class="w">                </span><span class="kd">final</span><span class="w"> </span><span class="n">BroadcastQueue</span><span class="w"> </span><span class="n">oldQueue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">broadcastQueueForIntent</span><span class="p">(</span><span class="n">oldRecord</span><span class="p">.</span><span class="na">intent</span><span class="p">);</span>
</span><span id="__span-41-734"><a id="__codelineno-41-734" name="__codelineno-41-734" href="#__codelineno-41-734"></a><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-735"><a id="__codelineno-41-735" name="__codelineno-41-735" href="#__codelineno-41-735"></a><span class="w">                    </span><span class="n">oldQueue</span><span class="p">.</span><span class="na">performReceiveLocked</span><span class="p">(</span><span class="n">oldRecord</span><span class="p">.</span><span class="na">callerApp</span><span class="p">,</span><span class="w"> </span><span class="n">oldRecord</span><span class="p">.</span><span class="na">resultTo</span><span class="p">,</span>
</span><span id="__span-41-736"><a id="__codelineno-41-736" name="__codelineno-41-736" href="#__codelineno-41-736"></a><span class="w">                            </span><span class="n">oldRecord</span><span class="p">.</span><span class="na">intent</span><span class="p">,</span>
</span><span id="__span-41-737"><a id="__codelineno-41-737" name="__codelineno-41-737" href="#__codelineno-41-737"></a><span class="w">                            </span><span class="n">Activity</span><span class="p">.</span><span class="na">RESULT_CANCELED</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
</span><span id="__span-41-738"><a id="__codelineno-41-738" name="__codelineno-41-738" href="#__codelineno-41-738"></a><span class="w">                            </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">oldRecord</span><span class="p">.</span><span class="na">userId</span><span class="p">,</span><span class="w"> </span><span class="n">oldRecord</span><span class="p">.</span><span class="na">callingUid</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">);</span>
</span><span id="__span-41-739"><a id="__codelineno-41-739" name="__codelineno-41-739" href="#__codelineno-41-739"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-740"><a id="__codelineno-41-740" name="__codelineno-41-740" href="#__codelineno-41-740"></a><span class="w">                    </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Failure [&quot;</span>
</span><span id="__span-41-741"><a id="__codelineno-41-741" name="__codelineno-41-741" href="#__codelineno-41-741"></a><span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">queue</span><span class="p">.</span><span class="na">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;] sending broadcast result of &quot;</span>
</span><span id="__span-41-742"><a id="__codelineno-41-742" name="__codelineno-41-742" href="#__codelineno-41-742"></a><span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
</span><span id="__span-41-743"><a id="__codelineno-41-743" name="__codelineno-41-743" href="#__codelineno-41-743"></a>
</span><span id="__span-41-744"><a id="__codelineno-41-744" name="__codelineno-41-744" href="#__codelineno-41-744"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-41-745"><a id="__codelineno-41-745" name="__codelineno-41-745" href="#__codelineno-41-745"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-41-746"><a id="__codelineno-41-746" name="__codelineno-41-746" href="#__codelineno-41-746"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-747"><a id="__codelineno-41-747" name="__codelineno-41-747" href="#__codelineno-41-747"></a><span class="w">            </span><span class="n">queue</span><span class="p">.</span><span class="na">enqueueOrderedBroadcastLocked</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-41-748"><a id="__codelineno-41-748" name="__codelineno-41-748" href="#__codelineno-41-748"></a><span class="w">            </span><span class="n">queue</span><span class="p">.</span><span class="na">scheduleBroadcastsLocked</span><span class="p">();</span>
</span><span id="__span-41-749"><a id="__codelineno-41-749" name="__codelineno-41-749" href="#__codelineno-41-749"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-41-750"><a id="__codelineno-41-750" name="__codelineno-41-750" href="#__codelineno-41-750"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-751"><a id="__codelineno-41-751" name="__codelineno-41-751" href="#__codelineno-41-751"></a><span class="w">        </span><span class="c1">// There was nobody interested in the broadcast, but we still want to record</span>
</span><span id="__span-41-752"><a id="__codelineno-41-752" name="__codelineno-41-752" href="#__codelineno-41-752"></a><span class="w">        </span><span class="c1">// that it happened.</span>
</span><span id="__span-41-753"><a id="__codelineno-41-753" name="__codelineno-41-753" href="#__codelineno-41-753"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getComponent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getPackage</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span>
</span><span id="__span-41-754"><a id="__codelineno-41-754" name="__codelineno-41-754" href="#__codelineno-41-754"></a><span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getFlags</span><span class="p">()</span><span class="o">&amp;</span><span class="n">Intent</span><span class="p">.</span><span class="na">FLAG_RECEIVER_REGISTERED_ONLY</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-755"><a id="__codelineno-41-755" name="__codelineno-41-755" href="#__codelineno-41-755"></a><span class="w">            </span><span class="c1">// This was an implicit broadcast... let&#39;s record it for posterity.</span>
</span><span id="__span-41-756"><a id="__codelineno-41-756" name="__codelineno-41-756" href="#__codelineno-41-756"></a><span class="w">            </span><span class="n">addBroadcastStatLocked</span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">(),</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-41-757"><a id="__codelineno-41-757" name="__codelineno-41-757" href="#__codelineno-41-757"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-41-758"><a id="__codelineno-41-758" name="__codelineno-41-758" href="#__codelineno-41-758"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-41-759"><a id="__codelineno-41-759" name="__codelineno-41-759" href="#__codelineno-41-759"></a>
</span><span id="__span-41-760"><a id="__codelineno-41-760" name="__codelineno-41-760" href="#__codelineno-41-760"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">BROADCAST_SUCCESS</span><span class="p">;</span>
</span><span id="__span-41-761"><a id="__codelineno-41-761" name="__codelineno-41-761" href="#__codelineno-41-761"></a><span class="p">}</span>
</span></code></pre></div>
<p>这个函数代码非常多，下面我们从几个方面来分析：</p>
<h4 id="instant-app">instant app<a class="headerlink" href="#instant-app" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">callerInstantApp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isInstantApp</span><span class="p">(</span><span class="n">callerApp</span><span class="p">,</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">);</span>
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="c1">// Instant Apps cannot use FLAG_RECEIVER_VISIBLE_TO_INSTANT_APPS</span>
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">callerInstantApp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a><span class="w">    </span><span class="c1">// 如果caller是instant app，则不能使用FLAG_RECEIVER_VISIBLE_TO_INSTANT_APPS</span>
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a><span class="w">    </span><span class="c1">// 即instant app不能发送给instant app可见的广播</span>
</span><span id="__span-42-6"><a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a><span class="w">    </span><span class="n">intent</span><span class="p">.</span><span class="na">setFlags</span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getFlags</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">Intent</span><span class="p">.</span><span class="na">FLAG_RECEIVER_VISIBLE_TO_INSTANT_APPS</span><span class="p">);</span>
</span><span id="__span-42-7"><a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a><span class="p">}</span>
</span></code></pre></div>
<p>instant app不能发送给instant app可见的广播。</p>
<h4 id="stop">不发送给stop应用<a class="headerlink" href="#stop" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="c1">// By default broadcasts do not go to stopped apps.</span>
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="c1">//默认广播是不发送给stop的应用的，类似于安装后进程从未启动过，或者给强行停止的应用，</span>
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="c1">//是无法通过接收静态注册的广播来启动的(具体在IntentResolver.java的buildResolveList会使用)</span>
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a><span class="n">intent</span><span class="p">.</span><span class="na">addFlags</span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="na">FLAG_EXCLUDE_STOPPED_PACKAGES</span><span class="p">);</span>
</span></code></pre></div>
<h4 id="_27">开机未完成<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="c1">// If we have not finished booting, don&#39;t allow this to launch new processes.</span>
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="c1">//mProcessesReady在systemReady的时候会设置为true</span>
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a><span class="c1">//在系统没有启动完成的时候，而且广播发送没有带FLAG_RECEIVER_BOOT_UPGRADE的flag</span>
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mProcessesReady</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getFlags</span><span class="p">()</span><span class="o">&amp;</span><span class="n">Intent</span><span class="p">.</span><span class="na">FLAG_RECEIVER_BOOT_UPGRADE</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a><span class="w">    </span><span class="c1">//则默认只能发送到动态注册的接收者中，静态注册的全部无法接收</span>
</span><span id="__span-44-6"><a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a><span class="w">    </span><span class="n">intent</span><span class="p">.</span><span class="na">addFlags</span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="na">FLAG_RECEIVER_REGISTERED_ONLY</span><span class="p">);</span>
</span><span id="__span-44-7"><a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a><span class="p">}</span>
</span></code></pre></div>
<p>如果开机还没有完成，且没有带升级状态可接受的flag（FLAG_RECEIVER_BOOT_UPGRADE），则默认只能发送到动态注册的接收者中，静态注册的全部无法接收。</p>
<h4 id="user">user校验<a class="headerlink" href="#user" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="c1">// 获取当前发送广播应用所在用户的userId</span>
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="n">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mUserController</span><span class="p">.</span><span class="na">handleIncomingUser</span><span class="p">(</span><span class="n">callingPid</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="w">        </span><span class="n">ALLOW_NON_FULL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;broadcast&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">);</span>
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a>
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="c1">// Make sure that the user who is receiving this broadcast or its parent is running.</span>
</span><span id="__span-45-6"><a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a><span class="c1">// If not, we will just skip it. Make an exception for shutdown broadcasts, upgrade steps.</span>
</span><span id="__span-45-7"><a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a><span class="c1">//如果userId不是发送到所有用户USER_ALL(-1)，而且当前userId和它的父亲userId都没有在运行</span>
</span><span id="__span-45-8"><a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">userId</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">USER_ALL</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">mUserController</span><span class="p">.</span><span class="na">isUserOrItsParentRunning</span><span class="p">(</span><span class="n">userId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-45-9"><a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a><span class="w">    </span><span class="c1">//如果调用者不是系统或者没有设置FLAG_RECEIVER_BOOT_UPGRADE，而且不是关机广播，</span>
</span><span id="__span-45-10"><a id="__codelineno-45-10" name="__codelineno-45-10" href="#__codelineno-45-10"></a><span class="w">    </span><span class="c1">//则跳过本次广播发送，不允许stop的userId发送广播，原因是user已经stop了</span>
</span><span id="__span-45-11"><a id="__codelineno-45-11" name="__codelineno-45-11" href="#__codelineno-45-11"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">callingUid</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">SYSTEM_UID</span>
</span><span id="__span-45-12"><a id="__codelineno-45-12" name="__codelineno-45-12" href="#__codelineno-45-12"></a><span class="w">            </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getFlags</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">FLAG_RECEIVER_BOOT_UPGRADE</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-45-13"><a id="__codelineno-45-13" name="__codelineno-45-13" href="#__codelineno-45-13"></a><span class="w">            </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_SHUTDOWN</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-45-14"><a id="__codelineno-45-14" name="__codelineno-45-14" href="#__codelineno-45-14"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Skipping broadcast of &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">intent</span>
</span><span id="__span-45-15"><a id="__codelineno-45-15" name="__codelineno-45-15" href="#__codelineno-45-15"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;: user &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">userId</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; and its parent (if any) are stopped&quot;</span><span class="p">);</span>
</span><span id="__span-45-16"><a id="__codelineno-45-16" name="__codelineno-45-16" href="#__codelineno-45-16"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">BROADCAST_FAILED_USER_STOPPED</span><span class="p">;</span>
</span><span id="__span-45-17"><a id="__codelineno-45-17" name="__codelineno-45-17" href="#__codelineno-45-17"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-45-18"><a id="__codelineno-45-18" name="__codelineno-45-18" href="#__codelineno-45-18"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="_28">检查权限<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="c1">//获取action</span>
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">();</span>
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a><span class="n">BroadcastOptions</span><span class="w"> </span><span class="n">brOptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a><span class="c1">//是否有传入BroadcastOptions的Bundle，开机广播有传入bOptions，亮屏幕广播没有bOptions</span>
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bOptions</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-46-6"><a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a><span class="w">    </span><span class="c1">//将Bundle转换成BroadcastOptions brOptions</span>
</span><span id="__span-46-7"><a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a><span class="w">    </span><span class="n">brOptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BroadcastOptions</span><span class="p">(</span><span class="n">bOptions</span><span class="p">);</span>
</span><span id="__span-46-8"><a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">brOptions</span><span class="p">.</span><span class="na">getTemporaryAppAllowlistDuration</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-46-9"><a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a><span class="w">        </span><span class="c1">// See if the caller is allowed to do this.  Note we are checking against</span>
</span><span id="__span-46-10"><a id="__codelineno-46-10" name="__codelineno-46-10" href="#__codelineno-46-10"></a><span class="w">        </span><span class="c1">// the actual real caller (not whoever provided the operation as say a</span>
</span><span id="__span-46-11"><a id="__codelineno-46-11" name="__codelineno-46-11" href="#__codelineno-46-11"></a><span class="w">        </span><span class="c1">// PendingIntent), because that who is actually supplied the arguments.</span>
</span><span id="__span-46-12"><a id="__codelineno-46-12" name="__codelineno-46-12" href="#__codelineno-46-12"></a>
</span><span id="__span-46-13"><a id="__codelineno-46-13" name="__codelineno-46-13" href="#__codelineno-46-13"></a><span class="w">        </span><span class="c1">// 检查一下realCallingPid/realCallingUid是否拥有CHANGE_DEVICE_IDLE_TEMP_WHITELIST(修改临时白名单)、</span>
</span><span id="__span-46-14"><a id="__codelineno-46-14" name="__codelineno-46-14" href="#__codelineno-46-14"></a><span class="w">        </span><span class="c1">// START_ACTIVITIES_FROM_BACKGROUND(后台启动activity)、</span>
</span><span id="__span-46-15"><a id="__codelineno-46-15" name="__codelineno-46-15" href="#__codelineno-46-15"></a><span class="w">        </span><span class="c1">// START_FOREGROUND_SERVICES_FROM_BACKGROUND(后台启动前台服务)的权限，</span>
</span><span id="__span-46-16"><a id="__codelineno-46-16" name="__codelineno-46-16" href="#__codelineno-46-16"></a><span class="w">        </span><span class="c1">// 如果一个都没有，则不允许发送该广播，并抛出安全异常</span>
</span><span id="__span-46-17"><a id="__codelineno-46-17" name="__codelineno-46-17" href="#__codelineno-46-17"></a><span class="w">        </span><span class="c1">// (在部分情况下callingPid/callingUid调用该发送广播的调用者，于realCallingPid/realCallingUid真实调用者不是一样的)</span>
</span><span id="__span-46-18"><a id="__codelineno-46-18" name="__codelineno-46-18" href="#__codelineno-46-18"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">checkComponentPermission</span><span class="p">(</span><span class="n">CHANGE_DEVICE_IDLE_TEMP_WHITELIST</span><span class="p">,</span>
</span><span id="__span-46-19"><a id="__codelineno-46-19" name="__codelineno-46-19" href="#__codelineno-46-19"></a><span class="w">                </span><span class="n">realCallingPid</span><span class="p">,</span><span class="w"> </span><span class="n">realCallingUid</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
</span><span id="__span-46-20"><a id="__codelineno-46-20" name="__codelineno-46-20" href="#__codelineno-46-20"></a><span class="w">                </span><span class="o">!=</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="na">PERMISSION_GRANTED</span>
</span><span id="__span-46-21"><a id="__codelineno-46-21" name="__codelineno-46-21" href="#__codelineno-46-21"></a><span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">checkComponentPermission</span><span class="p">(</span><span class="n">START_ACTIVITIES_FROM_BACKGROUND</span><span class="p">,</span>
</span><span id="__span-46-22"><a id="__codelineno-46-22" name="__codelineno-46-22" href="#__codelineno-46-22"></a><span class="w">                </span><span class="n">realCallingPid</span><span class="p">,</span><span class="w"> </span><span class="n">realCallingUid</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
</span><span id="__span-46-23"><a id="__codelineno-46-23" name="__codelineno-46-23" href="#__codelineno-46-23"></a><span class="w">                </span><span class="o">!=</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="na">PERMISSION_GRANTED</span>
</span><span id="__span-46-24"><a id="__codelineno-46-24" name="__codelineno-46-24" href="#__codelineno-46-24"></a><span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">checkComponentPermission</span><span class="p">(</span><span class="n">START_FOREGROUND_SERVICES_FROM_BACKGROUND</span><span class="p">,</span>
</span><span id="__span-46-25"><a id="__codelineno-46-25" name="__codelineno-46-25" href="#__codelineno-46-25"></a><span class="w">                </span><span class="n">realCallingPid</span><span class="p">,</span><span class="w"> </span><span class="n">realCallingUid</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
</span><span id="__span-46-26"><a id="__codelineno-46-26" name="__codelineno-46-26" href="#__codelineno-46-26"></a><span class="w">                </span><span class="o">!=</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="na">PERMISSION_GRANTED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-46-27"><a id="__codelineno-46-27" name="__codelineno-46-27" href="#__codelineno-46-27"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Permission Denial: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">()</span>
</span><span id="__span-46-28"><a id="__codelineno-46-28" name="__codelineno-46-28" href="#__codelineno-46-28"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; broadcast from &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callerPackage</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; (pid=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callingPid</span>
</span><span id="__span-46-29"><a id="__codelineno-46-29" name="__codelineno-46-29" href="#__codelineno-46-29"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, uid=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callingUid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;)&quot;</span>
</span><span id="__span-46-30"><a id="__codelineno-46-30" name="__codelineno-46-30" href="#__codelineno-46-30"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; requires &quot;</span>
</span><span id="__span-46-31"><a id="__codelineno-46-31" name="__codelineno-46-31" href="#__codelineno-46-31"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">CHANGE_DEVICE_IDLE_TEMP_WHITELIST</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; or &quot;</span>
</span><span id="__span-46-32"><a id="__codelineno-46-32" name="__codelineno-46-32" href="#__codelineno-46-32"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">START_ACTIVITIES_FROM_BACKGROUND</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; or &quot;</span>
</span><span id="__span-46-33"><a id="__codelineno-46-33" name="__codelineno-46-33" href="#__codelineno-46-33"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">START_FOREGROUND_SERVICES_FROM_BACKGROUND</span><span class="p">;</span>
</span><span id="__span-46-34"><a id="__codelineno-46-34" name="__codelineno-46-34" href="#__codelineno-46-34"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span>
</span><span id="__span-46-35"><a id="__codelineno-46-35" name="__codelineno-46-35" href="#__codelineno-46-35"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecurityException</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span><span id="__span-46-36"><a id="__codelineno-46-36" name="__codelineno-46-36" href="#__codelineno-46-36"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-46-37"><a id="__codelineno-46-37" name="__codelineno-46-37" href="#__codelineno-46-37"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-46-38"><a id="__codelineno-46-38" name="__codelineno-46-38" href="#__codelineno-46-38"></a><span class="w">    </span><span class="c1">//如果带有mDontSendToRestrictedApps不发送给受限制的app</span>
</span><span id="__span-46-39"><a id="__codelineno-46-39" name="__codelineno-46-39" href="#__codelineno-46-39"></a><span class="w">    </span><span class="c1">// callingUid不在mActiveUids中，而且callingUid/callerPackage后台限制操作</span>
</span><span id="__span-46-40"><a id="__codelineno-46-40" name="__codelineno-46-40" href="#__codelineno-46-40"></a><span class="w">    </span><span class="c1">// 则由于“background restrictions”不允许发送广播</span>
</span><span id="__span-46-41"><a id="__codelineno-46-41" name="__codelineno-46-41" href="#__codelineno-46-41"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">brOptions</span><span class="p">.</span><span class="na">isDontSendToRestrictedApps</span><span class="p">()</span>
</span><span id="__span-46-42"><a id="__codelineno-46-42" name="__codelineno-46-42" href="#__codelineno-46-42"></a><span class="w">            </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">isUidActiveLOSP</span><span class="p">(</span><span class="n">callingUid</span><span class="p">)</span>
</span><span id="__span-46-43"><a id="__codelineno-46-43" name="__codelineno-46-43" href="#__codelineno-46-43"></a><span class="w">            </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">isBackgroundRestrictedNoCheck</span><span class="p">(</span><span class="n">callingUid</span><span class="p">,</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-46-44"><a id="__codelineno-46-44" name="__codelineno-46-44" href="#__codelineno-46-44"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Not sending broadcast &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; - app &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callerPackage</span>
</span><span id="__span-46-45"><a id="__codelineno-46-45" name="__codelineno-46-45" href="#__codelineno-46-45"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; has background restrictions&quot;</span><span class="p">);</span>
</span><span id="__span-46-46"><a id="__codelineno-46-46" name="__codelineno-46-46" href="#__codelineno-46-46"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">START_CANCELED</span><span class="p">;</span>
</span><span id="__span-46-47"><a id="__codelineno-46-47" name="__codelineno-46-47" href="#__codelineno-46-47"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-46-48"><a id="__codelineno-46-48" name="__codelineno-46-48" href="#__codelineno-46-48"></a><span class="w">    </span><span class="c1">//是否允许mAllowBackgroundActivityStarts后台启动activity</span>
</span><span id="__span-46-49"><a id="__codelineno-46-49" name="__codelineno-46-49" href="#__codelineno-46-49"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">brOptions</span><span class="p">.</span><span class="na">allowsBackgroundActivityStarts</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-46-50"><a id="__codelineno-46-50" name="__codelineno-46-50" href="#__codelineno-46-50"></a><span class="w">        </span><span class="c1">// See if the caller is allowed to do this.  Note we are checking against</span>
</span><span id="__span-46-51"><a id="__codelineno-46-51" name="__codelineno-46-51" href="#__codelineno-46-51"></a><span class="w">        </span><span class="c1">// the actual real caller (not whoever provided the operation as say a</span>
</span><span id="__span-46-52"><a id="__codelineno-46-52" name="__codelineno-46-52" href="#__codelineno-46-52"></a><span class="w">        </span><span class="c1">// PendingIntent), because that who is actually supplied the arguments.</span>
</span><span id="__span-46-53"><a id="__codelineno-46-53" name="__codelineno-46-53" href="#__codelineno-46-53"></a><span class="w">        </span><span class="c1">//如果没有START_ACTIVITIES_FROM_BACKGROUND则抛出权限异常</span>
</span><span id="__span-46-54"><a id="__codelineno-46-54" name="__codelineno-46-54" href="#__codelineno-46-54"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">checkComponentPermission</span><span class="p">(</span>
</span><span id="__span-46-55"><a id="__codelineno-46-55" name="__codelineno-46-55" href="#__codelineno-46-55"></a><span class="w">                </span><span class="n">android</span><span class="p">.</span><span class="na">Manifest</span><span class="p">.</span><span class="na">permission</span><span class="p">.</span><span class="na">START_ACTIVITIES_FROM_BACKGROUND</span><span class="p">,</span>
</span><span id="__span-46-56"><a id="__codelineno-46-56" name="__codelineno-46-56" href="#__codelineno-46-56"></a><span class="w">                </span><span class="n">realCallingPid</span><span class="p">,</span><span class="w"> </span><span class="n">realCallingUid</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
</span><span id="__span-46-57"><a id="__codelineno-46-57" name="__codelineno-46-57" href="#__codelineno-46-57"></a><span class="w">                </span><span class="o">!=</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="na">PERMISSION_GRANTED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-46-58"><a id="__codelineno-46-58" name="__codelineno-46-58" href="#__codelineno-46-58"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Permission Denial: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">()</span>
</span><span id="__span-46-59"><a id="__codelineno-46-59" name="__codelineno-46-59" href="#__codelineno-46-59"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; broadcast from &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callerPackage</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; (pid=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callingPid</span>
</span><span id="__span-46-60"><a id="__codelineno-46-60" name="__codelineno-46-60" href="#__codelineno-46-60"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, uid=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callingUid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;)&quot;</span>
</span><span id="__span-46-61"><a id="__codelineno-46-61" name="__codelineno-46-61" href="#__codelineno-46-61"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; requires &quot;</span>
</span><span id="__span-46-62"><a id="__codelineno-46-62" name="__codelineno-46-62" href="#__codelineno-46-62"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">android</span><span class="p">.</span><span class="na">Manifest</span><span class="p">.</span><span class="na">permission</span><span class="p">.</span><span class="na">START_ACTIVITIES_FROM_BACKGROUND</span><span class="p">;</span>
</span><span id="__span-46-63"><a id="__codelineno-46-63" name="__codelineno-46-63" href="#__codelineno-46-63"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span>
</span><span id="__span-46-64"><a id="__codelineno-46-64" name="__codelineno-46-64" href="#__codelineno-46-64"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecurityException</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span><span id="__span-46-65"><a id="__codelineno-46-65" name="__codelineno-46-65" href="#__codelineno-46-65"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="c1">//将allowBackgroundActivityStarts设置成true，允许后台启动activity</span>
</span><span id="__span-46-66"><a id="__codelineno-46-66" name="__codelineno-46-66" href="#__codelineno-46-66"></a><span class="w">            </span><span class="n">allowBackgroundActivityStarts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-46-67"><a id="__codelineno-46-67" name="__codelineno-46-67" href="#__codelineno-46-67"></a><span class="w">            </span><span class="c1">// We set the token to null since if it wasn&#39;t for it we&#39;d allow anyway here</span>
</span><span id="__span-46-68"><a id="__codelineno-46-68" name="__codelineno-46-68" href="#__codelineno-46-68"></a><span class="w">            </span><span class="n">backgroundActivityStartsToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-46-69"><a id="__codelineno-46-69" name="__codelineno-46-69" href="#__codelineno-46-69"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-46-70"><a id="__codelineno-46-70" name="__codelineno-46-70" href="#__codelineno-46-70"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-46-71"><a id="__codelineno-46-71" name="__codelineno-46-71" href="#__codelineno-46-71"></a>
</span><span id="__span-46-72"><a id="__codelineno-46-72" name="__codelineno-46-72" href="#__codelineno-46-72"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">brOptions</span><span class="p">.</span><span class="na">getIdForResponseEvent</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-46-73"><a id="__codelineno-46-73" name="__codelineno-46-73" href="#__codelineno-46-73"></a><span class="w">        </span><span class="n">enforcePermission</span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">Manifest</span><span class="p">.</span><span class="na">permission</span><span class="p">.</span><span class="na">ACCESS_BROADCAST_RESPONSE_STATS</span><span class="p">,</span>
</span><span id="__span-46-74"><a id="__codelineno-46-74" name="__codelineno-46-74" href="#__codelineno-46-74"></a><span class="w">                </span><span class="n">callingPid</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;recordResponseEventWhileInBackground&quot;</span><span class="p">);</span>
</span><span id="__span-46-75"><a id="__codelineno-46-75" name="__codelineno-46-75" href="#__codelineno-46-75"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-46-76"><a id="__codelineno-46-76" name="__codelineno-46-76" href="#__codelineno-46-76"></a><span class="p">}</span>
</span></code></pre></div>
<p>bOptions是Bundle，brOptions是通过bOptions转换的，大部分情况下发广播都不带Bundle的。</p>
<ul>
<li>检查caller是否有改变deviceidle名单的权限，如果没有后台启动activity、后台启动前台服务，则不允许发送该广播，并抛出安全异常。</li>
<li>检查是否可以发送给受限制的app</li>
<li>通过BroadcastOptions的mAllowBackgroundActivityStarts成员编译检查是否允许后台启动activity</li>
</ul>
<h4 id="_29">保护广播<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="c1">// Verify that protected broadcasts are only being sent by system code,</span>
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="c1">// and that system code is only sending protected broadcasts.</span>
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isProtectedBroadcast</span><span class="p">;</span>
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-5"><a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a><span class="w">    </span><span class="c1">//http://aospxref.com/android-13.0.0_r3/xref/frameworks/base/core/res/AndroidManifest.xml</span>
</span><span id="__span-47-6"><a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a><span class="w">    </span><span class="c1">//带有“protected-broadcast”的广播</span>
</span><span id="__span-47-7"><a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a><span class="w">    </span><span class="n">isProtectedBroadcast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AppGlobals</span><span class="p">.</span><span class="na">getPackageManager</span><span class="p">().</span><span class="na">isProtectedBroadcast</span><span class="p">(</span><span class="n">action</span><span class="p">);</span>
</span><span id="__span-47-8"><a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-9"><a id="__codelineno-47-9" name="__codelineno-47-9" href="#__codelineno-47-9"></a><span class="w">    </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Remote exception&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
</span><span id="__span-47-10"><a id="__codelineno-47-10" name="__codelineno-47-10" href="#__codelineno-47-10"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">BROADCAST_SUCCESS</span><span class="p">;</span>
</span><span id="__span-47-11"><a id="__codelineno-47-11" name="__codelineno-47-11" href="#__codelineno-47-11"></a><span class="p">}</span>
</span><span id="__span-47-12"><a id="__codelineno-47-12" name="__codelineno-47-12" href="#__codelineno-47-12"></a>
</span><span id="__span-47-13"><a id="__codelineno-47-13" name="__codelineno-47-13" href="#__codelineno-47-13"></a><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isCallerSystem</span><span class="p">;</span>
</span><span id="__span-47-14"><a id="__codelineno-47-14" name="__codelineno-47-14" href="#__codelineno-47-14"></a><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">UserHandle</span><span class="p">.</span><span class="na">getAppId</span><span class="p">(</span><span class="n">callingUid</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-15"><a id="__codelineno-47-15" name="__codelineno-47-15" href="#__codelineno-47-15"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">ROOT_UID</span><span class="p">:</span>
</span><span id="__span-47-16"><a id="__codelineno-47-16" name="__codelineno-47-16" href="#__codelineno-47-16"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">SYSTEM_UID</span><span class="p">:</span>
</span><span id="__span-47-17"><a id="__codelineno-47-17" name="__codelineno-47-17" href="#__codelineno-47-17"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">PHONE_UID</span><span class="p">:</span>
</span><span id="__span-47-18"><a id="__codelineno-47-18" name="__codelineno-47-18" href="#__codelineno-47-18"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">BLUETOOTH_UID</span><span class="p">:</span>
</span><span id="__span-47-19"><a id="__codelineno-47-19" name="__codelineno-47-19" href="#__codelineno-47-19"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">NFC_UID</span><span class="p">:</span>
</span><span id="__span-47-20"><a id="__codelineno-47-20" name="__codelineno-47-20" href="#__codelineno-47-20"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">SE_UID</span><span class="p">:</span>
</span><span id="__span-47-21"><a id="__codelineno-47-21" name="__codelineno-47-21" href="#__codelineno-47-21"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">NETWORK_STACK_UID</span><span class="p">:</span>
</span><span id="__span-47-22"><a id="__codelineno-47-22" name="__codelineno-47-22" href="#__codelineno-47-22"></a><span class="w">        </span><span class="n">isCallerSystem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-47-23"><a id="__codelineno-47-23" name="__codelineno-47-23" href="#__codelineno-47-23"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-47-24"><a id="__codelineno-47-24" name="__codelineno-47-24" href="#__codelineno-47-24"></a><span class="w">    </span><span class="k">default</span><span class="p">:</span>
</span><span id="__span-47-25"><a id="__codelineno-47-25" name="__codelineno-47-25" href="#__codelineno-47-25"></a><span class="w">        </span><span class="n">isCallerSystem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">callerApp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">callerApp</span><span class="p">.</span><span class="na">isPersistent</span><span class="p">();</span>
</span><span id="__span-47-26"><a id="__codelineno-47-26" name="__codelineno-47-26" href="#__codelineno-47-26"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-47-27"><a id="__codelineno-47-27" name="__codelineno-47-27" href="#__codelineno-47-27"></a><span class="p">}</span>
</span><span id="__span-47-28"><a id="__codelineno-47-28" name="__codelineno-47-28" href="#__codelineno-47-28"></a>
</span><span id="__span-47-29"><a id="__codelineno-47-29" name="__codelineno-47-29" href="#__codelineno-47-29"></a><span class="c1">// First line security check before anything else: stop non-system apps from</span>
</span><span id="__span-47-30"><a id="__codelineno-47-30" name="__codelineno-47-30" href="#__codelineno-47-30"></a><span class="c1">// sending protected broadcasts.</span>
</span><span id="__span-47-31"><a id="__codelineno-47-31" name="__codelineno-47-31" href="#__codelineno-47-31"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isCallerSystem</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-32"><a id="__codelineno-47-32" name="__codelineno-47-32" href="#__codelineno-47-32"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isProtectedBroadcast</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="c1">//不是系统不能发送保护广播</span>
</span><span id="__span-47-33"><a id="__codelineno-47-33" name="__codelineno-47-33" href="#__codelineno-47-33"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Permission Denial: not allowed to send broadcast &quot;</span>
</span><span id="__span-47-34"><a id="__codelineno-47-34" name="__codelineno-47-34" href="#__codelineno-47-34"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; from pid=&quot;</span>
</span><span id="__span-47-35"><a id="__codelineno-47-35" name="__codelineno-47-35" href="#__codelineno-47-35"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">callingPid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, uid=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callingUid</span><span class="p">;</span>
</span><span id="__span-47-36"><a id="__codelineno-47-36" name="__codelineno-47-36" href="#__codelineno-47-36"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span>
</span><span id="__span-47-37"><a id="__codelineno-47-37" name="__codelineno-47-37" href="#__codelineno-47-37"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecurityException</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span><span id="__span-47-38"><a id="__codelineno-47-38" name="__codelineno-47-38" href="#__codelineno-47-38"></a>
</span><span id="__span-47-39"><a id="__codelineno-47-39" name="__codelineno-47-39" href="#__codelineno-47-39"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">AppWidgetManager</span><span class="p">.</span><span class="na">ACTION_APPWIDGET_CONFIGURE</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
</span><span id="__span-47-40"><a id="__codelineno-47-40" name="__codelineno-47-40" href="#__codelineno-47-40"></a><span class="w">            </span><span class="o">||</span><span class="w"> </span><span class="n">AppWidgetManager</span><span class="p">.</span><span class="na">ACTION_APPWIDGET_UPDATE</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">action</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-41"><a id="__codelineno-47-41" name="__codelineno-47-41" href="#__codelineno-47-41"></a><span class="w">        </span><span class="c1">//如果是widget配置(ACTION_APPWIDGET_CONFIGURE)和更新(ACTION_APPWIDGET_UPDATE)</span>
</span><span id="__span-47-42"><a id="__codelineno-47-42" name="__codelineno-47-42" href="#__codelineno-47-42"></a><span class="w">        </span><span class="c1">//则调用callerPackage不能是空</span>
</span><span id="__span-47-43"><a id="__codelineno-47-43" name="__codelineno-47-43" href="#__codelineno-47-43"></a><span class="w">        </span><span class="c1">// Special case for compatibility: we don&#39;t want apps to send this,</span>
</span><span id="__span-47-44"><a id="__codelineno-47-44" name="__codelineno-47-44" href="#__codelineno-47-44"></a><span class="w">        </span><span class="c1">// but historically it has not been protected and apps may be using it</span>
</span><span id="__span-47-45"><a id="__codelineno-47-45" name="__codelineno-47-45" href="#__codelineno-47-45"></a><span class="w">        </span><span class="c1">// to poke their own app widget.  So, instead of making it protected,</span>
</span><span id="__span-47-46"><a id="__codelineno-47-46" name="__codelineno-47-46" href="#__codelineno-47-46"></a><span class="w">        </span><span class="c1">// just limit it to the caller.</span>
</span><span id="__span-47-47"><a id="__codelineno-47-47" name="__codelineno-47-47" href="#__codelineno-47-47"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">callerPackage</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-48"><a id="__codelineno-47-48" name="__codelineno-47-48" href="#__codelineno-47-48"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Permission Denial: not allowed to send broadcast &quot;</span>
</span><span id="__span-47-49"><a id="__codelineno-47-49" name="__codelineno-47-49" href="#__codelineno-47-49"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; from unknown caller.&quot;</span><span class="p">;</span>
</span><span id="__span-47-50"><a id="__codelineno-47-50" name="__codelineno-47-50" href="#__codelineno-47-50"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span>
</span><span id="__span-47-51"><a id="__codelineno-47-51" name="__codelineno-47-51" href="#__codelineno-47-51"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecurityException</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span><span id="__span-47-52"><a id="__codelineno-47-52" name="__codelineno-47-52" href="#__codelineno-47-52"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getComponent</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-53"><a id="__codelineno-47-53" name="__codelineno-47-53" href="#__codelineno-47-53"></a><span class="w">            </span><span class="c1">// They are good enough to send to an explicit component...  verify</span>
</span><span id="__span-47-54"><a id="__codelineno-47-54" name="__codelineno-47-54" href="#__codelineno-47-54"></a><span class="w">            </span><span class="c1">// it is being sent to the calling app.</span>
</span><span id="__span-47-55"><a id="__codelineno-47-55" name="__codelineno-47-55" href="#__codelineno-47-55"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">intent</span><span class="p">.</span><span class="na">getComponent</span><span class="p">().</span><span class="na">getPackageName</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span>
</span><span id="__span-47-56"><a id="__codelineno-47-56" name="__codelineno-47-56" href="#__codelineno-47-56"></a><span class="w">                    </span><span class="n">callerPackage</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="c1">//这种情况只能自己发送给自己，不然抛出权限异常</span>
</span><span id="__span-47-57"><a id="__codelineno-47-57" name="__codelineno-47-57" href="#__codelineno-47-57"></a><span class="w">                </span><span class="n">String</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Permission Denial: not allowed to send broadcast &quot;</span>
</span><span id="__span-47-58"><a id="__codelineno-47-58" name="__codelineno-47-58" href="#__codelineno-47-58"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; to &quot;</span>
</span><span id="__span-47-59"><a id="__codelineno-47-59" name="__codelineno-47-59" href="#__codelineno-47-59"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getComponent</span><span class="p">().</span><span class="na">getPackageName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; from &quot;</span>
</span><span id="__span-47-60"><a id="__codelineno-47-60" name="__codelineno-47-60" href="#__codelineno-47-60"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">;</span>
</span><span id="__span-47-61"><a id="__codelineno-47-61" name="__codelineno-47-61" href="#__codelineno-47-61"></a><span class="w">                </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span>
</span><span id="__span-47-62"><a id="__codelineno-47-62" name="__codelineno-47-62" href="#__codelineno-47-62"></a><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecurityException</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span><span id="__span-47-63"><a id="__codelineno-47-63" name="__codelineno-47-63" href="#__codelineno-47-63"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-47-64"><a id="__codelineno-47-64" name="__codelineno-47-64" href="#__codelineno-47-64"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-65"><a id="__codelineno-47-65" name="__codelineno-47-65" href="#__codelineno-47-65"></a><span class="w">            </span><span class="c1">// Limit broadcast to their own package.</span>
</span><span id="__span-47-66"><a id="__codelineno-47-66" name="__codelineno-47-66" href="#__codelineno-47-66"></a><span class="w">            </span><span class="c1">//这类广播只能发给它自己，用于自身widget的更新</span>
</span><span id="__span-47-67"><a id="__codelineno-47-67" name="__codelineno-47-67" href="#__codelineno-47-67"></a><span class="w">            </span><span class="n">intent</span><span class="p">.</span><span class="na">setPackage</span><span class="p">(</span><span class="n">callerPackage</span><span class="p">);</span>
</span><span id="__span-47-68"><a id="__codelineno-47-68" name="__codelineno-47-68" href="#__codelineno-47-68"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-47-69"><a id="__codelineno-47-69" name="__codelineno-47-69" href="#__codelineno-47-69"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-47-70"><a id="__codelineno-47-70" name="__codelineno-47-70" href="#__codelineno-47-70"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>检查是否是保护广播，拿当前需要发的 action 去查 frameworks/base/core/res/AndroidManifest.xml带有“protected-broadcast”的action是否一样。</li>
<li>root用户、系统、phone、蓝牙、nfc、安全、网络等相关调用则被认为是系统，还有就是否常驻进程。</li>
<li>protectBroadcast只能由系统发送。</li>
<li>如果是widget配置(ACTION_APPWIDGET_CONFIGURE)和更新(ACTION_APPWIDGET_UPDATE)，只能发给它自己，用于自身widget的更新。</li>
</ul>
<h4 id="background">广播能否发给background进程<a class="headerlink" href="#background" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="kt">boolean</span><span class="w"> </span><span class="n">timeoutExempt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a>
</span><span id="__span-48-3"><a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">action</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-48-4"><a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a><span class="w">    </span><span class="c1">//查看是否background的进程也可以接收该广播，具体列表在SystemConfig.java的mAllowImplicitBroadcasts</span>
</span><span id="__span-48-5"><a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a><span class="w">    </span><span class="c1">//这个列表是扫描**/etc/sysconfig/*.xml(如system/etc/sysconfig/framework-sysconfig.xml)</span>
</span><span id="__span-48-6"><a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a><span class="w">    </span><span class="c1">//带有“&lt;allow-implicit-broadcast”的广播</span>
</span><span id="__span-48-7"><a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getBackgroundLaunchBroadcasts</span><span class="p">().</span><span class="na">contains</span><span class="p">(</span><span class="n">action</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-48-8"><a id="__codelineno-48-8" name="__codelineno-48-8" href="#__codelineno-48-8"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BACKGROUND_CHECK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-48-9"><a id="__codelineno-48-9" name="__codelineno-48-9" href="#__codelineno-48-9"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Broadcast action &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; forcing include-background&quot;</span><span class="p">);</span>
</span><span id="__span-48-10"><a id="__codelineno-48-10" name="__codelineno-48-10" href="#__codelineno-48-10"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-48-11"><a id="__codelineno-48-11" name="__codelineno-48-11" href="#__codelineno-48-11"></a><span class="w">        </span><span class="n">intent</span><span class="p">.</span><span class="na">addFlags</span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="na">FLAG_RECEIVER_INCLUDE_BACKGROUND</span><span class="p">);</span>
</span><span id="__span-48-12"><a id="__codelineno-48-12" name="__codelineno-48-12" href="#__codelineno-48-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-48-13"><a id="__codelineno-48-13" name="__codelineno-48-13" href="#__codelineno-48-13"></a>
</span><span id="__span-48-14"><a id="__codelineno-48-14" name="__codelineno-48-14" href="#__codelineno-48-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Process</span><span class="p">.</span><span class="na">isSdkSandboxUid</span><span class="p">(</span><span class="n">realCallingUid</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-48-15"><a id="__codelineno-48-15" name="__codelineno-48-15" href="#__codelineno-48-15"></a><span class="w">        </span><span class="n">SdkSandboxManagerLocal</span><span class="w"> </span><span class="n">sdkSandboxManagerLocal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LocalManagerRegistry</span><span class="p">.</span><span class="na">getManager</span><span class="p">(</span>
</span><span id="__span-48-16"><a id="__codelineno-48-16" name="__codelineno-48-16" href="#__codelineno-48-16"></a><span class="w">                </span><span class="n">SdkSandboxManagerLocal</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
</span><span id="__span-48-17"><a id="__codelineno-48-17" name="__codelineno-48-17" href="#__codelineno-48-17"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sdkSandboxManagerLocal</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-48-18"><a id="__codelineno-48-18" name="__codelineno-48-18" href="#__codelineno-48-18"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;SdkSandboxManagerLocal not found when sending&quot;</span>
</span><span id="__span-48-19"><a id="__codelineno-48-19" name="__codelineno-48-19" href="#__codelineno-48-19"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; a broadcast from an SDK sandbox uid.&quot;</span><span class="p">);</span>
</span><span id="__span-48-20"><a id="__codelineno-48-20" name="__codelineno-48-20" href="#__codelineno-48-20"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-48-21"><a id="__codelineno-48-21" name="__codelineno-48-21" href="#__codelineno-48-21"></a><span class="w">        </span><span class="n">sdkSandboxManagerLocal</span><span class="p">.</span><span class="na">enforceAllowedToSendBroadcast</span><span class="p">(</span><span class="n">intent</span><span class="p">);</span>
</span><span id="__span-48-22"><a id="__codelineno-48-22" name="__codelineno-48-22" href="#__codelineno-48-22"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-48-23"><a id="__codelineno-48-23" name="__codelineno-48-23" href="#__codelineno-48-23"></a>
</span><span id="__span-48-24"><a id="__codelineno-48-24" name="__codelineno-48-24" href="#__codelineno-48-24"></a>
</span><span id="__span-48-25"><a id="__codelineno-48-25" name="__codelineno-48-25" href="#__codelineno-48-25"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">action</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-48-26"><a id="__codelineno-48-26" name="__codelineno-48-26" href="#__codelineno-48-26"></a><span class="w">        </span><span class="p">...</span>
</span><span id="__span-48-27"><a id="__codelineno-48-27" name="__codelineno-48-27" href="#__codelineno-48-27"></a><span class="w">        </span><span class="c1">//主要是针对package相关的广播做了特殊处理，这里不再罗列，有兴趣可以自己翻看源码</span>
</span><span id="__span-48-28"><a id="__codelineno-48-28" name="__codelineno-48-28" href="#__codelineno-48-28"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-48-29"><a id="__codelineno-48-29" name="__codelineno-48-29" href="#__codelineno-48-29"></a>
</span><span id="__span-48-30"><a id="__codelineno-48-30" name="__codelineno-48-30" href="#__codelineno-48-30"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-48-31"><a id="__codelineno-48-31" name="__codelineno-48-31" href="#__codelineno-48-31"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>判断后台应用是否被允许接收改广播，也就是SystemConfig.java的mAllowImplicitBroadcasts，具体是扫描 **/etc/sysconfig/*.xml(如system/etc/sysconfig/framework-sysconfig.xml)带有“&lt;allow-implicit-broadcast”的广播。</li>
<li>对某些的action进行特殊处理。</li>
</ul>
<h4 id="_30">处理粘性广播<a class="headerlink" href="#_30" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="c1">// Add to the sticky list if requested.</span>
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sticky</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="w">    </span><span class="c1">//Sticky广播需要在manifest中声明BROADCAST_STICKY权限</span>
</span><span id="__span-49-4"><a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">checkPermission</span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="na">Manifest</span><span class="p">.</span><span class="na">permission</span><span class="p">.</span><span class="na">BROADCAST_STICKY</span><span class="p">,</span>
</span><span id="__span-49-5"><a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a><span class="w">            </span><span class="n">callingPid</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">)</span>
</span><span id="__span-49-6"><a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a><span class="w">            </span><span class="o">!=</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="na">PERMISSION_GRANTED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-49-7"><a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Permission Denial: broadcastIntent() requesting a sticky broadcast from pid=&quot;</span>
</span><span id="__span-49-8"><a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">callingPid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, uid=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">callingUid</span>
</span><span id="__span-49-9"><a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; requires &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">android</span><span class="p">.</span><span class="na">Manifest</span><span class="p">.</span><span class="na">permission</span><span class="p">.</span><span class="na">BROADCAST_STICKY</span><span class="p">;</span>
</span><span id="__span-49-10"><a id="__codelineno-49-10" name="__codelineno-49-10" href="#__codelineno-49-10"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span>
</span><span id="__span-49-11"><a id="__codelineno-49-11" name="__codelineno-49-11" href="#__codelineno-49-11"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecurityException</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span><span id="__span-49-12"><a id="__codelineno-49-12" name="__codelineno-49-12" href="#__codelineno-49-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-49-13"><a id="__codelineno-49-13" name="__codelineno-49-13" href="#__codelineno-49-13"></a><span class="w">    </span><span class="c1">//Sticky广播不能有权限要求</span>
</span><span id="__span-49-14"><a id="__codelineno-49-14" name="__codelineno-49-14" href="#__codelineno-49-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">requiredPermissions</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">requiredPermissions</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-49-15"><a id="__codelineno-49-15" name="__codelineno-49-15" href="#__codelineno-49-15"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Can&#39;t broadcast sticky intent &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">intent</span>
</span><span id="__span-49-16"><a id="__codelineno-49-16" name="__codelineno-49-16" href="#__codelineno-49-16"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; and enforce permissions &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Arrays</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">requiredPermissions</span><span class="p">));</span>
</span><span id="__span-49-17"><a id="__codelineno-49-17" name="__codelineno-49-17" href="#__codelineno-49-17"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">BROADCAST_STICKY_CANT_HAVE_PERMISSION</span><span class="p">;</span>
</span><span id="__span-49-18"><a id="__codelineno-49-18" name="__codelineno-49-18" href="#__codelineno-49-18"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-49-19"><a id="__codelineno-49-19" name="__codelineno-49-19" href="#__codelineno-49-19"></a><span class="w">    </span><span class="c1">//粘性广播不能指定发送到相关组件，否则发出安全异常</span>
</span><span id="__span-49-20"><a id="__codelineno-49-20" name="__codelineno-49-20" href="#__codelineno-49-20"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getComponent</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-49-21"><a id="__codelineno-49-21" name="__codelineno-49-21" href="#__codelineno-49-21"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecurityException</span><span class="p">(</span>
</span><span id="__span-49-22"><a id="__codelineno-49-22" name="__codelineno-49-22" href="#__codelineno-49-22"></a><span class="w">                </span><span class="s">&quot;Sticky broadcasts can&#39;t target a specific component&quot;</span><span class="p">);</span>
</span><span id="__span-49-23"><a id="__codelineno-49-23" name="__codelineno-49-23" href="#__codelineno-49-23"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-49-24"><a id="__codelineno-49-24" name="__codelineno-49-24" href="#__codelineno-49-24"></a><span class="w">    </span><span class="c1">// We use userId directly here, since the &quot;all&quot; target is maintained</span>
</span><span id="__span-49-25"><a id="__codelineno-49-25" name="__codelineno-49-25" href="#__codelineno-49-25"></a><span class="w">    </span><span class="c1">// as a separate set of sticky broadcasts.</span>
</span><span id="__span-49-26"><a id="__codelineno-49-26" name="__codelineno-49-26" href="#__codelineno-49-26"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">userId</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">USER_ALL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-49-27"><a id="__codelineno-49-27" name="__codelineno-49-27" href="#__codelineno-49-27"></a><span class="w">        </span><span class="c1">// But first, if this is not a broadcast to all users, then</span>
</span><span id="__span-49-28"><a id="__codelineno-49-28" name="__codelineno-49-28" href="#__codelineno-49-28"></a><span class="w">        </span><span class="c1">// make sure it doesn&#39;t conflict with an existing broadcast to</span>
</span><span id="__span-49-29"><a id="__codelineno-49-29" name="__codelineno-49-29" href="#__codelineno-49-29"></a><span class="w">        </span><span class="c1">// all users.</span>
</span><span id="__span-49-30"><a id="__codelineno-49-30" name="__codelineno-49-30" href="#__codelineno-49-30"></a><span class="w">        </span><span class="c1">// 校验对于当前的这个对单个user的广播 和现有的针对所有user的广播不冲突</span>
</span><span id="__span-49-31"><a id="__codelineno-49-31" name="__codelineno-49-31" href="#__codelineno-49-31"></a><span class="w">        </span><span class="c1">// 也就是说一个sticky广播不能同时针对单个user又针对user_all</span>
</span><span id="__span-49-32"><a id="__codelineno-49-32" name="__codelineno-49-32" href="#__codelineno-49-32"></a><span class="w">        </span><span class="n">ArrayMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Intent</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">stickies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mStickyBroadcasts</span><span class="p">.</span><span class="na">get</span><span class="p">(</span>
</span><span id="__span-49-33"><a id="__codelineno-49-33" name="__codelineno-49-33" href="#__codelineno-49-33"></a><span class="w">                </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">USER_ALL</span><span class="p">);</span>
</span><span id="__span-49-34"><a id="__codelineno-49-34" name="__codelineno-49-34" href="#__codelineno-49-34"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stickies</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-49-35"><a id="__codelineno-49-35" name="__codelineno-49-35" href="#__codelineno-49-35"></a><span class="w">            </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Intent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stickies</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">());</span>
</span><span id="__span-49-36"><a id="__codelineno-49-36" name="__codelineno-49-36" href="#__codelineno-49-36"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">list</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-49-37"><a id="__codelineno-49-37" name="__codelineno-49-37" href="#__codelineno-49-37"></a><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">list</span><span class="p">.</span><span class="na">size</span><span class="p">();</span>
</span><span id="__span-49-38"><a id="__codelineno-49-38" name="__codelineno-49-38" href="#__codelineno-49-38"></a><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
</span><span id="__span-49-39"><a id="__codelineno-49-39" name="__codelineno-49-39" href="#__codelineno-49-39"></a><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-49-40"><a id="__codelineno-49-40" name="__codelineno-49-40" href="#__codelineno-49-40"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">filterEquals</span><span class="p">(</span><span class="n">list</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-49-41"><a id="__codelineno-49-41" name="__codelineno-49-41" href="#__codelineno-49-41"></a><span class="w">                        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span>
</span><span id="__span-49-42"><a id="__codelineno-49-42" name="__codelineno-49-42" href="#__codelineno-49-42"></a><span class="w">                                </span><span class="s">&quot;Sticky broadcast &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">intent</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; for user &quot;</span>
</span><span id="__span-49-43"><a id="__codelineno-49-43" name="__codelineno-49-43" href="#__codelineno-49-43"></a><span class="w">                                </span><span class="o">+</span><span class="w"> </span><span class="n">userId</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; conflicts with existing global broadcast&quot;</span><span class="p">);</span>
</span><span id="__span-49-44"><a id="__codelineno-49-44" name="__codelineno-49-44" href="#__codelineno-49-44"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-49-45"><a id="__codelineno-49-45" name="__codelineno-49-45" href="#__codelineno-49-45"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-49-46"><a id="__codelineno-49-46" name="__codelineno-49-46" href="#__codelineno-49-46"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-49-47"><a id="__codelineno-49-47" name="__codelineno-49-47" href="#__codelineno-49-47"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-49-48"><a id="__codelineno-49-48" name="__codelineno-49-48" href="#__codelineno-49-48"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-49-49"><a id="__codelineno-49-49" name="__codelineno-49-49" href="#__codelineno-49-49"></a><span class="w">    </span><span class="c1">// 将Sticky广播放入mStickyBroadcasts</span>
</span><span id="__span-49-50"><a id="__codelineno-49-50" name="__codelineno-49-50" href="#__codelineno-49-50"></a><span class="w">    </span><span class="n">ArrayMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Intent</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">stickies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mStickyBroadcasts</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span>
</span><span id="__span-49-51"><a id="__codelineno-49-51" name="__codelineno-49-51" href="#__codelineno-49-51"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stickies</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-49-52"><a id="__codelineno-49-52" name="__codelineno-49-52" href="#__codelineno-49-52"></a><span class="w">        </span><span class="n">stickies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-49-53"><a id="__codelineno-49-53" name="__codelineno-49-53" href="#__codelineno-49-53"></a><span class="w">        </span><span class="n">mStickyBroadcasts</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">stickies</span><span class="p">);</span>
</span><span id="__span-49-54"><a id="__codelineno-49-54" name="__codelineno-49-54" href="#__codelineno-49-54"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-49-55"><a id="__codelineno-49-55" name="__codelineno-49-55" href="#__codelineno-49-55"></a><span class="w">    </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Intent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stickies</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">());</span>
</span><span id="__span-49-56"><a id="__codelineno-49-56" name="__codelineno-49-56" href="#__codelineno-49-56"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">list</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-49-57"><a id="__codelineno-49-57" name="__codelineno-49-57" href="#__codelineno-49-57"></a><span class="w">        </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-49-58"><a id="__codelineno-49-58" name="__codelineno-49-58" href="#__codelineno-49-58"></a><span class="w">        </span><span class="n">stickies</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">(),</span><span class="w"> </span><span class="n">list</span><span class="p">);</span>
</span><span id="__span-49-59"><a id="__codelineno-49-59" name="__codelineno-49-59" href="#__codelineno-49-59"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-49-60"><a id="__codelineno-49-60" name="__codelineno-49-60" href="#__codelineno-49-60"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">stickiesCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">list</span><span class="p">.</span><span class="na">size</span><span class="p">();</span>
</span><span id="__span-49-61"><a id="__codelineno-49-61" name="__codelineno-49-61" href="#__codelineno-49-61"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
</span><span id="__span-49-62"><a id="__codelineno-49-62" name="__codelineno-49-62" href="#__codelineno-49-62"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">stickiesCount</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-49-63"><a id="__codelineno-49-63" name="__codelineno-49-63" href="#__codelineno-49-63"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">filterEquals</span><span class="p">(</span><span class="n">list</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-49-64"><a id="__codelineno-49-64" name="__codelineno-49-64" href="#__codelineno-49-64"></a><span class="w">            </span><span class="c1">// This sticky already exists, replace it.</span>
</span><span id="__span-49-65"><a id="__codelineno-49-65" name="__codelineno-49-65" href="#__codelineno-49-65"></a><span class="w">            </span><span class="c1">// 如果能找到对应的sticky广播，则进行替换</span>
</span><span id="__span-49-66"><a id="__codelineno-49-66" name="__codelineno-49-66" href="#__codelineno-49-66"></a><span class="w">            </span><span class="c1">// 因为sticky广播是在注册者一注册就把最近的u一个发出去了</span>
</span><span id="__span-49-67"><a id="__codelineno-49-67" name="__codelineno-49-67" href="#__codelineno-49-67"></a><span class="w">            </span><span class="c1">// 所以对于同一个sticky广播需要记录下，如果有重复，则替换</span>
</span><span id="__span-49-68"><a id="__codelineno-49-68" name="__codelineno-49-68" href="#__codelineno-49-68"></a><span class="w">            </span><span class="n">list</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Intent</span><span class="p">(</span><span class="n">intent</span><span class="p">));</span>
</span><span id="__span-49-69"><a id="__codelineno-49-69" name="__codelineno-49-69" href="#__codelineno-49-69"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-49-70"><a id="__codelineno-49-70" name="__codelineno-49-70" href="#__codelineno-49-70"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-49-71"><a id="__codelineno-49-71" name="__codelineno-49-71" href="#__codelineno-49-71"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-49-72"><a id="__codelineno-49-72" name="__codelineno-49-72" href="#__codelineno-49-72"></a><span class="w">    </span><span class="c1">//如果上面中途替换过list的intent，则i &lt; stickiesCount</span>
</span><span id="__span-49-73"><a id="__codelineno-49-73" name="__codelineno-49-73" href="#__codelineno-49-73"></a><span class="w">    </span><span class="c1">//而i &gt;= stickiesCount则代表没有替换过</span>
</span><span id="__span-49-74"><a id="__codelineno-49-74" name="__codelineno-49-74" href="#__codelineno-49-74"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">stickiesCount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-49-75"><a id="__codelineno-49-75" name="__codelineno-49-75" href="#__codelineno-49-75"></a><span class="w">        </span><span class="n">list</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Intent</span><span class="p">(</span><span class="n">intent</span><span class="p">));</span>
</span><span id="__span-49-76"><a id="__codelineno-49-76" name="__codelineno-49-76" href="#__codelineno-49-76"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-49-77"><a id="__codelineno-49-77" name="__codelineno-49-77" href="#__codelineno-49-77"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>Sticky广播需要在manifest中声明BROADCAST_STICKY权限</li>
<li>Sticky广播不能有权限要求</li>
<li>Sticky广播不能指定发送到相关组件，否则发出安全异常</li>
<li>Sticky广播不能同时针对单个user又针对user_all</li>
<li>将Sticky广播放入mStickyBroadcasts</li>
</ul>
<p>将粘性广播添加到AMS的mStickyBroadcasts(key是用户组，value是粘性广播列表stickies)中，单个用户组的粘性广播列表stickies(key是action，value是intent)，<strong>后面动态注册的接收者就可以在注册的时候就接收这类粘性广播， 因为系统有保存这类广播。</strong></p>
<h4 id="_31">筛选出静态广播接受者<a class="headerlink" href="#_31" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">users</span><span class="p">;</span>
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">userId</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">USER_ALL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="c1">// 发送广播给全部用户</span>
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a><span class="w">    </span><span class="c1">// Caller wants broadcast to go to all started users.</span>
</span><span id="__span-50-4"><a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a><span class="w">    </span><span class="c1">// 获取所有已启动用户的列表</span>
</span><span id="__span-50-5"><a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a><span class="w">    </span><span class="n">users</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mUserController</span><span class="p">.</span><span class="na">getStartedUserArray</span><span class="p">();</span>
</span><span id="__span-50-6"><a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="c1">// 发送广播给指定用户</span>
</span><span id="__span-50-7"><a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a><span class="w">    </span><span class="c1">// Caller wants broadcast to go to one specific user.</span>
</span><span id="__span-50-8"><a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a><span class="w">    </span><span class="n">users</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="n">userId</span><span class="p">};</span>
</span><span id="__span-50-9"><a id="__codelineno-50-9" name="__codelineno-50-9" href="#__codelineno-50-9"></a><span class="p">}</span>
</span><span id="__span-50-10"><a id="__codelineno-50-10" name="__codelineno-50-10" href="#__codelineno-50-10"></a>
</span><span id="__span-50-11"><a id="__codelineno-50-11" name="__codelineno-50-11" href="#__codelineno-50-11"></a><span class="c1">// Figure out who all will receive this broadcast.</span>
</span><span id="__span-50-12"><a id="__codelineno-50-12" name="__codelineno-50-12" href="#__codelineno-50-12"></a><span class="c1">// 静态广播接受者或者order的动态广播接受者的列表</span>
</span><span id="__span-50-13"><a id="__codelineno-50-13" name="__codelineno-50-13" href="#__codelineno-50-13"></a><span class="n">List</span><span class="w"> </span><span class="n">receivers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-50-14"><a id="__codelineno-50-14" name="__codelineno-50-14" href="#__codelineno-50-14"></a><span class="c1">// 动态广播接受者列表</span>
</span><span id="__span-50-15"><a id="__codelineno-50-15" name="__codelineno-50-15" href="#__codelineno-50-15"></a><span class="n">List</span><span class="o">&lt;</span><span class="n">BroadcastFilter</span><span class="o">&gt;</span><span class="w"> </span><span class="n">registeredReceivers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-50-16"><a id="__codelineno-50-16" name="__codelineno-50-16" href="#__codelineno-50-16"></a><span class="c1">// Need to resolve the intent to interested receivers...</span>
</span><span id="__span-50-17"><a id="__codelineno-50-17" name="__codelineno-50-17" href="#__codelineno-50-17"></a><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">intent</span><span class="p">.</span><span class="na">getFlags</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">FLAG_RECEIVER_REGISTERED_ONLY</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-50-18"><a id="__codelineno-50-18" name="__codelineno-50-18" href="#__codelineno-50-18"></a><span class="w">    </span><span class="c1">//这里就是查询静态广播的地方，通过PMS的mComponentResolver查询得到该intent静态注册的广播接受者</span>
</span><span id="__span-50-19"><a id="__codelineno-50-19" name="__codelineno-50-19" href="#__codelineno-50-19"></a><span class="w">    </span><span class="c1">//同时传入broadcastAllowList过滤是否允许接受者接收</span>
</span><span id="__span-50-20"><a id="__codelineno-50-20" name="__codelineno-50-20" href="#__codelineno-50-20"></a><span class="w">    </span><span class="n">receivers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">collectReceiverComponents</span><span class="p">(</span>
</span><span id="__span-50-21"><a id="__codelineno-50-21" name="__codelineno-50-21" href="#__codelineno-50-21"></a><span class="w">            </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">resolvedType</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">,</span><span class="w"> </span><span class="n">users</span><span class="p">,</span><span class="w"> </span><span class="n">broadcastAllowList</span><span class="p">);</span>
</span><span id="__span-50-22"><a id="__codelineno-50-22" name="__codelineno-50-22" href="#__codelineno-50-22"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>变量receivers为静态广播接受者</li>
<li>collectReceiverComponents()，PMS的mComponentResolver查询得到该intent静态注册的广播接受者</li>
</ul>
<h5 id="collectreceivercomponents">collectReceiverComponents()<a class="headerlink" href="#collectreceivercomponents" title="Permanent link">&para;</a></h5>
<div class="language-java highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="kd">private</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">ResolveInfo</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">collectReceiverComponents</span><span class="p">(</span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">resolvedType</span><span class="p">,</span>
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">callingUid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">users</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">broadcastAllowList</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a><span class="w">    </span><span class="c1">// TODO: come back and remove this assumption to triage all broadcasts</span>
</span><span id="__span-51-4"><a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pmFlags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">STOCK_PM_FLAGS</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MATCH_DEBUG_TRIAGED_MISSING</span><span class="p">;</span>
</span><span id="__span-51-5"><a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a>
</span><span id="__span-51-6"><a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">ResolveInfo</span><span class="o">&gt;</span><span class="w"> </span><span class="n">receivers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-51-7"><a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a><span class="w">    </span><span class="n">HashSet</span><span class="o">&lt;</span><span class="n">ComponentName</span><span class="o">&gt;</span><span class="w"> </span><span class="n">singleUserReceivers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-51-8"><a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">scannedFirstReceivers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-51-9"><a id="__codelineno-51-9" name="__codelineno-51-9" href="#__codelineno-51-9"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">users</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-10"><a id="__codelineno-51-10" name="__codelineno-51-10" href="#__codelineno-51-10"></a><span class="w">        </span><span class="c1">// Skip users that have Shell restrictions</span>
</span><span id="__span-51-11"><a id="__codelineno-51-11" name="__codelineno-51-11" href="#__codelineno-51-11"></a><span class="w">        </span><span class="c1">//如果调用者是shell，而且该user不允许shell调试，则跳过</span>
</span><span id="__span-51-12"><a id="__codelineno-51-12" name="__codelineno-51-12" href="#__codelineno-51-12"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">callingUid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SHELL_UID</span>
</span><span id="__span-51-13"><a id="__codelineno-51-13" name="__codelineno-51-13" href="#__codelineno-51-13"></a><span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mUserController</span><span class="p">.</span><span class="na">hasUserRestriction</span><span class="p">(</span>
</span><span id="__span-51-14"><a id="__codelineno-51-14" name="__codelineno-51-14" href="#__codelineno-51-14"></a><span class="w">                </span><span class="n">UserManager</span><span class="p">.</span><span class="na">DISALLOW_DEBUGGING_FEATURES</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-15"><a id="__codelineno-51-15" name="__codelineno-51-15" href="#__codelineno-51-15"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-51-16"><a id="__codelineno-51-16" name="__codelineno-51-16" href="#__codelineno-51-16"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-51-17"><a id="__codelineno-51-17" name="__codelineno-51-17" href="#__codelineno-51-17"></a><span class="w">        </span><span class="c1">//静态广播通过PMS去查询接收者</span>
</span><span id="__span-51-18"><a id="__codelineno-51-18" name="__codelineno-51-18" href="#__codelineno-51-18"></a><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">ResolveInfo</span><span class="o">&gt;</span><span class="w"> </span><span class="n">newReceivers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mPackageManagerInt</span><span class="p">.</span><span class="na">queryIntentReceivers</span><span class="p">(</span>
</span><span id="__span-51-19"><a id="__codelineno-51-19" name="__codelineno-51-19" href="#__codelineno-51-19"></a><span class="w">                </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">resolvedType</span><span class="p">,</span><span class="w"> </span><span class="n">pmFlags</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="cm">/* forSend */</span><span class="p">);</span>
</span><span id="__span-51-20"><a id="__codelineno-51-20" name="__codelineno-51-20" href="#__codelineno-51-20"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">user</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">USER_SYSTEM</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">newReceivers</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-21"><a id="__codelineno-51-21" name="__codelineno-51-21" href="#__codelineno-51-21"></a><span class="w">            </span><span class="c1">// If this is not the system user, we need to check for</span>
</span><span id="__span-51-22"><a id="__codelineno-51-22" name="__codelineno-51-22" href="#__codelineno-51-22"></a><span class="w">            </span><span class="c1">// any receivers that should be filtered out.</span>
</span><span id="__span-51-23"><a id="__codelineno-51-23" name="__codelineno-51-23" href="#__codelineno-51-23"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">newReceivers</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-24"><a id="__codelineno-51-24" name="__codelineno-51-24" href="#__codelineno-51-24"></a><span class="w">                </span><span class="n">ResolveInfo</span><span class="w"> </span><span class="n">ri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newReceivers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-51-25"><a id="__codelineno-51-25" name="__codelineno-51-25" href="#__codelineno-51-25"></a><span class="w">                </span><span class="c1">//如果取出来的ResolveInfo包含了只允许系统接收的flag(FLAG_SYSTEM_USER_ONLY)，</span>
</span><span id="__span-51-26"><a id="__codelineno-51-26" name="__codelineno-51-26" href="#__codelineno-51-26"></a><span class="w">                </span><span class="c1">//则从筛选出来的列表中移除这个接收者</span>
</span><span id="__span-51-27"><a id="__codelineno-51-27" name="__codelineno-51-27" href="#__codelineno-51-27"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">ri</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ActivityInfo</span><span class="p">.</span><span class="na">FLAG_SYSTEM_USER_ONLY</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-28"><a id="__codelineno-51-28" name="__codelineno-51-28" href="#__codelineno-51-28"></a><span class="w">                    </span><span class="n">newReceivers</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-51-29"><a id="__codelineno-51-29" name="__codelineno-51-29" href="#__codelineno-51-29"></a><span class="w">                    </span><span class="n">i</span><span class="o">--</span><span class="p">;</span>
</span><span id="__span-51-30"><a id="__codelineno-51-30" name="__codelineno-51-30" href="#__codelineno-51-30"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-51-31"><a id="__codelineno-51-31" name="__codelineno-51-31" href="#__codelineno-51-31"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-51-32"><a id="__codelineno-51-32" name="__codelineno-51-32" href="#__codelineno-51-32"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-51-33"><a id="__codelineno-51-33" name="__codelineno-51-33" href="#__codelineno-51-33"></a><span class="w">        </span><span class="c1">// Replace the alias receivers with their targets.</span>
</span><span id="__span-51-34"><a id="__codelineno-51-34" name="__codelineno-51-34" href="#__codelineno-51-34"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newReceivers</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-35"><a id="__codelineno-51-35" name="__codelineno-51-35" href="#__codelineno-51-35"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newReceivers</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-36"><a id="__codelineno-51-36" name="__codelineno-51-36" href="#__codelineno-51-36"></a><span class="w">                </span><span class="kd">final</span><span class="w"> </span><span class="n">ResolveInfo</span><span class="w"> </span><span class="n">ri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newReceivers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-51-37"><a id="__codelineno-51-37" name="__codelineno-51-37" href="#__codelineno-51-37"></a><span class="w">                </span><span class="kd">final</span><span class="w"> </span><span class="n">Resolution</span><span class="o">&lt;</span><span class="n">ResolveInfo</span><span class="o">&gt;</span><span class="w"> </span><span class="n">resolution</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-51-38"><a id="__codelineno-51-38" name="__codelineno-51-38" href="#__codelineno-51-38"></a><span class="w">                        </span><span class="n">mComponentAliasResolver</span><span class="p">.</span><span class="na">resolveReceiver</span><span class="p">(</span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">ri</span><span class="p">,</span><span class="w"> </span><span class="n">resolvedType</span><span class="p">,</span>
</span><span id="__span-51-39"><a id="__codelineno-51-39" name="__codelineno-51-39" href="#__codelineno-51-39"></a><span class="w">                                </span><span class="n">pmFlags</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="cm">/* forSend */</span><span class="p">);</span>
</span><span id="__span-51-40"><a id="__codelineno-51-40" name="__codelineno-51-40" href="#__codelineno-51-40"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">resolution</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-41"><a id="__codelineno-51-41" name="__codelineno-51-41" href="#__codelineno-51-41"></a><span class="w">                    </span><span class="c1">// It was an alias, but the target was not found.</span>
</span><span id="__span-51-42"><a id="__codelineno-51-42" name="__codelineno-51-42" href="#__codelineno-51-42"></a><span class="w">                    </span><span class="n">newReceivers</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-51-43"><a id="__codelineno-51-43" name="__codelineno-51-43" href="#__codelineno-51-43"></a><span class="w">                    </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-51-44"><a id="__codelineno-51-44" name="__codelineno-51-44" href="#__codelineno-51-44"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-51-45"><a id="__codelineno-51-45" name="__codelineno-51-45" href="#__codelineno-51-45"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">resolution</span><span class="p">.</span><span class="na">isAlias</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-46"><a id="__codelineno-51-46" name="__codelineno-51-46" href="#__codelineno-51-46"></a><span class="w">                    </span><span class="n">newReceivers</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">resolution</span><span class="p">.</span><span class="na">getTarget</span><span class="p">());</span>
</span><span id="__span-51-47"><a id="__codelineno-51-47" name="__codelineno-51-47" href="#__codelineno-51-47"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-51-48"><a id="__codelineno-51-48" name="__codelineno-51-48" href="#__codelineno-51-48"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-51-49"><a id="__codelineno-51-49" name="__codelineno-51-49" href="#__codelineno-51-49"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-51-50"><a id="__codelineno-51-50" name="__codelineno-51-50" href="#__codelineno-51-50"></a>
</span><span id="__span-51-51"><a id="__codelineno-51-51" name="__codelineno-51-51" href="#__codelineno-51-51"></a><span class="w">        </span><span class="c1">//如果到目前为止newReceivers(ResolveInfo列表)为null或者空的</span>
</span><span id="__span-51-52"><a id="__codelineno-51-52" name="__codelineno-51-52" href="#__codelineno-51-52"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newReceivers</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">newReceivers</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-53"><a id="__codelineno-51-53" name="__codelineno-51-53" href="#__codelineno-51-53"></a><span class="w">            </span><span class="n">newReceivers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-51-54"><a id="__codelineno-51-54" name="__codelineno-51-54" href="#__codelineno-51-54"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-51-55"><a id="__codelineno-51-55" name="__codelineno-51-55" href="#__codelineno-51-55"></a>
</span><span id="__span-51-56"><a id="__codelineno-51-56" name="__codelineno-51-56" href="#__codelineno-51-56"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">receivers</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-57"><a id="__codelineno-51-57" name="__codelineno-51-57" href="#__codelineno-51-57"></a><span class="w">            </span><span class="c1">//如果receivers(最后返回的结果)为null，则先将newReceivers赋值给receivers</span>
</span><span id="__span-51-58"><a id="__codelineno-51-58" name="__codelineno-51-58" href="#__codelineno-51-58"></a><span class="w">            </span><span class="n">receivers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newReceivers</span><span class="p">;</span>
</span><span id="__span-51-59"><a id="__codelineno-51-59" name="__codelineno-51-59" href="#__codelineno-51-59"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newReceivers</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-60"><a id="__codelineno-51-60" name="__codelineno-51-60" href="#__codelineno-51-60"></a><span class="w">            </span><span class="c1">// We need to concatenate the additional receivers</span>
</span><span id="__span-51-61"><a id="__codelineno-51-61" name="__codelineno-51-61" href="#__codelineno-51-61"></a><span class="w">            </span><span class="c1">// found with what we have do far.  This would be easy,</span>
</span><span id="__span-51-62"><a id="__codelineno-51-62" name="__codelineno-51-62" href="#__codelineno-51-62"></a><span class="w">            </span><span class="c1">// but we also need to de-dup any receivers that are</span>
</span><span id="__span-51-63"><a id="__codelineno-51-63" name="__codelineno-51-63" href="#__codelineno-51-63"></a><span class="w">            </span><span class="c1">// singleUser.</span>
</span><span id="__span-51-64"><a id="__codelineno-51-64" name="__codelineno-51-64" href="#__codelineno-51-64"></a><span class="w">            </span><span class="c1">//scannedFirstReceivers默认是fasle，也就是第一次跑到这段代码会进来，只进来一次</span>
</span><span id="__span-51-65"><a id="__codelineno-51-65" name="__codelineno-51-65" href="#__codelineno-51-65"></a><span class="w">            </span><span class="c1">//receivers此时已经赋值过一次，这里是users第二次和以上循环才可能会进来</span>
</span><span id="__span-51-66"><a id="__codelineno-51-66" name="__codelineno-51-66" href="#__codelineno-51-66"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">scannedFirstReceivers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-67"><a id="__codelineno-51-67" name="__codelineno-51-67" href="#__codelineno-51-67"></a><span class="w">                </span><span class="c1">// Collect any single user receivers we had already retrieved.</span>
</span><span id="__span-51-68"><a id="__codelineno-51-68" name="__codelineno-51-68" href="#__codelineno-51-68"></a><span class="w">                </span><span class="n">scannedFirstReceivers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-51-69"><a id="__codelineno-51-69" name="__codelineno-51-69" href="#__codelineno-51-69"></a><span class="w">                </span><span class="c1">// 遍历之前的receivers(这里receivers没有判空逻辑，只看这段逻辑不太严谨，</span>
</span><span id="__span-51-70"><a id="__codelineno-51-70" name="__codelineno-51-70" href="#__codelineno-51-70"></a><span class="w">                </span><span class="c1">// 没有出错是由于newReceivers有判空)</span>
</span><span id="__span-51-71"><a id="__codelineno-51-71" name="__codelineno-51-71" href="#__codelineno-51-71"></a><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">receivers</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-72"><a id="__codelineno-51-72" name="__codelineno-51-72" href="#__codelineno-51-72"></a><span class="w">                    </span><span class="n">ResolveInfo</span><span class="w"> </span><span class="n">ri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">receivers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-51-73"><a id="__codelineno-51-73" name="__codelineno-51-73" href="#__codelineno-51-73"></a><span class="w">                     </span><span class="c1">//如果接收者包含FLAG_SINGLE_USER的flag</span>
</span><span id="__span-51-74"><a id="__codelineno-51-74" name="__codelineno-51-74" href="#__codelineno-51-74"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">ri</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">flags</span><span class="o">&amp;</span><span class="n">ActivityInfo</span><span class="p">.</span><span class="na">FLAG_SINGLE_USER</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-75"><a id="__codelineno-51-75" name="__codelineno-51-75" href="#__codelineno-51-75"></a><span class="w">                        </span><span class="n">ComponentName</span><span class="w"> </span><span class="n">cn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ComponentName</span><span class="p">(</span>
</span><span id="__span-51-76"><a id="__codelineno-51-76" name="__codelineno-51-76" href="#__codelineno-51-76"></a><span class="w">                                </span><span class="n">ri</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">packageName</span><span class="p">,</span><span class="w"> </span><span class="n">ri</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">name</span><span class="p">);</span>
</span><span id="__span-51-77"><a id="__codelineno-51-77" name="__codelineno-51-77" href="#__codelineno-51-77"></a><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">singleUserReceivers</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-78"><a id="__codelineno-51-78" name="__codelineno-51-78" href="#__codelineno-51-78"></a><span class="w">                            </span><span class="n">singleUserReceivers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;</span><span class="n">ComponentName</span><span class="o">&gt;</span><span class="p">();</span>
</span><span id="__span-51-79"><a id="__codelineno-51-79" name="__codelineno-51-79" href="#__codelineno-51-79"></a><span class="w">                        </span><span class="p">}</span>
</span><span id="__span-51-80"><a id="__codelineno-51-80" name="__codelineno-51-80" href="#__codelineno-51-80"></a><span class="w">                        </span><span class="c1">//则把这类组件add到singleUserReceivers中</span>
</span><span id="__span-51-81"><a id="__codelineno-51-81" name="__codelineno-51-81" href="#__codelineno-51-81"></a><span class="w">                        </span><span class="n">singleUserReceivers</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">cn</span><span class="p">);</span>
</span><span id="__span-51-82"><a id="__codelineno-51-82" name="__codelineno-51-82" href="#__codelineno-51-82"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-51-83"><a id="__codelineno-51-83" name="__codelineno-51-83" href="#__codelineno-51-83"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-51-84"><a id="__codelineno-51-84" name="__codelineno-51-84" href="#__codelineno-51-84"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-51-85"><a id="__codelineno-51-85" name="__codelineno-51-85" href="#__codelineno-51-85"></a><span class="w">            </span><span class="c1">// Add the new results to the existing results, tracking</span>
</span><span id="__span-51-86"><a id="__codelineno-51-86" name="__codelineno-51-86" href="#__codelineno-51-86"></a><span class="w">            </span><span class="c1">// and de-dupping single user receivers.</span>
</span><span id="__span-51-87"><a id="__codelineno-51-87" name="__codelineno-51-87" href="#__codelineno-51-87"></a><span class="w">            </span><span class="c1">// 遍历新的users中获取的newReceivers</span>
</span><span id="__span-51-88"><a id="__codelineno-51-88" name="__codelineno-51-88" href="#__codelineno-51-88"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">newReceivers</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-89"><a id="__codelineno-51-89" name="__codelineno-51-89" href="#__codelineno-51-89"></a><span class="w">                </span><span class="n">ResolveInfo</span><span class="w"> </span><span class="n">ri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newReceivers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-51-90"><a id="__codelineno-51-90" name="__codelineno-51-90" href="#__codelineno-51-90"></a><span class="w">                </span><span class="c1">//如果也是带有FLAG_SINGLE_USER的flag，只发送给单个user</span>
</span><span id="__span-51-91"><a id="__codelineno-51-91" name="__codelineno-51-91" href="#__codelineno-51-91"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">ri</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ActivityInfo</span><span class="p">.</span><span class="na">FLAG_SINGLE_USER</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-92"><a id="__codelineno-51-92" name="__codelineno-51-92" href="#__codelineno-51-92"></a><span class="w">                    </span><span class="n">ComponentName</span><span class="w"> </span><span class="n">cn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ComponentName</span><span class="p">(</span>
</span><span id="__span-51-93"><a id="__codelineno-51-93" name="__codelineno-51-93" href="#__codelineno-51-93"></a><span class="w">                            </span><span class="n">ri</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">packageName</span><span class="p">,</span><span class="w"> </span><span class="n">ri</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">name</span><span class="p">);</span>
</span><span id="__span-51-94"><a id="__codelineno-51-94" name="__codelineno-51-94" href="#__codelineno-51-94"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">singleUserReceivers</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-95"><a id="__codelineno-51-95" name="__codelineno-51-95" href="#__codelineno-51-95"></a><span class="w">                        </span><span class="n">singleUserReceivers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;</span><span class="n">ComponentName</span><span class="o">&gt;</span><span class="p">();</span>
</span><span id="__span-51-96"><a id="__codelineno-51-96" name="__codelineno-51-96" href="#__codelineno-51-96"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-51-97"><a id="__codelineno-51-97" name="__codelineno-51-97" href="#__codelineno-51-97"></a><span class="w">                    </span><span class="c1">//如果之前还没有添加过，才进行receivers添加</span>
</span><span id="__span-51-98"><a id="__codelineno-51-98" name="__codelineno-51-98" href="#__codelineno-51-98"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">singleUserReceivers</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">cn</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-99"><a id="__codelineno-51-99" name="__codelineno-51-99" href="#__codelineno-51-99"></a><span class="w">                        </span><span class="c1">//而且将单个用户接受者ComponentName cn添加到ComponentName中</span>
</span><span id="__span-51-100"><a id="__codelineno-51-100" name="__codelineno-51-100" href="#__codelineno-51-100"></a><span class="w">                        </span><span class="n">singleUserReceivers</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">cn</span><span class="p">);</span>
</span><span id="__span-51-101"><a id="__codelineno-51-101" name="__codelineno-51-101" href="#__codelineno-51-101"></a><span class="w">                        </span><span class="n">receivers</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">ri</span><span class="p">);</span>
</span><span id="__span-51-102"><a id="__codelineno-51-102" name="__codelineno-51-102" href="#__codelineno-51-102"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-51-103"><a id="__codelineno-51-103" name="__codelineno-51-103" href="#__codelineno-51-103"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-104"><a id="__codelineno-51-104" name="__codelineno-51-104" href="#__codelineno-51-104"></a><span class="w">                    </span><span class="c1">//其它情况则直接加入该接收者到receivers</span>
</span><span id="__span-51-105"><a id="__codelineno-51-105" name="__codelineno-51-105" href="#__codelineno-51-105"></a><span class="w">                    </span><span class="n">receivers</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">ri</span><span class="p">);</span>
</span><span id="__span-51-106"><a id="__codelineno-51-106" name="__codelineno-51-106" href="#__codelineno-51-106"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-51-107"><a id="__codelineno-51-107" name="__codelineno-51-107" href="#__codelineno-51-107"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-51-108"><a id="__codelineno-51-108" name="__codelineno-51-108" href="#__codelineno-51-108"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-51-109"><a id="__codelineno-51-109" name="__codelineno-51-109" href="#__codelineno-51-109"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-51-110"><a id="__codelineno-51-110" name="__codelineno-51-110" href="#__codelineno-51-110"></a><span class="w">    </span><span class="c1">//如果带有broadcastAllowList，允许接收该广播uid的列表</span>
</span><span id="__span-51-111"><a id="__codelineno-51-111" name="__codelineno-51-111" href="#__codelineno-51-111"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">receivers</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">broadcastAllowList</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-112"><a id="__codelineno-51-112" name="__codelineno-51-112" href="#__codelineno-51-112"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">receivers</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-113"><a id="__codelineno-51-113" name="__codelineno-51-113" href="#__codelineno-51-113"></a><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">receiverAppId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">getAppId</span><span class="p">(</span>
</span><span id="__span-51-114"><a id="__codelineno-51-114" name="__codelineno-51-114" href="#__codelineno-51-114"></a><span class="w">                    </span><span class="n">receivers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">);</span>
</span><span id="__span-51-115"><a id="__codelineno-51-115" name="__codelineno-51-115" href="#__codelineno-51-115"></a><span class="w">            </span><span class="c1">//接受者的uid如果是app进程，而且不在允许接收该广播uid的列表，则移除查询到的接收者</span>
</span><span id="__span-51-116"><a id="__codelineno-51-116" name="__codelineno-51-116" href="#__codelineno-51-116"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">receiverAppId</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">Process</span><span class="p">.</span><span class="na">FIRST_APPLICATION_UID</span>
</span><span id="__span-51-117"><a id="__codelineno-51-117" name="__codelineno-51-117" href="#__codelineno-51-117"></a><span class="w">                    </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">Arrays</span><span class="p">.</span><span class="na">binarySearch</span><span class="p">(</span><span class="n">broadcastAllowList</span><span class="p">,</span><span class="w"> </span><span class="n">receiverAppId</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-118"><a id="__codelineno-51-118" name="__codelineno-51-118" href="#__codelineno-51-118"></a><span class="w">                </span><span class="n">receivers</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-51-119"><a id="__codelineno-51-119" name="__codelineno-51-119" href="#__codelineno-51-119"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-51-120"><a id="__codelineno-51-120" name="__codelineno-51-120" href="#__codelineno-51-120"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-51-121"><a id="__codelineno-51-121" name="__codelineno-51-121" href="#__codelineno-51-121"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-51-122"><a id="__codelineno-51-122" name="__codelineno-51-122" href="#__codelineno-51-122"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">receivers</span><span class="p">;</span>
</span><span id="__span-51-123"><a id="__codelineno-51-123" name="__codelineno-51-123" href="#__codelineno-51-123"></a><span class="p">}</span><span class="w">   </span>
</span></code></pre></div>
<h5 id="packagemanagerservicequeryintentreceivers">PackageManagerService.queryIntentReceivers<a class="headerlink" href="#packagemanagerservicequeryintentreceivers" title="Permanent link">&para;</a></h5>
<div class="language-java highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="n">PackageManagerService</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a>
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a><span class="kd">public</span><span class="w"> </span><span class="nd">@NonNull</span><span class="w"> </span><span class="n">ParceledListSlice</span><span class="o">&lt;</span><span class="n">ResolveInfo</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">queryIntentReceivers</span><span class="p">(</span><span class="nd">@NonNull</span><span class="w"> </span><span class="n">Computer</span><span class="w"> </span><span class="n">snapshot</span><span class="p">,</span>
</span><span id="__span-52-4"><a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a><span class="w">        </span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">resolvedType</span><span class="p">,</span><span class="w"> </span><span class="nd">@PackageManager.ResolveInfoFlagsBits</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span>
</span><span id="__span-52-5"><a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a><span class="w">        </span><span class="nd">@UserIdInt</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-52-6"><a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ParceledListSlice</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">mResolveIntentHelper</span><span class="p">.</span><span class="na">queryIntentReceiversInternal</span><span class="p">(</span>
</span><span id="__span-52-7"><a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a><span class="w">            </span><span class="n">snapshot</span><span class="p">,</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">resolvedType</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">Binder</span><span class="p">.</span><span class="na">getCallingUid</span><span class="p">()));</span>
</span><span id="__span-52-8"><a id="__codelineno-52-8" name="__codelineno-52-8" href="#__codelineno-52-8"></a><span class="p">}</span>
</span></code></pre></div>
<p>进入PMS的逻辑就不在详细阐述，最终获取之前在静态广播注册时存在PMS的成员变量mComponentResolver，从而拿到静态注册广播的receivers。</p>
<h4 id="_32">筛选出动态广播接收者<a class="headerlink" href="#_32" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getComponent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">PackageDataSnapshot</span><span class="w"> </span><span class="n">snapshot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getPackageManagerInternal</span><span class="p">().</span><span class="na">snapshot</span><span class="p">();</span>
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">userId</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">USER_ALL</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">callingUid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SHELL_UID</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-53-4"><a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a><span class="w">        </span><span class="c1">// Query one target user at a time, excluding shell-restricted users</span>
</span><span id="__span-53-5"><a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a><span class="w">        </span><span class="c1">//对于shell发送的user_all的广播</span>
</span><span id="__span-53-6"><a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">users</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-53-7"><a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mUserController</span><span class="p">.</span><span class="na">hasUserRestriction</span><span class="p">(</span>
</span><span id="__span-53-8"><a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a><span class="w">                    </span><span class="n">UserManager</span><span class="p">.</span><span class="na">DISALLOW_DEBUGGING_FEATURES</span><span class="p">,</span><span class="w"> </span><span class="n">users</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-53-9"><a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a><span class="w">                </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-53-10"><a id="__codelineno-53-10" name="__codelineno-53-10" href="#__codelineno-53-10"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-53-11"><a id="__codelineno-53-11" name="__codelineno-53-11" href="#__codelineno-53-11"></a><span class="w">            </span><span class="n">List</span><span class="o">&lt;</span><span class="n">BroadcastFilter</span><span class="o">&gt;</span><span class="w"> </span><span class="n">registeredReceiversForUser</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-53-12"><a id="__codelineno-53-12" name="__codelineno-53-12" href="#__codelineno-53-12"></a><span class="w">                    </span><span class="n">mReceiverResolver</span><span class="p">.</span><span class="na">queryIntent</span><span class="p">(</span><span class="n">snapshot</span><span class="p">,</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span>
</span><span id="__span-53-13"><a id="__codelineno-53-13" name="__codelineno-53-13" href="#__codelineno-53-13"></a><span class="w">                            </span><span class="n">resolvedType</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="cm">/*defaultOnly*/</span><span class="p">,</span><span class="w"> </span><span class="n">users</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">);</span>
</span><span id="__span-53-14"><a id="__codelineno-53-14" name="__codelineno-53-14" href="#__codelineno-53-14"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">registeredReceivers</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-53-15"><a id="__codelineno-53-15" name="__codelineno-53-15" href="#__codelineno-53-15"></a><span class="w">                </span><span class="n">registeredReceivers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">registeredReceiversForUser</span><span class="p">;</span>
</span><span id="__span-53-16"><a id="__codelineno-53-16" name="__codelineno-53-16" href="#__codelineno-53-16"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">registeredReceiversForUser</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-53-17"><a id="__codelineno-53-17" name="__codelineno-53-17" href="#__codelineno-53-17"></a><span class="w">                </span><span class="n">registeredReceivers</span><span class="p">.</span><span class="na">addAll</span><span class="p">(</span><span class="n">registeredReceiversForUser</span><span class="p">);</span>
</span><span id="__span-53-18"><a id="__codelineno-53-18" name="__codelineno-53-18" href="#__codelineno-53-18"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-53-19"><a id="__codelineno-53-19" name="__codelineno-53-19" href="#__codelineno-53-19"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-53-20"><a id="__codelineno-53-20" name="__codelineno-53-20" href="#__codelineno-53-20"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-53-21"><a id="__codelineno-53-21" name="__codelineno-53-21" href="#__codelineno-53-21"></a><span class="w">        </span><span class="c1">//一般情况我们走的这里，直接从mReceiverResolver查询动态接受者赋值给registeredReceivers</span>
</span><span id="__span-53-22"><a id="__codelineno-53-22" name="__codelineno-53-22" href="#__codelineno-53-22"></a><span class="w">        </span><span class="n">registeredReceivers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mReceiverResolver</span><span class="p">.</span><span class="na">queryIntent</span><span class="p">(</span><span class="n">snapshot</span><span class="p">,</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span>
</span><span id="__span-53-23"><a id="__codelineno-53-23" name="__codelineno-53-23" href="#__codelineno-53-23"></a><span class="w">                </span><span class="n">resolvedType</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="cm">/*defaultOnly*/</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">);</span>
</span><span id="__span-53-24"><a id="__codelineno-53-24" name="__codelineno-53-24" href="#__codelineno-53-24"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-53-25"><a id="__codelineno-53-25" name="__codelineno-53-25" href="#__codelineno-53-25"></a><span class="p">}</span>
</span></code></pre></div>
<p>mReceiverResolver查询动态接受者赋值给registeredReceivers。</p>
<h4 id="_33">无序广播<a class="headerlink" href="#_33" title="Permanent link">&para;</a></h4>
<p>如果没有设置ordered按顺序，则针对动态注册类型的广播会一次性全部发送出去。</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="c1">// 如果带有FLAG_RECEIVER_REPLACE_PENDING</span>
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a><span class="c1">// 表示如果这个广播还没有派发，则替换掉之前的广播</span>
</span><span id="__span-54-3"><a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">replacePending</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-54-4"><a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a><span class="w">        </span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getFlags</span><span class="p">()</span><span class="o">&amp;</span><span class="n">Intent</span><span class="p">.</span><span class="na">FLAG_RECEIVER_REPLACE_PENDING</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-54-5"><a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a>
</span><span id="__span-54-6"><a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Enqueueing broadcast: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">()</span>
</span><span id="__span-54-7"><a id="__codelineno-54-7" name="__codelineno-54-7" href="#__codelineno-54-7"></a><span class="w">        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; replacePending=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">replacePending</span><span class="p">);</span>
</span><span id="__span-54-8"><a id="__codelineno-54-8" name="__codelineno-54-8" href="#__codelineno-54-8"></a><span class="c1">// 动态注册查询的时候没有传入broadcastAllowList(允许接收的uid列表)</span>
</span><span id="__span-54-9"><a id="__codelineno-54-9" name="__codelineno-54-9" href="#__codelineno-54-9"></a><span class="c1">// 此处会根据broadcastAllowList(不为null才会过滤)来进行动态注册接收者的过滤</span>
</span><span id="__span-54-10"><a id="__codelineno-54-10" name="__codelineno-54-10" href="#__codelineno-54-10"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">registeredReceivers</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">broadcastAllowList</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-11"><a id="__codelineno-54-11" name="__codelineno-54-11" href="#__codelineno-54-11"></a><span class="w">    </span><span class="c1">// if a uid whitelist was provided, remove anything in the application space that wasn&#39;t</span>
</span><span id="__span-54-12"><a id="__codelineno-54-12" name="__codelineno-54-12" href="#__codelineno-54-12"></a><span class="w">    </span><span class="c1">// in it.</span>
</span><span id="__span-54-13"><a id="__codelineno-54-13" name="__codelineno-54-13" href="#__codelineno-54-13"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">registeredReceivers</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-14"><a id="__codelineno-54-14" name="__codelineno-54-14" href="#__codelineno-54-14"></a><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">owningAppId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">getAppId</span><span class="p">(</span><span class="n">registeredReceivers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="na">owningUid</span><span class="p">);</span>
</span><span id="__span-54-15"><a id="__codelineno-54-15" name="__codelineno-54-15" href="#__codelineno-54-15"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">owningAppId</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">Process</span><span class="p">.</span><span class="na">FIRST_APPLICATION_UID</span>
</span><span id="__span-54-16"><a id="__codelineno-54-16" name="__codelineno-54-16" href="#__codelineno-54-16"></a><span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">Arrays</span><span class="p">.</span><span class="na">binarySearch</span><span class="p">(</span><span class="n">broadcastAllowList</span><span class="p">,</span><span class="w"> </span><span class="n">owningAppId</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-17"><a id="__codelineno-54-17" name="__codelineno-54-17" href="#__codelineno-54-17"></a><span class="w">            </span><span class="n">registeredReceivers</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-54-18"><a id="__codelineno-54-18" name="__codelineno-54-18" href="#__codelineno-54-18"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-54-19"><a id="__codelineno-54-19" name="__codelineno-54-19" href="#__codelineno-54-19"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-54-20"><a id="__codelineno-54-20" name="__codelineno-54-20" href="#__codelineno-54-20"></a><span class="p">}</span>
</span><span id="__span-54-21"><a id="__codelineno-54-21" name="__codelineno-54-21" href="#__codelineno-54-21"></a><span class="c1">// 动态注册的广播接收者个数</span>
</span><span id="__span-54-22"><a id="__codelineno-54-22" name="__codelineno-54-22" href="#__codelineno-54-22"></a><span class="kt">int</span><span class="w"> </span><span class="n">NR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">registeredReceivers</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">registeredReceivers</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-54-23"><a id="__codelineno-54-23" name="__codelineno-54-23" href="#__codelineno-54-23"></a><span class="c1">// 先处理动态注册接收者的逻辑，如果该广播是非ordered(也就是无序广播)，则进入里面</span>
</span><span id="__span-54-24"><a id="__codelineno-54-24" name="__codelineno-54-24" href="#__codelineno-54-24"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ordered</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">NR</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-25"><a id="__codelineno-54-25" name="__codelineno-54-25" href="#__codelineno-54-25"></a><span class="w">    </span><span class="c1">// If we are not serializing this broadcast, then send the</span>
</span><span id="__span-54-26"><a id="__codelineno-54-26" name="__codelineno-54-26" href="#__codelineno-54-26"></a><span class="w">    </span><span class="c1">// registered receivers separately so they don&#39;t wait for the</span>
</span><span id="__span-54-27"><a id="__codelineno-54-27" name="__codelineno-54-27" href="#__codelineno-54-27"></a><span class="w">    </span><span class="c1">// components to be launched.</span>
</span><span id="__span-54-28"><a id="__codelineno-54-28" name="__codelineno-54-28" href="#__codelineno-54-28"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isCallerSystem</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-29"><a id="__codelineno-54-29" name="__codelineno-54-29" href="#__codelineno-54-29"></a><span class="w">        </span><span class="c1">// 对于系统发送的广播进行校验</span>
</span><span id="__span-54-30"><a id="__codelineno-54-30" name="__codelineno-54-30" href="#__codelineno-54-30"></a><span class="w">        </span><span class="n">checkBroadcastFromSystem</span><span class="p">(</span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">callerApp</span><span class="p">,</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">,</span>
</span><span id="__span-54-31"><a id="__codelineno-54-31" name="__codelineno-54-31" href="#__codelineno-54-31"></a><span class="w">                </span><span class="n">isProtectedBroadcast</span><span class="p">,</span><span class="w"> </span><span class="n">registeredReceivers</span><span class="p">);</span>
</span><span id="__span-54-32"><a id="__codelineno-54-32" name="__codelineno-54-32" href="#__codelineno-54-32"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-54-33"><a id="__codelineno-54-33" name="__codelineno-54-33" href="#__codelineno-54-33"></a><span class="w">    </span><span class="c1">//根据intent查找对应的广播队列</span>
</span><span id="__span-54-34"><a id="__codelineno-54-34" name="__codelineno-54-34" href="#__codelineno-54-34"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">BroadcastQueue</span><span class="w"> </span><span class="n">queue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">broadcastQueueForIntent</span><span class="p">(</span><span class="n">intent</span><span class="p">);</span>
</span><span id="__span-54-35"><a id="__codelineno-54-35" name="__codelineno-54-35" href="#__codelineno-54-35"></a><span class="w">    </span><span class="c1">//创建BroadcastRecord对象并将当前所有通过动态注册的广播接收者传进去</span>
</span><span id="__span-54-36"><a id="__codelineno-54-36" name="__codelineno-54-36" href="#__codelineno-54-36"></a><span class="w">    </span><span class="n">BroadcastRecord</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">callerApp</span><span class="p">,</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">,</span>
</span><span id="__span-54-37"><a id="__codelineno-54-37" name="__codelineno-54-37" href="#__codelineno-54-37"></a><span class="w">            </span><span class="n">callerFeatureId</span><span class="p">,</span><span class="w"> </span><span class="n">callingPid</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">,</span><span class="w"> </span><span class="n">callerInstantApp</span><span class="p">,</span><span class="w"> </span><span class="n">resolvedType</span><span class="p">,</span>
</span><span id="__span-54-38"><a id="__codelineno-54-38" name="__codelineno-54-38" href="#__codelineno-54-38"></a><span class="w">            </span><span class="n">requiredPermissions</span><span class="p">,</span><span class="w"> </span><span class="n">excludedPermissions</span><span class="p">,</span><span class="w"> </span><span class="n">excludedPackages</span><span class="p">,</span><span class="w"> </span><span class="n">appOp</span><span class="p">,</span><span class="w"> </span><span class="n">brOptions</span><span class="p">,</span>
</span><span id="__span-54-39"><a id="__codelineno-54-39" name="__codelineno-54-39" href="#__codelineno-54-39"></a><span class="w">            </span><span class="n">registeredReceivers</span><span class="p">,</span><span class="w"> </span><span class="n">resultTo</span><span class="p">,</span><span class="w"> </span><span class="n">resultCode</span><span class="p">,</span><span class="w"> </span><span class="n">resultData</span><span class="p">,</span><span class="w"> </span><span class="n">resultExtras</span><span class="p">,</span><span class="w"> </span><span class="n">ordered</span><span class="p">,</span>
</span><span id="__span-54-40"><a id="__codelineno-54-40" name="__codelineno-54-40" href="#__codelineno-54-40"></a><span class="w">            </span><span class="n">sticky</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">allowBackgroundActivityStarts</span><span class="p">,</span>
</span><span id="__span-54-41"><a id="__codelineno-54-41" name="__codelineno-54-41" href="#__codelineno-54-41"></a><span class="w">            </span><span class="n">backgroundActivityStartsToken</span><span class="p">,</span><span class="w"> </span><span class="n">timeoutExempt</span><span class="p">);</span>
</span><span id="__span-54-42"><a id="__codelineno-54-42" name="__codelineno-54-42" href="#__codelineno-54-42"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Enqueueing parallel broadcast &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-54-43"><a id="__codelineno-54-43" name="__codelineno-54-43" href="#__codelineno-54-43"></a><span class="w">    </span><span class="c1">// 在BroadcastQueue中等待发送广播中搜索是否有相同的BroadcastRecord并且是否替换</span>
</span><span id="__span-54-44"><a id="__codelineno-54-44" name="__codelineno-54-44" href="#__codelineno-54-44"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">replaced</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">replacePending</span>
</span><span id="__span-54-45"><a id="__codelineno-54-45" name="__codelineno-54-45" href="#__codelineno-54-45"></a><span class="w">            </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">queue</span><span class="p">.</span><span class="na">replaceParallelBroadcastLocked</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
</span><span id="__span-54-46"><a id="__codelineno-54-46" name="__codelineno-54-46" href="#__codelineno-54-46"></a><span class="w">    </span><span class="c1">// Note: We assume resultTo is null for non-ordered broadcasts.</span>
</span><span id="__span-54-47"><a id="__codelineno-54-47" name="__codelineno-54-47" href="#__codelineno-54-47"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">replaced</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-48"><a id="__codelineno-54-48" name="__codelineno-54-48" href="#__codelineno-54-48"></a><span class="w">        </span><span class="c1">// 如果不需要替换则插入到BroadcastQueue中</span>
</span><span id="__span-54-49"><a id="__codelineno-54-49" name="__codelineno-54-49" href="#__codelineno-54-49"></a><span class="w">        </span><span class="c1">// 也就是说动态广播接收者都放在了BroadcastQueue的mParallelBroadcasts中</span>
</span><span id="__span-54-50"><a id="__codelineno-54-50" name="__codelineno-54-50" href="#__codelineno-54-50"></a><span class="w">        </span><span class="n">queue</span><span class="p">.</span><span class="na">enqueueParallelBroadcastLocked</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-54-51"><a id="__codelineno-54-51" name="__codelineno-54-51" href="#__codelineno-54-51"></a><span class="w">        </span><span class="c1">//并推动一次广播发送</span>
</span><span id="__span-54-52"><a id="__codelineno-54-52" name="__codelineno-54-52" href="#__codelineno-54-52"></a><span class="w">        </span><span class="n">queue</span><span class="p">.</span><span class="na">scheduleBroadcastsLocked</span><span class="p">();</span>
</span><span id="__span-54-53"><a id="__codelineno-54-53" name="__codelineno-54-53" href="#__codelineno-54-53"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-54-54"><a id="__codelineno-54-54" name="__codelineno-54-54" href="#__codelineno-54-54"></a><span class="w">    </span><span class="c1">//清空动态接收者，已经处理过了</span>
</span><span id="__span-54-55"><a id="__codelineno-54-55" name="__codelineno-54-55" href="#__codelineno-54-55"></a><span class="w">    </span><span class="n">registeredReceivers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-54-56"><a id="__codelineno-54-56" name="__codelineno-54-56" href="#__codelineno-54-56"></a><span class="w">    </span><span class="n">NR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-54-57"><a id="__codelineno-54-57" name="__codelineno-54-57" href="#__codelineno-54-57"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>根据intent查找对应的广播队列</li>
<li>创建BroadcastRecord对象并将当前所有通过动态注册的广播接收者传进去</li>
<li>调用enqueueParallelBroadcastLocked()，将动态广播接收者放在了BroadcastQueue的mParallelBroadcasts中</li>
<li>调用scheduleBroadcastsLocked()发送广播</li>
</ul>
<h4 id="_34">有序广播<a class="headerlink" href="#_34" title="Permanent link">&para;</a></h4>
<p>如果说【动态注册且接受无序广播的广播接收者】是并行操作，那么【动态注册接受有序广播的广播接收者】和【静态注册的广播接收者】接受广播的最大特点就是串行</p>
<p>如果是有序广播，动态接收者和静态的接收者合并到一个队列里面进行处理，也就是说order广播下，所有的接收者（静态和动态）处理方式都是一样的（后面会分析到，都是串行化处理的）。</p>
<p>还有就是对于静态注册的接收者而言，始终是和order广播的处理方式是一样的，也就是说静态的接收者只有order模式（串行化接收）。在合并过程中，如果一个动态注册的广播接收者和一个静态注册的目标广播接收者的优先级相同，那么动态注册的目标接收者会排在静态注册的目标广播接收者前面，即动态注册的目标广播接收者会优先于静态注册的广播接收者接受有序广播。</p>
<ul>
<li>无序 ---&gt; registeredReceivers</li>
</ul>
<p>动态注册 + 无序 ---&gt; registeredReceivers</p>
<ul>
<li>
<p>有序 ---&gt; receivers</p>
</li>
<li>
<p>动态注册 + 有序</p>
</li>
<li>静态注册( 有序 + 无序 )</li>
</ul>
<div class="language-java highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="c1">// Merge into one list.</span>
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="kt">int</span><span class="w"> </span><span class="n">ir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a><span class="c1">//处理静态接收者</span>
</span><span id="__span-55-4"><a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">receivers</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-55-5"><a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a><span class="w">    </span><span class="c1">// A special case for PACKAGE_ADDED: do not allow the package</span>
</span><span id="__span-55-6"><a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a><span class="w">    </span><span class="c1">// being added to see this broadcast.  This prevents them from</span>
</span><span id="__span-55-7"><a id="__codelineno-55-7" name="__codelineno-55-7" href="#__codelineno-55-7"></a><span class="w">    </span><span class="c1">// using this as a back door to get run as soon as they are</span>
</span><span id="__span-55-8"><a id="__codelineno-55-8" name="__codelineno-55-8" href="#__codelineno-55-8"></a><span class="w">    </span><span class="c1">// installed.  Maybe in the future we want to have a special install</span>
</span><span id="__span-55-9"><a id="__codelineno-55-9" name="__codelineno-55-9" href="#__codelineno-55-9"></a><span class="w">    </span><span class="c1">// broadcast or such for apps, but we&#39;d like to deliberately make</span>
</span><span id="__span-55-10"><a id="__codelineno-55-10" name="__codelineno-55-10" href="#__codelineno-55-10"></a><span class="w">    </span><span class="c1">// this decision.</span>
</span><span id="__span-55-11"><a id="__codelineno-55-11" name="__codelineno-55-11" href="#__codelineno-55-11"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">skipPackages</span><span class="o">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-55-12"><a id="__codelineno-55-12" name="__codelineno-55-12" href="#__codelineno-55-12"></a><span class="w">    </span><span class="c1">//针对ACTION_PACKAGE_ADDED/ACTION_PACKAGE_RESTARTED/ACTION_PACKAGE_DATA_CLEARED</span>
</span><span id="__span-55-13"><a id="__codelineno-55-13" name="__codelineno-55-13" href="#__codelineno-55-13"></a><span class="w">    </span><span class="c1">//这类广播不允许被安装的package接收(自己接收自己安装的广播不允许)，防止自启</span>
</span><span id="__span-55-14"><a id="__codelineno-55-14" name="__codelineno-55-14" href="#__codelineno-55-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_PACKAGE_ADDED</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">())</span>
</span><span id="__span-55-15"><a id="__codelineno-55-15" name="__codelineno-55-15" href="#__codelineno-55-15"></a><span class="w">            </span><span class="o">||</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_PACKAGE_RESTARTED</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">())</span>
</span><span id="__span-55-16"><a id="__codelineno-55-16" name="__codelineno-55-16" href="#__codelineno-55-16"></a><span class="w">            </span><span class="o">||</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_PACKAGE_DATA_CLEARED</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-55-17"><a id="__codelineno-55-17" name="__codelineno-55-17" href="#__codelineno-55-17"></a><span class="w">        </span><span class="n">Uri</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getData</span><span class="p">();</span>
</span><span id="__span-55-18"><a id="__codelineno-55-18" name="__codelineno-55-18" href="#__codelineno-55-18"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-55-19"><a id="__codelineno-55-19" name="__codelineno-55-19" href="#__codelineno-55-19"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">pkgName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="na">getSchemeSpecificPart</span><span class="p">();</span>
</span><span id="__span-55-20"><a id="__codelineno-55-20" name="__codelineno-55-20" href="#__codelineno-55-20"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pkgName</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-55-21"><a id="__codelineno-55-21" name="__codelineno-55-21" href="#__codelineno-55-21"></a><span class="w">                </span><span class="n">skipPackages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">pkgName</span><span class="w"> </span><span class="p">};</span>
</span><span id="__span-55-22"><a id="__codelineno-55-22" name="__codelineno-55-22" href="#__codelineno-55-22"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-55-23"><a id="__codelineno-55-23" name="__codelineno-55-23" href="#__codelineno-55-23"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-55-24"><a id="__codelineno-55-24" name="__codelineno-55-24" href="#__codelineno-55-24"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_EXTERNAL_APPLICATIONS_AVAILABLE</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-55-25"><a id="__codelineno-55-25" name="__codelineno-55-25" href="#__codelineno-55-25"></a><span class="w">        </span><span class="n">skipPackages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getStringArrayExtra</span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="na">EXTRA_CHANGED_PACKAGE_LIST</span><span class="p">);</span>
</span><span id="__span-55-26"><a id="__codelineno-55-26" name="__codelineno-55-26" href="#__codelineno-55-26"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-55-27"><a id="__codelineno-55-27" name="__codelineno-55-27" href="#__codelineno-55-27"></a><span class="w">    </span><span class="c1">//将跳过的packageName从receivers中移除</span>
</span><span id="__span-55-28"><a id="__codelineno-55-28" name="__codelineno-55-28" href="#__codelineno-55-28"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">skipPackages</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">skipPackages</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-55-29"><a id="__codelineno-55-29" name="__codelineno-55-29" href="#__codelineno-55-29"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">skipPackage</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">skipPackages</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-55-30"><a id="__codelineno-55-30" name="__codelineno-55-30" href="#__codelineno-55-30"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">skipPackage</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-55-31"><a id="__codelineno-55-31" name="__codelineno-55-31" href="#__codelineno-55-31"></a><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">NT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">receivers</span><span class="p">.</span><span class="na">size</span><span class="p">();</span>
</span><span id="__span-55-32"><a id="__codelineno-55-32" name="__codelineno-55-32" href="#__codelineno-55-32"></a><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">it</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">it</span><span class="o">&lt;</span><span class="n">NT</span><span class="p">;</span><span class="w"> </span><span class="n">it</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-55-33"><a id="__codelineno-55-33" name="__codelineno-55-33" href="#__codelineno-55-33"></a><span class="w">                    </span><span class="n">ResolveInfo</span><span class="w"> </span><span class="n">curt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ResolveInfo</span><span class="p">)</span><span class="n">receivers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">it</span><span class="p">);</span>
</span><span id="__span-55-34"><a id="__codelineno-55-34" name="__codelineno-55-34" href="#__codelineno-55-34"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">curt</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">packageName</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">skipPackage</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-55-35"><a id="__codelineno-55-35" name="__codelineno-55-35" href="#__codelineno-55-35"></a><span class="w">                        </span><span class="n">receivers</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">it</span><span class="p">);</span>
</span><span id="__span-55-36"><a id="__codelineno-55-36" name="__codelineno-55-36" href="#__codelineno-55-36"></a><span class="w">                        </span><span class="n">it</span><span class="o">--</span><span class="p">;</span>
</span><span id="__span-55-37"><a id="__codelineno-55-37" name="__codelineno-55-37" href="#__codelineno-55-37"></a><span class="w">                        </span><span class="n">NT</span><span class="o">--</span><span class="p">;</span>
</span><span id="__span-55-38"><a id="__codelineno-55-38" name="__codelineno-55-38" href="#__codelineno-55-38"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-55-39"><a id="__codelineno-55-39" name="__codelineno-55-39" href="#__codelineno-55-39"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-55-40"><a id="__codelineno-55-40" name="__codelineno-55-40" href="#__codelineno-55-40"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-55-41"><a id="__codelineno-55-41" name="__codelineno-55-41" href="#__codelineno-55-41"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-55-42"><a id="__codelineno-55-42" name="__codelineno-55-42" href="#__codelineno-55-42"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-55-43"><a id="__codelineno-55-43" name="__codelineno-55-43" href="#__codelineno-55-43"></a>
</span><span id="__span-55-44"><a id="__codelineno-55-44" name="__codelineno-55-44" href="#__codelineno-55-44"></a><span class="w">    </span><span class="c1">//NT是静态接收者的个数，NR是动态接收者的个数</span>
</span><span id="__span-55-45"><a id="__codelineno-55-45" name="__codelineno-55-45" href="#__codelineno-55-45"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">NT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">receivers</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">receivers</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-55-46"><a id="__codelineno-55-46" name="__codelineno-55-46" href="#__codelineno-55-46"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-55-47"><a id="__codelineno-55-47" name="__codelineno-55-47" href="#__codelineno-55-47"></a><span class="w">    </span><span class="n">ResolveInfo</span><span class="w"> </span><span class="n">curt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="c1">//静态注册的广播接收者</span>
</span><span id="__span-55-48"><a id="__codelineno-55-48" name="__codelineno-55-48" href="#__codelineno-55-48"></a><span class="w">    </span><span class="n">BroadcastFilter</span><span class="w"> </span><span class="n">curr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="c1">//动态注册的广播接收者</span>
</span><span id="__span-55-49"><a id="__codelineno-55-49" name="__codelineno-55-49" href="#__codelineno-55-49"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NT</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ir</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NR</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="c1">//开始把动态注册的广播接收者列表registeredReceivers和静态注册的广播接收者列表receivers合并成一个列表</span>
</span><span id="__span-55-50"><a id="__codelineno-55-50" name="__codelineno-55-50" href="#__codelineno-55-50"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">curt</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-55-51"><a id="__codelineno-55-51" name="__codelineno-55-51" href="#__codelineno-55-51"></a><span class="w">            </span><span class="c1">//获取静态广播接收者列表第it个</span>
</span><span id="__span-55-52"><a id="__codelineno-55-52" name="__codelineno-55-52" href="#__codelineno-55-52"></a><span class="w">            </span><span class="n">curt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ResolveInfo</span><span class="p">)</span><span class="n">receivers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">it</span><span class="p">);</span>
</span><span id="__span-55-53"><a id="__codelineno-55-53" name="__codelineno-55-53" href="#__codelineno-55-53"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-55-54"><a id="__codelineno-55-54" name="__codelineno-55-54" href="#__codelineno-55-54"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">curr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-55-55"><a id="__codelineno-55-55" name="__codelineno-55-55" href="#__codelineno-55-55"></a><span class="w">            </span><span class="c1">//获取动态广播接收者列表第ir个</span>
</span><span id="__span-55-56"><a id="__codelineno-55-56" name="__codelineno-55-56" href="#__codelineno-55-56"></a><span class="w">            </span><span class="n">curr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">registeredReceivers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">ir</span><span class="p">);</span>
</span><span id="__span-55-57"><a id="__codelineno-55-57" name="__codelineno-55-57" href="#__codelineno-55-57"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-55-58"><a id="__codelineno-55-58" name="__codelineno-55-58" href="#__codelineno-55-58"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">curr</span><span class="p">.</span><span class="na">getPriority</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">curt</span><span class="p">.</span><span class="na">priority</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="c1">//如果动态注册广播接收者的优先级大于等于静态注册的</span>
</span><span id="__span-55-59"><a id="__codelineno-55-59" name="__codelineno-55-59" href="#__codelineno-55-59"></a><span class="w">            </span><span class="c1">// Insert this broadcast record into the final list.</span>
</span><span id="__span-55-60"><a id="__codelineno-55-60" name="__codelineno-55-60" href="#__codelineno-55-60"></a><span class="w">            </span><span class="c1">//把动态注册广播者插入静态注册的广播接收者列表中对应条目的前方</span>
</span><span id="__span-55-61"><a id="__codelineno-55-61" name="__codelineno-55-61" href="#__codelineno-55-61"></a><span class="w">            </span><span class="n">receivers</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">it</span><span class="p">,</span><span class="w"> </span><span class="n">curr</span><span class="p">);</span>
</span><span id="__span-55-62"><a id="__codelineno-55-62" name="__codelineno-55-62" href="#__codelineno-55-62"></a><span class="w">            </span><span class="n">ir</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-55-63"><a id="__codelineno-55-63" name="__codelineno-55-63" href="#__codelineno-55-63"></a><span class="w">            </span><span class="n">curr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-55-64"><a id="__codelineno-55-64" name="__codelineno-55-64" href="#__codelineno-55-64"></a><span class="w">            </span><span class="n">it</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-55-65"><a id="__codelineno-55-65" name="__codelineno-55-65" href="#__codelineno-55-65"></a><span class="w">            </span><span class="n">NT</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-55-66"><a id="__codelineno-55-66" name="__codelineno-55-66" href="#__codelineno-55-66"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-55-67"><a id="__codelineno-55-67" name="__codelineno-55-67" href="#__codelineno-55-67"></a><span class="w">            </span><span class="c1">// Skip to the next ResolveInfo in the final list.</span>
</span><span id="__span-55-68"><a id="__codelineno-55-68" name="__codelineno-55-68" href="#__codelineno-55-68"></a><span class="w">            </span><span class="n">it</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-55-69"><a id="__codelineno-55-69" name="__codelineno-55-69" href="#__codelineno-55-69"></a><span class="w">            </span><span class="n">curt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-55-70"><a id="__codelineno-55-70" name="__codelineno-55-70" href="#__codelineno-55-70"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-55-71"><a id="__codelineno-55-71" name="__codelineno-55-71" href="#__codelineno-55-71"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-55-72"><a id="__codelineno-55-72" name="__codelineno-55-72" href="#__codelineno-55-72"></a><span class="p">}</span>
</span><span id="__span-55-73"><a id="__codelineno-55-73" name="__codelineno-55-73" href="#__codelineno-55-73"></a><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">ir</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NR</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="c1">//将两个列表合并到一个列表中，这样静态注册广播接收者receivers列表就包含了所有的广播接收者(无序广播和有序广播)</span>
</span><span id="__span-55-74"><a id="__codelineno-55-74" name="__codelineno-55-74" href="#__codelineno-55-74"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">receivers</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-55-75"><a id="__codelineno-55-75" name="__codelineno-55-75" href="#__codelineno-55-75"></a><span class="w">        </span><span class="n">receivers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="p">();</span>
</span><span id="__span-55-76"><a id="__codelineno-55-76" name="__codelineno-55-76" href="#__codelineno-55-76"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-55-77"><a id="__codelineno-55-77" name="__codelineno-55-77" href="#__codelineno-55-77"></a><span class="w">    </span><span class="n">receivers</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">registeredReceivers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
</span><span id="__span-55-78"><a id="__codelineno-55-78" name="__codelineno-55-78" href="#__codelineno-55-78"></a><span class="w">    </span><span class="n">ir</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-55-79"><a id="__codelineno-55-79" name="__codelineno-55-79" href="#__codelineno-55-79"></a><span class="p">}</span>
</span><span id="__span-55-80"><a id="__codelineno-55-80" name="__codelineno-55-80" href="#__codelineno-55-80"></a>
</span><span id="__span-55-81"><a id="__codelineno-55-81" name="__codelineno-55-81" href="#__codelineno-55-81"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isCallerSystem</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="c1">//isCallerSystem是否系统调用发送广播</span>
</span><span id="__span-55-82"><a id="__codelineno-55-82" name="__codelineno-55-82" href="#__codelineno-55-82"></a><span class="w">    </span><span class="c1">//查看一下发送的是否保护的广播</span>
</span><span id="__span-55-83"><a id="__codelineno-55-83" name="__codelineno-55-83" href="#__codelineno-55-83"></a><span class="w">    </span><span class="n">checkBroadcastFromSystem</span><span class="p">(</span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">callerApp</span><span class="p">,</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">,</span>
</span><span id="__span-55-84"><a id="__codelineno-55-84" name="__codelineno-55-84" href="#__codelineno-55-84"></a><span class="w">            </span><span class="n">isProtectedBroadcast</span><span class="p">,</span><span class="w"> </span><span class="n">receivers</span><span class="p">);</span>
</span><span id="__span-55-85"><a id="__codelineno-55-85" name="__codelineno-55-85" href="#__codelineno-55-85"></a><span class="p">}</span>
</span><span id="__span-55-86"><a id="__codelineno-55-86" name="__codelineno-55-86" href="#__codelineno-55-86"></a>
</span><span id="__span-55-87"><a id="__codelineno-55-87" name="__codelineno-55-87" href="#__codelineno-55-87"></a><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">receivers</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">receivers</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-55-88"><a id="__codelineno-55-88" name="__codelineno-55-88" href="#__codelineno-55-88"></a><span class="w">        </span><span class="o">||</span><span class="w"> </span><span class="n">resultTo</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-55-89"><a id="__codelineno-55-89" name="__codelineno-55-89" href="#__codelineno-55-89"></a><span class="w">    </span><span class="c1">// 根据intent查找对应的广播队列</span>
</span><span id="__span-55-90"><a id="__codelineno-55-90" name="__codelineno-55-90" href="#__codelineno-55-90"></a><span class="w">    </span><span class="n">BroadcastQueue</span><span class="w"> </span><span class="n">queue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">broadcastQueueForIntent</span><span class="p">(</span><span class="n">intent</span><span class="p">);</span>
</span><span id="__span-55-91"><a id="__codelineno-55-91" name="__codelineno-55-91" href="#__codelineno-55-91"></a><span class="w">    </span><span class="c1">// 创建BroadcastRecord对象并将合并过的广播接收者列表receivers传进去</span>
</span><span id="__span-55-92"><a id="__codelineno-55-92" name="__codelineno-55-92" href="#__codelineno-55-92"></a><span class="w">    </span><span class="n">BroadcastRecord</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">callerApp</span><span class="p">,</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">,</span>
</span><span id="__span-55-93"><a id="__codelineno-55-93" name="__codelineno-55-93" href="#__codelineno-55-93"></a><span class="w">            </span><span class="n">callerFeatureId</span><span class="p">,</span><span class="w"> </span><span class="n">callingPid</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">,</span><span class="w"> </span><span class="n">callerInstantApp</span><span class="p">,</span><span class="w"> </span><span class="n">resolvedType</span><span class="p">,</span>
</span><span id="__span-55-94"><a id="__codelineno-55-94" name="__codelineno-55-94" href="#__codelineno-55-94"></a><span class="w">            </span><span class="n">requiredPermissions</span><span class="p">,</span><span class="w"> </span><span class="n">excludedPermissions</span><span class="p">,</span><span class="w"> </span><span class="n">excludedPackages</span><span class="p">,</span><span class="w"> </span><span class="n">appOp</span><span class="p">,</span><span class="w"> </span><span class="n">brOptions</span><span class="p">,</span>
</span><span id="__span-55-95"><a id="__codelineno-55-95" name="__codelineno-55-95" href="#__codelineno-55-95"></a><span class="w">            </span><span class="n">receivers</span><span class="p">,</span><span class="w"> </span><span class="n">resultTo</span><span class="p">,</span><span class="w"> </span><span class="n">resultCode</span><span class="p">,</span><span class="w"> </span><span class="n">resultData</span><span class="p">,</span><span class="w"> </span><span class="n">resultExtras</span><span class="p">,</span>
</span><span id="__span-55-96"><a id="__codelineno-55-96" name="__codelineno-55-96" href="#__codelineno-55-96"></a><span class="w">            </span><span class="n">ordered</span><span class="p">,</span><span class="w"> </span><span class="n">sticky</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">allowBackgroundActivityStarts</span><span class="p">,</span>
</span><span id="__span-55-97"><a id="__codelineno-55-97" name="__codelineno-55-97" href="#__codelineno-55-97"></a><span class="w">            </span><span class="n">backgroundActivityStartsToken</span><span class="p">,</span><span class="w"> </span><span class="n">timeoutExempt</span><span class="p">);</span>
</span><span id="__span-55-98"><a id="__codelineno-55-98" name="__codelineno-55-98" href="#__codelineno-55-98"></a>
</span><span id="__span-55-99"><a id="__codelineno-55-99" name="__codelineno-55-99" href="#__codelineno-55-99"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Enqueueing ordered broadcast &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-55-100"><a id="__codelineno-55-100" name="__codelineno-55-100" href="#__codelineno-55-100"></a>
</span><span id="__span-55-101"><a id="__codelineno-55-101" name="__codelineno-55-101" href="#__codelineno-55-101"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="w"> </span><span class="n">oldRecord</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-55-102"><a id="__codelineno-55-102" name="__codelineno-55-102" href="#__codelineno-55-102"></a><span class="w">            </span><span class="n">replacePending</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">queue</span><span class="p">.</span><span class="na">replaceOrderedBroadcastLocked</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-55-103"><a id="__codelineno-55-103" name="__codelineno-55-103" href="#__codelineno-55-103"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oldRecord</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-55-104"><a id="__codelineno-55-104" name="__codelineno-55-104" href="#__codelineno-55-104"></a><span class="w">        </span><span class="c1">// Replaced, fire the result-to receiver.</span>
</span><span id="__span-55-105"><a id="__codelineno-55-105" name="__codelineno-55-105" href="#__codelineno-55-105"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oldRecord</span><span class="p">.</span><span class="na">resultTo</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-55-106"><a id="__codelineno-55-106" name="__codelineno-55-106" href="#__codelineno-55-106"></a><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">BroadcastQueue</span><span class="w"> </span><span class="n">oldQueue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">broadcastQueueForIntent</span><span class="p">(</span><span class="n">oldRecord</span><span class="p">.</span><span class="na">intent</span><span class="p">);</span>
</span><span id="__span-55-107"><a id="__codelineno-55-107" name="__codelineno-55-107" href="#__codelineno-55-107"></a><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-55-108"><a id="__codelineno-55-108" name="__codelineno-55-108" href="#__codelineno-55-108"></a><span class="w">                </span><span class="n">oldQueue</span><span class="p">.</span><span class="na">performReceiveLocked</span><span class="p">(</span><span class="n">oldRecord</span><span class="p">.</span><span class="na">callerApp</span><span class="p">,</span><span class="w"> </span><span class="n">oldRecord</span><span class="p">.</span><span class="na">resultTo</span><span class="p">,</span>
</span><span id="__span-55-109"><a id="__codelineno-55-109" name="__codelineno-55-109" href="#__codelineno-55-109"></a><span class="w">                        </span><span class="n">oldRecord</span><span class="p">.</span><span class="na">intent</span><span class="p">,</span>
</span><span id="__span-55-110"><a id="__codelineno-55-110" name="__codelineno-55-110" href="#__codelineno-55-110"></a><span class="w">                        </span><span class="n">Activity</span><span class="p">.</span><span class="na">RESULT_CANCELED</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
</span><span id="__span-55-111"><a id="__codelineno-55-111" name="__codelineno-55-111" href="#__codelineno-55-111"></a><span class="w">                        </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">oldRecord</span><span class="p">.</span><span class="na">userId</span><span class="p">,</span><span class="w"> </span><span class="n">oldRecord</span><span class="p">.</span><span class="na">callingUid</span><span class="p">,</span><span class="w"> </span><span class="n">callingUid</span><span class="p">);</span>
</span><span id="__span-55-112"><a id="__codelineno-55-112" name="__codelineno-55-112" href="#__codelineno-55-112"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-55-113"><a id="__codelineno-55-113" name="__codelineno-55-113" href="#__codelineno-55-113"></a><span class="w">                </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Failure [&quot;</span>
</span><span id="__span-55-114"><a id="__codelineno-55-114" name="__codelineno-55-114" href="#__codelineno-55-114"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">queue</span><span class="p">.</span><span class="na">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;] sending broadcast result of &quot;</span>
</span><span id="__span-55-115"><a id="__codelineno-55-115" name="__codelineno-55-115" href="#__codelineno-55-115"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
</span><span id="__span-55-116"><a id="__codelineno-55-116" name="__codelineno-55-116" href="#__codelineno-55-116"></a>
</span><span id="__span-55-117"><a id="__codelineno-55-117" name="__codelineno-55-117" href="#__codelineno-55-117"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-55-118"><a id="__codelineno-55-118" name="__codelineno-55-118" href="#__codelineno-55-118"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-55-119"><a id="__codelineno-55-119" name="__codelineno-55-119" href="#__codelineno-55-119"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-55-120"><a id="__codelineno-55-120" name="__codelineno-55-120" href="#__codelineno-55-120"></a><span class="w">        </span><span class="c1">//无序广播+有序广播合并之后放在了BroadcastQueue的mOrderedBroadcasts中</span>
</span><span id="__span-55-121"><a id="__codelineno-55-121" name="__codelineno-55-121" href="#__codelineno-55-121"></a><span class="w">        </span><span class="n">queue</span><span class="p">.</span><span class="na">enqueueOrderedBroadcastLocked</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-55-122"><a id="__codelineno-55-122" name="__codelineno-55-122" href="#__codelineno-55-122"></a><span class="w">        </span><span class="c1">//并推动一次广播发送</span>
</span><span id="__span-55-123"><a id="__codelineno-55-123" name="__codelineno-55-123" href="#__codelineno-55-123"></a><span class="w">        </span><span class="n">queue</span><span class="p">.</span><span class="na">scheduleBroadcastsLocked</span><span class="p">();</span>
</span><span id="__span-55-124"><a id="__codelineno-55-124" name="__codelineno-55-124" href="#__codelineno-55-124"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-55-125"><a id="__codelineno-55-125" name="__codelineno-55-125" href="#__codelineno-55-125"></a><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-55-126"><a id="__codelineno-55-126" name="__codelineno-55-126" href="#__codelineno-55-126"></a><span class="w">    </span><span class="c1">// There was nobody interested in the broadcast, but we still want to record</span>
</span><span id="__span-55-127"><a id="__codelineno-55-127" name="__codelineno-55-127" href="#__codelineno-55-127"></a><span class="w">    </span><span class="c1">// that it happened.</span>
</span><span id="__span-55-128"><a id="__codelineno-55-128" name="__codelineno-55-128" href="#__codelineno-55-128"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getComponent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getPackage</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span>
</span><span id="__span-55-129"><a id="__codelineno-55-129" name="__codelineno-55-129" href="#__codelineno-55-129"></a><span class="w">            </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getFlags</span><span class="p">()</span><span class="o">&amp;</span><span class="n">Intent</span><span class="p">.</span><span class="na">FLAG_RECEIVER_REGISTERED_ONLY</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-55-130"><a id="__codelineno-55-130" name="__codelineno-55-130" href="#__codelineno-55-130"></a><span class="w">        </span><span class="c1">// This was an implicit broadcast... let&#39;s record it for posterity.</span>
</span><span id="__span-55-131"><a id="__codelineno-55-131" name="__codelineno-55-131" href="#__codelineno-55-131"></a><span class="w">        </span><span class="n">addBroadcastStatLocked</span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">(),</span><span class="w"> </span><span class="n">callerPackage</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-55-132"><a id="__codelineno-55-132" name="__codelineno-55-132" href="#__codelineno-55-132"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-55-133"><a id="__codelineno-55-133" name="__codelineno-55-133" href="#__codelineno-55-133"></a><span class="p">}</span>
</span><span id="__span-55-134"><a id="__codelineno-55-134" name="__codelineno-55-134" href="#__codelineno-55-134"></a>
</span><span id="__span-55-135"><a id="__codelineno-55-135" name="__codelineno-55-135" href="#__codelineno-55-135"></a><span class="k">return</span><span class="w"> </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">BROADCAST_SUCCESS</span><span class="p">;</span>
</span></code></pre></div>
<ul>
<li>对特殊的广播，需要跳过</li>
</ul>
<p>如ACTION_PACKAGE_ADDED(安装)/ACTION_PACKAGE_RESTARTED(重新)/ACTION_PACKAGE_DATA_CLEARED(清除)，不允许被安装的package接收，防止自启。</p>
<ul>
<li>动态注册的广播接收者列表registeredReceivers和静态注册的广播接收者列表receivers合并成一个列表</li>
<li>根据intent查找对应的广播队列</li>
<li>创建BroadcastRecord对象并将合并过的广播接收者列表receivers传进去</li>
<li>调用enqueueOrderedBroadcastLocked，将无序广播+有序广播合并之后放在了BroadcastQueue的mOrderedBroadcasts中</li>
<li>调用scheduleBroadcastsLocked()发送广播</li>
</ul>
<h4 id="_35">总结<a class="headerlink" href="#_35" title="Permanent link">&para;</a></h4>
<p>这段代码看起来很长，但是仔细捋一遍其中的大致流程其实也是很容易理解的。</p>
<ul>
<li>做一些检查和判断</li>
</ul>
<p>如userid校验、是否允许后台启动activity、改变deviceidle名单，进行权限校验、protectBroadcast的caller校验等等</p>
<ul>
<li>特殊action广播特殊处理</li>
<li>sticky广播处理</li>
<li>动态注册的并行广播处理入队</li>
<li>静态注册广播以及动态注册有序广播根据优先级排序后入队</li>
<li>开始调度</li>
</ul>
<h3 id="ams">AMS创建广播队列<a class="headerlink" href="#ams" title="Permanent link">&para;</a></h3>
<p>前面讲的是过滤接收者，然后将信息放入广播队列中，那么广播队列是如何处理这类信息的呢？广播队列又是在哪里创建的呢？</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ActivityManagerService</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">IActivityManager</span><span class="p">.</span><span class="na">Stub</span>
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="w">        </span><span class="kd">implements</span><span class="w"> </span><span class="n">Watchdog</span><span class="p">.</span><span class="na">Monitor</span><span class="p">,</span><span class="w"> </span><span class="n">BatteryStatsImpl</span><span class="p">.</span><span class="na">BatteryCallback</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityManagerGlobalLock</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a>
</span><span id="__span-56-4"><a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">BroadcastQueue</span><span class="w"> </span><span class="n">mFgBroadcastQueue</span><span class="p">;</span>
</span><span id="__span-56-5"><a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">BroadcastQueue</span><span class="w"> </span><span class="n">mBgBroadcastQueue</span><span class="p">;</span>
</span><span id="__span-56-6"><a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">BroadcastQueue</span><span class="w"> </span><span class="n">mBgOffloadBroadcastQueue</span><span class="p">;</span>
</span><span id="__span-56-7"><a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">BroadcastQueue</span><span class="w"> </span><span class="n">mFgOffloadBroadcastQueue</span><span class="p">;</span>
</span><span id="__span-56-8"><a id="__codelineno-56-8" name="__codelineno-56-8" href="#__codelineno-56-8"></a><span class="w">    </span><span class="c1">// Convenient for easy iteration over the queues. Foreground is first</span>
</span><span id="__span-56-9"><a id="__codelineno-56-9" name="__codelineno-56-9" href="#__codelineno-56-9"></a><span class="w">    </span><span class="c1">// so that dispatch of foreground broadcasts gets precedence.</span>
</span><span id="__span-56-10"><a id="__codelineno-56-10" name="__codelineno-56-10" href="#__codelineno-56-10"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">BroadcastQueue</span><span class="o">[]</span><span class="w"> </span><span class="n">mBroadcastQueues</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BroadcastQueue</span><span class="o">[</span><span class="mi">4</span><span class="o">]</span><span class="p">;</span>
</span><span id="__span-56-11"><a id="__codelineno-56-11" name="__codelineno-56-11" href="#__codelineno-56-11"></a>
</span><span id="__span-56-12"><a id="__codelineno-56-12" name="__codelineno-56-12" href="#__codelineno-56-12"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">ActivityManagerService</span><span class="p">(</span><span class="n">Context</span><span class="w"> </span><span class="n">systemContext</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityTaskManagerService</span><span class="w"> </span><span class="n">atm</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-56-13"><a id="__codelineno-56-13" name="__codelineno-56-13" href="#__codelineno-56-13"></a><span class="w">        </span><span class="p">...</span>
</span><span id="__span-56-14"><a id="__codelineno-56-14" name="__codelineno-56-14" href="#__codelineno-56-14"></a>
</span><span id="__span-56-15"><a id="__codelineno-56-15" name="__codelineno-56-15" href="#__codelineno-56-15"></a><span class="w">        </span><span class="c1">// Broadcast policy parameters</span>
</span><span id="__span-56-16"><a id="__codelineno-56-16" name="__codelineno-56-16" href="#__codelineno-56-16"></a><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">BroadcastConstants</span><span class="w"> </span><span class="n">foreConstants</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BroadcastConstants</span><span class="p">(</span>
</span><span id="__span-56-17"><a id="__codelineno-56-17" name="__codelineno-56-17" href="#__codelineno-56-17"></a><span class="w">                </span><span class="n">Settings</span><span class="p">.</span><span class="na">Global</span><span class="p">.</span><span class="na">BROADCAST_FG_CONSTANTS</span><span class="p">);</span>
</span><span id="__span-56-18"><a id="__codelineno-56-18" name="__codelineno-56-18" href="#__codelineno-56-18"></a><span class="w">        </span><span class="c1">//前台广播超时时间是10s</span>
</span><span id="__span-56-19"><a id="__codelineno-56-19" name="__codelineno-56-19" href="#__codelineno-56-19"></a><span class="w">        </span><span class="n">foreConstants</span><span class="p">.</span><span class="na">TIMEOUT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BROADCAST_FG_TIMEOUT</span><span class="p">;</span>
</span><span id="__span-56-20"><a id="__codelineno-56-20" name="__codelineno-56-20" href="#__codelineno-56-20"></a>
</span><span id="__span-56-21"><a id="__codelineno-56-21" name="__codelineno-56-21" href="#__codelineno-56-21"></a><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">BroadcastConstants</span><span class="w"> </span><span class="n">backConstants</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BroadcastConstants</span><span class="p">(</span>
</span><span id="__span-56-22"><a id="__codelineno-56-22" name="__codelineno-56-22" href="#__codelineno-56-22"></a><span class="w">                </span><span class="n">Settings</span><span class="p">.</span><span class="na">Global</span><span class="p">.</span><span class="na">BROADCAST_BG_CONSTANTS</span><span class="p">);</span>
</span><span id="__span-56-23"><a id="__codelineno-56-23" name="__codelineno-56-23" href="#__codelineno-56-23"></a><span class="w">        </span><span class="c1">//后台广播超时时间是60s</span>
</span><span id="__span-56-24"><a id="__codelineno-56-24" name="__codelineno-56-24" href="#__codelineno-56-24"></a><span class="w">        </span><span class="n">backConstants</span><span class="p">.</span><span class="na">TIMEOUT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BROADCAST_BG_TIMEOUT</span><span class="p">;</span>
</span><span id="__span-56-25"><a id="__codelineno-56-25" name="__codelineno-56-25" href="#__codelineno-56-25"></a>
</span><span id="__span-56-26"><a id="__codelineno-56-26" name="__codelineno-56-26" href="#__codelineno-56-26"></a><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">BroadcastConstants</span><span class="w"> </span><span class="n">offloadConstants</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BroadcastConstants</span><span class="p">(</span>
</span><span id="__span-56-27"><a id="__codelineno-56-27" name="__codelineno-56-27" href="#__codelineno-56-27"></a><span class="w">                </span><span class="n">Settings</span><span class="p">.</span><span class="na">Global</span><span class="p">.</span><span class="na">BROADCAST_OFFLOAD_CONSTANTS</span><span class="p">);</span>
</span><span id="__span-56-28"><a id="__codelineno-56-28" name="__codelineno-56-28" href="#__codelineno-56-28"></a><span class="w">        </span><span class="n">offloadConstants</span><span class="p">.</span><span class="na">TIMEOUT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BROADCAST_BG_TIMEOUT</span><span class="p">;</span>
</span><span id="__span-56-29"><a id="__codelineno-56-29" name="__codelineno-56-29" href="#__codelineno-56-29"></a><span class="w">        </span><span class="c1">// by default, no &quot;slow&quot; policy in this queue</span>
</span><span id="__span-56-30"><a id="__codelineno-56-30" name="__codelineno-56-30" href="#__codelineno-56-30"></a><span class="w">        </span><span class="c1">//没有SLOW_TIME，不使用延迟策略广播</span>
</span><span id="__span-56-31"><a id="__codelineno-56-31" name="__codelineno-56-31" href="#__codelineno-56-31"></a><span class="w">        </span><span class="n">offloadConstants</span><span class="p">.</span><span class="na">SLOW_TIME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Integer</span><span class="p">.</span><span class="na">MAX_VALUE</span><span class="p">;</span>
</span><span id="__span-56-32"><a id="__codelineno-56-32" name="__codelineno-56-32" href="#__codelineno-56-32"></a>
</span><span id="__span-56-33"><a id="__codelineno-56-33" name="__codelineno-56-33" href="#__codelineno-56-33"></a><span class="w">        </span><span class="c1">//默认使用Offload的广播的</span>
</span><span id="__span-56-34"><a id="__codelineno-56-34" name="__codelineno-56-34" href="#__codelineno-56-34"></a><span class="w">        </span><span class="n">mEnableOffloadQueue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SystemProperties</span><span class="p">.</span><span class="na">getBoolean</span><span class="p">(</span>
</span><span id="__span-56-35"><a id="__codelineno-56-35" name="__codelineno-56-35" href="#__codelineno-56-35"></a><span class="w">                </span><span class="s">&quot;persist.device_config.activity_manager_native_boot.offload_queue_enabled&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
</span><span id="__span-56-36"><a id="__codelineno-56-36" name="__codelineno-56-36" href="#__codelineno-56-36"></a>
</span><span id="__span-56-37"><a id="__codelineno-56-37" name="__codelineno-56-37" href="#__codelineno-56-37"></a><span class="w">        </span><span class="c1">//这里的mHandler是AMS的MainHandler，优先级是THREAD_PRIORITY_FOREGROUND前台</span>
</span><span id="__span-56-38"><a id="__codelineno-56-38" name="__codelineno-56-38" href="#__codelineno-56-38"></a><span class="w">        </span><span class="n">mFgBroadcastQueue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BroadcastQueue</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">mHandler</span><span class="p">,</span>
</span><span id="__span-56-39"><a id="__codelineno-56-39" name="__codelineno-56-39" href="#__codelineno-56-39"></a><span class="w">                </span><span class="s">&quot;foreground&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">foreConstants</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
</span><span id="__span-56-40"><a id="__codelineno-56-40" name="__codelineno-56-40" href="#__codelineno-56-40"></a><span class="w">        </span><span class="n">mBgBroadcastQueue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BroadcastQueue</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">mHandler</span><span class="p">,</span>
</span><span id="__span-56-41"><a id="__codelineno-56-41" name="__codelineno-56-41" href="#__codelineno-56-41"></a><span class="w">                </span><span class="s">&quot;background&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">backConstants</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
</span><span id="__span-56-42"><a id="__codelineno-56-42" name="__codelineno-56-42" href="#__codelineno-56-42"></a><span class="w">        </span><span class="n">mBgOffloadBroadcastQueue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BroadcastQueue</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">mHandler</span><span class="p">,</span>
</span><span id="__span-56-43"><a id="__codelineno-56-43" name="__codelineno-56-43" href="#__codelineno-56-43"></a><span class="w">                </span><span class="s">&quot;offload_bg&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">offloadConstants</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
</span><span id="__span-56-44"><a id="__codelineno-56-44" name="__codelineno-56-44" href="#__codelineno-56-44"></a><span class="w">        </span><span class="n">mFgOffloadBroadcastQueue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BroadcastQueue</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">mHandler</span><span class="p">,</span>
</span><span id="__span-56-45"><a id="__codelineno-56-45" name="__codelineno-56-45" href="#__codelineno-56-45"></a><span class="w">                </span><span class="s">&quot;offload_fg&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">foreConstants</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
</span><span id="__span-56-46"><a id="__codelineno-56-46" name="__codelineno-56-46" href="#__codelineno-56-46"></a><span class="w">        </span><span class="n">mBroadcastQueues</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mFgBroadcastQueue</span><span class="p">;</span>
</span><span id="__span-56-47"><a id="__codelineno-56-47" name="__codelineno-56-47" href="#__codelineno-56-47"></a><span class="w">        </span><span class="n">mBroadcastQueues</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mBgBroadcastQueue</span><span class="p">;</span>
</span><span id="__span-56-48"><a id="__codelineno-56-48" name="__codelineno-56-48" href="#__codelineno-56-48"></a><span class="w">        </span><span class="n">mBroadcastQueues</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mBgOffloadBroadcastQueue</span><span class="p">;</span>
</span><span id="__span-56-49"><a id="__codelineno-56-49" name="__codelineno-56-49" href="#__codelineno-56-49"></a><span class="w">        </span><span class="n">mBroadcastQueues</span><span class="o">[</span><span class="mi">3</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mFgOffloadBroadcastQueue</span><span class="p">;</span>
</span><span id="__span-56-50"><a id="__codelineno-56-50" name="__codelineno-56-50" href="#__codelineno-56-50"></a>
</span><span id="__span-56-51"><a id="__codelineno-56-51" name="__codelineno-56-51" href="#__codelineno-56-51"></a><span class="w">        </span><span class="p">...</span>
</span><span id="__span-56-52"><a id="__codelineno-56-52" name="__codelineno-56-52" href="#__codelineno-56-52"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-56-53"><a id="__codelineno-56-53" name="__codelineno-56-53" href="#__codelineno-56-53"></a>
</span><span id="__span-56-54"><a id="__codelineno-56-54" name="__codelineno-56-54" href="#__codelineno-56-54"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="_36">广播接收者入队列<a class="headerlink" href="#_36" title="Permanent link">&para;</a></h3>
<h4 id="enqueueparallelbroadcastlocked">enqueueParallelBroadcastLocked<a class="headerlink" href="#enqueueparallelbroadcastlocked" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="n">BroadcastQueue</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-57-2"><a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a>
</span><span id="__span-57-3"><a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a><span class="kd">final</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">BroadcastRecord</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mParallelBroadcasts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-57-4"><a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a>
</span><span id="__span-57-5"><a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">enqueueParallelBroadcastLocked</span><span class="p">(</span><span class="n">BroadcastRecord</span><span class="w"> </span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-57-6"><a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a><span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="na">enqueueClockTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span>
</span><span id="__span-57-7"><a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a><span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="na">enqueueTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SystemClock</span><span class="p">.</span><span class="na">uptimeMillis</span><span class="p">();</span>
</span><span id="__span-57-8"><a id="__codelineno-57-8" name="__codelineno-57-8" href="#__codelineno-57-8"></a><span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="na">enqueueRealTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SystemClock</span><span class="p">.</span><span class="na">elapsedRealtime</span><span class="p">();</span>
</span><span id="__span-57-9"><a id="__codelineno-57-9" name="__codelineno-57-9" href="#__codelineno-57-9"></a><span class="w">    </span><span class="n">mParallelBroadcasts</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-57-10"><a id="__codelineno-57-10" name="__codelineno-57-10" href="#__codelineno-57-10"></a><span class="w">    </span><span class="n">enqueueBroadcastHelper</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-57-11"><a id="__codelineno-57-11" name="__codelineno-57-11" href="#__codelineno-57-11"></a><span class="p">}</span>
</span></code></pre></div>
<p>全部丢入广播队列BroadcastQueue的mParallelBroadcasts中。</p>
<h4 id="enqueueorderedbroadcastlocked">enqueueOrderedBroadcastLocked<a class="headerlink" href="#enqueueorderedbroadcastlocked" title="Permanent link">&para;</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a>BroadcastQueue.java
</span><span id="__span-58-2"><a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a>
</span><span id="__span-58-3"><a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a>final BroadcastDispatcher mDispatcher;
</span><span id="__span-58-4"><a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a>
</span><span id="__span-58-5"><a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a>public void enqueueOrderedBroadcastLocked(BroadcastRecord r) {
</span><span id="__span-58-6"><a id="__codelineno-58-6" name="__codelineno-58-6" href="#__codelineno-58-6"></a>    r.enqueueClockTime = System.currentTimeMillis();
</span><span id="__span-58-7"><a id="__codelineno-58-7" name="__codelineno-58-7" href="#__codelineno-58-7"></a>    r.enqueueTime = SystemClock.uptimeMillis();
</span><span id="__span-58-8"><a id="__codelineno-58-8" name="__codelineno-58-8" href="#__codelineno-58-8"></a>    r.enqueueRealTime = SystemClock.elapsedRealtime();
</span><span id="__span-58-9"><a id="__codelineno-58-9" name="__codelineno-58-9" href="#__codelineno-58-9"></a>    mDispatcher.enqueueOrderedBroadcastLocked(r);
</span><span id="__span-58-10"><a id="__codelineno-58-10" name="__codelineno-58-10" href="#__codelineno-58-10"></a>    enqueueBroadcastHelper(r);
</span><span id="__span-58-11"><a id="__codelineno-58-11" name="__codelineno-58-11" href="#__codelineno-58-11"></a>}
</span></code></pre></div>
<div class="language-java highlight"><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="n">BroadcastDispatcher</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-59-2"><a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a>
</span><span id="__span-59-3"><a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">BroadcastRecord</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mOrderedBroadcasts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-59-4"><a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a>
</span><span id="__span-59-5"><a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a><span class="kt">void</span><span class="w"> </span><span class="nf">enqueueOrderedBroadcastLocked</span><span class="p">(</span><span class="n">BroadcastRecord</span><span class="w"> </span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-59-6"><a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">receivers</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">receivers</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-59-7"><a id="__codelineno-59-7" name="__codelineno-59-7" href="#__codelineno-59-7"></a><span class="w">        </span><span class="n">mOrderedBroadcasts</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-59-8"><a id="__codelineno-59-8" name="__codelineno-59-8" href="#__codelineno-59-8"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-59-9"><a id="__codelineno-59-9" name="__codelineno-59-9" href="#__codelineno-59-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-59-10"><a id="__codelineno-59-10" name="__codelineno-59-10" href="#__codelineno-59-10"></a>
</span><span id="__span-59-11"><a id="__codelineno-59-11" name="__codelineno-59-11" href="#__codelineno-59-11"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_LOCKED_BOOT_COMPLETED</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-59-12"><a id="__codelineno-59-12" name="__codelineno-59-12" href="#__codelineno-59-12"></a><span class="w">        </span><span class="c1">// Create one BroadcastRecord for each UID that can be deferred.</span>
</span><span id="__span-59-13"><a id="__codelineno-59-13" name="__codelineno-59-13" href="#__codelineno-59-13"></a><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">SparseArray</span><span class="o">&lt;</span><span class="n">BroadcastRecord</span><span class="o">&gt;</span><span class="w"> </span><span class="n">deferred</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-59-14"><a id="__codelineno-59-14" name="__codelineno-59-14" href="#__codelineno-59-14"></a><span class="w">                </span><span class="n">r</span><span class="p">.</span><span class="na">splitDeferredBootCompletedBroadcastLocked</span><span class="p">(</span><span class="n">mQueue</span><span class="p">.</span><span class="na">mService</span><span class="p">.</span><span class="na">mInternal</span><span class="p">,</span>
</span><span id="__span-59-15"><a id="__codelineno-59-15" name="__codelineno-59-15" href="#__codelineno-59-15"></a><span class="w">                        </span><span class="n">mQueue</span><span class="p">.</span><span class="na">mService</span><span class="p">.</span><span class="na">mConstants</span><span class="p">.</span><span class="na">mDeferBootCompletedBroadcast</span><span class="p">);</span>
</span><span id="__span-59-16"><a id="__codelineno-59-16" name="__codelineno-59-16" href="#__codelineno-59-16"></a><span class="w">        </span><span class="n">getDeferredPerUser</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">userId</span><span class="p">).</span><span class="na">enqueueBootCompletedBroadcasts</span><span class="p">(</span>
</span><span id="__span-59-17"><a id="__codelineno-59-17" name="__codelineno-59-17" href="#__codelineno-59-17"></a><span class="w">                </span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_LOCKED_BOOT_COMPLETED</span><span class="p">,</span><span class="w"> </span><span class="n">deferred</span><span class="p">);</span>
</span><span id="__span-59-18"><a id="__codelineno-59-18" name="__codelineno-59-18" href="#__codelineno-59-18"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">.</span><span class="na">receivers</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-59-19"><a id="__codelineno-59-19" name="__codelineno-59-19" href="#__codelineno-59-19"></a><span class="w">            </span><span class="c1">// The non-deferred receivers.</span>
</span><span id="__span-59-20"><a id="__codelineno-59-20" name="__codelineno-59-20" href="#__codelineno-59-20"></a><span class="w">            </span><span class="n">mOrderedBroadcasts</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-59-21"><a id="__codelineno-59-21" name="__codelineno-59-21" href="#__codelineno-59-21"></a><span class="w">            </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-59-22"><a id="__codelineno-59-22" name="__codelineno-59-22" href="#__codelineno-59-22"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-59-23"><a id="__codelineno-59-23" name="__codelineno-59-23" href="#__codelineno-59-23"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_BOOT_COMPLETED</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-59-24"><a id="__codelineno-59-24" name="__codelineno-59-24" href="#__codelineno-59-24"></a><span class="w">        </span><span class="c1">// Create one BroadcastRecord for each UID that can be deferred.</span>
</span><span id="__span-59-25"><a id="__codelineno-59-25" name="__codelineno-59-25" href="#__codelineno-59-25"></a><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">SparseArray</span><span class="o">&lt;</span><span class="n">BroadcastRecord</span><span class="o">&gt;</span><span class="w"> </span><span class="n">deferred</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-59-26"><a id="__codelineno-59-26" name="__codelineno-59-26" href="#__codelineno-59-26"></a><span class="w">                </span><span class="n">r</span><span class="p">.</span><span class="na">splitDeferredBootCompletedBroadcastLocked</span><span class="p">(</span><span class="n">mQueue</span><span class="p">.</span><span class="na">mService</span><span class="p">.</span><span class="na">mInternal</span><span class="p">,</span>
</span><span id="__span-59-27"><a id="__codelineno-59-27" name="__codelineno-59-27" href="#__codelineno-59-27"></a><span class="w">                        </span><span class="n">mQueue</span><span class="p">.</span><span class="na">mService</span><span class="p">.</span><span class="na">mConstants</span><span class="p">.</span><span class="na">mDeferBootCompletedBroadcast</span><span class="p">);</span>
</span><span id="__span-59-28"><a id="__codelineno-59-28" name="__codelineno-59-28" href="#__codelineno-59-28"></a><span class="w">        </span><span class="n">getDeferredPerUser</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">userId</span><span class="p">).</span><span class="na">enqueueBootCompletedBroadcasts</span><span class="p">(</span>
</span><span id="__span-59-29"><a id="__codelineno-59-29" name="__codelineno-59-29" href="#__codelineno-59-29"></a><span class="w">                </span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_BOOT_COMPLETED</span><span class="p">,</span><span class="w"> </span><span class="n">deferred</span><span class="p">);</span>
</span><span id="__span-59-30"><a id="__codelineno-59-30" name="__codelineno-59-30" href="#__codelineno-59-30"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">.</span><span class="na">receivers</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-59-31"><a id="__codelineno-59-31" name="__codelineno-59-31" href="#__codelineno-59-31"></a><span class="w">            </span><span class="c1">// The non-deferred receivers.</span>
</span><span id="__span-59-32"><a id="__codelineno-59-32" name="__codelineno-59-32" href="#__codelineno-59-32"></a><span class="w">            </span><span class="n">mOrderedBroadcasts</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-59-33"><a id="__codelineno-59-33" name="__codelineno-59-33" href="#__codelineno-59-33"></a><span class="w">            </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-59-34"><a id="__codelineno-59-34" name="__codelineno-59-34" href="#__codelineno-59-34"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-59-35"><a id="__codelineno-59-35" name="__codelineno-59-35" href="#__codelineno-59-35"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-59-36"><a id="__codelineno-59-36" name="__codelineno-59-36" href="#__codelineno-59-36"></a><span class="w">        </span><span class="n">mOrderedBroadcasts</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-59-37"><a id="__codelineno-59-37" name="__codelineno-59-37" href="#__codelineno-59-37"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-59-38"><a id="__codelineno-59-38" name="__codelineno-59-38" href="#__codelineno-59-38"></a><span class="p">}</span>
</span></code></pre></div>
<p>这里多了一个中转mDispatcher(BroadcastDispatcher)，放入的其实是BroadcastDispatcher的mOrderedBroadcasts中。</p>
<h3 id="_37">广播队列分发<a class="headerlink" href="#_37" title="Permanent link">&para;</a></h3>
<div class="language-java highlight"><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="n">BroadcastQueue</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-60-2"><a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a>
</span><span id="__span-60-3"><a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">scheduleBroadcastsLocked</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-60-4"><a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Schedule broadcasts [&quot;</span>
</span><span id="__span-60-5"><a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;]: current=&quot;</span>
</span><span id="__span-60-6"><a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">mBroadcastsScheduled</span><span class="p">);</span>
</span><span id="__span-60-7"><a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a>
</span><span id="__span-60-8"><a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a><span class="w">    </span><span class="c1">// 如果true说明消息队列已经存在一个类型为BROADCAST_INTENT_MSG的消息了，直接返回，因为该消息在执行完毕会自动调用下一条消息</span>
</span><span id="__span-60-9"><a id="__codelineno-60-9" name="__codelineno-60-9" href="#__codelineno-60-9"></a><span class="w">    </span><span class="c1">// AMS就是通过这个BROADCAST_INTENT_MSG消息类</span>
</span><span id="__span-60-10"><a id="__codelineno-60-10" name="__codelineno-60-10" href="#__codelineno-60-10"></a><span class="w">    </span><span class="c1">// 来调度保存在无序广播调度队列mParallelBroadcasts和有序广播调度队列mOrderedBroadcasts中的广播转发任务的</span>
</span><span id="__span-60-11"><a id="__codelineno-60-11" name="__codelineno-60-11" href="#__codelineno-60-11"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mBroadcastsScheduled</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-60-12"><a id="__codelineno-60-12" name="__codelineno-60-12" href="#__codelineno-60-12"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-60-13"><a id="__codelineno-60-13" name="__codelineno-60-13" href="#__codelineno-60-13"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-60-14"><a id="__codelineno-60-14" name="__codelineno-60-14" href="#__codelineno-60-14"></a><span class="w">    </span><span class="c1">// 虽然这里只发送了发送广播的消息，但是这一步执行完之后就已经标记广播发送了，因此可以看出广播发送和接</span>
</span><span id="__span-60-15"><a id="__codelineno-60-15" name="__codelineno-60-15" href="#__codelineno-60-15"></a><span class="w">    </span><span class="c1">// 受是异步的，即广播发送者将一个广播发送给AMS后，不会等待AMS将这个广播转发给广播接收者处理</span>
</span><span id="__span-60-16"><a id="__codelineno-60-16" name="__codelineno-60-16" href="#__codelineno-60-16"></a><span class="w">    </span><span class="n">mHandler</span><span class="p">.</span><span class="na">sendMessage</span><span class="p">(</span><span class="n">mHandler</span><span class="p">.</span><span class="na">obtainMessage</span><span class="p">(</span><span class="n">BROADCAST_INTENT_MSG</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">));</span>
</span><span id="__span-60-17"><a id="__codelineno-60-17" name="__codelineno-60-17" href="#__codelineno-60-17"></a><span class="w">    </span><span class="n">mBroadcastsScheduled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-60-18"><a id="__codelineno-60-18" name="__codelineno-60-18" href="#__codelineno-60-18"></a><span class="p">}</span>
</span><span id="__span-60-19"><a id="__codelineno-60-19" name="__codelineno-60-19" href="#__codelineno-60-19"></a>
</span><span id="__span-60-20"><a id="__codelineno-60-20" name="__codelineno-60-20" href="#__codelineno-60-20"></a><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">BroadcastHandler</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Handler</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-60-21"><a id="__codelineno-60-21" name="__codelineno-60-21" href="#__codelineno-60-21"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">BroadcastHandler</span><span class="p">(</span><span class="n">Looper</span><span class="w"> </span><span class="n">looper</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-60-22"><a id="__codelineno-60-22" name="__codelineno-60-22" href="#__codelineno-60-22"></a><span class="w">        </span><span class="kd">super</span><span class="p">(</span><span class="n">looper</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
</span><span id="__span-60-23"><a id="__codelineno-60-23" name="__codelineno-60-23" href="#__codelineno-60-23"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-60-24"><a id="__codelineno-60-24" name="__codelineno-60-24" href="#__codelineno-60-24"></a>
</span><span id="__span-60-25"><a id="__codelineno-60-25" name="__codelineno-60-25" href="#__codelineno-60-25"></a><span class="w">    </span><span class="nd">@Override</span>
</span><span id="__span-60-26"><a id="__codelineno-60-26" name="__codelineno-60-26" href="#__codelineno-60-26"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handleMessage</span><span class="p">(</span><span class="n">Message</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-60-27"><a id="__codelineno-60-27" name="__codelineno-60-27" href="#__codelineno-60-27"></a><span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="na">what</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-60-28"><a id="__codelineno-60-28" name="__codelineno-60-28" href="#__codelineno-60-28"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">BROADCAST_INTENT_MSG</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-60-29"><a id="__codelineno-60-29" name="__codelineno-60-29" href="#__codelineno-60-29"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span>
</span><span id="__span-60-30"><a id="__codelineno-60-30" name="__codelineno-60-30" href="#__codelineno-60-30"></a><span class="w">                        </span><span class="n">TAG_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Received BROADCAST_INTENT_MSG [&quot;</span>
</span><span id="__span-60-31"><a id="__codelineno-60-31" name="__codelineno-60-31" href="#__codelineno-60-31"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;]&quot;</span><span class="p">);</span>
</span><span id="__span-60-32"><a id="__codelineno-60-32" name="__codelineno-60-32" href="#__codelineno-60-32"></a><span class="w">                </span><span class="c1">//开始处理下一个广播</span>
</span><span id="__span-60-33"><a id="__codelineno-60-33" name="__codelineno-60-33" href="#__codelineno-60-33"></a><span class="w">                </span><span class="n">processNextBroadcast</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span><span id="__span-60-34"><a id="__codelineno-60-34" name="__codelineno-60-34" href="#__codelineno-60-34"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-60-35"><a id="__codelineno-60-35" name="__codelineno-60-35" href="#__codelineno-60-35"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">BROADCAST_TIMEOUT_MSG</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-60-36"><a id="__codelineno-60-36" name="__codelineno-60-36" href="#__codelineno-60-36"></a><span class="w">                </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mService</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-60-37"><a id="__codelineno-60-37" name="__codelineno-60-37" href="#__codelineno-60-37"></a><span class="w">                    </span><span class="n">broadcastTimeoutLocked</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span><span id="__span-60-38"><a id="__codelineno-60-38" name="__codelineno-60-38" href="#__codelineno-60-38"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-60-39"><a id="__codelineno-60-39" name="__codelineno-60-39" href="#__codelineno-60-39"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-60-40"><a id="__codelineno-60-40" name="__codelineno-60-40" href="#__codelineno-60-40"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-60-41"><a id="__codelineno-60-41" name="__codelineno-60-41" href="#__codelineno-60-41"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-60-42"><a id="__codelineno-60-42" name="__codelineno-60-42" href="#__codelineno-60-42"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="_38">处理分发下一个广播<a class="headerlink" href="#_38" title="Permanent link">&para;</a></h3>
<div class="language-java highlight"><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="n">BroadcastQueue</span><span class="p">.</span><span class="na">java</span>
</span><span id="__span-61-2"><a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a>
</span><span id="__span-61-3"><a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">processNextBroadcast</span><span class="p">(</span><span class="kt">boolean</span><span class="w"> </span><span class="n">fromMsg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-4"><a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a><span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mService</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-5"><a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a><span class="w">        </span><span class="n">processNextBroadcastLocked</span><span class="p">(</span><span class="n">fromMsg</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
</span><span id="__span-61-6"><a id="__codelineno-61-6" name="__codelineno-61-6" href="#__codelineno-61-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-61-7"><a id="__codelineno-61-7" name="__codelineno-61-7" href="#__codelineno-61-7"></a><span class="p">}</span>
</span><span id="__span-61-8"><a id="__codelineno-61-8" name="__codelineno-61-8" href="#__codelineno-61-8"></a>
</span><span id="__span-61-9"><a id="__codelineno-61-9" name="__codelineno-61-9" href="#__codelineno-61-9"></a><span class="kd">final</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">processNextBroadcastLocked</span><span class="p">(</span><span class="kt">boolean</span><span class="w"> </span><span class="n">fromMsg</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">skipOomAdj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-10"><a id="__codelineno-61-10" name="__codelineno-61-10" href="#__codelineno-61-10"></a><span class="w">    </span><span class="n">BroadcastRecord</span><span class="w"> </span><span class="n">r</span><span class="p">;</span>
</span><span id="__span-61-11"><a id="__codelineno-61-11" name="__codelineno-61-11" href="#__codelineno-61-11"></a>
</span><span id="__span-61-12"><a id="__codelineno-61-12" name="__codelineno-61-12" href="#__codelineno-61-12"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;processNextBroadcast [&quot;</span>
</span><span id="__span-61-13"><a id="__codelineno-61-13" name="__codelineno-61-13" href="#__codelineno-61-13"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;]: &quot;</span>
</span><span id="__span-61-14"><a id="__codelineno-61-14" name="__codelineno-61-14" href="#__codelineno-61-14"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">mParallelBroadcasts</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; parallel broadcasts; &quot;</span>
</span><span id="__span-61-15"><a id="__codelineno-61-15" name="__codelineno-61-15" href="#__codelineno-61-15"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">mDispatcher</span><span class="p">.</span><span class="na">describeStateLocked</span><span class="p">());</span>
</span><span id="__span-61-16"><a id="__codelineno-61-16" name="__codelineno-61-16" href="#__codelineno-61-16"></a>
</span><span id="__span-61-17"><a id="__codelineno-61-17" name="__codelineno-61-17" href="#__codelineno-61-17"></a><span class="w">    </span><span class="n">mService</span><span class="p">.</span><span class="na">updateCpuStats</span><span class="p">();</span>
</span><span id="__span-61-18"><a id="__codelineno-61-18" name="__codelineno-61-18" href="#__codelineno-61-18"></a>
</span><span id="__span-61-19"><a id="__codelineno-61-19" name="__codelineno-61-19" href="#__codelineno-61-19"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fromMsg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-20"><a id="__codelineno-61-20" name="__codelineno-61-20" href="#__codelineno-61-20"></a><span class="w">        </span><span class="n">mBroadcastsScheduled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-61-21"><a id="__codelineno-61-21" name="__codelineno-61-21" href="#__codelineno-61-21"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-61-22"><a id="__codelineno-61-22" name="__codelineno-61-22" href="#__codelineno-61-22"></a>
</span><span id="__span-61-23"><a id="__codelineno-61-23" name="__codelineno-61-23" href="#__codelineno-61-23"></a><span class="w">    </span><span class="c1">// First, deliver any non-serialized broadcasts right away.</span>
</span><span id="__span-61-24"><a id="__codelineno-61-24" name="__codelineno-61-24" href="#__codelineno-61-24"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">mParallelBroadcasts</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-25"><a id="__codelineno-61-25" name="__codelineno-61-25" href="#__codelineno-61-25"></a><span class="w">        </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mParallelBroadcasts</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-61-26"><a id="__codelineno-61-26" name="__codelineno-61-26" href="#__codelineno-61-26"></a><span class="w">        </span><span class="n">r</span><span class="p">.</span><span class="na">dispatchTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SystemClock</span><span class="p">.</span><span class="na">uptimeMillis</span><span class="p">();</span>
</span><span id="__span-61-27"><a id="__codelineno-61-27" name="__codelineno-61-27" href="#__codelineno-61-27"></a><span class="w">        </span><span class="n">r</span><span class="p">.</span><span class="na">dispatchRealTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SystemClock</span><span class="p">.</span><span class="na">elapsedRealtime</span><span class="p">();</span>
</span><span id="__span-61-28"><a id="__codelineno-61-28" name="__codelineno-61-28" href="#__codelineno-61-28"></a><span class="w">        </span><span class="n">r</span><span class="p">.</span><span class="na">dispatchClockTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span>
</span><span id="__span-61-29"><a id="__codelineno-61-29" name="__codelineno-61-29" href="#__codelineno-61-29"></a>
</span><span id="__span-61-30"><a id="__codelineno-61-30" name="__codelineno-61-30" href="#__codelineno-61-30"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Trace</span><span class="p">.</span><span class="na">isTagEnabled</span><span class="p">(</span><span class="n">Trace</span><span class="p">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-31"><a id="__codelineno-61-31" name="__codelineno-61-31" href="#__codelineno-61-31"></a><span class="w">            </span><span class="n">Trace</span><span class="p">.</span><span class="na">asyncTraceEnd</span><span class="p">(</span><span class="n">Trace</span><span class="p">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="p">,</span>
</span><span id="__span-61-32"><a id="__codelineno-61-32" name="__codelineno-61-32" href="#__codelineno-61-32"></a><span class="w">                </span><span class="n">createBroadcastTraceTitle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">.</span><span class="na">DELIVERY_PENDING</span><span class="p">),</span>
</span><span id="__span-61-33"><a id="__codelineno-61-33" name="__codelineno-61-33" href="#__codelineno-61-33"></a><span class="w">                </span><span class="n">System</span><span class="p">.</span><span class="na">identityHashCode</span><span class="p">(</span><span class="n">r</span><span class="p">));</span>
</span><span id="__span-61-34"><a id="__codelineno-61-34" name="__codelineno-61-34" href="#__codelineno-61-34"></a><span class="w">            </span><span class="n">Trace</span><span class="p">.</span><span class="na">asyncTraceBegin</span><span class="p">(</span><span class="n">Trace</span><span class="p">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="p">,</span>
</span><span id="__span-61-35"><a id="__codelineno-61-35" name="__codelineno-61-35" href="#__codelineno-61-35"></a><span class="w">                </span><span class="n">createBroadcastTraceTitle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">.</span><span class="na">DELIVERY_DELIVERED</span><span class="p">),</span>
</span><span id="__span-61-36"><a id="__codelineno-61-36" name="__codelineno-61-36" href="#__codelineno-61-36"></a><span class="w">                </span><span class="n">System</span><span class="p">.</span><span class="na">identityHashCode</span><span class="p">(</span><span class="n">r</span><span class="p">));</span>
</span><span id="__span-61-37"><a id="__codelineno-61-37" name="__codelineno-61-37" href="#__codelineno-61-37"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-61-38"><a id="__codelineno-61-38" name="__codelineno-61-38" href="#__codelineno-61-38"></a>
</span><span id="__span-61-39"><a id="__codelineno-61-39" name="__codelineno-61-39" href="#__codelineno-61-39"></a><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">receivers</span><span class="p">.</span><span class="na">size</span><span class="p">();</span>
</span><span id="__span-61-40"><a id="__codelineno-61-40" name="__codelineno-61-40" href="#__codelineno-61-40"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST_LIGHT</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Processing parallel broadcast [&quot;</span>
</span><span id="__span-61-41"><a id="__codelineno-61-41" name="__codelineno-61-41" href="#__codelineno-61-41"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;] &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-61-42"><a id="__codelineno-61-42" name="__codelineno-61-42" href="#__codelineno-61-42"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-43"><a id="__codelineno-61-43" name="__codelineno-61-43" href="#__codelineno-61-43"></a><span class="w">            </span><span class="n">Object</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">receivers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-61-44"><a id="__codelineno-61-44" name="__codelineno-61-44" href="#__codelineno-61-44"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w">  </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span>
</span><span id="__span-61-45"><a id="__codelineno-61-45" name="__codelineno-61-45" href="#__codelineno-61-45"></a><span class="w">                    </span><span class="s">&quot;Delivering non-ordered on [&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;] to registered &quot;</span>
</span><span id="__span-61-46"><a id="__codelineno-61-46" name="__codelineno-61-46" href="#__codelineno-61-46"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-61-47"><a id="__codelineno-61-47" name="__codelineno-61-47" href="#__codelineno-61-47"></a><span class="w">            </span><span class="n">deliverToRegisteredReceiverLocked</span><span class="p">(</span><span class="n">r</span><span class="p">,</span>
</span><span id="__span-61-48"><a id="__codelineno-61-48" name="__codelineno-61-48" href="#__codelineno-61-48"></a><span class="w">                    </span><span class="p">(</span><span class="n">BroadcastFilter</span><span class="p">)</span><span class="w"> </span><span class="n">target</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-61-49"><a id="__codelineno-61-49" name="__codelineno-61-49" href="#__codelineno-61-49"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-61-50"><a id="__codelineno-61-50" name="__codelineno-61-50" href="#__codelineno-61-50"></a><span class="w">        </span><span class="n">addBroadcastToHistoryLocked</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-61-51"><a id="__codelineno-61-51" name="__codelineno-61-51" href="#__codelineno-61-51"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST_LIGHT</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Done with parallel broadcast [&quot;</span>
</span><span id="__span-61-52"><a id="__codelineno-61-52" name="__codelineno-61-52" href="#__codelineno-61-52"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;] &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-61-53"><a id="__codelineno-61-53" name="__codelineno-61-53" href="#__codelineno-61-53"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-61-54"><a id="__codelineno-61-54" name="__codelineno-61-54" href="#__codelineno-61-54"></a>
</span><span id="__span-61-55"><a id="__codelineno-61-55" name="__codelineno-61-55" href="#__codelineno-61-55"></a><span class="w">    </span><span class="c1">// Now take care of the next serialized one...</span>
</span><span id="__span-61-56"><a id="__codelineno-61-56" name="__codelineno-61-56" href="#__codelineno-61-56"></a>
</span><span id="__span-61-57"><a id="__codelineno-61-57" name="__codelineno-61-57" href="#__codelineno-61-57"></a><span class="w">    </span><span class="c1">// If we are waiting for a process to come up to handle the next</span>
</span><span id="__span-61-58"><a id="__codelineno-61-58" name="__codelineno-61-58" href="#__codelineno-61-58"></a><span class="w">    </span><span class="c1">// broadcast, then do nothing at this point.  Just in case, we</span>
</span><span id="__span-61-59"><a id="__codelineno-61-59" name="__codelineno-61-59" href="#__codelineno-61-59"></a><span class="w">    </span><span class="c1">// check that the process we&#39;re waiting for still exists.</span>
</span><span id="__span-61-60"><a id="__codelineno-61-60" name="__codelineno-61-60" href="#__codelineno-61-60"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mPendingBroadcast</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-61"><a id="__codelineno-61-61" name="__codelineno-61-61" href="#__codelineno-61-61"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST_LIGHT</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span>
</span><span id="__span-61-62"><a id="__codelineno-61-62" name="__codelineno-61-62" href="#__codelineno-61-62"></a><span class="w">                </span><span class="s">&quot;processNextBroadcast [&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;]: waiting for &quot;</span>
</span><span id="__span-61-63"><a id="__codelineno-61-63" name="__codelineno-61-63" href="#__codelineno-61-63"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">mPendingBroadcast</span><span class="p">.</span><span class="na">curApp</span><span class="p">);</span>
</span><span id="__span-61-64"><a id="__codelineno-61-64" name="__codelineno-61-64" href="#__codelineno-61-64"></a>
</span><span id="__span-61-65"><a id="__codelineno-61-65" name="__codelineno-61-65" href="#__codelineno-61-65"></a><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isDead</span><span class="p">;</span>
</span><span id="__span-61-66"><a id="__codelineno-61-66" name="__codelineno-61-66" href="#__codelineno-61-66"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mPendingBroadcast</span><span class="p">.</span><span class="na">curApp</span><span class="p">.</span><span class="na">getPid</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-67"><a id="__codelineno-61-67" name="__codelineno-61-67" href="#__codelineno-61-67"></a><span class="w">            </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mService</span><span class="p">.</span><span class="na">mPidsSelfLocked</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-68"><a id="__codelineno-61-68" name="__codelineno-61-68" href="#__codelineno-61-68"></a><span class="w">                </span><span class="n">ProcessRecord</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mService</span><span class="p">.</span><span class="na">mPidsSelfLocked</span><span class="p">.</span><span class="na">get</span><span class="p">(</span>
</span><span id="__span-61-69"><a id="__codelineno-61-69" name="__codelineno-61-69" href="#__codelineno-61-69"></a><span class="w">                        </span><span class="n">mPendingBroadcast</span><span class="p">.</span><span class="na">curApp</span><span class="p">.</span><span class="na">getPid</span><span class="p">());</span>
</span><span id="__span-61-70"><a id="__codelineno-61-70" name="__codelineno-61-70" href="#__codelineno-61-70"></a><span class="w">                </span><span class="n">isDead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">proc</span><span class="p">.</span><span class="na">mErrorState</span><span class="p">.</span><span class="na">isCrashing</span><span class="p">();</span>
</span><span id="__span-61-71"><a id="__codelineno-61-71" name="__codelineno-61-71" href="#__codelineno-61-71"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-61-72"><a id="__codelineno-61-72" name="__codelineno-61-72" href="#__codelineno-61-72"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-73"><a id="__codelineno-61-73" name="__codelineno-61-73" href="#__codelineno-61-73"></a><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">ProcessRecord</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mService</span><span class="p">.</span><span class="na">mProcessList</span><span class="p">.</span><span class="na">getProcessNamesLOSP</span><span class="p">().</span><span class="na">get</span><span class="p">(</span>
</span><span id="__span-61-74"><a id="__codelineno-61-74" name="__codelineno-61-74" href="#__codelineno-61-74"></a><span class="w">                    </span><span class="n">mPendingBroadcast</span><span class="p">.</span><span class="na">curApp</span><span class="p">.</span><span class="na">processName</span><span class="p">,</span><span class="w"> </span><span class="n">mPendingBroadcast</span><span class="p">.</span><span class="na">curApp</span><span class="p">.</span><span class="na">uid</span><span class="p">);</span>
</span><span id="__span-61-75"><a id="__codelineno-61-75" name="__codelineno-61-75" href="#__codelineno-61-75"></a><span class="w">            </span><span class="n">isDead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">proc</span><span class="p">.</span><span class="na">isPendingStart</span><span class="p">();</span>
</span><span id="__span-61-76"><a id="__codelineno-61-76" name="__codelineno-61-76" href="#__codelineno-61-76"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-61-77"><a id="__codelineno-61-77" name="__codelineno-61-77" href="#__codelineno-61-77"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isDead</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-78"><a id="__codelineno-61-78" name="__codelineno-61-78" href="#__codelineno-61-78"></a><span class="w">            </span><span class="c1">// It&#39;s still alive, so keep waiting</span>
</span><span id="__span-61-79"><a id="__codelineno-61-79" name="__codelineno-61-79" href="#__codelineno-61-79"></a><span class="w">            </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-61-80"><a id="__codelineno-61-80" name="__codelineno-61-80" href="#__codelineno-61-80"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-81"><a id="__codelineno-61-81" name="__codelineno-61-81" href="#__codelineno-61-81"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;pending app  [&quot;</span>
</span><span id="__span-61-82"><a id="__codelineno-61-82" name="__codelineno-61-82" href="#__codelineno-61-82"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;]&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mPendingBroadcast</span><span class="p">.</span><span class="na">curApp</span>
</span><span id="__span-61-83"><a id="__codelineno-61-83" name="__codelineno-61-83" href="#__codelineno-61-83"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; died before responding to broadcast&quot;</span><span class="p">);</span>
</span><span id="__span-61-84"><a id="__codelineno-61-84" name="__codelineno-61-84" href="#__codelineno-61-84"></a><span class="w">            </span><span class="n">mPendingBroadcast</span><span class="p">.</span><span class="na">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">.</span><span class="na">IDLE</span><span class="p">;</span>
</span><span id="__span-61-85"><a id="__codelineno-61-85" name="__codelineno-61-85" href="#__codelineno-61-85"></a><span class="w">            </span><span class="n">mPendingBroadcast</span><span class="p">.</span><span class="na">nextReceiver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mPendingBroadcastRecvIndex</span><span class="p">;</span>
</span><span id="__span-61-86"><a id="__codelineno-61-86" name="__codelineno-61-86" href="#__codelineno-61-86"></a><span class="w">            </span><span class="n">mPendingBroadcast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-61-87"><a id="__codelineno-61-87" name="__codelineno-61-87" href="#__codelineno-61-87"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-61-88"><a id="__codelineno-61-88" name="__codelineno-61-88" href="#__codelineno-61-88"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-61-89"><a id="__codelineno-61-89" name="__codelineno-61-89" href="#__codelineno-61-89"></a>
</span><span id="__span-61-90"><a id="__codelineno-61-90" name="__codelineno-61-90" href="#__codelineno-61-90"></a><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">looped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-61-91"><a id="__codelineno-61-91" name="__codelineno-61-91" href="#__codelineno-61-91"></a>
</span><span id="__span-61-92"><a id="__codelineno-61-92" name="__codelineno-61-92" href="#__codelineno-61-92"></a><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-93"><a id="__codelineno-61-93" name="__codelineno-61-93" href="#__codelineno-61-93"></a><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SystemClock</span><span class="p">.</span><span class="na">uptimeMillis</span><span class="p">();</span>
</span><span id="__span-61-94"><a id="__codelineno-61-94" name="__codelineno-61-94" href="#__codelineno-61-94"></a><span class="w">        </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mDispatcher</span><span class="p">.</span><span class="na">getNextBroadcastLocked</span><span class="p">(</span><span class="n">now</span><span class="p">);</span>
</span><span id="__span-61-95"><a id="__codelineno-61-95" name="__codelineno-61-95" href="#__codelineno-61-95"></a>
</span><span id="__span-61-96"><a id="__codelineno-61-96" name="__codelineno-61-96" href="#__codelineno-61-96"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-97"><a id="__codelineno-61-97" name="__codelineno-61-97" href="#__codelineno-61-97"></a><span class="w">            </span><span class="c1">// No more broadcasts are deliverable right now, so all done!</span>
</span><span id="__span-61-98"><a id="__codelineno-61-98" name="__codelineno-61-98" href="#__codelineno-61-98"></a><span class="w">            </span><span class="n">mDispatcher</span><span class="p">.</span><span class="na">scheduleDeferralCheckLocked</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span><span id="__span-61-99"><a id="__codelineno-61-99" name="__codelineno-61-99" href="#__codelineno-61-99"></a><span class="w">            </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mService</span><span class="p">.</span><span class="na">mAppProfiler</span><span class="p">.</span><span class="na">mProfilerLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-100"><a id="__codelineno-61-100" name="__codelineno-61-100" href="#__codelineno-61-100"></a><span class="w">                </span><span class="n">mService</span><span class="p">.</span><span class="na">mAppProfiler</span><span class="p">.</span><span class="na">scheduleAppGcsLPf</span><span class="p">();</span>
</span><span id="__span-61-101"><a id="__codelineno-61-101" name="__codelineno-61-101" href="#__codelineno-61-101"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-61-102"><a id="__codelineno-61-102" name="__codelineno-61-102" href="#__codelineno-61-102"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">looped</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">skipOomAdj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-103"><a id="__codelineno-61-103" name="__codelineno-61-103" href="#__codelineno-61-103"></a><span class="w">                </span><span class="c1">// If we had finished the last ordered broadcast, then</span>
</span><span id="__span-61-104"><a id="__codelineno-61-104" name="__codelineno-61-104" href="#__codelineno-61-104"></a><span class="w">                </span><span class="c1">// make sure all processes have correct oom and sched</span>
</span><span id="__span-61-105"><a id="__codelineno-61-105" name="__codelineno-61-105" href="#__codelineno-61-105"></a><span class="w">                </span><span class="c1">// adjustments.</span>
</span><span id="__span-61-106"><a id="__codelineno-61-106" name="__codelineno-61-106" href="#__codelineno-61-106"></a><span class="w">                </span><span class="n">mService</span><span class="p">.</span><span class="na">updateOomAdjPendingTargetsLocked</span><span class="p">(</span>
</span><span id="__span-61-107"><a id="__codelineno-61-107" name="__codelineno-61-107" href="#__codelineno-61-107"></a><span class="w">                        </span><span class="n">OomAdjuster</span><span class="p">.</span><span class="na">OOM_ADJ_REASON_START_RECEIVER</span><span class="p">);</span>
</span><span id="__span-61-108"><a id="__codelineno-61-108" name="__codelineno-61-108" href="#__codelineno-61-108"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-61-109"><a id="__codelineno-61-109" name="__codelineno-61-109" href="#__codelineno-61-109"></a>
</span><span id="__span-61-110"><a id="__codelineno-61-110" name="__codelineno-61-110" href="#__codelineno-61-110"></a><span class="w">            </span><span class="c1">// when we have no more ordered broadcast on this queue, stop logging</span>
</span><span id="__span-61-111"><a id="__codelineno-61-111" name="__codelineno-61-111" href="#__codelineno-61-111"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mService</span><span class="p">.</span><span class="na">mUserController</span><span class="p">.</span><span class="na">mBootCompleted</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mLogLatencyMetrics</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-112"><a id="__codelineno-61-112" name="__codelineno-61-112" href="#__codelineno-61-112"></a><span class="w">                </span><span class="n">mLogLatencyMetrics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-61-113"><a id="__codelineno-61-113" name="__codelineno-61-113" href="#__codelineno-61-113"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-61-114"><a id="__codelineno-61-114" name="__codelineno-61-114" href="#__codelineno-61-114"></a>
</span><span id="__span-61-115"><a id="__codelineno-61-115" name="__codelineno-61-115" href="#__codelineno-61-115"></a><span class="w">            </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-61-116"><a id="__codelineno-61-116" name="__codelineno-61-116" href="#__codelineno-61-116"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-61-117"><a id="__codelineno-61-117" name="__codelineno-61-117" href="#__codelineno-61-117"></a>
</span><span id="__span-61-118"><a id="__codelineno-61-118" name="__codelineno-61-118" href="#__codelineno-61-118"></a><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">forceReceive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-61-119"><a id="__codelineno-61-119" name="__codelineno-61-119" href="#__codelineno-61-119"></a>
</span><span id="__span-61-120"><a id="__codelineno-61-120" name="__codelineno-61-120" href="#__codelineno-61-120"></a><span class="w">        </span><span class="c1">// Ensure that even if something goes awry with the timeout</span>
</span><span id="__span-61-121"><a id="__codelineno-61-121" name="__codelineno-61-121" href="#__codelineno-61-121"></a><span class="w">        </span><span class="c1">// detection, we catch &quot;hung&quot; broadcasts here, discard them,</span>
</span><span id="__span-61-122"><a id="__codelineno-61-122" name="__codelineno-61-122" href="#__codelineno-61-122"></a><span class="w">        </span><span class="c1">// and continue to make progress.</span>
</span><span id="__span-61-123"><a id="__codelineno-61-123" name="__codelineno-61-123" href="#__codelineno-61-123"></a><span class="w">        </span><span class="c1">//</span>
</span><span id="__span-61-124"><a id="__codelineno-61-124" name="__codelineno-61-124" href="#__codelineno-61-124"></a><span class="w">        </span><span class="c1">// This is only done if the system is ready so that early-stage receivers</span>
</span><span id="__span-61-125"><a id="__codelineno-61-125" name="__codelineno-61-125" href="#__codelineno-61-125"></a><span class="w">        </span><span class="c1">// don&#39;t get executed with timeouts; and of course other timeout-</span>
</span><span id="__span-61-126"><a id="__codelineno-61-126" name="__codelineno-61-126" href="#__codelineno-61-126"></a><span class="w">        </span><span class="c1">// exempt broadcasts are ignored.</span>
</span><span id="__span-61-127"><a id="__codelineno-61-127" name="__codelineno-61-127" href="#__codelineno-61-127"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">numReceivers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">receivers</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">receivers</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-61-128"><a id="__codelineno-61-128" name="__codelineno-61-128" href="#__codelineno-61-128"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mService</span><span class="p">.</span><span class="na">mProcessesReady</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">r</span><span class="p">.</span><span class="na">timeoutExempt</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">dispatchTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-129"><a id="__codelineno-61-129" name="__codelineno-61-129" href="#__codelineno-61-129"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">numReceivers</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-61-130"><a id="__codelineno-61-130" name="__codelineno-61-130" href="#__codelineno-61-130"></a><span class="w">                    </span><span class="p">(</span><span class="n">now</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">dispatchTime</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">mConstants</span><span class="p">.</span><span class="na">TIMEOUT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numReceivers</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-131"><a id="__codelineno-61-131" name="__codelineno-61-131" href="#__codelineno-61-131"></a><span class="w">                </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Hung broadcast [&quot;</span>
</span><span id="__span-61-132"><a id="__codelineno-61-132" name="__codelineno-61-132" href="#__codelineno-61-132"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;] discarded after timeout failure:&quot;</span>
</span><span id="__span-61-133"><a id="__codelineno-61-133" name="__codelineno-61-133" href="#__codelineno-61-133"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; now=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">now</span>
</span><span id="__span-61-134"><a id="__codelineno-61-134" name="__codelineno-61-134" href="#__codelineno-61-134"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; dispatchTime=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">dispatchTime</span>
</span><span id="__span-61-135"><a id="__codelineno-61-135" name="__codelineno-61-135" href="#__codelineno-61-135"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; startTime=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">receiverTime</span>
</span><span id="__span-61-136"><a id="__codelineno-61-136" name="__codelineno-61-136" href="#__codelineno-61-136"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; intent=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span>
</span><span id="__span-61-137"><a id="__codelineno-61-137" name="__codelineno-61-137" href="#__codelineno-61-137"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; numReceivers=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">numReceivers</span>
</span><span id="__span-61-138"><a id="__codelineno-61-138" name="__codelineno-61-138" href="#__codelineno-61-138"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; nextReceiver=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">nextReceiver</span>
</span><span id="__span-61-139"><a id="__codelineno-61-139" name="__codelineno-61-139" href="#__codelineno-61-139"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; state=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">state</span><span class="p">);</span>
</span><span id="__span-61-140"><a id="__codelineno-61-140" name="__codelineno-61-140" href="#__codelineno-61-140"></a><span class="w">                </span><span class="n">broadcastTimeoutLocked</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w"> </span><span class="c1">// forcibly finish this broadcast</span>
</span><span id="__span-61-141"><a id="__codelineno-61-141" name="__codelineno-61-141" href="#__codelineno-61-141"></a><span class="w">                </span><span class="n">forceReceive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-61-142"><a id="__codelineno-61-142" name="__codelineno-61-142" href="#__codelineno-61-142"></a><span class="w">                </span><span class="n">r</span><span class="p">.</span><span class="na">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">.</span><span class="na">IDLE</span><span class="p">;</span>
</span><span id="__span-61-143"><a id="__codelineno-61-143" name="__codelineno-61-143" href="#__codelineno-61-143"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-61-144"><a id="__codelineno-61-144" name="__codelineno-61-144" href="#__codelineno-61-144"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-61-145"><a id="__codelineno-61-145" name="__codelineno-61-145" href="#__codelineno-61-145"></a>
</span><span id="__span-61-146"><a id="__codelineno-61-146" name="__codelineno-61-146" href="#__codelineno-61-146"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">state</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">.</span><span class="na">IDLE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-147"><a id="__codelineno-61-147" name="__codelineno-61-147" href="#__codelineno-61-147"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span>
</span><span id="__span-61-148"><a id="__codelineno-61-148" name="__codelineno-61-148" href="#__codelineno-61-148"></a><span class="w">                    </span><span class="s">&quot;processNextBroadcast(&quot;</span>
</span><span id="__span-61-149"><a id="__codelineno-61-149" name="__codelineno-61-149" href="#__codelineno-61-149"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;) called when not idle (state=&quot;</span>
</span><span id="__span-61-150"><a id="__codelineno-61-150" name="__codelineno-61-150" href="#__codelineno-61-150"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">state</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="p">);</span>
</span><span id="__span-61-151"><a id="__codelineno-61-151" name="__codelineno-61-151" href="#__codelineno-61-151"></a><span class="w">            </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-61-152"><a id="__codelineno-61-152" name="__codelineno-61-152" href="#__codelineno-61-152"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-61-153"><a id="__codelineno-61-153" name="__codelineno-61-153" href="#__codelineno-61-153"></a>
</span><span id="__span-61-154"><a id="__codelineno-61-154" name="__codelineno-61-154" href="#__codelineno-61-154"></a><span class="w">        </span><span class="c1">// Is the current broadcast is done for any reason?</span>
</span><span id="__span-61-155"><a id="__codelineno-61-155" name="__codelineno-61-155" href="#__codelineno-61-155"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">receivers</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">nextReceiver</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">numReceivers</span>
</span><span id="__span-61-156"><a id="__codelineno-61-156" name="__codelineno-61-156" href="#__codelineno-61-156"></a><span class="w">                </span><span class="o">||</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">resultAbort</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">forceReceive</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-157"><a id="__codelineno-61-157" name="__codelineno-61-157" href="#__codelineno-61-157"></a><span class="w">            </span><span class="c1">// Send the final result if requested</span>
</span><span id="__span-61-158"><a id="__codelineno-61-158" name="__codelineno-61-158" href="#__codelineno-61-158"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">resultTo</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-159"><a id="__codelineno-61-159" name="__codelineno-61-159" href="#__codelineno-61-159"></a><span class="w">                </span><span class="kt">boolean</span><span class="w"> </span><span class="n">sendResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-61-160"><a id="__codelineno-61-160" name="__codelineno-61-160" href="#__codelineno-61-160"></a>
</span><span id="__span-61-161"><a id="__codelineno-61-161" name="__codelineno-61-161" href="#__codelineno-61-161"></a><span class="w">                </span><span class="c1">// if this was part of a split/deferral complex, update the refcount and only</span>
</span><span id="__span-61-162"><a id="__codelineno-61-162" name="__codelineno-61-162" href="#__codelineno-61-162"></a><span class="w">                </span><span class="c1">// send the completion when we clear all of them</span>
</span><span id="__span-61-163"><a id="__codelineno-61-163" name="__codelineno-61-163" href="#__codelineno-61-163"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">splitToken</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-164"><a id="__codelineno-61-164" name="__codelineno-61-164" href="#__codelineno-61-164"></a><span class="w">                    </span><span class="kt">int</span><span class="w"> </span><span class="n">newCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mSplitRefcounts</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">splitToken</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-61-165"><a id="__codelineno-61-165" name="__codelineno-61-165" href="#__codelineno-61-165"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-166"><a id="__codelineno-61-166" name="__codelineno-61-166" href="#__codelineno-61-166"></a><span class="w">                        </span><span class="c1">// done!  clear out this record&#39;s bookkeeping and deliver</span>
</span><span id="__span-61-167"><a id="__codelineno-61-167" name="__codelineno-61-167" href="#__codelineno-61-167"></a><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST_DEFERRAL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-168"><a id="__codelineno-61-168" name="__codelineno-61-168" href="#__codelineno-61-168"></a><span class="w">                            </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span>
</span><span id="__span-61-169"><a id="__codelineno-61-169" name="__codelineno-61-169" href="#__codelineno-61-169"></a><span class="w">                                    </span><span class="s">&quot;Sending broadcast completion for split token &quot;</span>
</span><span id="__span-61-170"><a id="__codelineno-61-170" name="__codelineno-61-170" href="#__codelineno-61-170"></a><span class="w">                                    </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">splitToken</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; : &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">());</span>
</span><span id="__span-61-171"><a id="__codelineno-61-171" name="__codelineno-61-171" href="#__codelineno-61-171"></a><span class="w">                        </span><span class="p">}</span>
</span><span id="__span-61-172"><a id="__codelineno-61-172" name="__codelineno-61-172" href="#__codelineno-61-172"></a><span class="w">                        </span><span class="n">mSplitRefcounts</span><span class="p">.</span><span class="na">delete</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">splitToken</span><span class="p">);</span>
</span><span id="__span-61-173"><a id="__codelineno-61-173" name="__codelineno-61-173" href="#__codelineno-61-173"></a><span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-174"><a id="__codelineno-61-174" name="__codelineno-61-174" href="#__codelineno-61-174"></a><span class="w">                        </span><span class="c1">// still have some split broadcast records in flight; update refcount</span>
</span><span id="__span-61-175"><a id="__codelineno-61-175" name="__codelineno-61-175" href="#__codelineno-61-175"></a><span class="w">                        </span><span class="c1">// and hold off on the callback</span>
</span><span id="__span-61-176"><a id="__codelineno-61-176" name="__codelineno-61-176" href="#__codelineno-61-176"></a><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST_DEFERRAL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-177"><a id="__codelineno-61-177" name="__codelineno-61-177" href="#__codelineno-61-177"></a><span class="w">                            </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span>
</span><span id="__span-61-178"><a id="__codelineno-61-178" name="__codelineno-61-178" href="#__codelineno-61-178"></a><span class="w">                                    </span><span class="s">&quot;Result refcount now &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">newCount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; for split token &quot;</span>
</span><span id="__span-61-179"><a id="__codelineno-61-179" name="__codelineno-61-179" href="#__codelineno-61-179"></a><span class="w">                                    </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">splitToken</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; : &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">()</span>
</span><span id="__span-61-180"><a id="__codelineno-61-180" name="__codelineno-61-180" href="#__codelineno-61-180"></a><span class="w">                                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; - not sending completion yet&quot;</span><span class="p">);</span>
</span><span id="__span-61-181"><a id="__codelineno-61-181" name="__codelineno-61-181" href="#__codelineno-61-181"></a><span class="w">                        </span><span class="p">}</span>
</span><span id="__span-61-182"><a id="__codelineno-61-182" name="__codelineno-61-182" href="#__codelineno-61-182"></a><span class="w">                        </span><span class="n">sendResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-61-183"><a id="__codelineno-61-183" name="__codelineno-61-183" href="#__codelineno-61-183"></a><span class="w">                        </span><span class="n">mSplitRefcounts</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">splitToken</span><span class="p">,</span><span class="w"> </span><span class="n">newCount</span><span class="p">);</span>
</span><span id="__span-61-184"><a id="__codelineno-61-184" name="__codelineno-61-184" href="#__codelineno-61-184"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-61-185"><a id="__codelineno-61-185" name="__codelineno-61-185" href="#__codelineno-61-185"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-61-186"><a id="__codelineno-61-186" name="__codelineno-61-186" href="#__codelineno-61-186"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sendResult</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-187"><a id="__codelineno-61-187" name="__codelineno-61-187" href="#__codelineno-61-187"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">callerApp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-188"><a id="__codelineno-61-188" name="__codelineno-61-188" href="#__codelineno-61-188"></a><span class="w">                        </span><span class="n">mService</span><span class="p">.</span><span class="na">mOomAdjuster</span><span class="p">.</span><span class="na">mCachedAppOptimizer</span><span class="p">.</span><span class="na">unfreezeTemporarily</span><span class="p">(</span>
</span><span id="__span-61-189"><a id="__codelineno-61-189" name="__codelineno-61-189" href="#__codelineno-61-189"></a><span class="w">                                </span><span class="n">r</span><span class="p">.</span><span class="na">callerApp</span><span class="p">);</span>
</span><span id="__span-61-190"><a id="__codelineno-61-190" name="__codelineno-61-190" href="#__codelineno-61-190"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-61-191"><a id="__codelineno-61-191" name="__codelineno-61-191" href="#__codelineno-61-191"></a><span class="w">                    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-192"><a id="__codelineno-61-192" name="__codelineno-61-192" href="#__codelineno-61-192"></a><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-193"><a id="__codelineno-61-193" name="__codelineno-61-193" href="#__codelineno-61-193"></a><span class="w">                            </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Finishing broadcast [&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;] &quot;</span>
</span><span id="__span-61-194"><a id="__codelineno-61-194" name="__codelineno-61-194" href="#__codelineno-61-194"></a><span class="w">                                    </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; app=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callerApp</span><span class="p">);</span>
</span><span id="__span-61-195"><a id="__codelineno-61-195" name="__codelineno-61-195" href="#__codelineno-61-195"></a><span class="w">                        </span><span class="p">}</span>
</span><span id="__span-61-196"><a id="__codelineno-61-196" name="__codelineno-61-196" href="#__codelineno-61-196"></a><span class="w">                        </span><span class="n">performReceiveLocked</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">callerApp</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">resultTo</span><span class="p">,</span>
</span><span id="__span-61-197"><a id="__codelineno-61-197" name="__codelineno-61-197" href="#__codelineno-61-197"></a><span class="w">                                </span><span class="k">new</span><span class="w"> </span><span class="n">Intent</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">),</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">resultCode</span><span class="p">,</span>
</span><span id="__span-61-198"><a id="__codelineno-61-198" name="__codelineno-61-198" href="#__codelineno-61-198"></a><span class="w">                                </span><span class="n">r</span><span class="p">.</span><span class="na">resultData</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">resultExtras</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">userId</span><span class="p">,</span>
</span><span id="__span-61-199"><a id="__codelineno-61-199" name="__codelineno-61-199" href="#__codelineno-61-199"></a><span class="w">                                </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="p">);</span>
</span><span id="__span-61-200"><a id="__codelineno-61-200" name="__codelineno-61-200" href="#__codelineno-61-200"></a><span class="w">                        </span><span class="n">logBootCompletedBroadcastCompletionLatencyIfPossible</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-61-201"><a id="__codelineno-61-201" name="__codelineno-61-201" href="#__codelineno-61-201"></a><span class="w">                        </span><span class="c1">// Set this to null so that the reference</span>
</span><span id="__span-61-202"><a id="__codelineno-61-202" name="__codelineno-61-202" href="#__codelineno-61-202"></a><span class="w">                        </span><span class="c1">// (local and remote) isn&#39;t kept in the mBroadcastHistory.</span>
</span><span id="__span-61-203"><a id="__codelineno-61-203" name="__codelineno-61-203" href="#__codelineno-61-203"></a><span class="w">                        </span><span class="n">r</span><span class="p">.</span><span class="na">resultTo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-61-204"><a id="__codelineno-61-204" name="__codelineno-61-204" href="#__codelineno-61-204"></a><span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-205"><a id="__codelineno-61-205" name="__codelineno-61-205" href="#__codelineno-61-205"></a><span class="w">                        </span><span class="n">r</span><span class="p">.</span><span class="na">resultTo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-61-206"><a id="__codelineno-61-206" name="__codelineno-61-206" href="#__codelineno-61-206"></a><span class="w">                        </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Failure [&quot;</span>
</span><span id="__span-61-207"><a id="__codelineno-61-207" name="__codelineno-61-207" href="#__codelineno-61-207"></a><span class="w">                                </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;] sending broadcast result of &quot;</span>
</span><span id="__span-61-208"><a id="__codelineno-61-208" name="__codelineno-61-208" href="#__codelineno-61-208"></a><span class="w">                                </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
</span><span id="__span-61-209"><a id="__codelineno-61-209" name="__codelineno-61-209" href="#__codelineno-61-209"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-61-210"><a id="__codelineno-61-210" name="__codelineno-61-210" href="#__codelineno-61-210"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-61-211"><a id="__codelineno-61-211" name="__codelineno-61-211" href="#__codelineno-61-211"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-61-212"><a id="__codelineno-61-212" name="__codelineno-61-212" href="#__codelineno-61-212"></a>
</span><span id="__span-61-213"><a id="__codelineno-61-213" name="__codelineno-61-213" href="#__codelineno-61-213"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Cancelling BROADCAST_TIMEOUT_MSG&quot;</span><span class="p">);</span>
</span><span id="__span-61-214"><a id="__codelineno-61-214" name="__codelineno-61-214" href="#__codelineno-61-214"></a><span class="w">            </span><span class="n">cancelBroadcastTimeoutLocked</span><span class="p">();</span>
</span><span id="__span-61-215"><a id="__codelineno-61-215" name="__codelineno-61-215" href="#__codelineno-61-215"></a>
</span><span id="__span-61-216"><a id="__codelineno-61-216" name="__codelineno-61-216" href="#__codelineno-61-216"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST_LIGHT</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span>
</span><span id="__span-61-217"><a id="__codelineno-61-217" name="__codelineno-61-217" href="#__codelineno-61-217"></a><span class="w">                    </span><span class="s">&quot;Finished with ordered broadcast &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-61-218"><a id="__codelineno-61-218" name="__codelineno-61-218" href="#__codelineno-61-218"></a>
</span><span id="__span-61-219"><a id="__codelineno-61-219" name="__codelineno-61-219" href="#__codelineno-61-219"></a><span class="w">            </span><span class="c1">// ... and on to the next...</span>
</span><span id="__span-61-220"><a id="__codelineno-61-220" name="__codelineno-61-220" href="#__codelineno-61-220"></a><span class="w">            </span><span class="n">addBroadcastToHistoryLocked</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-61-221"><a id="__codelineno-61-221" name="__codelineno-61-221" href="#__codelineno-61-221"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getComponent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getPackage</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span>
</span><span id="__span-61-222"><a id="__codelineno-61-222" name="__codelineno-61-222" href="#__codelineno-61-222"></a><span class="w">                    </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getFlags</span><span class="p">()</span><span class="o">&amp;</span><span class="n">Intent</span><span class="p">.</span><span class="na">FLAG_RECEIVER_REGISTERED_ONLY</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-223"><a id="__codelineno-61-223" name="__codelineno-61-223" href="#__codelineno-61-223"></a><span class="w">                </span><span class="c1">// This was an implicit broadcast... let&#39;s record it for posterity.</span>
</span><span id="__span-61-224"><a id="__codelineno-61-224" name="__codelineno-61-224" href="#__codelineno-61-224"></a><span class="w">                </span><span class="n">mService</span><span class="p">.</span><span class="na">addBroadcastStatLocked</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">(),</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callerPackage</span><span class="p">,</span>
</span><span id="__span-61-225"><a id="__codelineno-61-225" name="__codelineno-61-225" href="#__codelineno-61-225"></a><span class="w">                        </span><span class="n">r</span><span class="p">.</span><span class="na">manifestCount</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">manifestSkipCount</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">finishTime</span><span class="o">-</span><span class="n">r</span><span class="p">.</span><span class="na">dispatchTime</span><span class="p">);</span>
</span><span id="__span-61-226"><a id="__codelineno-61-226" name="__codelineno-61-226" href="#__codelineno-61-226"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-61-227"><a id="__codelineno-61-227" name="__codelineno-61-227" href="#__codelineno-61-227"></a><span class="w">            </span><span class="n">mDispatcher</span><span class="p">.</span><span class="na">retireBroadcastLocked</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-61-228"><a id="__codelineno-61-228" name="__codelineno-61-228" href="#__codelineno-61-228"></a><span class="w">            </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-61-229"><a id="__codelineno-61-229" name="__codelineno-61-229" href="#__codelineno-61-229"></a><span class="w">            </span><span class="n">looped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-61-230"><a id="__codelineno-61-230" name="__codelineno-61-230" href="#__codelineno-61-230"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-61-231"><a id="__codelineno-61-231" name="__codelineno-61-231" href="#__codelineno-61-231"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-61-232"><a id="__codelineno-61-232" name="__codelineno-61-232" href="#__codelineno-61-232"></a>
</span><span id="__span-61-233"><a id="__codelineno-61-233" name="__codelineno-61-233" href="#__codelineno-61-233"></a><span class="w">        </span><span class="c1">// Check whether the next receiver is under deferral policy, and handle that</span>
</span><span id="__span-61-234"><a id="__codelineno-61-234" name="__codelineno-61-234" href="#__codelineno-61-234"></a><span class="w">        </span><span class="c1">// accordingly.  If the current broadcast was already part of deferred-delivery</span>
</span><span id="__span-61-235"><a id="__codelineno-61-235" name="__codelineno-61-235" href="#__codelineno-61-235"></a><span class="w">        </span><span class="c1">// tracking, we know that it must now be deliverable as-is without re-deferral.</span>
</span><span id="__span-61-236"><a id="__codelineno-61-236" name="__codelineno-61-236" href="#__codelineno-61-236"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">.</span><span class="na">deferred</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-237"><a id="__codelineno-61-237" name="__codelineno-61-237" href="#__codelineno-61-237"></a><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">receiverUid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">getReceiverUid</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">receivers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">nextReceiver</span><span class="p">));</span>
</span><span id="__span-61-238"><a id="__codelineno-61-238" name="__codelineno-61-238" href="#__codelineno-61-238"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mDispatcher</span><span class="p">.</span><span class="na">isDeferringLocked</span><span class="p">(</span><span class="n">receiverUid</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-239"><a id="__codelineno-61-239" name="__codelineno-61-239" href="#__codelineno-61-239"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST_DEFERRAL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-240"><a id="__codelineno-61-240" name="__codelineno-61-240" href="#__codelineno-61-240"></a><span class="w">                    </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Next receiver in &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; uid &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">receiverUid</span>
</span><span id="__span-61-241"><a id="__codelineno-61-241" name="__codelineno-61-241" href="#__codelineno-61-241"></a><span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; at &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">nextReceiver</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; is under deferral&quot;</span><span class="p">);</span>
</span><span id="__span-61-242"><a id="__codelineno-61-242" name="__codelineno-61-242" href="#__codelineno-61-242"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-61-243"><a id="__codelineno-61-243" name="__codelineno-61-243" href="#__codelineno-61-243"></a><span class="w">                </span><span class="c1">// If this is the only (remaining) receiver in the broadcast, &quot;splitting&quot;</span>
</span><span id="__span-61-244"><a id="__codelineno-61-244" name="__codelineno-61-244" href="#__codelineno-61-244"></a><span class="w">                </span><span class="c1">// doesn&#39;t make sense -- just defer it as-is and retire it as the</span>
</span><span id="__span-61-245"><a id="__codelineno-61-245" name="__codelineno-61-245" href="#__codelineno-61-245"></a><span class="w">                </span><span class="c1">// currently active outgoing broadcast.</span>
</span><span id="__span-61-246"><a id="__codelineno-61-246" name="__codelineno-61-246" href="#__codelineno-61-246"></a><span class="w">                </span><span class="n">BroadcastRecord</span><span class="w"> </span><span class="n">defer</span><span class="p">;</span>
</span><span id="__span-61-247"><a id="__codelineno-61-247" name="__codelineno-61-247" href="#__codelineno-61-247"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">nextReceiver</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">numReceivers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-248"><a id="__codelineno-61-248" name="__codelineno-61-248" href="#__codelineno-61-248"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST_DEFERRAL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-249"><a id="__codelineno-61-249" name="__codelineno-61-249" href="#__codelineno-61-249"></a><span class="w">                        </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Sole receiver of &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span>
</span><span id="__span-61-250"><a id="__codelineno-61-250" name="__codelineno-61-250" href="#__codelineno-61-250"></a><span class="w">                                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; is under deferral; setting aside and proceeding&quot;</span><span class="p">);</span>
</span><span id="__span-61-251"><a id="__codelineno-61-251" name="__codelineno-61-251" href="#__codelineno-61-251"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-61-252"><a id="__codelineno-61-252" name="__codelineno-61-252" href="#__codelineno-61-252"></a><span class="w">                    </span><span class="n">defer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">;</span>
</span><span id="__span-61-253"><a id="__codelineno-61-253" name="__codelineno-61-253" href="#__codelineno-61-253"></a><span class="w">                    </span><span class="n">mDispatcher</span><span class="p">.</span><span class="na">retireBroadcastLocked</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-61-254"><a id="__codelineno-61-254" name="__codelineno-61-254" href="#__codelineno-61-254"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-255"><a id="__codelineno-61-255" name="__codelineno-61-255" href="#__codelineno-61-255"></a><span class="w">                    </span><span class="c1">// Nontrivial case; split out &#39;uid&#39;s receivers to a new broadcast record</span>
</span><span id="__span-61-256"><a id="__codelineno-61-256" name="__codelineno-61-256" href="#__codelineno-61-256"></a><span class="w">                    </span><span class="c1">// and defer that, then loop and pick up continuing delivery of the current</span>
</span><span id="__span-61-257"><a id="__codelineno-61-257" name="__codelineno-61-257" href="#__codelineno-61-257"></a><span class="w">                    </span><span class="c1">// record (now absent those receivers).</span>
</span><span id="__span-61-258"><a id="__codelineno-61-258" name="__codelineno-61-258" href="#__codelineno-61-258"></a>
</span><span id="__span-61-259"><a id="__codelineno-61-259" name="__codelineno-61-259" href="#__codelineno-61-259"></a><span class="w">                    </span><span class="c1">// The split operation is guaranteed to match at least at &#39;nextReceiver&#39;</span>
</span><span id="__span-61-260"><a id="__codelineno-61-260" name="__codelineno-61-260" href="#__codelineno-61-260"></a><span class="w">                    </span><span class="n">defer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">splitRecipientsLocked</span><span class="p">(</span><span class="n">receiverUid</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">nextReceiver</span><span class="p">);</span>
</span><span id="__span-61-261"><a id="__codelineno-61-261" name="__codelineno-61-261" href="#__codelineno-61-261"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST_DEFERRAL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-262"><a id="__codelineno-61-262" name="__codelineno-61-262" href="#__codelineno-61-262"></a><span class="w">                        </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Post split:&quot;</span><span class="p">);</span>
</span><span id="__span-61-263"><a id="__codelineno-61-263" name="__codelineno-61-263" href="#__codelineno-61-263"></a><span class="w">                        </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Original broadcast receivers:&quot;</span><span class="p">);</span>
</span><span id="__span-61-264"><a id="__codelineno-61-264" name="__codelineno-61-264" href="#__codelineno-61-264"></a><span class="w">                        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">receivers</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-265"><a id="__codelineno-61-265" name="__codelineno-61-265" href="#__codelineno-61-265"></a><span class="w">                            </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;  &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">receivers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
</span><span id="__span-61-266"><a id="__codelineno-61-266" name="__codelineno-61-266" href="#__codelineno-61-266"></a><span class="w">                        </span><span class="p">}</span>
</span><span id="__span-61-267"><a id="__codelineno-61-267" name="__codelineno-61-267" href="#__codelineno-61-267"></a><span class="w">                        </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Split receivers:&quot;</span><span class="p">);</span>
</span><span id="__span-61-268"><a id="__codelineno-61-268" name="__codelineno-61-268" href="#__codelineno-61-268"></a><span class="w">                        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">defer</span><span class="p">.</span><span class="na">receivers</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-269"><a id="__codelineno-61-269" name="__codelineno-61-269" href="#__codelineno-61-269"></a><span class="w">                            </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;  &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">defer</span><span class="p">.</span><span class="na">receivers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
</span><span id="__span-61-270"><a id="__codelineno-61-270" name="__codelineno-61-270" href="#__codelineno-61-270"></a><span class="w">                        </span><span class="p">}</span>
</span><span id="__span-61-271"><a id="__codelineno-61-271" name="__codelineno-61-271" href="#__codelineno-61-271"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-61-272"><a id="__codelineno-61-272" name="__codelineno-61-272" href="#__codelineno-61-272"></a><span class="w">                    </span><span class="c1">// Track completion refcount as well if relevant</span>
</span><span id="__span-61-273"><a id="__codelineno-61-273" name="__codelineno-61-273" href="#__codelineno-61-273"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">resultTo</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-274"><a id="__codelineno-61-274" name="__codelineno-61-274" href="#__codelineno-61-274"></a><span class="w">                        </span><span class="kt">int</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">splitToken</span><span class="p">;</span>
</span><span id="__span-61-275"><a id="__codelineno-61-275" name="__codelineno-61-275" href="#__codelineno-61-275"></a><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">token</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-276"><a id="__codelineno-61-276" name="__codelineno-61-276" href="#__codelineno-61-276"></a><span class="w">                            </span><span class="c1">// first split of this record; refcount for &#39;r&#39; and &#39;deferred&#39;</span>
</span><span id="__span-61-277"><a id="__codelineno-61-277" name="__codelineno-61-277" href="#__codelineno-61-277"></a><span class="w">                            </span><span class="n">r</span><span class="p">.</span><span class="na">splitToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">defer</span><span class="p">.</span><span class="na">splitToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nextSplitTokenLocked</span><span class="p">();</span>
</span><span id="__span-61-278"><a id="__codelineno-61-278" name="__codelineno-61-278" href="#__codelineno-61-278"></a><span class="w">                            </span><span class="n">mSplitRefcounts</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">splitToken</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
</span><span id="__span-61-279"><a id="__codelineno-61-279" name="__codelineno-61-279" href="#__codelineno-61-279"></a><span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST_DEFERRAL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-280"><a id="__codelineno-61-280" name="__codelineno-61-280" href="#__codelineno-61-280"></a><span class="w">                                </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span>
</span><span id="__span-61-281"><a id="__codelineno-61-281" name="__codelineno-61-281" href="#__codelineno-61-281"></a><span class="w">                                        </span><span class="s">&quot;Broadcast needs split refcount; using new token &quot;</span>
</span><span id="__span-61-282"><a id="__codelineno-61-282" name="__codelineno-61-282" href="#__codelineno-61-282"></a><span class="w">                                        </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">splitToken</span><span class="p">);</span>
</span><span id="__span-61-283"><a id="__codelineno-61-283" name="__codelineno-61-283" href="#__codelineno-61-283"></a><span class="w">                            </span><span class="p">}</span>
</span><span id="__span-61-284"><a id="__codelineno-61-284" name="__codelineno-61-284" href="#__codelineno-61-284"></a><span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-285"><a id="__codelineno-61-285" name="__codelineno-61-285" href="#__codelineno-61-285"></a><span class="w">                            </span><span class="c1">// new split from an already-refcounted situation; increment count</span>
</span><span id="__span-61-286"><a id="__codelineno-61-286" name="__codelineno-61-286" href="#__codelineno-61-286"></a><span class="w">                            </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">curCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mSplitRefcounts</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
</span><span id="__span-61-287"><a id="__codelineno-61-287" name="__codelineno-61-287" href="#__codelineno-61-287"></a><span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST_DEFERRAL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-288"><a id="__codelineno-61-288" name="__codelineno-61-288" href="#__codelineno-61-288"></a><span class="w">                                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">curCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-289"><a id="__codelineno-61-289" name="__codelineno-61-289" href="#__codelineno-61-289"></a><span class="w">                                    </span><span class="n">Slog</span><span class="p">.</span><span class="na">wtf</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span>
</span><span id="__span-61-290"><a id="__codelineno-61-290" name="__codelineno-61-290" href="#__codelineno-61-290"></a><span class="w">                                            </span><span class="s">&quot;Split refcount is zero with token for &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-61-291"><a id="__codelineno-61-291" name="__codelineno-61-291" href="#__codelineno-61-291"></a><span class="w">                                </span><span class="p">}</span>
</span><span id="__span-61-292"><a id="__codelineno-61-292" name="__codelineno-61-292" href="#__codelineno-61-292"></a><span class="w">                            </span><span class="p">}</span>
</span><span id="__span-61-293"><a id="__codelineno-61-293" name="__codelineno-61-293" href="#__codelineno-61-293"></a><span class="w">                            </span><span class="n">mSplitRefcounts</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">token</span><span class="p">,</span><span class="w"> </span><span class="n">curCount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-61-294"><a id="__codelineno-61-294" name="__codelineno-61-294" href="#__codelineno-61-294"></a><span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST_DEFERRAL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-295"><a id="__codelineno-61-295" name="__codelineno-61-295" href="#__codelineno-61-295"></a><span class="w">                                </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;New split count for token &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">token</span>
</span><span id="__span-61-296"><a id="__codelineno-61-296" name="__codelineno-61-296" href="#__codelineno-61-296"></a><span class="w">                                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; is &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">curCount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
</span><span id="__span-61-297"><a id="__codelineno-61-297" name="__codelineno-61-297" href="#__codelineno-61-297"></a><span class="w">                            </span><span class="p">}</span>
</span><span id="__span-61-298"><a id="__codelineno-61-298" name="__codelineno-61-298" href="#__codelineno-61-298"></a><span class="w">                        </span><span class="p">}</span>
</span><span id="__span-61-299"><a id="__codelineno-61-299" name="__codelineno-61-299" href="#__codelineno-61-299"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-61-300"><a id="__codelineno-61-300" name="__codelineno-61-300" href="#__codelineno-61-300"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-61-301"><a id="__codelineno-61-301" name="__codelineno-61-301" href="#__codelineno-61-301"></a><span class="w">                </span><span class="n">mDispatcher</span><span class="p">.</span><span class="na">addDeferredBroadcast</span><span class="p">(</span><span class="n">receiverUid</span><span class="p">,</span><span class="w"> </span><span class="n">defer</span><span class="p">);</span>
</span><span id="__span-61-302"><a id="__codelineno-61-302" name="__codelineno-61-302" href="#__codelineno-61-302"></a><span class="w">                </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-61-303"><a id="__codelineno-61-303" name="__codelineno-61-303" href="#__codelineno-61-303"></a><span class="w">                </span><span class="n">looped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-61-304"><a id="__codelineno-61-304" name="__codelineno-61-304" href="#__codelineno-61-304"></a><span class="w">                </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-61-305"><a id="__codelineno-61-305" name="__codelineno-61-305" href="#__codelineno-61-305"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-61-306"><a id="__codelineno-61-306" name="__codelineno-61-306" href="#__codelineno-61-306"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-61-307"><a id="__codelineno-61-307" name="__codelineno-61-307" href="#__codelineno-61-307"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
</span><span id="__span-61-308"><a id="__codelineno-61-308" name="__codelineno-61-308" href="#__codelineno-61-308"></a>
</span><span id="__span-61-309"><a id="__codelineno-61-309" name="__codelineno-61-309" href="#__codelineno-61-309"></a><span class="w">    </span><span class="c1">// Get the next receiver...</span>
</span><span id="__span-61-310"><a id="__codelineno-61-310" name="__codelineno-61-310" href="#__codelineno-61-310"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">recIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">nextReceiver</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-61-311"><a id="__codelineno-61-311" name="__codelineno-61-311" href="#__codelineno-61-311"></a>
</span><span id="__span-61-312"><a id="__codelineno-61-312" name="__codelineno-61-312" href="#__codelineno-61-312"></a><span class="w">    </span><span class="c1">// Keep track of when this receiver started, and make sure there</span>
</span><span id="__span-61-313"><a id="__codelineno-61-313" name="__codelineno-61-313" href="#__codelineno-61-313"></a><span class="w">    </span><span class="c1">// is a timeout message pending to kill it if need be.</span>
</span><span id="__span-61-314"><a id="__codelineno-61-314" name="__codelineno-61-314" href="#__codelineno-61-314"></a><span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="na">receiverTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SystemClock</span><span class="p">.</span><span class="na">uptimeMillis</span><span class="p">();</span>
</span><span id="__span-61-315"><a id="__codelineno-61-315" name="__codelineno-61-315" href="#__codelineno-61-315"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">recIdx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-316"><a id="__codelineno-61-316" name="__codelineno-61-316" href="#__codelineno-61-316"></a><span class="w">        </span><span class="n">r</span><span class="p">.</span><span class="na">dispatchTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">receiverTime</span><span class="p">;</span>
</span><span id="__span-61-317"><a id="__codelineno-61-317" name="__codelineno-61-317" href="#__codelineno-61-317"></a><span class="w">        </span><span class="n">r</span><span class="p">.</span><span class="na">dispatchRealTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SystemClock</span><span class="p">.</span><span class="na">elapsedRealtime</span><span class="p">();</span>
</span><span id="__span-61-318"><a id="__codelineno-61-318" name="__codelineno-61-318" href="#__codelineno-61-318"></a><span class="w">        </span><span class="n">r</span><span class="p">.</span><span class="na">dispatchClockTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span>
</span><span id="__span-61-319"><a id="__codelineno-61-319" name="__codelineno-61-319" href="#__codelineno-61-319"></a>
</span><span id="__span-61-320"><a id="__codelineno-61-320" name="__codelineno-61-320" href="#__codelineno-61-320"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mLogLatencyMetrics</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-321"><a id="__codelineno-61-321" name="__codelineno-61-321" href="#__codelineno-61-321"></a><span class="w">            </span><span class="n">FrameworkStatsLog</span><span class="p">.</span><span class="na">write</span><span class="p">(</span>
</span><span id="__span-61-322"><a id="__codelineno-61-322" name="__codelineno-61-322" href="#__codelineno-61-322"></a><span class="w">                    </span><span class="n">FrameworkStatsLog</span><span class="p">.</span><span class="na">BROADCAST_DISPATCH_LATENCY_REPORTED</span><span class="p">,</span>
</span><span id="__span-61-323"><a id="__codelineno-61-323" name="__codelineno-61-323" href="#__codelineno-61-323"></a><span class="w">                    </span><span class="n">r</span><span class="p">.</span><span class="na">dispatchClockTime</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">enqueueClockTime</span><span class="p">);</span>
</span><span id="__span-61-324"><a id="__codelineno-61-324" name="__codelineno-61-324" href="#__codelineno-61-324"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-61-325"><a id="__codelineno-61-325" name="__codelineno-61-325" href="#__codelineno-61-325"></a>
</span><span id="__span-61-326"><a id="__codelineno-61-326" name="__codelineno-61-326" href="#__codelineno-61-326"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Trace</span><span class="p">.</span><span class="na">isTagEnabled</span><span class="p">(</span><span class="n">Trace</span><span class="p">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-327"><a id="__codelineno-61-327" name="__codelineno-61-327" href="#__codelineno-61-327"></a><span class="w">            </span><span class="n">Trace</span><span class="p">.</span><span class="na">asyncTraceEnd</span><span class="p">(</span><span class="n">Trace</span><span class="p">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="p">,</span>
</span><span id="__span-61-328"><a id="__codelineno-61-328" name="__codelineno-61-328" href="#__codelineno-61-328"></a><span class="w">                </span><span class="n">createBroadcastTraceTitle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">.</span><span class="na">DELIVERY_PENDING</span><span class="p">),</span>
</span><span id="__span-61-329"><a id="__codelineno-61-329" name="__codelineno-61-329" href="#__codelineno-61-329"></a><span class="w">                </span><span class="n">System</span><span class="p">.</span><span class="na">identityHashCode</span><span class="p">(</span><span class="n">r</span><span class="p">));</span>
</span><span id="__span-61-330"><a id="__codelineno-61-330" name="__codelineno-61-330" href="#__codelineno-61-330"></a><span class="w">            </span><span class="n">Trace</span><span class="p">.</span><span class="na">asyncTraceBegin</span><span class="p">(</span><span class="n">Trace</span><span class="p">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="p">,</span>
</span><span id="__span-61-331"><a id="__codelineno-61-331" name="__codelineno-61-331" href="#__codelineno-61-331"></a><span class="w">                </span><span class="n">createBroadcastTraceTitle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">.</span><span class="na">DELIVERY_DELIVERED</span><span class="p">),</span>
</span><span id="__span-61-332"><a id="__codelineno-61-332" name="__codelineno-61-332" href="#__codelineno-61-332"></a><span class="w">                </span><span class="n">System</span><span class="p">.</span><span class="na">identityHashCode</span><span class="p">(</span><span class="n">r</span><span class="p">));</span>
</span><span id="__span-61-333"><a id="__codelineno-61-333" name="__codelineno-61-333" href="#__codelineno-61-333"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-61-334"><a id="__codelineno-61-334" name="__codelineno-61-334" href="#__codelineno-61-334"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST_LIGHT</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Processing ordered broadcast [&quot;</span>
</span><span id="__span-61-335"><a id="__codelineno-61-335" name="__codelineno-61-335" href="#__codelineno-61-335"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;] &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-61-336"><a id="__codelineno-61-336" name="__codelineno-61-336" href="#__codelineno-61-336"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-61-337"><a id="__codelineno-61-337" name="__codelineno-61-337" href="#__codelineno-61-337"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="w"> </span><span class="n">mPendingBroadcastTimeoutMessage</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-338"><a id="__codelineno-61-338" name="__codelineno-61-338" href="#__codelineno-61-338"></a><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">timeoutTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">receiverTime</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mConstants</span><span class="p">.</span><span class="na">TIMEOUT</span><span class="p">;</span>
</span><span id="__span-61-339"><a id="__codelineno-61-339" name="__codelineno-61-339" href="#__codelineno-61-339"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span>
</span><span id="__span-61-340"><a id="__codelineno-61-340" name="__codelineno-61-340" href="#__codelineno-61-340"></a><span class="w">                </span><span class="s">&quot;Submitting BROADCAST_TIMEOUT_MSG [&quot;</span>
</span><span id="__span-61-341"><a id="__codelineno-61-341" name="__codelineno-61-341" href="#__codelineno-61-341"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;] for &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; at &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">timeoutTime</span><span class="p">);</span>
</span><span id="__span-61-342"><a id="__codelineno-61-342" name="__codelineno-61-342" href="#__codelineno-61-342"></a><span class="w">        </span><span class="n">setBroadcastTimeoutLocked</span><span class="p">(</span><span class="n">timeoutTime</span><span class="p">);</span>
</span><span id="__span-61-343"><a id="__codelineno-61-343" name="__codelineno-61-343" href="#__codelineno-61-343"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-61-344"><a id="__codelineno-61-344" name="__codelineno-61-344" href="#__codelineno-61-344"></a>
</span><span id="__span-61-345"><a id="__codelineno-61-345" name="__codelineno-61-345" href="#__codelineno-61-345"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">BroadcastOptions</span><span class="w"> </span><span class="n">brOptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">options</span><span class="p">;</span>
</span><span id="__span-61-346"><a id="__codelineno-61-346" name="__codelineno-61-346" href="#__codelineno-61-346"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">nextReceiver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">receivers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">recIdx</span><span class="p">);</span>
</span><span id="__span-61-347"><a id="__codelineno-61-347" name="__codelineno-61-347" href="#__codelineno-61-347"></a>
</span><span id="__span-61-348"><a id="__codelineno-61-348" name="__codelineno-61-348" href="#__codelineno-61-348"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nextReceiver</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">BroadcastFilter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-349"><a id="__codelineno-61-349" name="__codelineno-61-349" href="#__codelineno-61-349"></a><span class="w">        </span><span class="c1">// Simple case: this is a registered receiver who gets</span>
</span><span id="__span-61-350"><a id="__codelineno-61-350" name="__codelineno-61-350" href="#__codelineno-61-350"></a><span class="w">        </span><span class="c1">// a direct call.</span>
</span><span id="__span-61-351"><a id="__codelineno-61-351" name="__codelineno-61-351" href="#__codelineno-61-351"></a><span class="w">        </span><span class="n">BroadcastFilter</span><span class="w"> </span><span class="n">filter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">BroadcastFilter</span><span class="p">)</span><span class="n">nextReceiver</span><span class="p">;</span>
</span><span id="__span-61-352"><a id="__codelineno-61-352" name="__codelineno-61-352" href="#__codelineno-61-352"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w">  </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span>
</span><span id="__span-61-353"><a id="__codelineno-61-353" name="__codelineno-61-353" href="#__codelineno-61-353"></a><span class="w">                </span><span class="s">&quot;Delivering ordered [&quot;</span>
</span><span id="__span-61-354"><a id="__codelineno-61-354" name="__codelineno-61-354" href="#__codelineno-61-354"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;] to registered &quot;</span>
</span><span id="__span-61-355"><a id="__codelineno-61-355" name="__codelineno-61-355" href="#__codelineno-61-355"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">filter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-61-356"><a id="__codelineno-61-356" name="__codelineno-61-356" href="#__codelineno-61-356"></a><span class="w">        </span><span class="n">deliverToRegisteredReceiverLocked</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">filter</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">ordered</span><span class="p">,</span><span class="w"> </span><span class="n">recIdx</span><span class="p">);</span>
</span><span id="__span-61-357"><a id="__codelineno-61-357" name="__codelineno-61-357" href="#__codelineno-61-357"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">receiver</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">r</span><span class="p">.</span><span class="na">ordered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-358"><a id="__codelineno-61-358" name="__codelineno-61-358" href="#__codelineno-61-358"></a><span class="w">            </span><span class="c1">// The receiver has already finished, so schedule to</span>
</span><span id="__span-61-359"><a id="__codelineno-61-359" name="__codelineno-61-359" href="#__codelineno-61-359"></a><span class="w">            </span><span class="c1">// process the next one.</span>
</span><span id="__span-61-360"><a id="__codelineno-61-360" name="__codelineno-61-360" href="#__codelineno-61-360"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Quick finishing [&quot;</span>
</span><span id="__span-61-361"><a id="__codelineno-61-361" name="__codelineno-61-361" href="#__codelineno-61-361"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;]: ordered=&quot;</span>
</span><span id="__span-61-362"><a id="__codelineno-61-362" name="__codelineno-61-362" href="#__codelineno-61-362"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">ordered</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; receiver=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">receiver</span><span class="p">);</span>
</span><span id="__span-61-363"><a id="__codelineno-61-363" name="__codelineno-61-363" href="#__codelineno-61-363"></a><span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="na">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">.</span><span class="na">IDLE</span><span class="p">;</span>
</span><span id="__span-61-364"><a id="__codelineno-61-364" name="__codelineno-61-364" href="#__codelineno-61-364"></a><span class="w">            </span><span class="n">scheduleBroadcastsLocked</span><span class="p">();</span>
</span><span id="__span-61-365"><a id="__codelineno-61-365" name="__codelineno-61-365" href="#__codelineno-61-365"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-366"><a id="__codelineno-61-366" name="__codelineno-61-366" href="#__codelineno-61-366"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-367"><a id="__codelineno-61-367" name="__codelineno-61-367" href="#__codelineno-61-367"></a><span class="w">                </span><span class="n">maybeAddAllowBackgroundActivityStartsToken</span><span class="p">(</span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">app</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-61-368"><a id="__codelineno-61-368" name="__codelineno-61-368" href="#__codelineno-61-368"></a><span class="w">                </span><span class="c1">// r is guaranteed ordered at this point, so we know finishReceiverLocked()</span>
</span><span id="__span-61-369"><a id="__codelineno-61-369" name="__codelineno-61-369" href="#__codelineno-61-369"></a><span class="w">                </span><span class="c1">// will get a callback and handle the activity start token lifecycle.</span>
</span><span id="__span-61-370"><a id="__codelineno-61-370" name="__codelineno-61-370" href="#__codelineno-61-370"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-61-371"><a id="__codelineno-61-371" name="__codelineno-61-371" href="#__codelineno-61-371"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-61-372"><a id="__codelineno-61-372" name="__codelineno-61-372" href="#__codelineno-61-372"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-61-373"><a id="__codelineno-61-373" name="__codelineno-61-373" href="#__codelineno-61-373"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-61-374"><a id="__codelineno-61-374" name="__codelineno-61-374" href="#__codelineno-61-374"></a>
</span><span id="__span-61-375"><a id="__codelineno-61-375" name="__codelineno-61-375" href="#__codelineno-61-375"></a><span class="w">    </span><span class="c1">// Hard case: need to instantiate the receiver, possibly</span>
</span><span id="__span-61-376"><a id="__codelineno-61-376" name="__codelineno-61-376" href="#__codelineno-61-376"></a><span class="w">    </span><span class="c1">// starting its application process to host it.</span>
</span><span id="__span-61-377"><a id="__codelineno-61-377" name="__codelineno-61-377" href="#__codelineno-61-377"></a>
</span><span id="__span-61-378"><a id="__codelineno-61-378" name="__codelineno-61-378" href="#__codelineno-61-378"></a><span class="w">    </span><span class="n">ResolveInfo</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-61-379"><a id="__codelineno-61-379" name="__codelineno-61-379" href="#__codelineno-61-379"></a><span class="w">        </span><span class="p">(</span><span class="n">ResolveInfo</span><span class="p">)</span><span class="n">nextReceiver</span><span class="p">;</span>
</span><span id="__span-61-380"><a id="__codelineno-61-380" name="__codelineno-61-380" href="#__codelineno-61-380"></a><span class="w">    </span><span class="n">ComponentName</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ComponentName</span><span class="p">(</span>
</span><span id="__span-61-381"><a id="__codelineno-61-381" name="__codelineno-61-381" href="#__codelineno-61-381"></a><span class="w">            </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">packageName</span><span class="p">,</span>
</span><span id="__span-61-382"><a id="__codelineno-61-382" name="__codelineno-61-382" href="#__codelineno-61-382"></a><span class="w">            </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">name</span><span class="p">);</span>
</span><span id="__span-61-383"><a id="__codelineno-61-383" name="__codelineno-61-383" href="#__codelineno-61-383"></a>
</span><span id="__span-61-384"><a id="__codelineno-61-384" name="__codelineno-61-384" href="#__codelineno-61-384"></a><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-61-385"><a id="__codelineno-61-385" name="__codelineno-61-385" href="#__codelineno-61-385"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">brOptions</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-61-386"><a id="__codelineno-61-386" name="__codelineno-61-386" href="#__codelineno-61-386"></a><span class="w">            </span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">targetSdkVersion</span>
</span><span id="__span-61-387"><a id="__codelineno-61-387" name="__codelineno-61-387" href="#__codelineno-61-387"></a><span class="w">                    </span><span class="o">&lt;</span><span class="w"> </span><span class="n">brOptions</span><span class="p">.</span><span class="na">getMinManifestReceiverApiLevel</span><span class="p">()</span><span class="w"> </span><span class="o">||</span>
</span><span id="__span-61-388"><a id="__codelineno-61-388" name="__codelineno-61-388" href="#__codelineno-61-388"></a><span class="w">            </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">targetSdkVersion</span>
</span><span id="__span-61-389"><a id="__codelineno-61-389" name="__codelineno-61-389" href="#__codelineno-61-389"></a><span class="w">                    </span><span class="o">&gt;</span><span class="w"> </span><span class="n">brOptions</span><span class="p">.</span><span class="na">getMaxManifestReceiverApiLevel</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-390"><a id="__codelineno-61-390" name="__codelineno-61-390" href="#__codelineno-61-390"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Target SDK mismatch: receiver &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span>
</span><span id="__span-61-391"><a id="__codelineno-61-391" name="__codelineno-61-391" href="#__codelineno-61-391"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; targets &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">targetSdkVersion</span>
</span><span id="__span-61-392"><a id="__codelineno-61-392" name="__codelineno-61-392" href="#__codelineno-61-392"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; but delivery restricted to [&quot;</span>
</span><span id="__span-61-393"><a id="__codelineno-61-393" name="__codelineno-61-393" href="#__codelineno-61-393"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">brOptions</span><span class="p">.</span><span class="na">getMinManifestReceiverApiLevel</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, &quot;</span>
</span><span id="__span-61-394"><a id="__codelineno-61-394" name="__codelineno-61-394" href="#__codelineno-61-394"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">brOptions</span><span class="p">.</span><span class="na">getMaxManifestReceiverApiLevel</span><span class="p">()</span>
</span><span id="__span-61-395"><a id="__codelineno-61-395" name="__codelineno-61-395" href="#__codelineno-61-395"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;] broadcasting &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">broadcastDescription</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">));</span>
</span><span id="__span-61-396"><a id="__codelineno-61-396" name="__codelineno-61-396" href="#__codelineno-61-396"></a><span class="w">        </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-61-397"><a id="__codelineno-61-397" name="__codelineno-61-397" href="#__codelineno-61-397"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-61-398"><a id="__codelineno-61-398" name="__codelineno-61-398" href="#__codelineno-61-398"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">brOptions</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-61-399"><a id="__codelineno-61-399" name="__codelineno-61-399" href="#__codelineno-61-399"></a><span class="w">            </span><span class="o">!</span><span class="n">brOptions</span><span class="p">.</span><span class="na">testRequireCompatChange</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-400"><a id="__codelineno-61-400" name="__codelineno-61-400" href="#__codelineno-61-400"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Compat change filtered: broadcasting &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">broadcastDescription</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">)</span>
</span><span id="__span-61-401"><a id="__codelineno-61-401" name="__codelineno-61-401" href="#__codelineno-61-401"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; to uid &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; due to compat change &quot;</span>
</span><span id="__span-61-402"><a id="__codelineno-61-402" name="__codelineno-61-402" href="#__codelineno-61-402"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">options</span><span class="p">.</span><span class="na">getRequireCompatChangeId</span><span class="p">());</span>
</span><span id="__span-61-403"><a id="__codelineno-61-403" name="__codelineno-61-403" href="#__codelineno-61-403"></a><span class="w">        </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-61-404"><a id="__codelineno-61-404" name="__codelineno-61-404" href="#__codelineno-61-404"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-61-405"><a id="__codelineno-61-405" name="__codelineno-61-405" href="#__codelineno-61-405"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">skip</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">mService</span><span class="p">.</span><span class="na">validateAssociationAllowedLocked</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">callerPackage</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="p">,</span>
</span><span id="__span-61-406"><a id="__codelineno-61-406" name="__codelineno-61-406" href="#__codelineno-61-406"></a><span class="w">            </span><span class="n">component</span><span class="p">.</span><span class="na">getPackageName</span><span class="p">(),</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-407"><a id="__codelineno-61-407" name="__codelineno-61-407" href="#__codelineno-61-407"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Association not allowed: broadcasting &quot;</span>
</span><span id="__span-61-408"><a id="__codelineno-61-408" name="__codelineno-61-408" href="#__codelineno-61-408"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">broadcastDescription</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">));</span>
</span><span id="__span-61-409"><a id="__codelineno-61-409" name="__codelineno-61-409" href="#__codelineno-61-409"></a><span class="w">        </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-61-410"><a id="__codelineno-61-410" name="__codelineno-61-410" href="#__codelineno-61-410"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-61-411"><a id="__codelineno-61-411" name="__codelineno-61-411" href="#__codelineno-61-411"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">skip</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-412"><a id="__codelineno-61-412" name="__codelineno-61-412" href="#__codelineno-61-412"></a><span class="w">        </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="n">mService</span><span class="p">.</span><span class="na">mIntentFirewall</span><span class="p">.</span><span class="na">checkBroadcast</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="p">,</span>
</span><span id="__span-61-413"><a id="__codelineno-61-413" name="__codelineno-61-413" href="#__codelineno-61-413"></a><span class="w">                </span><span class="n">r</span><span class="p">.</span><span class="na">callingPid</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">resolvedType</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">);</span>
</span><span id="__span-61-414"><a id="__codelineno-61-414" name="__codelineno-61-414" href="#__codelineno-61-414"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">skip</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-415"><a id="__codelineno-61-415" name="__codelineno-61-415" href="#__codelineno-61-415"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Firewall blocked: broadcasting &quot;</span>
</span><span id="__span-61-416"><a id="__codelineno-61-416" name="__codelineno-61-416" href="#__codelineno-61-416"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">broadcastDescription</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">));</span>
</span><span id="__span-61-417"><a id="__codelineno-61-417" name="__codelineno-61-417" href="#__codelineno-61-417"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-61-418"><a id="__codelineno-61-418" name="__codelineno-61-418" href="#__codelineno-61-418"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-61-419"><a id="__codelineno-61-419" name="__codelineno-61-419" href="#__codelineno-61-419"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">perm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mService</span><span class="p">.</span><span class="na">checkComponentPermission</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">permission</span><span class="p">,</span>
</span><span id="__span-61-420"><a id="__codelineno-61-420" name="__codelineno-61-420" href="#__codelineno-61-420"></a><span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="na">callingPid</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">,</span>
</span><span id="__span-61-421"><a id="__codelineno-61-421" name="__codelineno-61-421" href="#__codelineno-61-421"></a><span class="w">            </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">exported</span><span class="p">);</span>
</span><span id="__span-61-422"><a id="__codelineno-61-422" name="__codelineno-61-422" href="#__codelineno-61-422"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">skip</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">perm</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="na">PERMISSION_GRANTED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-423"><a id="__codelineno-61-423" name="__codelineno-61-423" href="#__codelineno-61-423"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">exported</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-424"><a id="__codelineno-61-424" name="__codelineno-61-424" href="#__codelineno-61-424"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Permission Denial: broadcasting &quot;</span>
</span><span id="__span-61-425"><a id="__codelineno-61-425" name="__codelineno-61-425" href="#__codelineno-61-425"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">broadcastDescription</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">)</span>
</span><span id="__span-61-426"><a id="__codelineno-61-426" name="__codelineno-61-426" href="#__codelineno-61-426"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; is not exported from uid &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">);</span>
</span><span id="__span-61-427"><a id="__codelineno-61-427" name="__codelineno-61-427" href="#__codelineno-61-427"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-428"><a id="__codelineno-61-428" name="__codelineno-61-428" href="#__codelineno-61-428"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Permission Denial: broadcasting &quot;</span>
</span><span id="__span-61-429"><a id="__codelineno-61-429" name="__codelineno-61-429" href="#__codelineno-61-429"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">broadcastDescription</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">)</span>
</span><span id="__span-61-430"><a id="__codelineno-61-430" name="__codelineno-61-430" href="#__codelineno-61-430"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; requires &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">permission</span><span class="p">);</span>
</span><span id="__span-61-431"><a id="__codelineno-61-431" name="__codelineno-61-431" href="#__codelineno-61-431"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-61-432"><a id="__codelineno-61-432" name="__codelineno-61-432" href="#__codelineno-61-432"></a><span class="w">        </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-61-433"><a id="__codelineno-61-433" name="__codelineno-61-433" href="#__codelineno-61-433"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">skip</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">permission</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-434"><a id="__codelineno-61-434" name="__codelineno-61-434" href="#__codelineno-61-434"></a><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">opCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">permissionToOpCode</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">permission</span><span class="p">);</span>
</span><span id="__span-61-435"><a id="__codelineno-61-435" name="__codelineno-61-435" href="#__codelineno-61-435"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">opCode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">OP_NONE</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mService</span><span class="p">.</span><span class="na">getAppOpsManager</span><span class="p">().</span><span class="na">noteOpNoThrow</span><span class="p">(</span><span class="n">opCode</span><span class="p">,</span>
</span><span id="__span-61-436"><a id="__codelineno-61-436" name="__codelineno-61-436" href="#__codelineno-61-436"></a><span class="w">                </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callerPackage</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callerFeatureId</span><span class="p">,</span>
</span><span id="__span-61-437"><a id="__codelineno-61-437" name="__codelineno-61-437" href="#__codelineno-61-437"></a><span class="w">                </span><span class="s">&quot;Broadcast delivered to &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">name</span><span class="p">)</span>
</span><span id="__span-61-438"><a id="__codelineno-61-438" name="__codelineno-61-438" href="#__codelineno-61-438"></a><span class="w">                </span><span class="o">!=</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">MODE_ALLOWED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-439"><a id="__codelineno-61-439" name="__codelineno-61-439" href="#__codelineno-61-439"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Appop Denial: broadcasting &quot;</span>
</span><span id="__span-61-440"><a id="__codelineno-61-440" name="__codelineno-61-440" href="#__codelineno-61-440"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">broadcastDescription</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">)</span>
</span><span id="__span-61-441"><a id="__codelineno-61-441" name="__codelineno-61-441" href="#__codelineno-61-441"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; requires appop &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">permissionToOp</span><span class="p">(</span>
</span><span id="__span-61-442"><a id="__codelineno-61-442" name="__codelineno-61-442" href="#__codelineno-61-442"></a><span class="w">                            </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">permission</span><span class="p">));</span>
</span><span id="__span-61-443"><a id="__codelineno-61-443" name="__codelineno-61-443" href="#__codelineno-61-443"></a><span class="w">            </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-61-444"><a id="__codelineno-61-444" name="__codelineno-61-444" href="#__codelineno-61-444"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-61-445"><a id="__codelineno-61-445" name="__codelineno-61-445" href="#__codelineno-61-445"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-61-446"><a id="__codelineno-61-446" name="__codelineno-61-446" href="#__codelineno-61-446"></a>
</span><span id="__span-61-447"><a id="__codelineno-61-447" name="__codelineno-61-447" href="#__codelineno-61-447"></a><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isSingleton</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-61-448"><a id="__codelineno-61-448" name="__codelineno-61-448" href="#__codelineno-61-448"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-449"><a id="__codelineno-61-449" name="__codelineno-61-449" href="#__codelineno-61-449"></a><span class="w">        </span><span class="n">isSingleton</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mService</span><span class="p">.</span><span class="na">isSingleton</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">processName</span><span class="p">,</span>
</span><span id="__span-61-450"><a id="__codelineno-61-450" name="__codelineno-61-450" href="#__codelineno-61-450"></a><span class="w">                </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">,</span>
</span><span id="__span-61-451"><a id="__codelineno-61-451" name="__codelineno-61-451" href="#__codelineno-61-451"></a><span class="w">                </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">name</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">flags</span><span class="p">);</span>
</span><span id="__span-61-452"><a id="__codelineno-61-452" name="__codelineno-61-452" href="#__codelineno-61-452"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">SecurityException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-453"><a id="__codelineno-61-453" name="__codelineno-61-453" href="#__codelineno-61-453"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
</span><span id="__span-61-454"><a id="__codelineno-61-454" name="__codelineno-61-454" href="#__codelineno-61-454"></a><span class="w">        </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-61-455"><a id="__codelineno-61-455" name="__codelineno-61-455" href="#__codelineno-61-455"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-61-456"><a id="__codelineno-61-456" name="__codelineno-61-456" href="#__codelineno-61-456"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">flags</span><span class="o">&amp;</span><span class="n">ActivityInfo</span><span class="p">.</span><span class="na">FLAG_SINGLE_USER</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-457"><a id="__codelineno-61-457" name="__codelineno-61-457" href="#__codelineno-61-457"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">checkUidPermission</span><span class="p">(</span>
</span><span id="__span-61-458"><a id="__codelineno-61-458" name="__codelineno-61-458" href="#__codelineno-61-458"></a><span class="w">                </span><span class="n">android</span><span class="p">.</span><span class="na">Manifest</span><span class="p">.</span><span class="na">permission</span><span class="p">.</span><span class="na">INTERACT_ACROSS_USERS</span><span class="p">,</span>
</span><span id="__span-61-459"><a id="__codelineno-61-459" name="__codelineno-61-459" href="#__codelineno-61-459"></a><span class="w">                </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">)</span>
</span><span id="__span-61-460"><a id="__codelineno-61-460" name="__codelineno-61-460" href="#__codelineno-61-460"></a><span class="w">                        </span><span class="o">!=</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="na">PERMISSION_GRANTED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-461"><a id="__codelineno-61-461" name="__codelineno-61-461" href="#__codelineno-61-461"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Permission Denial: Receiver &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">component</span><span class="p">.</span><span class="na">flattenToShortString</span><span class="p">()</span>
</span><span id="__span-61-462"><a id="__codelineno-61-462" name="__codelineno-61-462" href="#__codelineno-61-462"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; requests FLAG_SINGLE_USER, but app does not hold &quot;</span>
</span><span id="__span-61-463"><a id="__codelineno-61-463" name="__codelineno-61-463" href="#__codelineno-61-463"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">android</span><span class="p">.</span><span class="na">Manifest</span><span class="p">.</span><span class="na">permission</span><span class="p">.</span><span class="na">INTERACT_ACROSS_USERS</span><span class="p">);</span>
</span><span id="__span-61-464"><a id="__codelineno-61-464" name="__codelineno-61-464" href="#__codelineno-61-464"></a><span class="w">            </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-61-465"><a id="__codelineno-61-465" name="__codelineno-61-465" href="#__codelineno-61-465"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-61-466"><a id="__codelineno-61-466" name="__codelineno-61-466" href="#__codelineno-61-466"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-61-467"><a id="__codelineno-61-467" name="__codelineno-61-467" href="#__codelineno-61-467"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">skip</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">isInstantApp</span><span class="p">()</span>
</span><span id="__span-61-468"><a id="__codelineno-61-468" name="__codelineno-61-468" href="#__codelineno-61-468"></a><span class="w">            </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-469"><a id="__codelineno-61-469" name="__codelineno-61-469" href="#__codelineno-61-469"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Instant App Denial: receiving &quot;</span>
</span><span id="__span-61-470"><a id="__codelineno-61-470" name="__codelineno-61-470" href="#__codelineno-61-470"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span>
</span><span id="__span-61-471"><a id="__codelineno-61-471" name="__codelineno-61-471" href="#__codelineno-61-471"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; to &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">component</span><span class="p">.</span><span class="na">flattenToShortString</span><span class="p">()</span>
</span><span id="__span-61-472"><a id="__codelineno-61-472" name="__codelineno-61-472" href="#__codelineno-61-472"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; due to sender &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callerPackage</span>
</span><span id="__span-61-473"><a id="__codelineno-61-473" name="__codelineno-61-473" href="#__codelineno-61-473"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; (uid &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;)&quot;</span>
</span><span id="__span-61-474"><a id="__codelineno-61-474" name="__codelineno-61-474" href="#__codelineno-61-474"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; Instant Apps do not support manifest receivers&quot;</span><span class="p">);</span>
</span><span id="__span-61-475"><a id="__codelineno-61-475" name="__codelineno-61-475" href="#__codelineno-61-475"></a><span class="w">        </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-61-476"><a id="__codelineno-61-476" name="__codelineno-61-476" href="#__codelineno-61-476"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-61-477"><a id="__codelineno-61-477" name="__codelineno-61-477" href="#__codelineno-61-477"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">skip</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callerInstantApp</span>
</span><span id="__span-61-478"><a id="__codelineno-61-478" name="__codelineno-61-478" href="#__codelineno-61-478"></a><span class="w">            </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ActivityInfo</span><span class="p">.</span><span class="na">FLAG_VISIBLE_TO_INSTANT_APP</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-61-479"><a id="__codelineno-61-479" name="__codelineno-61-479" href="#__codelineno-61-479"></a><span class="w">            </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-480"><a id="__codelineno-61-480" name="__codelineno-61-480" href="#__codelineno-61-480"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Instant App Denial: receiving &quot;</span>
</span><span id="__span-61-481"><a id="__codelineno-61-481" name="__codelineno-61-481" href="#__codelineno-61-481"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span>
</span><span id="__span-61-482"><a id="__codelineno-61-482" name="__codelineno-61-482" href="#__codelineno-61-482"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; to &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">component</span><span class="p">.</span><span class="na">flattenToShortString</span><span class="p">()</span>
</span><span id="__span-61-483"><a id="__codelineno-61-483" name="__codelineno-61-483" href="#__codelineno-61-483"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; requires receiver have visibleToInstantApps set&quot;</span>
</span><span id="__span-61-484"><a id="__codelineno-61-484" name="__codelineno-61-484" href="#__codelineno-61-484"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; due to sender &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callerPackage</span>
</span><span id="__span-61-485"><a id="__codelineno-61-485" name="__codelineno-61-485" href="#__codelineno-61-485"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; (uid &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="p">);</span>
</span><span id="__span-61-486"><a id="__codelineno-61-486" name="__codelineno-61-486" href="#__codelineno-61-486"></a><span class="w">        </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-61-487"><a id="__codelineno-61-487" name="__codelineno-61-487" href="#__codelineno-61-487"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-61-488"><a id="__codelineno-61-488" name="__codelineno-61-488" href="#__codelineno-61-488"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">curApp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">curApp</span><span class="p">.</span><span class="na">mErrorState</span><span class="p">.</span><span class="na">isCrashing</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-489"><a id="__codelineno-61-489" name="__codelineno-61-489" href="#__codelineno-61-489"></a><span class="w">        </span><span class="c1">// If the target process is crashing, just skip it.</span>
</span><span id="__span-61-490"><a id="__codelineno-61-490" name="__codelineno-61-490" href="#__codelineno-61-490"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Skipping deliver ordered [&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;] &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span>
</span><span id="__span-61-491"><a id="__codelineno-61-491" name="__codelineno-61-491" href="#__codelineno-61-491"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; to &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">curApp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;: process crashing&quot;</span><span class="p">);</span>
</span><span id="__span-61-492"><a id="__codelineno-61-492" name="__codelineno-61-492" href="#__codelineno-61-492"></a><span class="w">        </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-61-493"><a id="__codelineno-61-493" name="__codelineno-61-493" href="#__codelineno-61-493"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-61-494"><a id="__codelineno-61-494" name="__codelineno-61-494" href="#__codelineno-61-494"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">skip</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-495"><a id="__codelineno-61-495" name="__codelineno-61-495" href="#__codelineno-61-495"></a><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isAvailable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-61-496"><a id="__codelineno-61-496" name="__codelineno-61-496" href="#__codelineno-61-496"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-497"><a id="__codelineno-61-497" name="__codelineno-61-497" href="#__codelineno-61-497"></a><span class="w">            </span><span class="n">isAvailable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AppGlobals</span><span class="p">.</span><span class="na">getPackageManager</span><span class="p">().</span><span class="na">isPackageAvailable</span><span class="p">(</span>
</span><span id="__span-61-498"><a id="__codelineno-61-498" name="__codelineno-61-498" href="#__codelineno-61-498"></a><span class="w">                    </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">packageName</span><span class="p">,</span>
</span><span id="__span-61-499"><a id="__codelineno-61-499" name="__codelineno-61-499" href="#__codelineno-61-499"></a><span class="w">                    </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">));</span>
</span><span id="__span-61-500"><a id="__codelineno-61-500" name="__codelineno-61-500" href="#__codelineno-61-500"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-501"><a id="__codelineno-61-501" name="__codelineno-61-501" href="#__codelineno-61-501"></a><span class="w">            </span><span class="c1">// all such failures mean we skip this receiver</span>
</span><span id="__span-61-502"><a id="__codelineno-61-502" name="__codelineno-61-502" href="#__codelineno-61-502"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Exception getting recipient info for &quot;</span>
</span><span id="__span-61-503"><a id="__codelineno-61-503" name="__codelineno-61-503" href="#__codelineno-61-503"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">packageName</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
</span><span id="__span-61-504"><a id="__codelineno-61-504" name="__codelineno-61-504" href="#__codelineno-61-504"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-61-505"><a id="__codelineno-61-505" name="__codelineno-61-505" href="#__codelineno-61-505"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isAvailable</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-506"><a id="__codelineno-61-506" name="__codelineno-61-506" href="#__codelineno-61-506"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span>
</span><span id="__span-61-507"><a id="__codelineno-61-507" name="__codelineno-61-507" href="#__codelineno-61-507"></a><span class="w">                    </span><span class="s">&quot;Skipping delivery to &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">packageName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; / &quot;</span>
</span><span id="__span-61-508"><a id="__codelineno-61-508" name="__codelineno-61-508" href="#__codelineno-61-508"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span>
</span><span id="__span-61-509"><a id="__codelineno-61-509" name="__codelineno-61-509" href="#__codelineno-61-509"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; : package no longer available&quot;</span><span class="p">);</span>
</span><span id="__span-61-510"><a id="__codelineno-61-510" name="__codelineno-61-510" href="#__codelineno-61-510"></a><span class="w">            </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-61-511"><a id="__codelineno-61-511" name="__codelineno-61-511" href="#__codelineno-61-511"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-61-512"><a id="__codelineno-61-512" name="__codelineno-61-512" href="#__codelineno-61-512"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-61-513"><a id="__codelineno-61-513" name="__codelineno-61-513" href="#__codelineno-61-513"></a>
</span><span id="__span-61-514"><a id="__codelineno-61-514" name="__codelineno-61-514" href="#__codelineno-61-514"></a><span class="w">    </span><span class="c1">// If permissions need a review before any of the app components can run, we drop</span>
</span><span id="__span-61-515"><a id="__codelineno-61-515" name="__codelineno-61-515" href="#__codelineno-61-515"></a><span class="w">    </span><span class="c1">// the broadcast and if the calling app is in the foreground and the broadcast is</span>
</span><span id="__span-61-516"><a id="__codelineno-61-516" name="__codelineno-61-516" href="#__codelineno-61-516"></a><span class="w">    </span><span class="c1">// explicit we launch the review UI passing it a pending intent to send the skipped</span>
</span><span id="__span-61-517"><a id="__codelineno-61-517" name="__codelineno-61-517" href="#__codelineno-61-517"></a><span class="w">    </span><span class="c1">// broadcast.</span>
</span><span id="__span-61-518"><a id="__codelineno-61-518" name="__codelineno-61-518" href="#__codelineno-61-518"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">skip</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-519"><a id="__codelineno-61-519" name="__codelineno-61-519" href="#__codelineno-61-519"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">requestStartTargetPermissionsReviewIfNeededLocked</span><span class="p">(</span><span class="n">r</span><span class="p">,</span>
</span><span id="__span-61-520"><a id="__codelineno-61-520" name="__codelineno-61-520" href="#__codelineno-61-520"></a><span class="w">                </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">packageName</span><span class="p">,</span><span class="w"> </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(</span>
</span><span id="__span-61-521"><a id="__codelineno-61-521" name="__codelineno-61-521" href="#__codelineno-61-521"></a><span class="w">                        </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-522"><a id="__codelineno-61-522" name="__codelineno-61-522" href="#__codelineno-61-522"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span>
</span><span id="__span-61-523"><a id="__codelineno-61-523" name="__codelineno-61-523" href="#__codelineno-61-523"></a><span class="w">                    </span><span class="s">&quot;Skipping delivery: permission review required for &quot;</span>
</span><span id="__span-61-524"><a id="__codelineno-61-524" name="__codelineno-61-524" href="#__codelineno-61-524"></a><span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">broadcastDescription</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">));</span>
</span><span id="__span-61-525"><a id="__codelineno-61-525" name="__codelineno-61-525" href="#__codelineno-61-525"></a><span class="w">            </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-61-526"><a id="__codelineno-61-526" name="__codelineno-61-526" href="#__codelineno-61-526"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-61-527"><a id="__codelineno-61-527" name="__codelineno-61-527" href="#__codelineno-61-527"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-61-528"><a id="__codelineno-61-528" name="__codelineno-61-528" href="#__codelineno-61-528"></a>
</span><span id="__span-61-529"><a id="__codelineno-61-529" name="__codelineno-61-529" href="#__codelineno-61-529"></a><span class="w">    </span><span class="c1">// This is safe to do even if we are skipping the broadcast, and we need</span>
</span><span id="__span-61-530"><a id="__codelineno-61-530" name="__codelineno-61-530" href="#__codelineno-61-530"></a><span class="w">    </span><span class="c1">// this information now to evaluate whether it is going to be allowed to run.</span>
</span><span id="__span-61-531"><a id="__codelineno-61-531" name="__codelineno-61-531" href="#__codelineno-61-531"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">receiverUid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">;</span>
</span><span id="__span-61-532"><a id="__codelineno-61-532" name="__codelineno-61-532" href="#__codelineno-61-532"></a><span class="w">    </span><span class="c1">// If it&#39;s a singleton, it needs to be the same app or a special app</span>
</span><span id="__span-61-533"><a id="__codelineno-61-533" name="__codelineno-61-533" href="#__codelineno-61-533"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">Process</span><span class="p">.</span><span class="na">SYSTEM_UID</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">isSingleton</span>
</span><span id="__span-61-534"><a id="__codelineno-61-534" name="__codelineno-61-534" href="#__codelineno-61-534"></a><span class="w">            </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mService</span><span class="p">.</span><span class="na">isValidSingletonCall</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="p">,</span><span class="w"> </span><span class="n">receiverUid</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-535"><a id="__codelineno-61-535" name="__codelineno-61-535" href="#__codelineno-61-535"></a><span class="w">        </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mService</span><span class="p">.</span><span class="na">getActivityInfoForUser</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-61-536"><a id="__codelineno-61-536" name="__codelineno-61-536" href="#__codelineno-61-536"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-61-537"><a id="__codelineno-61-537" name="__codelineno-61-537" href="#__codelineno-61-537"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">targetProcess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">processName</span><span class="p">;</span>
</span><span id="__span-61-538"><a id="__codelineno-61-538" name="__codelineno-61-538" href="#__codelineno-61-538"></a><span class="w">    </span><span class="n">ProcessRecord</span><span class="w"> </span><span class="n">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mService</span><span class="p">.</span><span class="na">getProcessRecordLocked</span><span class="p">(</span><span class="n">targetProcess</span><span class="p">,</span>
</span><span id="__span-61-539"><a id="__codelineno-61-539" name="__codelineno-61-539" href="#__codelineno-61-539"></a><span class="w">            </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">);</span>
</span><span id="__span-61-540"><a id="__codelineno-61-540" name="__codelineno-61-540" href="#__codelineno-61-540"></a>
</span><span id="__span-61-541"><a id="__codelineno-61-541" name="__codelineno-61-541" href="#__codelineno-61-541"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">skip</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-542"><a id="__codelineno-61-542" name="__codelineno-61-542" href="#__codelineno-61-542"></a><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">allowed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mService</span><span class="p">.</span><span class="na">getAppStartModeLOSP</span><span class="p">(</span>
</span><span id="__span-61-543"><a id="__codelineno-61-543" name="__codelineno-61-543" href="#__codelineno-61-543"></a><span class="w">                </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">packageName</span><span class="p">,</span>
</span><span id="__span-61-544"><a id="__codelineno-61-544" name="__codelineno-61-544" href="#__codelineno-61-544"></a><span class="w">                </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">targetSdkVersion</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
</span><span id="__span-61-545"><a id="__codelineno-61-545" name="__codelineno-61-545" href="#__codelineno-61-545"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">allowed</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">APP_START_MODE_NORMAL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-546"><a id="__codelineno-61-546" name="__codelineno-61-546" href="#__codelineno-61-546"></a><span class="w">            </span><span class="c1">// We won&#39;t allow this receiver to be launched if the app has been</span>
</span><span id="__span-61-547"><a id="__codelineno-61-547" name="__codelineno-61-547" href="#__codelineno-61-547"></a><span class="w">            </span><span class="c1">// completely disabled from launches, or it was not explicitly sent</span>
</span><span id="__span-61-548"><a id="__codelineno-61-548" name="__codelineno-61-548" href="#__codelineno-61-548"></a><span class="w">            </span><span class="c1">// to it and the app is in a state that should not receive it</span>
</span><span id="__span-61-549"><a id="__codelineno-61-549" name="__codelineno-61-549" href="#__codelineno-61-549"></a><span class="w">            </span><span class="c1">// (depending on how getAppStartModeLOSP has determined that).</span>
</span><span id="__span-61-550"><a id="__codelineno-61-550" name="__codelineno-61-550" href="#__codelineno-61-550"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">allowed</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">APP_START_MODE_DISABLED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-551"><a id="__codelineno-61-551" name="__codelineno-61-551" href="#__codelineno-61-551"></a><span class="w">                </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Background execution disabled: receiving &quot;</span>
</span><span id="__span-61-552"><a id="__codelineno-61-552" name="__codelineno-61-552" href="#__codelineno-61-552"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; to &quot;</span>
</span><span id="__span-61-553"><a id="__codelineno-61-553" name="__codelineno-61-553" href="#__codelineno-61-553"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">component</span><span class="p">.</span><span class="na">flattenToShortString</span><span class="p">());</span>
</span><span id="__span-61-554"><a id="__codelineno-61-554" name="__codelineno-61-554" href="#__codelineno-61-554"></a><span class="w">                </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-61-555"><a id="__codelineno-61-555" name="__codelineno-61-555" href="#__codelineno-61-555"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(((</span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getFlags</span><span class="p">()</span><span class="o">&amp;</span><span class="n">Intent</span><span class="p">.</span><span class="na">FLAG_RECEIVER_EXCLUDE_BACKGROUND</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-61-556"><a id="__codelineno-61-556" name="__codelineno-61-556" href="#__codelineno-61-556"></a><span class="w">                    </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getComponent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span>
</span><span id="__span-61-557"><a id="__codelineno-61-557" name="__codelineno-61-557" href="#__codelineno-61-557"></a><span class="w">                        </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getPackage</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span>
</span><span id="__span-61-558"><a id="__codelineno-61-558" name="__codelineno-61-558" href="#__codelineno-61-558"></a><span class="w">                        </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">((</span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getFlags</span><span class="p">()</span>
</span><span id="__span-61-559"><a id="__codelineno-61-559" name="__codelineno-61-559" href="#__codelineno-61-559"></a><span class="w">                                </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">FLAG_RECEIVER_INCLUDE_BACKGROUND</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-61-560"><a id="__codelineno-61-560" name="__codelineno-61-560" href="#__codelineno-61-560"></a><span class="w">                        </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">isSignaturePerm</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">requiredPermissions</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-561"><a id="__codelineno-61-561" name="__codelineno-61-561" href="#__codelineno-61-561"></a><span class="w">                </span><span class="n">mService</span><span class="p">.</span><span class="na">addBackgroundCheckViolationLocked</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">(),</span>
</span><span id="__span-61-562"><a id="__codelineno-61-562" name="__codelineno-61-562" href="#__codelineno-61-562"></a><span class="w">                        </span><span class="n">component</span><span class="p">.</span><span class="na">getPackageName</span><span class="p">());</span>
</span><span id="__span-61-563"><a id="__codelineno-61-563" name="__codelineno-61-563" href="#__codelineno-61-563"></a><span class="w">                </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Background execution not allowed: receiving &quot;</span>
</span><span id="__span-61-564"><a id="__codelineno-61-564" name="__codelineno-61-564" href="#__codelineno-61-564"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; to &quot;</span>
</span><span id="__span-61-565"><a id="__codelineno-61-565" name="__codelineno-61-565" href="#__codelineno-61-565"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">component</span><span class="p">.</span><span class="na">flattenToShortString</span><span class="p">());</span>
</span><span id="__span-61-566"><a id="__codelineno-61-566" name="__codelineno-61-566" href="#__codelineno-61-566"></a><span class="w">                </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-61-567"><a id="__codelineno-61-567" name="__codelineno-61-567" href="#__codelineno-61-567"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-61-568"><a id="__codelineno-61-568" name="__codelineno-61-568" href="#__codelineno-61-568"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-61-569"><a id="__codelineno-61-569" name="__codelineno-61-569" href="#__codelineno-61-569"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-61-570"><a id="__codelineno-61-570" name="__codelineno-61-570" href="#__codelineno-61-570"></a>
</span><span id="__span-61-571"><a id="__codelineno-61-571" name="__codelineno-61-571" href="#__codelineno-61-571"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">skip</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_SHUTDOWN</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">())</span>
</span><span id="__span-61-572"><a id="__codelineno-61-572" name="__codelineno-61-572" href="#__codelineno-61-572"></a><span class="w">            </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">mService</span><span class="p">.</span><span class="na">mUserController</span>
</span><span id="__span-61-573"><a id="__codelineno-61-573" name="__codelineno-61-573" href="#__codelineno-61-573"></a><span class="w">            </span><span class="p">.</span><span class="na">isUserRunning</span><span class="p">(</span><span class="n">UserHandle</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">),</span>
</span><span id="__span-61-574"><a id="__codelineno-61-574" name="__codelineno-61-574" href="#__codelineno-61-574"></a><span class="w">                    </span><span class="mi">0</span><span class="w"> </span><span class="cm">/* flags */</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-575"><a id="__codelineno-61-575" name="__codelineno-61-575" href="#__codelineno-61-575"></a><span class="w">        </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-61-576"><a id="__codelineno-61-576" name="__codelineno-61-576" href="#__codelineno-61-576"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span>
</span><span id="__span-61-577"><a id="__codelineno-61-577" name="__codelineno-61-577" href="#__codelineno-61-577"></a><span class="w">                </span><span class="s">&quot;Skipping delivery to &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">packageName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; / &quot;</span>
</span><span id="__span-61-578"><a id="__codelineno-61-578" name="__codelineno-61-578" href="#__codelineno-61-578"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; : user is not running&quot;</span><span class="p">);</span>
</span><span id="__span-61-579"><a id="__codelineno-61-579" name="__codelineno-61-579" href="#__codelineno-61-579"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-61-580"><a id="__codelineno-61-580" name="__codelineno-61-580" href="#__codelineno-61-580"></a>
</span><span id="__span-61-581"><a id="__codelineno-61-581" name="__codelineno-61-581" href="#__codelineno-61-581"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">skip</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">excludedPermissions</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">excludedPermissions</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-582"><a id="__codelineno-61-582" name="__codelineno-61-582" href="#__codelineno-61-582"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">excludedPermissions</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-583"><a id="__codelineno-61-583" name="__codelineno-61-583" href="#__codelineno-61-583"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">excludedPermission</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">excludedPermissions</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">;</span>
</span><span id="__span-61-584"><a id="__codelineno-61-584" name="__codelineno-61-584" href="#__codelineno-61-584"></a><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-585"><a id="__codelineno-61-585" name="__codelineno-61-585" href="#__codelineno-61-585"></a><span class="w">                </span><span class="n">perm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AppGlobals</span><span class="p">.</span><span class="na">getPackageManager</span><span class="p">()</span>
</span><span id="__span-61-586"><a id="__codelineno-61-586" name="__codelineno-61-586" href="#__codelineno-61-586"></a><span class="w">                    </span><span class="p">.</span><span class="na">checkPermission</span><span class="p">(</span><span class="n">excludedPermission</span><span class="p">,</span>
</span><span id="__span-61-587"><a id="__codelineno-61-587" name="__codelineno-61-587" href="#__codelineno-61-587"></a><span class="w">                            </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">packageName</span><span class="p">,</span>
</span><span id="__span-61-588"><a id="__codelineno-61-588" name="__codelineno-61-588" href="#__codelineno-61-588"></a><span class="w">                            </span><span class="n">UserHandle</span>
</span><span id="__span-61-589"><a id="__codelineno-61-589" name="__codelineno-61-589" href="#__codelineno-61-589"></a><span class="w">                            </span><span class="p">.</span><span class="na">getUserId</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">));</span>
</span><span id="__span-61-590"><a id="__codelineno-61-590" name="__codelineno-61-590" href="#__codelineno-61-590"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-591"><a id="__codelineno-61-591" name="__codelineno-61-591" href="#__codelineno-61-591"></a><span class="w">                </span><span class="n">perm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="na">PERMISSION_DENIED</span><span class="p">;</span>
</span><span id="__span-61-592"><a id="__codelineno-61-592" name="__codelineno-61-592" href="#__codelineno-61-592"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-61-593"><a id="__codelineno-61-593" name="__codelineno-61-593" href="#__codelineno-61-593"></a>
</span><span id="__span-61-594"><a id="__codelineno-61-594" name="__codelineno-61-594" href="#__codelineno-61-594"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">appOp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">permissionToOpCode</span><span class="p">(</span><span class="n">excludedPermission</span><span class="p">);</span>
</span><span id="__span-61-595"><a id="__codelineno-61-595" name="__codelineno-61-595" href="#__codelineno-61-595"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">appOp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">OP_NONE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-596"><a id="__codelineno-61-596" name="__codelineno-61-596" href="#__codelineno-61-596"></a><span class="w">                </span><span class="c1">// When there is an app op associated with the permission,</span>
</span><span id="__span-61-597"><a id="__codelineno-61-597" name="__codelineno-61-597" href="#__codelineno-61-597"></a><span class="w">                </span><span class="c1">// skip when both the permission and the app op are</span>
</span><span id="__span-61-598"><a id="__codelineno-61-598" name="__codelineno-61-598" href="#__codelineno-61-598"></a><span class="w">                </span><span class="c1">// granted.</span>
</span><span id="__span-61-599"><a id="__codelineno-61-599" name="__codelineno-61-599" href="#__codelineno-61-599"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">perm</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="na">PERMISSION_GRANTED</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-61-600"><a id="__codelineno-61-600" name="__codelineno-61-600" href="#__codelineno-61-600"></a><span class="w">                            </span><span class="n">mService</span><span class="p">.</span><span class="na">getAppOpsManager</span><span class="p">().</span><span class="na">checkOpNoThrow</span><span class="p">(</span><span class="n">appOp</span><span class="p">,</span>
</span><span id="__span-61-601"><a id="__codelineno-61-601" name="__codelineno-61-601" href="#__codelineno-61-601"></a><span class="w">                            </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">,</span>
</span><span id="__span-61-602"><a id="__codelineno-61-602" name="__codelineno-61-602" href="#__codelineno-61-602"></a><span class="w">                            </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">packageName</span><span class="p">)</span>
</span><span id="__span-61-603"><a id="__codelineno-61-603" name="__codelineno-61-603" href="#__codelineno-61-603"></a><span class="w">                        </span><span class="o">==</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">MODE_ALLOWED</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-604"><a id="__codelineno-61-604" name="__codelineno-61-604" href="#__codelineno-61-604"></a><span class="w">                    </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-61-605"><a id="__codelineno-61-605" name="__codelineno-61-605" href="#__codelineno-61-605"></a><span class="w">                    </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-61-606"><a id="__codelineno-61-606" name="__codelineno-61-606" href="#__codelineno-61-606"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-61-607"><a id="__codelineno-61-607" name="__codelineno-61-607" href="#__codelineno-61-607"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-608"><a id="__codelineno-61-608" name="__codelineno-61-608" href="#__codelineno-61-608"></a><span class="w">                </span><span class="c1">// When there is no app op associated with the permission,</span>
</span><span id="__span-61-609"><a id="__codelineno-61-609" name="__codelineno-61-609" href="#__codelineno-61-609"></a><span class="w">                </span><span class="c1">// skip when permission is granted.</span>
</span><span id="__span-61-610"><a id="__codelineno-61-610" name="__codelineno-61-610" href="#__codelineno-61-610"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">perm</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="na">PERMISSION_GRANTED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-611"><a id="__codelineno-61-611" name="__codelineno-61-611" href="#__codelineno-61-611"></a><span class="w">                    </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-61-612"><a id="__codelineno-61-612" name="__codelineno-61-612" href="#__codelineno-61-612"></a><span class="w">                    </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-61-613"><a id="__codelineno-61-613" name="__codelineno-61-613" href="#__codelineno-61-613"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-61-614"><a id="__codelineno-61-614" name="__codelineno-61-614" href="#__codelineno-61-614"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-61-615"><a id="__codelineno-61-615" name="__codelineno-61-615" href="#__codelineno-61-615"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-61-616"><a id="__codelineno-61-616" name="__codelineno-61-616" href="#__codelineno-61-616"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-61-617"><a id="__codelineno-61-617" name="__codelineno-61-617" href="#__codelineno-61-617"></a>
</span><span id="__span-61-618"><a id="__codelineno-61-618" name="__codelineno-61-618" href="#__codelineno-61-618"></a><span class="w">    </span><span class="c1">// Check that the receiver does *not* belong to any of the excluded packages</span>
</span><span id="__span-61-619"><a id="__codelineno-61-619" name="__codelineno-61-619" href="#__codelineno-61-619"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">skip</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">excludedPackages</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">excludedPackages</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-620"><a id="__codelineno-61-620" name="__codelineno-61-620" href="#__codelineno-61-620"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ArrayUtils</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">excludedPackages</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">.</span><span class="na">getPackageName</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-621"><a id="__codelineno-61-621" name="__codelineno-61-621" href="#__codelineno-61-621"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Skipping delivery of excluded package &quot;</span>
</span><span id="__span-61-622"><a id="__codelineno-61-622" name="__codelineno-61-622" href="#__codelineno-61-622"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; to &quot;</span>
</span><span id="__span-61-623"><a id="__codelineno-61-623" name="__codelineno-61-623" href="#__codelineno-61-623"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">component</span><span class="p">.</span><span class="na">flattenToShortString</span><span class="p">()</span>
</span><span id="__span-61-624"><a id="__codelineno-61-624" name="__codelineno-61-624" href="#__codelineno-61-624"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; excludes package &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">component</span><span class="p">.</span><span class="na">getPackageName</span><span class="p">()</span>
</span><span id="__span-61-625"><a id="__codelineno-61-625" name="__codelineno-61-625" href="#__codelineno-61-625"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; due to sender &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callerPackage</span>
</span><span id="__span-61-626"><a id="__codelineno-61-626" name="__codelineno-61-626" href="#__codelineno-61-626"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; (uid &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="p">);</span>
</span><span id="__span-61-627"><a id="__codelineno-61-627" name="__codelineno-61-627" href="#__codelineno-61-627"></a><span class="w">            </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-61-628"><a id="__codelineno-61-628" name="__codelineno-61-628" href="#__codelineno-61-628"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-61-629"><a id="__codelineno-61-629" name="__codelineno-61-629" href="#__codelineno-61-629"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-61-630"><a id="__codelineno-61-630" name="__codelineno-61-630" href="#__codelineno-61-630"></a>
</span><span id="__span-61-631"><a id="__codelineno-61-631" name="__codelineno-61-631" href="#__codelineno-61-631"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">skip</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">Process</span><span class="p">.</span><span class="na">SYSTEM_UID</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-61-632"><a id="__codelineno-61-632" name="__codelineno-61-632" href="#__codelineno-61-632"></a><span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="na">requiredPermissions</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">requiredPermissions</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-633"><a id="__codelineno-61-633" name="__codelineno-61-633" href="#__codelineno-61-633"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">requiredPermissions</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-634"><a id="__codelineno-61-634" name="__codelineno-61-634" href="#__codelineno-61-634"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">requiredPermission</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">requiredPermissions</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">;</span>
</span><span id="__span-61-635"><a id="__codelineno-61-635" name="__codelineno-61-635" href="#__codelineno-61-635"></a><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-636"><a id="__codelineno-61-636" name="__codelineno-61-636" href="#__codelineno-61-636"></a><span class="w">                </span><span class="n">perm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AppGlobals</span><span class="p">.</span><span class="na">getPackageManager</span><span class="p">().</span>
</span><span id="__span-61-637"><a id="__codelineno-61-637" name="__codelineno-61-637" href="#__codelineno-61-637"></a><span class="w">                        </span><span class="n">checkPermission</span><span class="p">(</span><span class="n">requiredPermission</span><span class="p">,</span>
</span><span id="__span-61-638"><a id="__codelineno-61-638" name="__codelineno-61-638" href="#__codelineno-61-638"></a><span class="w">                                </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">packageName</span><span class="p">,</span>
</span><span id="__span-61-639"><a id="__codelineno-61-639" name="__codelineno-61-639" href="#__codelineno-61-639"></a><span class="w">                                </span><span class="n">UserHandle</span>
</span><span id="__span-61-640"><a id="__codelineno-61-640" name="__codelineno-61-640" href="#__codelineno-61-640"></a><span class="w">                                </span><span class="p">.</span><span class="na">getUserId</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">));</span>
</span><span id="__span-61-641"><a id="__codelineno-61-641" name="__codelineno-61-641" href="#__codelineno-61-641"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-642"><a id="__codelineno-61-642" name="__codelineno-61-642" href="#__codelineno-61-642"></a><span class="w">                </span><span class="n">perm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="na">PERMISSION_DENIED</span><span class="p">;</span>
</span><span id="__span-61-643"><a id="__codelineno-61-643" name="__codelineno-61-643" href="#__codelineno-61-643"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-61-644"><a id="__codelineno-61-644" name="__codelineno-61-644" href="#__codelineno-61-644"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">perm</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="na">PERMISSION_GRANTED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-645"><a id="__codelineno-61-645" name="__codelineno-61-645" href="#__codelineno-61-645"></a><span class="w">                </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Permission Denial: receiving &quot;</span>
</span><span id="__span-61-646"><a id="__codelineno-61-646" name="__codelineno-61-646" href="#__codelineno-61-646"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; to &quot;</span>
</span><span id="__span-61-647"><a id="__codelineno-61-647" name="__codelineno-61-647" href="#__codelineno-61-647"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">component</span><span class="p">.</span><span class="na">flattenToShortString</span><span class="p">()</span>
</span><span id="__span-61-648"><a id="__codelineno-61-648" name="__codelineno-61-648" href="#__codelineno-61-648"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; requires &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">requiredPermission</span>
</span><span id="__span-61-649"><a id="__codelineno-61-649" name="__codelineno-61-649" href="#__codelineno-61-649"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; due to sender &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callerPackage</span>
</span><span id="__span-61-650"><a id="__codelineno-61-650" name="__codelineno-61-650" href="#__codelineno-61-650"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; (uid &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="p">);</span>
</span><span id="__span-61-651"><a id="__codelineno-61-651" name="__codelineno-61-651" href="#__codelineno-61-651"></a><span class="w">                </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-61-652"><a id="__codelineno-61-652" name="__codelineno-61-652" href="#__codelineno-61-652"></a><span class="w">                </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-61-653"><a id="__codelineno-61-653" name="__codelineno-61-653" href="#__codelineno-61-653"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-61-654"><a id="__codelineno-61-654" name="__codelineno-61-654" href="#__codelineno-61-654"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">appOp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">permissionToOpCode</span><span class="p">(</span><span class="n">requiredPermission</span><span class="p">);</span>
</span><span id="__span-61-655"><a id="__codelineno-61-655" name="__codelineno-61-655" href="#__codelineno-61-655"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">appOp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">OP_NONE</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">appOp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">appOp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-656"><a id="__codelineno-61-656" name="__codelineno-61-656" href="#__codelineno-61-656"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">noteOpForManifestReceiver</span><span class="p">(</span><span class="n">appOp</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-657"><a id="__codelineno-61-657" name="__codelineno-61-657" href="#__codelineno-61-657"></a><span class="w">                    </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-61-658"><a id="__codelineno-61-658" name="__codelineno-61-658" href="#__codelineno-61-658"></a><span class="w">                    </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-61-659"><a id="__codelineno-61-659" name="__codelineno-61-659" href="#__codelineno-61-659"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-61-660"><a id="__codelineno-61-660" name="__codelineno-61-660" href="#__codelineno-61-660"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-61-661"><a id="__codelineno-61-661" name="__codelineno-61-661" href="#__codelineno-61-661"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-61-662"><a id="__codelineno-61-662" name="__codelineno-61-662" href="#__codelineno-61-662"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-61-663"><a id="__codelineno-61-663" name="__codelineno-61-663" href="#__codelineno-61-663"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">skip</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">appOp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">OP_NONE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-664"><a id="__codelineno-61-664" name="__codelineno-61-664" href="#__codelineno-61-664"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">noteOpForManifestReceiver</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">appOp</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-665"><a id="__codelineno-61-665" name="__codelineno-61-665" href="#__codelineno-61-665"></a><span class="w">            </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-61-666"><a id="__codelineno-61-666" name="__codelineno-61-666" href="#__codelineno-61-666"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-61-667"><a id="__codelineno-61-667" name="__codelineno-61-667" href="#__codelineno-61-667"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-61-668"><a id="__codelineno-61-668" name="__codelineno-61-668" href="#__codelineno-61-668"></a>
</span><span id="__span-61-669"><a id="__codelineno-61-669" name="__codelineno-61-669" href="#__codelineno-61-669"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">skip</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-670"><a id="__codelineno-61-670" name="__codelineno-61-670" href="#__codelineno-61-670"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w">  </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span>
</span><span id="__span-61-671"><a id="__codelineno-61-671" name="__codelineno-61-671" href="#__codelineno-61-671"></a><span class="w">                </span><span class="s">&quot;Skipping delivery of ordered [&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;] &quot;</span>
</span><span id="__span-61-672"><a id="__codelineno-61-672" name="__codelineno-61-672" href="#__codelineno-61-672"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; for reason described above&quot;</span><span class="p">);</span>
</span><span id="__span-61-673"><a id="__codelineno-61-673" name="__codelineno-61-673" href="#__codelineno-61-673"></a><span class="w">        </span><span class="n">r</span><span class="p">.</span><span class="na">delivery</span><span class="o">[</span><span class="n">recIdx</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">.</span><span class="na">DELIVERY_SKIPPED</span><span class="p">;</span>
</span><span id="__span-61-674"><a id="__codelineno-61-674" name="__codelineno-61-674" href="#__codelineno-61-674"></a><span class="w">        </span><span class="n">r</span><span class="p">.</span><span class="na">receiver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-61-675"><a id="__codelineno-61-675" name="__codelineno-61-675" href="#__codelineno-61-675"></a><span class="w">        </span><span class="n">r</span><span class="p">.</span><span class="na">curFilter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-61-676"><a id="__codelineno-61-676" name="__codelineno-61-676" href="#__codelineno-61-676"></a><span class="w">        </span><span class="n">r</span><span class="p">.</span><span class="na">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">.</span><span class="na">IDLE</span><span class="p">;</span>
</span><span id="__span-61-677"><a id="__codelineno-61-677" name="__codelineno-61-677" href="#__codelineno-61-677"></a><span class="w">        </span><span class="n">r</span><span class="p">.</span><span class="na">manifestSkipCount</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-61-678"><a id="__codelineno-61-678" name="__codelineno-61-678" href="#__codelineno-61-678"></a><span class="w">        </span><span class="n">scheduleBroadcastsLocked</span><span class="p">();</span>
</span><span id="__span-61-679"><a id="__codelineno-61-679" name="__codelineno-61-679" href="#__codelineno-61-679"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-61-680"><a id="__codelineno-61-680" name="__codelineno-61-680" href="#__codelineno-61-680"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-61-681"><a id="__codelineno-61-681" name="__codelineno-61-681" href="#__codelineno-61-681"></a><span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="na">manifestCount</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-61-682"><a id="__codelineno-61-682" name="__codelineno-61-682" href="#__codelineno-61-682"></a>
</span><span id="__span-61-683"><a id="__codelineno-61-683" name="__codelineno-61-683" href="#__codelineno-61-683"></a><span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="na">delivery</span><span class="o">[</span><span class="n">recIdx</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">.</span><span class="na">DELIVERY_DELIVERED</span><span class="p">;</span>
</span><span id="__span-61-684"><a id="__codelineno-61-684" name="__codelineno-61-684" href="#__codelineno-61-684"></a><span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="na">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">.</span><span class="na">APP_RECEIVE</span><span class="p">;</span>
</span><span id="__span-61-685"><a id="__codelineno-61-685" name="__codelineno-61-685" href="#__codelineno-61-685"></a><span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="na">curComponent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">component</span><span class="p">;</span>
</span><span id="__span-61-686"><a id="__codelineno-61-686" name="__codelineno-61-686" href="#__codelineno-61-686"></a><span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="na">curReceiver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">;</span>
</span><span id="__span-61-687"><a id="__codelineno-61-687" name="__codelineno-61-687" href="#__codelineno-61-687"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_MU</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">PER_USER_RANGE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-688"><a id="__codelineno-61-688" name="__codelineno-61-688" href="#__codelineno-61-688"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_MU</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Updated broadcast record activity info for secondary user, &quot;</span>
</span><span id="__span-61-689"><a id="__codelineno-61-689" name="__codelineno-61-689" href="#__codelineno-61-689"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, callingUid = &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, uid = &quot;</span>
</span><span id="__span-61-690"><a id="__codelineno-61-690" name="__codelineno-61-690" href="#__codelineno-61-690"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">receiverUid</span><span class="p">);</span>
</span><span id="__span-61-691"><a id="__codelineno-61-691" name="__codelineno-61-691" href="#__codelineno-61-691"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-61-692"><a id="__codelineno-61-692" name="__codelineno-61-692" href="#__codelineno-61-692"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isActivityCapable</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-61-693"><a id="__codelineno-61-693" name="__codelineno-61-693" href="#__codelineno-61-693"></a><span class="w">            </span><span class="p">(</span><span class="n">brOptions</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">brOptions</span><span class="p">.</span><span class="na">getTemporaryAppAllowlistDuration</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-61-694"><a id="__codelineno-61-694" name="__codelineno-61-694" href="#__codelineno-61-694"></a><span class="w">    </span><span class="n">maybeScheduleTempAllowlistLocked</span><span class="p">(</span><span class="n">receiverUid</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">brOptions</span><span class="p">);</span>
</span><span id="__span-61-695"><a id="__codelineno-61-695" name="__codelineno-61-695" href="#__codelineno-61-695"></a>
</span><span id="__span-61-696"><a id="__codelineno-61-696" name="__codelineno-61-696" href="#__codelineno-61-696"></a><span class="w">    </span><span class="c1">// Report that a component is used for explicit broadcasts.</span>
</span><span id="__span-61-697"><a id="__codelineno-61-697" name="__codelineno-61-697" href="#__codelineno-61-697"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getComponent</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">curComponent</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span>
</span><span id="__span-61-698"><a id="__codelineno-61-698" name="__codelineno-61-698" href="#__codelineno-61-698"></a><span class="w">            </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">TextUtils</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">curComponent</span><span class="p">.</span><span class="na">getPackageName</span><span class="p">(),</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callerPackage</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-699"><a id="__codelineno-61-699" name="__codelineno-61-699" href="#__codelineno-61-699"></a><span class="w">        </span><span class="n">mService</span><span class="p">.</span><span class="na">mUsageStatsService</span><span class="p">.</span><span class="na">reportEvent</span><span class="p">(</span>
</span><span id="__span-61-700"><a id="__codelineno-61-700" name="__codelineno-61-700" href="#__codelineno-61-700"></a><span class="w">                </span><span class="n">r</span><span class="p">.</span><span class="na">curComponent</span><span class="p">.</span><span class="na">getPackageName</span><span class="p">(),</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">userId</span><span class="p">,</span><span class="w"> </span><span class="n">Event</span><span class="p">.</span><span class="na">APP_COMPONENT_USED</span><span class="p">);</span>
</span><span id="__span-61-701"><a id="__codelineno-61-701" name="__codelineno-61-701" href="#__codelineno-61-701"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-61-702"><a id="__codelineno-61-702" name="__codelineno-61-702" href="#__codelineno-61-702"></a>
</span><span id="__span-61-703"><a id="__codelineno-61-703" name="__codelineno-61-703" href="#__codelineno-61-703"></a><span class="w">    </span><span class="c1">// Broadcast is being executed, its package can&#39;t be stopped.</span>
</span><span id="__span-61-704"><a id="__codelineno-61-704" name="__codelineno-61-704" href="#__codelineno-61-704"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-705"><a id="__codelineno-61-705" name="__codelineno-61-705" href="#__codelineno-61-705"></a><span class="w">        </span><span class="n">AppGlobals</span><span class="p">.</span><span class="na">getPackageManager</span><span class="p">().</span><span class="na">setPackageStoppedState</span><span class="p">(</span>
</span><span id="__span-61-706"><a id="__codelineno-61-706" name="__codelineno-61-706" href="#__codelineno-61-706"></a><span class="w">                </span><span class="n">r</span><span class="p">.</span><span class="na">curComponent</span><span class="p">.</span><span class="na">getPackageName</span><span class="p">(),</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">userId</span><span class="p">);</span>
</span><span id="__span-61-707"><a id="__codelineno-61-707" name="__codelineno-61-707" href="#__codelineno-61-707"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-708"><a id="__codelineno-61-708" name="__codelineno-61-708" href="#__codelineno-61-708"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IllegalArgumentException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-709"><a id="__codelineno-61-709" name="__codelineno-61-709" href="#__codelineno-61-709"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Failed trying to unstop package &quot;</span>
</span><span id="__span-61-710"><a id="__codelineno-61-710" name="__codelineno-61-710" href="#__codelineno-61-710"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">curComponent</span><span class="p">.</span><span class="na">getPackageName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
</span><span id="__span-61-711"><a id="__codelineno-61-711" name="__codelineno-61-711" href="#__codelineno-61-711"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-61-712"><a id="__codelineno-61-712" name="__codelineno-61-712" href="#__codelineno-61-712"></a>
</span><span id="__span-61-713"><a id="__codelineno-61-713" name="__codelineno-61-713" href="#__codelineno-61-713"></a><span class="w">    </span><span class="c1">// Is this receiver&#39;s application already running?</span>
</span><span id="__span-61-714"><a id="__codelineno-61-714" name="__codelineno-61-714" href="#__codelineno-61-714"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">app</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">app</span><span class="p">.</span><span class="na">getThread</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">app</span><span class="p">.</span><span class="na">isKilled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-715"><a id="__codelineno-61-715" name="__codelineno-61-715" href="#__codelineno-61-715"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-716"><a id="__codelineno-61-716" name="__codelineno-61-716" href="#__codelineno-61-716"></a><span class="w">            </span><span class="n">app</span><span class="p">.</span><span class="na">addPackage</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">packageName</span><span class="p">,</span>
</span><span id="__span-61-717"><a id="__codelineno-61-717" name="__codelineno-61-717" href="#__codelineno-61-717"></a><span class="w">                    </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">longVersionCode</span><span class="p">,</span><span class="w"> </span><span class="n">mService</span><span class="p">.</span><span class="na">mProcessStats</span><span class="p">);</span>
</span><span id="__span-61-718"><a id="__codelineno-61-718" name="__codelineno-61-718" href="#__codelineno-61-718"></a><span class="w">            </span><span class="n">maybeAddAllowBackgroundActivityStartsToken</span><span class="p">(</span><span class="n">app</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-61-719"><a id="__codelineno-61-719" name="__codelineno-61-719" href="#__codelineno-61-719"></a><span class="w">            </span><span class="n">processCurBroadcastLocked</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">app</span><span class="p">,</span>
</span><span id="__span-61-720"><a id="__codelineno-61-720" name="__codelineno-61-720" href="#__codelineno-61-720"></a><span class="w">                    </span><span class="n">BROADCAST_DELIVERY_EVENT_REPORTED__RECEIVER_TYPE__MANIFEST</span><span class="p">,</span>
</span><span id="__span-61-721"><a id="__codelineno-61-721" name="__codelineno-61-721" href="#__codelineno-61-721"></a><span class="w">                    </span><span class="n">BROADCAST_DELIVERY_EVENT_REPORTED__PROC_START_TYPE__PROCESS_START_TYPE_WARM</span><span class="p">);</span>
</span><span id="__span-61-722"><a id="__codelineno-61-722" name="__codelineno-61-722" href="#__codelineno-61-722"></a><span class="w">            </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-61-723"><a id="__codelineno-61-723" name="__codelineno-61-723" href="#__codelineno-61-723"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-724"><a id="__codelineno-61-724" name="__codelineno-61-724" href="#__codelineno-61-724"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Exception when sending broadcast to &quot;</span>
</span><span id="__span-61-725"><a id="__codelineno-61-725" name="__codelineno-61-725" href="#__codelineno-61-725"></a><span class="w">                  </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">curComponent</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
</span><span id="__span-61-726"><a id="__codelineno-61-726" name="__codelineno-61-726" href="#__codelineno-61-726"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RuntimeException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-727"><a id="__codelineno-61-727" name="__codelineno-61-727" href="#__codelineno-61-727"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">wtf</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Failed sending broadcast to &quot;</span>
</span><span id="__span-61-728"><a id="__codelineno-61-728" name="__codelineno-61-728" href="#__codelineno-61-728"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">curComponent</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; with &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
</span><span id="__span-61-729"><a id="__codelineno-61-729" name="__codelineno-61-729" href="#__codelineno-61-729"></a><span class="w">            </span><span class="c1">// If some unexpected exception happened, just skip</span>
</span><span id="__span-61-730"><a id="__codelineno-61-730" name="__codelineno-61-730" href="#__codelineno-61-730"></a><span class="w">            </span><span class="c1">// this broadcast.  At this point we are not in the call</span>
</span><span id="__span-61-731"><a id="__codelineno-61-731" name="__codelineno-61-731" href="#__codelineno-61-731"></a><span class="w">            </span><span class="c1">// from a client, so throwing an exception out from here</span>
</span><span id="__span-61-732"><a id="__codelineno-61-732" name="__codelineno-61-732" href="#__codelineno-61-732"></a><span class="w">            </span><span class="c1">// will crash the entire system instead of just whoever</span>
</span><span id="__span-61-733"><a id="__codelineno-61-733" name="__codelineno-61-733" href="#__codelineno-61-733"></a><span class="w">            </span><span class="c1">// sent the broadcast.</span>
</span><span id="__span-61-734"><a id="__codelineno-61-734" name="__codelineno-61-734" href="#__codelineno-61-734"></a><span class="w">            </span><span class="n">logBroadcastReceiverDiscardLocked</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-61-735"><a id="__codelineno-61-735" name="__codelineno-61-735" href="#__codelineno-61-735"></a><span class="w">            </span><span class="n">finishReceiverLocked</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">resultCode</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">resultData</span><span class="p">,</span>
</span><span id="__span-61-736"><a id="__codelineno-61-736" name="__codelineno-61-736" href="#__codelineno-61-736"></a><span class="w">                    </span><span class="n">r</span><span class="p">.</span><span class="na">resultExtras</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">resultAbort</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
</span><span id="__span-61-737"><a id="__codelineno-61-737" name="__codelineno-61-737" href="#__codelineno-61-737"></a><span class="w">            </span><span class="n">scheduleBroadcastsLocked</span><span class="p">();</span>
</span><span id="__span-61-738"><a id="__codelineno-61-738" name="__codelineno-61-738" href="#__codelineno-61-738"></a><span class="w">            </span><span class="c1">// We need to reset the state if we failed to start the receiver.</span>
</span><span id="__span-61-739"><a id="__codelineno-61-739" name="__codelineno-61-739" href="#__codelineno-61-739"></a><span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="na">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">.</span><span class="na">IDLE</span><span class="p">;</span>
</span><span id="__span-61-740"><a id="__codelineno-61-740" name="__codelineno-61-740" href="#__codelineno-61-740"></a><span class="w">            </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-61-741"><a id="__codelineno-61-741" name="__codelineno-61-741" href="#__codelineno-61-741"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-61-742"><a id="__codelineno-61-742" name="__codelineno-61-742" href="#__codelineno-61-742"></a>
</span><span id="__span-61-743"><a id="__codelineno-61-743" name="__codelineno-61-743" href="#__codelineno-61-743"></a><span class="w">        </span><span class="c1">// If a dead object exception was thrown -- fall through to</span>
</span><span id="__span-61-744"><a id="__codelineno-61-744" name="__codelineno-61-744" href="#__codelineno-61-744"></a><span class="w">        </span><span class="c1">// restart the application.</span>
</span><span id="__span-61-745"><a id="__codelineno-61-745" name="__codelineno-61-745" href="#__codelineno-61-745"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-61-746"><a id="__codelineno-61-746" name="__codelineno-61-746" href="#__codelineno-61-746"></a>
</span><span id="__span-61-747"><a id="__codelineno-61-747" name="__codelineno-61-747" href="#__codelineno-61-747"></a><span class="w">    </span><span class="c1">// Not running -- get it started, to be executed when the app comes up.</span>
</span><span id="__span-61-748"><a id="__codelineno-61-748" name="__codelineno-61-748" href="#__codelineno-61-748"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w">  </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span>
</span><span id="__span-61-749"><a id="__codelineno-61-749" name="__codelineno-61-749" href="#__codelineno-61-749"></a><span class="w">            </span><span class="s">&quot;Need to start app [&quot;</span>
</span><span id="__span-61-750"><a id="__codelineno-61-750" name="__codelineno-61-750" href="#__codelineno-61-750"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;] &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">targetProcess</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; for broadcast &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-61-751"><a id="__codelineno-61-751" name="__codelineno-61-751" href="#__codelineno-61-751"></a><span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="na">curApp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mService</span><span class="p">.</span><span class="na">startProcessLocked</span><span class="p">(</span><span class="n">targetProcess</span><span class="p">,</span>
</span><span id="__span-61-752"><a id="__codelineno-61-752" name="__codelineno-61-752" href="#__codelineno-61-752"></a><span class="w">            </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-61-753"><a id="__codelineno-61-753" name="__codelineno-61-753" href="#__codelineno-61-753"></a><span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getFlags</span><span class="p">()</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">FLAG_FROM_BACKGROUND</span><span class="p">,</span>
</span><span id="__span-61-754"><a id="__codelineno-61-754" name="__codelineno-61-754" href="#__codelineno-61-754"></a><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">HostingRecord</span><span class="p">(</span><span class="n">HostingRecord</span><span class="p">.</span><span class="na">HOSTING_TYPE_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">curComponent</span><span class="p">,</span>
</span><span id="__span-61-755"><a id="__codelineno-61-755" name="__codelineno-61-755" href="#__codelineno-61-755"></a><span class="w">                    </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">()),</span>
</span><span id="__span-61-756"><a id="__codelineno-61-756" name="__codelineno-61-756" href="#__codelineno-61-756"></a><span class="w">            </span><span class="n">isActivityCapable</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">ZYGOTE_POLICY_FLAG_LATENCY_SENSITIVE</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">ZYGOTE_POLICY_FLAG_EMPTY</span><span class="p">,</span>
</span><span id="__span-61-757"><a id="__codelineno-61-757" name="__codelineno-61-757" href="#__codelineno-61-757"></a><span class="w">            </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getFlags</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">FLAG_RECEIVER_BOOT_UPGRADE</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
</span><span id="__span-61-758"><a id="__codelineno-61-758" name="__codelineno-61-758" href="#__codelineno-61-758"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">curApp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-759"><a id="__codelineno-61-759" name="__codelineno-61-759" href="#__codelineno-61-759"></a><span class="w">        </span><span class="c1">// Ah, this recipient is unavailable.  Finish it if necessary,</span>
</span><span id="__span-61-760"><a id="__codelineno-61-760" name="__codelineno-61-760" href="#__codelineno-61-760"></a><span class="w">        </span><span class="c1">// and mark the broadcast record as ready for the next.</span>
</span><span id="__span-61-761"><a id="__codelineno-61-761" name="__codelineno-61-761" href="#__codelineno-61-761"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Unable to launch app &quot;</span>
</span><span id="__span-61-762"><a id="__codelineno-61-762" name="__codelineno-61-762" href="#__codelineno-61-762"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">packageName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;/&quot;</span>
</span><span id="__span-61-763"><a id="__codelineno-61-763" name="__codelineno-61-763" href="#__codelineno-61-763"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">receiverUid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; for broadcast &quot;</span>
</span><span id="__span-61-764"><a id="__codelineno-61-764" name="__codelineno-61-764" href="#__codelineno-61-764"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;: process is bad&quot;</span><span class="p">);</span>
</span><span id="__span-61-765"><a id="__codelineno-61-765" name="__codelineno-61-765" href="#__codelineno-61-765"></a><span class="w">        </span><span class="n">logBroadcastReceiverDiscardLocked</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-61-766"><a id="__codelineno-61-766" name="__codelineno-61-766" href="#__codelineno-61-766"></a><span class="w">        </span><span class="n">finishReceiverLocked</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">resultCode</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">resultData</span><span class="p">,</span>
</span><span id="__span-61-767"><a id="__codelineno-61-767" name="__codelineno-61-767" href="#__codelineno-61-767"></a><span class="w">                </span><span class="n">r</span><span class="p">.</span><span class="na">resultExtras</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">resultAbort</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
</span><span id="__span-61-768"><a id="__codelineno-61-768" name="__codelineno-61-768" href="#__codelineno-61-768"></a><span class="w">        </span><span class="n">scheduleBroadcastsLocked</span><span class="p">();</span>
</span><span id="__span-61-769"><a id="__codelineno-61-769" name="__codelineno-61-769" href="#__codelineno-61-769"></a><span class="w">        </span><span class="n">r</span><span class="p">.</span><span class="na">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">.</span><span class="na">IDLE</span><span class="p">;</span>
</span><span id="__span-61-770"><a id="__codelineno-61-770" name="__codelineno-61-770" href="#__codelineno-61-770"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-61-771"><a id="__codelineno-61-771" name="__codelineno-61-771" href="#__codelineno-61-771"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-61-772"><a id="__codelineno-61-772" name="__codelineno-61-772" href="#__codelineno-61-772"></a>
</span><span id="__span-61-773"><a id="__codelineno-61-773" name="__codelineno-61-773" href="#__codelineno-61-773"></a><span class="w">    </span><span class="n">maybeAddAllowBackgroundActivityStartsToken</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">curApp</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-61-774"><a id="__codelineno-61-774" name="__codelineno-61-774" href="#__codelineno-61-774"></a><span class="w">    </span><span class="n">mPendingBroadcast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">;</span>
</span><span id="__span-61-775"><a id="__codelineno-61-775" name="__codelineno-61-775" href="#__codelineno-61-775"></a><span class="w">    </span><span class="n">mPendingBroadcastRecvIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">recIdx</span><span class="p">;</span>
</span><span id="__span-61-776"><a id="__codelineno-61-776" name="__codelineno-61-776" href="#__codelineno-61-776"></a><span class="p">}</span>
</span></code></pre></div>
<p>processNextBroadcastLocked()函数是广播发送的核心内容，代码非常多，下面我们从几个方面来分析：</p>
<h4 id="_39">无序广播<a class="headerlink" href="#_39" title="Permanent link">&para;</a></h4>
<div class="language-java highlight"><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="n">BroadcastRecord</span><span class="w"> </span><span class="n">r</span><span class="p">;</span><span class="c1">//BroadcastRecord广播的记录者，需要分发的广播</span>
</span><span id="__span-62-2"><a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a>
</span><span id="__span-62-3"><a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;processNextBroadcast [&quot;</span>
</span><span id="__span-62-4"><a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a><span class="w">        </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;]: &quot;</span>
</span><span id="__span-62-5"><a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a><span class="w">        </span><span class="o">+</span><span class="w"> </span><span class="n">mParallelBroadcasts</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; parallel broadcasts; &quot;</span>
</span><span id="__span-62-6"><a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a><span class="w">        </span><span class="o">+</span><span class="w"> </span><span class="n">mDispatcher</span><span class="p">.</span><span class="na">describeStateLocked</span><span class="p">());</span>
</span><span id="__span-62-7"><a id="__codelineno-62-7" name="__codelineno-62-7" href="#__codelineno-62-7"></a>
</span><span id="__span-62-8"><a id="__codelineno-62-8" name="__codelineno-62-8" href="#__codelineno-62-8"></a><span class="n">mService</span><span class="p">.</span><span class="na">updateCpuStats</span><span class="p">();</span>
</span><span id="__span-62-9"><a id="__codelineno-62-9" name="__codelineno-62-9" href="#__codelineno-62-9"></a>
</span><span id="__span-62-10"><a id="__codelineno-62-10" name="__codelineno-62-10" href="#__codelineno-62-10"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fromMsg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="c1">// 否是来自handleMessage的BROADCAST_INTENT_MSG类型消息</span>
</span><span id="__span-62-11"><a id="__codelineno-62-11" name="__codelineno-62-11" href="#__codelineno-62-11"></a><span class="w">    </span><span class="c1">// 前面说到，如果消息队列里面有BROADCAST_INTENT_MSG消息，该标记为true，阻止新的消息加入队列，</span>
</span><span id="__span-62-12"><a id="__codelineno-62-12" name="__codelineno-62-12" href="#__codelineno-62-12"></a><span class="w">    </span><span class="c1">// 这里开始处理这个消息的时候，将mBroadcastsScheduled变量设置为false，开始允许新的消息加入。</span>
</span><span id="__span-62-13"><a id="__codelineno-62-13" name="__codelineno-62-13" href="#__codelineno-62-13"></a><span class="w">    </span><span class="n">mBroadcastsScheduled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-62-14"><a id="__codelineno-62-14" name="__codelineno-62-14" href="#__codelineno-62-14"></a><span class="p">}</span>
</span><span id="__span-62-15"><a id="__codelineno-62-15" name="__codelineno-62-15" href="#__codelineno-62-15"></a>
</span><span id="__span-62-16"><a id="__codelineno-62-16" name="__codelineno-62-16" href="#__codelineno-62-16"></a><span class="c1">// First, deliver any non-serialized broadcasts right away.</span>
</span><span id="__span-62-17"><a id="__codelineno-62-17" name="__codelineno-62-17" href="#__codelineno-62-17"></a><span class="c1">// 无序广播之间不存在相互等待，这里处理的是保存在无序广播调度队列mParallelBroadcasts中的广播发送任务，</span>
</span><span id="__span-62-18"><a id="__codelineno-62-18" name="__codelineno-62-18" href="#__codelineno-62-18"></a><span class="c1">// 即把保存在无序广播调度队列mParallelBroadcasts中的广播发送给它的目标广播接收者处理</span>
</span><span id="__span-62-19"><a id="__codelineno-62-19" name="__codelineno-62-19" href="#__codelineno-62-19"></a><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">mParallelBroadcasts</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-62-20"><a id="__codelineno-62-20" name="__codelineno-62-20" href="#__codelineno-62-20"></a><span class="w">    </span><span class="c1">// 首先获取保存无序广播调度队列mParallelBroadcasts中的每一个BroadcastRecord对象</span>
</span><span id="__span-62-21"><a id="__codelineno-62-21" name="__codelineno-62-21" href="#__codelineno-62-21"></a><span class="w">    </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mParallelBroadcasts</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-62-22"><a id="__codelineno-62-22" name="__codelineno-62-22" href="#__codelineno-62-22"></a><span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="na">dispatchTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SystemClock</span><span class="p">.</span><span class="na">uptimeMillis</span><span class="p">();</span><span class="c1">//设置BroadcastRecord r广播分发时间dispatchTime</span>
</span><span id="__span-62-23"><a id="__codelineno-62-23" name="__codelineno-62-23" href="#__codelineno-62-23"></a><span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="na">dispatchRealTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SystemClock</span><span class="p">.</span><span class="na">elapsedRealtime</span><span class="p">();</span>
</span><span id="__span-62-24"><a id="__codelineno-62-24" name="__codelineno-62-24" href="#__codelineno-62-24"></a><span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="na">dispatchClockTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="c1">//System.currentTimeMillis()获取的是系统时钟的时间，修改系统时间这个时间会变化</span>
</span><span id="__span-62-25"><a id="__codelineno-62-25" name="__codelineno-62-25" href="#__codelineno-62-25"></a>
</span><span id="__span-62-26"><a id="__codelineno-62-26" name="__codelineno-62-26" href="#__codelineno-62-26"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Trace</span><span class="p">.</span><span class="na">isTagEnabled</span><span class="p">(</span><span class="n">Trace</span><span class="p">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-62-27"><a id="__codelineno-62-27" name="__codelineno-62-27" href="#__codelineno-62-27"></a><span class="w">        </span><span class="n">Trace</span><span class="p">.</span><span class="na">asyncTraceEnd</span><span class="p">(</span><span class="n">Trace</span><span class="p">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="p">,</span>
</span><span id="__span-62-28"><a id="__codelineno-62-28" name="__codelineno-62-28" href="#__codelineno-62-28"></a><span class="w">            </span><span class="n">createBroadcastTraceTitle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">.</span><span class="na">DELIVERY_PENDING</span><span class="p">),</span>
</span><span id="__span-62-29"><a id="__codelineno-62-29" name="__codelineno-62-29" href="#__codelineno-62-29"></a><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">identityHashCode</span><span class="p">(</span><span class="n">r</span><span class="p">));</span>
</span><span id="__span-62-30"><a id="__codelineno-62-30" name="__codelineno-62-30" href="#__codelineno-62-30"></a><span class="w">        </span><span class="n">Trace</span><span class="p">.</span><span class="na">asyncTraceBegin</span><span class="p">(</span><span class="n">Trace</span><span class="p">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="p">,</span>
</span><span id="__span-62-31"><a id="__codelineno-62-31" name="__codelineno-62-31" href="#__codelineno-62-31"></a><span class="w">            </span><span class="n">createBroadcastTraceTitle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">.</span><span class="na">DELIVERY_DELIVERED</span><span class="p">),</span>
</span><span id="__span-62-32"><a id="__codelineno-62-32" name="__codelineno-62-32" href="#__codelineno-62-32"></a><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">identityHashCode</span><span class="p">(</span><span class="n">r</span><span class="p">));</span>
</span><span id="__span-62-33"><a id="__codelineno-62-33" name="__codelineno-62-33" href="#__codelineno-62-33"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-62-34"><a id="__codelineno-62-34" name="__codelineno-62-34" href="#__codelineno-62-34"></a>
</span><span id="__span-62-35"><a id="__codelineno-62-35" name="__codelineno-62-35" href="#__codelineno-62-35"></a><span class="w">    </span><span class="c1">//获取BroadcastRecord中的所有广播接收者的数量</span>
</span><span id="__span-62-36"><a id="__codelineno-62-36" name="__codelineno-62-36" href="#__codelineno-62-36"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">receivers</span><span class="p">.</span><span class="na">size</span><span class="p">();</span>
</span><span id="__span-62-37"><a id="__codelineno-62-37" name="__codelineno-62-37" href="#__codelineno-62-37"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST_LIGHT</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Processing parallel broadcast [&quot;</span>
</span><span id="__span-62-38"><a id="__codelineno-62-38" name="__codelineno-62-38" href="#__codelineno-62-38"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;] &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-62-39"><a id="__codelineno-62-39" name="__codelineno-62-39" href="#__codelineno-62-39"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="c1">//遍历构建 BroadcastRecord 的所有receivers</span>
</span><span id="__span-62-40"><a id="__codelineno-62-40" name="__codelineno-62-40" href="#__codelineno-62-40"></a><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">receivers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-62-41"><a id="__codelineno-62-41" name="__codelineno-62-41" href="#__codelineno-62-41"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w">  </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span>
</span><span id="__span-62-42"><a id="__codelineno-62-42" name="__codelineno-62-42" href="#__codelineno-62-42"></a><span class="w">                </span><span class="s">&quot;Delivering non-ordered on [&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;] to registered &quot;</span>
</span><span id="__span-62-43"><a id="__codelineno-62-43" name="__codelineno-62-43" href="#__codelineno-62-43"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-62-44"><a id="__codelineno-62-44" name="__codelineno-62-44" href="#__codelineno-62-44"></a><span class="w">        </span><span class="c1">// 调用deliverToRegisteredReceiverLocked向所有的receivers发送广播</span>
</span><span id="__span-62-45"><a id="__codelineno-62-45" name="__codelineno-62-45" href="#__codelineno-62-45"></a><span class="w">        </span><span class="c1">// 将它所描述的每一个无序广播发送给每一个广播接收者，异步处理广播</span>
</span><span id="__span-62-46"><a id="__codelineno-62-46" name="__codelineno-62-46" href="#__codelineno-62-46"></a><span class="w">        </span><span class="c1">// 通过deliverToRegisteredReceiverLocked调用ActivityThread.scheduleRegisteredReceiver处理广播</span>
</span><span id="__span-62-47"><a id="__codelineno-62-47" name="__codelineno-62-47" href="#__codelineno-62-47"></a><span class="w">        </span><span class="n">deliverToRegisteredReceiverLocked</span><span class="p">(</span><span class="n">r</span><span class="p">,</span>
</span><span id="__span-62-48"><a id="__codelineno-62-48" name="__codelineno-62-48" href="#__codelineno-62-48"></a><span class="w">                </span><span class="p">(</span><span class="n">BroadcastFilter</span><span class="p">)</span><span class="w"> </span><span class="n">target</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-62-49"><a id="__codelineno-62-49" name="__codelineno-62-49" href="#__codelineno-62-49"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-62-50"><a id="__codelineno-62-50" name="__codelineno-62-50" href="#__codelineno-62-50"></a><span class="w">    </span><span class="n">addBroadcastToHistoryLocked</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-62-51"><a id="__codelineno-62-51" name="__codelineno-62-51" href="#__codelineno-62-51"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST_LIGHT</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Done with parallel broadcast [&quot;</span>
</span><span id="__span-62-52"><a id="__codelineno-62-52" name="__codelineno-62-52" href="#__codelineno-62-52"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;] &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-62-53"><a id="__codelineno-62-53" name="__codelineno-62-53" href="#__codelineno-62-53"></a><span class="p">}</span>
</span></code></pre></div>
<p>无序广播接收者不需要等待，所以直接for循环执行，调用deliverToRegisteredReceiverLocked方法发送广播。</p>
<h5 id="delivertoregisteredreceiverlocked">deliverToRegisteredReceiverLocked<a class="headerlink" href="#delivertoregisteredreceiverlocked" title="Permanent link">&para;</a></h5>
<div class="language-java highlight"><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="c1">//执行动态注册的广播接收者的发送接受过程</span>
</span><span id="__span-63-2"><a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">deliverToRegisteredReceiverLocked</span><span class="p">(</span><span class="n">BroadcastRecord</span><span class="w"> </span><span class="n">r</span><span class="p">,</span>
</span><span id="__span-63-3"><a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a><span class="w">        </span><span class="n">BroadcastFilter</span><span class="w"> </span><span class="n">filter</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">ordered</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-4"><a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a><span class="w">    </span><span class="c1">// 标记是否要跳过该广播接收者</span>
</span><span id="__span-63-5"><a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-63-6"><a id="__codelineno-63-6" name="__codelineno-63-6" href="#__codelineno-63-6"></a>
</span><span id="__span-63-7"><a id="__codelineno-63-7" name="__codelineno-63-7" href="#__codelineno-63-7"></a><span class="w">    </span><span class="c1">//skip的场景</span>
</span><span id="__span-63-8"><a id="__codelineno-63-8" name="__codelineno-63-8" href="#__codelineno-63-8"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-63-9"><a id="__codelineno-63-9" name="__codelineno-63-9" href="#__codelineno-63-9"></a>
</span><span id="__span-63-10"><a id="__codelineno-63-10" name="__codelineno-63-10" href="#__codelineno-63-10"></a><span class="w">    </span><span class="c1">// 检查广播发送者的权限</span>
</span><span id="__span-63-11"><a id="__codelineno-63-11" name="__codelineno-63-11" href="#__codelineno-63-11"></a><span class="w">    </span><span class="c1">// Check that the sender has permission to send to this receiver</span>
</span><span id="__span-63-12"><a id="__codelineno-63-12" name="__codelineno-63-12" href="#__codelineno-63-12"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">filter</span><span class="p">.</span><span class="na">requiredPermission</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-13"><a id="__codelineno-63-13" name="__codelineno-63-13" href="#__codelineno-63-13"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">perm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mService</span><span class="p">.</span><span class="na">checkComponentPermission</span><span class="p">(</span><span class="n">filter</span><span class="p">.</span><span class="na">requiredPermission</span><span class="p">,</span>
</span><span id="__span-63-14"><a id="__codelineno-63-14" name="__codelineno-63-14" href="#__codelineno-63-14"></a><span class="w">                </span><span class="n">r</span><span class="p">.</span><span class="na">callingPid</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
</span><span id="__span-63-15"><a id="__codelineno-63-15" name="__codelineno-63-15" href="#__codelineno-63-15"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">perm</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="na">PERMISSION_GRANTED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-16"><a id="__codelineno-63-16" name="__codelineno-63-16" href="#__codelineno-63-16"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Permission Denial: broadcasting &quot;</span>
</span><span id="__span-63-17"><a id="__codelineno-63-17" name="__codelineno-63-17" href="#__codelineno-63-17"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">toString</span><span class="p">()</span>
</span><span id="__span-63-18"><a id="__codelineno-63-18" name="__codelineno-63-18" href="#__codelineno-63-18"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; from &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callerPackage</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; (pid=&quot;</span>
</span><span id="__span-63-19"><a id="__codelineno-63-19" name="__codelineno-63-19" href="#__codelineno-63-19"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callingPid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, uid=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;)&quot;</span>
</span><span id="__span-63-20"><a id="__codelineno-63-20" name="__codelineno-63-20" href="#__codelineno-63-20"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; requires &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="na">requiredPermission</span>
</span><span id="__span-63-21"><a id="__codelineno-63-21" name="__codelineno-63-21" href="#__codelineno-63-21"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; due to registered receiver &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">filter</span><span class="p">);</span>
</span><span id="__span-63-22"><a id="__codelineno-63-22" name="__codelineno-63-22" href="#__codelineno-63-22"></a><span class="w">            </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-63-23"><a id="__codelineno-63-23" name="__codelineno-63-23" href="#__codelineno-63-23"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-24"><a id="__codelineno-63-24" name="__codelineno-63-24" href="#__codelineno-63-24"></a><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">opCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">permissionToOpCode</span><span class="p">(</span><span class="n">filter</span><span class="p">.</span><span class="na">requiredPermission</span><span class="p">);</span>
</span><span id="__span-63-25"><a id="__codelineno-63-25" name="__codelineno-63-25" href="#__codelineno-63-25"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">opCode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">OP_NONE</span>
</span><span id="__span-63-26"><a id="__codelineno-63-26" name="__codelineno-63-26" href="#__codelineno-63-26"></a><span class="w">                    </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mService</span><span class="p">.</span><span class="na">getAppOpsManager</span><span class="p">().</span><span class="na">noteOpNoThrow</span><span class="p">(</span><span class="n">opCode</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="p">,</span>
</span><span id="__span-63-27"><a id="__codelineno-63-27" name="__codelineno-63-27" href="#__codelineno-63-27"></a><span class="w">                    </span><span class="n">r</span><span class="p">.</span><span class="na">callerPackage</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callerFeatureId</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Broadcast sent to protected receiver&quot;</span><span class="p">)</span>
</span><span id="__span-63-28"><a id="__codelineno-63-28" name="__codelineno-63-28" href="#__codelineno-63-28"></a><span class="w">                    </span><span class="o">!=</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">MODE_ALLOWED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-29"><a id="__codelineno-63-29" name="__codelineno-63-29" href="#__codelineno-63-29"></a><span class="w">                </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Appop Denial: broadcasting &quot;</span>
</span><span id="__span-63-30"><a id="__codelineno-63-30" name="__codelineno-63-30" href="#__codelineno-63-30"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">toString</span><span class="p">()</span>
</span><span id="__span-63-31"><a id="__codelineno-63-31" name="__codelineno-63-31" href="#__codelineno-63-31"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; from &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callerPackage</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; (pid=&quot;</span>
</span><span id="__span-63-32"><a id="__codelineno-63-32" name="__codelineno-63-32" href="#__codelineno-63-32"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callingPid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, uid=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;)&quot;</span>
</span><span id="__span-63-33"><a id="__codelineno-63-33" name="__codelineno-63-33" href="#__codelineno-63-33"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; requires appop &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">permissionToOp</span><span class="p">(</span>
</span><span id="__span-63-34"><a id="__codelineno-63-34" name="__codelineno-63-34" href="#__codelineno-63-34"></a><span class="w">                                </span><span class="n">filter</span><span class="p">.</span><span class="na">requiredPermission</span><span class="p">)</span>
</span><span id="__span-63-35"><a id="__codelineno-63-35" name="__codelineno-63-35" href="#__codelineno-63-35"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; due to registered receiver &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">filter</span><span class="p">);</span>
</span><span id="__span-63-36"><a id="__codelineno-63-36" name="__codelineno-63-36" href="#__codelineno-63-36"></a><span class="w">                </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-63-37"><a id="__codelineno-63-37" name="__codelineno-63-37" href="#__codelineno-63-37"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-63-38"><a id="__codelineno-63-38" name="__codelineno-63-38" href="#__codelineno-63-38"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-63-39"><a id="__codelineno-63-39" name="__codelineno-63-39" href="#__codelineno-63-39"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-63-40"><a id="__codelineno-63-40" name="__codelineno-63-40" href="#__codelineno-63-40"></a>
</span><span id="__span-63-41"><a id="__codelineno-63-41" name="__codelineno-63-41" href="#__codelineno-63-41"></a><span class="w">    </span><span class="c1">// 如果要跳过，则设置该广播结束</span>
</span><span id="__span-63-42"><a id="__codelineno-63-42" name="__codelineno-63-42" href="#__codelineno-63-42"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">skip</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">app</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">app</span><span class="p">.</span><span class="na">isKilled</span><span class="p">()</span>
</span><span id="__span-63-43"><a id="__codelineno-63-43" name="__codelineno-63-43" href="#__codelineno-63-43"></a><span class="w">            </span><span class="o">||</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">app</span><span class="p">.</span><span class="na">mErrorState</span><span class="p">.</span><span class="na">isCrashing</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-44"><a id="__codelineno-63-44" name="__codelineno-63-44" href="#__codelineno-63-44"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Skipping deliver [&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;] &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span>
</span><span id="__span-63-45"><a id="__codelineno-63-45" name="__codelineno-63-45" href="#__codelineno-63-45"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; to &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;: process gone or crashing&quot;</span><span class="p">);</span>
</span><span id="__span-63-46"><a id="__codelineno-63-46" name="__codelineno-63-46" href="#__codelineno-63-46"></a><span class="w">        </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-63-47"><a id="__codelineno-63-47" name="__codelineno-63-47" href="#__codelineno-63-47"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-63-48"><a id="__codelineno-63-48" name="__codelineno-63-48" href="#__codelineno-63-48"></a>
</span><span id="__span-63-49"><a id="__codelineno-63-49" name="__codelineno-63-49" href="#__codelineno-63-49"></a><span class="w">    </span><span class="c1">//Instant Apps skip的场景</span>
</span><span id="__span-63-50"><a id="__codelineno-63-50" name="__codelineno-63-50" href="#__codelineno-63-50"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-63-51"><a id="__codelineno-63-51" name="__codelineno-63-51" href="#__codelineno-63-51"></a>
</span><span id="__span-63-52"><a id="__codelineno-63-52" name="__codelineno-63-52" href="#__codelineno-63-52"></a><span class="w">    </span><span class="c1">// 检查广播发送者的权限</span>
</span><span id="__span-63-53"><a id="__codelineno-63-53" name="__codelineno-63-53" href="#__codelineno-63-53"></a><span class="w">    </span><span class="c1">// Check that the receiver has the required permission(s) to receive this broadcast.</span>
</span><span id="__span-63-54"><a id="__codelineno-63-54" name="__codelineno-63-54" href="#__codelineno-63-54"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">skip</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">requiredPermissions</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">requiredPermissions</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-55"><a id="__codelineno-63-55" name="__codelineno-63-55" href="#__codelineno-63-55"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">requiredPermissions</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-56"><a id="__codelineno-63-56" name="__codelineno-63-56" href="#__codelineno-63-56"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">requiredPermission</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">requiredPermissions</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">;</span>
</span><span id="__span-63-57"><a id="__codelineno-63-57" name="__codelineno-63-57" href="#__codelineno-63-57"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">perm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mService</span><span class="p">.</span><span class="na">checkComponentPermission</span><span class="p">(</span><span class="n">requiredPermission</span><span class="p">,</span>
</span><span id="__span-63-58"><a id="__codelineno-63-58" name="__codelineno-63-58" href="#__codelineno-63-58"></a><span class="w">                    </span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">pid</span><span class="p">,</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">uid</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
</span><span id="__span-63-59"><a id="__codelineno-63-59" name="__codelineno-63-59" href="#__codelineno-63-59"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">perm</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="na">PERMISSION_GRANTED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-60"><a id="__codelineno-63-60" name="__codelineno-63-60" href="#__codelineno-63-60"></a><span class="w">                </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Permission Denial: receiving &quot;</span>
</span><span id="__span-63-61"><a id="__codelineno-63-61" name="__codelineno-63-61" href="#__codelineno-63-61"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">toString</span><span class="p">()</span>
</span><span id="__span-63-62"><a id="__codelineno-63-62" name="__codelineno-63-62" href="#__codelineno-63-62"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; to &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">app</span>
</span><span id="__span-63-63"><a id="__codelineno-63-63" name="__codelineno-63-63" href="#__codelineno-63-63"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; (pid=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">pid</span>
</span><span id="__span-63-64"><a id="__codelineno-63-64" name="__codelineno-63-64" href="#__codelineno-63-64"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, uid=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">uid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;)&quot;</span>
</span><span id="__span-63-65"><a id="__codelineno-63-65" name="__codelineno-63-65" href="#__codelineno-63-65"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; requires &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">requiredPermission</span>
</span><span id="__span-63-66"><a id="__codelineno-63-66" name="__codelineno-63-66" href="#__codelineno-63-66"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; due to sender &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callerPackage</span>
</span><span id="__span-63-67"><a id="__codelineno-63-67" name="__codelineno-63-67" href="#__codelineno-63-67"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; (uid &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="p">);</span>
</span><span id="__span-63-68"><a id="__codelineno-63-68" name="__codelineno-63-68" href="#__codelineno-63-68"></a><span class="w">                </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-63-69"><a id="__codelineno-63-69" name="__codelineno-63-69" href="#__codelineno-63-69"></a><span class="w">                </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-63-70"><a id="__codelineno-63-70" name="__codelineno-63-70" href="#__codelineno-63-70"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-63-71"><a id="__codelineno-63-71" name="__codelineno-63-71" href="#__codelineno-63-71"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">appOp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">permissionToOpCode</span><span class="p">(</span><span class="n">requiredPermission</span><span class="p">);</span>
</span><span id="__span-63-72"><a id="__codelineno-63-72" name="__codelineno-63-72" href="#__codelineno-63-72"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">appOp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">OP_NONE</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">appOp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">appOp</span>
</span><span id="__span-63-73"><a id="__codelineno-63-73" name="__codelineno-63-73" href="#__codelineno-63-73"></a><span class="w">                    </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mService</span><span class="p">.</span><span class="na">getAppOpsManager</span><span class="p">().</span><span class="na">noteOpNoThrow</span><span class="p">(</span><span class="n">appOp</span><span class="p">,</span>
</span><span id="__span-63-74"><a id="__codelineno-63-74" name="__codelineno-63-74" href="#__codelineno-63-74"></a><span class="w">                    </span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">uid</span><span class="p">,</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="na">packageName</span><span class="p">,</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="na">featureId</span><span class="p">,</span>
</span><span id="__span-63-75"><a id="__codelineno-63-75" name="__codelineno-63-75" href="#__codelineno-63-75"></a><span class="w">                    </span><span class="s">&quot;Broadcast delivered to registered receiver &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="na">receiverId</span><span class="p">)</span>
</span><span id="__span-63-76"><a id="__codelineno-63-76" name="__codelineno-63-76" href="#__codelineno-63-76"></a><span class="w">                    </span><span class="o">!=</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">MODE_ALLOWED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-77"><a id="__codelineno-63-77" name="__codelineno-63-77" href="#__codelineno-63-77"></a><span class="w">                </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Appop Denial: receiving &quot;</span>
</span><span id="__span-63-78"><a id="__codelineno-63-78" name="__codelineno-63-78" href="#__codelineno-63-78"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">toString</span><span class="p">()</span>
</span><span id="__span-63-79"><a id="__codelineno-63-79" name="__codelineno-63-79" href="#__codelineno-63-79"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; to &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">app</span>
</span><span id="__span-63-80"><a id="__codelineno-63-80" name="__codelineno-63-80" href="#__codelineno-63-80"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; (pid=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">pid</span>
</span><span id="__span-63-81"><a id="__codelineno-63-81" name="__codelineno-63-81" href="#__codelineno-63-81"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, uid=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">uid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;)&quot;</span>
</span><span id="__span-63-82"><a id="__codelineno-63-82" name="__codelineno-63-82" href="#__codelineno-63-82"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; requires appop &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">permissionToOp</span><span class="p">(</span>
</span><span id="__span-63-83"><a id="__codelineno-63-83" name="__codelineno-63-83" href="#__codelineno-63-83"></a><span class="w">                        </span><span class="n">requiredPermission</span><span class="p">)</span>
</span><span id="__span-63-84"><a id="__codelineno-63-84" name="__codelineno-63-84" href="#__codelineno-63-84"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; due to sender &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callerPackage</span>
</span><span id="__span-63-85"><a id="__codelineno-63-85" name="__codelineno-63-85" href="#__codelineno-63-85"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; (uid &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="p">);</span>
</span><span id="__span-63-86"><a id="__codelineno-63-86" name="__codelineno-63-86" href="#__codelineno-63-86"></a><span class="w">                </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-63-87"><a id="__codelineno-63-87" name="__codelineno-63-87" href="#__codelineno-63-87"></a><span class="w">                </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-63-88"><a id="__codelineno-63-88" name="__codelineno-63-88" href="#__codelineno-63-88"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-63-89"><a id="__codelineno-63-89" name="__codelineno-63-89" href="#__codelineno-63-89"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-63-90"><a id="__codelineno-63-90" name="__codelineno-63-90" href="#__codelineno-63-90"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-63-91"><a id="__codelineno-63-91" name="__codelineno-63-91" href="#__codelineno-63-91"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">skip</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">requiredPermissions</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">requiredPermissions</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-92"><a id="__codelineno-63-92" name="__codelineno-63-92" href="#__codelineno-63-92"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">perm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mService</span><span class="p">.</span><span class="na">checkComponentPermission</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span>
</span><span id="__span-63-93"><a id="__codelineno-63-93" name="__codelineno-63-93" href="#__codelineno-63-93"></a><span class="w">                </span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">pid</span><span class="p">,</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">uid</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
</span><span id="__span-63-94"><a id="__codelineno-63-94" name="__codelineno-63-94" href="#__codelineno-63-94"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">perm</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="na">PERMISSION_GRANTED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-95"><a id="__codelineno-63-95" name="__codelineno-63-95" href="#__codelineno-63-95"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Permission Denial: security check failed when receiving &quot;</span>
</span><span id="__span-63-96"><a id="__codelineno-63-96" name="__codelineno-63-96" href="#__codelineno-63-96"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">toString</span><span class="p">()</span>
</span><span id="__span-63-97"><a id="__codelineno-63-97" name="__codelineno-63-97" href="#__codelineno-63-97"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; to &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">app</span>
</span><span id="__span-63-98"><a id="__codelineno-63-98" name="__codelineno-63-98" href="#__codelineno-63-98"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; (pid=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">pid</span>
</span><span id="__span-63-99"><a id="__codelineno-63-99" name="__codelineno-63-99" href="#__codelineno-63-99"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, uid=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">uid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;)&quot;</span>
</span><span id="__span-63-100"><a id="__codelineno-63-100" name="__codelineno-63-100" href="#__codelineno-63-100"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; due to sender &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callerPackage</span>
</span><span id="__span-63-101"><a id="__codelineno-63-101" name="__codelineno-63-101" href="#__codelineno-63-101"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; (uid &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="p">);</span>
</span><span id="__span-63-102"><a id="__codelineno-63-102" name="__codelineno-63-102" href="#__codelineno-63-102"></a><span class="w">            </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-63-103"><a id="__codelineno-63-103" name="__codelineno-63-103" href="#__codelineno-63-103"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-63-104"><a id="__codelineno-63-104" name="__codelineno-63-104" href="#__codelineno-63-104"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-63-105"><a id="__codelineno-63-105" name="__codelineno-63-105" href="#__codelineno-63-105"></a>
</span><span id="__span-63-106"><a id="__codelineno-63-106" name="__codelineno-63-106" href="#__codelineno-63-106"></a><span class="w">    </span><span class="c1">//permissions to exclude</span>
</span><span id="__span-63-107"><a id="__codelineno-63-107" name="__codelineno-63-107" href="#__codelineno-63-107"></a><span class="w">    </span><span class="c1">//packages to exclude</span>
</span><span id="__span-63-108"><a id="__codelineno-63-108" name="__codelineno-63-108" href="#__codelineno-63-108"></a><span class="w">    </span><span class="c1">//检查</span>
</span><span id="__span-63-109"><a id="__codelineno-63-109" name="__codelineno-63-109" href="#__codelineno-63-109"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-63-110"><a id="__codelineno-63-110" name="__codelineno-63-110" href="#__codelineno-63-110"></a>
</span><span id="__span-63-111"><a id="__codelineno-63-111" name="__codelineno-63-111" href="#__codelineno-63-111"></a>
</span><span id="__span-63-112"><a id="__codelineno-63-112" name="__codelineno-63-112" href="#__codelineno-63-112"></a><span class="w">    </span><span class="c1">//如果要跳过，则设置该广播结束</span>
</span><span id="__span-63-113"><a id="__codelineno-63-113" name="__codelineno-63-113" href="#__codelineno-63-113"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">skip</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-114"><a id="__codelineno-63-114" name="__codelineno-63-114" href="#__codelineno-63-114"></a><span class="w">        </span><span class="n">r</span><span class="p">.</span><span class="na">delivery</span><span class="o">[</span><span class="n">index</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">.</span><span class="na">DELIVERY_SKIPPED</span><span class="p">;</span>
</span><span id="__span-63-115"><a id="__codelineno-63-115" name="__codelineno-63-115" href="#__codelineno-63-115"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-63-116"><a id="__codelineno-63-116" name="__codelineno-63-116" href="#__codelineno-63-116"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-63-117"><a id="__codelineno-63-117" name="__codelineno-63-117" href="#__codelineno-63-117"></a>
</span><span id="__span-63-118"><a id="__codelineno-63-118" name="__codelineno-63-118" href="#__codelineno-63-118"></a><span class="w">    </span><span class="c1">// If permissions need a review before any of the app components can run, we drop</span>
</span><span id="__span-63-119"><a id="__codelineno-63-119" name="__codelineno-63-119" href="#__codelineno-63-119"></a><span class="w">    </span><span class="c1">// the broadcast and if the calling app is in the foreground and the broadcast is</span>
</span><span id="__span-63-120"><a id="__codelineno-63-120" name="__codelineno-63-120" href="#__codelineno-63-120"></a><span class="w">    </span><span class="c1">// explicit we launch the review UI passing it a pending intent to send the skipped</span>
</span><span id="__span-63-121"><a id="__codelineno-63-121" name="__codelineno-63-121" href="#__codelineno-63-121"></a><span class="w">    </span><span class="c1">// broadcast.</span>
</span><span id="__span-63-122"><a id="__codelineno-63-122" name="__codelineno-63-122" href="#__codelineno-63-122"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">requestStartTargetPermissionsReviewIfNeededLocked</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="na">packageName</span><span class="p">,</span>
</span><span id="__span-63-123"><a id="__codelineno-63-123" name="__codelineno-63-123" href="#__codelineno-63-123"></a><span class="w">            </span><span class="n">filter</span><span class="p">.</span><span class="na">owningUserId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-124"><a id="__codelineno-63-124" name="__codelineno-63-124" href="#__codelineno-63-124"></a><span class="w">        </span><span class="n">r</span><span class="p">.</span><span class="na">delivery</span><span class="o">[</span><span class="n">index</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">.</span><span class="na">DELIVERY_SKIPPED</span><span class="p">;</span>
</span><span id="__span-63-125"><a id="__codelineno-63-125" name="__codelineno-63-125" href="#__codelineno-63-125"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-63-126"><a id="__codelineno-63-126" name="__codelineno-63-126" href="#__codelineno-63-126"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-63-127"><a id="__codelineno-63-127" name="__codelineno-63-127" href="#__codelineno-63-127"></a>
</span><span id="__span-63-128"><a id="__codelineno-63-128" name="__codelineno-63-128" href="#__codelineno-63-128"></a><span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="na">delivery</span><span class="o">[</span><span class="n">index</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">.</span><span class="na">DELIVERY_DELIVERED</span><span class="p">;</span>
</span><span id="__span-63-129"><a id="__codelineno-63-129" name="__codelineno-63-129" href="#__codelineno-63-129"></a>
</span><span id="__span-63-130"><a id="__codelineno-63-130" name="__codelineno-63-130" href="#__codelineno-63-130"></a><span class="w">    </span><span class="c1">// If this is not being sent as an ordered broadcast, then we</span>
</span><span id="__span-63-131"><a id="__codelineno-63-131" name="__codelineno-63-131" href="#__codelineno-63-131"></a><span class="w">    </span><span class="c1">// don&#39;t want to touch the fields that keep track of the current</span>
</span><span id="__span-63-132"><a id="__codelineno-63-132" name="__codelineno-63-132" href="#__codelineno-63-132"></a><span class="w">    </span><span class="c1">// state of ordered broadcasts.</span>
</span><span id="__span-63-133"><a id="__codelineno-63-133" name="__codelineno-63-133" href="#__codelineno-63-133"></a><span class="w">    </span><span class="c1">//order广播，所有的接收者需要依次以一种同步的方式发送广播，</span>
</span><span id="__span-63-134"><a id="__codelineno-63-134" name="__codelineno-63-134" href="#__codelineno-63-134"></a><span class="w">    </span><span class="c1">//可以看到order广播在BroadcastRecord保存了几个状态</span>
</span><span id="__span-63-135"><a id="__codelineno-63-135" name="__codelineno-63-135" href="#__codelineno-63-135"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ordered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-136"><a id="__codelineno-63-136" name="__codelineno-63-136" href="#__codelineno-63-136"></a><span class="w">        </span><span class="c1">// IBinder类型，代表当前的接收者</span>
</span><span id="__span-63-137"><a id="__codelineno-63-137" name="__codelineno-63-137" href="#__codelineno-63-137"></a><span class="w">        </span><span class="n">r</span><span class="p">.</span><span class="na">receiver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">receiver</span><span class="p">.</span><span class="na">asBinder</span><span class="p">();</span>
</span><span id="__span-63-138"><a id="__codelineno-63-138" name="__codelineno-63-138" href="#__codelineno-63-138"></a><span class="w">        </span><span class="c1">// 当前正在处理的BroadcastFilter，和上面的receiver是对应好的</span>
</span><span id="__span-63-139"><a id="__codelineno-63-139" name="__codelineno-63-139" href="#__codelineno-63-139"></a><span class="w">        </span><span class="n">r</span><span class="p">.</span><span class="na">curFilter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filter</span><span class="p">;</span>
</span><span id="__span-63-140"><a id="__codelineno-63-140" name="__codelineno-63-140" href="#__codelineno-63-140"></a><span class="w">        </span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">curBroadcast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">;</span>
</span><span id="__span-63-141"><a id="__codelineno-63-141" name="__codelineno-63-141" href="#__codelineno-63-141"></a><span class="w">        </span><span class="n">r</span><span class="p">.</span><span class="na">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">.</span><span class="na">CALL_IN_RECEIVE</span><span class="p">;</span>
</span><span id="__span-63-142"><a id="__codelineno-63-142" name="__codelineno-63-142" href="#__codelineno-63-142"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">app</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-143"><a id="__codelineno-63-143" name="__codelineno-63-143" href="#__codelineno-63-143"></a><span class="w">            </span><span class="c1">// Bump hosting application to no longer be in background</span>
</span><span id="__span-63-144"><a id="__codelineno-63-144" name="__codelineno-63-144" href="#__codelineno-63-144"></a><span class="w">            </span><span class="c1">// scheduling class.  Note that we can&#39;t do that if there</span>
</span><span id="__span-63-145"><a id="__codelineno-63-145" name="__codelineno-63-145" href="#__codelineno-63-145"></a><span class="w">            </span><span class="c1">// isn&#39;t an app...  but we can only be in that case for</span>
</span><span id="__span-63-146"><a id="__codelineno-63-146" name="__codelineno-63-146" href="#__codelineno-63-146"></a><span class="w">            </span><span class="c1">// things that directly call the IActivityManager API, which</span>
</span><span id="__span-63-147"><a id="__codelineno-63-147" name="__codelineno-63-147" href="#__codelineno-63-147"></a><span class="w">            </span><span class="c1">// are already core system stuff so don&#39;t matter for this.</span>
</span><span id="__span-63-148"><a id="__codelineno-63-148" name="__codelineno-63-148" href="#__codelineno-63-148"></a><span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="na">curApp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">app</span><span class="p">;</span>
</span><span id="__span-63-149"><a id="__codelineno-63-149" name="__codelineno-63-149" href="#__codelineno-63-149"></a><span class="w">            </span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">app</span><span class="p">.</span><span class="na">mReceivers</span><span class="p">.</span><span class="na">addCurReceiver</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-63-150"><a id="__codelineno-63-150" name="__codelineno-63-150" href="#__codelineno-63-150"></a><span class="w">            </span><span class="n">mService</span><span class="p">.</span><span class="na">enqueueOomAdjTargetLocked</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">curApp</span><span class="p">);</span>
</span><span id="__span-63-151"><a id="__codelineno-63-151" name="__codelineno-63-151" href="#__codelineno-63-151"></a><span class="w">            </span><span class="n">mService</span><span class="p">.</span><span class="na">updateOomAdjPendingTargetsLocked</span><span class="p">(</span>
</span><span id="__span-63-152"><a id="__codelineno-63-152" name="__codelineno-63-152" href="#__codelineno-63-152"></a><span class="w">                    </span><span class="n">OomAdjuster</span><span class="p">.</span><span class="na">OOM_ADJ_REASON_START_RECEIVER</span><span class="p">);</span>
</span><span id="__span-63-153"><a id="__codelineno-63-153" name="__codelineno-63-153" href="#__codelineno-63-153"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-63-154"><a id="__codelineno-63-154" name="__codelineno-63-154" href="#__codelineno-63-154"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">app</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-155"><a id="__codelineno-63-155" name="__codelineno-63-155" href="#__codelineno-63-155"></a><span class="w">        </span><span class="n">mService</span><span class="p">.</span><span class="na">mOomAdjuster</span><span class="p">.</span><span class="na">mCachedAppOptimizer</span><span class="p">.</span><span class="na">unfreezeTemporarily</span><span class="p">(</span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">app</span><span class="p">);</span>
</span><span id="__span-63-156"><a id="__codelineno-63-156" name="__codelineno-63-156" href="#__codelineno-63-156"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-63-157"><a id="__codelineno-63-157" name="__codelineno-63-157" href="#__codelineno-63-157"></a>
</span><span id="__span-63-158"><a id="__codelineno-63-158" name="__codelineno-63-158" href="#__codelineno-63-158"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-159"><a id="__codelineno-63-159" name="__codelineno-63-159" href="#__codelineno-63-159"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST_LIGHT</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span>
</span><span id="__span-63-160"><a id="__codelineno-63-160" name="__codelineno-63-160" href="#__codelineno-63-160"></a><span class="w">                </span><span class="s">&quot;Delivering to &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">filter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; : &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-63-161"><a id="__codelineno-63-161" name="__codelineno-63-161" href="#__codelineno-63-161"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">app</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">app</span><span class="p">.</span><span class="na">isInFullBackup</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-162"><a id="__codelineno-63-162" name="__codelineno-63-162" href="#__codelineno-63-162"></a><span class="w">            </span><span class="c1">// Skip delivery if full backup in progress</span>
</span><span id="__span-63-163"><a id="__codelineno-63-163" name="__codelineno-63-163" href="#__codelineno-63-163"></a><span class="w">            </span><span class="c1">// If it&#39;s an ordered broadcast, we need to continue to the next receiver.</span>
</span><span id="__span-63-164"><a id="__codelineno-63-164" name="__codelineno-63-164" href="#__codelineno-63-164"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ordered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-165"><a id="__codelineno-63-165" name="__codelineno-63-165" href="#__codelineno-63-165"></a><span class="w">                </span><span class="c1">// 如果正在备份或者恢复备份跳过，</span>
</span><span id="__span-63-166"><a id="__codelineno-63-166" name="__codelineno-63-166" href="#__codelineno-63-166"></a><span class="w">                </span><span class="c1">// 如果是一个有序广播，则执行下一个广播</span>
</span><span id="__span-63-167"><a id="__codelineno-63-167" name="__codelineno-63-167" href="#__codelineno-63-167"></a><span class="w">                </span><span class="n">skipReceiverLocked</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-63-168"><a id="__codelineno-63-168" name="__codelineno-63-168" href="#__codelineno-63-168"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-63-169"><a id="__codelineno-63-169" name="__codelineno-63-169" href="#__codelineno-63-169"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-170"><a id="__codelineno-63-170" name="__codelineno-63-170" href="#__codelineno-63-170"></a><span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="na">receiverTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SystemClock</span><span class="p">.</span><span class="na">uptimeMillis</span><span class="p">();</span>
</span><span id="__span-63-171"><a id="__codelineno-63-171" name="__codelineno-63-171" href="#__codelineno-63-171"></a><span class="w">            </span><span class="n">maybeAddAllowBackgroundActivityStartsToken</span><span class="p">(</span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">app</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-63-172"><a id="__codelineno-63-172" name="__codelineno-63-172" href="#__codelineno-63-172"></a><span class="w">            </span><span class="n">maybeScheduleTempAllowlistLocked</span><span class="p">(</span><span class="n">filter</span><span class="p">.</span><span class="na">owningUid</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">options</span><span class="p">);</span>
</span><span id="__span-63-173"><a id="__codelineno-63-173" name="__codelineno-63-173" href="#__codelineno-63-173"></a><span class="w">            </span><span class="n">maybeReportBroadcastDispatchedEventLocked</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="na">owningUid</span><span class="p">);</span>
</span><span id="__span-63-174"><a id="__codelineno-63-174" name="__codelineno-63-174" href="#__codelineno-63-174"></a><span class="w">            </span><span class="c1">//如果不需要进行权限检查或者通过权限检查，调用performReceiveLocked发送广播</span>
</span><span id="__span-63-175"><a id="__codelineno-63-175" name="__codelineno-63-175" href="#__codelineno-63-175"></a><span class="w">            </span><span class="n">performReceiveLocked</span><span class="p">(</span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">app</span><span class="p">,</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">receiver</span><span class="p">,</span>
</span><span id="__span-63-176"><a id="__codelineno-63-176" name="__codelineno-63-176" href="#__codelineno-63-176"></a><span class="w">                    </span><span class="k">new</span><span class="w"> </span><span class="n">Intent</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">),</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">resultCode</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">resultData</span><span class="p">,</span>
</span><span id="__span-63-177"><a id="__codelineno-63-177" name="__codelineno-63-177" href="#__codelineno-63-177"></a><span class="w">                    </span><span class="n">r</span><span class="p">.</span><span class="na">resultExtras</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">ordered</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">initialSticky</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">userId</span><span class="p">,</span>
</span><span id="__span-63-178"><a id="__codelineno-63-178" name="__codelineno-63-178" href="#__codelineno-63-178"></a><span class="w">                    </span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">uid</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="p">);</span>
</span><span id="__span-63-179"><a id="__codelineno-63-179" name="__codelineno-63-179" href="#__codelineno-63-179"></a><span class="w">            </span><span class="c1">// parallel broadcasts are fire-and-forget, not bookended by a call to</span>
</span><span id="__span-63-180"><a id="__codelineno-63-180" name="__codelineno-63-180" href="#__codelineno-63-180"></a><span class="w">            </span><span class="c1">// finishReceiverLocked(), so we manage their activity-start token here</span>
</span><span id="__span-63-181"><a id="__codelineno-63-181" name="__codelineno-63-181" href="#__codelineno-63-181"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">app</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span>
</span><span id="__span-63-182"><a id="__codelineno-63-182" name="__codelineno-63-182" href="#__codelineno-63-182"></a><span class="w">                    </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">allowBackgroundActivityStarts</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">r</span><span class="p">.</span><span class="na">ordered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-183"><a id="__codelineno-63-183" name="__codelineno-63-183" href="#__codelineno-63-183"></a><span class="w">                </span><span class="n">postActivityStartTokenRemoval</span><span class="p">(</span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">app</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-63-184"><a id="__codelineno-63-184" name="__codelineno-63-184" href="#__codelineno-63-184"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-63-185"><a id="__codelineno-63-185" name="__codelineno-63-185" href="#__codelineno-63-185"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-63-186"><a id="__codelineno-63-186" name="__codelineno-63-186" href="#__codelineno-63-186"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ordered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-187"><a id="__codelineno-63-187" name="__codelineno-63-187" href="#__codelineno-63-187"></a><span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="na">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">.</span><span class="na">CALL_DONE_RECEIVE</span><span class="p">;</span>
</span><span id="__span-63-188"><a id="__codelineno-63-188" name="__codelineno-63-188" href="#__codelineno-63-188"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-63-189"><a id="__codelineno-63-189" name="__codelineno-63-189" href="#__codelineno-63-189"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-190"><a id="__codelineno-63-190" name="__codelineno-63-190" href="#__codelineno-63-190"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Failure sending broadcast &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
</span><span id="__span-63-191"><a id="__codelineno-63-191" name="__codelineno-63-191" href="#__codelineno-63-191"></a><span class="w">        </span><span class="c1">// Clean up ProcessRecord state related to this broadcast attempt</span>
</span><span id="__span-63-192"><a id="__codelineno-63-192" name="__codelineno-63-192" href="#__codelineno-63-192"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">app</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-193"><a id="__codelineno-63-193" name="__codelineno-63-193" href="#__codelineno-63-193"></a><span class="w">            </span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">app</span><span class="p">.</span><span class="na">removeAllowBackgroundActivityStartsToken</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-63-194"><a id="__codelineno-63-194" name="__codelineno-63-194" href="#__codelineno-63-194"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ordered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-195"><a id="__codelineno-63-195" name="__codelineno-63-195" href="#__codelineno-63-195"></a><span class="w">                </span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">app</span><span class="p">.</span><span class="na">mReceivers</span><span class="p">.</span><span class="na">removeCurReceiver</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-63-196"><a id="__codelineno-63-196" name="__codelineno-63-196" href="#__codelineno-63-196"></a><span class="w">                </span><span class="c1">// Something wrong, its oom adj could be downgraded, but not in a hurry.</span>
</span><span id="__span-63-197"><a id="__codelineno-63-197" name="__codelineno-63-197" href="#__codelineno-63-197"></a><span class="w">                </span><span class="n">mService</span><span class="p">.</span><span class="na">enqueueOomAdjTargetLocked</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">curApp</span><span class="p">);</span>
</span><span id="__span-63-198"><a id="__codelineno-63-198" name="__codelineno-63-198" href="#__codelineno-63-198"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-63-199"><a id="__codelineno-63-199" name="__codelineno-63-199" href="#__codelineno-63-199"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-63-200"><a id="__codelineno-63-200" name="__codelineno-63-200" href="#__codelineno-63-200"></a><span class="w">        </span><span class="c1">// And BroadcastRecord state related to ordered delivery, if appropriate</span>
</span><span id="__span-63-201"><a id="__codelineno-63-201" name="__codelineno-63-201" href="#__codelineno-63-201"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ordered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-202"><a id="__codelineno-63-202" name="__codelineno-63-202" href="#__codelineno-63-202"></a><span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="na">receiver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-63-203"><a id="__codelineno-63-203" name="__codelineno-63-203" href="#__codelineno-63-203"></a><span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="na">curFilter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-63-204"><a id="__codelineno-63-204" name="__codelineno-63-204" href="#__codelineno-63-204"></a><span class="w">            </span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">curBroadcast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-63-205"><a id="__codelineno-63-205" name="__codelineno-63-205" href="#__codelineno-63-205"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-63-206"><a id="__codelineno-63-206" name="__codelineno-63-206" href="#__codelineno-63-206"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-63-207"><a id="__codelineno-63-207" name="__codelineno-63-207" href="#__codelineno-63-207"></a><span class="p">}</span>
</span></code></pre></div>
<p>这个方法中主要做了权限校验，然后派发。</p>
<ul>
<li>跳过skip的场景</li>
<li>检查广播发送者的权限</li>
</ul>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a>//注册者<span class="w"> </span>申请权限
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a>//发送者<span class="w"> </span>未设置权限
</span><span id="__span-64-3"><a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a><span class="m">11</span>-11<span class="w"> </span><span class="m">03</span>:24:54.935<span class="w">  </span><span class="m">2596</span><span class="w">  </span><span class="m">2938</span><span class="w"> </span>W<span class="w"> </span>BroadcastQueue:<span class="w"> </span>Permission<span class="w"> </span>Denial:<span class="w"> </span>broadcasting<span class="w"> </span>Intent<span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="nv">act</span><span class="o">=</span>android.intent.action.extfwk.test<span class="w"> </span><span class="nv">flg</span><span class="o">=</span>0x10<span class="w"> </span><span class="o">}</span><span class="w"> </span>from<span class="w"> </span>com.android.extfwk<span class="w"> </span><span class="o">(</span><span class="nv">pid</span><span class="o">=</span><span class="m">11568</span>,<span class="w"> </span><span class="nv">uid</span><span class="o">=</span><span class="m">10205</span><span class="o">)</span><span class="w"> </span>requires<span class="w"> </span>android.permission.extfwk.test<span class="w"> </span>due<span class="w"> </span>to<span class="w"> </span>registered<span class="w"> </span>receiver<span class="w"> </span>BroadcastFilter<span class="o">{</span>4a03f68<span class="w"> </span><span class="m">1000</span>/u0<span class="w"> </span>ReceiverList<span class="o">{</span>c0d228b<span class="w"> </span><span class="m">11361</span><span class="w"> </span>com.android.systemui/1000/u0<span class="w"> </span>remote:ccee05a<span class="o">}}</span>
</span></code></pre></div>
<ul>
<li>检查广播接收者的权限</li>
</ul>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a>//注册者<span class="w"> </span>未申请权限
</span><span id="__span-65-2"><a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a>//发送者<span class="w"> </span>设置权限
</span><span id="__span-65-3"><a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a><span class="m">11</span>-11<span class="w"> </span><span class="m">03</span>:29:34.723<span class="w">  </span><span class="m">2596</span><span class="w">  </span><span class="m">2938</span><span class="w"> </span>W<span class="w"> </span>BroadcastQueue:<span class="w"> </span>Permission<span class="w"> </span>Denial:<span class="w"> </span>receiving<span class="w"> </span>Intent<span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="nv">act</span><span class="o">=</span>android.intent.action.extfwk.test<span class="w"> </span><span class="nv">flg</span><span class="o">=</span>0x10<span class="w"> </span><span class="o">}</span><span class="w"> </span>to<span class="w"> </span>ProcessRecord<span class="o">{</span>2501df2<span class="w"> </span><span class="m">12153</span>:com.android.extfwk/u0a205<span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="nv">pid</span><span class="o">=</span><span class="m">12153</span>,<span class="w"> </span><span class="nv">uid</span><span class="o">=</span><span class="m">10205</span><span class="o">)</span><span class="w"> </span>requires<span class="w"> </span>android.permission.extfwk.test<span class="w"> </span>due<span class="w"> </span>to<span class="w"> </span>sender<span class="w"> </span>com.android.bctest<span class="w"> </span><span class="o">(</span>uid<span class="w"> </span><span class="m">1000</span><span class="o">)</span>
</span></code></pre></div>
<ul>
<li>调用performReceiveLocked()派发</li>
</ul>
<p>检查权限的调用流程：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a>mService.checkComponentPermission<span class="o">()</span>,<span class="w"> </span>mService是ActivityManagerService
</span><span id="__span-66-2"><a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a>---&gt;<span class="w"> </span>ActivityManagerService.checkComponentPermission<span class="o">()</span>
</span><span id="__span-66-3"><a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a><span class="w">    </span>---&gt;<span class="w"> </span>ActivityManager.checkComponentPermission<span class="o">()</span>
</span><span id="__span-66-4"><a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a><span class="w">        </span>---&gt;<span class="w"> </span>AppGlobals.getPackageManager<span class="o">()</span>.checkUidPermission<span class="o">()</span>
</span><span id="__span-66-5"><a id="__codelineno-66-5" name="__codelineno-66-5" href="#__codelineno-66-5"></a><span class="w">            </span>---&gt;<span class="w"> </span>PackageManagerService.checkUidPermission<span class="o">()</span><span class="w"> </span>,<span class="w"> </span>
</span><span id="__span-66-6"><a id="__codelineno-66-6" name="__codelineno-66-6" href="#__codelineno-66-6"></a><span class="w">                    </span>IPackageManagerImpl<span class="w"> </span><span class="nv">iPackageManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>m.new<span class="w"> </span>IPackageManagerImpl<span class="o">()</span><span class="p">;</span>
</span><span id="__span-66-7"><a id="__codelineno-66-7" name="__codelineno-66-7" href="#__codelineno-66-7"></a><span class="w">                    </span>ServiceManager.addService<span class="o">(</span><span class="s2">&quot;package&quot;</span>,<span class="w"> </span>iPackageManager<span class="o">)</span><span class="p">;</span>
</span><span id="__span-66-8"><a id="__codelineno-66-8" name="__codelineno-66-8" href="#__codelineno-66-8"></a>
</span><span id="__span-66-9"><a id="__codelineno-66-9" name="__codelineno-66-9" href="#__codelineno-66-9"></a><span class="w">                    </span>public<span class="w"> </span>class<span class="w"> </span>IPackageManagerImpl<span class="w"> </span>extends<span class="w"> </span>IPackageManagerBase<span class="w"> </span><span class="o">{}</span>
</span><span id="__span-66-10"><a id="__codelineno-66-10" name="__codelineno-66-10" href="#__codelineno-66-10"></a>
</span><span id="__span-66-11"><a id="__codelineno-66-11" name="__codelineno-66-11" href="#__codelineno-66-11"></a><span class="w">                    </span>IPackageManagerBase.checkUidPermission<span class="w"> </span>---&gt;<span class="w">  </span>snapshot<span class="o">()</span>.checkUidPermission<span class="o">(</span>permName,<span class="w"> </span>uid<span class="o">)</span><span class="p">;</span>
</span><span id="__span-66-12"><a id="__codelineno-66-12" name="__codelineno-66-12" href="#__codelineno-66-12"></a><span class="w">                        </span>---&gt;<span class="w"> </span>ComputerEngine.checkUidPermission<span class="o">()</span>
</span><span id="__span-66-13"><a id="__codelineno-66-13" name="__codelineno-66-13" href="#__codelineno-66-13"></a><span class="w">                            </span>---&gt;<span class="w"> </span>PermissionManager.checkUidPermission<span class="o">()</span>
</span><span id="__span-66-14"><a id="__codelineno-66-14" name="__codelineno-66-14" href="#__codelineno-66-14"></a><span class="w">                                </span>---&gt;<span class="w"> </span>PermissionManagerService.checkUidPermission<span class="o">()</span>
</span></code></pre></div>
<h5 id="performreceivelocked">performReceiveLocked<a class="headerlink" href="#performreceivelocked" title="Permanent link">&para;</a></h5>
<div class="language-java highlight"><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">performReceiveLocked</span><span class="p">(</span><span class="n">ProcessRecord</span><span class="w"> </span><span class="n">app</span><span class="p">,</span><span class="w"> </span><span class="n">IIntentReceiver</span><span class="w"> </span><span class="n">receiver</span><span class="p">,</span>
</span><span id="__span-67-2"><a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a><span class="w">        </span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">resultCode</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">Bundle</span><span class="w"> </span><span class="n">extras</span><span class="p">,</span>
</span><span id="__span-67-3"><a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">ordered</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">sticky</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">sendingUser</span><span class="p">,</span>
</span><span id="__span-67-4"><a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">receiverUid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">callingUid</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">RemoteException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-67-5"><a id="__codelineno-67-5" name="__codelineno-67-5" href="#__codelineno-67-5"></a><span class="w">    </span><span class="c1">// Send the intent to the receiver asynchronously using one-way binder calls.</span>
</span><span id="__span-67-6"><a id="__codelineno-67-6" name="__codelineno-67-6" href="#__codelineno-67-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">app</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-67-7"><a id="__codelineno-67-7" name="__codelineno-67-7" href="#__codelineno-67-7"></a><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">IApplicationThread</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">app</span><span class="p">.</span><span class="na">getThread</span><span class="p">();</span>
</span><span id="__span-67-8"><a id="__codelineno-67-8" name="__codelineno-67-8" href="#__codelineno-67-8"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">thread</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="c1">// 因为是动态注册广播，所以不为空</span>
</span><span id="__span-67-9"><a id="__codelineno-67-9" name="__codelineno-67-9" href="#__codelineno-67-9"></a><span class="w">            </span><span class="c1">// If we have an app thread, do the call through that so it is</span>
</span><span id="__span-67-10"><a id="__codelineno-67-10" name="__codelineno-67-10" href="#__codelineno-67-10"></a><span class="w">            </span><span class="c1">// correctly ordered with other one-way calls.</span>
</span><span id="__span-67-11"><a id="__codelineno-67-11" name="__codelineno-67-11" href="#__codelineno-67-11"></a><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-67-12"><a id="__codelineno-67-12" name="__codelineno-67-12" href="#__codelineno-67-12"></a><span class="w">                </span><span class="c1">// 调用ApplicationThread对象的Binder代理对象的函数来向它发送广播</span>
</span><span id="__span-67-13"><a id="__codelineno-67-13" name="__codelineno-67-13" href="#__codelineno-67-13"></a><span class="w">                </span><span class="c1">// ActivityThread.java的scheduleRegisteredReceiver(这里已经是app线程了)</span>
</span><span id="__span-67-14"><a id="__codelineno-67-14" name="__codelineno-67-14" href="#__codelineno-67-14"></a><span class="w">                </span><span class="n">thread</span><span class="p">.</span><span class="na">scheduleRegisteredReceiver</span><span class="p">(</span><span class="n">receiver</span><span class="p">,</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">resultCode</span><span class="p">,</span>
</span><span id="__span-67-15"><a id="__codelineno-67-15" name="__codelineno-67-15" href="#__codelineno-67-15"></a><span class="w">                        </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">extras</span><span class="p">,</span><span class="w"> </span><span class="n">ordered</span><span class="p">,</span><span class="w"> </span><span class="n">sticky</span><span class="p">,</span><span class="w"> </span><span class="n">sendingUser</span><span class="p">,</span>
</span><span id="__span-67-16"><a id="__codelineno-67-16" name="__codelineno-67-16" href="#__codelineno-67-16"></a><span class="w">                        </span><span class="n">app</span><span class="p">.</span><span class="na">mState</span><span class="p">.</span><span class="na">getReportedProcState</span><span class="p">());</span>
</span><span id="__span-67-17"><a id="__codelineno-67-17" name="__codelineno-67-17" href="#__codelineno-67-17"></a><span class="w">            </span><span class="c1">// TODO: Uncomment this when (b/28322359) is fixed and we aren&#39;t getting</span>
</span><span id="__span-67-18"><a id="__codelineno-67-18" name="__codelineno-67-18" href="#__codelineno-67-18"></a><span class="w">            </span><span class="c1">// DeadObjectException when the process isn&#39;t actually dead.</span>
</span><span id="__span-67-19"><a id="__codelineno-67-19" name="__codelineno-67-19" href="#__codelineno-67-19"></a><span class="w">            </span><span class="c1">//} catch (DeadObjectException ex) {</span>
</span><span id="__span-67-20"><a id="__codelineno-67-20" name="__codelineno-67-20" href="#__codelineno-67-20"></a><span class="w">            </span><span class="c1">// Failed to call into the process.  It&#39;s dying so just let it die and move on.</span>
</span><span id="__span-67-21"><a id="__codelineno-67-21" name="__codelineno-67-21" href="#__codelineno-67-21"></a><span class="w">            </span><span class="c1">//    throw ex;</span>
</span><span id="__span-67-22"><a id="__codelineno-67-22" name="__codelineno-67-22" href="#__codelineno-67-22"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-67-23"><a id="__codelineno-67-23" name="__codelineno-67-23" href="#__codelineno-67-23"></a><span class="w">                </span><span class="c1">// Failed to call into the process. It&#39;s either dying or wedged. Kill it gently.</span>
</span><span id="__span-67-24"><a id="__codelineno-67-24" name="__codelineno-67-24" href="#__codelineno-67-24"></a><span class="w">                </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mService</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-67-25"><a id="__codelineno-67-25" name="__codelineno-67-25" href="#__codelineno-67-25"></a><span class="w">                    </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Can&#39;t deliver broadcast to &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">app</span><span class="p">.</span><span class="na">processName</span>
</span><span id="__span-67-26"><a id="__codelineno-67-26" name="__codelineno-67-26" href="#__codelineno-67-26"></a><span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; (pid &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">app</span><span class="p">.</span><span class="na">getPid</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;). Crashing it.&quot;</span><span class="p">);</span>
</span><span id="__span-67-27"><a id="__codelineno-67-27" name="__codelineno-67-27" href="#__codelineno-67-27"></a><span class="w">                    </span><span class="n">app</span><span class="p">.</span><span class="na">scheduleCrashLocked</span><span class="p">(</span><span class="s">&quot;can&#39;t deliver broadcast&quot;</span><span class="p">,</span>
</span><span id="__span-67-28"><a id="__codelineno-67-28" name="__codelineno-67-28" href="#__codelineno-67-28"></a><span class="w">                            </span><span class="n">CannotDeliverBroadcastException</span><span class="p">.</span><span class="na">TYPE_ID</span><span class="p">,</span><span class="w"> </span><span class="cm">/* extras=*/</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
</span><span id="__span-67-29"><a id="__codelineno-67-29" name="__codelineno-67-29" href="#__codelineno-67-29"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-67-30"><a id="__codelineno-67-30" name="__codelineno-67-30" href="#__codelineno-67-30"></a><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="n">ex</span><span class="p">;</span>
</span><span id="__span-67-31"><a id="__codelineno-67-31" name="__codelineno-67-31" href="#__codelineno-67-31"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-67-32"><a id="__codelineno-67-32" name="__codelineno-67-32" href="#__codelineno-67-32"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-67-33"><a id="__codelineno-67-33" name="__codelineno-67-33" href="#__codelineno-67-33"></a><span class="w">            </span><span class="c1">// Application has died. Receiver doesn&#39;t exist.</span>
</span><span id="__span-67-34"><a id="__codelineno-67-34" name="__codelineno-67-34" href="#__codelineno-67-34"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RemoteException</span><span class="p">(</span><span class="s">&quot;app.thread must not be null&quot;</span><span class="p">);</span>
</span><span id="__span-67-35"><a id="__codelineno-67-35" name="__codelineno-67-35" href="#__codelineno-67-35"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-67-36"><a id="__codelineno-67-36" name="__codelineno-67-36" href="#__codelineno-67-36"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-67-37"><a id="__codelineno-67-37" name="__codelineno-67-37" href="#__codelineno-67-37"></a><span class="w">        </span><span class="c1">// 直接调用与它关联的一个InnerReceiver对象的Binder代理对象的成员函数performReceive来向它发送广播</span>
</span><span id="__span-67-38"><a id="__codelineno-67-38" name="__codelineno-67-38" href="#__codelineno-67-38"></a><span class="w">        </span><span class="n">receiver</span><span class="p">.</span><span class="na">performReceive</span><span class="p">(</span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">resultCode</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">extras</span><span class="p">,</span><span class="w"> </span><span class="n">ordered</span><span class="p">,</span>
</span><span id="__span-67-39"><a id="__codelineno-67-39" name="__codelineno-67-39" href="#__codelineno-67-39"></a><span class="w">                </span><span class="n">sticky</span><span class="p">,</span><span class="w"> </span><span class="n">sendingUser</span><span class="p">);</span>
</span><span id="__span-67-40"><a id="__codelineno-67-40" name="__codelineno-67-40" href="#__codelineno-67-40"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-67-41"><a id="__codelineno-67-41" name="__codelineno-67-41" href="#__codelineno-67-41"></a><span class="w">    </span><span class="n">FrameworkStatsLog</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">BROADCAST_DELIVERY_EVENT_REPORTED</span><span class="p">,</span>
</span><span id="__span-67-42"><a id="__codelineno-67-42" name="__codelineno-67-42" href="#__codelineno-67-42"></a><span class="w">            </span><span class="n">receiverUid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">Process</span><span class="p">.</span><span class="na">SYSTEM_UID</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">receiverUid</span><span class="p">,</span>
</span><span id="__span-67-43"><a id="__codelineno-67-43" name="__codelineno-67-43" href="#__codelineno-67-43"></a><span class="w">            </span><span class="n">callingUid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">Process</span><span class="p">.</span><span class="na">SYSTEM_UID</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">callingUid</span><span class="p">,</span>
</span><span id="__span-67-44"><a id="__codelineno-67-44" name="__codelineno-67-44" href="#__codelineno-67-44"></a><span class="w">            </span><span class="n">ActivityManagerService</span><span class="p">.</span><span class="na">getShortAction</span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">()),</span>
</span><span id="__span-67-45"><a id="__codelineno-67-45" name="__codelineno-67-45" href="#__codelineno-67-45"></a><span class="w">            </span><span class="n">BROADCAST_DELIVERY_EVENT_REPORTED__RECEIVER_TYPE__RUNTIME</span><span class="p">,</span>
</span><span id="__span-67-46"><a id="__codelineno-67-46" name="__codelineno-67-46" href="#__codelineno-67-46"></a><span class="w">            </span><span class="n">BROADCAST_DELIVERY_EVENT_REPORTED__PROC_START_TYPE__PROCESS_START_TYPE_WARM</span><span class="p">);</span>
</span><span id="__span-67-47"><a id="__codelineno-67-47" name="__codelineno-67-47" href="#__codelineno-67-47"></a><span class="p">}</span>
</span></code></pre></div>
<p>当一个Activity或者一个Service将一个广播接收者注册到AMS中时，它所在的应用程序进程会先将这个广播接收者封装成一个类型为InnerReceiver的Binder本地对象，然后再注册到AMS中。因此当AMS要将一个广播发给一个目标广播接收者处理时，实际上是将这个广播转发给封装了这个目标广播接收者的一个InnerReceiver对象来处理。</p>
<p>AMS向一个应用程序进程发送一个广播时，采用的是异步进程间通信方式。前面提到，发送给一个Binder实体对象的所有异步事物都是保存在一个异步事物队列中的。由于保存在一个异步事物队列中的异步事物在同一时刻只有一个会得到处理，即只有队列头部的异步事物才会得到处理，因此AMS就可以保证它发送给同一个应用程序的所有广播都是按照这个发送顺序来串行的被接受和处理。</p>
<h5 id="activitythreadscheduleregisteredreceiver">ActivityThread.scheduleRegisteredReceiver<a class="headerlink" href="#activitythreadscheduleregisteredreceiver" title="Permanent link">&para;</a></h5>
<div class="language-java highlight"><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="c1">// This function exists to make sure all receiver dispatching is</span>
</span><span id="__span-68-2"><a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a><span class="c1">// correctly ordered, since these are one-way calls and the binder driver</span>
</span><span id="__span-68-3"><a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a><span class="c1">// applies transaction ordering per object for such calls.</span>
</span><span id="__span-68-4"><a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">scheduleRegisteredReceiver</span><span class="p">(</span><span class="n">IIntentReceiver</span><span class="w"> </span><span class="n">receiver</span><span class="p">,</span><span class="w"> </span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span>
</span><span id="__span-68-5"><a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">resultCode</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">dataStr</span><span class="p">,</span><span class="w"> </span><span class="n">Bundle</span><span class="w"> </span><span class="n">extras</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">ordered</span><span class="p">,</span>
</span><span id="__span-68-6"><a id="__codelineno-68-6" name="__codelineno-68-6" href="#__codelineno-68-6"></a><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">sticky</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">sendingUser</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">processState</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">RemoteException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-68-7"><a id="__codelineno-68-7" name="__codelineno-68-7" href="#__codelineno-68-7"></a><span class="w">    </span><span class="n">updateProcessState</span><span class="p">(</span><span class="n">processState</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
</span><span id="__span-68-8"><a id="__codelineno-68-8" name="__codelineno-68-8" href="#__codelineno-68-8"></a><span class="w">    </span><span class="n">receiver</span><span class="p">.</span><span class="na">performReceive</span><span class="p">(</span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">resultCode</span><span class="p">,</span><span class="w"> </span><span class="n">dataStr</span><span class="p">,</span><span class="w"> </span><span class="n">extras</span><span class="p">,</span><span class="w"> </span><span class="n">ordered</span><span class="p">,</span>
</span><span id="__span-68-9"><a id="__codelineno-68-9" name="__codelineno-68-9" href="#__codelineno-68-9"></a><span class="w">            </span><span class="n">sticky</span><span class="p">,</span><span class="w"> </span><span class="n">sendingUser</span><span class="p">);</span>
</span><span id="__span-68-10"><a id="__codelineno-68-10" name="__codelineno-68-10" href="#__codelineno-68-10"></a><span class="p">}</span>
</span></code></pre></div>
<p>处理非串行化动态广播，非串化ordered是false，这里的receiver对应的是LoadedApk.ReceiverDispatcher.InnerReceiver对象。从函数里可以看到，这里和第上步的else分支一样，最终还是执行receiver.performReceive方法来发送广播。</p>
<h5 id="innerreceiverperformreceive">InnerReceiver.performReceive<a class="headerlink" href="#innerreceiverperformreceive" title="Permanent link">&para;</a></h5>
<div class="language-java highlight"><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LoadedApk</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-69-2"><a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a><span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ReceiverDispatcher</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-69-3"><a id="__codelineno-69-3" name="__codelineno-69-3" href="#__codelineno-69-3"></a>
</span><span id="__span-69-4"><a id="__codelineno-69-4" name="__codelineno-69-4" href="#__codelineno-69-4"></a><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">InnerReceiver</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">IIntentReceiver</span><span class="p">.</span><span class="na">Stub</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-69-5"><a id="__codelineno-69-5" name="__codelineno-69-5" href="#__codelineno-69-5"></a><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">LoadedApk</span><span class="p">.</span><span class="na">ReceiverDispatcher</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mDispatcher</span><span class="p">;</span>
</span><span id="__span-69-6"><a id="__codelineno-69-6" name="__codelineno-69-6" href="#__codelineno-69-6"></a>
</span><span id="__span-69-7"><a id="__codelineno-69-7" name="__codelineno-69-7" href="#__codelineno-69-7"></a>
</span><span id="__span-69-8"><a id="__codelineno-69-8" name="__codelineno-69-8" href="#__codelineno-69-8"></a><span class="w">            </span><span class="nd">@Override</span>
</span><span id="__span-69-9"><a id="__codelineno-69-9" name="__codelineno-69-9" href="#__codelineno-69-9"></a><span class="w">            </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">performReceive</span><span class="p">(</span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">resultCode</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">data</span><span class="p">,</span>
</span><span id="__span-69-10"><a id="__codelineno-69-10" name="__codelineno-69-10" href="#__codelineno-69-10"></a><span class="w">                    </span><span class="n">Bundle</span><span class="w"> </span><span class="n">extras</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">ordered</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">sticky</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">sendingUser</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-69-11"><a id="__codelineno-69-11" name="__codelineno-69-11" href="#__codelineno-69-11"></a><span class="w">                </span><span class="kd">final</span><span class="w"> </span><span class="n">LoadedApk</span><span class="p">.</span><span class="na">ReceiverDispatcher</span><span class="w"> </span><span class="n">rd</span><span class="p">;</span>
</span><span id="__span-69-12"><a id="__codelineno-69-12" name="__codelineno-69-12" href="#__codelineno-69-12"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intent</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-69-13"><a id="__codelineno-69-13" name="__codelineno-69-13" href="#__codelineno-69-13"></a><span class="w">                    </span><span class="n">Log</span><span class="p">.</span><span class="na">wtf</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Null intent received&quot;</span><span class="p">);</span>
</span><span id="__span-69-14"><a id="__codelineno-69-14" name="__codelineno-69-14" href="#__codelineno-69-14"></a><span class="w">                    </span><span class="n">rd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-69-15"><a id="__codelineno-69-15" name="__codelineno-69-15" href="#__codelineno-69-15"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-69-16"><a id="__codelineno-69-16" name="__codelineno-69-16" href="#__codelineno-69-16"></a><span class="w">                    </span><span class="c1">//获取rd的实例对象</span>
</span><span id="__span-69-17"><a id="__codelineno-69-17" name="__codelineno-69-17" href="#__codelineno-69-17"></a><span class="w">                    </span><span class="n">rd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mDispatcher</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
</span><span id="__span-69-18"><a id="__codelineno-69-18" name="__codelineno-69-18" href="#__codelineno-69-18"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-69-19"><a id="__codelineno-69-19" name="__codelineno-69-19" href="#__codelineno-69-19"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ActivityThread</span><span class="p">.</span><span class="na">DEBUG_BROADCAST</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-69-20"><a id="__codelineno-69-20" name="__codelineno-69-20" href="#__codelineno-69-20"></a><span class="w">                    </span><span class="kt">int</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getIntExtra</span><span class="p">(</span><span class="s">&quot;seq&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-69-21"><a id="__codelineno-69-21" name="__codelineno-69-21" href="#__codelineno-69-21"></a><span class="w">                    </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">ActivityThread</span><span class="p">.</span><span class="na">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Receiving broadcast &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">()</span>
</span><span id="__span-69-22"><a id="__codelineno-69-22" name="__codelineno-69-22" href="#__codelineno-69-22"></a><span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; seq=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; to &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">rd</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">rd</span><span class="p">.</span><span class="na">mReceiver</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">));</span>
</span><span id="__span-69-23"><a id="__codelineno-69-23" name="__codelineno-69-23" href="#__codelineno-69-23"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-69-24"><a id="__codelineno-69-24" name="__codelineno-69-24" href="#__codelineno-69-24"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rd</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-69-25"><a id="__codelineno-69-25" name="__codelineno-69-25" href="#__codelineno-69-25"></a><span class="w">                    </span><span class="c1">//存在广播，rd 不为空，调用LoadedApk.ReceiverDispatcher对象的performReceive方法</span>
</span><span id="__span-69-26"><a id="__codelineno-69-26" name="__codelineno-69-26" href="#__codelineno-69-26"></a><span class="w">                    </span><span class="n">rd</span><span class="p">.</span><span class="na">performReceive</span><span class="p">(</span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">resultCode</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">extras</span><span class="p">,</span>
</span><span id="__span-69-27"><a id="__codelineno-69-27" name="__codelineno-69-27" href="#__codelineno-69-27"></a><span class="w">                            </span><span class="n">ordered</span><span class="p">,</span><span class="w"> </span><span class="n">sticky</span><span class="p">,</span><span class="w"> </span><span class="n">sendingUser</span><span class="p">);</span>
</span><span id="__span-69-28"><a id="__codelineno-69-28" name="__codelineno-69-28" href="#__codelineno-69-28"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-69-29"><a id="__codelineno-69-29" name="__codelineno-69-29" href="#__codelineno-69-29"></a><span class="w">                    </span><span class="c1">// The activity manager dispatched a broadcast to a registered</span>
</span><span id="__span-69-30"><a id="__codelineno-69-30" name="__codelineno-69-30" href="#__codelineno-69-30"></a><span class="w">                    </span><span class="c1">// receiver in this process, but before it could be delivered the</span>
</span><span id="__span-69-31"><a id="__codelineno-69-31" name="__codelineno-69-31" href="#__codelineno-69-31"></a><span class="w">                    </span><span class="c1">// receiver was unregistered.  Acknowledge the broadcast on its</span>
</span><span id="__span-69-32"><a id="__codelineno-69-32" name="__codelineno-69-32" href="#__codelineno-69-32"></a><span class="w">                    </span><span class="c1">// behalf so that the system&#39;s broadcast sequence can continue.</span>
</span><span id="__span-69-33"><a id="__codelineno-69-33" name="__codelineno-69-33" href="#__codelineno-69-33"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ActivityThread</span><span class="p">.</span><span class="na">DEBUG_BROADCAST</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">ActivityThread</span><span class="p">.</span><span class="na">TAG</span><span class="p">,</span>
</span><span id="__span-69-34"><a id="__codelineno-69-34" name="__codelineno-69-34" href="#__codelineno-69-34"></a><span class="w">                            </span><span class="s">&quot;Finishing broadcast to unregistered receiver&quot;</span><span class="p">);</span>
</span><span id="__span-69-35"><a id="__codelineno-69-35" name="__codelineno-69-35" href="#__codelineno-69-35"></a><span class="w">                    </span><span class="n">IActivityManager</span><span class="w"> </span><span class="n">mgr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">getService</span><span class="p">();</span>
</span><span id="__span-69-36"><a id="__codelineno-69-36" name="__codelineno-69-36" href="#__codelineno-69-36"></a><span class="w">                    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-69-37"><a id="__codelineno-69-37" name="__codelineno-69-37" href="#__codelineno-69-37"></a><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">extras</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-69-38"><a id="__codelineno-69-38" name="__codelineno-69-38" href="#__codelineno-69-38"></a><span class="w">                            </span><span class="n">extras</span><span class="p">.</span><span class="na">setAllowFds</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span><span id="__span-69-39"><a id="__codelineno-69-39" name="__codelineno-69-39" href="#__codelineno-69-39"></a><span class="w">                        </span><span class="p">}</span>
</span><span id="__span-69-40"><a id="__codelineno-69-40" name="__codelineno-69-40" href="#__codelineno-69-40"></a><span class="w">                        </span><span class="c1">//不存在广播，rd为空，调用activityManagerService对象的finishReceiver结束广播的发送接受过程</span>
</span><span id="__span-69-41"><a id="__codelineno-69-41" name="__codelineno-69-41" href="#__codelineno-69-41"></a><span class="w">                        </span><span class="n">mgr</span><span class="p">.</span><span class="na">finishReceiver</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">resultCode</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">extras</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getFlags</span><span class="p">());</span>
</span><span id="__span-69-42"><a id="__codelineno-69-42" name="__codelineno-69-42" href="#__codelineno-69-42"></a><span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-69-43"><a id="__codelineno-69-43" name="__codelineno-69-43" href="#__codelineno-69-43"></a><span class="w">                        </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">rethrowFromSystemServer</span><span class="p">();</span>
</span><span id="__span-69-44"><a id="__codelineno-69-44" name="__codelineno-69-44" href="#__codelineno-69-44"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-69-45"><a id="__codelineno-69-45" name="__codelineno-69-45" href="#__codelineno-69-45"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-69-46"><a id="__codelineno-69-46" name="__codelineno-69-46" href="#__codelineno-69-46"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-69-47"><a id="__codelineno-69-47" name="__codelineno-69-47" href="#__codelineno-69-47"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-69-48"><a id="__codelineno-69-48" name="__codelineno-69-48" href="#__codelineno-69-48"></a>
</span><span id="__span-69-49"><a id="__codelineno-69-49" name="__codelineno-69-49" href="#__codelineno-69-49"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-69-50"><a id="__codelineno-69-50" name="__codelineno-69-50" href="#__codelineno-69-50"></a><span class="p">}</span>
</span></code></pre></div>
<p>LoadedApk.ReceiverDispatcher对象封装了广播接收者，如果该广播接收者注册了，那么该对象就会存在，这里就会调用LodedApk.ReceiverDispatcher.performReceive，否则就会调用AMS.finishReceiver方法，这里我们先看存在广播的情况。</p>
<h5 id="receiverdispatcherperformreceive">ReceiverDispatcher.performReceive<a class="headerlink" href="#receiverdispatcherperformreceive" title="Permanent link">&para;</a></h5>
<div class="language-java highlight"><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LoadedApk</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-70-2"><a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a><span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ReceiverDispatcher</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-70-3"><a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a>
</span><span id="__span-70-4"><a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a>
</span><span id="__span-70-5"><a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">performReceive</span><span class="p">(</span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">resultCode</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">data</span><span class="p">,</span>
</span><span id="__span-70-6"><a id="__codelineno-70-6" name="__codelineno-70-6" href="#__codelineno-70-6"></a><span class="w">                </span><span class="n">Bundle</span><span class="w"> </span><span class="n">extras</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">ordered</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">sticky</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">sendingUser</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-70-7"><a id="__codelineno-70-7" name="__codelineno-70-7" href="#__codelineno-70-7"></a><span class="w">            </span><span class="c1">// 首先将参数Intent所描述的一个广播封装成一个Args对象，然后将这个Args对象封装成一个消息对象，</span>
</span><span id="__span-70-8"><a id="__codelineno-70-8" name="__codelineno-70-8" href="#__codelineno-70-8"></a><span class="w">            </span><span class="c1">// 然后将这个消息对象发送到应用程序主线程的消息队列中。</span>
</span><span id="__span-70-9"><a id="__codelineno-70-9" name="__codelineno-70-9" href="#__codelineno-70-9"></a><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">Args</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Args</span><span class="p">(</span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">resultCode</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">extras</span><span class="p">,</span><span class="w"> </span><span class="n">ordered</span><span class="p">,</span>
</span><span id="__span-70-10"><a id="__codelineno-70-10" name="__codelineno-70-10" href="#__codelineno-70-10"></a><span class="w">                    </span><span class="n">sticky</span><span class="p">,</span><span class="w"> </span><span class="n">sendingUser</span><span class="p">);</span>
</span><span id="__span-70-11"><a id="__codelineno-70-11" name="__codelineno-70-11" href="#__codelineno-70-11"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intent</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-70-12"><a id="__codelineno-70-12" name="__codelineno-70-12" href="#__codelineno-70-12"></a><span class="w">                </span><span class="n">Log</span><span class="p">.</span><span class="na">wtf</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Null intent received&quot;</span><span class="p">);</span>
</span><span id="__span-70-13"><a id="__codelineno-70-13" name="__codelineno-70-13" href="#__codelineno-70-13"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-70-14"><a id="__codelineno-70-14" name="__codelineno-70-14" href="#__codelineno-70-14"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ActivityThread</span><span class="p">.</span><span class="na">DEBUG_BROADCAST</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-70-15"><a id="__codelineno-70-15" name="__codelineno-70-15" href="#__codelineno-70-15"></a><span class="w">                    </span><span class="kt">int</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getIntExtra</span><span class="p">(</span><span class="s">&quot;seq&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-70-16"><a id="__codelineno-70-16" name="__codelineno-70-16" href="#__codelineno-70-16"></a><span class="w">                    </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">ActivityThread</span><span class="p">.</span><span class="na">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Enqueueing broadcast &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">()</span>
</span><span id="__span-70-17"><a id="__codelineno-70-17" name="__codelineno-70-17" href="#__codelineno-70-17"></a><span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; seq=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; to &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mReceiver</span><span class="p">);</span>
</span><span id="__span-70-18"><a id="__codelineno-70-18" name="__codelineno-70-18" href="#__codelineno-70-18"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-70-19"><a id="__codelineno-70-19" name="__codelineno-70-19" href="#__codelineno-70-19"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-70-20"><a id="__codelineno-70-20" name="__codelineno-70-20" href="#__codelineno-70-20"></a><span class="w">            </span><span class="c1">// 将args对象post到主线程的消息队列里面，作为一个Runnable调度而不是在handleMessage中处理，</span>
</span><span id="__span-70-21"><a id="__codelineno-70-21" name="__codelineno-70-21" href="#__codelineno-70-21"></a><span class="w">            </span><span class="c1">// 因此这里不久后会调用Args.run函数</span>
</span><span id="__span-70-22"><a id="__codelineno-70-22" name="__codelineno-70-22" href="#__codelineno-70-22"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intent</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">mActivityThread</span><span class="p">.</span><span class="na">post</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="na">getRunnable</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-70-23"><a id="__codelineno-70-23" name="__codelineno-70-23" href="#__codelineno-70-23"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mRegistered</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ordered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-70-24"><a id="__codelineno-70-24" name="__codelineno-70-24" href="#__codelineno-70-24"></a><span class="w">                    </span><span class="n">IActivityManager</span><span class="w"> </span><span class="n">mgr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">getService</span><span class="p">();</span>
</span><span id="__span-70-25"><a id="__codelineno-70-25" name="__codelineno-70-25" href="#__codelineno-70-25"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ActivityThread</span><span class="p">.</span><span class="na">DEBUG_BROADCAST</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">ActivityThread</span><span class="p">.</span><span class="na">TAG</span><span class="p">,</span>
</span><span id="__span-70-26"><a id="__codelineno-70-26" name="__codelineno-70-26" href="#__codelineno-70-26"></a><span class="w">                            </span><span class="s">&quot;Finishing sync broadcast to &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mReceiver</span><span class="p">);</span>
</span><span id="__span-70-27"><a id="__codelineno-70-27" name="__codelineno-70-27" href="#__codelineno-70-27"></a><span class="w">                    </span><span class="n">args</span><span class="p">.</span><span class="na">sendFinished</span><span class="p">(</span><span class="n">mgr</span><span class="p">);</span>
</span><span id="__span-70-28"><a id="__codelineno-70-28" name="__codelineno-70-28" href="#__codelineno-70-28"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-70-29"><a id="__codelineno-70-29" name="__codelineno-70-29" href="#__codelineno-70-29"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-70-30"><a id="__codelineno-70-30" name="__codelineno-70-30" href="#__codelineno-70-30"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-70-31"><a id="__codelineno-70-31" name="__codelineno-70-31" href="#__codelineno-70-31"></a>
</span><span id="__span-70-32"><a id="__codelineno-70-32" name="__codelineno-70-32" href="#__codelineno-70-32"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-70-33"><a id="__codelineno-70-33" name="__codelineno-70-33" href="#__codelineno-70-33"></a><span class="p">}</span>
</span></code></pre></div>
<p>初始化了一个Args对象，该对象实现了Runnable接口，在if语句中调用post方法，最终会调用Args中的run方法。</p>
<p>这个方法的重点在于mActivityThread.post(args.getRunnable())，不要被mActivityThread的名字迷惑，其实这是一个Handler，正是在广播动态注册的时候设置的那个handler通过这个post，切换了线程，开始执行receiver。</p>
<h5 id="argsrun">Args.run<a class="headerlink" href="#argsrun" title="Permanent link">&para;</a></h5>
<div class="language-java highlight"><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ReceiverDispatcher</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-71-2"><a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a>
</span><span id="__span-71-3"><a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Args</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">BroadcastReceiver</span><span class="p">.</span><span class="na">PendingResult</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-71-4"><a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">Intent</span><span class="w"> </span><span class="n">mCurIntent</span><span class="p">;</span>
</span><span id="__span-71-5"><a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">mOrdered</span><span class="p">;</span>
</span><span id="__span-71-6"><a id="__codelineno-71-6" name="__codelineno-71-6" href="#__codelineno-71-6"></a><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">mDispatched</span><span class="p">;</span>
</span><span id="__span-71-7"><a id="__codelineno-71-7" name="__codelineno-71-7" href="#__codelineno-71-7"></a><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">mRunCalled</span><span class="p">;</span>
</span><span id="__span-71-8"><a id="__codelineno-71-8" name="__codelineno-71-8" href="#__codelineno-71-8"></a>
</span><span id="__span-71-9"><a id="__codelineno-71-9" name="__codelineno-71-9" href="#__codelineno-71-9"></a><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="nf">Args</span><span class="p">(</span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">resultCode</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">resultData</span><span class="p">,</span><span class="w"> </span><span class="n">Bundle</span><span class="w"> </span><span class="n">resultExtras</span><span class="p">,</span>
</span><span id="__span-71-10"><a id="__codelineno-71-10" name="__codelineno-71-10" href="#__codelineno-71-10"></a><span class="w">                </span><span class="kt">boolean</span><span class="w"> </span><span class="n">ordered</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">sticky</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">sendingUser</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-71-11"><a id="__codelineno-71-11" name="__codelineno-71-11" href="#__codelineno-71-11"></a><span class="w">            </span><span class="kd">super</span><span class="p">(</span><span class="n">resultCode</span><span class="p">,</span><span class="w"> </span><span class="n">resultData</span><span class="p">,</span><span class="w"> </span><span class="n">resultExtras</span><span class="p">,</span>
</span><span id="__span-71-12"><a id="__codelineno-71-12" name="__codelineno-71-12" href="#__codelineno-71-12"></a><span class="w">                    </span><span class="n">mRegistered</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">TYPE_REGISTERED</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">TYPE_UNREGISTERED</span><span class="p">,</span><span class="w"> </span><span class="n">ordered</span><span class="p">,</span>
</span><span id="__span-71-13"><a id="__codelineno-71-13" name="__codelineno-71-13" href="#__codelineno-71-13"></a><span class="w">                    </span><span class="n">sticky</span><span class="p">,</span><span class="w"> </span><span class="n">mIIntentReceiver</span><span class="p">.</span><span class="na">asBinder</span><span class="p">(),</span><span class="w"> </span><span class="n">sendingUser</span><span class="p">,</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getFlags</span><span class="p">());</span>
</span><span id="__span-71-14"><a id="__codelineno-71-14" name="__codelineno-71-14" href="#__codelineno-71-14"></a><span class="w">            </span><span class="n">mCurIntent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="p">;</span>
</span><span id="__span-71-15"><a id="__codelineno-71-15" name="__codelineno-71-15" href="#__codelineno-71-15"></a><span class="w">            </span><span class="n">mOrdered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ordered</span><span class="p">;</span>
</span><span id="__span-71-16"><a id="__codelineno-71-16" name="__codelineno-71-16" href="#__codelineno-71-16"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-71-17"><a id="__codelineno-71-17" name="__codelineno-71-17" href="#__codelineno-71-17"></a>
</span><span id="__span-71-18"><a id="__codelineno-71-18" name="__codelineno-71-18" href="#__codelineno-71-18"></a><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Runnable</span><span class="w"> </span><span class="nf">getRunnable</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-71-19"><a id="__codelineno-71-19" name="__codelineno-71-19" href="#__codelineno-71-19"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-71-20"><a id="__codelineno-71-20" name="__codelineno-71-20" href="#__codelineno-71-20"></a><span class="w">                </span><span class="c1">//mReceiver指向一个广播接收者</span>
</span><span id="__span-71-21"><a id="__codelineno-71-21" name="__codelineno-71-21" href="#__codelineno-71-21"></a><span class="w">                </span><span class="kd">final</span><span class="w"> </span><span class="n">BroadcastReceiver</span><span class="w"> </span><span class="n">receiver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mReceiver</span><span class="p">;</span>
</span><span id="__span-71-22"><a id="__codelineno-71-22" name="__codelineno-71-22" href="#__codelineno-71-22"></a><span class="w">                </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">ordered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mOrdered</span><span class="p">;</span>
</span><span id="__span-71-23"><a id="__codelineno-71-23" name="__codelineno-71-23" href="#__codelineno-71-23"></a>
</span><span id="__span-71-24"><a id="__codelineno-71-24" name="__codelineno-71-24" href="#__codelineno-71-24"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ActivityThread</span><span class="p">.</span><span class="na">DEBUG_BROADCAST</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-71-25"><a id="__codelineno-71-25" name="__codelineno-71-25" href="#__codelineno-71-25"></a><span class="w">                    </span><span class="kt">int</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mCurIntent</span><span class="p">.</span><span class="na">getIntExtra</span><span class="p">(</span><span class="s">&quot;seq&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-71-26"><a id="__codelineno-71-26" name="__codelineno-71-26" href="#__codelineno-71-26"></a><span class="w">                    </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">ActivityThread</span><span class="p">.</span><span class="na">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Dispatching broadcast &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mCurIntent</span><span class="p">.</span><span class="na">getAction</span><span class="p">()</span>
</span><span id="__span-71-27"><a id="__codelineno-71-27" name="__codelineno-71-27" href="#__codelineno-71-27"></a><span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; seq=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; to &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mReceiver</span><span class="p">);</span>
</span><span id="__span-71-28"><a id="__codelineno-71-28" name="__codelineno-71-28" href="#__codelineno-71-28"></a><span class="w">                    </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">ActivityThread</span><span class="p">.</span><span class="na">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;  mRegistered=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mRegistered</span>
</span><span id="__span-71-29"><a id="__codelineno-71-29" name="__codelineno-71-29" href="#__codelineno-71-29"></a><span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; mOrderedHint=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ordered</span><span class="p">);</span>
</span><span id="__span-71-30"><a id="__codelineno-71-30" name="__codelineno-71-30" href="#__codelineno-71-30"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-71-31"><a id="__codelineno-71-31" name="__codelineno-71-31" href="#__codelineno-71-31"></a>
</span><span id="__span-71-32"><a id="__codelineno-71-32" name="__codelineno-71-32" href="#__codelineno-71-32"></a><span class="w">                </span><span class="kd">final</span><span class="w"> </span><span class="n">IActivityManager</span><span class="w"> </span><span class="n">mgr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">getService</span><span class="p">();</span>
</span><span id="__span-71-33"><a id="__codelineno-71-33" name="__codelineno-71-33" href="#__codelineno-71-33"></a><span class="w">                </span><span class="kd">final</span><span class="w"> </span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mCurIntent</span><span class="p">;</span>
</span><span id="__span-71-34"><a id="__codelineno-71-34" name="__codelineno-71-34" href="#__codelineno-71-34"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intent</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-71-35"><a id="__codelineno-71-35" name="__codelineno-71-35" href="#__codelineno-71-35"></a><span class="w">                    </span><span class="n">Log</span><span class="p">.</span><span class="na">wtf</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Null intent being dispatched, mDispatched=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mDispatched</span>
</span><span id="__span-71-36"><a id="__codelineno-71-36" name="__codelineno-71-36" href="#__codelineno-71-36"></a><span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">mRunCalled</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;, run() has already been called&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">));</span>
</span><span id="__span-71-37"><a id="__codelineno-71-37" name="__codelineno-71-37" href="#__codelineno-71-37"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-71-38"><a id="__codelineno-71-38" name="__codelineno-71-38" href="#__codelineno-71-38"></a>
</span><span id="__span-71-39"><a id="__codelineno-71-39" name="__codelineno-71-39" href="#__codelineno-71-39"></a><span class="w">                </span><span class="n">mCurIntent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-71-40"><a id="__codelineno-71-40" name="__codelineno-71-40" href="#__codelineno-71-40"></a><span class="w">                </span><span class="n">mDispatched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-71-41"><a id="__codelineno-71-41" name="__codelineno-71-41" href="#__codelineno-71-41"></a><span class="w">                </span><span class="n">mRunCalled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-71-42"><a id="__codelineno-71-42" name="__codelineno-71-42" href="#__codelineno-71-42"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">receiver</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">intent</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">mForgotten</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-71-43"><a id="__codelineno-71-43" name="__codelineno-71-43" href="#__codelineno-71-43"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mRegistered</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ordered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-71-44"><a id="__codelineno-71-44" name="__codelineno-71-44" href="#__codelineno-71-44"></a><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ActivityThread</span><span class="p">.</span><span class="na">DEBUG_BROADCAST</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">ActivityThread</span><span class="p">.</span><span class="na">TAG</span><span class="p">,</span>
</span><span id="__span-71-45"><a id="__codelineno-71-45" name="__codelineno-71-45" href="#__codelineno-71-45"></a><span class="w">                                </span><span class="s">&quot;Finishing null broadcast to &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mReceiver</span><span class="p">);</span>
</span><span id="__span-71-46"><a id="__codelineno-71-46" name="__codelineno-71-46" href="#__codelineno-71-46"></a><span class="w">                        </span><span class="c1">//receiver为空直接发送finish</span>
</span><span id="__span-71-47"><a id="__codelineno-71-47" name="__codelineno-71-47" href="#__codelineno-71-47"></a><span class="w">                        </span><span class="n">sendFinished</span><span class="p">(</span><span class="n">mgr</span><span class="p">);</span>
</span><span id="__span-71-48"><a id="__codelineno-71-48" name="__codelineno-71-48" href="#__codelineno-71-48"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-71-49"><a id="__codelineno-71-49" name="__codelineno-71-49" href="#__codelineno-71-49"></a><span class="w">                    </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-71-50"><a id="__codelineno-71-50" name="__codelineno-71-50" href="#__codelineno-71-50"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-71-51"><a id="__codelineno-71-51" name="__codelineno-71-51" href="#__codelineno-71-51"></a>
</span><span id="__span-71-52"><a id="__codelineno-71-52" name="__codelineno-71-52" href="#__codelineno-71-52"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Trace</span><span class="p">.</span><span class="na">isTagEnabled</span><span class="p">(</span><span class="n">Trace</span><span class="p">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-71-53"><a id="__codelineno-71-53" name="__codelineno-71-53" href="#__codelineno-71-53"></a><span class="w">                    </span><span class="n">Trace</span><span class="p">.</span><span class="na">traceBegin</span><span class="p">(</span><span class="n">Trace</span><span class="p">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="p">,</span>
</span><span id="__span-71-54"><a id="__codelineno-71-54" name="__codelineno-71-54" href="#__codelineno-71-54"></a><span class="w">                            </span><span class="s">&quot;broadcastReceiveReg: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">());</span>
</span><span id="__span-71-55"><a id="__codelineno-71-55" name="__codelineno-71-55" href="#__codelineno-71-55"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-71-56"><a id="__codelineno-71-56" name="__codelineno-71-56" href="#__codelineno-71-56"></a>
</span><span id="__span-71-57"><a id="__codelineno-71-57" name="__codelineno-71-57" href="#__codelineno-71-57"></a><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-71-58"><a id="__codelineno-71-58" name="__codelineno-71-58" href="#__codelineno-71-58"></a><span class="w">                    </span><span class="c1">//这里处理的是动态广播接收者，默认认为接收者BroadcastReceiver已经存在</span>
</span><span id="__span-71-59"><a id="__codelineno-71-59" name="__codelineno-71-59" href="#__codelineno-71-59"></a><span class="w">                    </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">cl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mReceiver</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getClassLoader</span><span class="p">();</span>
</span><span id="__span-71-60"><a id="__codelineno-71-60" name="__codelineno-71-60" href="#__codelineno-71-60"></a><span class="w">                    </span><span class="n">intent</span><span class="p">.</span><span class="na">setExtrasClassLoader</span><span class="p">(</span><span class="n">cl</span><span class="p">);</span>
</span><span id="__span-71-61"><a id="__codelineno-71-61" name="__codelineno-71-61" href="#__codelineno-71-61"></a><span class="w">                    </span><span class="c1">// TODO: determine at registration time if caller is</span>
</span><span id="__span-71-62"><a id="__codelineno-71-62" name="__codelineno-71-62" href="#__codelineno-71-62"></a><span class="w">                    </span><span class="c1">// protecting themselves with signature permission</span>
</span><span id="__span-71-63"><a id="__codelineno-71-63" name="__codelineno-71-63" href="#__codelineno-71-63"></a><span class="w">                    </span><span class="n">intent</span><span class="p">.</span><span class="na">prepareToEnterProcess</span><span class="p">(</span><span class="n">ActivityThread</span><span class="p">.</span><span class="na">isProtectedBroadcast</span><span class="p">(</span><span class="n">intent</span><span class="p">),</span>
</span><span id="__span-71-64"><a id="__codelineno-71-64" name="__codelineno-71-64" href="#__codelineno-71-64"></a><span class="w">                            </span><span class="n">mContext</span><span class="p">.</span><span class="na">getAttributionSource</span><span class="p">());</span>
</span><span id="__span-71-65"><a id="__codelineno-71-65" name="__codelineno-71-65" href="#__codelineno-71-65"></a><span class="w">                    </span><span class="n">setExtrasClassLoader</span><span class="p">(</span><span class="n">cl</span><span class="p">);</span>
</span><span id="__span-71-66"><a id="__codelineno-71-66" name="__codelineno-71-66" href="#__codelineno-71-66"></a><span class="w">                    </span><span class="n">receiver</span><span class="p">.</span><span class="na">setPendingResult</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span id="__span-71-67"><a id="__codelineno-71-67" name="__codelineno-71-67" href="#__codelineno-71-67"></a><span class="w">                    </span><span class="c1">// 终于看到了熟悉的onReceive回调了</span>
</span><span id="__span-71-68"><a id="__codelineno-71-68" name="__codelineno-71-68" href="#__codelineno-71-68"></a><span class="w">                    </span><span class="n">receiver</span><span class="p">.</span><span class="na">onReceive</span><span class="p">(</span><span class="n">mContext</span><span class="p">,</span><span class="w"> </span><span class="n">intent</span><span class="p">);</span>
</span><span id="__span-71-69"><a id="__codelineno-71-69" name="__codelineno-71-69" href="#__codelineno-71-69"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-71-70"><a id="__codelineno-71-70" name="__codelineno-71-70" href="#__codelineno-71-70"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mRegistered</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ordered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="c1">//检查当前广播是否是有序广播，并且广播接收者是否已经注册到AMS中</span>
</span><span id="__span-71-71"><a id="__codelineno-71-71" name="__codelineno-71-71" href="#__codelineno-71-71"></a><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ActivityThread</span><span class="p">.</span><span class="na">DEBUG_BROADCAST</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">ActivityThread</span><span class="p">.</span><span class="na">TAG</span><span class="p">,</span>
</span><span id="__span-71-72"><a id="__codelineno-71-72" name="__codelineno-71-72" href="#__codelineno-71-72"></a><span class="w">                                </span><span class="s">&quot;Finishing failed broadcast to &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mReceiver</span><span class="p">);</span>
</span><span id="__span-71-73"><a id="__codelineno-71-73" name="__codelineno-71-73" href="#__codelineno-71-73"></a><span class="w">                        </span><span class="c1">//通知AMS，它前面转发过来的有序广播已经处理完了，这时AMS就可以继续将这个有序广播转发给下一个目标广播接收者了</span>
</span><span id="__span-71-74"><a id="__codelineno-71-74" name="__codelineno-71-74" href="#__codelineno-71-74"></a><span class="w">                        </span><span class="n">sendFinished</span><span class="p">(</span><span class="n">mgr</span><span class="p">);</span>
</span><span id="__span-71-75"><a id="__codelineno-71-75" name="__codelineno-71-75" href="#__codelineno-71-75"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-71-76"><a id="__codelineno-71-76" name="__codelineno-71-76" href="#__codelineno-71-76"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mInstrumentation</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span>
</span><span id="__span-71-77"><a id="__codelineno-71-77" name="__codelineno-71-77" href="#__codelineno-71-77"></a><span class="w">                            </span><span class="o">!</span><span class="n">mInstrumentation</span><span class="p">.</span><span class="na">onException</span><span class="p">(</span><span class="n">mReceiver</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-71-78"><a id="__codelineno-71-78" name="__codelineno-71-78" href="#__codelineno-71-78"></a><span class="w">                        </span><span class="n">Trace</span><span class="p">.</span><span class="na">traceEnd</span><span class="p">(</span><span class="n">Trace</span><span class="p">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="p">);</span>
</span><span id="__span-71-79"><a id="__codelineno-71-79" name="__codelineno-71-79" href="#__codelineno-71-79"></a><span class="w">                        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span>
</span><span id="__span-71-80"><a id="__codelineno-71-80" name="__codelineno-71-80" href="#__codelineno-71-80"></a><span class="w">                                </span><span class="s">&quot;Error receiving broadcast &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">intent</span>
</span><span id="__span-71-81"><a id="__codelineno-71-81" name="__codelineno-71-81" href="#__codelineno-71-81"></a><span class="w">                                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; in &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mReceiver</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
</span><span id="__span-71-82"><a id="__codelineno-71-82" name="__codelineno-71-82" href="#__codelineno-71-82"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-71-83"><a id="__codelineno-71-83" name="__codelineno-71-83" href="#__codelineno-71-83"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-71-84"><a id="__codelineno-71-84" name="__codelineno-71-84" href="#__codelineno-71-84"></a>
</span><span id="__span-71-85"><a id="__codelineno-71-85" name="__codelineno-71-85" href="#__codelineno-71-85"></a><span class="w">                </span><span class="c1">//只有有序广播才会执行此步骤</span>
</span><span id="__span-71-86"><a id="__codelineno-71-86" name="__codelineno-71-86" href="#__codelineno-71-86"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">receiver</span><span class="p">.</span><span class="na">getPendingResult</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-71-87"><a id="__codelineno-71-87" name="__codelineno-71-87" href="#__codelineno-71-87"></a><span class="w">                    </span><span class="n">finish</span><span class="p">();</span>
</span><span id="__span-71-88"><a id="__codelineno-71-88" name="__codelineno-71-88" href="#__codelineno-71-88"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-71-89"><a id="__codelineno-71-89" name="__codelineno-71-89" href="#__codelineno-71-89"></a><span class="w">                </span><span class="n">Trace</span><span class="p">.</span><span class="na">traceEnd</span><span class="p">(</span><span class="n">Trace</span><span class="p">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="p">);</span>
</span><span id="__span-71-90"><a id="__codelineno-71-90" name="__codelineno-71-90" href="#__codelineno-71-90"></a><span class="w">            </span><span class="p">};</span>
</span><span id="__span-71-91"><a id="__codelineno-71-91" name="__codelineno-71-91" href="#__codelineno-71-91"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-71-92"><a id="__codelineno-71-92" name="__codelineno-71-92" href="#__codelineno-71-92"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-71-93"><a id="__codelineno-71-93" name="__codelineno-71-93" href="#__codelineno-71-93"></a>
</span><span id="__span-71-94"><a id="__codelineno-71-94" name="__codelineno-71-94" href="#__codelineno-71-94"></a><span class="p">}</span>
</span></code></pre></div>
<p>在这里调用BroadcastReceiver.onReceive方法，这样就会执行完一次无序广播的发送接受过程。</p>
<p>如果是有序广播则还需要发送finish。  </p>
<p>LodedApk.ReceiverDispatcher.performReceive函数中，如果广播不存在就会调用AMS.finishReceiver方法，所以下面我们看AMS.finishReceiver()流程。</p>
<h5 id="amsfinishreceiver">AMS.finishReceiver()<a class="headerlink" href="#amsfinishreceiver" title="Permanent link">&para;</a></h5>
<div class="language-java highlight"><pre><span></span><code><span id="__span-72-1"><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">finishReceiver</span><span class="p">(</span><span class="n">IBinder</span><span class="w"> </span><span class="n">who</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">resultCode</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">resultData</span><span class="p">,</span>
</span><span id="__span-72-2"><a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a><span class="w">            </span><span class="n">Bundle</span><span class="w"> </span><span class="n">resultExtras</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">resultAbort</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-72-3"><a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Finish receiver: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">who</span><span class="p">);</span>
</span><span id="__span-72-4"><a id="__codelineno-72-4" name="__codelineno-72-4" href="#__codelineno-72-4"></a>
</span><span id="__span-72-5"><a id="__codelineno-72-5" name="__codelineno-72-5" href="#__codelineno-72-5"></a><span class="w">    </span><span class="c1">// Refuse possible leaked file descriptors</span>
</span><span id="__span-72-6"><a id="__codelineno-72-6" name="__codelineno-72-6" href="#__codelineno-72-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">resultExtras</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">resultExtras</span><span class="p">.</span><span class="na">hasFileDescriptors</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-72-7"><a id="__codelineno-72-7" name="__codelineno-72-7" href="#__codelineno-72-7"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span><span class="s">&quot;File descriptors passed in Bundle&quot;</span><span class="p">);</span>
</span><span id="__span-72-8"><a id="__codelineno-72-8" name="__codelineno-72-8" href="#__codelineno-72-8"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-72-9"><a id="__codelineno-72-9" name="__codelineno-72-9" href="#__codelineno-72-9"></a>
</span><span id="__span-72-10"><a id="__codelineno-72-10" name="__codelineno-72-10" href="#__codelineno-72-10"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">origId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Binder</span><span class="p">.</span><span class="na">clearCallingIdentity</span><span class="p">();</span>
</span><span id="__span-72-11"><a id="__codelineno-72-11" name="__codelineno-72-11" href="#__codelineno-72-11"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-72-12"><a id="__codelineno-72-12" name="__codelineno-72-12" href="#__codelineno-72-12"></a><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">doNext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-72-13"><a id="__codelineno-72-13" name="__codelineno-72-13" href="#__codelineno-72-13"></a><span class="w">        </span><span class="n">BroadcastRecord</span><span class="w"> </span><span class="n">r</span><span class="p">;</span>
</span><span id="__span-72-14"><a id="__codelineno-72-14" name="__codelineno-72-14" href="#__codelineno-72-14"></a><span class="w">        </span><span class="n">BroadcastQueue</span><span class="w"> </span><span class="n">queue</span><span class="p">;</span>
</span><span id="__span-72-15"><a id="__codelineno-72-15" name="__codelineno-72-15" href="#__codelineno-72-15"></a>
</span><span id="__span-72-16"><a id="__codelineno-72-16" name="__codelineno-72-16" href="#__codelineno-72-16"></a><span class="w">        </span><span class="c1">// 首先辨别出当前receiver所在的BroadcastRecord属于前台广播还是后台广播，然后在对应的</span>
</span><span id="__span-72-17"><a id="__codelineno-72-17" name="__codelineno-72-17" href="#__codelineno-72-17"></a><span class="w">        </span><span class="c1">// BroadcastQueue中找出对应的BroadcastRecord，里面的finishReceiverLocked函数在前面介绍过，</span>
</span><span id="__span-72-18"><a id="__codelineno-72-18" name="__codelineno-72-18" href="#__codelineno-72-18"></a><span class="w">        </span><span class="c1">// 主要是重新设置BroadcastRecord里面一些状态变量，以便于BroadcastRecord将广播发送给下一个</span>
</span><span id="__span-72-19"><a id="__codelineno-72-19" name="__codelineno-72-19" href="#__codelineno-72-19"></a><span class="w">        </span><span class="c1">// 接收者。尤其的，如果前面的mAbortBroadcast设置为true，那么BroadcastRecord的成员resultAbort</span>
</span><span id="__span-72-20"><a id="__codelineno-72-20" name="__codelineno-72-20" href="#__codelineno-72-20"></a><span class="w">        </span><span class="c1">// 会设置成true</span>
</span><span id="__span-72-21"><a id="__codelineno-72-21" name="__codelineno-72-21" href="#__codelineno-72-21"></a><span class="w">        </span><span class="kd">synchronized</span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-72-22"><a id="__codelineno-72-22" name="__codelineno-72-22" href="#__codelineno-72-22"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isOnFgOffloadQueue</span><span class="p">(</span><span class="n">flags</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-72-23"><a id="__codelineno-72-23" name="__codelineno-72-23" href="#__codelineno-72-23"></a><span class="w">                </span><span class="n">queue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mFgOffloadBroadcastQueue</span><span class="p">;</span>
</span><span id="__span-72-24"><a id="__codelineno-72-24" name="__codelineno-72-24" href="#__codelineno-72-24"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isOnBgOffloadQueue</span><span class="p">(</span><span class="n">flags</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-72-25"><a id="__codelineno-72-25" name="__codelineno-72-25" href="#__codelineno-72-25"></a><span class="w">                </span><span class="n">queue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mBgOffloadBroadcastQueue</span><span class="p">;</span>
</span><span id="__span-72-26"><a id="__codelineno-72-26" name="__codelineno-72-26" href="#__codelineno-72-26"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-72-27"><a id="__codelineno-72-27" name="__codelineno-72-27" href="#__codelineno-72-27"></a><span class="w">                </span><span class="n">queue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">FLAG_RECEIVER_FOREGROUND</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-72-28"><a id="__codelineno-72-28" name="__codelineno-72-28" href="#__codelineno-72-28"></a><span class="w">                        </span><span class="o">?</span><span class="w"> </span><span class="n">mFgBroadcastQueue</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">mBgBroadcastQueue</span><span class="p">;</span>
</span><span id="__span-72-29"><a id="__codelineno-72-29" name="__codelineno-72-29" href="#__codelineno-72-29"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-72-30"><a id="__codelineno-72-30" name="__codelineno-72-30" href="#__codelineno-72-30"></a>
</span><span id="__span-72-31"><a id="__codelineno-72-31" name="__codelineno-72-31" href="#__codelineno-72-31"></a><span class="w">            </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queue</span><span class="p">.</span><span class="na">getMatchingOrderedReceiver</span><span class="p">(</span><span class="n">who</span><span class="p">);</span>
</span><span id="__span-72-32"><a id="__codelineno-72-32" name="__codelineno-72-32" href="#__codelineno-72-32"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-72-33"><a id="__codelineno-72-33" name="__codelineno-72-33" href="#__codelineno-72-33"></a><span class="w">                </span><span class="c1">//结束当前正在发送的广播</span>
</span><span id="__span-72-34"><a id="__codelineno-72-34" name="__codelineno-72-34" href="#__codelineno-72-34"></a><span class="w">                </span><span class="n">doNext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">queue</span><span class="p">.</span><span class="na">finishReceiverLocked</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">resultCode</span><span class="p">,</span>
</span><span id="__span-72-35"><a id="__codelineno-72-35" name="__codelineno-72-35" href="#__codelineno-72-35"></a><span class="w">                    </span><span class="n">resultData</span><span class="p">,</span><span class="w"> </span><span class="n">resultExtras</span><span class="p">,</span><span class="w"> </span><span class="n">resultAbort</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
</span><span id="__span-72-36"><a id="__codelineno-72-36" name="__codelineno-72-36" href="#__codelineno-72-36"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-72-37"><a id="__codelineno-72-37" name="__codelineno-72-37" href="#__codelineno-72-37"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">doNext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-72-38"><a id="__codelineno-72-38" name="__codelineno-72-38" href="#__codelineno-72-38"></a><span class="w">                </span><span class="c1">//立马调度一次发送广播，发送下一次广播，但是processNextBroadcast是一个同步函数，一次只能处理一个请求</span>
</span><span id="__span-72-39"><a id="__codelineno-72-39" name="__codelineno-72-39" href="#__codelineno-72-39"></a><span class="w">                </span><span class="n">r</span><span class="p">.</span><span class="na">queue</span><span class="p">.</span><span class="na">processNextBroadcastLocked</span><span class="p">(</span><span class="cm">/*fromMsg=*/</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="cm">/*skipOomAdj=*/</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
</span><span id="__span-72-40"><a id="__codelineno-72-40" name="__codelineno-72-40" href="#__codelineno-72-40"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-72-41"><a id="__codelineno-72-41" name="__codelineno-72-41" href="#__codelineno-72-41"></a><span class="w">            </span><span class="c1">// updateOomAdjLocked() will be done here</span>
</span><span id="__span-72-42"><a id="__codelineno-72-42" name="__codelineno-72-42" href="#__codelineno-72-42"></a><span class="w">            </span><span class="n">trimApplicationsLocked</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">OomAdjuster</span><span class="p">.</span><span class="na">OOM_ADJ_REASON_FINISH_RECEIVER</span><span class="p">);</span>
</span><span id="__span-72-43"><a id="__codelineno-72-43" name="__codelineno-72-43" href="#__codelineno-72-43"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-72-44"><a id="__codelineno-72-44" name="__codelineno-72-44" href="#__codelineno-72-44"></a>
</span><span id="__span-72-45"><a id="__codelineno-72-45" name="__codelineno-72-45" href="#__codelineno-72-45"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-72-46"><a id="__codelineno-72-46" name="__codelineno-72-46" href="#__codelineno-72-46"></a><span class="w">        </span><span class="n">Binder</span><span class="p">.</span><span class="na">restoreCallingIdentity</span><span class="p">(</span><span class="n">origId</span><span class="p">);</span>
</span><span id="__span-72-47"><a id="__codelineno-72-47" name="__codelineno-72-47" href="#__codelineno-72-47"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-72-48"><a id="__codelineno-72-48" name="__codelineno-72-48" href="#__codelineno-72-48"></a><span class="p">}</span>
</span></code></pre></div>
<p>如果发送广播时接收者不存在，那么要完成该次广播，并且判断是否执行发送给下一个广播接收者，如果需要发送给下个广播接收者要再次调用BroadcastQueue.processNextBroadcast方法，这样就又回到了前面的步骤。</p>
<h4 id="_40">有序广播<a class="headerlink" href="#_40" title="Permanent link">&para;</a></h4>
<p>BroadcastQueue.processNextBroadcast方法中，该方法在执行完无序广播后开始执行有序广播。</p>
<h5 id="pending-broadcast">处理Pending Broadcast<a class="headerlink" href="#pending-broadcast" title="Permanent link">&para;</a></h5>
<div class="language-java highlight"><pre><span></span><code><span id="__span-73-1"><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a><span class="c1">// Now take care of the next serialized one...</span>
</span><span id="__span-73-2"><a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a>
</span><span id="__span-73-3"><a id="__codelineno-73-3" name="__codelineno-73-3" href="#__codelineno-73-3"></a><span class="c1">// If we are waiting for a process to come up to handle the next</span>
</span><span id="__span-73-4"><a id="__codelineno-73-4" name="__codelineno-73-4" href="#__codelineno-73-4"></a><span class="c1">// broadcast, then do nothing at this point.  Just in case, we</span>
</span><span id="__span-73-5"><a id="__codelineno-73-5" name="__codelineno-73-5" href="#__codelineno-73-5"></a><span class="c1">// check that the process we&#39;re waiting for still exists.</span>
</span><span id="__span-73-6"><a id="__codelineno-73-6" name="__codelineno-73-6" href="#__codelineno-73-6"></a><span class="c1">// mPendingBroadcast对象是用来描述一个正在等待静态注册的目标广播接收者启动起来的广播转发任务的</span>
</span><span id="__span-73-7"><a id="__codelineno-73-7" name="__codelineno-73-7" href="#__codelineno-73-7"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mPendingBroadcast</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-73-8"><a id="__codelineno-73-8" name="__codelineno-73-8" href="#__codelineno-73-8"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST_LIGHT</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span>
</span><span id="__span-73-9"><a id="__codelineno-73-9" name="__codelineno-73-9" href="#__codelineno-73-9"></a><span class="w">            </span><span class="s">&quot;processNextBroadcast [&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;]: waiting for &quot;</span>
</span><span id="__span-73-10"><a id="__codelineno-73-10" name="__codelineno-73-10" href="#__codelineno-73-10"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">mPendingBroadcast</span><span class="p">.</span><span class="na">curApp</span><span class="p">);</span>
</span><span id="__span-73-11"><a id="__codelineno-73-11" name="__codelineno-73-11" href="#__codelineno-73-11"></a>
</span><span id="__span-73-12"><a id="__codelineno-73-12" name="__codelineno-73-12" href="#__codelineno-73-12"></a><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isDead</span><span class="p">;</span>
</span><span id="__span-73-13"><a id="__codelineno-73-13" name="__codelineno-73-13" href="#__codelineno-73-13"></a><span class="w">    </span><span class="c1">//是否存在这个进程的pid</span>
</span><span id="__span-73-14"><a id="__codelineno-73-14" name="__codelineno-73-14" href="#__codelineno-73-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mPendingBroadcast</span><span class="p">.</span><span class="na">curApp</span><span class="p">.</span><span class="na">getPid</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-73-15"><a id="__codelineno-73-15" name="__codelineno-73-15" href="#__codelineno-73-15"></a><span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mService</span><span class="p">.</span><span class="na">mPidsSelfLocked</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-73-16"><a id="__codelineno-73-16" name="__codelineno-73-16" href="#__codelineno-73-16"></a><span class="w">            </span><span class="c1">//如果存在pid，则从mPidsSelfLocked中获取这个进程的ProcessRecord proc</span>
</span><span id="__span-73-17"><a id="__codelineno-73-17" name="__codelineno-73-17" href="#__codelineno-73-17"></a><span class="w">            </span><span class="n">ProcessRecord</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mService</span><span class="p">.</span><span class="na">mPidsSelfLocked</span><span class="p">.</span><span class="na">get</span><span class="p">(</span>
</span><span id="__span-73-18"><a id="__codelineno-73-18" name="__codelineno-73-18" href="#__codelineno-73-18"></a><span class="w">                    </span><span class="n">mPendingBroadcast</span><span class="p">.</span><span class="na">curApp</span><span class="p">.</span><span class="na">getPid</span><span class="p">());</span>
</span><span id="__span-73-19"><a id="__codelineno-73-19" name="__codelineno-73-19" href="#__codelineno-73-19"></a><span class="w">            </span><span class="c1">//如果proc存在，而且没有发生crash，则isDead = false</span>
</span><span id="__span-73-20"><a id="__codelineno-73-20" name="__codelineno-73-20" href="#__codelineno-73-20"></a><span class="w">            </span><span class="n">isDead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">proc</span><span class="p">.</span><span class="na">mErrorState</span><span class="p">.</span><span class="na">isCrashing</span><span class="p">();</span>
</span><span id="__span-73-21"><a id="__codelineno-73-21" name="__codelineno-73-21" href="#__codelineno-73-21"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-73-22"><a id="__codelineno-73-22" name="__codelineno-73-22" href="#__codelineno-73-22"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-73-23"><a id="__codelineno-73-23" name="__codelineno-73-23" href="#__codelineno-73-23"></a><span class="w">        </span><span class="c1">//进程的pid不存在，则从mProcessList通过名字获取该进程的ProcessRecord proc</span>
</span><span id="__span-73-24"><a id="__codelineno-73-24" name="__codelineno-73-24" href="#__codelineno-73-24"></a><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">ProcessRecord</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mService</span><span class="p">.</span><span class="na">mProcessList</span><span class="p">.</span><span class="na">getProcessNamesLOSP</span><span class="p">().</span><span class="na">get</span><span class="p">(</span>
</span><span id="__span-73-25"><a id="__codelineno-73-25" name="__codelineno-73-25" href="#__codelineno-73-25"></a><span class="w">                </span><span class="n">mPendingBroadcast</span><span class="p">.</span><span class="na">curApp</span><span class="p">.</span><span class="na">processName</span><span class="p">,</span><span class="w"> </span><span class="n">mPendingBroadcast</span><span class="p">.</span><span class="na">curApp</span><span class="p">.</span><span class="na">uid</span><span class="p">);</span>
</span><span id="__span-73-26"><a id="__codelineno-73-26" name="__codelineno-73-26" href="#__codelineno-73-26"></a><span class="w">        </span><span class="c1">//如果proc存在，而且该进程正在启动中isPendingStart，则isDead = false</span>
</span><span id="__span-73-27"><a id="__codelineno-73-27" name="__codelineno-73-27" href="#__codelineno-73-27"></a><span class="w">        </span><span class="n">isDead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">proc</span><span class="p">.</span><span class="na">isPendingStart</span><span class="p">();</span>
</span><span id="__span-73-28"><a id="__codelineno-73-28" name="__codelineno-73-28" href="#__codelineno-73-28"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-73-29"><a id="__codelineno-73-29" name="__codelineno-73-29" href="#__codelineno-73-29"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isDead</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-73-30"><a id="__codelineno-73-30" name="__codelineno-73-30" href="#__codelineno-73-30"></a><span class="w">        </span><span class="c1">// It&#39;s still alive, so keep waiting</span>
</span><span id="__span-73-31"><a id="__codelineno-73-31" name="__codelineno-73-31" href="#__codelineno-73-31"></a><span class="w">        </span><span class="c1">// 如果应用已经启动，会调用AMS的函数来处理静态广播，这里直接return</span>
</span><span id="__span-73-32"><a id="__codelineno-73-32" name="__codelineno-73-32" href="#__codelineno-73-32"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-73-33"><a id="__codelineno-73-33" name="__codelineno-73-33" href="#__codelineno-73-33"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-73-34"><a id="__codelineno-73-34" name="__codelineno-73-34" href="#__codelineno-73-34"></a><span class="w">        </span><span class="c1">//如果app死掉了</span>
</span><span id="__span-73-35"><a id="__codelineno-73-35" name="__codelineno-73-35" href="#__codelineno-73-35"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;pending app  [&quot;</span>
</span><span id="__span-73-36"><a id="__codelineno-73-36" name="__codelineno-73-36" href="#__codelineno-73-36"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;]&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mPendingBroadcast</span><span class="p">.</span><span class="na">curApp</span>
</span><span id="__span-73-37"><a id="__codelineno-73-37" name="__codelineno-73-37" href="#__codelineno-73-37"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; died before responding to broadcast&quot;</span><span class="p">);</span>
</span><span id="__span-73-38"><a id="__codelineno-73-38" name="__codelineno-73-38" href="#__codelineno-73-38"></a><span class="w">        </span><span class="n">mPendingBroadcast</span><span class="p">.</span><span class="na">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">.</span><span class="na">IDLE</span><span class="p">;</span>
</span><span id="__span-73-39"><a id="__codelineno-73-39" name="__codelineno-73-39" href="#__codelineno-73-39"></a><span class="w">        </span><span class="c1">//下一次处理这个BroadcastRecord的nextReceiver还是这个recIdx</span>
</span><span id="__span-73-40"><a id="__codelineno-73-40" name="__codelineno-73-40" href="#__codelineno-73-40"></a><span class="w">        </span><span class="n">mPendingBroadcast</span><span class="p">.</span><span class="na">nextReceiver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mPendingBroadcastRecvIndex</span><span class="p">;</span>
</span><span id="__span-73-41"><a id="__codelineno-73-41" name="__codelineno-73-41" href="#__codelineno-73-41"></a><span class="w">        </span><span class="c1">//app死掉了清除mPendingBroadcast = null, 跳过这个mPendingBroadcast</span>
</span><span id="__span-73-42"><a id="__codelineno-73-42" name="__codelineno-73-42" href="#__codelineno-73-42"></a><span class="w">        </span><span class="n">mPendingBroadcast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-73-43"><a id="__codelineno-73-43" name="__codelineno-73-43" href="#__codelineno-73-43"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-73-44"><a id="__codelineno-73-44" name="__codelineno-73-44" href="#__codelineno-73-44"></a><span class="p">}</span>
</span></code></pre></div>
<p>处理保存在有序广播调度队列mPendingBroadcast中的广播转发任务。从前面可知，有序广播调度队列mOrderedBroadcast描述的目标广播接收者有可能是静态注册的，而这些静态注册的目标广播接收者可能还没有启动起来，因此AMS将一个广播发送给它们处理时，首先将它们启动起来。事实上，AMS只需要将他们所运行在的进程启动起来就可以了，因为当这些进程接收到AMS发送的广播后，就会主动将目标广播接收者启动起来。</p>
<h5 id="_41">取出下一个广播<a class="headerlink" href="#_41" title="Permanent link">&para;</a></h5>
<div class="language-java highlight"><pre><span></span><code><span id="__span-74-1"><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a><span class="kt">boolean</span><span class="w"> </span><span class="n">looped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-74-2"><a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a>
</span><span id="__span-74-3"><a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a><span class="k">do</span><span class="w"> </span><span class="p">{</span><span class="c1">//这里的do-while只会从mOrderedBroadcasts中取出第一个BroadcastRecord进行后续的处理</span>
</span><span id="__span-74-4"><a id="__codelineno-74-4" name="__codelineno-74-4" href="#__codelineno-74-4"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SystemClock</span><span class="p">.</span><span class="na">uptimeMillis</span><span class="p">();</span>
</span><span id="__span-74-5"><a id="__codelineno-74-5" name="__codelineno-74-5" href="#__codelineno-74-5"></a><span class="w">    </span><span class="c1">//从 mOrderedBroadcasts 有序广播队列，依次取出来</span>
</span><span id="__span-74-6"><a id="__codelineno-74-6" name="__codelineno-74-6" href="#__codelineno-74-6"></a><span class="w">    </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mDispatcher</span><span class="p">.</span><span class="na">getNextBroadcastLocked</span><span class="p">(</span><span class="n">now</span><span class="p">);</span>
</span><span id="__span-74-7"><a id="__codelineno-74-7" name="__codelineno-74-7" href="#__codelineno-74-7"></a>
</span><span id="__span-74-8"><a id="__codelineno-74-8" name="__codelineno-74-8" href="#__codelineno-74-8"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-74-9"><a id="__codelineno-74-9" name="__codelineno-74-9" href="#__codelineno-74-9"></a><span class="w">        </span><span class="c1">// No more broadcasts are deliverable right now, so all done!</span>
</span><span id="__span-74-10"><a id="__codelineno-74-10" name="__codelineno-74-10" href="#__codelineno-74-10"></a><span class="w">        </span><span class="c1">// 调度队列mOrderedBroadcasts中的广播已经全部处理完成</span>
</span><span id="__span-74-11"><a id="__codelineno-74-11" name="__codelineno-74-11" href="#__codelineno-74-11"></a><span class="w">        </span><span class="n">mDispatcher</span><span class="p">.</span><span class="na">scheduleDeferralCheckLocked</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span><span id="__span-74-12"><a id="__codelineno-74-12" name="__codelineno-74-12" href="#__codelineno-74-12"></a><span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">mService</span><span class="p">.</span><span class="na">mAppProfiler</span><span class="p">.</span><span class="na">mProfilerLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-74-13"><a id="__codelineno-74-13" name="__codelineno-74-13" href="#__codelineno-74-13"></a><span class="w">            </span><span class="c1">//AMS将所有挂起的gc进程mProcessesToGc进行按顺序的gc</span>
</span><span id="__span-74-14"><a id="__codelineno-74-14" name="__codelineno-74-14" href="#__codelineno-74-14"></a><span class="w">            </span><span class="n">mService</span><span class="p">.</span><span class="na">mAppProfiler</span><span class="p">.</span><span class="na">scheduleAppGcsLPf</span><span class="p">();</span>
</span><span id="__span-74-15"><a id="__codelineno-74-15" name="__codelineno-74-15" href="#__codelineno-74-15"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-74-16"><a id="__codelineno-74-16" name="__codelineno-74-16" href="#__codelineno-74-16"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">looped</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">skipOomAdj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-74-17"><a id="__codelineno-74-17" name="__codelineno-74-17" href="#__codelineno-74-17"></a><span class="w">            </span><span class="c1">// If we had finished the last ordered broadcast, then</span>
</span><span id="__span-74-18"><a id="__codelineno-74-18" name="__codelineno-74-18" href="#__codelineno-74-18"></a><span class="w">            </span><span class="c1">// make sure all processes have correct oom and sched</span>
</span><span id="__span-74-19"><a id="__codelineno-74-19" name="__codelineno-74-19" href="#__codelineno-74-19"></a><span class="w">            </span><span class="c1">// adjustments.</span>
</span><span id="__span-74-20"><a id="__codelineno-74-20" name="__codelineno-74-20" href="#__codelineno-74-20"></a><span class="w">            </span><span class="c1">//adj调整</span>
</span><span id="__span-74-21"><a id="__codelineno-74-21" name="__codelineno-74-21" href="#__codelineno-74-21"></a><span class="w">            </span><span class="n">mService</span><span class="p">.</span><span class="na">updateOomAdjPendingTargetsLocked</span><span class="p">(</span>
</span><span id="__span-74-22"><a id="__codelineno-74-22" name="__codelineno-74-22" href="#__codelineno-74-22"></a><span class="w">                    </span><span class="n">OomAdjuster</span><span class="p">.</span><span class="na">OOM_ADJ_REASON_START_RECEIVER</span><span class="p">);</span>
</span><span id="__span-74-23"><a id="__codelineno-74-23" name="__codelineno-74-23" href="#__codelineno-74-23"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-74-24"><a id="__codelineno-74-24" name="__codelineno-74-24" href="#__codelineno-74-24"></a>
</span><span id="__span-74-25"><a id="__codelineno-74-25" name="__codelineno-74-25" href="#__codelineno-74-25"></a><span class="w">        </span><span class="c1">// when we have no more ordered broadcast on this queue, stop logging</span>
</span><span id="__span-74-26"><a id="__codelineno-74-26" name="__codelineno-74-26" href="#__codelineno-74-26"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mService</span><span class="p">.</span><span class="na">mUserController</span><span class="p">.</span><span class="na">mBootCompleted</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mLogLatencyMetrics</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-74-27"><a id="__codelineno-74-27" name="__codelineno-74-27" href="#__codelineno-74-27"></a><span class="w">            </span><span class="n">mLogLatencyMetrics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-74-28"><a id="__codelineno-74-28" name="__codelineno-74-28" href="#__codelineno-74-28"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-74-29"><a id="__codelineno-74-29" name="__codelineno-74-29" href="#__codelineno-74-29"></a>
</span><span id="__span-74-30"><a id="__codelineno-74-30" name="__codelineno-74-30" href="#__codelineno-74-30"></a><span class="w">        </span><span class="c1">//结束本次processNextBroadcastLocked</span>
</span><span id="__span-74-31"><a id="__codelineno-74-31" name="__codelineno-74-31" href="#__codelineno-74-31"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-74-32"><a id="__codelineno-74-32" name="__codelineno-74-32" href="#__codelineno-74-32"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-74-33"><a id="__codelineno-74-33" name="__codelineno-74-33" href="#__codelineno-74-33"></a>
</span><span id="__span-74-34"><a id="__codelineno-74-34" name="__codelineno-74-34" href="#__codelineno-74-34"></a><span class="w">    </span><span class="c1">// 是否需要强制结束recevie</span>
</span><span id="__span-74-35"><a id="__codelineno-74-35" name="__codelineno-74-35" href="#__codelineno-74-35"></a><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">forceReceive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-74-36"><a id="__codelineno-74-36" name="__codelineno-74-36" href="#__codelineno-74-36"></a>
</span><span id="__span-74-37"><a id="__codelineno-74-37" name="__codelineno-74-37" href="#__codelineno-74-37"></a><span class="w">    </span><span class="c1">// Ensure that even if something goes awry with the timeout</span>
</span><span id="__span-74-38"><a id="__codelineno-74-38" name="__codelineno-74-38" href="#__codelineno-74-38"></a><span class="w">    </span><span class="c1">// detection, we catch &quot;hung&quot; broadcasts here, discard them,</span>
</span><span id="__span-74-39"><a id="__codelineno-74-39" name="__codelineno-74-39" href="#__codelineno-74-39"></a><span class="w">    </span><span class="c1">// and continue to make progress.</span>
</span><span id="__span-74-40"><a id="__codelineno-74-40" name="__codelineno-74-40" href="#__codelineno-74-40"></a><span class="w">    </span><span class="c1">//</span>
</span><span id="__span-74-41"><a id="__codelineno-74-41" name="__codelineno-74-41" href="#__codelineno-74-41"></a><span class="w">    </span><span class="c1">// This is only done if the system is ready so that early-stage receivers</span>
</span><span id="__span-74-42"><a id="__codelineno-74-42" name="__codelineno-74-42" href="#__codelineno-74-42"></a><span class="w">    </span><span class="c1">// don&#39;t get executed with timeouts; and of course other timeout-</span>
</span><span id="__span-74-43"><a id="__codelineno-74-43" name="__codelineno-74-43" href="#__codelineno-74-43"></a><span class="w">    </span><span class="c1">// exempt broadcasts are ignored.</span>
</span><span id="__span-74-44"><a id="__codelineno-74-44" name="__codelineno-74-44" href="#__codelineno-74-44"></a><span class="w">    </span><span class="c1">// 接收者的个数</span>
</span><span id="__span-74-45"><a id="__codelineno-74-45" name="__codelineno-74-45" href="#__codelineno-74-45"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">numReceivers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">receivers</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">receivers</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-74-46"><a id="__codelineno-74-46" name="__codelineno-74-46" href="#__codelineno-74-46"></a><span class="w">    </span><span class="c1">// 1. systemReady之后mService.mProcessesReady = true</span>
</span><span id="__span-74-47"><a id="__codelineno-74-47" name="__codelineno-74-47" href="#__codelineno-74-47"></a><span class="w">    </span><span class="c1">// 2. timeoutExempt只有ACTION_PRE_BOOT_COMPLETED才会设置为true</span>
</span><span id="__span-74-48"><a id="__codelineno-74-48" name="__codelineno-74-48" href="#__codelineno-74-48"></a><span class="w">    </span><span class="c1">// 3. r.dispatchTime是开始分发该BroadcastRecord r的时间</span>
</span><span id="__span-74-49"><a id="__codelineno-74-49" name="__codelineno-74-49" href="#__codelineno-74-49"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mService</span><span class="p">.</span><span class="na">mProcessesReady</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">r</span><span class="p">.</span><span class="na">timeoutExempt</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">dispatchTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-74-50"><a id="__codelineno-74-50" name="__codelineno-74-50" href="#__codelineno-74-50"></a><span class="w">        </span><span class="c1">// 1. 接收者的个数 &gt; 0</span>
</span><span id="__span-74-51"><a id="__codelineno-74-51" name="__codelineno-74-51" href="#__codelineno-74-51"></a><span class="w">        </span><span class="c1">// 2. 当前时间now &gt; r.dispatchTime + (2 * mConstants.TIMEOUT(10s/60s) * numReceivers)</span>
</span><span id="__span-74-52"><a id="__codelineno-74-52" name="__codelineno-74-52" href="#__codelineno-74-52"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">numReceivers</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-74-53"><a id="__codelineno-74-53" name="__codelineno-74-53" href="#__codelineno-74-53"></a><span class="w">                </span><span class="p">(</span><span class="n">now</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">dispatchTime</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">mConstants</span><span class="p">.</span><span class="na">TIMEOUT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numReceivers</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-74-54"><a id="__codelineno-74-54" name="__codelineno-74-54" href="#__codelineno-74-54"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Hung broadcast [&quot;</span>
</span><span id="__span-74-55"><a id="__codelineno-74-55" name="__codelineno-74-55" href="#__codelineno-74-55"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;] discarded after timeout failure:&quot;</span>
</span><span id="__span-74-56"><a id="__codelineno-74-56" name="__codelineno-74-56" href="#__codelineno-74-56"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; now=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">now</span>
</span><span id="__span-74-57"><a id="__codelineno-74-57" name="__codelineno-74-57" href="#__codelineno-74-57"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; dispatchTime=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">dispatchTime</span>
</span><span id="__span-74-58"><a id="__codelineno-74-58" name="__codelineno-74-58" href="#__codelineno-74-58"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; startTime=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">receiverTime</span>
</span><span id="__span-74-59"><a id="__codelineno-74-59" name="__codelineno-74-59" href="#__codelineno-74-59"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; intent=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span>
</span><span id="__span-74-60"><a id="__codelineno-74-60" name="__codelineno-74-60" href="#__codelineno-74-60"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; numReceivers=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">numReceivers</span>
</span><span id="__span-74-61"><a id="__codelineno-74-61" name="__codelineno-74-61" href="#__codelineno-74-61"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; nextReceiver=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">nextReceiver</span>
</span><span id="__span-74-62"><a id="__codelineno-74-62" name="__codelineno-74-62" href="#__codelineno-74-62"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; state=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">state</span><span class="p">);</span>
</span><span id="__span-74-63"><a id="__codelineno-74-63" name="__codelineno-74-63" href="#__codelineno-74-63"></a><span class="w">            </span><span class="c1">//出现超时，强制结束</span>
</span><span id="__span-74-64"><a id="__codelineno-74-64" name="__codelineno-74-64" href="#__codelineno-74-64"></a><span class="w">            </span><span class="n">broadcastTimeoutLocked</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w"> </span><span class="c1">// forcibly finish this broadcast</span>
</span><span id="__span-74-65"><a id="__codelineno-74-65" name="__codelineno-74-65" href="#__codelineno-74-65"></a><span class="w">            </span><span class="c1">//重置参数，继续处理有序广播调度队列mOrderedBroadcasts的下一个广播转发任务</span>
</span><span id="__span-74-66"><a id="__codelineno-74-66" name="__codelineno-74-66" href="#__codelineno-74-66"></a><span class="w">            </span><span class="n">forceReceive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-74-67"><a id="__codelineno-74-67" name="__codelineno-74-67" href="#__codelineno-74-67"></a><span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="na">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">.</span><span class="na">IDLE</span><span class="p">;</span>
</span><span id="__span-74-68"><a id="__codelineno-74-68" name="__codelineno-74-68" href="#__codelineno-74-68"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-74-69"><a id="__codelineno-74-69" name="__codelineno-74-69" href="#__codelineno-74-69"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-74-70"><a id="__codelineno-74-70" name="__codelineno-74-70" href="#__codelineno-74-70"></a>
</span><span id="__span-74-71"><a id="__codelineno-74-71" name="__codelineno-74-71" href="#__codelineno-74-71"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">state</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">.</span><span class="na">IDLE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-74-72"><a id="__codelineno-74-72" name="__codelineno-74-72" href="#__codelineno-74-72"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span>
</span><span id="__span-74-73"><a id="__codelineno-74-73" name="__codelineno-74-73" href="#__codelineno-74-73"></a><span class="w">                </span><span class="s">&quot;processNextBroadcast(&quot;</span>
</span><span id="__span-74-74"><a id="__codelineno-74-74" name="__codelineno-74-74" href="#__codelineno-74-74"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;) called when not idle (state=&quot;</span>
</span><span id="__span-74-75"><a id="__codelineno-74-75" name="__codelineno-74-75" href="#__codelineno-74-75"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">state</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="p">);</span>
</span><span id="__span-74-76"><a id="__codelineno-74-76" name="__codelineno-74-76" href="#__codelineno-74-76"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-74-77"><a id="__codelineno-74-77" name="__codelineno-74-77" href="#__codelineno-74-77"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-74-78"><a id="__codelineno-74-78" name="__codelineno-74-78" href="#__codelineno-74-78"></a>
</span><span id="__span-74-79"><a id="__codelineno-74-79" name="__codelineno-74-79" href="#__codelineno-74-79"></a><span class="w">    </span><span class="c1">// Is the current broadcast is done for any reason?</span>
</span><span id="__span-74-80"><a id="__codelineno-74-80" name="__codelineno-74-80" href="#__codelineno-74-80"></a><span class="w">    </span><span class="c1">// r.resultAbort表示广播已经向所有的receiver发送结束或者中途被取消, 如果r.resultAbort为true，会停止处理当前正在发送的BroadcastRecord，这样优先级比较低的接收者也就收不到这个广播了</span>
</span><span id="__span-74-81"><a id="__codelineno-74-81" name="__codelineno-74-81" href="#__codelineno-74-81"></a><span class="w">    </span><span class="c1">// forceReceive检查BroadcastRecord对象r所描述的广播转发任务是否已经处理完成，或者是否已经被强制结束了。</span>
</span><span id="__span-74-82"><a id="__codelineno-74-82" name="__codelineno-74-82" href="#__codelineno-74-82"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">receivers</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">nextReceiver</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">numReceivers</span>
</span><span id="__span-74-83"><a id="__codelineno-74-83" name="__codelineno-74-83" href="#__codelineno-74-83"></a><span class="w">            </span><span class="o">||</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">resultAbort</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">forceReceive</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-74-84"><a id="__codelineno-74-84" name="__codelineno-74-84" href="#__codelineno-74-84"></a><span class="w">        </span><span class="c1">// Send the final result if requested</span>
</span><span id="__span-74-85"><a id="__codelineno-74-85" name="__codelineno-74-85" href="#__codelineno-74-85"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">resultTo</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="c1">//是否有resultTo，如果有将结果回传resultTo</span>
</span><span id="__span-74-86"><a id="__codelineno-74-86" name="__codelineno-74-86" href="#__codelineno-74-86"></a><span class="w">            </span><span class="kt">boolean</span><span class="w"> </span><span class="n">sendResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-74-87"><a id="__codelineno-74-87" name="__codelineno-74-87" href="#__codelineno-74-87"></a>
</span><span id="__span-74-88"><a id="__codelineno-74-88" name="__codelineno-74-88" href="#__codelineno-74-88"></a><span class="w">            </span><span class="c1">// if this was part of a split/deferral complex, update the refcount and only</span>
</span><span id="__span-74-89"><a id="__codelineno-74-89" name="__codelineno-74-89" href="#__codelineno-74-89"></a><span class="w">            </span><span class="c1">// send the completion when we clear all of them</span>
</span><span id="__span-74-90"><a id="__codelineno-74-90" name="__codelineno-74-90" href="#__codelineno-74-90"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">splitToken</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-74-91"><a id="__codelineno-74-91" name="__codelineno-74-91" href="#__codelineno-74-91"></a><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">newCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mSplitRefcounts</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">splitToken</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-74-92"><a id="__codelineno-74-92" name="__codelineno-74-92" href="#__codelineno-74-92"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-74-93"><a id="__codelineno-74-93" name="__codelineno-74-93" href="#__codelineno-74-93"></a><span class="w">                    </span><span class="c1">// done!  clear out this record&#39;s bookkeeping and deliver</span>
</span><span id="__span-74-94"><a id="__codelineno-74-94" name="__codelineno-74-94" href="#__codelineno-74-94"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST_DEFERRAL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-74-95"><a id="__codelineno-74-95" name="__codelineno-74-95" href="#__codelineno-74-95"></a><span class="w">                        </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span>
</span><span id="__span-74-96"><a id="__codelineno-74-96" name="__codelineno-74-96" href="#__codelineno-74-96"></a><span class="w">                                </span><span class="s">&quot;Sending broadcast completion for split token &quot;</span>
</span><span id="__span-74-97"><a id="__codelineno-74-97" name="__codelineno-74-97" href="#__codelineno-74-97"></a><span class="w">                                </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">splitToken</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; : &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">());</span>
</span><span id="__span-74-98"><a id="__codelineno-74-98" name="__codelineno-74-98" href="#__codelineno-74-98"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-74-99"><a id="__codelineno-74-99" name="__codelineno-74-99" href="#__codelineno-74-99"></a><span class="w">                    </span><span class="n">mSplitRefcounts</span><span class="p">.</span><span class="na">delete</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">splitToken</span><span class="p">);</span>
</span><span id="__span-74-100"><a id="__codelineno-74-100" name="__codelineno-74-100" href="#__codelineno-74-100"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-74-101"><a id="__codelineno-74-101" name="__codelineno-74-101" href="#__codelineno-74-101"></a><span class="w">                    </span><span class="c1">// still have some split broadcast records in flight; update refcount</span>
</span><span id="__span-74-102"><a id="__codelineno-74-102" name="__codelineno-74-102" href="#__codelineno-74-102"></a><span class="w">                    </span><span class="c1">// and hold off on the callback</span>
</span><span id="__span-74-103"><a id="__codelineno-74-103" name="__codelineno-74-103" href="#__codelineno-74-103"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST_DEFERRAL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-74-104"><a id="__codelineno-74-104" name="__codelineno-74-104" href="#__codelineno-74-104"></a><span class="w">                        </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span>
</span><span id="__span-74-105"><a id="__codelineno-74-105" name="__codelineno-74-105" href="#__codelineno-74-105"></a><span class="w">                                </span><span class="s">&quot;Result refcount now &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">newCount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; for split token &quot;</span>
</span><span id="__span-74-106"><a id="__codelineno-74-106" name="__codelineno-74-106" href="#__codelineno-74-106"></a><span class="w">                                </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">splitToken</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; : &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">()</span>
</span><span id="__span-74-107"><a id="__codelineno-74-107" name="__codelineno-74-107" href="#__codelineno-74-107"></a><span class="w">                                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; - not sending completion yet&quot;</span><span class="p">);</span>
</span><span id="__span-74-108"><a id="__codelineno-74-108" name="__codelineno-74-108" href="#__codelineno-74-108"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-74-109"><a id="__codelineno-74-109" name="__codelineno-74-109" href="#__codelineno-74-109"></a><span class="w">                    </span><span class="n">sendResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-74-110"><a id="__codelineno-74-110" name="__codelineno-74-110" href="#__codelineno-74-110"></a><span class="w">                    </span><span class="n">mSplitRefcounts</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">splitToken</span><span class="p">,</span><span class="w"> </span><span class="n">newCount</span><span class="p">);</span>
</span><span id="__span-74-111"><a id="__codelineno-74-111" name="__codelineno-74-111" href="#__codelineno-74-111"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-74-112"><a id="__codelineno-74-112" name="__codelineno-74-112" href="#__codelineno-74-112"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-74-113"><a id="__codelineno-74-113" name="__codelineno-74-113" href="#__codelineno-74-113"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sendResult</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-74-114"><a id="__codelineno-74-114" name="__codelineno-74-114" href="#__codelineno-74-114"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">callerApp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-74-115"><a id="__codelineno-74-115" name="__codelineno-74-115" href="#__codelineno-74-115"></a><span class="w">                    </span><span class="n">mService</span><span class="p">.</span><span class="na">mOomAdjuster</span><span class="p">.</span><span class="na">mCachedAppOptimizer</span><span class="p">.</span><span class="na">unfreezeTemporarily</span><span class="p">(</span>
</span><span id="__span-74-116"><a id="__codelineno-74-116" name="__codelineno-74-116" href="#__codelineno-74-116"></a><span class="w">                            </span><span class="n">r</span><span class="p">.</span><span class="na">callerApp</span><span class="p">);</span>
</span><span id="__span-74-117"><a id="__codelineno-74-117" name="__codelineno-74-117" href="#__codelineno-74-117"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-74-118"><a id="__codelineno-74-118" name="__codelineno-74-118" href="#__codelineno-74-118"></a><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-74-119"><a id="__codelineno-74-119" name="__codelineno-74-119" href="#__codelineno-74-119"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-74-120"><a id="__codelineno-74-120" name="__codelineno-74-120" href="#__codelineno-74-120"></a><span class="w">                        </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Finishing broadcast [&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;] &quot;</span>
</span><span id="__span-74-121"><a id="__codelineno-74-121" name="__codelineno-74-121" href="#__codelineno-74-121"></a><span class="w">                                </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; app=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callerApp</span><span class="p">);</span>
</span><span id="__span-74-122"><a id="__codelineno-74-122" name="__codelineno-74-122" href="#__codelineno-74-122"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-74-123"><a id="__codelineno-74-123" name="__codelineno-74-123" href="#__codelineno-74-123"></a><span class="w">                    </span><span class="c1">//将结果返回给app</span>
</span><span id="__span-74-124"><a id="__codelineno-74-124" name="__codelineno-74-124" href="#__codelineno-74-124"></a><span class="w">                    </span><span class="n">performReceiveLocked</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">callerApp</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">resultTo</span><span class="p">,</span>
</span><span id="__span-74-125"><a id="__codelineno-74-125" name="__codelineno-74-125" href="#__codelineno-74-125"></a><span class="w">                            </span><span class="k">new</span><span class="w"> </span><span class="n">Intent</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">),</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">resultCode</span><span class="p">,</span>
</span><span id="__span-74-126"><a id="__codelineno-74-126" name="__codelineno-74-126" href="#__codelineno-74-126"></a><span class="w">                            </span><span class="n">r</span><span class="p">.</span><span class="na">resultData</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">resultExtras</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">userId</span><span class="p">,</span>
</span><span id="__span-74-127"><a id="__codelineno-74-127" name="__codelineno-74-127" href="#__codelineno-74-127"></a><span class="w">                            </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="p">);</span>
</span><span id="__span-74-128"><a id="__codelineno-74-128" name="__codelineno-74-128" href="#__codelineno-74-128"></a><span class="w">                    </span><span class="n">logBootCompletedBroadcastCompletionLatencyIfPossible</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-74-129"><a id="__codelineno-74-129" name="__codelineno-74-129" href="#__codelineno-74-129"></a><span class="w">                    </span><span class="c1">// Set this to null so that the reference</span>
</span><span id="__span-74-130"><a id="__codelineno-74-130" name="__codelineno-74-130" href="#__codelineno-74-130"></a><span class="w">                    </span><span class="c1">// (local and remote) isn&#39;t kept in the mBroadcastHistory.</span>
</span><span id="__span-74-131"><a id="__codelineno-74-131" name="__codelineno-74-131" href="#__codelineno-74-131"></a><span class="w">                    </span><span class="n">r</span><span class="p">.</span><span class="na">resultTo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-74-132"><a id="__codelineno-74-132" name="__codelineno-74-132" href="#__codelineno-74-132"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-74-133"><a id="__codelineno-74-133" name="__codelineno-74-133" href="#__codelineno-74-133"></a><span class="w">                    </span><span class="n">r</span><span class="p">.</span><span class="na">resultTo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-74-134"><a id="__codelineno-74-134" name="__codelineno-74-134" href="#__codelineno-74-134"></a><span class="w">                    </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Failure [&quot;</span>
</span><span id="__span-74-135"><a id="__codelineno-74-135" name="__codelineno-74-135" href="#__codelineno-74-135"></a><span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;] sending broadcast result of &quot;</span>
</span><span id="__span-74-136"><a id="__codelineno-74-136" name="__codelineno-74-136" href="#__codelineno-74-136"></a><span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
</span><span id="__span-74-137"><a id="__codelineno-74-137" name="__codelineno-74-137" href="#__codelineno-74-137"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-74-138"><a id="__codelineno-74-138" name="__codelineno-74-138" href="#__codelineno-74-138"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-74-139"><a id="__codelineno-74-139" name="__codelineno-74-139" href="#__codelineno-74-139"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-74-140"><a id="__codelineno-74-140" name="__codelineno-74-140" href="#__codelineno-74-140"></a>
</span><span id="__span-74-141"><a id="__codelineno-74-141" name="__codelineno-74-141" href="#__codelineno-74-141"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Cancelling BROADCAST_TIMEOUT_MSG&quot;</span><span class="p">);</span>
</span><span id="__span-74-142"><a id="__codelineno-74-142" name="__codelineno-74-142" href="#__codelineno-74-142"></a><span class="w">        </span><span class="c1">//取消广播超时</span>
</span><span id="__span-74-143"><a id="__codelineno-74-143" name="__codelineno-74-143" href="#__codelineno-74-143"></a><span class="w">        </span><span class="n">cancelBroadcastTimeoutLocked</span><span class="p">();</span>
</span><span id="__span-74-144"><a id="__codelineno-74-144" name="__codelineno-74-144" href="#__codelineno-74-144"></a>
</span><span id="__span-74-145"><a id="__codelineno-74-145" name="__codelineno-74-145" href="#__codelineno-74-145"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST_LIGHT</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span>
</span><span id="__span-74-146"><a id="__codelineno-74-146" name="__codelineno-74-146" href="#__codelineno-74-146"></a><span class="w">                </span><span class="s">&quot;Finished with ordered broadcast &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-74-147"><a id="__codelineno-74-147" name="__codelineno-74-147" href="#__codelineno-74-147"></a>
</span><span id="__span-74-148"><a id="__codelineno-74-148" name="__codelineno-74-148" href="#__codelineno-74-148"></a><span class="w">        </span><span class="c1">// ... and on to the next...</span>
</span><span id="__span-74-149"><a id="__codelineno-74-149" name="__codelineno-74-149" href="#__codelineno-74-149"></a><span class="w">        </span><span class="c1">//添加到广播历史中去，代表完成了</span>
</span><span id="__span-74-150"><a id="__codelineno-74-150" name="__codelineno-74-150" href="#__codelineno-74-150"></a><span class="w">        </span><span class="n">addBroadcastToHistoryLocked</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-74-151"><a id="__codelineno-74-151" name="__codelineno-74-151" href="#__codelineno-74-151"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getComponent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getPackage</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span>
</span><span id="__span-74-152"><a id="__codelineno-74-152" name="__codelineno-74-152" href="#__codelineno-74-152"></a><span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getFlags</span><span class="p">()</span><span class="o">&amp;</span><span class="n">Intent</span><span class="p">.</span><span class="na">FLAG_RECEIVER_REGISTERED_ONLY</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-74-153"><a id="__codelineno-74-153" name="__codelineno-74-153" href="#__codelineno-74-153"></a><span class="w">            </span><span class="c1">// This was an implicit broadcast... let&#39;s record it for posterity.</span>
</span><span id="__span-74-154"><a id="__codelineno-74-154" name="__codelineno-74-154" href="#__codelineno-74-154"></a><span class="w">            </span><span class="n">mService</span><span class="p">.</span><span class="na">addBroadcastStatLocked</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">(),</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callerPackage</span><span class="p">,</span>
</span><span id="__span-74-155"><a id="__codelineno-74-155" name="__codelineno-74-155" href="#__codelineno-74-155"></a><span class="w">                    </span><span class="n">r</span><span class="p">.</span><span class="na">manifestCount</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">manifestSkipCount</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">finishTime</span><span class="o">-</span><span class="n">r</span><span class="p">.</span><span class="na">dispatchTime</span><span class="p">);</span>
</span><span id="__span-74-156"><a id="__codelineno-74-156" name="__codelineno-74-156" href="#__codelineno-74-156"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-74-157"><a id="__codelineno-74-157" name="__codelineno-74-157" href="#__codelineno-74-157"></a><span class="w">        </span><span class="c1">//完成odered的广播后，在retireBroadcastLocked中设置mCurrentBroadcast = null(一般在r == mCurrentBroadcast时)</span>
</span><span id="__span-74-158"><a id="__codelineno-74-158" name="__codelineno-74-158" href="#__codelineno-74-158"></a><span class="w">        </span><span class="n">mDispatcher</span><span class="p">.</span><span class="na">retireBroadcastLocked</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-74-159"><a id="__codelineno-74-159" name="__codelineno-74-159" href="#__codelineno-74-159"></a><span class="w">        </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-74-160"><a id="__codelineno-74-160" name="__codelineno-74-160" href="#__codelineno-74-160"></a><span class="w">        </span><span class="n">looped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-74-161"><a id="__codelineno-74-161" name="__codelineno-74-161" href="#__codelineno-74-161"></a><span class="w">        </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-74-162"><a id="__codelineno-74-162" name="__codelineno-74-162" href="#__codelineno-74-162"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-74-163"><a id="__codelineno-74-163" name="__codelineno-74-163" href="#__codelineno-74-163"></a>
</span><span id="__span-74-164"><a id="__codelineno-74-164" name="__codelineno-74-164" href="#__codelineno-74-164"></a><span class="w">    </span><span class="c1">// Check whether the next receiver is under deferral policy, and handle that</span>
</span><span id="__span-74-165"><a id="__codelineno-74-165" name="__codelineno-74-165" href="#__codelineno-74-165"></a><span class="w">    </span><span class="c1">// accordingly.  If the current broadcast was already part of deferred-delivery</span>
</span><span id="__span-74-166"><a id="__codelineno-74-166" name="__codelineno-74-166" href="#__codelineno-74-166"></a><span class="w">    </span><span class="c1">// tracking, we know that it must now be deliverable as-is without re-deferral.</span>
</span><span id="__span-74-167"><a id="__codelineno-74-167" name="__codelineno-74-167" href="#__codelineno-74-167"></a><span class="w">    </span><span class="c1">// 如果这个广播没有进行延迟，则判断一下是否需要延迟</span>
</span><span id="__span-74-168"><a id="__codelineno-74-168" name="__codelineno-74-168" href="#__codelineno-74-168"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">.</span><span class="na">deferred</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-74-169"><a id="__codelineno-74-169" name="__codelineno-74-169" href="#__codelineno-74-169"></a><span class="w">        </span><span class="c1">// 获取下一个nextReceiver的uid</span>
</span><span id="__span-74-170"><a id="__codelineno-74-170" name="__codelineno-74-170" href="#__codelineno-74-170"></a><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">receiverUid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">getReceiverUid</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">receivers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">nextReceiver</span><span class="p">));</span>
</span><span id="__span-74-171"><a id="__codelineno-74-171" name="__codelineno-74-171" href="#__codelineno-74-171"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mDispatcher</span><span class="p">.</span><span class="na">isDeferringLocked</span><span class="p">(</span><span class="n">receiverUid</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-74-172"><a id="__codelineno-74-172" name="__codelineno-74-172" href="#__codelineno-74-172"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST_DEFERRAL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-74-173"><a id="__codelineno-74-173" name="__codelineno-74-173" href="#__codelineno-74-173"></a><span class="w">                </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Next receiver in &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; uid &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">receiverUid</span>
</span><span id="__span-74-174"><a id="__codelineno-74-174" name="__codelineno-74-174" href="#__codelineno-74-174"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; at &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">nextReceiver</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; is under deferral&quot;</span><span class="p">);</span>
</span><span id="__span-74-175"><a id="__codelineno-74-175" name="__codelineno-74-175" href="#__codelineno-74-175"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-74-176"><a id="__codelineno-74-176" name="__codelineno-74-176" href="#__codelineno-74-176"></a><span class="w">            </span><span class="c1">// If this is the only (remaining) receiver in the broadcast, &quot;splitting&quot;</span>
</span><span id="__span-74-177"><a id="__codelineno-74-177" name="__codelineno-74-177" href="#__codelineno-74-177"></a><span class="w">            </span><span class="c1">// doesn&#39;t make sense -- just defer it as-is and retire it as the</span>
</span><span id="__span-74-178"><a id="__codelineno-74-178" name="__codelineno-74-178" href="#__codelineno-74-178"></a><span class="w">            </span><span class="c1">// currently active outgoing broadcast.</span>
</span><span id="__span-74-179"><a id="__codelineno-74-179" name="__codelineno-74-179" href="#__codelineno-74-179"></a><span class="w">            </span><span class="n">BroadcastRecord</span><span class="w"> </span><span class="n">defer</span><span class="p">;</span>
</span><span id="__span-74-180"><a id="__codelineno-74-180" name="__codelineno-74-180" href="#__codelineno-74-180"></a><span class="w">            </span><span class="c1">// 下一个Receiver将延迟，再下一个Receiver已经没有了</span>
</span><span id="__span-74-181"><a id="__codelineno-74-181" name="__codelineno-74-181" href="#__codelineno-74-181"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">nextReceiver</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">numReceivers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-74-182"><a id="__codelineno-74-182" name="__codelineno-74-182" href="#__codelineno-74-182"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST_DEFERRAL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-74-183"><a id="__codelineno-74-183" name="__codelineno-74-183" href="#__codelineno-74-183"></a><span class="w">                    </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Sole receiver of &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span>
</span><span id="__span-74-184"><a id="__codelineno-74-184" name="__codelineno-74-184" href="#__codelineno-74-184"></a><span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; is under deferral; setting aside and proceeding&quot;</span><span class="p">);</span>
</span><span id="__span-74-185"><a id="__codelineno-74-185" name="__codelineno-74-185" href="#__codelineno-74-185"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-74-186"><a id="__codelineno-74-186" name="__codelineno-74-186" href="#__codelineno-74-186"></a><span class="w">                </span><span class="n">defer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">;</span>
</span><span id="__span-74-187"><a id="__codelineno-74-187" name="__codelineno-74-187" href="#__codelineno-74-187"></a><span class="w">                </span><span class="c1">// 下一个Receiver将延迟，再下一个Receiver已经没有了，</span>
</span><span id="__span-74-188"><a id="__codelineno-74-188" name="__codelineno-74-188" href="#__codelineno-74-188"></a><span class="w">                </span><span class="c1">// 则在retireBroadcastLocked中设置mCurrentBroadcast = null(一般在r == mCurrentBroadcast时)</span>
</span><span id="__span-74-189"><a id="__codelineno-74-189" name="__codelineno-74-189" href="#__codelineno-74-189"></a><span class="w">                </span><span class="n">mDispatcher</span><span class="p">.</span><span class="na">retireBroadcastLocked</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-74-190"><a id="__codelineno-74-190" name="__codelineno-74-190" href="#__codelineno-74-190"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-74-191"><a id="__codelineno-74-191" name="__codelineno-74-191" href="#__codelineno-74-191"></a><span class="w">                </span><span class="p">...</span>
</span><span id="__span-74-192"><a id="__codelineno-74-192" name="__codelineno-74-192" href="#__codelineno-74-192"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-74-193"><a id="__codelineno-74-193" name="__codelineno-74-193" href="#__codelineno-74-193"></a><span class="w">            </span><span class="c1">//将defer添加到延迟广播中，按照uid放入</span>
</span><span id="__span-74-194"><a id="__codelineno-74-194" name="__codelineno-74-194" href="#__codelineno-74-194"></a><span class="w">            </span><span class="n">mDispatcher</span><span class="p">.</span><span class="na">addDeferredBroadcast</span><span class="p">(</span><span class="n">receiverUid</span><span class="p">,</span><span class="w"> </span><span class="n">defer</span><span class="p">);</span>
</span><span id="__span-74-195"><a id="__codelineno-74-195" name="__codelineno-74-195" href="#__codelineno-74-195"></a><span class="w">            </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-74-196"><a id="__codelineno-74-196" name="__codelineno-74-196" href="#__codelineno-74-196"></a><span class="w">            </span><span class="n">looped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-74-197"><a id="__codelineno-74-197" name="__codelineno-74-197" href="#__codelineno-74-197"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-74-198"><a id="__codelineno-74-198" name="__codelineno-74-198" href="#__codelineno-74-198"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-74-199"><a id="__codelineno-74-199" name="__codelineno-74-199" href="#__codelineno-74-199"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-74-200"><a id="__codelineno-74-200" name="__codelineno-74-200" href="#__codelineno-74-200"></a><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
</span></code></pre></div>
<ul>
<li>
<p>广播已经全部处理完成</p>
</li>
<li>
<p>AMS将所有挂起的gc进程mProcessesToGc进行按顺序的gc</p>
</li>
<li>
<p>adj调整</p>
</li>
<li>
<p>广播未处理完</p>
</li>
<li>
<p>获取接收者的个数</p>
</li>
<li>
<p>判断ANR</p>
</li>
<li>
<p>接收者的个数 &gt; 0</p>
</li>
<li>now &gt; r.dispatchTime + (2 * mConstants.TIMEOUT(10s/60s) * numReceivers)</li>
</ul>
<p>now = 当前时间</p>
<p>r.dispatchTime = 开始分发该BroadcastRecord r的时间</p>
<p>mConstants.TIMEOUT = 10s/60s</p>
<p>numReceivers = 接收者的个数</p>
<p>调用broadcastTimeoutLocked函数来强制结束这个广播转发任务，</p>
<ul>
<li>
<p>如果已经完成了广播发送，而且发送时有设置IIntentReceiver resultTo(结果返回的地方)，则调用performReceiveLocked，返回结果给到resultTo</p>
</li>
<li>
<p>如果已经完成了广播发送，则取消该order的超时设定，输出“Finished with ordered broadcast”类似日志</p>
</li>
</ul>
<h5 id="_42">处理下一个接收者<a class="headerlink" href="#_42" title="Permanent link">&para;</a></h5>
<div class="language-java highlight"><pre><span></span><code><span id="__span-75-1"><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="c1">// Get the next receiver...</span>
</span><span id="__span-75-2"><a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a><span class="c1">//获取下一个将要处理的广播接收者在其列表中的位置</span>
</span><span id="__span-75-3"><a id="__codelineno-75-3" name="__codelineno-75-3" href="#__codelineno-75-3"></a><span class="kt">int</span><span class="w"> </span><span class="n">recIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">nextReceiver</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-75-4"><a id="__codelineno-75-4" name="__codelineno-75-4" href="#__codelineno-75-4"></a>
</span><span id="__span-75-5"><a id="__codelineno-75-5" name="__codelineno-75-5" href="#__codelineno-75-5"></a><span class="c1">// Keep track of when this receiver started, and make sure there</span>
</span><span id="__span-75-6"><a id="__codelineno-75-6" name="__codelineno-75-6" href="#__codelineno-75-6"></a><span class="c1">// is a timeout message pending to kill it if need be.</span>
</span><span id="__span-75-7"><a id="__codelineno-75-7" name="__codelineno-75-7" href="#__codelineno-75-7"></a><span class="c1">//设置receiver接受时间receiverTime(当前时间)</span>
</span><span id="__span-75-8"><a id="__codelineno-75-8" name="__codelineno-75-8" href="#__codelineno-75-8"></a><span class="n">r</span><span class="p">.</span><span class="na">receiverTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SystemClock</span><span class="p">.</span><span class="na">uptimeMillis</span><span class="p">();</span>
</span><span id="__span-75-9"><a id="__codelineno-75-9" name="__codelineno-75-9" href="#__codelineno-75-9"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">recIdx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="c1">// 表示第一个开始处理的接收者，也就是BroadcastRecord对象r所描述的广播任务刚被处理</span>
</span><span id="__span-75-10"><a id="__codelineno-75-10" name="__codelineno-75-10" href="#__codelineno-75-10"></a><span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="na">dispatchTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">receiverTime</span><span class="p">;</span>
</span><span id="__span-75-11"><a id="__codelineno-75-11" name="__codelineno-75-11" href="#__codelineno-75-11"></a><span class="w">    </span><span class="c1">// 接收者开始处理的时间戳，也就是这个接收者开始处理了，要记录开始时间来计算是否超过超时时间</span>
</span><span id="__span-75-12"><a id="__codelineno-75-12" name="__codelineno-75-12" href="#__codelineno-75-12"></a><span class="w">    </span><span class="c1">// 也就是说这是BroadcastRecord中第一个接收者开始被处理的时间戳，也就是上面BroadcastRecord</span>
</span><span id="__span-75-13"><a id="__codelineno-75-13" name="__codelineno-75-13" href="#__codelineno-75-13"></a><span class="w">    </span><span class="c1">// 超时的起点，可以看到上面超时比较的时候用的就是r.dispatchTime</span>
</span><span id="__span-75-14"><a id="__codelineno-75-14" name="__codelineno-75-14" href="#__codelineno-75-14"></a><span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="na">dispatchRealTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SystemClock</span><span class="p">.</span><span class="na">elapsedRealtime</span><span class="p">();</span>
</span><span id="__span-75-15"><a id="__codelineno-75-15" name="__codelineno-75-15" href="#__codelineno-75-15"></a><span class="w">    </span><span class="c1">//设置分发的系统时间(修改系统时间这个时间会变化)</span>
</span><span id="__span-75-16"><a id="__codelineno-75-16" name="__codelineno-75-16" href="#__codelineno-75-16"></a><span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="na">dispatchClockTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span>
</span><span id="__span-75-17"><a id="__codelineno-75-17" name="__codelineno-75-17" href="#__codelineno-75-17"></a>
</span><span id="__span-75-18"><a id="__codelineno-75-18" name="__codelineno-75-18" href="#__codelineno-75-18"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mLogLatencyMetrics</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="c1">//输出日志到FrameworkStatsLog中</span>
</span><span id="__span-75-19"><a id="__codelineno-75-19" name="__codelineno-75-19" href="#__codelineno-75-19"></a><span class="w">        </span><span class="n">FrameworkStatsLog</span><span class="p">.</span><span class="na">write</span><span class="p">(</span>
</span><span id="__span-75-20"><a id="__codelineno-75-20" name="__codelineno-75-20" href="#__codelineno-75-20"></a><span class="w">                </span><span class="n">FrameworkStatsLog</span><span class="p">.</span><span class="na">BROADCAST_DISPATCH_LATENCY_REPORTED</span><span class="p">,</span>
</span><span id="__span-75-21"><a id="__codelineno-75-21" name="__codelineno-75-21" href="#__codelineno-75-21"></a><span class="w">                </span><span class="n">r</span><span class="p">.</span><span class="na">dispatchClockTime</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">enqueueClockTime</span><span class="p">);</span>
</span><span id="__span-75-22"><a id="__codelineno-75-22" name="__codelineno-75-22" href="#__codelineno-75-22"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-75-23"><a id="__codelineno-75-23" name="__codelineno-75-23" href="#__codelineno-75-23"></a>
</span><span id="__span-75-24"><a id="__codelineno-75-24" name="__codelineno-75-24" href="#__codelineno-75-24"></a><span class="w">    </span><span class="c1">//trace相关</span>
</span><span id="__span-75-25"><a id="__codelineno-75-25" name="__codelineno-75-25" href="#__codelineno-75-25"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Trace</span><span class="p">.</span><span class="na">isTagEnabled</span><span class="p">(</span><span class="n">Trace</span><span class="p">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-75-26"><a id="__codelineno-75-26" name="__codelineno-75-26" href="#__codelineno-75-26"></a><span class="w">        </span><span class="n">Trace</span><span class="p">.</span><span class="na">asyncTraceEnd</span><span class="p">(</span><span class="n">Trace</span><span class="p">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="p">,</span>
</span><span id="__span-75-27"><a id="__codelineno-75-27" name="__codelineno-75-27" href="#__codelineno-75-27"></a><span class="w">            </span><span class="n">createBroadcastTraceTitle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">.</span><span class="na">DELIVERY_PENDING</span><span class="p">),</span>
</span><span id="__span-75-28"><a id="__codelineno-75-28" name="__codelineno-75-28" href="#__codelineno-75-28"></a><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">identityHashCode</span><span class="p">(</span><span class="n">r</span><span class="p">));</span>
</span><span id="__span-75-29"><a id="__codelineno-75-29" name="__codelineno-75-29" href="#__codelineno-75-29"></a><span class="w">        </span><span class="n">Trace</span><span class="p">.</span><span class="na">asyncTraceBegin</span><span class="p">(</span><span class="n">Trace</span><span class="p">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="p">,</span>
</span><span id="__span-75-30"><a id="__codelineno-75-30" name="__codelineno-75-30" href="#__codelineno-75-30"></a><span class="w">            </span><span class="n">createBroadcastTraceTitle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">.</span><span class="na">DELIVERY_DELIVERED</span><span class="p">),</span>
</span><span id="__span-75-31"><a id="__codelineno-75-31" name="__codelineno-75-31" href="#__codelineno-75-31"></a><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">identityHashCode</span><span class="p">(</span><span class="n">r</span><span class="p">));</span>
</span><span id="__span-75-32"><a id="__codelineno-75-32" name="__codelineno-75-32" href="#__codelineno-75-32"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-75-33"><a id="__codelineno-75-33" name="__codelineno-75-33" href="#__codelineno-75-33"></a><span class="w">    </span><span class="c1">//输出开始发送order的广播</span>
</span><span id="__span-75-34"><a id="__codelineno-75-34" name="__codelineno-75-34" href="#__codelineno-75-34"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST_LIGHT</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Processing ordered broadcast [&quot;</span>
</span><span id="__span-75-35"><a id="__codelineno-75-35" name="__codelineno-75-35" href="#__codelineno-75-35"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;] &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-75-36"><a id="__codelineno-75-36" name="__codelineno-75-36" href="#__codelineno-75-36"></a><span class="p">}</span>
</span><span id="__span-75-37"><a id="__codelineno-75-37" name="__codelineno-75-37" href="#__codelineno-75-37"></a><span class="c1">//如果还没有设置超时时间，此处设置超时时间</span>
</span><span id="__span-75-38"><a id="__codelineno-75-38" name="__codelineno-75-38" href="#__codelineno-75-38"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="w"> </span><span class="n">mPendingBroadcastTimeoutMessage</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-75-39"><a id="__codelineno-75-39" name="__codelineno-75-39" href="#__codelineno-75-39"></a><span class="w">    </span><span class="c1">//设置超时，传入参数是r.receiverTime + mTimeoutPeriod，也就是开始时间加上超时时间</span>
</span><span id="__span-75-40"><a id="__codelineno-75-40" name="__codelineno-75-40" href="#__codelineno-75-40"></a><span class="w">    </span><span class="c1">//mTimeoutPeriod，mTimeoutPeriod初始化是在BroadcastQueue初始化的时候传入的，</span>
</span><span id="__span-75-41"><a id="__codelineno-75-41" name="__codelineno-75-41" href="#__codelineno-75-41"></a><span class="w">    </span><span class="c1">//也就是在AMS（AMS构造函数中）中初始化mFgBroadcastQueue和mBgBroadcastQueue时传入的</span>
</span><span id="__span-75-42"><a id="__codelineno-75-42" name="__codelineno-75-42" href="#__codelineno-75-42"></a><span class="w">    </span><span class="c1">//BROADCAST_FG_TIMEOUT = 10 * 1000和BROADCAST_BG_TIMEOUT = 60 * 1000，</span>
</span><span id="__span-75-43"><a id="__codelineno-75-43" name="__codelineno-75-43" href="#__codelineno-75-43"></a><span class="w">    </span><span class="c1">//这里开始埋了ANR的雷</span>
</span><span id="__span-75-44"><a id="__codelineno-75-44" name="__codelineno-75-44" href="#__codelineno-75-44"></a><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">timeoutTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">receiverTime</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mConstants</span><span class="p">.</span><span class="na">TIMEOUT</span><span class="p">;</span>
</span><span id="__span-75-45"><a id="__codelineno-75-45" name="__codelineno-75-45" href="#__codelineno-75-45"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span>
</span><span id="__span-75-46"><a id="__codelineno-75-46" name="__codelineno-75-46" href="#__codelineno-75-46"></a><span class="w">            </span><span class="s">&quot;Submitting BROADCAST_TIMEOUT_MSG [&quot;</span>
</span><span id="__span-75-47"><a id="__codelineno-75-47" name="__codelineno-75-47" href="#__codelineno-75-47"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;] for &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; at &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">timeoutTime</span><span class="p">);</span>
</span><span id="__span-75-48"><a id="__codelineno-75-48" name="__codelineno-75-48" href="#__codelineno-75-48"></a><span class="w">    </span><span class="n">setBroadcastTimeoutLocked</span><span class="p">(</span><span class="n">timeoutTime</span><span class="p">);</span>
</span><span id="__span-75-49"><a id="__codelineno-75-49" name="__codelineno-75-49" href="#__codelineno-75-49"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>第一个接收者会设置r.dispatchTime广播分发时间(SystemClock.uptimeMillis当前时间，不受系统时间修改影响)、r.dispatchClockTime分发的系统时间(System.currentTimeMillis，该时间会随系统时间变化而变化)</li>
<li>设置超时时间setBroadcastTimeoutLocked(前台是10s超时，后台是60s超时，针对是单个注册者的时间)，每个有序的接受者，都是从取出开始算时间r.receiverTime = SystemClock.uptimeMillis();</li>
<li>开始处理时输出如："Processing ordered broadcast"类似的日志</li>
</ul>
<h5 id="_43">发送广播<a class="headerlink" href="#_43" title="Permanent link">&para;</a></h5>
<p>上面分析的时候对于BroadcastRecord.receivers里面包含两种receiver接收者：order广播下的动态注册接收者和静态接收者，这两种receiver处理的方式是不一样的，对于order广播下的动态注册receiver而言，接收者进程一定是已经启动的，但是对于静态接收者receiver而言，当前的receiver进程可能还没有启动，因此动态和静态的receiver处理的逻辑不一样，需要分开处理，而静态接收者又分为进程已经启动和尚未启动两种情况。</p>
<p>所以发送广播这一部分我们分成三个小点来分析：动态注册有序广播接收者、进程已经启动的静态有序广播接收者、进程还未启动的静态有序广播接收者。</p>
<h6 id="_44">动态注册有序广播接收者<a class="headerlink" href="#_44" title="Permanent link">&para;</a></h6>
<div class="language-java highlight"><pre><span></span><code><span id="__span-76-1"><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a><span class="kd">final</span><span class="w"> </span><span class="n">BroadcastOptions</span><span class="w"> </span><span class="n">brOptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">options</span><span class="p">;</span>
</span><span id="__span-76-2"><a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a><span class="c1">//获取下一个接受者</span>
</span><span id="__span-76-3"><a id="__codelineno-76-3" name="__codelineno-76-3" href="#__codelineno-76-3"></a><span class="kd">final</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">nextReceiver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">receivers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">recIdx</span><span class="p">);</span>
</span><span id="__span-76-4"><a id="__codelineno-76-4" name="__codelineno-76-4" href="#__codelineno-76-4"></a>
</span><span id="__span-76-5"><a id="__codelineno-76-5" name="__codelineno-76-5" href="#__codelineno-76-5"></a><span class="c1">// 如果当前nextReceiver是一个BroadcastFilter类型，说明是一个动态注册接收者，不需要启动一个进程,</span>
</span><span id="__span-76-6"><a id="__codelineno-76-6" name="__codelineno-76-6" href="#__codelineno-76-6"></a><span class="c1">// 直接调用deliverToRegisteredReceiverLocked函数发送广播</span>
</span><span id="__span-76-7"><a id="__codelineno-76-7" name="__codelineno-76-7" href="#__codelineno-76-7"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nextReceiver</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">BroadcastFilter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-76-8"><a id="__codelineno-76-8" name="__codelineno-76-8" href="#__codelineno-76-8"></a><span class="w">    </span><span class="c1">// Simple case: this is a registered receiver who gets</span>
</span><span id="__span-76-9"><a id="__codelineno-76-9" name="__codelineno-76-9" href="#__codelineno-76-9"></a><span class="w">    </span><span class="c1">// a direct call.</span>
</span><span id="__span-76-10"><a id="__codelineno-76-10" name="__codelineno-76-10" href="#__codelineno-76-10"></a><span class="w">    </span><span class="n">BroadcastFilter</span><span class="w"> </span><span class="n">filter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">BroadcastFilter</span><span class="p">)</span><span class="n">nextReceiver</span><span class="p">;</span>
</span><span id="__span-76-11"><a id="__codelineno-76-11" name="__codelineno-76-11" href="#__codelineno-76-11"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w">  </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span>
</span><span id="__span-76-12"><a id="__codelineno-76-12" name="__codelineno-76-12" href="#__codelineno-76-12"></a><span class="w">            </span><span class="s">&quot;Delivering ordered [&quot;</span>
</span><span id="__span-76-13"><a id="__codelineno-76-13" name="__codelineno-76-13" href="#__codelineno-76-13"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;] to registered &quot;</span>
</span><span id="__span-76-14"><a id="__codelineno-76-14" name="__codelineno-76-14" href="#__codelineno-76-14"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">filter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-76-15"><a id="__codelineno-76-15" name="__codelineno-76-15" href="#__codelineno-76-15"></a><span class="w">    </span><span class="c1">// 调用deliverToRegisteredReceiverLocked向所有的receivers发送广播</span>
</span><span id="__span-76-16"><a id="__codelineno-76-16" name="__codelineno-76-16" href="#__codelineno-76-16"></a><span class="w">    </span><span class="c1">// 将它所描述的每一个无序广播发送给每一个广播接收者，异步处理广播</span>
</span><span id="__span-76-17"><a id="__codelineno-76-17" name="__codelineno-76-17" href="#__codelineno-76-17"></a><span class="w">    </span><span class="c1">// 通过deliverToRegisteredReceiverLocked调用ActivityThread.scheduleRegisteredReceiver处理广播</span>
</span><span id="__span-76-18"><a id="__codelineno-76-18" name="__codelineno-76-18" href="#__codelineno-76-18"></a><span class="w">    </span><span class="n">deliverToRegisteredReceiverLocked</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">filter</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">ordered</span><span class="p">,</span><span class="w"> </span><span class="n">recIdx</span><span class="p">);</span>
</span><span id="__span-76-19"><a id="__codelineno-76-19" name="__codelineno-76-19" href="#__codelineno-76-19"></a><span class="w">    </span><span class="c1">//如果r.receiver == null(没有正在执行的广播)</span>
</span><span id="__span-76-20"><a id="__codelineno-76-20" name="__codelineno-76-20" href="#__codelineno-76-20"></a><span class="w">    </span><span class="c1">//或者该广播是非order（无序）的</span>
</span><span id="__span-76-21"><a id="__codelineno-76-21" name="__codelineno-76-21" href="#__codelineno-76-21"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">receiver</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">r</span><span class="p">.</span><span class="na">ordered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-76-22"><a id="__codelineno-76-22" name="__codelineno-76-22" href="#__codelineno-76-22"></a><span class="w">        </span><span class="c1">// The receiver has already finished, so schedule to</span>
</span><span id="__span-76-23"><a id="__codelineno-76-23" name="__codelineno-76-23" href="#__codelineno-76-23"></a><span class="w">        </span><span class="c1">// process the next one.</span>
</span><span id="__span-76-24"><a id="__codelineno-76-24" name="__codelineno-76-24" href="#__codelineno-76-24"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Quick finishing [&quot;</span>
</span><span id="__span-76-25"><a id="__codelineno-76-25" name="__codelineno-76-25" href="#__codelineno-76-25"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;]: ordered=&quot;</span>
</span><span id="__span-76-26"><a id="__codelineno-76-26" name="__codelineno-76-26" href="#__codelineno-76-26"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">ordered</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; receiver=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">receiver</span><span class="p">);</span>
</span><span id="__span-76-27"><a id="__codelineno-76-27" name="__codelineno-76-27" href="#__codelineno-76-27"></a><span class="w">        </span><span class="c1">// 设置IDLE状态，表示AMS不需要等待它的前一个目标广播接收者处理完成一个广播就可以将该广播</span>
</span><span id="__span-76-28"><a id="__codelineno-76-28" name="__codelineno-76-28" href="#__codelineno-76-28"></a><span class="w">        </span><span class="c1">// 继续发送给它的下一个目标广播接收者处理</span>
</span><span id="__span-76-29"><a id="__codelineno-76-29" name="__codelineno-76-29" href="#__codelineno-76-29"></a><span class="w">        </span><span class="n">r</span><span class="p">.</span><span class="na">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">.</span><span class="na">IDLE</span><span class="p">;</span>
</span><span id="__span-76-30"><a id="__codelineno-76-30" name="__codelineno-76-30" href="#__codelineno-76-30"></a><span class="w">        </span><span class="c1">// 调用scheduleBroadcastsLocked函数就是为了将一个广播继续发送给BroadcastRecord对象r所描述的广播转发任务的</span>
</span><span id="__span-76-31"><a id="__codelineno-76-31" name="__codelineno-76-31" href="#__codelineno-76-31"></a><span class="w">        </span><span class="c1">// 下一个目标广播接收者处理的</span>
</span><span id="__span-76-32"><a id="__codelineno-76-32" name="__codelineno-76-32" href="#__codelineno-76-32"></a><span class="w">        </span><span class="n">scheduleBroadcastsLocked</span><span class="p">();</span>
</span><span id="__span-76-33"><a id="__codelineno-76-33" name="__codelineno-76-33" href="#__codelineno-76-33"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-76-34"><a id="__codelineno-76-34" name="__codelineno-76-34" href="#__codelineno-76-34"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-76-35"><a id="__codelineno-76-35" name="__codelineno-76-35" href="#__codelineno-76-35"></a><span class="w">            </span><span class="n">maybeAddAllowBackgroundActivityStartsToken</span><span class="p">(</span><span class="n">filter</span><span class="p">.</span><span class="na">receiverList</span><span class="p">.</span><span class="na">app</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-76-36"><a id="__codelineno-76-36" name="__codelineno-76-36" href="#__codelineno-76-36"></a><span class="w">            </span><span class="c1">// r is guaranteed ordered at this point, so we know finishReceiverLocked()</span>
</span><span id="__span-76-37"><a id="__codelineno-76-37" name="__codelineno-76-37" href="#__codelineno-76-37"></a><span class="w">            </span><span class="c1">// will get a callback and handle the activity start token lifecycle.</span>
</span><span id="__span-76-38"><a id="__codelineno-76-38" name="__codelineno-76-38" href="#__codelineno-76-38"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-76-39"><a id="__codelineno-76-39" name="__codelineno-76-39" href="#__codelineno-76-39"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-76-40"><a id="__codelineno-76-40" name="__codelineno-76-40" href="#__codelineno-76-40"></a><span class="w">    </span><span class="c1">//直接返回，代表本次完成，一次处理一个广播中的nextReceiver</span>
</span><span id="__span-76-41"><a id="__codelineno-76-41" name="__codelineno-76-41" href="#__codelineno-76-41"></a><span class="w">    </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-76-42"><a id="__codelineno-76-42" name="__codelineno-76-42" href="#__codelineno-76-42"></a><span class="p">}</span>
</span></code></pre></div>
<h6 id="_45">进程已经启动的静态有序广播接收者<a class="headerlink" href="#_45" title="Permanent link">&para;</a></h6>
<p>发送给静态有序广播之前先做一些跳过的逻辑处理。</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-77-1"><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a><span class="c1">// Hard case: need to instantiate the receiver, possibly</span>
</span><span id="__span-77-2"><a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a><span class="c1">// starting its application process to host it.</span>
</span><span id="__span-77-3"><a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a>
</span><span id="__span-77-4"><a id="__codelineno-77-4" name="__codelineno-77-4" href="#__codelineno-77-4"></a><span class="c1">//如果上面if没有进行拦截，说明不是广播接收者动态注册的，而应该是静态注册的，此时进程可能没有启动</span>
</span><span id="__span-77-5"><a id="__codelineno-77-5" name="__codelineno-77-5" href="#__codelineno-77-5"></a><span class="n">ResolveInfo</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-77-6"><a id="__codelineno-77-6" name="__codelineno-77-6" href="#__codelineno-77-6"></a><span class="w">    </span><span class="p">(</span><span class="n">ResolveInfo</span><span class="p">)</span><span class="n">nextReceiver</span><span class="p">;</span>
</span><span id="__span-77-7"><a id="__codelineno-77-7" name="__codelineno-77-7" href="#__codelineno-77-7"></a><span class="n">ComponentName</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ComponentName</span><span class="p">(</span>
</span><span id="__span-77-8"><a id="__codelineno-77-8" name="__codelineno-77-8" href="#__codelineno-77-8"></a><span class="w">        </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">packageName</span><span class="p">,</span>
</span><span id="__span-77-9"><a id="__codelineno-77-9" name="__codelineno-77-9" href="#__codelineno-77-9"></a><span class="w">        </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">name</span><span class="p">);</span>
</span><span id="__span-77-10"><a id="__codelineno-77-10" name="__codelineno-77-10" href="#__codelineno-77-10"></a>
</span><span id="__span-77-11"><a id="__codelineno-77-11" name="__codelineno-77-11" href="#__codelineno-77-11"></a><span class="c1">//静态注册者跳过的逻辑，跳过的逻辑较多</span>
</span><span id="__span-77-12"><a id="__codelineno-77-12" name="__codelineno-77-12" href="#__codelineno-77-12"></a>
</span><span id="__span-77-13"><a id="__codelineno-77-13" name="__codelineno-77-13" href="#__codelineno-77-13"></a><span class="kt">boolean</span><span class="w"> </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-77-14"><a id="__codelineno-77-14" name="__codelineno-77-14" href="#__codelineno-77-14"></a>
</span><span id="__span-77-15"><a id="__codelineno-77-15" name="__codelineno-77-15" href="#__codelineno-77-15"></a><span class="c1">//sdk的一些判断</span>
</span><span id="__span-77-16"><a id="__codelineno-77-16" name="__codelineno-77-16" href="#__codelineno-77-16"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">brOptions</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-77-17"><a id="__codelineno-77-17" name="__codelineno-77-17" href="#__codelineno-77-17"></a><span class="w">        </span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">targetSdkVersion</span>
</span><span id="__span-77-18"><a id="__codelineno-77-18" name="__codelineno-77-18" href="#__codelineno-77-18"></a><span class="w">                </span><span class="o">&lt;</span><span class="w"> </span><span class="n">brOptions</span><span class="p">.</span><span class="na">getMinManifestReceiverApiLevel</span><span class="p">()</span><span class="w"> </span><span class="o">||</span>
</span><span id="__span-77-19"><a id="__codelineno-77-19" name="__codelineno-77-19" href="#__codelineno-77-19"></a><span class="w">        </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">targetSdkVersion</span>
</span><span id="__span-77-20"><a id="__codelineno-77-20" name="__codelineno-77-20" href="#__codelineno-77-20"></a><span class="w">                </span><span class="o">&gt;</span><span class="w"> </span><span class="n">brOptions</span><span class="p">.</span><span class="na">getMaxManifestReceiverApiLevel</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-21"><a id="__codelineno-77-21" name="__codelineno-77-21" href="#__codelineno-77-21"></a><span class="w">    </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Target SDK mismatch: receiver &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span>
</span><span id="__span-77-22"><a id="__codelineno-77-22" name="__codelineno-77-22" href="#__codelineno-77-22"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; targets &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">targetSdkVersion</span>
</span><span id="__span-77-23"><a id="__codelineno-77-23" name="__codelineno-77-23" href="#__codelineno-77-23"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; but delivery restricted to [&quot;</span>
</span><span id="__span-77-24"><a id="__codelineno-77-24" name="__codelineno-77-24" href="#__codelineno-77-24"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">brOptions</span><span class="p">.</span><span class="na">getMinManifestReceiverApiLevel</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, &quot;</span>
</span><span id="__span-77-25"><a id="__codelineno-77-25" name="__codelineno-77-25" href="#__codelineno-77-25"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">brOptions</span><span class="p">.</span><span class="na">getMaxManifestReceiverApiLevel</span><span class="p">()</span>
</span><span id="__span-77-26"><a id="__codelineno-77-26" name="__codelineno-77-26" href="#__codelineno-77-26"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;] broadcasting &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">broadcastDescription</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">));</span>
</span><span id="__span-77-27"><a id="__codelineno-77-27" name="__codelineno-77-27" href="#__codelineno-77-27"></a><span class="w">    </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-77-28"><a id="__codelineno-77-28" name="__codelineno-77-28" href="#__codelineno-77-28"></a><span class="p">}</span>
</span><span id="__span-77-29"><a id="__codelineno-77-29" name="__codelineno-77-29" href="#__codelineno-77-29"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">brOptions</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-77-30"><a id="__codelineno-77-30" name="__codelineno-77-30" href="#__codelineno-77-30"></a><span class="w">        </span><span class="o">!</span><span class="n">brOptions</span><span class="p">.</span><span class="na">testRequireCompatChange</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-31"><a id="__codelineno-77-31" name="__codelineno-77-31" href="#__codelineno-77-31"></a><span class="w">    </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Compat change filtered: broadcasting &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">broadcastDescription</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">)</span>
</span><span id="__span-77-32"><a id="__codelineno-77-32" name="__codelineno-77-32" href="#__codelineno-77-32"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; to uid &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; due to compat change &quot;</span>
</span><span id="__span-77-33"><a id="__codelineno-77-33" name="__codelineno-77-33" href="#__codelineno-77-33"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">options</span><span class="p">.</span><span class="na">getRequireCompatChangeId</span><span class="p">());</span>
</span><span id="__span-77-34"><a id="__codelineno-77-34" name="__codelineno-77-34" href="#__codelineno-77-34"></a><span class="w">    </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-77-35"><a id="__codelineno-77-35" name="__codelineno-77-35" href="#__codelineno-77-35"></a><span class="p">}</span>
</span><span id="__span-77-36"><a id="__codelineno-77-36" name="__codelineno-77-36" href="#__codelineno-77-36"></a><span class="c1">//查看发送者的uid和接受者的uid是否一样，或者是否系统uid，确定一些是否两者有设定关联关系</span>
</span><span id="__span-77-37"><a id="__codelineno-77-37" name="__codelineno-77-37" href="#__codelineno-77-37"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">skip</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">mService</span><span class="p">.</span><span class="na">validateAssociationAllowedLocked</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">callerPackage</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="p">,</span>
</span><span id="__span-77-38"><a id="__codelineno-77-38" name="__codelineno-77-38" href="#__codelineno-77-38"></a><span class="w">        </span><span class="n">component</span><span class="p">.</span><span class="na">getPackageName</span><span class="p">(),</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-39"><a id="__codelineno-77-39" name="__codelineno-77-39" href="#__codelineno-77-39"></a><span class="w">    </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Association not allowed: broadcasting &quot;</span>
</span><span id="__span-77-40"><a id="__codelineno-77-40" name="__codelineno-77-40" href="#__codelineno-77-40"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">broadcastDescription</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">));</span>
</span><span id="__span-77-41"><a id="__codelineno-77-41" name="__codelineno-77-41" href="#__codelineno-77-41"></a><span class="w">    </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-77-42"><a id="__codelineno-77-42" name="__codelineno-77-42" href="#__codelineno-77-42"></a><span class="p">}</span>
</span><span id="__span-77-43"><a id="__codelineno-77-43" name="__codelineno-77-43" href="#__codelineno-77-43"></a>
</span><span id="__span-77-44"><a id="__codelineno-77-44" name="__codelineno-77-44" href="#__codelineno-77-44"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">skip</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-45"><a id="__codelineno-77-45" name="__codelineno-77-45" href="#__codelineno-77-45"></a><span class="w">    </span><span class="c1">//看一下intent防火墙mIntentFirewall是否有block该发送行为</span>
</span><span id="__span-77-46"><a id="__codelineno-77-46" name="__codelineno-77-46" href="#__codelineno-77-46"></a><span class="w">    </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="n">mService</span><span class="p">.</span><span class="na">mIntentFirewall</span><span class="p">.</span><span class="na">checkBroadcast</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="p">,</span>
</span><span id="__span-77-47"><a id="__codelineno-77-47" name="__codelineno-77-47" href="#__codelineno-77-47"></a><span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="na">callingPid</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">resolvedType</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">);</span>
</span><span id="__span-77-48"><a id="__codelineno-77-48" name="__codelineno-77-48" href="#__codelineno-77-48"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">skip</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-49"><a id="__codelineno-77-49" name="__codelineno-77-49" href="#__codelineno-77-49"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Firewall blocked: broadcasting &quot;</span>
</span><span id="__span-77-50"><a id="__codelineno-77-50" name="__codelineno-77-50" href="#__codelineno-77-50"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">broadcastDescription</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">));</span>
</span><span id="__span-77-51"><a id="__codelineno-77-51" name="__codelineno-77-51" href="#__codelineno-77-51"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-77-52"><a id="__codelineno-77-52" name="__codelineno-77-52" href="#__codelineno-77-52"></a><span class="p">}</span>
</span><span id="__span-77-53"><a id="__codelineno-77-53" name="__codelineno-77-53" href="#__codelineno-77-53"></a><span class="c1">//权限相关的的检查</span>
</span><span id="__span-77-54"><a id="__codelineno-77-54" name="__codelineno-77-54" href="#__codelineno-77-54"></a><span class="kt">int</span><span class="w"> </span><span class="n">perm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mService</span><span class="p">.</span><span class="na">checkComponentPermission</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">permission</span><span class="p">,</span>
</span><span id="__span-77-55"><a id="__codelineno-77-55" name="__codelineno-77-55" href="#__codelineno-77-55"></a><span class="w">        </span><span class="n">r</span><span class="p">.</span><span class="na">callingPid</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">,</span>
</span><span id="__span-77-56"><a id="__codelineno-77-56" name="__codelineno-77-56" href="#__codelineno-77-56"></a><span class="w">        </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">exported</span><span class="p">);</span>
</span><span id="__span-77-57"><a id="__codelineno-77-57" name="__codelineno-77-57" href="#__codelineno-77-57"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">skip</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">perm</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="na">PERMISSION_GRANTED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-58"><a id="__codelineno-77-58" name="__codelineno-77-58" href="#__codelineno-77-58"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">exported</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-59"><a id="__codelineno-77-59" name="__codelineno-77-59" href="#__codelineno-77-59"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Permission Denial: broadcasting &quot;</span>
</span><span id="__span-77-60"><a id="__codelineno-77-60" name="__codelineno-77-60" href="#__codelineno-77-60"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">broadcastDescription</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">)</span>
</span><span id="__span-77-61"><a id="__codelineno-77-61" name="__codelineno-77-61" href="#__codelineno-77-61"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; is not exported from uid &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">);</span>
</span><span id="__span-77-62"><a id="__codelineno-77-62" name="__codelineno-77-62" href="#__codelineno-77-62"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-63"><a id="__codelineno-77-63" name="__codelineno-77-63" href="#__codelineno-77-63"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Permission Denial: broadcasting &quot;</span>
</span><span id="__span-77-64"><a id="__codelineno-77-64" name="__codelineno-77-64" href="#__codelineno-77-64"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">broadcastDescription</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">)</span>
</span><span id="__span-77-65"><a id="__codelineno-77-65" name="__codelineno-77-65" href="#__codelineno-77-65"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; requires &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">permission</span><span class="p">);</span>
</span><span id="__span-77-66"><a id="__codelineno-77-66" name="__codelineno-77-66" href="#__codelineno-77-66"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-77-67"><a id="__codelineno-77-67" name="__codelineno-77-67" href="#__codelineno-77-67"></a><span class="w">    </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-77-68"><a id="__codelineno-77-68" name="__codelineno-77-68" href="#__codelineno-77-68"></a><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">skip</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">permission</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-69"><a id="__codelineno-77-69" name="__codelineno-77-69" href="#__codelineno-77-69"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">opCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">permissionToOpCode</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">permission</span><span class="p">);</span>
</span><span id="__span-77-70"><a id="__codelineno-77-70" name="__codelineno-77-70" href="#__codelineno-77-70"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">opCode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">OP_NONE</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mService</span><span class="p">.</span><span class="na">getAppOpsManager</span><span class="p">().</span><span class="na">noteOpNoThrow</span><span class="p">(</span><span class="n">opCode</span><span class="p">,</span>
</span><span id="__span-77-71"><a id="__codelineno-77-71" name="__codelineno-77-71" href="#__codelineno-77-71"></a><span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callerPackage</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callerFeatureId</span><span class="p">,</span>
</span><span id="__span-77-72"><a id="__codelineno-77-72" name="__codelineno-77-72" href="#__codelineno-77-72"></a><span class="w">            </span><span class="s">&quot;Broadcast delivered to &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">name</span><span class="p">)</span>
</span><span id="__span-77-73"><a id="__codelineno-77-73" name="__codelineno-77-73" href="#__codelineno-77-73"></a><span class="w">            </span><span class="o">!=</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">MODE_ALLOWED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-74"><a id="__codelineno-77-74" name="__codelineno-77-74" href="#__codelineno-77-74"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Appop Denial: broadcasting &quot;</span>
</span><span id="__span-77-75"><a id="__codelineno-77-75" name="__codelineno-77-75" href="#__codelineno-77-75"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">broadcastDescription</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">)</span>
</span><span id="__span-77-76"><a id="__codelineno-77-76" name="__codelineno-77-76" href="#__codelineno-77-76"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; requires appop &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">permissionToOp</span><span class="p">(</span>
</span><span id="__span-77-77"><a id="__codelineno-77-77" name="__codelineno-77-77" href="#__codelineno-77-77"></a><span class="w">                        </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">permission</span><span class="p">));</span>
</span><span id="__span-77-78"><a id="__codelineno-77-78" name="__codelineno-77-78" href="#__codelineno-77-78"></a><span class="w">        </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-77-79"><a id="__codelineno-77-79" name="__codelineno-77-79" href="#__codelineno-77-79"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-77-80"><a id="__codelineno-77-80" name="__codelineno-77-80" href="#__codelineno-77-80"></a><span class="p">}</span>
</span><span id="__span-77-81"><a id="__codelineno-77-81" name="__codelineno-77-81" href="#__codelineno-77-81"></a>
</span><span id="__span-77-82"><a id="__codelineno-77-82" name="__codelineno-77-82" href="#__codelineno-77-82"></a><span class="kt">boolean</span><span class="w"> </span><span class="n">isSingleton</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-77-83"><a id="__codelineno-77-83" name="__codelineno-77-83" href="#__codelineno-77-83"></a><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-84"><a id="__codelineno-77-84" name="__codelineno-77-84" href="#__codelineno-77-84"></a><span class="w">    </span><span class="n">isSingleton</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mService</span><span class="p">.</span><span class="na">isSingleton</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">processName</span><span class="p">,</span>
</span><span id="__span-77-85"><a id="__codelineno-77-85" name="__codelineno-77-85" href="#__codelineno-77-85"></a><span class="w">            </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">,</span>
</span><span id="__span-77-86"><a id="__codelineno-77-86" name="__codelineno-77-86" href="#__codelineno-77-86"></a><span class="w">            </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">name</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">flags</span><span class="p">);</span>
</span><span id="__span-77-87"><a id="__codelineno-77-87" name="__codelineno-77-87" href="#__codelineno-77-87"></a><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">SecurityException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-88"><a id="__codelineno-77-88" name="__codelineno-77-88" href="#__codelineno-77-88"></a><span class="w">    </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
</span><span id="__span-77-89"><a id="__codelineno-77-89" name="__codelineno-77-89" href="#__codelineno-77-89"></a><span class="w">    </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-77-90"><a id="__codelineno-77-90" name="__codelineno-77-90" href="#__codelineno-77-90"></a><span class="p">}</span>
</span><span id="__span-77-91"><a id="__codelineno-77-91" name="__codelineno-77-91" href="#__codelineno-77-91"></a><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">flags</span><span class="o">&amp;</span><span class="n">ActivityInfo</span><span class="p">.</span><span class="na">FLAG_SINGLE_USER</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-92"><a id="__codelineno-77-92" name="__codelineno-77-92" href="#__codelineno-77-92"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">checkUidPermission</span><span class="p">(</span>
</span><span id="__span-77-93"><a id="__codelineno-77-93" name="__codelineno-77-93" href="#__codelineno-77-93"></a><span class="w">            </span><span class="n">android</span><span class="p">.</span><span class="na">Manifest</span><span class="p">.</span><span class="na">permission</span><span class="p">.</span><span class="na">INTERACT_ACROSS_USERS</span><span class="p">,</span>
</span><span id="__span-77-94"><a id="__codelineno-77-94" name="__codelineno-77-94" href="#__codelineno-77-94"></a><span class="w">            </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">)</span>
</span><span id="__span-77-95"><a id="__codelineno-77-95" name="__codelineno-77-95" href="#__codelineno-77-95"></a><span class="w">                    </span><span class="o">!=</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="na">PERMISSION_GRANTED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-96"><a id="__codelineno-77-96" name="__codelineno-77-96" href="#__codelineno-77-96"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Permission Denial: Receiver &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">component</span><span class="p">.</span><span class="na">flattenToShortString</span><span class="p">()</span>
</span><span id="__span-77-97"><a id="__codelineno-77-97" name="__codelineno-77-97" href="#__codelineno-77-97"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; requests FLAG_SINGLE_USER, but app does not hold &quot;</span>
</span><span id="__span-77-98"><a id="__codelineno-77-98" name="__codelineno-77-98" href="#__codelineno-77-98"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">android</span><span class="p">.</span><span class="na">Manifest</span><span class="p">.</span><span class="na">permission</span><span class="p">.</span><span class="na">INTERACT_ACROSS_USERS</span><span class="p">);</span>
</span><span id="__span-77-99"><a id="__codelineno-77-99" name="__codelineno-77-99" href="#__codelineno-77-99"></a><span class="w">        </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-77-100"><a id="__codelineno-77-100" name="__codelineno-77-100" href="#__codelineno-77-100"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-77-101"><a id="__codelineno-77-101" name="__codelineno-77-101" href="#__codelineno-77-101"></a><span class="p">}</span>
</span><span id="__span-77-102"><a id="__codelineno-77-102" name="__codelineno-77-102" href="#__codelineno-77-102"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">skip</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">isInstantApp</span><span class="p">()</span>
</span><span id="__span-77-103"><a id="__codelineno-77-103" name="__codelineno-77-103" href="#__codelineno-77-103"></a><span class="w">        </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-104"><a id="__codelineno-77-104" name="__codelineno-77-104" href="#__codelineno-77-104"></a><span class="w">    </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Instant App Denial: receiving &quot;</span>
</span><span id="__span-77-105"><a id="__codelineno-77-105" name="__codelineno-77-105" href="#__codelineno-77-105"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span>
</span><span id="__span-77-106"><a id="__codelineno-77-106" name="__codelineno-77-106" href="#__codelineno-77-106"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; to &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">component</span><span class="p">.</span><span class="na">flattenToShortString</span><span class="p">()</span>
</span><span id="__span-77-107"><a id="__codelineno-77-107" name="__codelineno-77-107" href="#__codelineno-77-107"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; due to sender &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callerPackage</span>
</span><span id="__span-77-108"><a id="__codelineno-77-108" name="__codelineno-77-108" href="#__codelineno-77-108"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; (uid &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;)&quot;</span>
</span><span id="__span-77-109"><a id="__codelineno-77-109" name="__codelineno-77-109" href="#__codelineno-77-109"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; Instant Apps do not support manifest receivers&quot;</span><span class="p">);</span>
</span><span id="__span-77-110"><a id="__codelineno-77-110" name="__codelineno-77-110" href="#__codelineno-77-110"></a><span class="w">    </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-77-111"><a id="__codelineno-77-111" name="__codelineno-77-111" href="#__codelineno-77-111"></a><span class="p">}</span>
</span><span id="__span-77-112"><a id="__codelineno-77-112" name="__codelineno-77-112" href="#__codelineno-77-112"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">skip</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callerInstantApp</span>
</span><span id="__span-77-113"><a id="__codelineno-77-113" name="__codelineno-77-113" href="#__codelineno-77-113"></a><span class="w">        </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ActivityInfo</span><span class="p">.</span><span class="na">FLAG_VISIBLE_TO_INSTANT_APP</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-77-114"><a id="__codelineno-77-114" name="__codelineno-77-114" href="#__codelineno-77-114"></a><span class="w">        </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-115"><a id="__codelineno-77-115" name="__codelineno-77-115" href="#__codelineno-77-115"></a><span class="w">    </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Instant App Denial: receiving &quot;</span>
</span><span id="__span-77-116"><a id="__codelineno-77-116" name="__codelineno-77-116" href="#__codelineno-77-116"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span>
</span><span id="__span-77-117"><a id="__codelineno-77-117" name="__codelineno-77-117" href="#__codelineno-77-117"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; to &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">component</span><span class="p">.</span><span class="na">flattenToShortString</span><span class="p">()</span>
</span><span id="__span-77-118"><a id="__codelineno-77-118" name="__codelineno-77-118" href="#__codelineno-77-118"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; requires receiver have visibleToInstantApps set&quot;</span>
</span><span id="__span-77-119"><a id="__codelineno-77-119" name="__codelineno-77-119" href="#__codelineno-77-119"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; due to sender &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callerPackage</span>
</span><span id="__span-77-120"><a id="__codelineno-77-120" name="__codelineno-77-120" href="#__codelineno-77-120"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; (uid &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="p">);</span>
</span><span id="__span-77-121"><a id="__codelineno-77-121" name="__codelineno-77-121" href="#__codelineno-77-121"></a><span class="w">    </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-77-122"><a id="__codelineno-77-122" name="__codelineno-77-122" href="#__codelineno-77-122"></a><span class="p">}</span>
</span><span id="__span-77-123"><a id="__codelineno-77-123" name="__codelineno-77-123" href="#__codelineno-77-123"></a><span class="c1">//crash的app则直接跳过</span>
</span><span id="__span-77-124"><a id="__codelineno-77-124" name="__codelineno-77-124" href="#__codelineno-77-124"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">curApp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">curApp</span><span class="p">.</span><span class="na">mErrorState</span><span class="p">.</span><span class="na">isCrashing</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-125"><a id="__codelineno-77-125" name="__codelineno-77-125" href="#__codelineno-77-125"></a><span class="w">    </span><span class="c1">// If the target process is crashing, just skip it.</span>
</span><span id="__span-77-126"><a id="__codelineno-77-126" name="__codelineno-77-126" href="#__codelineno-77-126"></a><span class="w">    </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Skipping deliver ordered [&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;] &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span>
</span><span id="__span-77-127"><a id="__codelineno-77-127" name="__codelineno-77-127" href="#__codelineno-77-127"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; to &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">curApp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;: process crashing&quot;</span><span class="p">);</span>
</span><span id="__span-77-128"><a id="__codelineno-77-128" name="__codelineno-77-128" href="#__codelineno-77-128"></a><span class="w">    </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-77-129"><a id="__codelineno-77-129" name="__codelineno-77-129" href="#__codelineno-77-129"></a><span class="p">}</span>
</span><span id="__span-77-130"><a id="__codelineno-77-130" name="__codelineno-77-130" href="#__codelineno-77-130"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">skip</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-131"><a id="__codelineno-77-131" name="__codelineno-77-131" href="#__codelineno-77-131"></a><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isAvailable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-77-132"><a id="__codelineno-77-132" name="__codelineno-77-132" href="#__codelineno-77-132"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-133"><a id="__codelineno-77-133" name="__codelineno-77-133" href="#__codelineno-77-133"></a><span class="w">        </span><span class="n">isAvailable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AppGlobals</span><span class="p">.</span><span class="na">getPackageManager</span><span class="p">().</span><span class="na">isPackageAvailable</span><span class="p">(</span>
</span><span id="__span-77-134"><a id="__codelineno-77-134" name="__codelineno-77-134" href="#__codelineno-77-134"></a><span class="w">                </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">packageName</span><span class="p">,</span>
</span><span id="__span-77-135"><a id="__codelineno-77-135" name="__codelineno-77-135" href="#__codelineno-77-135"></a><span class="w">                </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">));</span>
</span><span id="__span-77-136"><a id="__codelineno-77-136" name="__codelineno-77-136" href="#__codelineno-77-136"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-137"><a id="__codelineno-77-137" name="__codelineno-77-137" href="#__codelineno-77-137"></a><span class="w">        </span><span class="c1">// all such failures mean we skip this receiver</span>
</span><span id="__span-77-138"><a id="__codelineno-77-138" name="__codelineno-77-138" href="#__codelineno-77-138"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Exception getting recipient info for &quot;</span>
</span><span id="__span-77-139"><a id="__codelineno-77-139" name="__codelineno-77-139" href="#__codelineno-77-139"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">packageName</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
</span><span id="__span-77-140"><a id="__codelineno-77-140" name="__codelineno-77-140" href="#__codelineno-77-140"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-77-141"><a id="__codelineno-77-141" name="__codelineno-77-141" href="#__codelineno-77-141"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isAvailable</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-142"><a id="__codelineno-77-142" name="__codelineno-77-142" href="#__codelineno-77-142"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span>
</span><span id="__span-77-143"><a id="__codelineno-77-143" name="__codelineno-77-143" href="#__codelineno-77-143"></a><span class="w">                </span><span class="s">&quot;Skipping delivery to &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">packageName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; / &quot;</span>
</span><span id="__span-77-144"><a id="__codelineno-77-144" name="__codelineno-77-144" href="#__codelineno-77-144"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span>
</span><span id="__span-77-145"><a id="__codelineno-77-145" name="__codelineno-77-145" href="#__codelineno-77-145"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; : package no longer available&quot;</span><span class="p">);</span>
</span><span id="__span-77-146"><a id="__codelineno-77-146" name="__codelineno-77-146" href="#__codelineno-77-146"></a><span class="w">        </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-77-147"><a id="__codelineno-77-147" name="__codelineno-77-147" href="#__codelineno-77-147"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-77-148"><a id="__codelineno-77-148" name="__codelineno-77-148" href="#__codelineno-77-148"></a><span class="p">}</span>
</span><span id="__span-77-149"><a id="__codelineno-77-149" name="__codelineno-77-149" href="#__codelineno-77-149"></a>
</span><span id="__span-77-150"><a id="__codelineno-77-150" name="__codelineno-77-150" href="#__codelineno-77-150"></a><span class="c1">// If permissions need a review before any of the app components can run, we drop</span>
</span><span id="__span-77-151"><a id="__codelineno-77-151" name="__codelineno-77-151" href="#__codelineno-77-151"></a><span class="c1">// the broadcast and if the calling app is in the foreground and the broadcast is</span>
</span><span id="__span-77-152"><a id="__codelineno-77-152" name="__codelineno-77-152" href="#__codelineno-77-152"></a><span class="c1">// explicit we launch the review UI passing it a pending intent to send the skipped</span>
</span><span id="__span-77-153"><a id="__codelineno-77-153" name="__codelineno-77-153" href="#__codelineno-77-153"></a><span class="c1">// broadcast.</span>
</span><span id="__span-77-154"><a id="__codelineno-77-154" name="__codelineno-77-154" href="#__codelineno-77-154"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">skip</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-155"><a id="__codelineno-77-155" name="__codelineno-77-155" href="#__codelineno-77-155"></a><span class="w">    </span><span class="c1">//判断是否需要权限来启动，如果需要则跳过(如果调用者是前台，而且发送到特定组件，则启动权限申请的ui界面)</span>
</span><span id="__span-77-156"><a id="__codelineno-77-156" name="__codelineno-77-156" href="#__codelineno-77-156"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">requestStartTargetPermissionsReviewIfNeededLocked</span><span class="p">(</span><span class="n">r</span><span class="p">,</span>
</span><span id="__span-77-157"><a id="__codelineno-77-157" name="__codelineno-77-157" href="#__codelineno-77-157"></a><span class="w">            </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">packageName</span><span class="p">,</span><span class="w"> </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(</span>
</span><span id="__span-77-158"><a id="__codelineno-77-158" name="__codelineno-77-158" href="#__codelineno-77-158"></a><span class="w">                    </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-159"><a id="__codelineno-77-159" name="__codelineno-77-159" href="#__codelineno-77-159"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span>
</span><span id="__span-77-160"><a id="__codelineno-77-160" name="__codelineno-77-160" href="#__codelineno-77-160"></a><span class="w">                </span><span class="s">&quot;Skipping delivery: permission review required for &quot;</span>
</span><span id="__span-77-161"><a id="__codelineno-77-161" name="__codelineno-77-161" href="#__codelineno-77-161"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">broadcastDescription</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">));</span>
</span><span id="__span-77-162"><a id="__codelineno-77-162" name="__codelineno-77-162" href="#__codelineno-77-162"></a><span class="w">        </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-77-163"><a id="__codelineno-77-163" name="__codelineno-77-163" href="#__codelineno-77-163"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-77-164"><a id="__codelineno-77-164" name="__codelineno-77-164" href="#__codelineno-77-164"></a><span class="p">}</span>
</span><span id="__span-77-165"><a id="__codelineno-77-165" name="__codelineno-77-165" href="#__codelineno-77-165"></a>
</span><span id="__span-77-166"><a id="__codelineno-77-166" name="__codelineno-77-166" href="#__codelineno-77-166"></a><span class="c1">// This is safe to do even if we are skipping the broadcast, and we need</span>
</span><span id="__span-77-167"><a id="__codelineno-77-167" name="__codelineno-77-167" href="#__codelineno-77-167"></a><span class="c1">// this information now to evaluate whether it is going to be allowed to run.</span>
</span><span id="__span-77-168"><a id="__codelineno-77-168" name="__codelineno-77-168" href="#__codelineno-77-168"></a><span class="c1">//接收者的uid</span>
</span><span id="__span-77-169"><a id="__codelineno-77-169" name="__codelineno-77-169" href="#__codelineno-77-169"></a><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">receiverUid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">;</span>
</span><span id="__span-77-170"><a id="__codelineno-77-170" name="__codelineno-77-170" href="#__codelineno-77-170"></a><span class="c1">// If it&#39;s a singleton, it needs to be the same app or a special app</span>
</span><span id="__span-77-171"><a id="__codelineno-77-171" name="__codelineno-77-171" href="#__codelineno-77-171"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">Process</span><span class="p">.</span><span class="na">SYSTEM_UID</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">isSingleton</span>
</span><span id="__span-77-172"><a id="__codelineno-77-172" name="__codelineno-77-172" href="#__codelineno-77-172"></a><span class="w">        </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mService</span><span class="p">.</span><span class="na">isValidSingletonCall</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="p">,</span><span class="w"> </span><span class="n">receiverUid</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-173"><a id="__codelineno-77-173" name="__codelineno-77-173" href="#__codelineno-77-173"></a><span class="w">    </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mService</span><span class="p">.</span><span class="na">getActivityInfoForUser</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-77-174"><a id="__codelineno-77-174" name="__codelineno-77-174" href="#__codelineno-77-174"></a><span class="p">}</span>
</span><span id="__span-77-175"><a id="__codelineno-77-175" name="__codelineno-77-175" href="#__codelineno-77-175"></a><span class="c1">//接受者的进程名字</span>
</span><span id="__span-77-176"><a id="__codelineno-77-176" name="__codelineno-77-176" href="#__codelineno-77-176"></a><span class="n">String</span><span class="w"> </span><span class="n">targetProcess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">processName</span><span class="p">;</span>
</span><span id="__span-77-177"><a id="__codelineno-77-177" name="__codelineno-77-177" href="#__codelineno-77-177"></a><span class="c1">//接受者的进程ProcessRecord app，这个可能为null，也就是进程未启动</span>
</span><span id="__span-77-178"><a id="__codelineno-77-178" name="__codelineno-77-178" href="#__codelineno-77-178"></a><span class="n">ProcessRecord</span><span class="w"> </span><span class="n">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mService</span><span class="p">.</span><span class="na">getProcessRecordLocked</span><span class="p">(</span><span class="n">targetProcess</span><span class="p">,</span>
</span><span id="__span-77-179"><a id="__codelineno-77-179" name="__codelineno-77-179" href="#__codelineno-77-179"></a><span class="w">        </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">);</span>
</span><span id="__span-77-180"><a id="__codelineno-77-180" name="__codelineno-77-180" href="#__codelineno-77-180"></a>
</span><span id="__span-77-181"><a id="__codelineno-77-181" name="__codelineno-77-181" href="#__codelineno-77-181"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">skip</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-182"><a id="__codelineno-77-182" name="__codelineno-77-182" href="#__codelineno-77-182"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">allowed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mService</span><span class="p">.</span><span class="na">getAppStartModeLOSP</span><span class="p">(</span>
</span><span id="__span-77-183"><a id="__codelineno-77-183" name="__codelineno-77-183" href="#__codelineno-77-183"></a><span class="w">            </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">packageName</span><span class="p">,</span>
</span><span id="__span-77-184"><a id="__codelineno-77-184" name="__codelineno-77-184" href="#__codelineno-77-184"></a><span class="w">            </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">targetSdkVersion</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
</span><span id="__span-77-185"><a id="__codelineno-77-185" name="__codelineno-77-185" href="#__codelineno-77-185"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">allowed</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">APP_START_MODE_NORMAL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-186"><a id="__codelineno-77-186" name="__codelineno-77-186" href="#__codelineno-77-186"></a><span class="w">        </span><span class="c1">// We won&#39;t allow this receiver to be launched if the app has been</span>
</span><span id="__span-77-187"><a id="__codelineno-77-187" name="__codelineno-77-187" href="#__codelineno-77-187"></a><span class="w">        </span><span class="c1">// completely disabled from launches, or it was not explicitly sent</span>
</span><span id="__span-77-188"><a id="__codelineno-77-188" name="__codelineno-77-188" href="#__codelineno-77-188"></a><span class="w">        </span><span class="c1">// to it and the app is in a state that should not receive it</span>
</span><span id="__span-77-189"><a id="__codelineno-77-189" name="__codelineno-77-189" href="#__codelineno-77-189"></a><span class="w">        </span><span class="c1">// (depending on how getAppStartModeLOSP has determined that).</span>
</span><span id="__span-77-190"><a id="__codelineno-77-190" name="__codelineno-77-190" href="#__codelineno-77-190"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">allowed</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">APP_START_MODE_DISABLED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-191"><a id="__codelineno-77-191" name="__codelineno-77-191" href="#__codelineno-77-191"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Background execution disabled: receiving &quot;</span>
</span><span id="__span-77-192"><a id="__codelineno-77-192" name="__codelineno-77-192" href="#__codelineno-77-192"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; to &quot;</span>
</span><span id="__span-77-193"><a id="__codelineno-77-193" name="__codelineno-77-193" href="#__codelineno-77-193"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">component</span><span class="p">.</span><span class="na">flattenToShortString</span><span class="p">());</span>
</span><span id="__span-77-194"><a id="__codelineno-77-194" name="__codelineno-77-194" href="#__codelineno-77-194"></a><span class="w">            </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-77-195"><a id="__codelineno-77-195" name="__codelineno-77-195" href="#__codelineno-77-195"></a><span class="w">        </span><span class="c1">//1. 如果flag设置了FLAG_RECEIVER_EXCLUDE_BACKGROUND则无法让后台接收</span>
</span><span id="__span-77-196"><a id="__codelineno-77-196" name="__codelineno-77-196" href="#__codelineno-77-196"></a><span class="w">        </span><span class="c1">//2. 或者getComponent/getPackage都为null，而且没有设置FLAG_RECEIVER_INCLUDE_BACKGROUND，而且没有requiredPermissions</span>
</span><span id="__span-77-197"><a id="__codelineno-77-197" name="__codelineno-77-197" href="#__codelineno-77-197"></a><span class="w">        </span><span class="c1">//3. 如ACTION_BOOT_COMPLETED是有设置FLAG_RECEIVER_INCLUDE_BACKGROUND，所以静态广播无需权限就可以直接接收</span>
</span><span id="__span-77-198"><a id="__codelineno-77-198" name="__codelineno-77-198" href="#__codelineno-77-198"></a>
</span><span id="__span-77-199"><a id="__codelineno-77-199" name="__codelineno-77-199" href="#__codelineno-77-199"></a><span class="w">        </span><span class="c1">//这段代码是在AMS.broadcastIntentLocked</span>
</span><span id="__span-77-200"><a id="__codelineno-77-200" name="__codelineno-77-200" href="#__codelineno-77-200"></a><span class="w">        </span><span class="c1">//if (getBackgroundLaunchBroadcasts().contains(action)) {</span>
</span><span id="__span-77-201"><a id="__codelineno-77-201" name="__codelineno-77-201" href="#__codelineno-77-201"></a><span class="w">        </span><span class="c1">//      if (DEBUG_BACKGROUND_CHECK) {</span>
</span><span id="__span-77-202"><a id="__codelineno-77-202" name="__codelineno-77-202" href="#__codelineno-77-202"></a><span class="w">        </span><span class="c1">//          Slog.i(TAG, &quot;Broadcast action &quot; + action + &quot; forcing include-background&quot;);</span>
</span><span id="__span-77-203"><a id="__codelineno-77-203" name="__codelineno-77-203" href="#__codelineno-77-203"></a><span class="w">        </span><span class="c1">//      }</span>
</span><span id="__span-77-204"><a id="__codelineno-77-204" name="__codelineno-77-204" href="#__codelineno-77-204"></a><span class="w">        </span><span class="c1">//      intent.addFlags(Intent.FLAG_RECEIVER_INCLUDE_BACKGROUND);</span>
</span><span id="__span-77-205"><a id="__codelineno-77-205" name="__codelineno-77-205" href="#__codelineno-77-205"></a><span class="w">        </span><span class="c1">//}</span>
</span><span id="__span-77-206"><a id="__codelineno-77-206" name="__codelineno-77-206" href="#__codelineno-77-206"></a>
</span><span id="__span-77-207"><a id="__codelineno-77-207" name="__codelineno-77-207" href="#__codelineno-77-207"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(((</span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getFlags</span><span class="p">()</span><span class="o">&amp;</span><span class="n">Intent</span><span class="p">.</span><span class="na">FLAG_RECEIVER_EXCLUDE_BACKGROUND</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-77-208"><a id="__codelineno-77-208" name="__codelineno-77-208" href="#__codelineno-77-208"></a><span class="w">                </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getComponent</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span>
</span><span id="__span-77-209"><a id="__codelineno-77-209" name="__codelineno-77-209" href="#__codelineno-77-209"></a><span class="w">                    </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getPackage</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span>
</span><span id="__span-77-210"><a id="__codelineno-77-210" name="__codelineno-77-210" href="#__codelineno-77-210"></a><span class="w">                    </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">((</span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getFlags</span><span class="p">()</span>
</span><span id="__span-77-211"><a id="__codelineno-77-211" name="__codelineno-77-211" href="#__codelineno-77-211"></a><span class="w">                            </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">FLAG_RECEIVER_INCLUDE_BACKGROUND</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-77-212"><a id="__codelineno-77-212" name="__codelineno-77-212" href="#__codelineno-77-212"></a><span class="w">                    </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">isSignaturePerm</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">requiredPermissions</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-213"><a id="__codelineno-77-213" name="__codelineno-77-213" href="#__codelineno-77-213"></a><span class="w">            </span><span class="n">mService</span><span class="p">.</span><span class="na">addBackgroundCheckViolationLocked</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">(),</span>
</span><span id="__span-77-214"><a id="__codelineno-77-214" name="__codelineno-77-214" href="#__codelineno-77-214"></a><span class="w">                    </span><span class="n">component</span><span class="p">.</span><span class="na">getPackageName</span><span class="p">());</span>
</span><span id="__span-77-215"><a id="__codelineno-77-215" name="__codelineno-77-215" href="#__codelineno-77-215"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Background execution not allowed: receiving &quot;</span>
</span><span id="__span-77-216"><a id="__codelineno-77-216" name="__codelineno-77-216" href="#__codelineno-77-216"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; to &quot;</span>
</span><span id="__span-77-217"><a id="__codelineno-77-217" name="__codelineno-77-217" href="#__codelineno-77-217"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">component</span><span class="p">.</span><span class="na">flattenToShortString</span><span class="p">());</span>
</span><span id="__span-77-218"><a id="__codelineno-77-218" name="__codelineno-77-218" href="#__codelineno-77-218"></a><span class="w">            </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-77-219"><a id="__codelineno-77-219" name="__codelineno-77-219" href="#__codelineno-77-219"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-77-220"><a id="__codelineno-77-220" name="__codelineno-77-220" href="#__codelineno-77-220"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-77-221"><a id="__codelineno-77-221" name="__codelineno-77-221" href="#__codelineno-77-221"></a><span class="p">}</span>
</span><span id="__span-77-222"><a id="__codelineno-77-222" name="__codelineno-77-222" href="#__codelineno-77-222"></a>
</span><span id="__span-77-223"><a id="__codelineno-77-223" name="__codelineno-77-223" href="#__codelineno-77-223"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">skip</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">Intent</span><span class="p">.</span><span class="na">ACTION_SHUTDOWN</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">())</span>
</span><span id="__span-77-224"><a id="__codelineno-77-224" name="__codelineno-77-224" href="#__codelineno-77-224"></a><span class="w">        </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">mService</span><span class="p">.</span><span class="na">mUserController</span>
</span><span id="__span-77-225"><a id="__codelineno-77-225" name="__codelineno-77-225" href="#__codelineno-77-225"></a><span class="w">        </span><span class="p">.</span><span class="na">isUserRunning</span><span class="p">(</span><span class="n">UserHandle</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">),</span>
</span><span id="__span-77-226"><a id="__codelineno-77-226" name="__codelineno-77-226" href="#__codelineno-77-226"></a><span class="w">                </span><span class="mi">0</span><span class="w"> </span><span class="cm">/* flags */</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-227"><a id="__codelineno-77-227" name="__codelineno-77-227" href="#__codelineno-77-227"></a><span class="w">    </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-77-228"><a id="__codelineno-77-228" name="__codelineno-77-228" href="#__codelineno-77-228"></a><span class="w">    </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span>
</span><span id="__span-77-229"><a id="__codelineno-77-229" name="__codelineno-77-229" href="#__codelineno-77-229"></a><span class="w">            </span><span class="s">&quot;Skipping delivery to &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">packageName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; / &quot;</span>
</span><span id="__span-77-230"><a id="__codelineno-77-230" name="__codelineno-77-230" href="#__codelineno-77-230"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; : user is not running&quot;</span><span class="p">);</span>
</span><span id="__span-77-231"><a id="__codelineno-77-231" name="__codelineno-77-231" href="#__codelineno-77-231"></a><span class="p">}</span>
</span><span id="__span-77-232"><a id="__codelineno-77-232" name="__codelineno-77-232" href="#__codelineno-77-232"></a>
</span><span id="__span-77-233"><a id="__codelineno-77-233" name="__codelineno-77-233" href="#__codelineno-77-233"></a><span class="c1">//处理不包含的权限excludedPermissions</span>
</span><span id="__span-77-234"><a id="__codelineno-77-234" name="__codelineno-77-234" href="#__codelineno-77-234"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">skip</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">excludedPermissions</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">excludedPermissions</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-235"><a id="__codelineno-77-235" name="__codelineno-77-235" href="#__codelineno-77-235"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">excludedPermissions</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-236"><a id="__codelineno-77-236" name="__codelineno-77-236" href="#__codelineno-77-236"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">excludedPermission</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">excludedPermissions</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">;</span>
</span><span id="__span-77-237"><a id="__codelineno-77-237" name="__codelineno-77-237" href="#__codelineno-77-237"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-238"><a id="__codelineno-77-238" name="__codelineno-77-238" href="#__codelineno-77-238"></a><span class="w">            </span><span class="n">perm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AppGlobals</span><span class="p">.</span><span class="na">getPackageManager</span><span class="p">()</span>
</span><span id="__span-77-239"><a id="__codelineno-77-239" name="__codelineno-77-239" href="#__codelineno-77-239"></a><span class="w">                </span><span class="p">.</span><span class="na">checkPermission</span><span class="p">(</span><span class="n">excludedPermission</span><span class="p">,</span>
</span><span id="__span-77-240"><a id="__codelineno-77-240" name="__codelineno-77-240" href="#__codelineno-77-240"></a><span class="w">                        </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">packageName</span><span class="p">,</span>
</span><span id="__span-77-241"><a id="__codelineno-77-241" name="__codelineno-77-241" href="#__codelineno-77-241"></a><span class="w">                        </span><span class="n">UserHandle</span>
</span><span id="__span-77-242"><a id="__codelineno-77-242" name="__codelineno-77-242" href="#__codelineno-77-242"></a><span class="w">                        </span><span class="p">.</span><span class="na">getUserId</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">));</span>
</span><span id="__span-77-243"><a id="__codelineno-77-243" name="__codelineno-77-243" href="#__codelineno-77-243"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-244"><a id="__codelineno-77-244" name="__codelineno-77-244" href="#__codelineno-77-244"></a><span class="w">            </span><span class="n">perm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="na">PERMISSION_DENIED</span><span class="p">;</span>
</span><span id="__span-77-245"><a id="__codelineno-77-245" name="__codelineno-77-245" href="#__codelineno-77-245"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-77-246"><a id="__codelineno-77-246" name="__codelineno-77-246" href="#__codelineno-77-246"></a>
</span><span id="__span-77-247"><a id="__codelineno-77-247" name="__codelineno-77-247" href="#__codelineno-77-247"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">appOp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">permissionToOpCode</span><span class="p">(</span><span class="n">excludedPermission</span><span class="p">);</span>
</span><span id="__span-77-248"><a id="__codelineno-77-248" name="__codelineno-77-248" href="#__codelineno-77-248"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">appOp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">OP_NONE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-249"><a id="__codelineno-77-249" name="__codelineno-77-249" href="#__codelineno-77-249"></a><span class="w">            </span><span class="c1">// When there is an app op associated with the permission,</span>
</span><span id="__span-77-250"><a id="__codelineno-77-250" name="__codelineno-77-250" href="#__codelineno-77-250"></a><span class="w">            </span><span class="c1">// skip when both the permission and the app op are</span>
</span><span id="__span-77-251"><a id="__codelineno-77-251" name="__codelineno-77-251" href="#__codelineno-77-251"></a><span class="w">            </span><span class="c1">// granted.</span>
</span><span id="__span-77-252"><a id="__codelineno-77-252" name="__codelineno-77-252" href="#__codelineno-77-252"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">perm</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="na">PERMISSION_GRANTED</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-77-253"><a id="__codelineno-77-253" name="__codelineno-77-253" href="#__codelineno-77-253"></a><span class="w">                        </span><span class="n">mService</span><span class="p">.</span><span class="na">getAppOpsManager</span><span class="p">().</span><span class="na">checkOpNoThrow</span><span class="p">(</span><span class="n">appOp</span><span class="p">,</span>
</span><span id="__span-77-254"><a id="__codelineno-77-254" name="__codelineno-77-254" href="#__codelineno-77-254"></a><span class="w">                        </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">,</span>
</span><span id="__span-77-255"><a id="__codelineno-77-255" name="__codelineno-77-255" href="#__codelineno-77-255"></a><span class="w">                        </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">packageName</span><span class="p">)</span>
</span><span id="__span-77-256"><a id="__codelineno-77-256" name="__codelineno-77-256" href="#__codelineno-77-256"></a><span class="w">                    </span><span class="o">==</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">MODE_ALLOWED</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-257"><a id="__codelineno-77-257" name="__codelineno-77-257" href="#__codelineno-77-257"></a><span class="w">                </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-77-258"><a id="__codelineno-77-258" name="__codelineno-77-258" href="#__codelineno-77-258"></a><span class="w">                </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-77-259"><a id="__codelineno-77-259" name="__codelineno-77-259" href="#__codelineno-77-259"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-77-260"><a id="__codelineno-77-260" name="__codelineno-77-260" href="#__codelineno-77-260"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-261"><a id="__codelineno-77-261" name="__codelineno-77-261" href="#__codelineno-77-261"></a><span class="w">            </span><span class="c1">// When there is no app op associated with the permission,</span>
</span><span id="__span-77-262"><a id="__codelineno-77-262" name="__codelineno-77-262" href="#__codelineno-77-262"></a><span class="w">            </span><span class="c1">// skip when permission is granted.</span>
</span><span id="__span-77-263"><a id="__codelineno-77-263" name="__codelineno-77-263" href="#__codelineno-77-263"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">perm</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="na">PERMISSION_GRANTED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-264"><a id="__codelineno-77-264" name="__codelineno-77-264" href="#__codelineno-77-264"></a><span class="w">                </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-77-265"><a id="__codelineno-77-265" name="__codelineno-77-265" href="#__codelineno-77-265"></a><span class="w">                </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-77-266"><a id="__codelineno-77-266" name="__codelineno-77-266" href="#__codelineno-77-266"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-77-267"><a id="__codelineno-77-267" name="__codelineno-77-267" href="#__codelineno-77-267"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-77-268"><a id="__codelineno-77-268" name="__codelineno-77-268" href="#__codelineno-77-268"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-77-269"><a id="__codelineno-77-269" name="__codelineno-77-269" href="#__codelineno-77-269"></a><span class="p">}</span>
</span><span id="__span-77-270"><a id="__codelineno-77-270" name="__codelineno-77-270" href="#__codelineno-77-270"></a>
</span><span id="__span-77-271"><a id="__codelineno-77-271" name="__codelineno-77-271" href="#__codelineno-77-271"></a><span class="c1">// Check that the receiver does *not* belong to any of the excluded packages</span>
</span><span id="__span-77-272"><a id="__codelineno-77-272" name="__codelineno-77-272" href="#__codelineno-77-272"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">skip</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">excludedPackages</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">excludedPackages</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-273"><a id="__codelineno-77-273" name="__codelineno-77-273" href="#__codelineno-77-273"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ArrayUtils</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">excludedPackages</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">.</span><span class="na">getPackageName</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-274"><a id="__codelineno-77-274" name="__codelineno-77-274" href="#__codelineno-77-274"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Skipping delivery of excluded package &quot;</span>
</span><span id="__span-77-275"><a id="__codelineno-77-275" name="__codelineno-77-275" href="#__codelineno-77-275"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; to &quot;</span>
</span><span id="__span-77-276"><a id="__codelineno-77-276" name="__codelineno-77-276" href="#__codelineno-77-276"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">component</span><span class="p">.</span><span class="na">flattenToShortString</span><span class="p">()</span>
</span><span id="__span-77-277"><a id="__codelineno-77-277" name="__codelineno-77-277" href="#__codelineno-77-277"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; excludes package &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">component</span><span class="p">.</span><span class="na">getPackageName</span><span class="p">()</span>
</span><span id="__span-77-278"><a id="__codelineno-77-278" name="__codelineno-77-278" href="#__codelineno-77-278"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; due to sender &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callerPackage</span>
</span><span id="__span-77-279"><a id="__codelineno-77-279" name="__codelineno-77-279" href="#__codelineno-77-279"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; (uid &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="p">);</span>
</span><span id="__span-77-280"><a id="__codelineno-77-280" name="__codelineno-77-280" href="#__codelineno-77-280"></a><span class="w">        </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-77-281"><a id="__codelineno-77-281" name="__codelineno-77-281" href="#__codelineno-77-281"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-77-282"><a id="__codelineno-77-282" name="__codelineno-77-282" href="#__codelineno-77-282"></a><span class="p">}</span>
</span><span id="__span-77-283"><a id="__codelineno-77-283" name="__codelineno-77-283" href="#__codelineno-77-283"></a>
</span><span id="__span-77-284"><a id="__codelineno-77-284" name="__codelineno-77-284" href="#__codelineno-77-284"></a><span class="c1">//处理需要包含的权限requiredPermission</span>
</span><span id="__span-77-285"><a id="__codelineno-77-285" name="__codelineno-77-285" href="#__codelineno-77-285"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">skip</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">Process</span><span class="p">.</span><span class="na">SYSTEM_UID</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-77-286"><a id="__codelineno-77-286" name="__codelineno-77-286" href="#__codelineno-77-286"></a><span class="w">        </span><span class="n">r</span><span class="p">.</span><span class="na">requiredPermissions</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">requiredPermissions</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-287"><a id="__codelineno-77-287" name="__codelineno-77-287" href="#__codelineno-77-287"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">requiredPermissions</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-288"><a id="__codelineno-77-288" name="__codelineno-77-288" href="#__codelineno-77-288"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">requiredPermission</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">requiredPermissions</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">;</span>
</span><span id="__span-77-289"><a id="__codelineno-77-289" name="__codelineno-77-289" href="#__codelineno-77-289"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-290"><a id="__codelineno-77-290" name="__codelineno-77-290" href="#__codelineno-77-290"></a><span class="w">            </span><span class="n">perm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AppGlobals</span><span class="p">.</span><span class="na">getPackageManager</span><span class="p">().</span>
</span><span id="__span-77-291"><a id="__codelineno-77-291" name="__codelineno-77-291" href="#__codelineno-77-291"></a><span class="w">                    </span><span class="n">checkPermission</span><span class="p">(</span><span class="n">requiredPermission</span><span class="p">,</span>
</span><span id="__span-77-292"><a id="__codelineno-77-292" name="__codelineno-77-292" href="#__codelineno-77-292"></a><span class="w">                            </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">packageName</span><span class="p">,</span>
</span><span id="__span-77-293"><a id="__codelineno-77-293" name="__codelineno-77-293" href="#__codelineno-77-293"></a><span class="w">                            </span><span class="n">UserHandle</span>
</span><span id="__span-77-294"><a id="__codelineno-77-294" name="__codelineno-77-294" href="#__codelineno-77-294"></a><span class="w">                            </span><span class="p">.</span><span class="na">getUserId</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">));</span>
</span><span id="__span-77-295"><a id="__codelineno-77-295" name="__codelineno-77-295" href="#__codelineno-77-295"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-296"><a id="__codelineno-77-296" name="__codelineno-77-296" href="#__codelineno-77-296"></a><span class="w">            </span><span class="n">perm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="na">PERMISSION_DENIED</span><span class="p">;</span>
</span><span id="__span-77-297"><a id="__codelineno-77-297" name="__codelineno-77-297" href="#__codelineno-77-297"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-77-298"><a id="__codelineno-77-298" name="__codelineno-77-298" href="#__codelineno-77-298"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">perm</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="na">PERMISSION_GRANTED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-299"><a id="__codelineno-77-299" name="__codelineno-77-299" href="#__codelineno-77-299"></a><span class="w">            </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Permission Denial: receiving &quot;</span>
</span><span id="__span-77-300"><a id="__codelineno-77-300" name="__codelineno-77-300" href="#__codelineno-77-300"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; to &quot;</span>
</span><span id="__span-77-301"><a id="__codelineno-77-301" name="__codelineno-77-301" href="#__codelineno-77-301"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">component</span><span class="p">.</span><span class="na">flattenToShortString</span><span class="p">()</span>
</span><span id="__span-77-302"><a id="__codelineno-77-302" name="__codelineno-77-302" href="#__codelineno-77-302"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; requires &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">requiredPermission</span>
</span><span id="__span-77-303"><a id="__codelineno-77-303" name="__codelineno-77-303" href="#__codelineno-77-303"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; due to sender &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callerPackage</span>
</span><span id="__span-77-304"><a id="__codelineno-77-304" name="__codelineno-77-304" href="#__codelineno-77-304"></a><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; (uid &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="p">);</span>
</span><span id="__span-77-305"><a id="__codelineno-77-305" name="__codelineno-77-305" href="#__codelineno-77-305"></a><span class="w">            </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-77-306"><a id="__codelineno-77-306" name="__codelineno-77-306" href="#__codelineno-77-306"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-77-307"><a id="__codelineno-77-307" name="__codelineno-77-307" href="#__codelineno-77-307"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-77-308"><a id="__codelineno-77-308" name="__codelineno-77-308" href="#__codelineno-77-308"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">appOp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">permissionToOpCode</span><span class="p">(</span><span class="n">requiredPermission</span><span class="p">);</span>
</span><span id="__span-77-309"><a id="__codelineno-77-309" name="__codelineno-77-309" href="#__codelineno-77-309"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">appOp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">OP_NONE</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">appOp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">appOp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-310"><a id="__codelineno-77-310" name="__codelineno-77-310" href="#__codelineno-77-310"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">noteOpForManifestReceiver</span><span class="p">(</span><span class="n">appOp</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-311"><a id="__codelineno-77-311" name="__codelineno-77-311" href="#__codelineno-77-311"></a><span class="w">                </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-77-312"><a id="__codelineno-77-312" name="__codelineno-77-312" href="#__codelineno-77-312"></a><span class="w">                </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-77-313"><a id="__codelineno-77-313" name="__codelineno-77-313" href="#__codelineno-77-313"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-77-314"><a id="__codelineno-77-314" name="__codelineno-77-314" href="#__codelineno-77-314"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-77-315"><a id="__codelineno-77-315" name="__codelineno-77-315" href="#__codelineno-77-315"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-77-316"><a id="__codelineno-77-316" name="__codelineno-77-316" href="#__codelineno-77-316"></a><span class="p">}</span>
</span><span id="__span-77-317"><a id="__codelineno-77-317" name="__codelineno-77-317" href="#__codelineno-77-317"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">skip</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">appOp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">AppOpsManager</span><span class="p">.</span><span class="na">OP_NONE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-318"><a id="__codelineno-77-318" name="__codelineno-77-318" href="#__codelineno-77-318"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">noteOpForManifestReceiver</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">appOp</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">component</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-319"><a id="__codelineno-77-319" name="__codelineno-77-319" href="#__codelineno-77-319"></a><span class="w">        </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-77-320"><a id="__codelineno-77-320" name="__codelineno-77-320" href="#__codelineno-77-320"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-77-321"><a id="__codelineno-77-321" name="__codelineno-77-321" href="#__codelineno-77-321"></a><span class="p">}</span>
</span><span id="__span-77-322"><a id="__codelineno-77-322" name="__codelineno-77-322" href="#__codelineno-77-322"></a>
</span><span id="__span-77-323"><a id="__codelineno-77-323" name="__codelineno-77-323" href="#__codelineno-77-323"></a><span class="c1">//上面都是各类判断是否需要跳过的逻辑skip</span>
</span><span id="__span-77-324"><a id="__codelineno-77-324" name="__codelineno-77-324" href="#__codelineno-77-324"></a><span class="c1">//如果跳过，直接恢复初始状态，开始下一个广播接收者的处理</span>
</span><span id="__span-77-325"><a id="__codelineno-77-325" name="__codelineno-77-325" href="#__codelineno-77-325"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">skip</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-326"><a id="__codelineno-77-326" name="__codelineno-77-326" href="#__codelineno-77-326"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w">  </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span>
</span><span id="__span-77-327"><a id="__codelineno-77-327" name="__codelineno-77-327" href="#__codelineno-77-327"></a><span class="w">            </span><span class="s">&quot;Skipping delivery of ordered [&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;] &quot;</span>
</span><span id="__span-77-328"><a id="__codelineno-77-328" name="__codelineno-77-328" href="#__codelineno-77-328"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; for reason described above&quot;</span><span class="p">);</span>
</span><span id="__span-77-329"><a id="__codelineno-77-329" name="__codelineno-77-329" href="#__codelineno-77-329"></a><span class="w">    </span><span class="c1">//如果需要跳过，标定当前r.delivery[recIdx]为skipped</span>
</span><span id="__span-77-330"><a id="__codelineno-77-330" name="__codelineno-77-330" href="#__codelineno-77-330"></a><span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="na">delivery</span><span class="o">[</span><span class="n">recIdx</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">.</span><span class="na">DELIVERY_SKIPPED</span><span class="p">;</span>
</span><span id="__span-77-331"><a id="__codelineno-77-331" name="__codelineno-77-331" href="#__codelineno-77-331"></a><span class="w">    </span><span class="c1">//跳过的时候清空r.receiver = null</span>
</span><span id="__span-77-332"><a id="__codelineno-77-332" name="__codelineno-77-332" href="#__codelineno-77-332"></a><span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="na">receiver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-77-333"><a id="__codelineno-77-333" name="__codelineno-77-333" href="#__codelineno-77-333"></a><span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="na">curFilter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-77-334"><a id="__codelineno-77-334" name="__codelineno-77-334" href="#__codelineno-77-334"></a><span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="na">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">.</span><span class="na">IDLE</span><span class="p">;</span>
</span><span id="__span-77-335"><a id="__codelineno-77-335" name="__codelineno-77-335" href="#__codelineno-77-335"></a><span class="w">    </span><span class="c1">//静态广播跳过++</span>
</span><span id="__span-77-336"><a id="__codelineno-77-336" name="__codelineno-77-336" href="#__codelineno-77-336"></a><span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="na">manifestSkipCount</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-77-337"><a id="__codelineno-77-337" name="__codelineno-77-337" href="#__codelineno-77-337"></a><span class="w">    </span><span class="c1">//继续下一个分发</span>
</span><span id="__span-77-338"><a id="__codelineno-77-338" name="__codelineno-77-338" href="#__codelineno-77-338"></a><span class="w">    </span><span class="n">scheduleBroadcastsLocked</span><span class="p">();</span>
</span><span id="__span-77-339"><a id="__codelineno-77-339" name="__codelineno-77-339" href="#__codelineno-77-339"></a><span class="w">    </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-77-340"><a id="__codelineno-77-340" name="__codelineno-77-340" href="#__codelineno-77-340"></a><span class="p">}</span>
</span></code></pre></div>
<p>这里除了有判断sdk、判断权限等细节，还有一个我们经常遇到的问题：“Background execution not allowed: ”，在前面的“广播能否发给background进程”小节讲到了这个细节。</p>
<p>下面开始分析发送给进程已经启动的静态广播接受者。</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-78-1"><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a><span class="c1">//静态广播Count执行++</span>
</span><span id="__span-78-2"><a id="__codelineno-78-2" name="__codelineno-78-2" href="#__codelineno-78-2"></a><span class="n">r</span><span class="p">.</span><span class="na">manifestCount</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-78-3"><a id="__codelineno-78-3" name="__codelineno-78-3" href="#__codelineno-78-3"></a>
</span><span id="__span-78-4"><a id="__codelineno-78-4" name="__codelineno-78-4" href="#__codelineno-78-4"></a><span class="c1">//标定当前r.delivery[recIdx]为分发DELIVERED</span>
</span><span id="__span-78-5"><a id="__codelineno-78-5" name="__codelineno-78-5" href="#__codelineno-78-5"></a><span class="n">r</span><span class="p">.</span><span class="na">delivery</span><span class="o">[</span><span class="n">recIdx</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">.</span><span class="na">DELIVERY_DELIVERED</span><span class="p">;</span>
</span><span id="__span-78-6"><a id="__codelineno-78-6" name="__codelineno-78-6" href="#__codelineno-78-6"></a><span class="c1">//状态修改成app接收APP_RECEIVE，后面该receive finishReceiver返回的时候APP_RECEIVE或BroadcastRecord.CALL_DONE_RECEIVE才会继续处理下一个</span>
</span><span id="__span-78-7"><a id="__codelineno-78-7" name="__codelineno-78-7" href="#__codelineno-78-7"></a><span class="n">r</span><span class="p">.</span><span class="na">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">.</span><span class="na">APP_RECEIVE</span><span class="p">;</span>
</span><span id="__span-78-8"><a id="__codelineno-78-8" name="__codelineno-78-8" href="#__codelineno-78-8"></a><span class="c1">//当前接收组件curComponent</span>
</span><span id="__span-78-9"><a id="__codelineno-78-9" name="__codelineno-78-9" href="#__codelineno-78-9"></a><span class="n">r</span><span class="p">.</span><span class="na">curComponent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">component</span><span class="p">;</span>
</span><span id="__span-78-10"><a id="__codelineno-78-10" name="__codelineno-78-10" href="#__codelineno-78-10"></a><span class="c1">//当前的receiver</span>
</span><span id="__span-78-11"><a id="__codelineno-78-11" name="__codelineno-78-11" href="#__codelineno-78-11"></a><span class="n">r</span><span class="p">.</span><span class="na">curReceiver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">;</span>
</span><span id="__span-78-12"><a id="__codelineno-78-12" name="__codelineno-78-12" href="#__codelineno-78-12"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_MU</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">UserHandle</span><span class="p">.</span><span class="na">PER_USER_RANGE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-78-13"><a id="__codelineno-78-13" name="__codelineno-78-13" href="#__codelineno-78-13"></a><span class="w">    </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_MU</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Updated broadcast record activity info for secondary user, &quot;</span>
</span><span id="__span-78-14"><a id="__codelineno-78-14" name="__codelineno-78-14" href="#__codelineno-78-14"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, callingUid = &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, uid = &quot;</span>
</span><span id="__span-78-15"><a id="__codelineno-78-15" name="__codelineno-78-15" href="#__codelineno-78-15"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">receiverUid</span><span class="p">);</span>
</span><span id="__span-78-16"><a id="__codelineno-78-16" name="__codelineno-78-16" href="#__codelineno-78-16"></a><span class="p">}</span>
</span><span id="__span-78-17"><a id="__codelineno-78-17" name="__codelineno-78-17" href="#__codelineno-78-17"></a><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isActivityCapable</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-78-18"><a id="__codelineno-78-18" name="__codelineno-78-18" href="#__codelineno-78-18"></a><span class="w">        </span><span class="p">(</span><span class="n">brOptions</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">brOptions</span><span class="p">.</span><span class="na">getTemporaryAppAllowlistDuration</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-78-19"><a id="__codelineno-78-19" name="__codelineno-78-19" href="#__codelineno-78-19"></a><span class="n">maybeScheduleTempAllowlistLocked</span><span class="p">(</span><span class="n">receiverUid</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">brOptions</span><span class="p">);</span>
</span><span id="__span-78-20"><a id="__codelineno-78-20" name="__codelineno-78-20" href="#__codelineno-78-20"></a>
</span><span id="__span-78-21"><a id="__codelineno-78-21" name="__codelineno-78-21" href="#__codelineno-78-21"></a><span class="c1">// Report that a component is used for explicit broadcasts.</span>
</span><span id="__span-78-22"><a id="__codelineno-78-22" name="__codelineno-78-22" href="#__codelineno-78-22"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getComponent</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">curComponent</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span>
</span><span id="__span-78-23"><a id="__codelineno-78-23" name="__codelineno-78-23" href="#__codelineno-78-23"></a><span class="w">        </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">TextUtils</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">curComponent</span><span class="p">.</span><span class="na">getPackageName</span><span class="p">(),</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callerPackage</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-78-24"><a id="__codelineno-78-24" name="__codelineno-78-24" href="#__codelineno-78-24"></a><span class="w">    </span><span class="n">mService</span><span class="p">.</span><span class="na">mUsageStatsService</span><span class="p">.</span><span class="na">reportEvent</span><span class="p">(</span>
</span><span id="__span-78-25"><a id="__codelineno-78-25" name="__codelineno-78-25" href="#__codelineno-78-25"></a><span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="na">curComponent</span><span class="p">.</span><span class="na">getPackageName</span><span class="p">(),</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">userId</span><span class="p">,</span><span class="w"> </span><span class="n">Event</span><span class="p">.</span><span class="na">APP_COMPONENT_USED</span><span class="p">);</span>
</span><span id="__span-78-26"><a id="__codelineno-78-26" name="__codelineno-78-26" href="#__codelineno-78-26"></a><span class="p">}</span>
</span><span id="__span-78-27"><a id="__codelineno-78-27" name="__codelineno-78-27" href="#__codelineno-78-27"></a>
</span><span id="__span-78-28"><a id="__codelineno-78-28" name="__codelineno-78-28" href="#__codelineno-78-28"></a><span class="c1">// Broadcast is being executed, its package can&#39;t be stopped.</span>
</span><span id="__span-78-29"><a id="__codelineno-78-29" name="__codelineno-78-29" href="#__codelineno-78-29"></a><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-78-30"><a id="__codelineno-78-30" name="__codelineno-78-30" href="#__codelineno-78-30"></a><span class="w">    </span><span class="c1">//设置包的stop状态是false(需要启动改应用了，包不再是stop了)</span>
</span><span id="__span-78-31"><a id="__codelineno-78-31" name="__codelineno-78-31" href="#__codelineno-78-31"></a><span class="w">    </span><span class="n">AppGlobals</span><span class="p">.</span><span class="na">getPackageManager</span><span class="p">().</span><span class="na">setPackageStoppedState</span><span class="p">(</span>
</span><span id="__span-78-32"><a id="__codelineno-78-32" name="__codelineno-78-32" href="#__codelineno-78-32"></a><span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="na">curComponent</span><span class="p">.</span><span class="na">getPackageName</span><span class="p">(),</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">userId</span><span class="p">);</span>
</span><span id="__span-78-33"><a id="__codelineno-78-33" name="__codelineno-78-33" href="#__codelineno-78-33"></a><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-78-34"><a id="__codelineno-78-34" name="__codelineno-78-34" href="#__codelineno-78-34"></a><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IllegalArgumentException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-78-35"><a id="__codelineno-78-35" name="__codelineno-78-35" href="#__codelineno-78-35"></a><span class="w">    </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Failed trying to unstop package &quot;</span>
</span><span id="__span-78-36"><a id="__codelineno-78-36" name="__codelineno-78-36" href="#__codelineno-78-36"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">curComponent</span><span class="p">.</span><span class="na">getPackageName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
</span><span id="__span-78-37"><a id="__codelineno-78-37" name="__codelineno-78-37" href="#__codelineno-78-37"></a><span class="p">}</span>
</span><span id="__span-78-38"><a id="__codelineno-78-38" name="__codelineno-78-38" href="#__codelineno-78-38"></a>
</span><span id="__span-78-39"><a id="__codelineno-78-39" name="__codelineno-78-39" href="#__codelineno-78-39"></a><span class="c1">// Is this receiver&#39;s application already running?</span>
</span><span id="__span-78-40"><a id="__codelineno-78-40" name="__codelineno-78-40" href="#__codelineno-78-40"></a><span class="c1">//如果当前进程已经运行，则直接发给该进程，然后返回</span>
</span><span id="__span-78-41"><a id="__codelineno-78-41" name="__codelineno-78-41" href="#__codelineno-78-41"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">app</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">app</span><span class="p">.</span><span class="na">getThread</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">app</span><span class="p">.</span><span class="na">isKilled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-78-42"><a id="__codelineno-78-42" name="__codelineno-78-42" href="#__codelineno-78-42"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-78-43"><a id="__codelineno-78-43" name="__codelineno-78-43" href="#__codelineno-78-43"></a><span class="w">        </span><span class="n">app</span><span class="p">.</span><span class="na">addPackage</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">packageName</span><span class="p">,</span>
</span><span id="__span-78-44"><a id="__codelineno-78-44" name="__codelineno-78-44" href="#__codelineno-78-44"></a><span class="w">                </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">longVersionCode</span><span class="p">,</span><span class="w"> </span><span class="n">mService</span><span class="p">.</span><span class="na">mProcessStats</span><span class="p">);</span>
</span><span id="__span-78-45"><a id="__codelineno-78-45" name="__codelineno-78-45" href="#__codelineno-78-45"></a><span class="w">        </span><span class="n">maybeAddAllowBackgroundActivityStartsToken</span><span class="p">(</span><span class="n">app</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-78-46"><a id="__codelineno-78-46" name="__codelineno-78-46" href="#__codelineno-78-46"></a><span class="w">        </span><span class="c1">// app进程存在，通过processCurBroadcastLocked -&gt; ActivityThread.scheduleReceiver -&gt; receiver.onReceive处理当前广播</span>
</span><span id="__span-78-47"><a id="__codelineno-78-47" name="__codelineno-78-47" href="#__codelineno-78-47"></a><span class="w">        </span><span class="n">processCurBroadcastLocked</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">app</span><span class="p">,</span>
</span><span id="__span-78-48"><a id="__codelineno-78-48" name="__codelineno-78-48" href="#__codelineno-78-48"></a><span class="w">                </span><span class="n">BROADCAST_DELIVERY_EVENT_REPORTED__RECEIVER_TYPE__MANIFEST</span><span class="p">,</span>
</span><span id="__span-78-49"><a id="__codelineno-78-49" name="__codelineno-78-49" href="#__codelineno-78-49"></a><span class="w">                </span><span class="n">BROADCAST_DELIVERY_EVENT_REPORTED__PROC_START_TYPE__PROCESS_START_TYPE_WARM</span><span class="p">);</span>
</span><span id="__span-78-50"><a id="__codelineno-78-50" name="__codelineno-78-50" href="#__codelineno-78-50"></a><span class="w">        </span><span class="c1">//order广播是一种同步处理方式，因此处理完可以直接return</span>
</span><span id="__span-78-51"><a id="__codelineno-78-51" name="__codelineno-78-51" href="#__codelineno-78-51"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-78-52"><a id="__codelineno-78-52" name="__codelineno-78-52" href="#__codelineno-78-52"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-78-53"><a id="__codelineno-78-53" name="__codelineno-78-53" href="#__codelineno-78-53"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Exception when sending broadcast to &quot;</span>
</span><span id="__span-78-54"><a id="__codelineno-78-54" name="__codelineno-78-54" href="#__codelineno-78-54"></a><span class="w">              </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">curComponent</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
</span><span id="__span-78-55"><a id="__codelineno-78-55" name="__codelineno-78-55" href="#__codelineno-78-55"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RuntimeException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-78-56"><a id="__codelineno-78-56" name="__codelineno-78-56" href="#__codelineno-78-56"></a><span class="w">        </span><span class="n">Slog</span><span class="p">.</span><span class="na">wtf</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Failed sending broadcast to &quot;</span>
</span><span id="__span-78-57"><a id="__codelineno-78-57" name="__codelineno-78-57" href="#__codelineno-78-57"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">curComponent</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; with &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
</span><span id="__span-78-58"><a id="__codelineno-78-58" name="__codelineno-78-58" href="#__codelineno-78-58"></a><span class="w">        </span><span class="c1">// If some unexpected exception happened, just skip</span>
</span><span id="__span-78-59"><a id="__codelineno-78-59" name="__codelineno-78-59" href="#__codelineno-78-59"></a><span class="w">        </span><span class="c1">// this broadcast.  At this point we are not in the call</span>
</span><span id="__span-78-60"><a id="__codelineno-78-60" name="__codelineno-78-60" href="#__codelineno-78-60"></a><span class="w">        </span><span class="c1">// from a client, so throwing an exception out from here</span>
</span><span id="__span-78-61"><a id="__codelineno-78-61" name="__codelineno-78-61" href="#__codelineno-78-61"></a><span class="w">        </span><span class="c1">// will crash the entire system instead of just whoever</span>
</span><span id="__span-78-62"><a id="__codelineno-78-62" name="__codelineno-78-62" href="#__codelineno-78-62"></a><span class="w">        </span><span class="c1">// sent the broadcast.</span>
</span><span id="__span-78-63"><a id="__codelineno-78-63" name="__codelineno-78-63" href="#__codelineno-78-63"></a><span class="w">        </span><span class="n">logBroadcastReceiverDiscardLocked</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-78-64"><a id="__codelineno-78-64" name="__codelineno-78-64" href="#__codelineno-78-64"></a><span class="w">        </span><span class="n">finishReceiverLocked</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">resultCode</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">resultData</span><span class="p">,</span>
</span><span id="__span-78-65"><a id="__codelineno-78-65" name="__codelineno-78-65" href="#__codelineno-78-65"></a><span class="w">                </span><span class="n">r</span><span class="p">.</span><span class="na">resultExtras</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">resultAbort</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
</span><span id="__span-78-66"><a id="__codelineno-78-66" name="__codelineno-78-66" href="#__codelineno-78-66"></a><span class="w">        </span><span class="n">scheduleBroadcastsLocked</span><span class="p">();</span>
</span><span id="__span-78-67"><a id="__codelineno-78-67" name="__codelineno-78-67" href="#__codelineno-78-67"></a><span class="w">        </span><span class="c1">// We need to reset the state if we failed to start the receiver.</span>
</span><span id="__span-78-68"><a id="__codelineno-78-68" name="__codelineno-78-68" href="#__codelineno-78-68"></a><span class="w">        </span><span class="n">r</span><span class="p">.</span><span class="na">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">.</span><span class="na">IDLE</span><span class="p">;</span>
</span><span id="__span-78-69"><a id="__codelineno-78-69" name="__codelineno-78-69" href="#__codelineno-78-69"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-78-70"><a id="__codelineno-78-70" name="__codelineno-78-70" href="#__codelineno-78-70"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-78-71"><a id="__codelineno-78-71" name="__codelineno-78-71" href="#__codelineno-78-71"></a>
</span><span id="__span-78-72"><a id="__codelineno-78-72" name="__codelineno-78-72" href="#__codelineno-78-72"></a><span class="w">    </span><span class="c1">// If a dead object exception was thrown -- fall through to</span>
</span><span id="__span-78-73"><a id="__codelineno-78-73" name="__codelineno-78-73" href="#__codelineno-78-73"></a><span class="w">    </span><span class="c1">// restart the application.</span>
</span><span id="__span-78-74"><a id="__codelineno-78-74" name="__codelineno-78-74" href="#__codelineno-78-74"></a><span class="p">}</span>
</span></code></pre></div>
<h6 id="processcurbroadcastlocked"># processCurBroadcastLocked<a class="headerlink" href="#processcurbroadcastlocked" title="Permanent link">&para;</a></h6>
<div class="language-java highlight"><pre><span></span><code><span id="__span-79-1"><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">processCurBroadcastLocked</span><span class="p">(</span><span class="n">BroadcastRecord</span><span class="w"> </span><span class="n">r</span><span class="p">,</span>
</span><span id="__span-79-2"><a id="__codelineno-79-2" name="__codelineno-79-2" href="#__codelineno-79-2"></a><span class="w">        </span><span class="n">ProcessRecord</span><span class="w"> </span><span class="n">app</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">receiverType</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">processTemperature</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">RemoteException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-79-3"><a id="__codelineno-79-3" name="__codelineno-79-3" href="#__codelineno-79-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w">  </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span>
</span><span id="__span-79-4"><a id="__codelineno-79-4" name="__codelineno-79-4" href="#__codelineno-79-4"></a><span class="w">            </span><span class="s">&quot;Process cur broadcast &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; for app &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">app</span><span class="p">);</span>
</span><span id="__span-79-5"><a id="__codelineno-79-5" name="__codelineno-79-5" href="#__codelineno-79-5"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">IApplicationThread</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">app</span><span class="p">.</span><span class="na">getThread</span><span class="p">();</span>
</span><span id="__span-79-6"><a id="__codelineno-79-6" name="__codelineno-79-6" href="#__codelineno-79-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">thread</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-79-7"><a id="__codelineno-79-7" name="__codelineno-79-7" href="#__codelineno-79-7"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RemoteException</span><span class="p">();</span>
</span><span id="__span-79-8"><a id="__codelineno-79-8" name="__codelineno-79-8" href="#__codelineno-79-8"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-79-9"><a id="__codelineno-79-9" name="__codelineno-79-9" href="#__codelineno-79-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="na">isInFullBackup</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-79-10"><a id="__codelineno-79-10" name="__codelineno-79-10" href="#__codelineno-79-10"></a><span class="w">        </span><span class="n">skipReceiverLocked</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-79-11"><a id="__codelineno-79-11" name="__codelineno-79-11" href="#__codelineno-79-11"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-79-12"><a id="__codelineno-79-12" name="__codelineno-79-12" href="#__codelineno-79-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-79-13"><a id="__codelineno-79-13" name="__codelineno-79-13" href="#__codelineno-79-13"></a>
</span><span id="__span-79-14"><a id="__codelineno-79-14" name="__codelineno-79-14" href="#__codelineno-79-14"></a><span class="w">    </span><span class="c1">//processCurBroadcastLocked的时候，会有r.receiver的设置</span>
</span><span id="__span-79-15"><a id="__codelineno-79-15" name="__codelineno-79-15" href="#__codelineno-79-15"></a><span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="na">receiver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thread</span><span class="p">.</span><span class="na">asBinder</span><span class="p">();</span>
</span><span id="__span-79-16"><a id="__codelineno-79-16" name="__codelineno-79-16" href="#__codelineno-79-16"></a><span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="na">curApp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">app</span><span class="p">;</span>
</span><span id="__span-79-17"><a id="__codelineno-79-17" name="__codelineno-79-17" href="#__codelineno-79-17"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">ProcessReceiverRecord</span><span class="w"> </span><span class="n">prr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">app</span><span class="p">.</span><span class="na">mReceivers</span><span class="p">;</span>
</span><span id="__span-79-18"><a id="__codelineno-79-18" name="__codelineno-79-18" href="#__codelineno-79-18"></a><span class="w">    </span><span class="n">prr</span><span class="p">.</span><span class="na">addCurReceiver</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-79-19"><a id="__codelineno-79-19" name="__codelineno-79-19" href="#__codelineno-79-19"></a><span class="w">    </span><span class="n">app</span><span class="p">.</span><span class="na">mState</span><span class="p">.</span><span class="na">forceProcessStateUpTo</span><span class="p">(</span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">PROCESS_STATE_RECEIVER</span><span class="p">);</span>
</span><span id="__span-79-20"><a id="__codelineno-79-20" name="__codelineno-79-20" href="#__codelineno-79-20"></a><span class="w">    </span><span class="c1">// Don&#39;t bump its LRU position if it&#39;s in the background restricted.</span>
</span><span id="__span-79-21"><a id="__codelineno-79-21" name="__codelineno-79-21" href="#__codelineno-79-21"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mService</span><span class="p">.</span><span class="na">mInternal</span><span class="p">.</span><span class="na">getRestrictionLevel</span><span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="na">info</span><span class="p">.</span><span class="na">packageName</span><span class="p">,</span><span class="w"> </span><span class="n">app</span><span class="p">.</span><span class="na">userId</span><span class="p">)</span>
</span><span id="__span-79-22"><a id="__codelineno-79-22" name="__codelineno-79-22" href="#__codelineno-79-22"></a><span class="w">            </span><span class="o">&lt;</span><span class="w"> </span><span class="n">RESTRICTION_LEVEL_RESTRICTED_BUCKET</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-79-23"><a id="__codelineno-79-23" name="__codelineno-79-23" href="#__codelineno-79-23"></a><span class="w">        </span><span class="n">mService</span><span class="p">.</span><span class="na">updateLruProcessLocked</span><span class="p">(</span><span class="n">app</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
</span><span id="__span-79-24"><a id="__codelineno-79-24" name="__codelineno-79-24" href="#__codelineno-79-24"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-79-25"><a id="__codelineno-79-25" name="__codelineno-79-25" href="#__codelineno-79-25"></a><span class="w">    </span><span class="c1">// Make sure the oom adj score is updated before delivering the broadcast.</span>
</span><span id="__span-79-26"><a id="__codelineno-79-26" name="__codelineno-79-26" href="#__codelineno-79-26"></a><span class="w">    </span><span class="c1">// Force an update, even if there are other pending requests, overall it still saves time,</span>
</span><span id="__span-79-27"><a id="__codelineno-79-27" name="__codelineno-79-27" href="#__codelineno-79-27"></a><span class="w">    </span><span class="c1">// because time(updateOomAdj(N apps)) &lt;= N * time(updateOomAdj(1 app)).</span>
</span><span id="__span-79-28"><a id="__codelineno-79-28" name="__codelineno-79-28" href="#__codelineno-79-28"></a><span class="w">    </span><span class="n">mService</span><span class="p">.</span><span class="na">enqueueOomAdjTargetLocked</span><span class="p">(</span><span class="n">app</span><span class="p">);</span>
</span><span id="__span-79-29"><a id="__codelineno-79-29" name="__codelineno-79-29" href="#__codelineno-79-29"></a><span class="w">    </span><span class="n">mService</span><span class="p">.</span><span class="na">updateOomAdjPendingTargetsLocked</span><span class="p">(</span><span class="n">OomAdjuster</span><span class="p">.</span><span class="na">OOM_ADJ_REASON_START_RECEIVER</span><span class="p">);</span>
</span><span id="__span-79-30"><a id="__codelineno-79-30" name="__codelineno-79-30" href="#__codelineno-79-30"></a>
</span><span id="__span-79-31"><a id="__codelineno-79-31" name="__codelineno-79-31" href="#__codelineno-79-31"></a><span class="w">    </span><span class="c1">// Tell the application to launch this receiver.</span>
</span><span id="__span-79-32"><a id="__codelineno-79-32" name="__codelineno-79-32" href="#__codelineno-79-32"></a><span class="w">    </span><span class="n">maybeReportBroadcastDispatchedEventLocked</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">curReceiver</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">uid</span><span class="p">);</span>
</span><span id="__span-79-33"><a id="__codelineno-79-33" name="__codelineno-79-33" href="#__codelineno-79-33"></a><span class="w">    </span><span class="c1">//r.curComponent是发送给静态接收者的时候设置的组件名字</span>
</span><span id="__span-79-34"><a id="__codelineno-79-34" name="__codelineno-79-34" href="#__codelineno-79-34"></a><span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">setComponent</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">curComponent</span><span class="p">);</span>
</span><span id="__span-79-35"><a id="__codelineno-79-35" name="__codelineno-79-35" href="#__codelineno-79-35"></a>
</span><span id="__span-79-36"><a id="__codelineno-79-36" name="__codelineno-79-36" href="#__codelineno-79-36"></a><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">started</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-79-37"><a id="__codelineno-79-37" name="__codelineno-79-37" href="#__codelineno-79-37"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-79-38"><a id="__codelineno-79-38" name="__codelineno-79-38" href="#__codelineno-79-38"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST_LIGHT</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span>
</span><span id="__span-79-39"><a id="__codelineno-79-39" name="__codelineno-79-39" href="#__codelineno-79-39"></a><span class="w">                </span><span class="s">&quot;Delivering to component &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">curComponent</span>
</span><span id="__span-79-40"><a id="__codelineno-79-40" name="__codelineno-79-40" href="#__codelineno-79-40"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-79-41"><a id="__codelineno-79-41" name="__codelineno-79-41" href="#__codelineno-79-41"></a><span class="w">        </span><span class="n">mService</span><span class="p">.</span><span class="na">notifyPackageUse</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getComponent</span><span class="p">().</span><span class="na">getPackageName</span><span class="p">(),</span>
</span><span id="__span-79-42"><a id="__codelineno-79-42" name="__codelineno-79-42" href="#__codelineno-79-42"></a><span class="w">                                  </span><span class="n">PackageManager</span><span class="p">.</span><span class="na">NOTIFY_PACKAGE_USE_BROADCAST_RECEIVER</span><span class="p">);</span>
</span><span id="__span-79-43"><a id="__codelineno-79-43" name="__codelineno-79-43" href="#__codelineno-79-43"></a><span class="w">        </span><span class="c1">//发送给app主线程的scheduleReceiver</span>
</span><span id="__span-79-44"><a id="__codelineno-79-44" name="__codelineno-79-44" href="#__codelineno-79-44"></a><span class="w">        </span><span class="n">thread</span><span class="p">.</span><span class="na">scheduleReceiver</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Intent</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">),</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">curReceiver</span><span class="p">,</span>
</span><span id="__span-79-45"><a id="__codelineno-79-45" name="__codelineno-79-45" href="#__codelineno-79-45"></a><span class="w">                </span><span class="n">mService</span><span class="p">.</span><span class="na">compatibilityInfoForPackage</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">curReceiver</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">),</span>
</span><span id="__span-79-46"><a id="__codelineno-79-46" name="__codelineno-79-46" href="#__codelineno-79-46"></a><span class="w">                </span><span class="n">r</span><span class="p">.</span><span class="na">resultCode</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">resultData</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">resultExtras</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">ordered</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">userId</span><span class="p">,</span>
</span><span id="__span-79-47"><a id="__codelineno-79-47" name="__codelineno-79-47" href="#__codelineno-79-47"></a><span class="w">                </span><span class="n">app</span><span class="p">.</span><span class="na">mState</span><span class="p">.</span><span class="na">getReportedProcState</span><span class="p">());</span>
</span><span id="__span-79-48"><a id="__codelineno-79-48" name="__codelineno-79-48" href="#__codelineno-79-48"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w">  </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span>
</span><span id="__span-79-49"><a id="__codelineno-79-49" name="__codelineno-79-49" href="#__codelineno-79-49"></a><span class="w">                </span><span class="s">&quot;Process cur broadcast &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; DELIVERED for app &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">app</span><span class="p">);</span>
</span><span id="__span-79-50"><a id="__codelineno-79-50" name="__codelineno-79-50" href="#__codelineno-79-50"></a><span class="w">        </span><span class="n">started</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-79-51"><a id="__codelineno-79-51" name="__codelineno-79-51" href="#__codelineno-79-51"></a><span class="w">        </span><span class="n">FrameworkStatsLog</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">BROADCAST_DELIVERY_EVENT_REPORTED</span><span class="p">,</span><span class="w"> </span><span class="n">app</span><span class="p">.</span><span class="na">uid</span><span class="p">,</span>
</span><span id="__span-79-52"><a id="__codelineno-79-52" name="__codelineno-79-52" href="#__codelineno-79-52"></a><span class="w">                </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">Process</span><span class="p">.</span><span class="na">SYSTEM_UID</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">callingUid</span><span class="p">,</span>
</span><span id="__span-79-53"><a id="__codelineno-79-53" name="__codelineno-79-53" href="#__codelineno-79-53"></a><span class="w">                </span><span class="n">ActivityManagerService</span><span class="p">.</span><span class="na">getShortAction</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">()),</span>
</span><span id="__span-79-54"><a id="__codelineno-79-54" name="__codelineno-79-54" href="#__codelineno-79-54"></a><span class="w">                </span><span class="n">receiverType</span><span class="p">,</span><span class="w"> </span><span class="n">processTemperature</span><span class="p">);</span>
</span><span id="__span-79-55"><a id="__codelineno-79-55" name="__codelineno-79-55" href="#__codelineno-79-55"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-79-56"><a id="__codelineno-79-56" name="__codelineno-79-56" href="#__codelineno-79-56"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">started</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-79-57"><a id="__codelineno-79-57" name="__codelineno-79-57" href="#__codelineno-79-57"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w">  </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span>
</span><span id="__span-79-58"><a id="__codelineno-79-58" name="__codelineno-79-58" href="#__codelineno-79-58"></a><span class="w">                    </span><span class="s">&quot;Process cur broadcast &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;: NOT STARTED!&quot;</span><span class="p">);</span>
</span><span id="__span-79-59"><a id="__codelineno-79-59" name="__codelineno-79-59" href="#__codelineno-79-59"></a><span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="na">receiver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-79-60"><a id="__codelineno-79-60" name="__codelineno-79-60" href="#__codelineno-79-60"></a><span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="na">curApp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-79-61"><a id="__codelineno-79-61" name="__codelineno-79-61" href="#__codelineno-79-61"></a><span class="w">            </span><span class="n">prr</span><span class="p">.</span><span class="na">removeCurReceiver</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-79-62"><a id="__codelineno-79-62" name="__codelineno-79-62" href="#__codelineno-79-62"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-79-63"><a id="__codelineno-79-63" name="__codelineno-79-63" href="#__codelineno-79-63"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-79-64"><a id="__codelineno-79-64" name="__codelineno-79-64" href="#__codelineno-79-64"></a>
</span><span id="__span-79-65"><a id="__codelineno-79-65" name="__codelineno-79-65" href="#__codelineno-79-65"></a><span class="w">    </span><span class="c1">// if something bad happens here, launch the app and try again</span>
</span><span id="__span-79-66"><a id="__codelineno-79-66" name="__codelineno-79-66" href="#__codelineno-79-66"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="na">isKilled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-79-67"><a id="__codelineno-79-67" name="__codelineno-79-67" href="#__codelineno-79-67"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RemoteException</span><span class="p">(</span><span class="s">&quot;app gets killed during broadcasting&quot;</span><span class="p">);</span>
</span><span id="__span-79-68"><a id="__codelineno-79-68" name="__codelineno-79-68" href="#__codelineno-79-68"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-79-69"><a id="__codelineno-79-69" name="__codelineno-79-69" href="#__codelineno-79-69"></a><span class="p">}</span>
</span></code></pre></div>
<h6 id="activitythreadschedulereceiver"># ActivityThread.scheduleReceiver<a class="headerlink" href="#activitythreadschedulereceiver" title="Permanent link">&para;</a></h6>
<div class="language-java highlight"><pre><span></span><code><span id="__span-80-1"><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">scheduleReceiver</span><span class="p">(</span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">ActivityInfo</span><span class="w"> </span><span class="n">info</span><span class="p">,</span>
</span><span id="__span-80-2"><a id="__codelineno-80-2" name="__codelineno-80-2" href="#__codelineno-80-2"></a><span class="w">        </span><span class="n">CompatibilityInfo</span><span class="w"> </span><span class="n">compatInfo</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">resultCode</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">Bundle</span><span class="w"> </span><span class="n">extras</span><span class="p">,</span>
</span><span id="__span-80-3"><a id="__codelineno-80-3" name="__codelineno-80-3" href="#__codelineno-80-3"></a><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">sync</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">sendingUser</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">processState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-80-4"><a id="__codelineno-80-4" name="__codelineno-80-4" href="#__codelineno-80-4"></a><span class="w">    </span><span class="n">updateProcessState</span><span class="p">(</span><span class="n">processState</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
</span><span id="__span-80-5"><a id="__codelineno-80-5" name="__codelineno-80-5" href="#__codelineno-80-5"></a><span class="w">    </span><span class="n">ReceiverData</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReceiverData</span><span class="p">(</span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">resultCode</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">extras</span><span class="p">,</span>
</span><span id="__span-80-6"><a id="__codelineno-80-6" name="__codelineno-80-6" href="#__codelineno-80-6"></a><span class="w">            </span><span class="n">sync</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">mAppThread</span><span class="p">.</span><span class="na">asBinder</span><span class="p">(),</span><span class="w"> </span><span class="n">sendingUser</span><span class="p">);</span>
</span><span id="__span-80-7"><a id="__codelineno-80-7" name="__codelineno-80-7" href="#__codelineno-80-7"></a><span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="na">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="p">;</span>
</span><span id="__span-80-8"><a id="__codelineno-80-8" name="__codelineno-80-8" href="#__codelineno-80-8"></a><span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="na">compatInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compatInfo</span><span class="p">;</span>
</span><span id="__span-80-9"><a id="__codelineno-80-9" name="__codelineno-80-9" href="#__codelineno-80-9"></a><span class="w">    </span><span class="n">sendMessage</span><span class="p">(</span><span class="n">H</span><span class="p">.</span><span class="na">RECEIVER</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-80-10"><a id="__codelineno-80-10" name="__codelineno-80-10" href="#__codelineno-80-10"></a><span class="p">}</span>
</span></code></pre></div>
<h6 id="activitythreadhandlereceiver"># ActivityThread.handleReceiver<a class="headerlink" href="#activitythreadhandlereceiver" title="Permanent link">&para;</a></h6>
<div class="language-java highlight"><pre><span></span><code><span id="__span-81-1"><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handleReceiver</span><span class="p">(</span><span class="n">ReceiverData</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-81-2"><a id="__codelineno-81-2" name="__codelineno-81-2" href="#__codelineno-81-2"></a><span class="w">    </span><span class="c1">// If we are getting ready to gc after going to the background, well</span>
</span><span id="__span-81-3"><a id="__codelineno-81-3" name="__codelineno-81-3" href="#__codelineno-81-3"></a><span class="w">    </span><span class="c1">// we are back active so skip it.</span>
</span><span id="__span-81-4"><a id="__codelineno-81-4" name="__codelineno-81-4" href="#__codelineno-81-4"></a><span class="w">    </span><span class="n">unscheduleGcIdler</span><span class="p">();</span>
</span><span id="__span-81-5"><a id="__codelineno-81-5" name="__codelineno-81-5" href="#__codelineno-81-5"></a><span class="w">    </span><span class="c1">// 1） 创建BroadcastReceiver对象</span>
</span><span id="__span-81-6"><a id="__codelineno-81-6" name="__codelineno-81-6" href="#__codelineno-81-6"></a><span class="w">    </span><span class="c1">// 这里处理的是静态广播接收者，默认认为接收者BroadcastReceiver对象不存在</span>
</span><span id="__span-81-7"><a id="__codelineno-81-7" name="__codelineno-81-7" href="#__codelineno-81-7"></a><span class="w">    </span><span class="c1">// 每次接受都会创建一个新的BroadcastReceiver对象</span>
</span><span id="__span-81-8"><a id="__codelineno-81-8" name="__codelineno-81-8" href="#__codelineno-81-8"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getComponent</span><span class="p">().</span><span class="na">getClassName</span><span class="p">();</span>
</span><span id="__span-81-9"><a id="__codelineno-81-9" name="__codelineno-81-9" href="#__codelineno-81-9"></a>
</span><span id="__span-81-10"><a id="__codelineno-81-10" name="__codelineno-81-10" href="#__codelineno-81-10"></a><span class="w">    </span><span class="n">LoadedApk</span><span class="w"> </span><span class="n">packageInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getPackageInfoNoCheck</span><span class="p">(</span>
</span><span id="__span-81-11"><a id="__codelineno-81-11" name="__codelineno-81-11" href="#__codelineno-81-11"></a><span class="w">            </span><span class="n">data</span><span class="p">.</span><span class="na">info</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="na">compatInfo</span><span class="p">);</span>
</span><span id="__span-81-12"><a id="__codelineno-81-12" name="__codelineno-81-12" href="#__codelineno-81-12"></a>
</span><span id="__span-81-13"><a id="__codelineno-81-13" name="__codelineno-81-13" href="#__codelineno-81-13"></a><span class="w">    </span><span class="n">IActivityManager</span><span class="w"> </span><span class="n">mgr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ActivityManager</span><span class="p">.</span><span class="na">getService</span><span class="p">();</span>
</span><span id="__span-81-14"><a id="__codelineno-81-14" name="__codelineno-81-14" href="#__codelineno-81-14"></a>
</span><span id="__span-81-15"><a id="__codelineno-81-15" name="__codelineno-81-15" href="#__codelineno-81-15"></a><span class="w">    </span><span class="n">Application</span><span class="w"> </span><span class="n">app</span><span class="p">;</span>
</span><span id="__span-81-16"><a id="__codelineno-81-16" name="__codelineno-81-16" href="#__codelineno-81-16"></a><span class="w">    </span><span class="n">BroadcastReceiver</span><span class="w"> </span><span class="n">receiver</span><span class="p">;</span>
</span><span id="__span-81-17"><a id="__codelineno-81-17" name="__codelineno-81-17" href="#__codelineno-81-17"></a><span class="w">    </span><span class="n">ContextImpl</span><span class="w"> </span><span class="n">context</span><span class="p">;</span>
</span><span id="__span-81-18"><a id="__codelineno-81-18" name="__codelineno-81-18" href="#__codelineno-81-18"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-81-19"><a id="__codelineno-81-19" name="__codelineno-81-19" href="#__codelineno-81-19"></a><span class="w">        </span><span class="c1">// 首先从AMS传递的intent中获取当前处理该广播的组件名称，然后通过反射创建一个BroadcastReceiver</span>
</span><span id="__span-81-20"><a id="__codelineno-81-20" name="__codelineno-81-20" href="#__codelineno-81-20"></a><span class="w">        </span><span class="c1">// 对象，从这里可以看出来，静态广播处理的时候，每次都会创建一个新的BroadcastReceiver对象；</span>
</span><span id="__span-81-21"><a id="__codelineno-81-21" name="__codelineno-81-21" href="#__codelineno-81-21"></a><span class="w">        </span><span class="c1">// 创建Application对象，如果进程已经启动，Application对象已经创建</span>
</span><span id="__span-81-22"><a id="__codelineno-81-22" name="__codelineno-81-22" href="#__codelineno-81-22"></a><span class="w">        </span><span class="n">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packageInfo</span><span class="p">.</span><span class="na">makeApplicationInner</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">mInstrumentation</span><span class="p">);</span>
</span><span id="__span-81-23"><a id="__codelineno-81-23" name="__codelineno-81-23" href="#__codelineno-81-23"></a><span class="w">        </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ContextImpl</span><span class="p">)</span><span class="w"> </span><span class="n">app</span><span class="p">.</span><span class="na">getBaseContext</span><span class="p">();</span>
</span><span id="__span-81-24"><a id="__codelineno-81-24" name="__codelineno-81-24" href="#__codelineno-81-24"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="na">info</span><span class="p">.</span><span class="na">splitName</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-81-25"><a id="__codelineno-81-25" name="__codelineno-81-25" href="#__codelineno-81-25"></a><span class="w">            </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ContextImpl</span><span class="p">)</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">createContextForSplit</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="na">info</span><span class="p">.</span><span class="na">splitName</span><span class="p">);</span>
</span><span id="__span-81-26"><a id="__codelineno-81-26" name="__codelineno-81-26" href="#__codelineno-81-26"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-81-27"><a id="__codelineno-81-27" name="__codelineno-81-27" href="#__codelineno-81-27"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="na">info</span><span class="p">.</span><span class="na">attributionTags</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="na">info</span><span class="p">.</span><span class="na">attributionTags</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-81-28"><a id="__codelineno-81-28" name="__codelineno-81-28" href="#__codelineno-81-28"></a><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">attributionTag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="na">info</span><span class="p">.</span><span class="na">attributionTags</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">;</span>
</span><span id="__span-81-29"><a id="__codelineno-81-29" name="__codelineno-81-29" href="#__codelineno-81-29"></a><span class="w">            </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ContextImpl</span><span class="p">)</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">createAttributionContext</span><span class="p">(</span><span class="n">attributionTag</span><span class="p">);</span>
</span><span id="__span-81-30"><a id="__codelineno-81-30" name="__codelineno-81-30" href="#__codelineno-81-30"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-81-31"><a id="__codelineno-81-31" name="__codelineno-81-31" href="#__codelineno-81-31"></a><span class="w">        </span><span class="n">java</span><span class="p">.</span><span class="na">lang</span><span class="p">.</span><span class="na">ClassLoader</span><span class="w"> </span><span class="n">cl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getClassLoader</span><span class="p">();</span>
</span><span id="__span-81-32"><a id="__codelineno-81-32" name="__codelineno-81-32" href="#__codelineno-81-32"></a><span class="w">        </span><span class="n">data</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">setExtrasClassLoader</span><span class="p">(</span><span class="n">cl</span><span class="p">);</span>
</span><span id="__span-81-33"><a id="__codelineno-81-33" name="__codelineno-81-33" href="#__codelineno-81-33"></a><span class="w">        </span><span class="n">data</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">prepareToEnterProcess</span><span class="p">(</span>
</span><span id="__span-81-34"><a id="__codelineno-81-34" name="__codelineno-81-34" href="#__codelineno-81-34"></a><span class="w">                </span><span class="n">isProtectedComponent</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="na">info</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">isProtectedBroadcast</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="na">intent</span><span class="p">),</span>
</span><span id="__span-81-35"><a id="__codelineno-81-35" name="__codelineno-81-35" href="#__codelineno-81-35"></a><span class="w">                </span><span class="n">context</span><span class="p">.</span><span class="na">getAttributionSource</span><span class="p">());</span>
</span><span id="__span-81-36"><a id="__codelineno-81-36" name="__codelineno-81-36" href="#__codelineno-81-36"></a><span class="w">        </span><span class="n">data</span><span class="p">.</span><span class="na">setExtrasClassLoader</span><span class="p">(</span><span class="n">cl</span><span class="p">);</span>
</span><span id="__span-81-37"><a id="__codelineno-81-37" name="__codelineno-81-37" href="#__codelineno-81-37"></a><span class="w">        </span><span class="n">receiver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packageInfo</span><span class="p">.</span><span class="na">getAppFactory</span><span class="p">()</span>
</span><span id="__span-81-38"><a id="__codelineno-81-38" name="__codelineno-81-38" href="#__codelineno-81-38"></a><span class="w">                </span><span class="p">.</span><span class="na">instantiateReceiver</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="na">info</span><span class="p">.</span><span class="na">name</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="na">intent</span><span class="p">);</span>
</span><span id="__span-81-39"><a id="__codelineno-81-39" name="__codelineno-81-39" href="#__codelineno-81-39"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-81-40"><a id="__codelineno-81-40" name="__codelineno-81-40" href="#__codelineno-81-40"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span>
</span><span id="__span-81-41"><a id="__codelineno-81-41" name="__codelineno-81-41" href="#__codelineno-81-41"></a><span class="w">                </span><span class="s">&quot;Finishing failed broadcast to &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getComponent</span><span class="p">());</span>
</span><span id="__span-81-42"><a id="__codelineno-81-42" name="__codelineno-81-42" href="#__codelineno-81-42"></a><span class="w">        </span><span class="n">data</span><span class="p">.</span><span class="na">sendFinished</span><span class="p">(</span><span class="n">mgr</span><span class="p">);</span>
</span><span id="__span-81-43"><a id="__codelineno-81-43" name="__codelineno-81-43" href="#__codelineno-81-43"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span>
</span><span id="__span-81-44"><a id="__codelineno-81-44" name="__codelineno-81-44" href="#__codelineno-81-44"></a><span class="w">            </span><span class="s">&quot;Unable to instantiate receiver &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">component</span>
</span><span id="__span-81-45"><a id="__codelineno-81-45" name="__codelineno-81-45" href="#__codelineno-81-45"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">toString</span><span class="p">(),</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
</span><span id="__span-81-46"><a id="__codelineno-81-46" name="__codelineno-81-46" href="#__codelineno-81-46"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-81-47"><a id="__codelineno-81-47" name="__codelineno-81-47" href="#__codelineno-81-47"></a>
</span><span id="__span-81-48"><a id="__codelineno-81-48" name="__codelineno-81-48" href="#__codelineno-81-48"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-81-49"><a id="__codelineno-81-49" name="__codelineno-81-49" href="#__codelineno-81-49"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">localLOGV</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span>
</span><span id="__span-81-50"><a id="__codelineno-81-50" name="__codelineno-81-50" href="#__codelineno-81-50"></a><span class="w">            </span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Performing receive of &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="na">intent</span>
</span><span id="__span-81-51"><a id="__codelineno-81-51" name="__codelineno-81-51" href="#__codelineno-81-51"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;: app=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">app</span>
</span><span id="__span-81-52"><a id="__codelineno-81-52" name="__codelineno-81-52" href="#__codelineno-81-52"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, appName=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">app</span><span class="p">.</span><span class="na">getPackageName</span><span class="p">()</span>
</span><span id="__span-81-53"><a id="__codelineno-81-53" name="__codelineno-81-53" href="#__codelineno-81-53"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, pkg=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">packageInfo</span><span class="p">.</span><span class="na">getPackageName</span><span class="p">()</span>
</span><span id="__span-81-54"><a id="__codelineno-81-54" name="__codelineno-81-54" href="#__codelineno-81-54"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, comp=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getComponent</span><span class="p">().</span><span class="na">toShortString</span><span class="p">()</span>
</span><span id="__span-81-55"><a id="__codelineno-81-55" name="__codelineno-81-55" href="#__codelineno-81-55"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, dir=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">packageInfo</span><span class="p">.</span><span class="na">getAppDir</span><span class="p">());</span>
</span><span id="__span-81-56"><a id="__codelineno-81-56" name="__codelineno-81-56" href="#__codelineno-81-56"></a>
</span><span id="__span-81-57"><a id="__codelineno-81-57" name="__codelineno-81-57" href="#__codelineno-81-57"></a><span class="w">        </span><span class="n">sCurrentBroadcastIntent</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="na">intent</span><span class="p">);</span>
</span><span id="__span-81-58"><a id="__codelineno-81-58" name="__codelineno-81-58" href="#__codelineno-81-58"></a><span class="w">        </span><span class="c1">//这里还调用了setPendingResult方法，详细内容请看BroadcastReceiver.goAsync方法。</span>
</span><span id="__span-81-59"><a id="__codelineno-81-59" name="__codelineno-81-59" href="#__codelineno-81-59"></a><span class="w">        </span><span class="n">receiver</span><span class="p">.</span><span class="na">setPendingResult</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
</span><span id="__span-81-60"><a id="__codelineno-81-60" name="__codelineno-81-60" href="#__codelineno-81-60"></a><span class="w">        </span><span class="c1">//终于看到了熟悉的onReceive回调了</span>
</span><span id="__span-81-61"><a id="__codelineno-81-61" name="__codelineno-81-61" href="#__codelineno-81-61"></a><span class="w">        </span><span class="n">receiver</span><span class="p">.</span><span class="na">onReceive</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="na">getReceiverRestrictedContext</span><span class="p">(),</span>
</span><span id="__span-81-62"><a id="__codelineno-81-62" name="__codelineno-81-62" href="#__codelineno-81-62"></a><span class="w">                </span><span class="n">data</span><span class="p">.</span><span class="na">intent</span><span class="p">);</span>
</span><span id="__span-81-63"><a id="__codelineno-81-63" name="__codelineno-81-63" href="#__codelineno-81-63"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-81-64"><a id="__codelineno-81-64" name="__codelineno-81-64" href="#__codelineno-81-64"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w"> </span><span class="n">Slog</span><span class="p">.</span><span class="na">i</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span>
</span><span id="__span-81-65"><a id="__codelineno-81-65" name="__codelineno-81-65" href="#__codelineno-81-65"></a><span class="w">                </span><span class="s">&quot;Finishing failed broadcast to &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getComponent</span><span class="p">());</span>
</span><span id="__span-81-66"><a id="__codelineno-81-66" name="__codelineno-81-66" href="#__codelineno-81-66"></a><span class="w">        </span><span class="n">data</span><span class="p">.</span><span class="na">sendFinished</span><span class="p">(</span><span class="n">mgr</span><span class="p">);</span>
</span><span id="__span-81-67"><a id="__codelineno-81-67" name="__codelineno-81-67" href="#__codelineno-81-67"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mInstrumentation</span><span class="p">.</span><span class="na">onException</span><span class="p">(</span><span class="n">receiver</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-81-68"><a id="__codelineno-81-68" name="__codelineno-81-68" href="#__codelineno-81-68"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span>
</span><span id="__span-81-69"><a id="__codelineno-81-69" name="__codelineno-81-69" href="#__codelineno-81-69"></a><span class="w">                </span><span class="s">&quot;Unable to start receiver &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">component</span>
</span><span id="__span-81-70"><a id="__codelineno-81-70" name="__codelineno-81-70" href="#__codelineno-81-70"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">toString</span><span class="p">(),</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
</span><span id="__span-81-71"><a id="__codelineno-81-71" name="__codelineno-81-71" href="#__codelineno-81-71"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-81-72"><a id="__codelineno-81-72" name="__codelineno-81-72" href="#__codelineno-81-72"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-81-73"><a id="__codelineno-81-73" name="__codelineno-81-73" href="#__codelineno-81-73"></a><span class="w">        </span><span class="n">sCurrentBroadcastIntent</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
</span><span id="__span-81-74"><a id="__codelineno-81-74" name="__codelineno-81-74" href="#__codelineno-81-74"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-81-75"><a id="__codelineno-81-75" name="__codelineno-81-75" href="#__codelineno-81-75"></a><span class="w">    </span><span class="c1">//向AMS发送处理结束消息</span>
</span><span id="__span-81-76"><a id="__codelineno-81-76" name="__codelineno-81-76" href="#__codelineno-81-76"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">receiver</span><span class="p">.</span><span class="na">getPendingResult</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-81-77"><a id="__codelineno-81-77" name="__codelineno-81-77" href="#__codelineno-81-77"></a><span class="w">        </span><span class="n">data</span><span class="p">.</span><span class="na">finish</span><span class="p">();</span>
</span><span id="__span-81-78"><a id="__codelineno-81-78" name="__codelineno-81-78" href="#__codelineno-81-78"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-81-79"><a id="__codelineno-81-79" name="__codelineno-81-79" href="#__codelineno-81-79"></a><span class="p">}</span>
</span></code></pre></div>
<p>handleReceiver主要包括三步：</p>
<ul>
<li>创建BroadcastReceiver对象</li>
<li>执行onReceive函数</li>
<li>向AMS发送处理结束消息</li>
</ul>
<h6 id="_46">进程还未启动的静态有序广播接收者<a class="headerlink" href="#_46" title="Permanent link">&para;</a></h6>
<div class="language-java highlight"><pre><span></span><code><span id="__span-82-1"><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a><span class="c1">// Not running -- get it started, to be executed when the app comes up.</span>
</span><span id="__span-82-2"><a id="__codelineno-82-2" name="__codelineno-82-2" href="#__codelineno-82-2"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DEBUG_BROADCAST</span><span class="p">)</span><span class="w">  </span><span class="n">Slog</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG_BROADCAST</span><span class="p">,</span>
</span><span id="__span-82-3"><a id="__codelineno-82-3" name="__codelineno-82-3" href="#__codelineno-82-3"></a><span class="w">        </span><span class="s">&quot;Need to start app [&quot;</span>
</span><span id="__span-82-4"><a id="__codelineno-82-4" name="__codelineno-82-4" href="#__codelineno-82-4"></a><span class="w">        </span><span class="o">+</span><span class="w"> </span><span class="n">mQueueName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;] &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">targetProcess</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; for broadcast &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-82-5"><a id="__codelineno-82-5" name="__codelineno-82-5" href="#__codelineno-82-5"></a><span class="c1">//启动进程 ZYGOTE_POLICY_FLAG_LATENCY_SENSITIVE (延迟敏感的)标签用于确定fork进程时是否需要使用usap</span>
</span><span id="__span-82-6"><a id="__codelineno-82-6" name="__codelineno-82-6" href="#__codelineno-82-6"></a><span class="n">r</span><span class="p">.</span><span class="na">curApp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mService</span><span class="p">.</span><span class="na">startProcessLocked</span><span class="p">(</span><span class="n">targetProcess</span><span class="p">,</span>
</span><span id="__span-82-7"><a id="__codelineno-82-7" name="__codelineno-82-7" href="#__codelineno-82-7"></a><span class="w">        </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-82-8"><a id="__codelineno-82-8" name="__codelineno-82-8" href="#__codelineno-82-8"></a><span class="w">        </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getFlags</span><span class="p">()</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">FLAG_FROM_BACKGROUND</span><span class="p">,</span>
</span><span id="__span-82-9"><a id="__codelineno-82-9" name="__codelineno-82-9" href="#__codelineno-82-9"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">HostingRecord</span><span class="p">(</span><span class="n">HostingRecord</span><span class="p">.</span><span class="na">HOSTING_TYPE_BROADCAST</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">curComponent</span><span class="p">,</span>
</span><span id="__span-82-10"><a id="__codelineno-82-10" name="__codelineno-82-10" href="#__codelineno-82-10"></a><span class="w">                </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getAction</span><span class="p">()),</span>
</span><span id="__span-82-11"><a id="__codelineno-82-11" name="__codelineno-82-11" href="#__codelineno-82-11"></a><span class="w">        </span><span class="n">isActivityCapable</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">ZYGOTE_POLICY_FLAG_LATENCY_SENSITIVE</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">ZYGOTE_POLICY_FLAG_EMPTY</span><span class="p">,</span>
</span><span id="__span-82-12"><a id="__codelineno-82-12" name="__codelineno-82-12" href="#__codelineno-82-12"></a><span class="w">        </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="p">.</span><span class="na">getFlags</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Intent</span><span class="p">.</span><span class="na">FLAG_RECEIVER_BOOT_UPGRADE</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
</span><span id="__span-82-13"><a id="__codelineno-82-13" name="__codelineno-82-13" href="#__codelineno-82-13"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">curApp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-82-14"><a id="__codelineno-82-14" name="__codelineno-82-14" href="#__codelineno-82-14"></a><span class="w">    </span><span class="c1">// Ah, this recipient is unavailable.  Finish it if necessary,</span>
</span><span id="__span-82-15"><a id="__codelineno-82-15" name="__codelineno-82-15" href="#__codelineno-82-15"></a><span class="w">    </span><span class="c1">// and mark the broadcast record as ready for the next.</span>
</span><span id="__span-82-16"><a id="__codelineno-82-16" name="__codelineno-82-16" href="#__codelineno-82-16"></a><span class="w">    </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Unable to launch app &quot;</span>
</span><span id="__span-82-17"><a id="__codelineno-82-17" name="__codelineno-82-17" href="#__codelineno-82-17"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="na">activityInfo</span><span class="p">.</span><span class="na">applicationInfo</span><span class="p">.</span><span class="na">packageName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;/&quot;</span>
</span><span id="__span-82-18"><a id="__codelineno-82-18" name="__codelineno-82-18" href="#__codelineno-82-18"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">receiverUid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; for broadcast &quot;</span>
</span><span id="__span-82-19"><a id="__codelineno-82-19" name="__codelineno-82-19" href="#__codelineno-82-19"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">intent</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;: process is bad&quot;</span><span class="p">);</span>
</span><span id="__span-82-20"><a id="__codelineno-82-20" name="__codelineno-82-20" href="#__codelineno-82-20"></a><span class="w">    </span><span class="c1">//当无法启动app的时候，完成这个广播BroadcastRecord r的分发finishReceiverLocked</span>
</span><span id="__span-82-21"><a id="__codelineno-82-21" name="__codelineno-82-21" href="#__codelineno-82-21"></a><span class="w">    </span><span class="n">logBroadcastReceiverDiscardLocked</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-82-22"><a id="__codelineno-82-22" name="__codelineno-82-22" href="#__codelineno-82-22"></a><span class="w">    </span><span class="n">finishReceiverLocked</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">resultCode</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">resultData</span><span class="p">,</span>
</span><span id="__span-82-23"><a id="__codelineno-82-23" name="__codelineno-82-23" href="#__codelineno-82-23"></a><span class="w">            </span><span class="n">r</span><span class="p">.</span><span class="na">resultExtras</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">resultAbort</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
</span><span id="__span-82-24"><a id="__codelineno-82-24" name="__codelineno-82-24" href="#__codelineno-82-24"></a><span class="w">    </span><span class="n">scheduleBroadcastsLocked</span><span class="p">();</span>
</span><span id="__span-82-25"><a id="__codelineno-82-25" name="__codelineno-82-25" href="#__codelineno-82-25"></a><span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="na">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">.</span><span class="na">IDLE</span><span class="p">;</span>
</span><span id="__span-82-26"><a id="__codelineno-82-26" name="__codelineno-82-26" href="#__codelineno-82-26"></a><span class="w">    </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-82-27"><a id="__codelineno-82-27" name="__codelineno-82-27" href="#__codelineno-82-27"></a><span class="p">}</span>
</span><span id="__span-82-28"><a id="__codelineno-82-28" name="__codelineno-82-28" href="#__codelineno-82-28"></a>
</span><span id="__span-82-29"><a id="__codelineno-82-29" name="__codelineno-82-29" href="#__codelineno-82-29"></a><span class="n">maybeAddAllowBackgroundActivityStartsToken</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">curApp</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-82-30"><a id="__codelineno-82-30" name="__codelineno-82-30" href="#__codelineno-82-30"></a><span class="c1">// Need to start app 需要先启动该进程会设置mPendingBroadcast = r;</span>
</span><span id="__span-82-31"><a id="__codelineno-82-31" name="__codelineno-82-31" href="#__codelineno-82-31"></a><span class="c1">//启动进程后会调用attachApplicationLocked(AMS)、bindApplication(IApplicationThread)</span>
</span><span id="__span-82-32"><a id="__codelineno-82-32" name="__codelineno-82-32" href="#__codelineno-82-32"></a><span class="c1">//attachApplicationLocked(AMS)-&gt; sendPendingBroadcastsLocked 会处理mPendingBroadcast</span>
</span><span id="__span-82-33"><a id="__codelineno-82-33" name="__codelineno-82-33" href="#__codelineno-82-33"></a><span class="n">mPendingBroadcast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">;</span>
</span><span id="__span-82-34"><a id="__codelineno-82-34" name="__codelineno-82-34" href="#__codelineno-82-34"></a><span class="c1">//mPendingBroadcastRecvIndex是当前需要处理recevie的recIdx</span>
</span><span id="__span-82-35"><a id="__codelineno-82-35" name="__codelineno-82-35" href="#__codelineno-82-35"></a><span class="n">mPendingBroadcastRecvIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">recIdx</span><span class="p">;</span>
</span></code></pre></div>
<p>静态接收者进程尚未启动，调用AMS的startProcessLocked函数启动该接收者进程，并将当前正在等待进程启动。</p>
<h6 id="_47"># 进程创建流程<a class="headerlink" href="#_47" title="Permanent link">&para;</a></h6>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-83-1"><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a>ActivityThread.main<span class="w"> </span>-&gt;<span class="w"> </span>ActivityThread.attach<span class="w"> </span>-&gt;<span class="w"> </span>AMS.attachApplication<span class="w"> </span>-&gt;<span class="w"> </span>AMS.attachApplicationLocked<span class="w"> </span>-&gt;<span class="w"> </span>ActivityThread.bindApplication
</span><span id="__span-83-2"><a id="__codelineno-83-2" name="__codelineno-83-2" href="#__codelineno-83-2"></a>-&gt;<span class="w"> </span>AMS.sendPendingBroadcastsLocked<span class="w"> </span>-&gt;<span class="w"> </span>BroadcastQueue.sendPendingBroadcastsLocked<span class="w"> </span>-&gt;<span class="w"> </span>BroadcastQueue.processCurBroadcastLocked<span class="w"> </span>-&gt;<span class="w"> </span>ActivityThread.scheduleReceiver<span class="w"> </span>-&gt;<span class="w"> </span>ActivityThread.handleReceiver<span class="w"> </span>-&gt;<span class="w"> </span>BroadcastReceiver.onReceive<span class="o">(</span>触发广播接收者的onReceive方法<span class="o">)</span>
</span><span id="__span-83-3"><a id="__codelineno-83-3" name="__codelineno-83-3" href="#__codelineno-83-3"></a>-&gt;<span class="w"> </span>ReceiverData.finishReceiver<span class="w"> </span>-&gt;<span class="w"> </span>AMS.finishReceiver
</span></code></pre></div>
<p>进程的创建流程不是本主题的重点，APP启动后会调用ActivityManagerService的sendPendingBroadcastsLocked方法。</p>
<h6 id="amssendpendingbroadcastslocked"># AMS.sendPendingBroadcastsLocked<a class="headerlink" href="#amssendpendingbroadcastslocked" title="Permanent link">&para;</a></h6>
<div class="language-java highlight"><pre><span></span><code><span id="__span-84-1"><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a><span class="c1">// The app just attached; send any pending broadcasts that it should receive</span>
</span><span id="__span-84-2"><a id="__codelineno-84-2" name="__codelineno-84-2" href="#__codelineno-84-2"></a><span class="kt">boolean</span><span class="w"> </span><span class="nf">sendPendingBroadcastsLocked</span><span class="p">(</span><span class="n">ProcessRecord</span><span class="w"> </span><span class="n">app</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-84-3"><a id="__codelineno-84-3" name="__codelineno-84-3" href="#__codelineno-84-3"></a><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">didSomething</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-84-4"><a id="__codelineno-84-4" name="__codelineno-84-4" href="#__codelineno-84-4"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">BroadcastQueue</span><span class="w"> </span><span class="n">queue</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">mBroadcastQueues</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-84-5"><a id="__codelineno-84-5" name="__codelineno-84-5" href="#__codelineno-84-5"></a><span class="w">        </span><span class="n">didSomething</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">queue</span><span class="p">.</span><span class="na">sendPendingBroadcastsLocked</span><span class="p">(</span><span class="n">app</span><span class="p">);</span>
</span><span id="__span-84-6"><a id="__codelineno-84-6" name="__codelineno-84-6" href="#__codelineno-84-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-84-7"><a id="__codelineno-84-7" name="__codelineno-84-7" href="#__codelineno-84-7"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">didSomething</span><span class="p">;</span>
</span><span id="__span-84-8"><a id="__codelineno-84-8" name="__codelineno-84-8" href="#__codelineno-84-8"></a><span class="p">}</span>
</span></code></pre></div>
<h6 id="broadcastqueuesendpendingbroadcastslocked">BroadcastQueue.sendPendingBroadcastsLocked<a class="headerlink" href="#broadcastqueuesendpendingbroadcastslocked" title="Permanent link">&para;</a></h6>
<div class="language-java highlight"><pre><span></span><code><span id="__span-85-1"><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">sendPendingBroadcastsLocked</span><span class="p">(</span><span class="n">ProcessRecord</span><span class="w"> </span><span class="n">app</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-85-2"><a id="__codelineno-85-2" name="__codelineno-85-2" href="#__codelineno-85-2"></a><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">didSomething</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-85-3"><a id="__codelineno-85-3" name="__codelineno-85-3" href="#__codelineno-85-3"></a><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="w"> </span><span class="n">br</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mPendingBroadcast</span><span class="p">;</span>
</span><span id="__span-85-4"><a id="__codelineno-85-4" name="__codelineno-85-4" href="#__codelineno-85-4"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">br</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">br</span><span class="p">.</span><span class="na">curApp</span><span class="p">.</span><span class="na">getPid</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">br</span><span class="p">.</span><span class="na">curApp</span><span class="p">.</span><span class="na">getPid</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">app</span><span class="p">.</span><span class="na">getPid</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-85-5"><a id="__codelineno-85-5" name="__codelineno-85-5" href="#__codelineno-85-5"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">br</span><span class="p">.</span><span class="na">curApp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">app</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-85-6"><a id="__codelineno-85-6" name="__codelineno-85-6" href="#__codelineno-85-6"></a><span class="w">                </span><span class="n">Slog</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;App mismatch when sending pending broadcast to &quot;</span>
</span><span id="__span-85-7"><a id="__codelineno-85-7" name="__codelineno-85-7" href="#__codelineno-85-7"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">app</span><span class="p">.</span><span class="na">processName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, intended target is &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">br</span><span class="p">.</span><span class="na">curApp</span><span class="p">.</span><span class="na">processName</span><span class="p">);</span>
</span><span id="__span-85-8"><a id="__codelineno-85-8" name="__codelineno-85-8" href="#__codelineno-85-8"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-85-9"><a id="__codelineno-85-9" name="__codelineno-85-9" href="#__codelineno-85-9"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-85-10"><a id="__codelineno-85-10" name="__codelineno-85-10" href="#__codelineno-85-10"></a><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-85-11"><a id="__codelineno-85-11" name="__codelineno-85-11" href="#__codelineno-85-11"></a><span class="w">                </span><span class="n">mPendingBroadcast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-85-12"><a id="__codelineno-85-12" name="__codelineno-85-12" href="#__codelineno-85-12"></a><span class="w">                </span><span class="n">processCurBroadcastLocked</span><span class="p">(</span><span class="n">br</span><span class="p">,</span><span class="w"> </span><span class="n">app</span><span class="p">,</span>
</span><span id="__span-85-13"><a id="__codelineno-85-13" name="__codelineno-85-13" href="#__codelineno-85-13"></a><span class="w">                        </span><span class="n">BROADCAST_DELIVERY_EVENT_REPORTED__RECEIVER_TYPE__MANIFEST</span><span class="p">,</span>
</span><span id="__span-85-14"><a id="__codelineno-85-14" name="__codelineno-85-14" href="#__codelineno-85-14"></a><span class="w">                        </span><span class="n">BROADCAST_DELIVERY_EVENT_REPORTED__PROC_START_TYPE__PROCESS_START_TYPE_COLD</span><span class="p">);</span>
</span><span id="__span-85-15"><a id="__codelineno-85-15" name="__codelineno-85-15" href="#__codelineno-85-15"></a><span class="w">                </span><span class="n">didSomething</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-85-16"><a id="__codelineno-85-16" name="__codelineno-85-16" href="#__codelineno-85-16"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-85-17"><a id="__codelineno-85-17" name="__codelineno-85-17" href="#__codelineno-85-17"></a><span class="w">                </span><span class="n">Slog</span><span class="p">.</span><span class="na">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Exception in new application when starting receiver &quot;</span>
</span><span id="__span-85-18"><a id="__codelineno-85-18" name="__codelineno-85-18" href="#__codelineno-85-18"></a><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">br</span><span class="p">.</span><span class="na">curComponent</span><span class="p">.</span><span class="na">flattenToShortString</span><span class="p">(),</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
</span><span id="__span-85-19"><a id="__codelineno-85-19" name="__codelineno-85-19" href="#__codelineno-85-19"></a><span class="w">                </span><span class="n">logBroadcastReceiverDiscardLocked</span><span class="p">(</span><span class="n">br</span><span class="p">);</span>
</span><span id="__span-85-20"><a id="__codelineno-85-20" name="__codelineno-85-20" href="#__codelineno-85-20"></a><span class="w">                </span><span class="n">finishReceiverLocked</span><span class="p">(</span><span class="n">br</span><span class="p">,</span><span class="w"> </span><span class="n">br</span><span class="p">.</span><span class="na">resultCode</span><span class="p">,</span><span class="w"> </span><span class="n">br</span><span class="p">.</span><span class="na">resultData</span><span class="p">,</span>
</span><span id="__span-85-21"><a id="__codelineno-85-21" name="__codelineno-85-21" href="#__codelineno-85-21"></a><span class="w">                        </span><span class="n">br</span><span class="p">.</span><span class="na">resultExtras</span><span class="p">,</span><span class="w"> </span><span class="n">br</span><span class="p">.</span><span class="na">resultAbort</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
</span><span id="__span-85-22"><a id="__codelineno-85-22" name="__codelineno-85-22" href="#__codelineno-85-22"></a><span class="w">                </span><span class="n">scheduleBroadcastsLocked</span><span class="p">();</span>
</span><span id="__span-85-23"><a id="__codelineno-85-23" name="__codelineno-85-23" href="#__codelineno-85-23"></a><span class="w">                </span><span class="c1">// We need to reset the state if we failed to start the receiver.</span>
</span><span id="__span-85-24"><a id="__codelineno-85-24" name="__codelineno-85-24" href="#__codelineno-85-24"></a><span class="w">                </span><span class="n">br</span><span class="p">.</span><span class="na">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BroadcastRecord</span><span class="p">.</span><span class="na">IDLE</span><span class="p">;</span>
</span><span id="__span-85-25"><a id="__codelineno-85-25" name="__codelineno-85-25" href="#__codelineno-85-25"></a><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
</span><span id="__span-85-26"><a id="__codelineno-85-26" name="__codelineno-85-26" href="#__codelineno-85-26"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-85-27"><a id="__codelineno-85-27" name="__codelineno-85-27" href="#__codelineno-85-27"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-85-28"><a id="__codelineno-85-28" name="__codelineno-85-28" href="#__codelineno-85-28"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">didSomething</span><span class="p">;</span>
</span><span id="__span-85-29"><a id="__codelineno-85-29" name="__codelineno-85-29" href="#__codelineno-85-29"></a><span class="w">    </span><span class="p">}</span>
</span></code></pre></div>
<p>又看到熟悉的代码了，调用processCurBroadcastLocked函数进行处理。</p>
<h2 id="_48">扩展<a class="headerlink" href="#_48" title="Permanent link">&para;</a></h2>
<h3 id="_49">命令<a class="headerlink" href="#_49" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>dumpsys activity broadcasts</p>
</li>
<li>
<p>Registered Receivers: 列出所有已注册的receivers列表</p>
</li>
</ul>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-86-1"><a id="__codelineno-86-1" name="__codelineno-86-1" href="#__codelineno-86-1"></a>Registered<span class="w"> </span>Receivers:
</span><span id="__span-86-2"><a id="__codelineno-86-2" name="__codelineno-86-2" href="#__codelineno-86-2"></a><span class="w">  </span>*<span class="w"> </span>ReceiverList<span class="o">{</span>e27a9e9<span class="w"> </span><span class="m">7522</span><span class="w"> </span>com.iflytek.inputmethod.miui/10267/u0<span class="w"> </span>remote:2779270<span class="o">}</span>
</span><span id="__span-86-3"><a id="__codelineno-86-3" name="__codelineno-86-3" href="#__codelineno-86-3"></a><span class="w">    </span><span class="nv">app</span><span class="o">=</span><span class="m">7522</span>:com.iflytek.inputmethod.miui/u0a267<span class="w"> </span><span class="nv">pid</span><span class="o">=</span><span class="m">7522</span><span class="w"> </span><span class="nv">uid</span><span class="o">=</span><span class="m">10267</span><span class="w"> </span><span class="nv">user</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-86-4"><a id="__codelineno-86-4" name="__codelineno-86-4" href="#__codelineno-86-4"></a><span class="w">    </span>Filter<span class="w"> </span><span class="c1">#0: BroadcastFilter{fde866e}</span>
</span><span id="__span-86-5"><a id="__codelineno-86-5" name="__codelineno-86-5" href="#__codelineno-86-5"></a><span class="w">      </span>Action:<span class="w"> </span><span class="s2">&quot;android.intent.action.CLOSE_SYSTEM_DIALOGS&quot;</span>
</span><span id="__span-86-6"><a id="__codelineno-86-6" name="__codelineno-86-6" href="#__codelineno-86-6"></a><span class="w">  </span>*<span class="w"> </span>ReceiverList<span class="o">{</span>92b6fe2<span class="w"> </span><span class="m">7522</span><span class="w"> </span>com.iflytek.inputmethod.miui/10267/u0<span class="w"> </span>remote:a140ad<span class="o">}</span>
</span><span id="__span-86-7"><a id="__codelineno-86-7" name="__codelineno-86-7" href="#__codelineno-86-7"></a><span class="w">    </span><span class="nv">app</span><span class="o">=</span><span class="m">7522</span>:com.iflytek.inputmethod.miui/u0a267<span class="w"> </span><span class="nv">pid</span><span class="o">=</span><span class="m">7522</span><span class="w"> </span><span class="nv">uid</span><span class="o">=</span><span class="m">10267</span><span class="w"> </span><span class="nv">user</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-86-8"><a id="__codelineno-86-8" name="__codelineno-86-8" href="#__codelineno-86-8"></a><span class="w">    </span>Filter<span class="w"> </span><span class="c1">#0: BroadcastFilter{e61af73}</span>
</span><span id="__span-86-9"><a id="__codelineno-86-9" name="__codelineno-86-9" href="#__codelineno-86-9"></a><span class="w">      </span>Action:<span class="w"> </span><span class="s2">&quot;android.net.conn.CONNECTIVITY_CHANGE&quot;</span>
</span></code></pre></div>
<ul>
<li>Receiver Resolver Table: receiver的解析表</li>
</ul>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-87-1"><a id="__codelineno-87-1" name="__codelineno-87-1" href="#__codelineno-87-1"></a>Receiver<span class="w"> </span>Resolver<span class="w"> </span>Table:
</span><span id="__span-87-2"><a id="__codelineno-87-2" name="__codelineno-87-2" href="#__codelineno-87-2"></a><span class="w">    </span>android.intent.action.CLOSE_SYSTEM_DIALOGS:
</span><span id="__span-87-3"><a id="__codelineno-87-3" name="__codelineno-87-3" href="#__codelineno-87-3"></a><span class="w">      </span>BroadcastFilter<span class="o">{</span>139a975<span class="w"> </span><span class="m">1000</span>/u0<span class="w"> </span>ReceiverList<span class="o">{</span>252e8ac<span class="w"> </span><span class="m">1836</span><span class="w"> </span>system/1000/u0<span class="w"> </span>local:f0f565f<span class="o">}}</span>
</span><span id="__span-87-4"><a id="__codelineno-87-4" name="__codelineno-87-4" href="#__codelineno-87-4"></a><span class="w">      </span>BroadcastFilter<span class="o">{</span>a385100<span class="w"> </span><span class="m">1000</span>/u0<span class="w"> </span>ReceiverList<span class="o">{</span>a9b83<span class="w"> </span><span class="m">1836</span><span class="w"> </span>system/1000/u0<span class="w"> </span>local:9134232<span class="o">}}</span>
</span><span id="__span-87-5"><a id="__codelineno-87-5" name="__codelineno-87-5" href="#__codelineno-87-5"></a><span class="w">      </span>BroadcastFilter<span class="o">{</span>1da9d23<span class="w"> </span><span class="m">1000</span>/u-1<span class="w"> </span>ReceiverList<span class="o">{</span>e41c652<span class="w"> </span><span class="m">1836</span><span class="w"> </span>system/1000/u-1<span class="w"> </span>local:aba2add<span class="o">}}</span>
</span><span id="__span-87-6"><a id="__codelineno-87-6" name="__codelineno-87-6" href="#__codelineno-87-6"></a><span class="w">      </span>BroadcastFilter<span class="o">{</span>431578f<span class="w"> </span><span class="m">1000</span>/u0<span class="w"> </span>ReceiverList<span class="o">{</span>7a676ee<span class="w"> </span><span class="m">3687</span><span class="w"> </span>com.android.systemui/1000/u0<span class="w"> </span>remote:64f0c69<span class="o">}}</span>
</span><span id="__span-87-7"><a id="__codelineno-87-7" name="__codelineno-87-7" href="#__codelineno-87-7"></a><span class="w">      </span>BroadcastFilter<span class="o">{</span>ed9a812<span class="w"> </span><span class="m">1000</span>/u0<span class="w"> </span>ReceiverList<span class="o">{</span>6a17b9d<span class="w"> </span><span class="m">3687</span><span class="w"> </span>com.android.systemui/1000/u0<span class="w"> </span>remote:11b8a74<span class="o">}}</span>
</span><span id="__span-87-8"><a id="__codelineno-87-8" name="__codelineno-87-8" href="#__codelineno-87-8"></a><span class="w">      </span>BroadcastFilter<span class="o">{</span>c50990f<span class="w"> </span><span class="m">1000</span>/u-1<span class="w"> </span>ReceiverList<span class="o">{</span>29bce6e<span class="w"> </span><span class="m">3687</span><span class="w"> </span>com.android.systemui/1000/u-1<span class="w"> </span>remote:bed11e9<span class="o">}}</span>
</span><span id="__span-87-9"><a id="__codelineno-87-9" name="__codelineno-87-9" href="#__codelineno-87-9"></a><span class="w">      </span>BroadcastFilter<span class="o">{</span>a6b8070<span class="w"> </span><span class="m">1000</span>/u0<span class="w"> </span>ReceiverList<span class="o">{</span>8b822b3<span class="w"> </span><span class="m">3687</span><span class="w"> </span>com.android.systemui/1000/u0<span class="w"> </span>remote:252a822<span class="o">}}</span>
</span><span id="__span-87-10"><a id="__codelineno-87-10" name="__codelineno-87-10" href="#__codelineno-87-10"></a><span class="w">      </span>BroadcastFilter<span class="o">{</span>fde866e<span class="w"> </span><span class="m">10267</span>/u0<span class="w"> </span>ReceiverList<span class="o">{</span>e27a9e9<span class="w"> </span><span class="m">7522</span><span class="w"> </span>com.iflytek.inputmethod.miui/10267/u0<span class="w"> </span>remote:2779270<span class="o">}}</span>
</span><span id="__span-87-11"><a id="__codelineno-87-11" name="__codelineno-87-11" href="#__codelineno-87-11"></a><span class="w">      </span>BroadcastFilter<span class="o">{</span>55a4b6d<span class="w"> </span><span class="m">1000</span>/u0<span class="w"> </span>ReceiverList<span class="o">{</span><span class="m">4197784</span><span class="w"> </span><span class="m">7416</span><span class="w"> </span>com.miui.securitycenter.remote/1000/u0<span class="w"> </span>remote:19df997<span class="o">}}</span>
</span><span id="__span-87-12"><a id="__codelineno-87-12" name="__codelineno-87-12" href="#__codelineno-87-12"></a><span class="w">      </span>BroadcastFilter<span class="o">{</span>3e759c8<span class="w"> </span><span class="m">1000</span>/u0<span class="w"> </span>ReceiverList<span class="o">{</span>7b0aa6b<span class="w"> </span><span class="m">7416</span><span class="w"> </span>com.miui.securitycenter.remote/1000/u0<span class="w"> </span>remote:2ee1bba<span class="o">}}</span>
</span><span id="__span-87-13"><a id="__codelineno-87-13" name="__codelineno-87-13" href="#__codelineno-87-13"></a><span class="w">      </span>BroadcastFilter<span class="o">{</span>56d5f61<span class="w"> </span><span class="m">1000</span>/u0<span class="w"> </span>ReceiverList<span class="o">{</span>24552c8<span class="w"> </span><span class="m">7416</span><span class="w"> </span>com.miui.securitycenter.remote/1000/u0<span class="w"> </span>remote:756e76b<span class="o">}}</span>
</span><span id="__span-87-14"><a id="__codelineno-87-14" name="__codelineno-87-14" href="#__codelineno-87-14"></a><span class="w">      </span>BroadcastFilter<span class="o">{</span><span class="m">3407249</span><span class="w"> </span><span class="m">10296</span>/u0<span class="w"> </span>ReceiverList<span class="o">{</span>28ec050<span class="w"> </span><span class="m">13759</span><span class="w"> </span>com.journeyOS.edge/10296/u0<span class="w"> </span>remote:322f613<span class="o">}}</span>
</span><span id="__span-87-15"><a id="__codelineno-87-15" name="__codelineno-87-15" href="#__codelineno-87-15"></a><span class="w">      </span>BroadcastFilter<span class="o">{</span>582dd19<span class="w"> </span><span class="m">10155</span>/u0<span class="w"> </span>ReceiverList<span class="o">{</span>f1fd460<span class="w"> </span><span class="m">3412</span><span class="w"> </span>com.miui.systemAdSolution/10155/u0<span class="w"> </span>remote:55a9063<span class="o">}}</span>
</span><span id="__span-87-16"><a id="__codelineno-87-16" name="__codelineno-87-16" href="#__codelineno-87-16"></a><span class="w">      </span>BroadcastFilter<span class="o">{</span>65b4041<span class="w"> </span><span class="m">10164</span>/u0<span class="w"> </span>ReceiverList<span class="o">{</span>f6cab28<span class="w"> </span><span class="m">25413</span><span class="w"> </span>com.miui.voiceassist/10164/u0<span class="w"> </span>remote:35ce54b<span class="o">}}</span>
</span><span id="__span-87-17"><a id="__codelineno-87-17" name="__codelineno-87-17" href="#__codelineno-87-17"></a><span class="w">      </span>BroadcastFilter<span class="o">{</span><span class="m">2848708</span><span class="w"> </span><span class="m">10164</span>/u0<span class="w"> </span>ReceiverList<span class="o">{</span>77d44ab<span class="w"> </span><span class="m">25413</span><span class="w"> </span>com.miui.voiceassist/10164/u0<span class="w"> </span>remote:87fb6fa<span class="o">}}</span>
</span><span id="__span-87-18"><a id="__codelineno-87-18" name="__codelineno-87-18" href="#__codelineno-87-18"></a><span class="w">      </span>BroadcastFilter<span class="o">{</span>f601940<span class="w"> </span><span class="m">10270</span>/u0<span class="w"> </span>ReceiverList<span class="o">{</span>3cf5cc3<span class="w"> </span><span class="m">32227</span><span class="w"> </span>com.tencent.mm:appbrand2/10270/u0<span class="w"> </span>remote:a594072<span class="o">}}</span>
</span><span id="__span-87-19"><a id="__codelineno-87-19" name="__codelineno-87-19" href="#__codelineno-87-19"></a><span class="w">      </span>BroadcastFilter<span class="o">{</span>b1ce8e<span class="w"> </span><span class="m">10171</span>/u0<span class="w"> </span>ReceiverList<span class="o">{</span>3d87e89<span class="w"> </span><span class="m">23970</span><span class="w"> </span>com.xiaomi.market/10171/u0<span class="w"> </span>remote:c0a5590<span class="o">}}</span>
</span></code></pre></div>
<ul>
<li>Historical broadcasts [foreground]: 前台广播历史记录</li>
</ul>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-88-1"><a id="__codelineno-88-1" name="__codelineno-88-1" href="#__codelineno-88-1"></a>Historical<span class="w"> </span>broadcasts<span class="w"> </span><span class="o">[</span>foreground<span class="o">]</span>:
</span><span id="__span-88-2"><a id="__codelineno-88-2" name="__codelineno-88-2" href="#__codelineno-88-2"></a><span class="w">  </span>Historical<span class="w"> </span>Broadcast<span class="w"> </span>foreground<span class="w"> </span><span class="c1">#1:// 前台广播队列第一条广播</span>
</span><span id="__span-88-3"><a id="__codelineno-88-3" name="__codelineno-88-3" href="#__codelineno-88-3"></a><span class="w">    </span>BroadcastRecord<span class="o">{</span>12fbe7c<span class="w"> </span>u-1<span class="w"> </span>android.hardware.usb.action.USB_STATE<span class="o">}</span><span class="w"> </span>to<span class="w"> </span>user<span class="w"> </span>-1<span class="w"> </span>//-1代表user_all
</span><span id="__span-88-4"><a id="__codelineno-88-4" name="__codelineno-88-4" href="#__codelineno-88-4"></a><span class="w">    </span>Intent<span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="nv">act</span><span class="o">=</span>android.hardware.usb.action.USB_STATE<span class="w"> </span><span class="nv">flg</span><span class="o">=</span>0x31000010<span class="w"> </span><span class="o">(</span>has<span class="w"> </span>extras<span class="o">)</span><span class="w"> </span><span class="o">}</span>//flag
</span><span id="__span-88-5"><a id="__codelineno-88-5" name="__codelineno-88-5" href="#__codelineno-88-5"></a><span class="w">      </span>extras:<span class="w"> </span>Bundle<span class="o">[{</span><span class="nv">host_connected</span><span class="o">=</span>false,<span class="w"> </span><span class="nv">connected</span><span class="o">=</span>true,<span class="w"> </span><span class="nv">unlocked</span><span class="o">=</span>false,<span class="w"> </span><span class="nv">adb</span><span class="o">=</span>true,<span class="w"> </span><span class="nv">configured</span><span class="o">=</span>true<span class="o">}]</span>
</span><span id="__span-88-6"><a id="__codelineno-88-6" name="__codelineno-88-6" href="#__codelineno-88-6"></a><span class="w">    </span><span class="nv">caller</span><span class="o">=</span>android<span class="w"> </span><span class="m">1836</span>:system/1000<span class="w"> </span><span class="nv">pid</span><span class="o">=</span><span class="m">1836</span><span class="w"> </span><span class="nv">uid</span><span class="o">=</span><span class="m">1000</span>//发送广播app的信息
</span><span id="__span-88-7"><a id="__codelineno-88-7" name="__codelineno-88-7" href="#__codelineno-88-7"></a><span class="w">    </span><span class="nv">enqueueClockTime</span><span class="o">=</span><span class="m">2022</span>-11-17<span class="w"> </span><span class="m">15</span>:44:28.352<span class="w"> </span><span class="nv">dispatchClockTime</span><span class="o">=</span><span class="m">2022</span>-11-17<span class="w"> </span><span class="m">15</span>:44:28.681
</span><span id="__span-88-8"><a id="__codelineno-88-8" name="__codelineno-88-8" href="#__codelineno-88-8"></a><span class="w">    </span><span class="nv">dispatchTime</span><span class="o">=</span>-2m56s517ms<span class="w"> </span><span class="o">(</span>+329ms<span class="w"> </span>since<span class="w"> </span>enq<span class="o">)</span><span class="w"> </span><span class="nv">finishTime</span><span class="o">=</span>-2m56s506ms<span class="w"> </span><span class="o">(</span>+11ms<span class="w"> </span>since<span class="w"> </span>disp<span class="o">)</span>//<span class="w"> </span>分发用时<span class="w"> </span>、<span class="w"> </span>结束时间<span class="w"> </span>
</span><span id="__span-88-9"><a id="__codelineno-88-9" name="__codelineno-88-9" href="#__codelineno-88-9"></a><span class="w">    </span><span class="nv">resultTo</span><span class="o">=</span>null<span class="w"> </span><span class="nv">resultCode</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">resultData</span><span class="o">=</span>null//<span class="w"> </span>一般resultCode为0且resultTo为null且无ordered为false表示静态注册的无序广播
</span><span id="__span-88-10"><a id="__codelineno-88-10" name="__codelineno-88-10" href="#__codelineno-88-10"></a><span class="w">    </span><span class="nv">resultAbort</span><span class="o">=</span><span class="nb">false</span><span class="w"> </span><span class="nv">ordered</span><span class="o">=</span><span class="nb">false</span><span class="w"> </span><span class="nv">sticky</span><span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="nv">initialSticky</span><span class="o">=</span><span class="nb">false</span>
</span><span id="__span-88-11"><a id="__codelineno-88-11" name="__codelineno-88-11" href="#__codelineno-88-11"></a><span class="w">    </span><span class="nv">nextReceiver</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">receiver</span><span class="o">=</span>null
</span><span id="__span-88-12"><a id="__codelineno-88-12" name="__codelineno-88-12" href="#__codelineno-88-12"></a><span class="w">    </span>Deliver<span class="w"> </span>+5ms<span class="w"> </span><span class="c1">#0: (manifest)//派发给静态注册的receiver</span>
</span><span id="__span-88-13"><a id="__codelineno-88-13" name="__codelineno-88-13" href="#__codelineno-88-13"></a><span class="w">      </span><span class="nv">priority</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">preferredOrder</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">match</span><span class="o">=</span>0x108000<span class="w"> </span><span class="nv">specificIndex</span><span class="o">=</span>-1<span class="w"> </span><span class="nv">isDefault</span><span class="o">=</span><span class="nb">false</span>
</span><span id="__span-88-14"><a id="__codelineno-88-14" name="__codelineno-88-14" href="#__codelineno-88-14"></a><span class="w">      </span>ActivityInfo:
</span><span id="__span-88-15"><a id="__codelineno-88-15" name="__codelineno-88-15" href="#__codelineno-88-15"></a><span class="w">        </span><span class="nv">name</span><span class="o">=</span>com.android.mtp.MtpReceiver
</span><span id="__span-88-16"><a id="__codelineno-88-16" name="__codelineno-88-16" href="#__codelineno-88-16"></a><span class="w">        </span><span class="nv">packageName</span><span class="o">=</span>com.android.mtp
</span><span id="__span-88-17"><a id="__codelineno-88-17" name="__codelineno-88-17" href="#__codelineno-88-17"></a><span class="w">        </span><span class="nv">processName</span><span class="o">=</span>android.process.media
</span><span id="__span-88-18"><a id="__codelineno-88-18" name="__codelineno-88-18" href="#__codelineno-88-18"></a><span class="w">        </span><span class="nv">enabled</span><span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="nv">exported</span><span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="nv">directBootAware</span><span class="o">=</span><span class="nb">false</span>
</span><span id="__span-88-19"><a id="__codelineno-88-19" name="__codelineno-88-19" href="#__codelineno-88-19"></a><span class="w">        </span><span class="nv">resizeMode</span><span class="o">=</span>RESIZE_MODE_RESIZEABLE
</span><span id="__span-88-20"><a id="__codelineno-88-20" name="__codelineno-88-20" href="#__codelineno-88-20"></a><span class="w">    </span>Deliver<span class="w"> </span>+6ms<span class="w"> </span><span class="c1">#1: (manifest)</span>
</span><span id="__span-88-21"><a id="__codelineno-88-21" name="__codelineno-88-21" href="#__codelineno-88-21"></a><span class="w">      </span><span class="nv">priority</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">preferredOrder</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">match</span><span class="o">=</span>0x108000<span class="w"> </span><span class="nv">specificIndex</span><span class="o">=</span>-1<span class="w"> </span><span class="nv">isDefault</span><span class="o">=</span>false//优先级默认为0
</span><span id="__span-88-22"><a id="__codelineno-88-22" name="__codelineno-88-22" href="#__codelineno-88-22"></a><span class="w">      </span>ActivityInfo://<span class="w"> </span>receiver的信息
</span><span id="__span-88-23"><a id="__codelineno-88-23" name="__codelineno-88-23" href="#__codelineno-88-23"></a><span class="w">        </span><span class="nv">name</span><span class="o">=</span>com.android.settings.connecteddevice.usb.UsbModeChooserReceiver
</span><span id="__span-88-24"><a id="__codelineno-88-24" name="__codelineno-88-24" href="#__codelineno-88-24"></a><span class="w">        </span><span class="nv">packageName</span><span class="o">=</span>com.android.settings
</span><span id="__span-88-25"><a id="__codelineno-88-25" name="__codelineno-88-25" href="#__codelineno-88-25"></a><span class="w">        </span><span class="nv">enabled</span><span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="nv">exported</span><span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="nv">directBootAware</span><span class="o">=</span><span class="nb">true</span>
</span><span id="__span-88-26"><a id="__codelineno-88-26" name="__codelineno-88-26" href="#__codelineno-88-26"></a><span class="w">        </span><span class="nv">resizeMode</span><span class="o">=</span>RESIZE_MODE_RESIZEABLE
</span></code></pre></div>
<p>这里没看到“requiredPermissions”，如果需要权限，还应该有如下关键信息</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-89-1"><a id="__codelineno-89-1" name="__codelineno-89-1" href="#__codelineno-89-1"></a><span class="nv">requiredPermissions</span><span class="o">=[</span>android.permission.READ_NETWORK_USAGE_HISTORY<span class="o">]</span><span class="w">  </span><span class="nv">appOp</span><span class="o">=</span>-1
</span></code></pre></div>
<p>下面再举例有序广播的例子：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-90-1"><a id="__codelineno-90-1" name="__codelineno-90-1" href="#__codelineno-90-1"></a>Historical<span class="w"> </span>Broadcast<span class="w"> </span>background<span class="w"> </span><span class="c1">#12: //后台广播队列第12条</span>
</span><span id="__span-90-2"><a id="__codelineno-90-2" name="__codelineno-90-2" href="#__codelineno-90-2"></a><span class="w">    </span>BroadcastRecord<span class="o">{</span>23a1e41<span class="w"> </span>u-1<span class="w"> </span>android.intent.action.BATTERY_CHANGED<span class="o">}</span><span class="w"> </span>to<span class="w"> </span>user<span class="w"> </span>-1<span class="w"> </span>//<span class="w"> </span>-1代表user_all
</span><span id="__span-90-3"><a id="__codelineno-90-3" name="__codelineno-90-3" href="#__codelineno-90-3"></a><span class="w">    </span>Intent<span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="nv">act</span><span class="o">=</span>android.intent.action.BATTERY_CHANGED<span class="w"> </span><span class="nv">flg</span><span class="o">=</span>0x60000010<span class="w"> </span><span class="o">(</span>has<span class="w"> </span>extras<span class="o">)</span><span class="w"> </span><span class="o">}</span><span class="w"> </span>//<span class="w"> </span>intent信息
</span><span id="__span-90-4"><a id="__codelineno-90-4" name="__codelineno-90-4" href="#__codelineno-90-4"></a><span class="w">      </span>extras:<span class="w"> </span>Bundle<span class="o">[{</span><span class="nv">technology</span><span class="o">=</span>Li-poly,<span class="w"> </span>icon-small<span class="o">=</span><span class="m">17303618</span>,<span class="w"> </span><span class="nv">max_charging_voltage</span><span class="o">=</span><span class="m">5000000</span>,<span class="w"> </span><span class="nv">health</span><span class="o">=</span><span class="m">2</span>,<span class="w"> </span><span class="nv">max_charging_current</span><span class="o">=</span><span class="m">3000000</span>,<span class="w"> </span><span class="nv">status</span><span class="o">=</span><span class="m">2</span>,<span class="w"> </span><span class="nv">plugged</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">present</span><span class="o">=</span>true,<span class="w"> </span><span class="nv">seq</span><span class="o">=</span><span class="m">1622</span>,<span class="w"> </span><span class="nv">charge_counter</span><span class="o">=</span><span class="m">3692780</span>,<span class="w"> </span><span class="nv">level</span><span class="o">=</span><span class="m">91</span>,<span class="w"> </span><span class="nv">scale</span><span class="o">=</span><span class="m">100</span>,<span class="w"> </span><span class="nv">temperature</span><span class="o">=</span><span class="m">260</span>,<span class="w"> </span><span class="nv">voltage</span><span class="o">=</span><span class="m">4433</span>,<span class="w"> </span><span class="nv">invalid_charger</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">battery_low</span><span class="o">=</span>false<span class="o">}]</span>
</span><span id="__span-90-5"><a id="__codelineno-90-5" name="__codelineno-90-5" href="#__codelineno-90-5"></a><span class="w">    </span><span class="nv">caller</span><span class="o">=</span>null<span class="w"> </span>null<span class="w"> </span><span class="nv">pid</span><span class="o">=</span><span class="m">1836</span><span class="w"> </span><span class="nv">uid</span><span class="o">=</span><span class="m">1000</span><span class="w"> </span>//<span class="w"> </span>发送广播app的信息
</span><span id="__span-90-6"><a id="__codelineno-90-6" name="__codelineno-90-6" href="#__codelineno-90-6"></a><span class="w">    </span><span class="nv">enqueueClockTime</span><span class="o">=</span><span class="m">2022</span>-11-17<span class="w"> </span><span class="m">15</span>:44:50.357<span class="w"> </span><span class="nv">dispatchClockTime</span><span class="o">=</span><span class="m">2022</span>-11-17<span class="w"> </span><span class="m">15</span>:44:50.357<span class="w"> </span>//<span class="w"> </span>入队时间和分发时间
</span><span id="__span-90-7"><a id="__codelineno-90-7" name="__codelineno-90-7" href="#__codelineno-90-7"></a><span class="w">    </span><span class="nv">dispatchTime</span><span class="o">=</span>-2m34s878ms<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>since<span class="w"> </span>enq<span class="o">)</span><span class="w"> </span><span class="nv">finishTime</span><span class="o">=</span>-2m34s859ms<span class="w"> </span><span class="o">(</span>+19ms<span class="w"> </span>since<span class="w"> </span>disp<span class="o">)</span><span class="w">  </span>//<span class="w"> </span>分发用时<span class="w"> </span>、结束时间
</span><span id="__span-90-8"><a id="__codelineno-90-8" name="__codelineno-90-8" href="#__codelineno-90-8"></a><span class="w">    </span><span class="nv">resultAbort</span><span class="o">=</span><span class="nb">false</span><span class="w"> </span><span class="nv">ordered</span><span class="o">=</span><span class="nb">false</span><span class="w"> </span><span class="nv">sticky</span><span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="nv">initialSticky</span><span class="o">=</span><span class="nb">false</span>
</span><span id="__span-90-9"><a id="__codelineno-90-9" name="__codelineno-90-9" href="#__codelineno-90-9"></a><span class="w">    </span>//<span class="w"> </span>分发每一个receiver的分发信息以及状态
</span><span id="__span-90-10"><a id="__codelineno-90-10" name="__codelineno-90-10" href="#__codelineno-90-10"></a><span class="w">    </span>//<span class="w"> </span>Deliver代表当前receiver已分发到
</span><span id="__span-90-11"><a id="__codelineno-90-11" name="__codelineno-90-11" href="#__codelineno-90-11"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#0: BroadcastFilter{702009b 1000/u0 ReceiverList{d32caa 3687 com.android.systemui/1000/u0 remote:ca25395}}</span>
</span><span id="__span-90-12"><a id="__codelineno-90-12" name="__codelineno-90-12" href="#__codelineno-90-12"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#1: BroadcastFilter{f3f7b8a 1000/u0 ReceiverList{9a511f5 4320 com.miui.aod/1000/u0 remote:220a32c}}</span>
</span><span id="__span-90-13"><a id="__codelineno-90-13" name="__codelineno-90-13" href="#__codelineno-90-13"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#2: BroadcastFilter{8e36b22 1000/u0 ReceiverList{91b20ed 4580 com.miui.aod:settings/1000/u0 remote:caa3304}}</span>
</span><span id="__span-90-14"><a id="__codelineno-90-14" name="__codelineno-90-14" href="#__codelineno-90-14"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#3: BroadcastFilter{690c74b 1000/u0 ReceiverList{9bb201a 1836 system/1000/u0 local:88d2ec5}}</span>
</span><span id="__span-90-15"><a id="__codelineno-90-15" name="__codelineno-90-15" href="#__codelineno-90-15"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#4: BroadcastFilter{9cd95f1 1000/u0 ReceiverList{c610998 1836 system/1000/u0 local:166f77b}}</span>
</span><span id="__span-90-16"><a id="__codelineno-90-16" name="__codelineno-90-16" href="#__codelineno-90-16"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#5: BroadcastFilter{6bc6320 1000/u0 ReceiverList{5e92223 9024 com.miui.powerkeeper/1000/u0 remote:9133f52}}</span>
</span><span id="__span-90-17"><a id="__codelineno-90-17" name="__codelineno-90-17" href="#__codelineno-90-17"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#6: BroadcastFilter{9d3ab0e 1000/u0 ReceiverList{c1dfd09 1836 system/1000/u0 local:514be10}}</span>
</span><span id="__span-90-18"><a id="__codelineno-90-18" name="__codelineno-90-18" href="#__codelineno-90-18"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#7: BroadcastFilter{281fba8 1000/u0 ReceiverList{82b27cb 1836 system/1000/u0 local:eb8b29a}}</span>
</span><span id="__span-90-19"><a id="__codelineno-90-19" name="__codelineno-90-19" href="#__codelineno-90-19"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#8: BroadcastFilter{750ef2a 1000/u0 ReceiverList{c4b9015 1836 system/1000/u0 local:8b7c5cc}}</span>
</span><span id="__span-90-20"><a id="__codelineno-90-20" name="__codelineno-90-20" href="#__codelineno-90-20"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#9: BroadcastFilter{c620732 1000/u0 ReceiverList{ae1633d 1836 system/1000/u0 local:a91cc94}}</span>
</span><span id="__span-90-21"><a id="__codelineno-90-21" name="__codelineno-90-21" href="#__codelineno-90-21"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#10: BroadcastFilter{f7e5ddf 1000/u0 ReceiverList{1a5647e 1836 system/1000/u0 local:905f639}}</span>
</span><span id="__span-90-22"><a id="__codelineno-90-22" name="__codelineno-90-22" href="#__codelineno-90-22"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#11: BroadcastFilter{6dd8a95 1000/u0 ReceiverList{bc31a4c 1836 system/1000/u0 local:280ca7f}}</span>
</span><span id="__span-90-23"><a id="__codelineno-90-23" name="__codelineno-90-23" href="#__codelineno-90-23"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#12: BroadcastFilter{d7c746e 1000/u0 ReceiverList{4f08fe9 1836 system/1000/u0 local:dc5070}}</span>
</span><span id="__span-90-24"><a id="__codelineno-90-24" name="__codelineno-90-24" href="#__codelineno-90-24"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#13: BroadcastFilter{3bdf32 6110/u0 ReceiverList{11b9b3d 3644 com.xiaomi.finddevice/6110/u0 remote:8f1e494}}</span>
</span><span id="__span-90-25"><a id="__codelineno-90-25" name="__codelineno-90-25" href="#__codelineno-90-25"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#14: BroadcastFilter{ac1e890 1000/u0 ReceiverList{b849753 3687 com.android.systemui/1000/u0 remote:3ab8b42}}</span>
</span><span id="__span-90-26"><a id="__codelineno-90-26" name="__codelineno-90-26" href="#__codelineno-90-26"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#15: BroadcastFilter{6cf0a78 1002/u0 ReceiverList{b7aefdb 3409 com.android.bluetooth/1002/u0 remote:d6950ea}}</span>
</span><span id="__span-90-27"><a id="__codelineno-90-27" name="__codelineno-90-27" href="#__codelineno-90-27"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#16: BroadcastFilter{bed2aee 1000/u0 ReceiverList{1701069 1836 system/1000/u0 local:69f82f0}}</span>
</span><span id="__span-90-28"><a id="__codelineno-90-28" name="__codelineno-90-28" href="#__codelineno-90-28"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#17: BroadcastFilter{f0507fa 1000/u0 ReceiverList{7704a25 1836 system/1000/u0 local:a91de1c}}</span>
</span><span id="__span-90-29"><a id="__codelineno-90-29" name="__codelineno-90-29" href="#__codelineno-90-29"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#18: BroadcastFilter{45519d1 1001/u0 ReceiverList{6c6b0f8 6950 com.miui.dmregservice/1001/u0 remote:87205b}}</span>
</span><span id="__span-90-30"><a id="__codelineno-90-30" name="__codelineno-90-30" href="#__codelineno-90-30"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#19: BroadcastFilter{acde4fa 1000/u0 ReceiverList{58e7b25 7416 com.miui.securitycenter.remote/1000/u0 remote:c76331c}}</span>
</span><span id="__span-90-31"><a id="__codelineno-90-31" name="__codelineno-90-31" href="#__codelineno-90-31"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#20: BroadcastFilter{20bc9b4 1000/u0 ReceiverList{85a7687 7416 com.miui.securitycenter.remote/1000/u0 remote:c8556c6}}</span>
</span><span id="__span-90-32"><a id="__codelineno-90-32" name="__codelineno-90-32" href="#__codelineno-90-32"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#21: BroadcastFilter{8d7795 1000/u0 ReceiverList{1ba9b4c 7416 com.miui.securitycenter.remote/1000/u0 remote:991af7f}}</span>
</span><span id="__span-90-33"><a id="__codelineno-90-33" name="__codelineno-90-33" href="#__codelineno-90-33"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#22: BroadcastFilter{80f07e4 1000/u0 ReceiverList{2680f77 7416 com.miui.securitycenter.remote/1000/u0 remote:4b6fd76}}</span>
</span><span id="__span-90-34"><a id="__codelineno-90-34" name="__codelineno-90-34" href="#__codelineno-90-34"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#23: BroadcastFilter{5db9849 1000/u0 ReceiverList{ba6be50 7416 com.miui.securitycenter.remote/1000/u0 remote:dc42c13}}</span>
</span><span id="__span-90-35"><a id="__codelineno-90-35" name="__codelineno-90-35" href="#__codelineno-90-35"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#24: BroadcastFilter{26eca43 1000/u0 ReceiverList{a43f3f2 9052 com.xiaomi.joyose/1000/u0 remote:180afd}}</span>
</span><span id="__span-90-36"><a id="__codelineno-90-36" name="__codelineno-90-36" href="#__codelineno-90-36"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#25: BroadcastFilter{e790cbf 1000/u0 ReceiverList{8f402de 9024 com.miui.powerkeeper/1000/u0 remote:9cc9219}}</span>
</span><span id="__span-90-37"><a id="__codelineno-90-37" name="__codelineno-90-37" href="#__codelineno-90-37"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#26: BroadcastFilter{bab5a56 10211/u0 ReceiverList{297cf8a 3663 com.qualcomm.qti.devicestatisticsservice/10211/u0 remote:49a35f5}}</span>
</span><span id="__span-90-38"><a id="__codelineno-90-38" name="__codelineno-90-38" href="#__codelineno-90-38"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#27: BroadcastFilter{310764e 10153/u0 ReceiverList{eded49 7119 com.miui.voicetrigger/10153/u0 remote:ae94750}}</span>
</span><span id="__span-90-39"><a id="__codelineno-90-39" name="__codelineno-90-39" href="#__codelineno-90-39"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#28: BroadcastFilter{6a5eb64 1000/u0 ReceiverList{e4650f7 9024 com.miui.powerkeeper/1000/u0 remote:f0754f6}}</span>
</span><span id="__span-90-40"><a id="__codelineno-90-40" name="__codelineno-90-40" href="#__codelineno-90-40"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#29: BroadcastFilter{e22ec6d 10153/u0 ReceiverList{bfc84 7119 com.miui.voicetrigger/10153/u0 remote:5637297}}</span>
</span><span id="__span-90-41"><a id="__codelineno-90-41" name="__codelineno-90-41" href="#__codelineno-90-41"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#30: BroadcastFilter{4a9f7f3 1000/u0 ReceiverList{2bd8a62 6974 com.miui.daemon/1000/u0 remote:c19352d}}</span>
</span><span id="__span-90-42"><a id="__codelineno-90-42" name="__codelineno-90-42" href="#__codelineno-90-42"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#31: BroadcastFilter{dec3de6 10296/u0 ReceiverList{6b43441 13759 com.journeyOS.edge/10296/u0 remote:e80ef28}}</span>
</span><span id="__span-90-43"><a id="__codelineno-90-43" name="__codelineno-90-43" href="#__codelineno-90-43"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#32: BroadcastFilter{a48a509 10296/u0 ReceiverList{c210610 14610 com.journeyOS.edge:push/10296/u0 remote:79fbad3}}</span>
</span><span id="__span-90-44"><a id="__codelineno-90-44" name="__codelineno-90-44" href="#__codelineno-90-44"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#33: BroadcastFilter{6065083 10137/u0 ReceiverList{188ab32 16861 com.xiaomi.metoknlp/10137/u0 remote:fac173d}}</span>
</span><span id="__span-90-45"><a id="__codelineno-90-45" name="__codelineno-90-45" href="#__codelineno-90-45"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#34: BroadcastFilter{1175a18 10270/u0 ReceiverList{5ba39fb 27689 com.tencent.mm:push/10270/u0 remote:28cef8a}}</span>
</span><span id="__span-90-46"><a id="__codelineno-90-46" name="__codelineno-90-46" href="#__codelineno-90-46"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#35: BroadcastFilter{b1b3a5 10270/u0 ReceiverList{ab8fd9c 28651 com.tencent.mm/10270/u0 remote:5fde90f}}</span>
</span><span id="__span-90-47"><a id="__codelineno-90-47" name="__codelineno-90-47" href="#__codelineno-90-47"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#36: BroadcastFilter{1bfe54a 10194/u0 ReceiverList{3220ab5 3621 org.codeaurora.ims/10194/u0 remote:b8706ec}}</span>
</span><span id="__span-90-48"><a id="__codelineno-90-48" name="__codelineno-90-48" href="#__codelineno-90-48"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#37: BroadcastFilter{66951a6 10296/u0 ReceiverList{6ee3f01 850 com.journeyOS.edge:core/10296/u0 remote:2056ce8}}</span>
</span><span id="__span-90-49"><a id="__codelineno-90-49" name="__codelineno-90-49" href="#__codelineno-90-49"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#38: BroadcastFilter{582dd19 10155/u0 ReceiverList{f1fd460 3412 com.miui.systemAdSolution/10155/u0 remote:55a9063}}</span>
</span><span id="__span-90-50"><a id="__codelineno-90-50" name="__codelineno-90-50" href="#__codelineno-90-50"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#39: BroadcastFilter{7dbc345 10270/u0 ReceiverList{54907bc 32227 com.tencent.mm:appbrand2/10270/u0 remote:b3d47af}}</span>
</span><span id="__span-90-51"><a id="__codelineno-90-51" name="__codelineno-90-51" href="#__codelineno-90-51"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#40: BroadcastFilter{c7ceb97 10291/u0 ReceiverList{8233616 4230 com.android.chrome/10291/u0 remote:ee82f31}}</span>
</span><span id="__span-90-52"><a id="__codelineno-90-52" name="__codelineno-90-52" href="#__codelineno-90-52"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#41: BroadcastFilter{d29701e 1000/u0 ReceiverList{16a6c59 3687 com.android.systemui/1000/u0 remote:73b18a0}}</span>
</span><span id="__span-90-53"><a id="__codelineno-90-53" name="__codelineno-90-53" href="#__codelineno-90-53"></a><span class="w">    </span>Deliver<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1">#42: BroadcastFilter{b2b2dad 10171/u0 ReceiverList{f737ac4 23970 com.xiaomi.market/10171/u0 remote:65d01d7}}</span>
</span></code></pre></div>
<p>如果有权限要求，还跟上面的无序广播一样；而且如果接受者没有权限，还有提示派发不成功：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-91-1"><a id="__codelineno-91-1" name="__codelineno-91-1" href="#__codelineno-91-1"></a>Skipped<span class="w"> </span><span class="m">0</span><span class="w"> </span>xxxxxxxxxx
</span></code></pre></div>
<ul>
<li>Historical broadcasts summary [foreground]: 前台广播历史记录简要</li>
</ul>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-92-1"><a id="__codelineno-92-1" name="__codelineno-92-1" href="#__codelineno-92-1"></a><span class="w">  </span>Historical<span class="w"> </span>broadcasts<span class="w"> </span>summary<span class="w"> </span><span class="o">[</span>background<span class="o">]</span>:
</span><span id="__span-92-2"><a id="__codelineno-92-2" name="__codelineno-92-2" href="#__codelineno-92-2"></a><span class="w">  </span><span class="c1">#0: act=com.android.server.action.NETWORK_STATS_UPDATED flg=0x40000010</span>
</span><span id="__span-92-3"><a id="__codelineno-92-3" name="__codelineno-92-3" href="#__codelineno-92-3"></a><span class="w">    </span><span class="m">0</span><span class="w"> </span>dispatch<span class="w"> </span>+1ms<span class="w"> </span>finish
</span><span id="__span-92-4"><a id="__codelineno-92-4" name="__codelineno-92-4" href="#__codelineno-92-4"></a><span class="w">    </span><span class="nv">enq</span><span class="o">=</span><span class="m">2022</span>-11-17<span class="w"> </span><span class="m">15</span>:47:08.580<span class="w"> </span><span class="nv">disp</span><span class="o">=</span><span class="m">2022</span>-11-17<span class="w"> </span><span class="m">15</span>:47:08.580<span class="w"> </span><span class="nv">fin</span><span class="o">=</span><span class="m">2022</span>-11-17<span class="w"> </span><span class="m">15</span>:47:08.581<span class="w"> </span>//入队时间、派发时间、结束时间
</span></code></pre></div>
<ul>
<li>Historical broadcasts [background]：后台广播历史记录</li>
<li>
<p>Historical broadcasts summary [background]: 后台广播历史记录简要</p>
</li>
<li>
<p>dumpsys activity broadcast-stats</p>
</li>
</ul>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-93-1"><a id="__codelineno-93-1" name="__codelineno-93-1" href="#__codelineno-93-1"></a>android.intent.action.USER_PRESENT:
</span><span id="__span-93-2"><a id="__codelineno-93-2" name="__codelineno-93-2" href="#__codelineno-93-2"></a><span class="w">  </span>Number<span class="w"> </span>received:<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>skipped:<span class="w"> </span><span class="m">559</span>//<span class="w"> </span>分发0次，跳过559次
</span><span id="__span-93-3"><a id="__codelineno-93-3" name="__codelineno-93-3" href="#__codelineno-93-3"></a><span class="w">  </span>Total<span class="w"> </span>dispatch<span class="w"> </span>time:<span class="w"> </span>+740ms,<span class="w"> </span>max:<span class="w"> </span>+59ms<span class="w"> </span>//<span class="w"> </span>总分发用时，和最大分发用时
</span><span id="__span-93-4"><a id="__codelineno-93-4" name="__codelineno-93-4" href="#__codelineno-93-4"></a><span class="w">  </span>Package<span class="w"> </span>com.android.systemui:<span class="w"> </span><span class="m">107</span><span class="w"> </span><span class="nb">times</span>
</span><span id="__span-93-5"><a id="__codelineno-93-5" name="__codelineno-93-5" href="#__codelineno-93-5"></a><span class="w">  </span>Bg<span class="w"> </span>Check<span class="w"> </span>Violation<span class="w"> </span>com.journeyOS.edge:<span class="w"> </span><span class="m">107</span><span class="w"> </span><span class="nb">times</span>
</span><span id="__span-93-6"><a id="__codelineno-93-6" name="__codelineno-93-6" href="#__codelineno-93-6"></a><span class="w">  </span>Bg<span class="w"> </span>Check<span class="w"> </span>Violation<span class="w"> </span>com.miui.voiceassist:<span class="w"> </span><span class="m">107</span><span class="w"> </span><span class="nb">times</span>
</span><span id="__span-93-7"><a id="__codelineno-93-7" name="__codelineno-93-7" href="#__codelineno-93-7"></a><span class="w">  </span>Bg<span class="w"> </span>Check<span class="w"> </span>Violation<span class="w"> </span>ctrip.android.view:<span class="w"> </span><span class="m">107</span><span class="w"> </span><span class="nb">times</span>
</span><span id="__span-93-8"><a id="__codelineno-93-8" name="__codelineno-93-8" href="#__codelineno-93-8"></a><span class="w">  </span>Bg<span class="w"> </span>Check<span class="w"> </span>Violation<span class="w"> </span>com.taobao.idlefish:<span class="w"> </span><span class="m">107</span><span class="w"> </span><span class="nb">times</span>
</span><span id="__span-93-9"><a id="__codelineno-93-9" name="__codelineno-93-9" href="#__codelineno-93-9"></a><span class="w">  </span>Bg<span class="w"> </span>Check<span class="w"> </span>Violation<span class="w"> </span>com.android.chrome:<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="nb">times</span>
</span><span id="__span-93-10"><a id="__codelineno-93-10" name="__codelineno-93-10" href="#__codelineno-93-10"></a><span class="w">  </span>Bg<span class="w"> </span>Check<span class="w"> </span>Violation<span class="w"> </span>cn.gov.tax.its:<span class="w"> </span><span class="m">107</span><span class="w"> </span><span class="nb">times</span>
</span><span id="__span-93-11"><a id="__codelineno-93-11" name="__codelineno-93-11" href="#__codelineno-93-11"></a><span class="w">  </span>Bg<span class="w"> </span>Check<span class="w"> </span>Violation<span class="w"> </span>com.homelink.android:<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="nb">times</span>
</span></code></pre></div>
<h3 id="flag">flag<a class="headerlink" href="#flag" title="Permanent link">&para;</a></h3>
<ul>
<li>FLAG_RECEIVER_REGISTERED_ONLY</li>
</ul>
<p>表示当前广播只允许动态注册的receiver接收，避免避免一些系统广播（如TIME_TICK等）拉起静态注册的app进程。</p>
<ul>
<li>FLAG_RECEIVER_REPLACE_PENDING</li>
</ul>
<p>如果广播队列中存在没有被处理的相同广播，则直接替换掉之前的广播，无序再入队分发</p>
<ul>
<li>FLAG_RECEIVER_FOREGROUND</li>
</ul>
<p>发送广播时添加这个flag，广播将会被添加到前台广播队列中。</p>
<h2 id="reference">Reference<a class="headerlink" href="#reference" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://blog.csdn.net/xiaoyantan/article/details/120000708">https://blog.csdn.net/xiaoyantan/article/details/120000708</a></li>
<li><a href="https://blog.csdn.net/qijingwang/article/details/122199832">https://blog.csdn.net/qijingwang/article/details/122199832</a></li>
<li><a href="https://www.cnblogs.com/linghu-java/articles/10307915.html">https://www.cnblogs.com/linghu-java/articles/10307915.html</a></li>
</ul>







  
  






  <h2 id="__comments">评论</h2>
  <!-- Insert generated snippet here -->

    <script src="https://giscus.app/client.js"
        data-repo="i-rtfsc/i-rtfsc.github.io"
        data-repo-id="MDEwOlJlcG9zaXRvcnkxNTU2NzA2OTE="
        data-category="Q&A"
        data-category-id="DIC_kwDOCUdYo84CeZYU"
        data-mapping="pathname"
        data-strict="1"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="preferred_color_scheme"
        data-lang="zh-CN"
        data-loading="lazy"
        data-default-reactions-enabled="1"
        crossorigin="anonymous"
        async>
    </script>

  <!-- Synchronize Giscus theme with palette -->
  <script>
    var giscus = document.querySelector("script[src*=giscus]")

    // Set palette on initial load
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object") {
      var theme = palette.color.scheme === "slate"
        ? "transparent_dark"
        : "light"

      // Instruct Giscus to set theme
      giscus.setAttribute("data-theme", theme)
    }

    // Register event handlers after documented loaded
    document.addEventListener("DOMContentLoaded", function() {
      var ref = document.querySelector("[data-md-component=palette]")
      ref.addEventListener("change", function() {
        var palette = __md_get("__palette")
        if (palette && typeof palette.color === "object") {
          var theme = palette.color.scheme === "slate"
            ? "transparent_dark"
            : "light"

          // Instruct Giscus to change theme
          var frame = document.querySelector(".giscus-frame")
          frame.contentWindow.postMessage(
            { giscus: { setConfig: { theme } } },
            "https://giscus.app"
          )
        }
      })
    })
  </script>


<script src="//code.tidio.co/rqu0g9yeqzoipyjjehe84aqmiqt1ap9r.js" async></script>


                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
    
    
    
    <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
        
        <a href="../../ams/frida-dump-activity-lifecycle/" class="md-footer__link md-footer__link--prev"
           aria-label="上一页: frida dump activity生命周期">
            <div class="md-footer__button md-icon">
                
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
                <div class="md-ellipsis">
                    frida dump activity生命周期
                </div>
            </div>
        </a>
        
        
        
        <a href="../../selinux/intro/" class="md-footer__link md-footer__link--next"
           aria-label="下一页: Android SELinux介绍">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
                <div class="md-ellipsis">
                    Android SELinux介绍
                </div>
            </div>
            <div class="md-footer__button md-icon">
                
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
        </a>
        
    </nav>
    
    
    <div class="md-footer-meta md-typeset">
        <div class="md-footer-meta__inner md-grid">
            <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2015-2025 Solo</br>The website content is licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a>
    </div>
  
  
</div>

            
            <div class="md-copyright">
    <font size=1>
        
        <a href="https://icp.gov.moe/?keyword=20243250" target="_blank">萌ICP备20243250号</a>
        

        
        <span>&nbsp;|&nbsp;本站访问量：</span>
        <script async src="//finicounter.eu.org/finicounter.js"></script>
        <span id="finicount_views"></span>
        

        
        
        <span>&nbsp;|&nbsp;本站已经运行：</span>
        <span id="uptime"></span>
        <script>
            function calculateUptime() {
                let dateString = '2018-11-1'
                let start = new Date(dateString);
                let currentTime = new Date();
                let difference = currentTime - start;
                let days = Math.floor(difference / (1000 * 60 * 60 * 24));
                document.getElementById('uptime').textContent = days + '天';
            }

            calculateUptime()
        </script>
        
    </font>
</div>
            

            
            <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/i-rtfsc" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
    <a href="mailto:<anqi.huang@outlook.com>" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 493.2 160 480v-83.6c0-4 1.5-7.8 4.2-10.8l167.6-182.8c5.8-6.3 5.6-16-.4-22s-15.7-6.4-22-.7L106 360.8l-88.3-44.2C7.1 311.3.3 300.7 0 288.9s5.9-22.8 16.1-28.7l448-256c10.7-6.1 23.9-5.5 34 1.4"/></svg>
    </a>
  
</div>
            
        </div>
    </div>

</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.code.select", "content.tooltips", "navigation.indexes", "navigation.top", "navigation.footer", "navigation.tracking", "navigation.path", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.tabs", "navigation.tabs.sticky", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": {"Default": "default-tag", "Hardware": "hardware-tag", "Software": "software-tag"}, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.60a45f97.min.js"></script>
      
        <script src="../../../javascripts/extra.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mermaid@10.0.2/dist/add-html-label-6e56ed67.min.js"></script>
      
    
  </body>
</html>